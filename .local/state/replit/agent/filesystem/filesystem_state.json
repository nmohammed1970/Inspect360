{"file_contents":{"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  integer,\n  boolean,\n  pgEnum,\n  numeric,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { relations } from \"drizzle-orm\";\n\n// Session storage table (required for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// Enums\nexport const userRoleEnum = pgEnum(\"user_role\", [\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"]);\nexport const inspectionStatusEnum = pgEnum(\"inspection_status\", [\"scheduled\", \"in_progress\", \"completed\", \"reviewed\"]);\nexport const inspectionTypeEnum = pgEnum(\"inspection_type\", [\"check_in\", \"check_out\", \"routine\", \"maintenance\"]);\nexport const complianceStatusEnum = pgEnum(\"compliance_status\", [\"current\", \"expiring_soon\", \"expired\"]);\nexport const maintenanceStatusEnum = pgEnum(\"maintenance_status\", [\"open\", \"in_progress\", \"completed\", \"closed\"]);\nexport const subscriptionStatusEnum = pgEnum(\"subscription_status\", [\"active\", \"inactive\", \"cancelled\"]);\nexport const subscriptionLevelEnum = pgEnum(\"subscription_level\", [\"free\", \"starter\", \"professional\", \"enterprise\"]);\nexport const workOrderStatusEnum = pgEnum(\"work_order_status\", [\"assigned\", \"in_progress\", \"waiting_parts\", \"completed\", \"rejected\"]);\nexport const assetConditionEnum = pgEnum(\"asset_condition\", [\"excellent\", \"good\", \"fair\", \"poor\", \"needs_replacement\"]);\nexport const inspectionPointDataTypeEnum = pgEnum(\"inspection_point_data_type\", [\"text\", \"number\", \"checkbox\", \"photo\", \"rating\"]);\nexport const conditionRatingEnum = pgEnum(\"condition_rating\", [\"excellent\", \"good\", \"fair\", \"poor\", \"not_applicable\"]);\nexport const cleanlinessRatingEnum = pgEnum(\"cleanliness_rating\", [\"very_clean\", \"clean\", \"acceptable\", \"needs_cleaning\", \"not_applicable\"]);\nexport const contactTypeEnum = pgEnum(\"contact_type\", [\"internal\", \"contractor\", \"lead\", \"company\", \"partner\", \"vendor\", \"tenant\", \"other\"]);\nexport const templateScopeEnum = pgEnum(\"template_scope\", [\"block\", \"property\", \"both\"]);\nexport const fieldTypeEnum = pgEnum(\"field_type\", [\"short_text\", \"long_text\", \"number\", \"select\", \"multiselect\", \"boolean\", \"rating\", \"date\", \"time\", \"datetime\", \"photo\", \"photo_array\", \"video\", \"gps\", \"signature\"]);\nexport const maintenanceSourceEnum = pgEnum(\"maintenance_source\", [\"manual\", \"inspection\", \"tenant_portal\", \"routine\"]);\nexport const comparisonReportStatusEnum = pgEnum(\"comparison_report_status\", [\"draft\", \"under_review\", \"awaiting_signatures\", \"signed\", \"filed\"]);\nexport const currencyEnum = pgEnum(\"currency\", [\"GBP\", \"USD\", \"AED\"]);\nexport const planCodeEnum = pgEnum(\"plan_code\", [\"starter\", \"professional\", \"enterprise\", \"enterprise_plus\"]);\nexport const creditSourceEnum = pgEnum(\"credit_source\", [\"plan_inclusion\", \"topup\", \"admin_grant\", \"refund\", \"adjustment\", \"consumption\", \"expiry\"]);\nexport const topupStatusEnum = pgEnum(\"topup_status\", [\"pending\", \"paid\", \"failed\", \"refunded\"]);\n\n// User storage table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: varchar(\"username\").unique().notNull(),\n  password: varchar(\"password\").notNull(),\n  email: varchar(\"email\").unique().notNull(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  phone: varchar(\"phone\"),\n  address: jsonb(\"address\").$type<{\n    street?: string;\n    city?: string;\n    state?: string;\n    postalCode?: string;\n    country?: string;\n    formatted?: string;\n  }>(),\n  skills: text(\"skills\").array(),\n  education: text(\"education\"),\n  certificateUrls: text(\"certificate_urls\").array(),\n  role: userRoleEnum(\"role\").notNull().default(\"owner\"),\n  organizationId: varchar(\"organization_id\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  resetToken: varchar(\"reset_token\"),\n  resetTokenExpiry: timestamp(\"reset_token_expiry\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  resetToken: true,\n  resetTokenExpiry: true,\n});\n\nexport const registerUserSchema = insertUserSchema.pick({\n  username: true,\n  password: true,\n  email: true,\n  firstName: true,\n  lastName: true,\n  role: true,\n}).extend({\n  firstName: z.string().optional(),\n  lastName: z.string().optional(),\n  countryCode: z.string().length(2).optional(), // ISO 3166-1 alpha-2\n});\n\nexport const loginUserSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type RegisterUser = z.infer<typeof registerUserSchema>;\nexport type LoginUser = z.infer<typeof loginUserSchema>;\n\n// Admin Users (Platform administrators)\nexport const adminUsers = pgTable(\"admin_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique().notNull(),\n  password: varchar(\"password\").notNull(),\n  firstName: varchar(\"first_name\").notNull(),\n  lastName: varchar(\"last_name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAdminUserSchema = createInsertSchema(adminUsers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const loginAdminSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1),\n});\n\nexport type AdminUser = typeof adminUsers.$inferSelect;\nexport type InsertAdminUser = z.infer<typeof insertAdminUserSchema>;\nexport type LoginAdmin = z.infer<typeof loginAdminSchema>;\n\n// Organizations\nexport const organizations = pgTable(\"organizations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  ownerId: varchar(\"owner_id\").notNull(),\n  stripeCustomerId: varchar(\"stripe_customer_id\"),\n  subscriptionStatus: subscriptionStatusEnum(\"subscription_status\").default(\"inactive\"),\n  subscriptionLevel: subscriptionLevelEnum(\"subscription_level\").default(\"free\"),\n  countryCode: varchar(\"country_code\", { length: 2 }).default(\"GB\"), // ISO 3166-1 alpha-2\n  currentPlanId: varchar(\"current_plan_id\"),\n  trialEndAt: timestamp(\"trial_end_at\"),\n  isActive: boolean(\"is_active\").default(true),\n  creditsRemaining: integer(\"credits_remaining\").default(5),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertOrganizationSchema = createInsertSchema(organizations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Organization = typeof organizations.$inferSelect;\nexport type InsertOrganization = z.infer<typeof insertOrganizationSchema>;\n\n// Contacts (Internal team members and external contacts)\nexport const contacts = pgTable(\"contacts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  type: contactTypeEnum(\"type\").notNull().default(\"other\"),\n  firstName: varchar(\"first_name\").notNull(),\n  lastName: varchar(\"last_name\").notNull(),\n  email: varchar(\"email\"),\n  phone: varchar(\"phone\"),\n  countryCode: varchar(\"country_code\").default(\"+1\"),\n  companyName: varchar(\"company_name\"),\n  jobTitle: varchar(\"job_title\"),\n  address: text(\"address\"),\n  city: varchar(\"city\"),\n  state: varchar(\"state\"),\n  postalCode: varchar(\"postal_code\"),\n  country: varchar(\"country\"),\n  website: varchar(\"website\"),\n  notes: text(\"notes\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  tags: text(\"tags\").array(),\n  linkedUserId: varchar(\"linked_user_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertContactSchema = createInsertSchema(contacts).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Contact = typeof contacts.$inferSelect;\nexport type InsertContact = z.infer<typeof insertContactSchema>;\n\n// Blocks (Buildings/Complexes)\nexport const blocks = pgTable(\"blocks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(),\n  address: text(\"address\").notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertBlockSchema = createInsertSchema(blocks).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Block = typeof blocks.$inferSelect;\nexport type InsertBlock = z.infer<typeof insertBlockSchema>;\n\n// Properties (Buildings/Locations)\n// Properties can optionally belong to blocks for organizational hierarchy\nexport const properties = pgTable(\"properties\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  blockId: varchar(\"block_id\"), // Optional: properties can be grouped into blocks\n  name: varchar(\"name\").notNull(),\n  address: text(\"address\").notNull(),\n  sqft: integer(\"sqft\"), // Property area in square feet (for cost estimation)\n  fixfloPropertyId: varchar(\"fixflo_property_id\"), // Fixflo external property/asset ID\n  fixfloSyncedAt: timestamp(\"fixflo_synced_at\"), // Last successful sync timestamp\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPropertySchema = createInsertSchema(properties).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Property = typeof properties.$inferSelect;\nexport type InsertProperty = z.infer<typeof insertPropertySchema>;\n\n// Tenant Assignments (tracks which tenant is assigned to which property)\nexport const tenantAssignments = pgTable(\"tenant_assignments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  tenantId: varchar(\"tenant_id\").notNull(), // References users.id where role='tenant'\n  propertyId: varchar(\"property_id\").notNull(), // References properties.id\n  leaseStartDate: timestamp(\"lease_start_date\"),\n  leaseEndDate: timestamp(\"lease_end_date\"),\n  monthlyRent: numeric(\"monthly_rent\", { precision: 10, scale: 2 }),\n  depositAmount: numeric(\"deposit_amount\", { precision: 10, scale: 2 }),\n  notes: text(\"notes\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  // Next of Kin Information\n  nextOfKinName: varchar(\"next_of_kin_name\", { length: 255 }),\n  nextOfKinPhone: varchar(\"next_of_kin_phone\", { length: 50 }),\n  nextOfKinEmail: varchar(\"next_of_kin_email\", { length: 255 }),\n  nextOfKinRelationship: varchar(\"next_of_kin_relationship\", { length: 100 }),\n  // Tenant Portal Access\n  hasPortalAccess: boolean(\"has_portal_access\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTenantAssignmentSchema = createInsertSchema(tenantAssignments).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport const updateTenantAssignmentSchema = insertTenantAssignmentSchema.partial();\nexport type TenantAssignment = typeof tenantAssignments.$inferSelect;\nexport type InsertTenantAssignment = z.infer<typeof insertTenantAssignmentSchema>;\n\n// Tenant Assignment Tags (many-to-many relationship)\nexport const tenantAssignmentTags = pgTable(\"tenant_assignment_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantAssignmentId: varchar(\"tenant_assignment_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type TenantAssignmentTag = typeof tenantAssignmentTags.$inferSelect;\n\n// Tenancy Attachments (documents related to tenant assignments)\nexport const tenancyAttachments = pgTable(\"tenancy_attachments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantAssignmentId: varchar(\"tenant_assignment_id\").notNull(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  fileName: varchar(\"file_name\", { length: 255 }).notNull(),\n  fileUrl: text(\"file_url\").notNull(),\n  fileType: varchar(\"file_type\", { length: 100 }), // e.g., \"application/pdf\", \"image/png\"\n  fileSize: integer(\"file_size\"), // Size in bytes\n  description: text(\"description\"),\n  uploadedBy: varchar(\"uploaded_by\"), // References users.id\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTenancyAttachmentSchema = createInsertSchema(tenancyAttachments).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type TenancyAttachment = typeof tenancyAttachments.$inferSelect;\nexport type InsertTenancyAttachment = z.infer<typeof insertTenancyAttachmentSchema>;\n\n// Inspection Categories\nexport const inspectionCategories = pgTable(\"inspection_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  sortOrder: integer(\"sort_order\").default(0),\n  isDefault: boolean(\"is_default\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInspectionCategorySchema = createInsertSchema(inspectionCategories).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InspectionCategory = typeof inspectionCategories.$inferSelect;\nexport type InsertInspectionCategory = z.infer<typeof insertInspectionCategorySchema>;\n\n// Template Categories (optional grouping for templates)\nexport const templateCategories = pgTable(\"template_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  color: varchar(\"color\").default(\"#5AB5E8\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTemplateCategorySchema = createInsertSchema(templateCategories).omit({\n  id: true,\n  createdAt: true,\n});\nexport type TemplateCategory = typeof templateCategories.$inferSelect;\nexport type InsertTemplateCategory = z.infer<typeof insertTemplateCategorySchema>;\n\n// Inspection Templates (JSON-based flexible structure)\nexport const inspectionTemplates = pgTable(\"inspection_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  scope: templateScopeEnum(\"scope\").notNull().default(\"property\"),\n  version: integer(\"version\").notNull().default(1),\n  parentTemplateId: varchar(\"parent_template_id\"), // Links to parent template for versioning\n  isActive: boolean(\"is_active\").default(true),\n  structureJson: jsonb(\"structure_json\").notNull(), // Full template schema with sections/fields\n  categoryId: varchar(\"category_id\"), // Optional link to template_categories\n  createdBy: varchar(\"created_by\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInspectionTemplateSchema = createInsertSchema(inspectionTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InspectionTemplate = typeof inspectionTemplates.$inferSelect;\nexport type InsertInspectionTemplate = z.infer<typeof insertInspectionTemplateSchema>;\n\n// Template Inventory Links (bind templates to inventory templates)\nexport const templateInventoryLinks = pgTable(\"template_inventory_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  templateId: varchar(\"template_id\").notNull(),\n  inventoryTemplateId: varchar(\"inventory_template_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"template_inventory_links_template_id_idx\").on(table.templateId),\n]);\n\nexport const insertTemplateInventoryLinkSchema = createInsertSchema(templateInventoryLinks).omit({\n  id: true,\n  createdAt: true,\n});\nexport type TemplateInventoryLink = typeof templateInventoryLinks.$inferSelect;\nexport type InsertTemplateInventoryLink = z.infer<typeof insertTemplateInventoryLinkSchema>;\n\n// Inspection Template Points (the items to inspect within a template)\nexport const inspectionTemplatePoints = pgTable(\"inspection_template_points\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  templateId: varchar(\"template_id\").notNull(),\n  categoryId: varchar(\"category_id\"), // Link to inspection_categories\n  name: varchar(\"name\").notNull(), // e.g., \"Kitchen Sink\", \"Living Room Walls\"\n  description: text(\"description\"),\n  dataType: inspectionPointDataTypeEnum(\"data_type\").notNull().default(\"text\"),\n  requiresConditionRating: boolean(\"requires_condition_rating\").default(true),\n  requiresCleanlinessRating: boolean(\"requires_cleanliness_rating\").default(true),\n  requiresPhoto: boolean(\"requires_photo\").default(false),\n  sortOrder: integer(\"sort_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertInspectionTemplatePointSchema = createInsertSchema(inspectionTemplatePoints).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InspectionTemplatePoint = typeof inspectionTemplatePoints.$inferSelect;\nexport type InsertInspectionTemplatePoint = z.infer<typeof insertInspectionTemplatePointSchema>;\n\n// Inspections (can be on blocks OR properties)\nexport const inspections = pgTable(\"inspections\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  templateId: varchar(\"template_id\"), // Link to inspection template (optional for backward compatibility)\n  templateVersion: integer(\"template_version\"), // Snapshot of template version used\n  templateSnapshotJson: jsonb(\"template_snapshot_json\"), // Copy of template structure at inspection start\n  inventorySnapshotJson: jsonb(\"inventory_snapshot_json\"), // Copy of inventory layout at inspection start\n  // Inspection can be on either a block or a property (at least one must be set)\n  blockId: varchar(\"block_id\"),\n  propertyId: varchar(\"property_id\"),\n  inspectorId: varchar(\"inspector_id\").notNull(),\n  type: inspectionTypeEnum(\"type\").notNull(),\n  status: inspectionStatusEnum(\"status\").notNull().default(\"scheduled\"),\n  scheduledDate: timestamp(\"scheduled_date\"),\n  startedAt: timestamp(\"started_at\"), // When inspector begins capture\n  completedDate: timestamp(\"completed_date\"),\n  submittedAt: timestamp(\"submitted_at\"), // When inspector submits\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"inspections_organization_id_idx\").on(table.organizationId),\n]);\n\nexport const insertInspectionSchema = createInsertSchema(inspections).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).refine(\n  (data) => data.blockId || data.propertyId,\n  { message: \"Either blockId or propertyId must be provided\" }\n);\nexport type Inspection = typeof inspections.$inferSelect;\nexport type InsertInspection = z.infer<typeof insertInspectionSchema>;\n\n// Inspection Items (Photos and condition ratings)\nexport const inspectionItems = pgTable(\"inspection_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inspectionId: varchar(\"inspection_id\").notNull(),\n  categoryId: varchar(\"category_id\"), // Optional: reference to inspection_categories\n  category: varchar(\"category\").notNull(), // e.g., \"Kitchen\", \"Bathroom\", \"Living Room\" (for backward compat)\n  itemName: varchar(\"item_name\").notNull(), // e.g., \"Walls\", \"Floors\", \"Appliances\"\n  photoUrl: text(\"photo_url\"),\n  conditionRating: integer(\"condition_rating\"), // 1-5 slider\n  notes: text(\"notes\"),\n  aiAnalysis: text(\"ai_analysis\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertInspectionItemSchema = createInsertSchema(inspectionItems).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InspectionItem = typeof inspectionItems.$inferSelect;\nexport type InsertInspectionItem = z.infer<typeof insertInspectionItemSchema>;\n\n// Inspection Responses (for template-based inspections)\nexport const inspectionResponses = pgTable(\"inspection_responses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inspectionId: varchar(\"inspection_id\").notNull(),\n  templatePointId: varchar(\"template_point_id\").notNull(), // Links to inspection_template_points\n  assetInventoryId: varchar(\"asset_inventory_id\"), // Optional: link to asset being inspected\n  conditionRating: conditionRatingEnum(\"condition_rating\"),\n  cleanlinessRating: cleanlinessRatingEnum(\"cleanliness_rating\"),\n  textValue: text(\"text_value\"), // For text data type\n  numberValue: integer(\"number_value\"), // For number data type\n  checkboxValue: boolean(\"checkbox_value\"), // For checkbox data type\n  photoUrl: text(\"photo_url\"), // For photo data type\n  notes: text(\"notes\"),\n  aiAnalysis: text(\"ai_analysis\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInspectionResponseSchema = createInsertSchema(inspectionResponses).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InspectionResponse = typeof inspectionResponses.$inferSelect;\nexport type InsertInspectionResponse = z.infer<typeof insertInspectionResponseSchema>;\n\n// Inspection Entries (new flexible JSON-based system for template inspections)\nexport const inspectionEntries = pgTable(\"inspection_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inspectionId: varchar(\"inspection_id\").notNull(),\n  sectionRef: text(\"section_ref\").notNull(), // Path to section in template (e.g., \"Bedrooms/Bedroom 1\")\n  itemRef: text(\"item_ref\"), // Path to item if inventory-based (e.g., \"Bedrooms/Bedroom 1/Wardrobe\")\n  fieldKey: varchar(\"field_key\").notNull(), // Field identifier from template\n  fieldType: fieldTypeEnum(\"field_type\").notNull(),\n  valueJson: jsonb(\"value_json\"), // Flexible value storage (text, number, boolean, array, etc.)\n  note: text(\"note\"),\n  photos: text(\"photos\").array(), // Array of photo URLs\n  videos: text(\"videos\").array(), // Array of video URLs\n  maintenanceFlag: boolean(\"maintenance_flag\").default(false),\n  markedForReview: boolean(\"marked_for_review\").default(false), // For comparison report generation\n  assetInventoryId: varchar(\"asset_inventory_id\"), // Link to asset for depreciation calculation\n  defectsJson: jsonb(\"defects_json\"), // Array of defect tags/types\n  offlineId: varchar(\"offline_id\").unique(), // For offline sync reconciliation (unique for idempotency)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"inspection_entries_inspection_id_idx\").on(table.inspectionId),\n  index(\"inspection_entries_offline_id_idx\").on(table.offlineId),\n]);\n\nexport const insertInspectionEntrySchema = createInsertSchema(inspectionEntries).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InspectionEntry = typeof inspectionEntries.$inferSelect;\nexport type InsertInspectionEntry = z.infer<typeof insertInspectionEntrySchema>;\n\n// AI Image Analyses (results from OpenAI Vision API)\nexport const aiImageAnalyses = pgTable(\"ai_image_analyses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inspectionEntryId: varchar(\"inspection_entry_id\"), // Link to entry if from inspection\n  inspectionId: varchar(\"inspection_id\"), // Direct link to inspection for easier queries\n  mediaUrl: text(\"media_url\").notNull(),\n  mediaType: varchar(\"media_type\").notNull().default(\"photo\"), // \"photo\" or \"video\"\n  model: varchar(\"model\").notNull().default(\"gpt-4o\"), // AI model used\n  resultJson: jsonb(\"result_json\"), // Full AI response\n  confidence: integer(\"confidence\"), // 0-100 confidence score\n  detectionsJson: jsonb(\"detections_json\"), // Detected issues (mold, cracks, etc.) with bboxes\n  annotationsUrl: text(\"annotations_url\"), // URL to annotated image if generated\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"ai_image_analyses_entry_id_idx\").on(table.inspectionEntryId),\n  index(\"ai_image_analyses_inspection_id_idx\").on(table.inspectionId),\n]);\n\nexport const insertAiImageAnalysisSchema = createInsertSchema(aiImageAnalyses).omit({\n  id: true,\n  createdAt: true,\n});\nexport type AiImageAnalysis = typeof aiImageAnalyses.$inferSelect;\nexport type InsertAiImageAnalysis = z.infer<typeof insertAiImageAnalysisSchema>;\n\n// Compliance Documents\nexport const complianceDocuments = pgTable(\"compliance_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  propertyId: varchar(\"property_id\"),\n  blockId: varchar(\"block_id\"),\n  documentType: varchar(\"document_type\").notNull(), // e.g., \"Fire Safety\", \"Insurance\", \"License\"\n  documentUrl: text(\"document_url\").notNull(),\n  expiryDate: timestamp(\"expiry_date\"),\n  status: complianceStatusEnum(\"status\").notNull().default(\"current\"),\n  uploadedBy: varchar(\"uploaded_by\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertComplianceDocumentSchema = createInsertSchema(complianceDocuments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  expiryDate: z.coerce.date().nullable().optional(),\n});\nexport type ComplianceDocument = typeof complianceDocuments.$inferSelect;\nexport type InsertComplianceDocument = z.infer<typeof insertComplianceDocumentSchema>;\n\n// Maintenance Requests (Internal tracking)\nexport const maintenanceRequests = pgTable(\"maintenance_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  propertyId: varchar(\"property_id\").notNull(),\n  reportedBy: varchar(\"reported_by\").notNull(),\n  assignedTo: varchar(\"assigned_to\"),\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  status: maintenanceStatusEnum(\"status\").notNull().default(\"open\"),\n  priority: varchar(\"priority\").notNull().default(\"medium\"), // low, medium, high, urgent\n  photoUrls: text(\"photo_urls\").array(), // Multiple photo support for maintenance teams\n  aiSuggestedFixes: text(\"ai_suggested_fixes\"), // AI-generated fix suggestions for tenant portal\n  aiAnalysisJson: jsonb(\"ai_analysis_json\"), // Full AI analysis data\n  source: maintenanceSourceEnum(\"source\").notNull().default(\"manual\"), // Track origin\n  inspectionId: varchar(\"inspection_id\"), // Link to source inspection if auto-created\n  inspectionEntryId: varchar(\"inspection_entry_id\"), // Link to specific entry that flagged it\n  fixfloIssueId: varchar(\"fixflo_issue_id\"), // Fixflo external issue ID\n  fixfloJobId: varchar(\"fixflo_job_id\"), // Fixflo job ID if escalated to job\n  fixfloStatus: varchar(\"fixflo_status\"), // Last known Fixflo status\n  fixfloContractorName: varchar(\"fixflo_contractor_name\"), // Assigned contractor from Fixflo\n  fixfloSyncedAt: timestamp(\"fixflo_synced_at\"), // Last successful sync timestamp\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertMaintenanceRequestSchema = createInsertSchema(maintenanceRequests).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type MaintenanceRequest = typeof maintenanceRequests.$inferSelect;\nexport type InsertMaintenanceRequest = z.infer<typeof insertMaintenanceRequestSchema>;\n\n// Tenant Maintenance Chat Conversations (AI Chatbot for preventative maintenance)\nexport const tenantMaintenanceChats = pgTable(\"tenant_maintenance_chats\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  tenantId: varchar(\"tenant_id\").notNull(), // References users.id where role='tenant'\n  propertyId: varchar(\"property_id\").notNull(),\n  maintenanceRequestId: varchar(\"maintenance_request_id\"), // Linked if tenant creates request after chat\n  title: varchar(\"title\").notNull(), // Auto-generated from first message\n  status: varchar(\"status\").notNull().default(\"active\"), // active, resolved, escalated\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTenantMaintenanceChatSchema = createInsertSchema(tenantMaintenanceChats).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type TenantMaintenanceChat = typeof tenantMaintenanceChats.$inferSelect;\nexport type InsertTenantMaintenanceChat = z.infer<typeof insertTenantMaintenanceChatSchema>;\n\n// Chat Messages\nexport const tenantMaintenanceChatMessages = pgTable(\"tenant_maintenance_chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  chatId: varchar(\"chat_id\").notNull(),\n  role: varchar(\"role\").notNull(), // 'user' or 'assistant'\n  content: text(\"content\").notNull(),\n  imageUrl: varchar(\"image_url\"), // If user uploaded image\n  aiSuggestedFixes: text(\"ai_suggested_fixes\"), // If AI provided fixes\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTenantMaintenanceChatMessageSchema = createInsertSchema(tenantMaintenanceChatMessages).omit({\n  id: true,\n  createdAt: true,\n});\nexport type TenantMaintenanceChatMessage = typeof tenantMaintenanceChatMessages.$inferSelect;\nexport type InsertTenantMaintenanceChatMessage = z.infer<typeof insertTenantMaintenanceChatMessageSchema>;\n\n// Quick-add maintenance schema for in-inspection workflow (minimal fields)\nexport const quickAddMaintenanceSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  propertyId: z.string().min(1, \"Property is required\"),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).default(\"medium\"),\n  photoUrls: z.array(z.string()).optional(),\n  inspectionId: z.string().optional(), // Auto-populated from inspection context\n  inspectionEntryId: z.string().optional(), // Optional specific entry link\n  source: z.enum([\"manual\", \"inspection\", \"tenant_portal\", \"routine\"]).default(\"inspection\"),\n});\nexport type QuickAddMaintenance = z.infer<typeof quickAddMaintenanceSchema>;\n\n// Comparison Reports (Check-in vs Check-out collaborative liability assessment)\nexport const comparisonReports = pgTable(\"comparison_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  propertyId: varchar(\"property_id\").notNull(),\n  checkInInspectionId: varchar(\"check_in_inspection_id\").notNull(),\n  checkOutInspectionId: varchar(\"check_out_inspection_id\").notNull(),\n  tenantId: varchar(\"tenant_id\"), // Optional: Tenant assigned to property (null for vacant units during turnover)\n  status: comparisonReportStatusEnum(\"status\").notNull().default(\"draft\"),\n  totalEstimatedCost: numeric(\"total_estimated_cost\", { precision: 10, scale: 2 }).default(\"0\"),\n  aiAnalysisJson: jsonb(\"ai_analysis_json\"), // AI comparison results\n  itemComparisons: jsonb(\"item_comparisons\"), // Array of item-by-item comparisons (backward compatibility)\n  generatedBy: varchar(\"generated_by\").notNull(), // User who triggered report generation\n  generatedAt: timestamp(\"generated_at\").defaultNow(),\n  operatorSignature: varchar(\"operator_signature\"), // Typed name\n  operatorSignedAt: timestamp(\"operator_signed_at\"),\n  operatorIpAddress: varchar(\"operator_ip_address\"),\n  tenantSignature: varchar(\"tenant_signature\"), // Typed name\n  tenantSignedAt: timestamp(\"tenant_signed_at\"),\n  tenantIpAddress: varchar(\"tenant_ip_address\"),\n  filedAt: timestamp(\"filed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"comparison_reports_organization_id_idx\").on(table.organizationId),\n  index(\"comparison_reports_property_id_idx\").on(table.propertyId),\n  index(\"comparison_reports_check_out_inspection_id_idx\").on(table.checkOutInspectionId),\n]);\n\nexport const insertComparisonReportSchema = createInsertSchema(comparisonReports).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type ComparisonReport = typeof comparisonReports.$inferSelect;\nexport type InsertComparisonReport = z.infer<typeof insertComparisonReportSchema>;\n\n// Comparison Report Items (Individual inspection entries marked for review)\nexport const comparisonReportItems = pgTable(\"comparison_report_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  comparisonReportId: varchar(\"comparison_report_id\").notNull(),\n  checkInEntryId: varchar(\"check_in_entry_id\"), // May not exist if new item in check-out\n  checkOutEntryId: varchar(\"check_out_entry_id\").notNull(),\n  sectionRef: text(\"section_ref\").notNull(),\n  itemRef: text(\"item_ref\"),\n  fieldKey: varchar(\"field_key\").notNull(),\n  aiComparisonJson: jsonb(\"ai_comparison_json\"), // AI analysis for this specific item\n  estimatedCost: numeric(\"estimated_cost\", { precision: 10, scale: 2 }),\n  depreciation: numeric(\"depreciation\", { precision: 10, scale: 2 }),\n  finalCost: numeric(\"final_cost\", { precision: 10, scale: 2 }), // After depreciation\n  liabilityDecision: varchar(\"liability_decision\"), // \"tenant\", \"landlord\", \"shared\", \"waived\"\n  liabilityNotes: text(\"liability_notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"comparison_report_items_report_id_idx\").on(table.comparisonReportId),\n]);\n\nexport const insertComparisonReportItemSchema = createInsertSchema(comparisonReportItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type ComparisonReportItem = typeof comparisonReportItems.$inferSelect;\nexport type InsertComparisonReportItem = z.infer<typeof insertComparisonReportItemSchema>;\n\n// Comparison Comments (Async discussion thread for liability negotiation)\nexport const comparisonComments = pgTable(\"comparison_comments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  comparisonReportId: varchar(\"comparison_report_id\").notNull(),\n  comparisonReportItemId: varchar(\"comparison_report_item_id\"), // Optional: comment on specific item\n  userId: varchar(\"user_id\").notNull(),\n  content: text(\"content\").notNull(),\n  attachments: text(\"attachments\").array(), // Optional file attachments\n  isInternal: boolean(\"is_internal\").default(false), // Internal notes not visible to tenant\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"comparison_comments_report_id_idx\").on(table.comparisonReportId),\n  index(\"comparison_comments_item_id_idx\").on(table.comparisonReportItemId),\n]);\n\nexport const insertComparisonCommentSchema = createInsertSchema(comparisonComments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type ComparisonComment = typeof comparisonComments.$inferSelect;\nexport type InsertComparisonComment = z.infer<typeof insertComparisonCommentSchema>;\n\n// Credit Transactions (Track credit usage)\nexport const creditTransactions = pgTable(\"credit_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  amount: integer(\"amount\").notNull(), // Positive for addition, negative for usage\n  type: varchar(\"type\").notNull(), // \"purchase\", \"inspection\", \"comparison\", \"refund\"\n  description: text(\"description\"),\n  relatedId: varchar(\"related_id\"), // ID of related inspection/comparison\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertCreditTransactionSchema = createInsertSchema(creditTransactions).omit({\n  id: true,\n  createdAt: true,\n});\nexport type CreditTransaction = typeof creditTransactions.$inferSelect;\nexport type InsertCreditTransaction = z.infer<typeof insertCreditTransactionSchema>;\n\n// Inventory Templates (Predefined room/item structures)\nexport const inventoryTemplates = pgTable(\"inventory_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(), // e.g., \"Studio\", \"1-bed\", \"2-bed\"\n  description: text(\"description\"),\n  schema: jsonb(\"schema\").notNull(), // JSON structure defining rooms and items\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInventoryTemplateSchema = createInsertSchema(inventoryTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InventoryTemplate = typeof inventoryTemplates.$inferSelect;\nexport type InsertInventoryTemplate = z.infer<typeof insertInventoryTemplateSchema>;\n\n// Inventories (Active inventory instances for properties)\nexport const inventories = pgTable(\"inventories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  propertyId: varchar(\"property_id\").notNull(),\n  templateId: varchar(\"template_id\"),\n  version: integer(\"version\").default(1),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInventorySchema = createInsertSchema(inventories).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Inventory = typeof inventories.$inferSelect;\nexport type InsertInventory = z.infer<typeof insertInventorySchema>;\n\n// Inventory Items (Individual items within an inventory)\nexport const inventoryItems = pgTable(\"inventory_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inventoryId: varchar(\"inventory_id\").notNull(),\n  path: text(\"path\").notNull(), // e.g., \"Kitchen > Appliances > Refrigerator\"\n  itemName: varchar(\"item_name\").notNull(),\n  baselineCondition: integer(\"baseline_condition\"), // 1-5 rating\n  baselineCleanliness: integer(\"baseline_cleanliness\"), // 1-5 rating\n  baselinePhotos: text(\"baseline_photos\").array(), // Array of photo URLs\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInventoryItemSchema = createInsertSchema(inventoryItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InventoryItem = typeof inventoryItems.$inferSelect;\nexport type InsertInventoryItem = z.infer<typeof insertInventoryItemSchema>;\n\n// Work Orders (Contractor assignments linked to maintenance requests)\nexport const workOrders = pgTable(\"work_orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  maintenanceRequestId: varchar(\"maintenance_request_id\").notNull(),\n  teamId: varchar(\"team_id\"), // Assigned team for work order\n  contractorId: varchar(\"contractor_id\"), // Specific contractor assigned (if any)\n  status: workOrderStatusEnum(\"status\").notNull().default(\"assigned\"),\n  slaDue: timestamp(\"sla_due\"), // Service Level Agreement deadline\n  costEstimate: integer(\"cost_estimate\"), // In cents\n  costActual: integer(\"cost_actual\"), // In cents\n  variationNotes: text(\"variation_notes\"), // Notes on cost variations\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertWorkOrderSchema = createInsertSchema(workOrders).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type WorkOrder = typeof workOrders.$inferSelect;\nexport type InsertWorkOrder = z.infer<typeof insertWorkOrderSchema>;\n\n// Work Logs (Activity logs for work orders)\nexport const workLogs = pgTable(\"work_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  workOrderId: varchar(\"work_order_id\").notNull(),\n  note: text(\"note\").notNull(),\n  photos: text(\"photos\").array(), // Array of photo URLs\n  timeSpentMinutes: integer(\"time_spent_minutes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertWorkLogSchema = createInsertSchema(workLogs).omit({\n  id: true,\n  createdAt: true,\n});\nexport type WorkLog = typeof workLogs.$inferSelect;\nexport type InsertWorkLog = z.infer<typeof insertWorkLogSchema>;\n\n// Asset Inventory (Physical assets/equipment for properties and blocks)\nexport const assetInventory = pgTable(\"asset_inventory\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  propertyId: varchar(\"property_id\"),\n  blockId: varchar(\"block_id\"),\n  name: varchar(\"name\").notNull(),\n  category: varchar(\"category\"), // e.g., \"HVAC\", \"Appliances\", \"Furniture\", \"Plumbing\", \"Electrical\"\n  description: text(\"description\"),\n  location: varchar(\"location\"), // Specific room/area: \"Unit 101 - Kitchen\", \"Common Area - Lobby\"\n  supplier: varchar(\"supplier\"),\n  supplierContact: varchar(\"supplier_contact\"), // Phone or email\n  serialNumber: varchar(\"serial_number\"),\n  modelNumber: varchar(\"model_number\"),\n  datePurchased: timestamp(\"date_purchased\"),\n  purchasePrice: numeric(\"purchase_price\", { precision: 10, scale: 2 }),\n  warrantyExpiryDate: timestamp(\"warranty_expiry_date\"),\n  condition: assetConditionEnum(\"condition\").notNull(),\n  cleanliness: cleanlinessRatingEnum(\"cleanliness\"),\n  expectedLifespanYears: integer(\"expected_lifespan_years\"),\n  depreciationPerYear: numeric(\"depreciation_per_year\", { precision: 10, scale: 2 }), // Auto-calculated or manual\n  currentValue: numeric(\"current_value\", { precision: 10, scale: 2 }), // Purchase price - accumulated depreciation\n  lastMaintenanceDate: timestamp(\"last_maintenance_date\"),\n  nextMaintenanceDate: timestamp(\"next_maintenance_date\"),\n  maintenanceNotes: text(\"maintenance_notes\"),\n  photos: text(\"photos\").array(), // Array of photo URLs\n  documents: text(\"documents\").array(), // Array of document URLs (manuals, warranties)\n  inspectionId: varchar(\"inspection_id\"), // Link to source inspection for audit trail\n  inspectionEntryId: varchar(\"inspection_entry_id\"), // Link to specific inspection entry if relevant\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAssetInventorySchema = createInsertSchema(assetInventory).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  datePurchased: z.coerce.date().nullable().optional(),\n  warrantyExpiryDate: z.coerce.date().nullable().optional(),\n  lastMaintenanceDate: z.coerce.date().nullable().optional(),\n  nextMaintenanceDate: z.coerce.date().nullable().optional(),\n});\nexport type AssetInventory = typeof assetInventory.$inferSelect;\nexport type InsertAssetInventory = z.infer<typeof insertAssetInventorySchema>;\n\n// Quick-add asset schema for in-inspection workflow (minimal fields)\nexport const quickAddAssetSchema = z.object({\n  name: z.string().min(1, \"Asset name is required\"),\n  category: z.string().optional(),\n  condition: z.enum([\"excellent\", \"good\", \"fair\", \"poor\", \"needs_replacement\"]),\n  cleanliness: z.enum([\"very_clean\", \"clean\", \"acceptable\", \"needs_cleaning\", \"not_applicable\"]).optional(),\n  location: z.string().optional(),\n  description: z.string().optional(),\n  propertyId: z.string().optional(), // Auto-populated from inspection context\n  blockId: z.string().optional(), // Auto-populated if block-level inspection\n  photos: z.array(z.string()).optional(),\n  inspectionId: z.string().optional(), // Auto-populated from inspection context\n  inspectionEntryId: z.string().optional(), // Optional specific entry link\n});\nexport type QuickAddAsset = z.infer<typeof quickAddAssetSchema>;\n\n// Quick-update asset schema for in-inspection workflow (update existing assets)\nexport const quickUpdateAssetSchema = z.object({\n  condition: z.enum([\"excellent\", \"good\", \"fair\", \"poor\", \"needs_replacement\"]).optional(),\n  cleanliness: z.enum([\"very_clean\", \"clean\", \"acceptable\", \"needs_cleaning\", \"not_applicable\"]).optional(),\n  location: z.string().optional(),\n  notes: z.string().optional(),\n  photos: z.array(z.string()).optional(),\n  inspectionId: z.string().optional(), // Link update to current inspection\n  inspectionEntryId: z.string().optional(), // Optional specific entry link\n  offlineId: z.string().optional(), // For offline deduplication\n});\nexport type QuickUpdateAsset = z.infer<typeof quickUpdateAssetSchema>;\n\n// Fixflo Integration Configuration (per organization)\nexport const fixfloConfig = pgTable(\"fixflo_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().unique(),\n  baseUrl: varchar(\"base_url\").notNull().default(\"https://api-sandbox.fixflo.com/api/v2\"),\n  bearerToken: varchar(\"bearer_token\"), // Encrypted token for Fixflo API\n  webhookVerifyToken: varchar(\"webhook_verify_token\"), // Token for webhook signature verification\n  isEnabled: boolean(\"is_enabled\").notNull().default(false),\n  lastHealthCheck: timestamp(\"last_health_check\"),\n  healthCheckStatus: varchar(\"health_check_status\"), // \"healthy\", \"degraded\", \"error\"\n  lastError: text(\"last_error\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertFixfloConfigSchema = createInsertSchema(fixfloConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type FixfloConfig = typeof fixfloConfig.$inferSelect;\nexport type InsertFixfloConfig = z.infer<typeof insertFixfloConfigSchema>;\n\n// Fixflo Webhook Logs (for debugging and audit trail)\nexport const fixfloWebhookLogs = pgTable(\"fixflo_webhook_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  eventType: varchar(\"event_type\").notNull(), // \"IssueCreated\", \"IssueUpdated\", \"JobCompleted\", etc.\n  fixfloIssueId: varchar(\"fixflo_issue_id\"),\n  fixfloJobId: varchar(\"fixflo_job_id\"),\n  payloadJson: jsonb(\"payload_json\").notNull(),\n  processingStatus: varchar(\"processing_status\").notNull().default(\"pending\"), // \"pending\", \"processed\", \"error\", \"retrying\"\n  errorMessage: text(\"error_message\"),\n  retryCount: integer(\"retry_count\").notNull().default(0),\n  processedAt: timestamp(\"processed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"fixflo_webhook_logs_organization_id_idx\").on(table.organizationId),\n  index(\"fixflo_webhook_logs_event_type_idx\").on(table.eventType),\n  index(\"fixflo_webhook_logs_processing_status_idx\").on(table.processingStatus),\n]);\n\nexport const insertFixfloWebhookLogSchema = createInsertSchema(fixfloWebhookLogs).omit({\n  id: true,\n  createdAt: true,\n});\nexport type FixfloWebhookLog = typeof fixfloWebhookLogs.$inferSelect;\nexport type InsertFixfloWebhookLog = z.infer<typeof insertFixfloWebhookLogSchema>;\n\n// Fixflo Sync State (tracks last successful sync for different entity types)\nexport const fixfloSyncState = pgTable(\"fixflo_sync_state\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  entityType: varchar(\"entity_type\").notNull(), // \"issues\", \"properties\", \"contractors\", \"invoices\"\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  lastSuccessfulSyncAt: timestamp(\"last_successful_sync_at\"),\n  syncStatus: varchar(\"sync_status\").notNull().default(\"idle\"), // \"idle\", \"syncing\", \"error\"\n  errorMessage: text(\"error_message\"),\n  recordsSynced: integer(\"records_synced\").notNull().default(0),\n  recordsFailed: integer(\"records_failed\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => ({\n  organizationIdIdx: index(\"fixflo_sync_state_organization_id_idx\").on(table.organizationId),\n}));\n\nexport const insertFixfloSyncStateSchema = createInsertSchema(fixfloSyncState).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type FixfloSyncState = typeof fixfloSyncState.$inferSelect;\nexport type InsertFixfloSyncState = z.infer<typeof insertFixfloSyncStateSchema>;\n\n// Teams (Work order distribution lists for BTR operators)\nexport const teams = pgTable(\"teams\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(), // e.g., \"Electrical Team\", \"Plumbing Team\", \"General Maintenance\"\n  description: text(\"description\"),\n  email: varchar(\"email\"), // Distribution list email (e.g., team@company.com)\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"teams_organization_id_idx\").on(table.organizationId),\n]);\n\nexport const insertTeamSchema = createInsertSchema(teams).omit({\n  id: true,\n  organizationId: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Team = typeof teams.$inferSelect;\nexport type InsertTeam = z.infer<typeof insertTeamSchema>;\n\n// Team Members (Links admins and contractors to teams)\nexport const teamMembers = pgTable(\"team_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  teamId: varchar(\"team_id\").notNull(),\n  userId: varchar(\"user_id\"), // For admins/internal users\n  contactId: varchar(\"contact_id\"), // For contractors in contacts list\n  role: varchar(\"role\").default(\"member\"), // \"lead\", \"member\"\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"team_members_team_id_idx\").on(table.teamId),\n  index(\"team_members_user_id_idx\").on(table.userId),\n  index(\"team_members_contact_id_idx\").on(table.contactId),\n]);\n\nexport const insertTeamMemberSchema = createInsertSchema(teamMembers).omit({\n  id: true,\n  createdAt: true,\n});\nexport type TeamMember = typeof teamMembers.$inferSelect;\nexport type InsertTeamMember = z.infer<typeof insertTeamMemberSchema>;\n\n// Team Categories (Assigns maintenance categories to teams)\nexport const teamCategories = pgTable(\"team_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  teamId: varchar(\"team_id\").notNull(),\n  category: varchar(\"category\").notNull(), // Maintenance category (e.g., \"plumbing\", \"electrical\", \"hvac\")\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"team_categories_team_id_idx\").on(table.teamId),\n]);\n\nexport const insertTeamCategorySchema = createInsertSchema(teamCategories).omit({\n  id: true,\n  createdAt: true,\n});\nexport type TeamCategory = typeof teamCategories.$inferSelect;\nexport type InsertTeamCategory = z.infer<typeof insertTeamCategorySchema>;\n\n// Relations\nexport const usersRelations = relations(users, ({ one }) => ({\n  organization: one(organizations, {\n    fields: [users.organizationId],\n    references: [organizations.id],\n  }),\n}));\n\nexport const organizationsRelations = relations(organizations, ({ many }) => ({\n  blocks: many(blocks),\n  properties: many(properties),\n  inspectionCategories: many(inspectionCategories),\n  complianceDocuments: many(complianceDocuments),\n  creditTransactions: many(creditTransactions),\n  inventoryTemplates: many(inventoryTemplates),\n  workOrders: many(workOrders),\n  assetInventory: many(assetInventory),\n}));\n\nexport const blocksRelations = relations(blocks, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [blocks.organizationId],\n    references: [organizations.id],\n  }),\n  properties: many(properties),\n  assetInventory: many(assetInventory),\n}));\n\nexport const propertiesRelations = relations(properties, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [properties.organizationId],\n    references: [organizations.id],\n  }),\n  block: one(blocks, {\n    fields: [properties.blockId],\n    references: [blocks.id],\n  }),\n  inspections: many(inspections),\n  maintenanceRequests: many(maintenanceRequests),\n  inventories: many(inventories),\n  comparisonReports: many(comparisonReports),\n  assetInventory: many(assetInventory),\n}));\n\nexport const inspectionCategoriesRelations = relations(inspectionCategories, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [inspectionCategories.organizationId],\n    references: [organizations.id],\n  }),\n  items: many(inspectionItems),\n}));\n\nexport const inspectionsRelations = relations(inspections, ({ one, many }) => ({\n  block: one(blocks, {\n    fields: [inspections.blockId],\n    references: [blocks.id],\n  }),\n  property: one(properties, {\n    fields: [inspections.propertyId],\n    references: [properties.id],\n  }),\n  items: many(inspectionItems),\n}));\n\nexport const inspectionItemsRelations = relations(inspectionItems, ({ one }) => ({\n  inspection: one(inspections, {\n    fields: [inspectionItems.inspectionId],\n    references: [inspections.id],\n  }),\n  category: one(inspectionCategories, {\n    fields: [inspectionItems.categoryId],\n    references: [inspectionCategories.id],\n  }),\n}));\n\nexport const inventoryTemplatesRelations = relations(inventoryTemplates, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [inventoryTemplates.organizationId],\n    references: [organizations.id],\n  }),\n  inventories: many(inventories),\n}));\n\nexport const inventoriesRelations = relations(inventories, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [inventories.organizationId],\n    references: [organizations.id],\n  }),\n  property: one(properties, {\n    fields: [inventories.propertyId],\n    references: [properties.id],\n  }),\n  template: one(inventoryTemplates, {\n    fields: [inventories.templateId],\n    references: [inventoryTemplates.id],\n  }),\n  items: many(inventoryItems),\n}));\n\nexport const inventoryItemsRelations = relations(inventoryItems, ({ one }) => ({\n  inventory: one(inventories, {\n    fields: [inventoryItems.inventoryId],\n    references: [inventories.id],\n  }),\n}));\n\nexport const maintenanceRequestsRelations = relations(maintenanceRequests, ({ one, many }) => ({\n  property: one(properties, {\n    fields: [maintenanceRequests.propertyId],\n    references: [properties.id],\n  }),\n  workOrders: many(workOrders),\n}));\n\nexport const workOrdersRelations = relations(workOrders, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [workOrders.organizationId],\n    references: [organizations.id],\n  }),\n  maintenanceRequest: one(maintenanceRequests, {\n    fields: [workOrders.maintenanceRequestId],\n    references: [maintenanceRequests.id],\n  }),\n  logs: many(workLogs),\n}));\n\nexport const workLogsRelations = relations(workLogs, ({ one }) => ({\n  workOrder: one(workOrders, {\n    fields: [workLogs.workOrderId],\n    references: [workOrders.id],\n  }),\n}));\n\nexport const assetInventoryRelations = relations(assetInventory, ({ one }) => ({\n  organization: one(organizations, {\n    fields: [assetInventory.organizationId],\n    references: [organizations.id],\n  }),\n  property: one(properties, {\n    fields: [assetInventory.propertyId],\n    references: [properties.id],\n  }),\n  block: one(blocks, {\n    fields: [assetInventory.blockId],\n    references: [blocks.id],\n  }),\n}));\n\nexport const contactsRelations = relations(contacts, ({ one }) => ({\n  organization: one(organizations, {\n    fields: [contacts.organizationId],\n    references: [organizations.id],\n  }),\n  linkedUser: one(users, {\n    fields: [contacts.linkedUserId],\n    references: [users.id],\n  }),\n}));\n\n// Tags system\nexport const tags = pgTable(\"tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\").notNull(),\n  color: varchar(\"color\"), // Hex color code for the tag\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Tag join tables\nexport const blockTags = pgTable(\"block_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  blockId: varchar(\"block_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const propertyTags = pgTable(\"property_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  propertyId: varchar(\"property_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const userTags = pgTable(\"user_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const complianceDocumentTags = pgTable(\"compliance_document_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  complianceDocumentId: varchar(\"compliance_document_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const assetInventoryTags = pgTable(\"asset_inventory_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  assetInventoryId: varchar(\"asset_inventory_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const maintenanceRequestTags = pgTable(\"maintenance_request_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  maintenanceRequestId: varchar(\"maintenance_request_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const contactTags = pgTable(\"contact_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  contactId: varchar(\"contact_id\").notNull(),\n  tagId: varchar(\"tag_id\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Tag schemas\nexport const insertTagSchema = createInsertSchema(tags).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Tag = typeof tags.$inferSelect;\nexport type InsertTag = z.infer<typeof insertTagSchema>;\n\n// Tag relations\nexport const tagsRelations = relations(tags, ({ one, many }) => ({\n  organization: one(organizations, {\n    fields: [tags.organizationId],\n    references: [organizations.id],\n  }),\n  blockTags: many(blockTags),\n  propertyTags: many(propertyTags),\n  userTags: many(userTags),\n  complianceDocumentTags: many(complianceDocumentTags),\n  assetInventoryTags: many(assetInventoryTags),\n  maintenanceRequestTags: many(maintenanceRequestTags),\n  contactTags: many(contactTags),\n}));\n\nexport const blockTagsRelations = relations(blockTags, ({ one }) => ({\n  block: one(blocks, {\n    fields: [blockTags.blockId],\n    references: [blocks.id],\n  }),\n  tag: one(tags, {\n    fields: [blockTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const propertyTagsRelations = relations(propertyTags, ({ one }) => ({\n  property: one(properties, {\n    fields: [propertyTags.propertyId],\n    references: [properties.id],\n  }),\n  tag: one(tags, {\n    fields: [propertyTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const userTagsRelations = relations(userTags, ({ one }) => ({\n  user: one(users, {\n    fields: [userTags.userId],\n    references: [users.id],\n  }),\n  tag: one(tags, {\n    fields: [userTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const complianceDocumentTagsRelations = relations(complianceDocumentTags, ({ one }) => ({\n  complianceDocument: one(complianceDocuments, {\n    fields: [complianceDocumentTags.complianceDocumentId],\n    references: [complianceDocuments.id],\n  }),\n  tag: one(tags, {\n    fields: [complianceDocumentTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const assetInventoryTagsRelations = relations(assetInventoryTags, ({ one }) => ({\n  assetInventory: one(assetInventory, {\n    fields: [assetInventoryTags.assetInventoryId],\n    references: [assetInventory.id],\n  }),\n  tag: one(tags, {\n    fields: [assetInventoryTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const maintenanceRequestTagsRelations = relations(maintenanceRequestTags, ({ one }) => ({\n  maintenanceRequest: one(maintenanceRequests, {\n    fields: [maintenanceRequestTags.maintenanceRequestId],\n    references: [maintenanceRequests.id],\n  }),\n  tag: one(tags, {\n    fields: [maintenanceRequestTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const contactTagsRelations = relations(contactTags, ({ one }) => ({\n  contact: one(contacts, {\n    fields: [contactTags.contactId],\n    references: [contacts.id],\n  }),\n  tag: one(tags, {\n    fields: [contactTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\n// Dashboard Preferences\nexport const dashboardPreferences = pgTable(\"dashboard_preferences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull(),\n  enabledPanels: jsonb(\"enabled_panels\").notNull().default('[\"stats\", \"inspections\", \"compliance\", \"maintenance\"]'),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDashboardPreferencesSchema = createInsertSchema(dashboardPreferences).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type DashboardPreferences = typeof dashboardPreferences.$inferSelect;\nexport type InsertDashboardPreferences = z.infer<typeof insertDashboardPreferencesSchema>;\n\n// ==================== ADDITIONAL VALIDATION SCHEMAS ====================\n\n// Organization validation schemas\nexport const createOrganizationSchema = z.object({\n  name: z.string().min(1, \"Organization name is required\").max(255),\n});\n\n// Team management validation schemas\nexport const createTeamMemberSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  firstName: z.string().min(1).max(255).optional(),\n  lastName: z.string().min(1).max(255).optional(),\n  username: z.string().min(3, \"Username must be at least 3 characters\").max(100),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  role: z.enum([\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"]),\n  phone: z.string().max(50).optional(),\n  address: z.object({\n    street: z.string().optional(),\n    city: z.string().optional(),\n    state: z.string().optional(),\n    postalCode: z.string().optional(),\n    country: z.string().optional(),\n    formatted: z.string().optional(),\n  }).optional(),\n  skills: z.array(z.string()).optional(),\n  education: z.string().optional(),\n  profileImageUrl: z.union([z.string().url(), z.string().startsWith(\"/objects/\"), z.literal(\"\")]).optional(),\n  certificateUrls: z.array(z.union([z.string().url(), z.string().startsWith(\"/objects/\"), z.literal(\"\")])).optional(),\n});\n\nexport const updateTeamMemberSchema = z.object({\n  firstName: z.string().min(1).max(255).optional(),\n  lastName: z.string().min(1).max(255).optional(),\n  phone: z.string().max(50).optional(),\n  address: z.object({\n    street: z.string().optional(),\n    city: z.string().optional(),\n    state: z.string().optional(),\n    postalCode: z.string().optional(),\n    country: z.string().optional(),\n    formatted: z.string().optional(),\n  }).optional(),\n  skills: z.array(z.string()).optional(),\n  education: z.string().optional(),\n  profileImageUrl: z.union([z.string().url(), z.string().startsWith(\"/objects/\"), z.literal(\"\")]).optional(),\n  certificateUrls: z.array(z.union([z.string().url(), z.string().startsWith(\"/objects/\"), z.literal(\"\")])).optional(),\n  role: z.enum([\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"]).optional(),\n});\n\nexport const updateUserRoleSchema = z.object({\n  role: z.enum([\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"]),\n});\n\nexport const updateUserStatusSchema = z.object({\n  isActive: z.boolean(),\n});\n\nexport const updateSelfProfileSchema = z.object({\n  firstName: z.string().min(1).max(255).optional(),\n  lastName: z.string().min(1).max(255).optional(),\n  phone: z.string().max(50).optional(),\n  profileImageUrl: z.union([z.string().url(), z.string().startsWith(\"/objects/\"), z.literal(\"\")]).optional(),\n});\n\n// Property update schema\nexport const updatePropertySchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  address: z.string().min(1).optional(),\n  blockId: z.string().nullable().optional(),\n});\n\n// Compliance update schema\nexport const updateComplianceDocumentSchema = z.object({\n  documentType: z.string().min(1).optional(),\n  documentUrl: z.string().url().optional(),\n  expiryDate: z.string().datetime().optional().nullable(),\n  propertyId: z.string().nullable().optional(),\n  blockId: z.string().nullable().optional(),\n});\n\n// Maintenance update schema\nexport const updateMaintenanceRequestSchema = z.object({\n  title: z.string().min(1).max(255).optional(),\n  description: z.string().optional().nullable(),\n  status: z.enum([\"open\", \"in_progress\", \"completed\", \"closed\"]).optional(),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).optional(),\n  assignedTo: z.string().nullable().optional(),\n  photoUrls: z.array(z.string()).optional(),\n});\n\n// AI operation validation schemas\nexport const analyzePhotoSchema = z.object({\n  itemId: z.string().uuid(\"Invalid inspection item ID\"),\n});\n\nexport const inspectFieldSchema = z.object({\n  inspectionId: z.string().uuid(\"Invalid inspection ID\"),\n  fieldKey: z.string().min(1, \"Field key is required\"),\n  fieldLabel: z.string().min(1, \"Field label is required\"),\n  fieldDescription: z.string().optional(),\n  photos: z.array(z.string().min(1, \"Photo path or URL is required\")).min(1, \"At least one photo is required\"),\n});\n\nexport const generateComparisonSchema = z.object({\n  propertyId: z.string().uuid(\"Invalid property ID\"),\n  checkInInspectionId: z.string().uuid(\"Invalid check-in inspection ID\"),\n  checkOutInspectionId: z.string().uuid(\"Invalid check-out inspection ID\"),\n});\n\nexport const analyzeMaintenanceImageSchema = z.object({\n  imageUrl: z.string().url(\"Invalid image URL\"),\n  issueDescription: z.string().optional(),\n});\n\n// Contact update schema (for PATCH route)\nexport const updateContactSchema = z.object({\n  type: z.enum([\"internal\", \"contractor\", \"lead\", \"company\", \"partner\", \"vendor\", \"tenant\", \"other\"]).optional(),\n  firstName: z.string().min(1).max(255).optional(),\n  lastName: z.string().min(1).max(255).optional(),\n  email: z.string().email().optional(),\n  phone: z.string().optional(),\n  countryCode: z.string().optional(),\n  companyName: z.string().optional(),\n  jobTitle: z.string().optional(),\n  address: z.string().optional(),\n  city: z.string().optional(),\n  state: z.string().optional(),\n  postalCode: z.string().optional(),\n  country: z.string().optional(),\n  website: z.string().url().optional(),\n  notes: z.string().optional(),\n  profileImageUrl: z.string().url().optional(),\n  tags: z.array(z.string()).optional(),\n  linkedUserId: z.string().optional(),\n});\n\n// Tag update schema\nexport const updateTagSchema = z.object({\n  name: z.string().min(1).max(100).optional(),\n  color: z.string().regex(/^#[0-9A-F]{6}$/i, \"Invalid color hex code\").optional(),\n});\n\n// Dashboard preferences update schema\nexport const updateDashboardPreferencesSchema = z.object({\n  enabledPanels: z.array(z.string()).min(1, \"At least one panel must be enabled\"),\n});\n\n// Template category update schema\nexport const updateTemplateCategorySchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  description: z.string().optional(),\n  color: z.string().regex(/^#[0-9A-F]{6}$/i, \"Invalid color hex code\").optional(),\n});\n\n// Inspection update schema\nexport const updateInspectionSchema = z.object({\n  status: z.enum([\"scheduled\", \"in_progress\", \"completed\", \"reviewed\"]).optional(),\n  scheduledDate: z.string().datetime().optional(),\n  startedAt: z.string().datetime().optional(),\n  completedDate: z.string().datetime().optional(),\n  submittedAt: z.string().datetime().optional(),\n  notes: z.string().optional(),\n});\n\n// Block update schema\nexport const updateBlockSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  address: z.string().min(1).optional(),\n  notes: z.string().optional(),\n});\n\n// Subscription Plans\nexport const plans = pgTable(\"plans\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  code: planCodeEnum(\"code\").notNull().unique(),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  monthlyPriceGbp: integer(\"monthly_price_gbp\").notNull(), // Price in pence\n  annualPriceGbp: integer(\"annual_price_gbp\"), // Price in pence (nullable for plans without annual option)\n  includedCredits: integer(\"included_credits\").notNull(),\n  softCap: integer(\"soft_cap\").default(5000), // Fair usage limit for \"unlimited\" plans\n  isCustom: boolean(\"is_custom\").default(false),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPlanSchema = createInsertSchema(plans).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Plan = typeof plans.$inferSelect;\nexport type InsertPlan = z.infer<typeof insertPlanSchema>;\n\n// Country Pricing Overrides\nexport const countryPricingOverrides = pgTable(\"country_pricing_overrides\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  countryCode: varchar(\"country_code\", { length: 2 }).notNull(), // ISO 3166-1 alpha-2\n  planId: varchar(\"plan_id\").notNull(),\n  currency: currencyEnum(\"currency\").notNull(),\n  monthlyPriceMinorUnits: integer(\"monthly_price_minor_units\").notNull(), // Price in smallest currency unit (pence, cents, fils)\n  includedCreditsOverride: integer(\"included_credits_override\"),\n  topupPricePerCreditMinorUnits: integer(\"topup_price_per_credit_minor_units\"), // Per-credit price for top-ups\n  activeFrom: timestamp(\"active_from\").notNull().defaultNow(),\n  activeTo: timestamp(\"active_to\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_country_pricing_country_plan\").on(table.countryCode, table.planId),\n]);\n\nexport const insertCountryPricingOverrideSchema = createInsertSchema(countryPricingOverrides).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type CountryPricingOverride = typeof countryPricingOverrides.$inferSelect;\nexport type InsertCountryPricingOverride = z.infer<typeof insertCountryPricingOverrideSchema>;\n\n// Credit Bundles (Add-on Packages)\nexport const creditBundles = pgTable(\"credit_bundles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  credits: integer(\"credits\").notNull(),\n  priceGbp: integer(\"price_gbp\").notNull(), // Price in pence\n  priceUsd: integer(\"price_usd\").notNull(), // Price in cents\n  priceAed: integer(\"price_aed\").notNull(), // Price in fils\n  sortOrder: integer(\"sort_order\").default(0),\n  isPopular: boolean(\"is_popular\").default(false),\n  discountLabel: varchar(\"discount_label\", { length: 50 }),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertCreditBundleSchema = createInsertSchema(creditBundles).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type CreditBundle = typeof creditBundles.$inferSelect;\nexport type InsertCreditBundle = z.infer<typeof insertCreditBundleSchema>;\n\n// Subscriptions\nexport const subscriptions = pgTable(\"subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  planSnapshotJson: jsonb(\"plan_snapshot_json\").$type<{\n    planId: string;\n    planCode: string;\n    planName: string;\n    monthlyPrice: number;\n    includedCredits: number;\n    currency: string;\n  }>().notNull(),\n  stripeSubscriptionId: varchar(\"stripe_subscription_id\").unique(),\n  billingCycleAnchor: timestamp(\"billing_cycle_anchor\").notNull(),\n  currentPeriodStart: timestamp(\"current_period_start\").notNull(),\n  currentPeriodEnd: timestamp(\"current_period_end\").notNull(),\n  status: subscriptionStatusEnum(\"status\").notNull().default(\"active\"),\n  cancelAtPeriodEnd: boolean(\"cancel_at_period_end\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_subscriptions_org\").on(table.organizationId),\n  index(\"idx_subscriptions_period_end\").on(table.currentPeriodEnd),\n]);\n\nexport const insertSubscriptionSchema = createInsertSchema(subscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type Subscription = typeof subscriptions.$inferSelect;\nexport type InsertSubscription = z.infer<typeof insertSubscriptionSchema>;\n\n// Credit Batches (for FIFO consumption and rollover tracking)\nexport const creditBatches = pgTable(\"credit_batches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  grantedQuantity: integer(\"granted_quantity\").notNull(),\n  remainingQuantity: integer(\"remaining_quantity\").notNull(),\n  grantSource: creditSourceEnum(\"grant_source\").notNull(), // plan_inclusion, topup, admin_grant\n  grantedAt: timestamp(\"granted_at\").notNull().defaultNow(),\n  expiresAt: timestamp(\"expires_at\"), // null for non-expiring batches\n  unitCostMinorUnits: integer(\"unit_cost_minor_units\"), // For valuation\n  rolled: boolean(\"rolled\").default(false), // Indicates if this batch came from a rollover\n  metadataJson: jsonb(\"metadata_json\").$type<{\n    subscriptionId?: string;\n    topupOrderId?: string;\n    adminNotes?: string;\n  }>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_credit_batches_org_expires\").on(table.organizationId, table.expiresAt),\n  index(\"idx_credit_batches_org_granted\").on(table.organizationId, table.grantedAt),\n]);\n\nexport const insertCreditBatchSchema = createInsertSchema(creditBatches).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type CreditBatch = typeof creditBatches.$inferSelect;\nexport type InsertCreditBatch = z.infer<typeof insertCreditBatchSchema>;\n\n// Credit Ledger (transaction log for all credit movements)\nexport const creditLedger = pgTable(\"credit_ledger\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  createdBy: varchar(\"created_by\"), // User who initiated this transaction (for purchases, admin grants, etc.)\n  source: creditSourceEnum(\"source\").notNull(),\n  quantity: integer(\"quantity\").notNull(), // Positive for grants, negative for consumption\n  batchId: varchar(\"batch_id\"), // Links to credit_batches\n  unitCostMinorUnits: integer(\"unit_cost_minor_units\"), // For valuation\n  notes: text(\"notes\"),\n  linkedEntityType: varchar(\"linked_entity_type\"), // e.g., \"inspection\", \"topup_order\"\n  linkedEntityId: varchar(\"linked_entity_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_credit_ledger_org_created\").on(table.organizationId, table.createdAt),\n  index(\"idx_credit_ledger_batch\").on(table.batchId),\n]);\n\nexport const insertCreditLedgerSchema = createInsertSchema(creditLedger).omit({\n  id: true,\n  createdAt: true,\n});\nexport type CreditLedger = typeof creditLedger.$inferSelect;\nexport type InsertCreditLedger = z.infer<typeof insertCreditLedgerSchema>;\n\n// Top-up Orders\nexport const topupOrders = pgTable(\"topup_orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  packSize: integer(\"pack_size\").notNull(), // 100, 500, 1000, or custom\n  currency: currencyEnum(\"currency\").notNull(),\n  unitPriceMinorUnits: integer(\"unit_price_minor_units\").notNull(),\n  totalPriceMinorUnits: integer(\"total_price_minor_units\").notNull(),\n  stripePaymentIntentId: varchar(\"stripe_payment_intent_id\"),\n  status: topupStatusEnum(\"status\").notNull().default(\"pending\"),\n  deliveredBatchId: varchar(\"delivered_batch_id\"), // Links to credit_batches when delivered\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_topup_orders_org\").on(table.organizationId),\n]);\n\nexport const insertTopupOrderSchema = createInsertSchema(topupOrders).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type TopupOrder = typeof topupOrders.$inferSelect;\nexport type InsertTopupOrder = z.infer<typeof insertTopupOrderSchema>;\n\n// Message Templates (for broadcasting to tenants)\nexport const messageTemplates = pgTable(\"message_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: varchar(\"name\", { length: 255 }).notNull(),\n  subject: varchar(\"subject\", { length: 500 }).notNull(),\n  body: text(\"body\").notNull(),\n  description: text(\"description\"),\n  variables: text(\"variables\").array(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdBy: varchar(\"created_by\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertMessageTemplateSchema = createInsertSchema(messageTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateMessageTemplateSchema = z.object({\n  name: z.string().min(1).max(255).optional(),\n  subject: z.string().min(1).max(500).optional(),\n  body: z.string().min(1).optional(),\n  description: z.string().optional(),\n  variables: z.array(z.string()).optional(),\n  isActive: z.boolean().optional(),\n});\n\nexport type MessageTemplate = typeof messageTemplates.$inferSelect;\nexport type InsertMessageTemplate = z.infer<typeof insertMessageTemplateSchema>;\nexport type UpdateMessageTemplate = z.infer<typeof updateMessageTemplateSchema>;\n\n// Knowledge Base Documents (for AI chatbot)\nexport const knowledgeBaseDocuments = pgTable(\"knowledge_base_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: varchar(\"title\", { length: 500 }).notNull(),\n  fileName: varchar(\"file_name\", { length: 500 }).notNull(),\n  fileUrl: varchar(\"file_url\", { length: 1000 }).notNull(),\n  fileType: varchar(\"file_type\", { length: 100 }).notNull(), // pdf, docx, txt\n  fileSizeBytes: integer(\"file_size_bytes\").notNull(),\n  extractedText: text(\"extracted_text\"), // Full text content\n  category: varchar(\"category\", { length: 255 }), // e.g., \"User Guide\", \"Best Practices\", \"Compliance\"\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  uploadedBy: varchar(\"uploaded_by\").notNull(), // admin user ID\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_kb_docs_active\").on(table.isActive),\n  index(\"idx_kb_docs_category\").on(table.category),\n]);\n\nexport const insertKnowledgeBaseDocumentSchema = createInsertSchema(knowledgeBaseDocuments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type KnowledgeBaseDocument = typeof knowledgeBaseDocuments.$inferSelect;\nexport type InsertKnowledgeBaseDocument = z.infer<typeof insertKnowledgeBaseDocumentSchema>;\n\n// Chat Conversations (for AI chatbot)\nexport const chatConversations = pgTable(\"chat_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull(),\n  userId: varchar(\"user_id\").notNull(), // User who started the conversation\n  title: varchar(\"title\", { length: 500 }), // Auto-generated from first message\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_chat_conversations_user\").on(table.userId),\n  index(\"idx_chat_conversations_org\").on(table.organizationId),\n]);\n\nexport const insertChatConversationSchema = createInsertSchema(chatConversations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type ChatConversation = typeof chatConversations.$inferSelect;\nexport type InsertChatConversation = z.infer<typeof insertChatConversationSchema>;\n\n// Chat Messages (for AI chatbot)\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").notNull(),\n  role: varchar(\"role\", { length: 50 }).notNull(), // \"user\" or \"assistant\"\n  content: text(\"content\").notNull(),\n  sourceDocs: text(\"source_docs\").array(), // IDs of knowledge base docs used\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_chat_messages_conversation\").on(table.conversationId),\n]);\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type ChatMessage = typeof chatMessages.$inferSelect;\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\n\n// Export types for the new schemas\nexport type CreateOrganization = z.infer<typeof createOrganizationSchema>;\nexport type CreateTeamMember = z.infer<typeof createTeamMemberSchema>;\nexport type UpdateTeamMember = z.infer<typeof updateTeamMemberSchema>;\nexport type UpdateUserRole = z.infer<typeof updateUserRoleSchema>;\nexport type UpdateUserStatus = z.infer<typeof updateUserStatusSchema>;\nexport type UpdateSelfProfile = z.infer<typeof updateSelfProfileSchema>;\nexport type UpdateProperty = z.infer<typeof updatePropertySchema>;\nexport type UpdateComplianceDocument = z.infer<typeof updateComplianceDocumentSchema>;\nexport type UpdateMaintenanceRequest = z.infer<typeof updateMaintenanceRequestSchema>;\nexport type AnalyzePhoto = z.infer<typeof analyzePhotoSchema>;\nexport type InspectField = z.infer<typeof inspectFieldSchema>;\nexport type GenerateComparison = z.infer<typeof generateComparisonSchema>;\nexport type AnalyzeMaintenanceImage = z.infer<typeof analyzeMaintenanceImageSchema>;\nexport type UpdateContact = z.infer<typeof updateContactSchema>;\nexport type UpdateTag = z.infer<typeof updateTagSchema>;\nexport type UpdateDashboardPreferences = z.infer<typeof updateDashboardPreferencesSchema>;\nexport type UpdateTemplateCategory = z.infer<typeof updateTemplateCategorySchema>;\nexport type UpdateInspection = z.infer<typeof updateInspectionSchema>;\nexport type UpdateBlock = z.infer<typeof updateBlockSchema>;\n","size_bytes":82879},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/pages/Properties.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { TagInput } from \"@/components/TagInput\";\nimport { TagFilter } from \"@/components/TagFilter\";\nimport { AddressInput } from \"@/components/AddressInput\";\nimport type { Tag } from \"@shared/schema\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Plus, Building2, MapPin, Search, Package, ClipboardCheck, Users, FileText, ArrowLeft, Pencil, Tag as TagIcon } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link, useSearch } from \"wouter\";\n\nexport default function Properties() {\n  const { toast } = useToast();\n  const searchParams = useSearch();\n  const urlBlockId = new URLSearchParams(searchParams).get(\"blockId\");\n  \n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingProperty, setEditingProperty] = useState<any | null>(null);\n  const [name, setName] = useState(\"\");\n  const [address, setAddress] = useState(\"\");\n  const [blockId, setBlockId] = useState<string | undefined>();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterTags, setFilterTags] = useState<Tag[]>([]);\n  const [selectedTags, setSelectedTags] = useState<Tag[]>([]);\n\n  const { data: properties = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  // Fetch tags for all properties\n  const propertyIds = useMemo(() => properties.map(p => p.id).sort().join(','), [properties]);\n  const { data: propertyTagsMap = {} } = useQuery<Record<string, Tag[]>>({\n    queryKey: [\"/api/properties/tags\", propertyIds],\n    enabled: properties.length > 0,\n    queryFn: async () => {\n      const tagPromises = properties.map(async (property: any) => {\n        try {\n          const res = await fetch(`/api/properties/${property.id}/tags`, { credentials: \"include\" });\n          if (res.ok) {\n            const tags = await res.json();\n            return { propertyId: property.id, tags };\n          }\n        } catch (error) {\n          console.error(`Error fetching tags for property ${property.id}:`, error);\n        }\n        return { propertyId: property.id, tags: [] };\n      });\n      \n      const results = await Promise.all(tagPromises);\n      return results.reduce((acc, { propertyId, tags }) => {\n        acc[propertyId] = tags;\n        return acc;\n      }, {} as Record<string, Tag[]>);\n    },\n  });\n\n  // Merge tags into properties\n  const propertiesWithTags = useMemo(() => {\n    return properties.map(property => ({\n      ...property,\n      tags: propertyTagsMap[property.id] || [],\n    }));\n  }, [properties, propertyTagsMap]);\n\n  // Fetch block details if filtering by block\n  const { data: selectedBlock } = useQuery<any>({\n    queryKey: [\"/api/blocks\", urlBlockId],\n    enabled: !!urlBlockId,\n  });\n\n  // Filter properties by block (from URL), search query, and tags\n  const filteredProperties = useMemo(() => {\n    let filtered = propertiesWithTags;\n    \n    // First filter by blockId from URL if present\n    if (urlBlockId) {\n      filtered = filtered.filter(property => property.blockId === urlBlockId);\n    }\n    \n    // Then apply search query filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(property => \n        property.name.toLowerCase().includes(query) ||\n        property.address.toLowerCase().includes(query)\n      );\n    }\n\n    // Filter by tags (show properties that have ALL selected tags)\n    if (filterTags.length > 0) {\n      filtered = filtered.filter(property => {\n        if (!property.tags || property.tags.length === 0) return false;\n        return filterTags.every(filterTag =>\n          property.tags!.some((propertyTag: Tag) => propertyTag.id === filterTag.id)\n        );\n      });\n    }\n    \n    return filtered;\n  }, [propertiesWithTags, urlBlockId, searchQuery, filterTags]);\n\n  // Prepopulate form when dialog opens and we have a selected block (only for new properties, not edits)\n  useEffect(() => {\n    if (dialogOpen && !editingProperty && urlBlockId && selectedBlock) {\n      setAddress(selectedBlock.address || \"\");\n      setBlockId(urlBlockId);\n    }\n  }, [dialogOpen, editingProperty, urlBlockId, selectedBlock]);\n\n  const createProperty = useMutation({\n    mutationFn: async (data: { name: string; address: string; blockId?: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/properties\", data);\n      return await res.json();\n    },\n    onSuccess: async (property: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties/tags\"] });\n      \n      // Update tags for the newly created property\n      if (selectedTags.length > 0 && property?.id) {\n        await updatePropertyTags(property.id, selectedTags);\n      }\n      \n      toast({\n        title: \"Success\",\n        description: \"Property created successfully\",\n      });\n      handleCloseDialog();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create property\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateProperty = useMutation({\n    mutationFn: async (data: { id: string; name: string; address: string; blockId?: string }) => {\n      return await apiRequest(\"PATCH\", `/api/properties/${data.id}`, {\n        name: data.name,\n        address: data.address,\n        blockId: data.blockId,\n      });\n    },\n    onSuccess: async (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties/tags\"] });\n      \n      // Update tags for the property (always update, even if empty, to handle removals)\n      await updatePropertyTags(variables.id, selectedTags);\n      \n      toast({\n        title: \"Success\",\n        description: \"Property updated successfully\",\n      });\n      handleCloseDialog();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update property\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenCreate = () => {\n    setEditingProperty(null);\n    setName(\"\");\n    setAddress(\"\");\n    setBlockId(urlBlockId || undefined);\n    setSelectedTags([]);\n    setDialogOpen(true);\n  };\n\n  const handleOpenEdit = async (property: any) => {\n    setEditingProperty(property);\n    setName(property.name);\n    setAddress(property.address);\n    setBlockId(property.blockId || undefined);\n    \n    // Fetch tags for this property\n    try {\n      const res = await fetch(`/api/properties/${property.id}/tags`, { credentials: \"include\" });\n      if (res.ok) {\n        const tags = await res.json();\n        setSelectedTags(tags);\n      }\n    } catch (error) {\n      console.error(\"Error fetching property tags:\", error);\n    }\n    \n    setDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setDialogOpen(false);\n    setEditingProperty(null);\n    setName(\"\");\n    setAddress(\"\");\n    setBlockId(undefined);\n    setSelectedTags([]);\n  };\n\n  const updatePropertyTags = async (propertyId: string, tags: Tag[]) => {\n    // Get current tags for the property\n    try {\n      const res = await fetch(`/api/properties/${propertyId}/tags`, { credentials: \"include\" });\n      const currentTags = res.ok ? await res.json() : [];\n      \n      // Remove tags that are no longer selected\n      for (const currentTag of currentTags) {\n        if (!tags.find(t => t.id === currentTag.id)) {\n          await apiRequest(\"DELETE\", `/api/properties/${propertyId}/tags/${currentTag.id}`);\n        }\n      }\n      \n      // Add new tags\n      for (const tag of tags) {\n        if (!currentTags.find((t: Tag) => t.id === tag.id)) {\n          await apiRequest(\"POST\", `/api/properties/${propertyId}/tags/${tag.id}`);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error updating property tags:\", error);\n    }\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!name || !address) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    // Don't send blockId if \"none\" or undefined\n    const finalBlockId = blockId === \"none\" ? undefined : blockId;\n    \n    if (editingProperty) {\n      updateProperty.mutate({ id: editingProperty.id, name, address, blockId: finalBlockId });\n    } else {\n      createProperty.mutate({ name, address, blockId: finalBlockId });\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-8\">\n        <div className=\"text-muted-foreground\">Loading...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      {urlBlockId && selectedBlock && (\n        <Link href={`/blocks/${urlBlockId}`}>\n          <Button variant=\"ghost\" className=\"mb-4\" data-testid=\"button-back-to-block\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to {selectedBlock.name}\n          </Button>\n        </Link>\n      )}\n      \n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">\n            {urlBlockId && selectedBlock ? `${selectedBlock.name} - Properties` : \"Properties\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {urlBlockId && selectedBlock \n              ? `Properties in ${selectedBlock.name}` \n              : \"Manage your building portfolio\"\n            }\n          </p>\n        </div>\n\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button style={{ backgroundColor: '#00D2BD' }} className=\"hover:opacity-90\" data-testid=\"button-create-property\" onClick={handleOpenCreate}>\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Property\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>{editingProperty ? \"Edit Property\" : \"Create New Property\"}</DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"name\">Property Name *</Label>\n                <Input\n                  id=\"name\"\n                  value={name}\n                  onChange={(e) => setName(e.target.value)}\n                  placeholder=\"e.g., Flat 12, Unit 5B\"\n                  data-testid=\"input-property-name\"\n                  required\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"address\">Address *</Label>\n                <AddressInput\n                  id=\"address\"\n                  value={address}\n                  onChange={setAddress}\n                  placeholder=\"123 Main St, City, State ZIP\"\n                  data-testid=\"input-property-address\"\n                  required\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"block\">Block (Optional)</Label>\n                <Select value={blockId} onValueChange={setBlockId}>\n                  <SelectTrigger data-testid=\"select-block\">\n                    <SelectValue placeholder=\"Select a block\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">No Block</SelectItem>\n                    {blocks.map((block: any) => (\n                      <SelectItem key={block.id} value={block.id}>\n                        {block.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Assign this property to a building/block for better organization\n                </p>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Tags</Label>\n                <TagInput\n                  selectedTags={selectedTags}\n                  onTagsChange={setSelectedTags}\n                  placeholder=\"Add tags to organize this property...\"\n                />\n              </div>\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={createProperty.isPending || updateProperty.isPending}\n                data-testid=\"button-submit-property\"\n              >\n                {editingProperty \n                  ? (updateProperty.isPending ? \"Updating...\" : \"Update Property\")\n                  : (createProperty.isPending ? \"Creating...\" : \"Create Property\")\n                }\n              </Button>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Search and Tag Filter */}\n      {properties.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"relative max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n            <Input\n              placeholder=\"Search properties by name or address...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-properties\"\n            />\n          </div>\n          <TagFilter\n            selectedTags={filterTags}\n            onTagsChange={setFilterTags}\n            placeholder=\"Filter by tags...\"\n          />\n        </div>\n      )}\n\n      {properties.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <Building2 className=\"w-16 h-16 text-muted-foreground mb-4\" />\n            <p className=\"text-lg font-medium mb-2\">No properties yet</p>\n            <p className=\"text-muted-foreground mb-4\">Get started by adding your first property</p>\n          </CardContent>\n        </Card>\n      ) : filteredProperties.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <Search className=\"w-16 h-16 text-muted-foreground mb-4\" />\n            <p className=\"text-lg font-medium mb-2\">No properties found</p>\n            <p className=\"text-muted-foreground mb-4\">Try adjusting your search query</p>\n            <Button variant=\"outline\" onClick={() => setSearchQuery(\"\")}>\n              Clear Search\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredProperties.map((property: any) => {\n            const propertyBlock = blocks.find((b: any) => b.id === property.blockId);\n            return (\n              <Card key={property.id} className=\"hover-elevate\" data-testid={`card-property-${property.id}`}>\n                <Link href={`/properties/${property.id}`}>\n                  <CardHeader className=\"cursor-pointer\">\n                    <CardTitle className=\"flex items-center justify-between gap-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"w-5 h-5 text-primary\" />\n                        {property.name}\n                      </div>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className=\"h-8 w-8\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          e.stopPropagation();\n                          handleOpenEdit(property);\n                        }}\n                        data-testid={`button-edit-property-${property.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 cursor-pointer pb-4\">\n                    <p className=\"text-sm text-muted-foreground\">{property.address}</p>\n                    {propertyBlock && (\n                      <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                        <MapPin className=\"w-3 h-3\" />\n                        {propertyBlock.name}\n                      </p>\n                    )}\n                    {property.tags && property.tags.length > 0 && (\n                      <div className=\"flex flex-wrap gap-1 pt-1\">\n                        {property.tags.map((tag: Tag) => (\n                          <span\n                            key={tag.id}\n                            className=\"inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-md\"\n                            style={{ backgroundColor: tag.color || '#e2e8f0' }}\n                            data-testid={`tag-${property.id}-${tag.id}`}\n                          >\n                            <TagIcon className=\"h-3 w-3\" />\n                            {tag.name}\n                          </span>\n                        ))}\n                      </div>\n                    )}\n                  </CardContent>\n                </Link>\n                <CardContent className=\"pt-0 border-t\">\n                  <div className=\"flex items-center justify-around pt-4\">\n                    <Link href={`/asset-inventory?propertyId=${property.id}`}>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"flex flex-col h-auto py-2 px-3\"\n                        data-testid={`button-inventory-${property.id}`}\n                      >\n                        <Package className=\"h-4 w-4 mb-1\" />\n                        <span className=\"text-xs\">Inventory</span>\n                      </Button>\n                    </Link>\n                    <Link href={`/inspections?propertyId=${property.id}&create=true`}>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"flex flex-col h-auto py-2 px-3\"\n                        data-testid={`button-inspect-${property.id}`}\n                      >\n                        <ClipboardCheck className=\"h-4 w-4 mb-1\" />\n                        <span className=\"text-xs\">Inspect</span>\n                      </Button>\n                    </Link>\n                    <Link href={`/properties/${property.id}/tenants`}>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"flex flex-col h-auto py-2 px-3\"\n                        data-testid={`button-tenants-${property.id}`}\n                      >\n                        <Users className=\"h-4 w-4 mb-1\" />\n                        <span className=\"text-xs\">Tenants</span>\n                      </Button>\n                    </Link>\n                    <Link href={`/compliance?propertyId=${property.id}`}>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"flex flex-col h-auto py-2 px-3\"\n                        data-testid={`button-compliance-${property.id}`}\n                      >\n                        <FileText className=\"h-4 w-4 mb-1\" />\n                        <span className=\"text-xs\">Compliance</span>\n                      </Button>\n                    </Link>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":20103},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport { offlineQueue } from \"./lib/offlineQueue\";\nimport { apiRequest } from \"./lib/queryClient\";\n\n// Listen for messages from service worker\nif ('serviceWorker' in navigator) {\n  navigator.serviceWorker.addEventListener('message', async (event) => {\n    if (event.data && event.data.type === 'REQUEST_SYNC') {\n      console.log('[Client] Received sync request from service worker');\n      \n      // Get the MessageChannel port from the event\n      const port = event.ports[0];\n      \n      try {\n        // Trigger offline queue sync\n        const result = await offlineQueue.syncAll(apiRequest);\n        console.log('[Client] Sync complete:', result);\n        \n        // Send result back to service worker via MessageChannel\n        if (port) {\n          port.postMessage({\n            type: 'SYNC_RESULT',\n            success: result.success,\n            failed: result.failed\n          });\n        }\n      } catch (error) {\n        console.error('[Client] Sync failed:', error);\n        \n        // Send error back to service worker via MessageChannel\n        if (port) {\n          port.postMessage({\n            type: 'SYNC_ERROR',\n            error: error instanceof Error ? error.message : 'Unknown sync error'\n          });\n        }\n      }\n    }\n  });\n}\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":1423},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4050},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/pages/Landing.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Building2, ClipboardCheck, Sparkles, Shield, Users, TrendingUp } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport logoUrl from \"@assets/Inspect360 Logo_1761302629835.png\";\n\nexport default function Landing() {\n  const [, navigate] = useLocation();\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-background to-muted/20\">\n      {/* Header/Nav */}\n      <header className=\"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <img src={logoUrl} alt=\"Inspect360\" className=\"h-10\" />\n          </div>\n          <Button\n            onClick={() => (navigate(\"/auth\"))}\n            variant=\"outline\"\n            data-testid=\"button-login-header\"\n          >\n            Sign In\n          </Button>\n        </div>\n      </header>\n\n      {/* Hero Section */}\n      <section className=\"container mx-auto px-4 py-20 md:py-32\">\n        <div className=\"max-w-4xl mx-auto text-center space-y-8\">\n          <div className=\"inline-block rounded-lg bg-accent/10 px-4 py-2 text-sm font-medium text-accent mb-4\">\n            AI-Powered Property Inspections\n          </div>\n          <h1 className=\"text-4xl md:text-6xl font-bold tracking-tight\">\n            Building Inspection Platform for{\" \"}\n            <span className=\"text-primary\">Build-to-Rent</span> Operations\n          </h1>\n          <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto\">\n            Streamline property inspections with AI-powered photo analysis, offline mobile support, \n            and comprehensive compliance tracking for modern rental operations.\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center\">\n            <Button\n              size=\"lg\"\n              onClick={() => (navigate(\"/auth\"))}\n              className=\"text-lg px-8\"\n              data-testid=\"button-get-started\"\n            >\n              Get Started Free\n            </Button>\n            <Button\n              size=\"lg\"\n              variant=\"outline\"\n              onClick={() => (navigate(\"/auth\"))}\n              className=\"text-lg px-8\"\n              data-testid=\"button-sign-in\"\n            >\n              Sign In\n            </Button>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            No credit card required  Start with 5 free AI credits\n          </p>\n        </div>\n      </section>\n\n      {/* Features Grid */}\n      <section className=\"container mx-auto px-4 py-16\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl font-bold mb-4\">Everything You Need</h2>\n          <p className=\"text-muted-foreground max-w-2xl mx-auto\">\n            Comprehensive tools for property managers, inspectors, compliance officers, and tenants\n          </p>\n        </div>\n        <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto\">\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <Building2 className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>Property Management</CardTitle>\n              <CardDescription>\n                Manage multiple properties and units with ease. Track inspections, maintenance, and tenant assignments all in one place.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <ClipboardCheck className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>Mobile Inspections</CardTitle>\n              <CardDescription>\n                PWA-ready offline inspections with photo capture. Conduct inspections in the field without internet connectivity.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <Sparkles className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>AI Photo Analysis</CardTitle>\n              <CardDescription>\n                OpenAI-powered analysis of inspection photos. Automatically detect damage, wear, and generate detailed condition reports.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <Shield className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>Compliance Tracking</CardTitle>\n              <CardDescription>\n                Track certificates, licenses, and documents with expiry alerts. Stay compliant with automated reminders.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <Users className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>Tenant Portal</CardTitle>\n              <CardDescription>\n                Self-service portal for tenants to submit maintenance requests and view comparison reports for their units.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <TrendingUp className=\"w-12 h-12 text-accent mb-2\" />\n              <CardTitle>Comparison Reports</CardTitle>\n              <CardDescription>\n                AI-generated check-in vs check-out comparisons. Make informed decisions about security deposits.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n        </div>\n      </section>\n\n      {/* How It Works */}\n      <section className=\"container mx-auto px-4 py-16 bg-muted/30 rounded-xl my-16\">\n        <div className=\"max-w-4xl mx-auto\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl font-bold mb-4\">How It Works</h2>\n            <p className=\"text-muted-foreground\">Get started in minutes with our simple workflow</p>\n          </div>\n          <div className=\"grid md:grid-cols-3 gap-8\">\n            <div className=\"text-center space-y-4\">\n              <div className=\"w-16 h-16 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-2xl font-bold mx-auto\">\n                1\n              </div>\n              <h3 className=\"text-xl font-semibold\">Create Account</h3>\n              <p className=\"text-muted-foreground\">\n                Sign up and set up your organization with properties and units\n              </p>\n            </div>\n            <div className=\"text-center space-y-4\">\n              <div className=\"w-16 h-16 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-2xl font-bold mx-auto\">\n                2\n              </div>\n              <h3 className=\"text-xl font-semibold\">Conduct Inspections</h3>\n              <p className=\"text-muted-foreground\">\n                Use mobile app to capture photos and rate conditions during inspections\n              </p>\n            </div>\n            <div className=\"text-center space-y-4\">\n              <div className=\"w-16 h-16 rounded-full bg-accent text-accent-foreground flex items-center justify-center text-2xl font-bold mx-auto\">\n                3\n              </div>\n              <h3 className=\"text-xl font-semibold\">AI Analysis</h3>\n              <p className=\"text-muted-foreground\">\n                Generate AI-powered reports and comparison analysis automatically\n              </p>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* CTA Section */}\n      <section className=\"container mx-auto px-4 py-20\">\n        <div className=\"max-w-3xl mx-auto text-center space-y-6 bg-primary text-primary-foreground rounded-xl p-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold\">\n            Ready to Transform Your Inspection Process?\n          </h2>\n          <p className=\"text-lg opacity-90\">\n            Join property managers who are saving time and improving accuracy with AI-powered inspections\n          </p>\n          <Button\n            size=\"lg\"\n            variant=\"secondary\"\n            onClick={() => (navigate(\"/auth\"))}\n            className=\"text-lg px-8\"\n            data-testid=\"button-cta-bottom\"\n          >\n            Get Started Now\n          </Button>\n        </div>\n      </section>\n\n      {/* Footer */}\n      <footer className=\"border-t bg-muted/30 mt-16\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <div className=\"text-center text-muted-foreground\">\n            <p>&copy; 2025 Inspect360. All rights reserved.</p>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","size_bytes":8849},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    let errorMessage = res.statusText;\n    \n    try {\n      const contentType = res.headers.get(\"content-type\");\n      if (contentType && contentType.includes(\"application/json\")) {\n        const errorData = await res.json();\n        errorMessage = errorData.message || errorData.error || JSON.stringify(errorData);\n      } else {\n        errorMessage = await res.text() || res.statusText;\n      }\n    } catch (e) {\n      // If parsing fails, use status text\n      errorMessage = res.statusText;\n    }\n    \n    throw new Error(errorMessage);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      refetchOnMount: true, // Refetch when component mounts (after invalidation)\n      staleTime: 0, // Allow queries to refetch after invalidation\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1945},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/pages/Dashboard.tsx":{"content":"import { useEffect, useState, useMemo } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Building2, \n  ClipboardCheck, \n  FileText, \n  CreditCard, \n  AlertCircle, \n  Search, \n  Settings,\n  TrendingUp,\n  Users,\n  Wrench,\n  Package,\n  Eye,\n  EyeOff\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { TagSearch } from \"@/components/TagSearch\";\nimport { \n  BarChart, \n  Bar, \n  LineChart, \n  Line, \n  PieChart, \n  Pie, \n  Cell,\n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  Legend, \n  ResponsiveContainer \n} from \"recharts\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Property, Inspection, ComplianceDocument, MaintenanceRequest, Block } from \"@shared/schema\";\n\ntype InspectionWithDetails = Inspection & {\n  property?: Property;\n  block?: Block;\n  clerk?: { firstName: string | null; lastName: string | null };\n};\n\ntype PanelType = \n  | \"stats\" \n  | \"inspections\" \n  | \"compliance\" \n  | \"maintenance\" \n  | \"assets\"\n  | \"workOrders\"\n  | \"inspectionTrend\"\n  | \"statusDistribution\"\n  | \"credits\";\n\ninterface PanelConfig {\n  id: PanelType;\n  title: string;\n  icon: any;\n  roles: string[];\n  description: string;\n}\n\nconst AVAILABLE_PANELS: PanelConfig[] = [\n  { \n    id: \"stats\", \n    title: \"Quick Stats\", \n    icon: TrendingUp, \n    roles: [\"owner\", \"clerk\", \"compliance\"],\n    description: \"Overview of properties, blocks, and inspections\"\n  },\n  { \n    id: \"inspections\", \n    title: \"Recent Inspections\", \n    icon: ClipboardCheck, \n    roles: [\"owner\", \"clerk\"],\n    description: \"Latest inspection activities\"\n  },\n  { \n    id: \"compliance\", \n    title: \"Compliance Documents\", \n    icon: FileText, \n    roles: [\"owner\", \"compliance\"],\n    description: \"Expiring compliance documents\"\n  },\n  { \n    id: \"maintenance\", \n    title: \"Maintenance Requests\", \n    icon: Wrench, \n    roles: [\"owner\", \"clerk\"],\n    description: \"Open maintenance requests\"\n  },\n  { \n    id: \"assets\", \n    title: \"Asset Inventory\", \n    icon: Package, \n    roles: [\"owner\", \"clerk\"],\n    description: \"Assets needing attention\"\n  },\n  { \n    id: \"workOrders\", \n    title: \"Work Orders\", \n    icon: Users, \n    roles: [\"owner\", \"contractor\"],\n    description: \"Active work orders\"\n  },\n  { \n    id: \"inspectionTrend\", \n    title: \"Inspection Trend\", \n    icon: TrendingUp, \n    roles: [\"owner\", \"clerk\"],\n    description: \"Inspection activity over time\"\n  },\n  { \n    id: \"statusDistribution\", \n    title: \"Status Distribution\", \n    icon: TrendingUp, \n    roles: [\"owner\", \"clerk\", \"compliance\"],\n    description: \"Distribution of inspection statuses\"\n  },\n  { \n    id: \"credits\", \n    title: \"AI Credits\", \n    icon: CreditCard, \n    roles: [\"owner\"],\n    description: \"Credit usage and balance\"\n  },\n];\n\nconst COLORS = ['hsl(199, 79%, 63%)', 'hsl(214, 100%, 50%)', 'hsl(142, 71%, 45%)', 'hsl(38, 92%, 50%)', 'hsl(0, 72%, 51%)'];\n\nexport default function Dashboard() {\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const [tagSearchOpen, setTagSearchOpen] = useState(false);\n  const [configDialogOpen, setConfigDialogOpen] = useState(false);\n  const [viewRole, setViewRole] = useState<string>(\"\");\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n    if (user && !viewRole) {\n      setViewRole(user.role);\n    }\n  }, [isAuthenticated, isLoading, toast, user, viewRole]);\n\n  const { data: properties = [] } = useQuery<Property[]>({\n    queryKey: [\"/api/properties\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: inspections = [] } = useQuery<InspectionWithDetails[]>({\n    queryKey: [\"/api/inspections/my\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: blocks = [] } = useQuery<Block[]>({\n    queryKey: [\"/api/blocks\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: compliance = [] } = useQuery<ComplianceDocument[]>({\n    queryKey: [\"/api/compliance/expiring\", { days: 90 }],\n    enabled: isAuthenticated && (user?.role === \"owner\" || user?.role === \"compliance\"),\n  });\n\n  const { data: maintenance = [] } = useQuery<MaintenanceRequest[]>({\n    queryKey: [\"/api/maintenance\"],\n    enabled: isAuthenticated && (user?.role === \"owner\" || user?.role === \"clerk\"),\n  });\n\n  const { data: assets = [] } = useQuery<any[]>({\n    queryKey: [\"/api/asset-inventory\"],\n    enabled: isAuthenticated && (user?.role === \"owner\" || user?.role === \"clerk\"),\n  });\n\n  const { data: workOrders = [] } = useQuery<any[]>({\n    queryKey: [\"/api/work-orders\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: organization } = useQuery<{creditsRemaining: number | null}>({\n    queryKey: [\"/api/organizations\", user?.organizationId],\n    queryFn: async () => {\n      const res = await fetch(`/api/organizations/${user?.organizationId}`);\n      if (!res.ok) throw new Error(\"Failed to fetch organization\");\n      return res.json();\n    },\n    enabled: isAuthenticated && !!user?.organizationId && user?.role === \"owner\",\n  });\n\n  const { data: preferences } = useQuery<{ enabledPanels: string[] }>({\n    queryKey: [\"/api/dashboard/preferences\"],\n    enabled: isAuthenticated,\n  });\n\n  const updatePreferences = useMutation({\n    mutationFn: async (enabledPanels: string[]) => {\n      return await apiRequest(\"PUT\", \"/api/dashboard/preferences\", { enabledPanels });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/preferences\"] });\n      toast({\n        title: \"Success\",\n        description: \"Dashboard preferences updated\",\n      });\n    },\n  });\n\n  const enabledPanels = useMemo(() => {\n    if (preferences?.enabledPanels) {\n      if (typeof preferences.enabledPanels === \"string\") {\n        return JSON.parse(preferences.enabledPanels as any);\n      }\n      return preferences.enabledPanels;\n    }\n    return [\"stats\", \"inspections\", \"compliance\", \"maintenance\"];\n  }, [preferences]);\n\n  const availablePanelsForRole = useMemo(() => {\n    return AVAILABLE_PANELS.filter(panel => panel.roles.includes(viewRole));\n  }, [viewRole]);\n\n  const togglePanel = (panelId: PanelType) => {\n    const newPanels = enabledPanels.includes(panelId)\n      ? enabledPanels.filter((p: string) => p !== panelId)\n      : [...enabledPanels, panelId];\n    updatePreferences.mutate(newPanels);\n  };\n\n  const inspectionTrendData = useMemo(() => {\n    const last7Days = Array.from({ length: 7 }, (_, i) => {\n      const date = new Date();\n      date.setDate(date.getDate() - (6 - i));\n      return date.toISOString().split('T')[0];\n    });\n\n    return last7Days.map(date => {\n      const count = inspections.filter(i => \n        i.createdAt && new Date(i.createdAt).toISOString().split('T')[0] === date\n      ).length;\n      return {\n        date: new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),\n        count\n      };\n    });\n  }, [inspections]);\n\n  const statusDistributionData = useMemo(() => {\n    const statusCounts: Record<string, number> = {};\n    inspections.forEach(i => {\n      statusCounts[i.status] = (statusCounts[i.status] || 0) + 1;\n    });\n    return Object.entries(statusCounts).map(([name, value]) => ({ name, value }));\n  }, [inspections]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div className=\"text-muted-foreground\">Loading...</div>\n      </div>\n    );\n  }\n\n  const creditsRemaining = organization?.creditsRemaining ?? 0;\n  const creditsLow = creditsRemaining < 5;\n\n  const shouldShowPanel = (panelId: PanelType) => {\n    const panel = AVAILABLE_PANELS.find(p => p.id === panelId);\n    return panel && panel.roles.includes(viewRole) && enabledPanels.includes(panelId);\n  };\n\n  return (\n    <div className=\"p-4 md:p-6 lg:p-8 xl:p-12 space-y-6 md:space-y-8\">\n      {/* Header Section */}\n      <div className=\"flex flex-col gap-4\">\n        <div className=\"space-y-1\">\n          <h1 className=\"text-3xl md:text-4xl lg:text-5xl font-bold tracking-tight text-foreground\" data-testid=\"text-dashboard-title\">\n            Dashboard\n          </h1>\n          <p className=\"text-sm md:text-base lg:text-lg text-muted-foreground\">\n            Welcome back, <span className=\"font-medium text-foreground\">{user?.firstName || user?.email}</span>\n          </p>\n        </div>\n        <div className=\"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3\">\n          {user?.role === \"owner\" && (\n            <Select value={viewRole} onValueChange={setViewRole}>\n              <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-view-role\">\n                <SelectValue placeholder=\"View as...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"owner\" data-testid=\"option-owner\">Owner View</SelectItem>\n                <SelectItem value=\"clerk\" data-testid=\"option-clerk\">Clerk View</SelectItem>\n                <SelectItem value=\"compliance\" data-testid=\"option-compliance\">Compliance View</SelectItem>\n              </SelectContent>\n            </Select>\n          )}\n          <div className=\"flex gap-2 sm:gap-3\">\n            <Dialog open={configDialogOpen} onOpenChange={setConfigDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" className=\"gap-2 flex-1 sm:flex-initial\" data-testid=\"button-configure-panels\">\n                  <Settings className=\"h-4 w-4\" />\n                  <span className=\"hidden sm:inline\">Configure</span>\n                  <span className=\"sm:hidden\">Config</span>\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Configure Dashboard Panels</DialogTitle>\n                  <DialogDescription>\n                    Select which panels you want to see on your dashboard\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"grid gap-4 py-4\">\n                  {availablePanelsForRole.map((panel) => {\n                    const Icon = panel.icon;\n                    const isEnabled = enabledPanels.includes(panel.id);\n                    return (\n                      <div \n                        key={panel.id} \n                        className=\"flex items-start gap-4 p-4 border rounded-xl hover-elevate cursor-pointer\"\n                        onClick={() => togglePanel(panel.id)}\n                        data-testid={`panel-config-${panel.id}`}\n                      >\n                        <Checkbox \n                          checked={isEnabled} \n                          onCheckedChange={() => togglePanel(panel.id)}\n                          data-testid={`checkbox-panel-${panel.id}`}\n                        />\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <Icon className=\"h-4 w-4 text-primary\" />\n                            <span className=\"font-semibold\">{panel.title}</span>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground\">{panel.description}</p>\n                        </div>\n                        {isEnabled ? (\n                          <Eye className=\"h-5 w-5 text-primary\" />\n                        ) : (\n                          <EyeOff className=\"h-5 w-5 text-muted-foreground\" />\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              </DialogContent>\n            </Dialog>\n            <Button \n              onClick={() => setTagSearchOpen(true)} \n              variant=\"outline\"\n              className=\"gap-2 flex-1 sm:flex-initial\"\n              data-testid=\"button-search-tags\"\n            >\n              <Search className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Search by Tags</span>\n              <span className=\"sm:hidden\">Search</span>\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Credits Low Alert */}\n      {creditsLow && user?.role === \"owner\" && (\n        <Card className=\"border-destructive/30 bg-destructive/5\">\n          <CardContent className=\"flex flex-col gap-4 p-4 md:p-6\">\n            <div className=\"flex items-start gap-3 md:gap-4\">\n              <div className=\"flex-shrink-0 w-10 h-10 md:w-12 md:h-12 rounded-full bg-destructive/10 flex items-center justify-center\">\n                <AlertCircle className=\"w-5 h-5 md:w-6 md:h-6 text-destructive\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"font-semibold text-base md:text-lg\">Inspection credits low</p>\n                <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">\n                  You have {creditsRemaining} credits remaining. Purchase more to avoid blocking submissions.\n                </p>\n              </div>\n            </div>\n            <Link href=\"/credits\" className=\"w-full sm:w-auto sm:self-end\">\n              <Button variant=\"default\" className=\"w-full sm:w-auto\" data-testid=\"button-purchase-credits\">\n                Purchase Credits\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      )}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 lg:gap-8\">\n        {/* Quick Stats Panel */}\n        {shouldShowPanel(\"stats\") && (\n          <Card className=\"xl:col-span-3\" data-testid=\"panel-stats\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Quick Stats\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4\">\n                <Link href=\"/properties\">\n                  <div className=\"p-4 md:p-6 bg-card/50 rounded-xl border hover-elevate cursor-pointer transition-all\" data-testid=\"stat-properties\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <Building2 className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n                      </div>\n                    </div>\n                    <p className=\"text-2xl md:text-3xl font-bold\">{properties.length}</p>\n                    <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">Properties</p>\n                  </div>\n                </Link>\n                <Link href=\"/blocks\">\n                  <div className=\"p-4 md:p-6 bg-card/50 rounded-xl border hover-elevate cursor-pointer transition-all\" data-testid=\"stat-blocks\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <Building2 className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n                      </div>\n                    </div>\n                    <p className=\"text-2xl md:text-3xl font-bold\">{blocks.length}</p>\n                    <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">Blocks</p>\n                  </div>\n                </Link>\n                <Link href=\"/inspections\">\n                  <div className=\"p-4 md:p-6 bg-card/50 rounded-xl border hover-elevate cursor-pointer transition-all\" data-testid=\"stat-inspections\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <ClipboardCheck className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n                      </div>\n                    </div>\n                    <p className=\"text-2xl md:text-3xl font-bold\">{inspections.length}</p>\n                    <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">Inspections</p>\n                  </div>\n                </Link>\n                {viewRole === \"owner\" && (\n                  <Link href=\"/billing?action=topup\">\n                    <div className=\"p-4 md:p-6 bg-card/50 rounded-xl border hover-elevate cursor-pointer transition-all\" data-testid=\"stat-credits\">\n                      <div className=\"flex items-center gap-3 mb-2\">\n                        <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                          <CreditCard className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n                        </div>\n                      </div>\n                      <p className=\"text-2xl md:text-3xl font-bold\">{creditsRemaining}</p>\n                      <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">AI Credits</p>\n                    </div>\n                  </Link>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Inspection Trend Chart */}\n        {shouldShowPanel(\"inspectionTrend\") && (\n          <Card className=\"lg:col-span-2\" data-testid=\"panel-inspection-trend\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold\">Inspection Activity (Last 7 Days)</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-[250px] md:h-[300px]\" data-testid=\"chart-wrapper-line\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <LineChart data={inspectionTrendData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                    <XAxis \n                      dataKey=\"date\" \n                      stroke=\"hsl(var(--muted-foreground))\" \n                      tick={{ fontSize: 12 }}\n                    />\n                    <YAxis \n                      stroke=\"hsl(var(--muted-foreground))\" \n                      tick={{ fontSize: 12 }}\n                    />\n                    <Tooltip \n                      contentStyle={{ \n                        backgroundColor: 'hsl(var(--background))', \n                        border: '1px solid hsl(var(--border))',\n                        borderRadius: '0.75rem',\n                        fontSize: '0.875rem'\n                      }} \n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"count\" \n                      stroke=\"hsl(199, 79%, 63%)\" \n                      strokeWidth={2}\n                      dot={{ fill: 'hsl(199, 79%, 63%)', r: 3 }}\n                    />\n                  </LineChart>\n                </ResponsiveContainer>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Status Distribution Chart */}\n        {shouldShowPanel(\"statusDistribution\") && (\n          <Card data-testid=\"panel-status-distribution\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold\">Inspection Status</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-[250px] md:h-[300px]\" data-testid=\"chart-wrapper-pie\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <PieChart>\n                    <Pie\n                      data={statusDistributionData}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      labelLine={false}\n                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                      outerRadius={80}\n                      fill=\"#8884d8\"\n                      dataKey=\"value\"\n                    >\n                      {statusDistributionData.map((entry, index) => (\n                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                      ))}\n                    </Pie>\n                    <Tooltip \n                      contentStyle={{ \n                        backgroundColor: 'hsl(var(--background))', \n                        border: '1px solid hsl(var(--border))',\n                        borderRadius: '0.75rem',\n                        fontSize: '0.875rem'\n                      }} \n                    />\n                  </PieChart>\n                </ResponsiveContainer>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Recent Inspections */}\n        {shouldShowPanel(\"inspections\") && (\n          <Card className=\"lg:col-span-2\" data-testid=\"panel-inspections\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <ClipboardCheck className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Recent Inspections\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {inspections.length > 0 ? (\n                <div className=\"space-y-2 md:space-y-3\">\n                  {inspections.slice(0, 5).map((inspection) => (\n                    <Link key={inspection.id} href={`/inspections/${inspection.id}`}>\n                      <div\n                        className=\"flex items-center justify-between gap-3 md:gap-4 p-4 md:p-5 border rounded-xl hover-elevate cursor-pointer transition-all bg-card/50\"\n                        data-testid={`card-inspection-${inspection.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-semibold text-base md:text-lg truncate\">\n                            {inspection.property?.name || inspection.block?.name || \"Unknown Property\"}\n                          </p>\n                          <p className=\"text-xs md:text-sm text-muted-foreground truncate mt-1\">\n                            {inspection.type}  {inspection.scheduledDate ? new Date(inspection.scheduledDate).toLocaleDateString() : 'Not scheduled'}\n                          </p>\n                        </div>\n                        <Badge\n                          variant={\n                            inspection.status === \"completed\"\n                              ? \"default\"\n                              : inspection.status === \"in_progress\"\n                              ? \"secondary\"\n                              : \"outline\"\n                          }\n                          className=\"whitespace-nowrap text-xs\"\n                          data-testid={`badge-status-${inspection.id}`}\n                        >\n                          {inspection.status}\n                        </Badge>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 md:py-12\" data-testid=\"empty-inspections\">\n                  <ClipboardCheck className=\"h-10 w-10 md:h-12 md:w-12 text-muted-foreground/30 mx-auto mb-3 md:mb-4\" />\n                  <p className=\"text-sm md:text-base text-muted-foreground\">No inspections yet</p>\n                  <Link href=\"/inspections\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3 md:mt-4\">\n                      Create Inspection\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Compliance Documents */}\n        {shouldShowPanel(\"compliance\") && (\n          <Card data-testid=\"panel-compliance\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <FileText className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Expiring Soon\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {compliance.length > 0 ? (\n                <div className=\"space-y-2 md:space-y-3\">\n                  {compliance.slice(0, 5).map((doc) => (\n                    <Link key={doc.id} href=\"/compliance\">\n                      <div\n                        className=\"flex items-center justify-between gap-3 md:gap-4 p-4 md:p-5 border rounded-xl hover-elevate cursor-pointer transition-all bg-card/50\"\n                        data-testid={`card-compliance-${doc.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-semibold text-base md:text-lg truncate\">{doc.documentType}</p>\n                          <p className=\"text-xs md:text-sm text-muted-foreground truncate mt-1\">\n                            Expires: {doc.expiryDate ? new Date(doc.expiryDate).toLocaleDateString() : 'No expiry date'}\n                          </p>\n                        </div>\n                        <Badge\n                          variant={\n                            doc.status === \"current\"\n                              ? \"default\"\n                              : doc.status === \"expiring_soon\"\n                              ? \"secondary\"\n                              : \"destructive\"\n                          }\n                          className=\"whitespace-nowrap text-xs\"\n                          data-testid={`badge-status-${doc.id}`}\n                        >\n                          {doc.status}\n                        </Badge>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 md:py-12\" data-testid=\"empty-compliance\">\n                  <FileText className=\"h-10 w-10 md:h-12 md:w-12 text-muted-foreground/30 mx-auto mb-3 md:mb-4\" />\n                  <p className=\"text-sm md:text-base text-muted-foreground\">No compliance documents yet</p>\n                  <Link href=\"/compliance\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3 md:mt-4\">\n                      Add Document\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Maintenance Requests */}\n        {shouldShowPanel(\"maintenance\") && (\n          <Card data-testid=\"panel-maintenance\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <Wrench className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Maintenance Requests\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {maintenance.length > 0 ? (\n                <div className=\"space-y-2 md:space-y-3\">\n                  {maintenance.slice(0, 5).map((request) => (\n                    <Link key={request.id} href=\"/maintenance\">\n                      <div\n                        className=\"flex items-center justify-between gap-3 md:gap-4 p-4 md:p-5 border rounded-xl hover-elevate cursor-pointer transition-all bg-card/50\"\n                        data-testid={`card-maintenance-${request.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-semibold text-base md:text-lg truncate\">{request.title}</p>\n                          <p className=\"text-xs md:text-sm text-muted-foreground truncate mt-1\">\n                            Priority: <span className=\"font-medium\">{request.priority}</span>\n                          </p>\n                        </div>\n                        <Badge\n                          variant={\n                            request.status === \"completed\"\n                              ? \"default\"\n                              : request.status === \"in_progress\"\n                              ? \"secondary\"\n                              : \"outline\"\n                          }\n                          className=\"whitespace-nowrap text-xs\"\n                          data-testid={`badge-status-${request.id}`}\n                        >\n                          {request.status}\n                        </Badge>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 md:py-12\" data-testid=\"empty-maintenance\">\n                  <Wrench className=\"h-10 w-10 md:h-12 md:w-12 text-muted-foreground/30 mx-auto mb-3 md:mb-4\" />\n                  <p className=\"text-sm md:text-base text-muted-foreground\">No maintenance requests</p>\n                  <Link href=\"/maintenance\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3 md:mt-4\">\n                      Create Request\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Asset Inventory */}\n        {shouldShowPanel(\"assets\") && (\n          <Card data-testid=\"panel-assets\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <Package className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Assets Needing Attention\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {assets.length > 0 ? (\n                <div className=\"space-y-2 md:space-y-3\">\n                  {assets.filter(a => a.condition === \"poor\" || a.condition === \"needs_replacement\").slice(0, 5).map((asset) => (\n                    <Link key={asset.id} href=\"/inventory\">\n                      <div\n                        className=\"flex items-center justify-between gap-3 md:gap-4 p-4 md:p-5 border rounded-xl hover-elevate cursor-pointer transition-all bg-card/50\"\n                        data-testid={`card-asset-${asset.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-semibold text-base md:text-lg truncate\">{asset.name}</p>\n                          <p className=\"text-xs md:text-sm text-muted-foreground truncate mt-1\">\n                            {asset.category}\n                          </p>\n                        </div>\n                        <Badge\n                          variant={asset.condition === \"needs_replacement\" ? \"destructive\" : \"secondary\"}\n                          className=\"whitespace-nowrap text-xs\"\n                          data-testid={`badge-condition-${asset.id}`}\n                        >\n                          {asset.condition}\n                        </Badge>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 md:py-12\" data-testid=\"empty-assets\">\n                  <Package className=\"h-10 w-10 md:h-12 md:w-12 text-muted-foreground/30 mx-auto mb-3 md:mb-4\" />\n                  <p className=\"text-sm md:text-base text-muted-foreground\">No assets tracked yet</p>\n                  <Link href=\"/inventory\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3 md:mt-4\">\n                      Add Asset\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Work Orders */}\n        {shouldShowPanel(\"workOrders\") && (\n          <Card data-testid=\"panel-work-orders\">\n            <CardHeader className=\"pb-3 md:pb-6\">\n              <CardTitle className=\"text-xl md:text-2xl font-bold flex items-center gap-2\">\n                <Users className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n                Active Work Orders\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {workOrders.length > 0 ? (\n                <div className=\"space-y-2 md:space-y-3\">\n                  {workOrders.filter(wo => wo.status !== \"completed\").slice(0, 5).map((workOrder) => (\n                    <Link key={workOrder.id} href=\"/maintenance?tab=work-orders\">\n                      <div\n                        className=\"flex items-center justify-between gap-3 md:gap-4 p-4 md:p-5 border rounded-xl hover-elevate cursor-pointer transition-all bg-card/50\"\n                        data-testid={`card-work-order-${workOrder.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-semibold text-base md:text-lg truncate\">{workOrder.title}</p>\n                          <p className=\"text-xs md:text-sm text-muted-foreground truncate mt-1\">\n                            {workOrder.description}\n                          </p>\n                        </div>\n                        <Badge\n                          variant={\n                            workOrder.status === \"completed\"\n                              ? \"default\"\n                              : workOrder.status === \"in_progress\"\n                              ? \"secondary\"\n                              : \"outline\"\n                          }\n                          className=\"whitespace-nowrap text-xs\"\n                          data-testid={`badge-status-${workOrder.id}`}\n                        >\n                          {workOrder.status}\n                        </Badge>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 md:py-12\" data-testid=\"empty-work-orders\">\n                  <Users className=\"h-10 w-10 md:h-12 md:w-12 text-muted-foreground/30 mx-auto mb-3 md:mb-4\" />\n                  <p className=\"text-sm md:text-base text-muted-foreground\">No active work orders</p>\n                  <Link href=\"/maintenance?tab=work-orders\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3 md:mt-4\" data-testid=\"button-create-work-order\">\n                      Create Work Order\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Tag Search Dialog */}\n      <TagSearch open={tagSearchOpen} onOpenChange={setTagSearchOpen} />\n    </div>\n  );\n}\n","size_bytes":35223},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n    // Ensure relative paths in build output (not absolute)\n    rollupOptions: {\n      output: {\n        // Use relative paths for all assets\n        assetFileNames: 'assets/[name].[hash][extname]',\n        chunkFileNames: 'assets/[name].[hash].js',\n        entryFileNames: 'assets/[name].[hash].js',\n      },\n    },\n  },\n  server: {\n    fs: {\n      // Less strict to allow workspace setups and sibling projects\n      strict: false,\n      deny: [\"**/.*\"],\n      // Explicitly allow the sibling Inspect360 directory\n      allow: [\n        path.resolve(import.meta.dirname),\n        path.resolve(import.meta.dirname, \"..\", \"Inspect360\"),\n      ],\n    },\n    hmr: process.env.NODE_ENV === 'development' ? {\n      // Fix WebSocket connection issues in development\n      protocol: 'ws',\n      host: 'localhost',\n      // Use PORT from env or default to 5000/5005\n      port: process.env.PORT ? parseInt(process.env.PORT, 10) : undefined,\n    } : undefined,\n  },\n  optimizeDeps: {\n    // Force re-optimization on dependency changes\n    force: false,\n    // Exclude problematic dependencies from pre-bundling if needed\n    exclude: [],\n    // Include dependencies that need pre-bundling\n    include: [],\n  },\n});\n","size_bytes":2200},"client/src/pages/InspectionDetail.tsx":{"content":"import { useParams, Link } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { ArrowLeft, Calendar, MapPin, User, CheckCircle, Plus, Upload, Sparkles, Camera } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useState } from \"react\";\n\nexport default function InspectionDetail() {\n  const { id } = useParams<{ id: string }>();\n  const { toast } = useToast();\n\n  const [showAddForm, setShowAddForm] = useState(false);\n  const [newItem, setNewItem] = useState({\n    category: \"\",\n    itemName: \"\",\n    photoUrl: \"\",\n    conditionRating: 5,\n    notes: \"\",\n  });\n\n  const { data: inspection, isLoading } = useQuery<any>({\n    queryKey: [\"/api/inspections\", id],\n    enabled: !!id,\n  });\n\n  const completeInspection = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"PATCH\", `/api/inspections/${id}/status`, {\n        status: \"completed\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections/my\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection marked as completed\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update inspection status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const addItemMutation = useMutation({\n    mutationFn: async (itemData: any) => {\n      const response = await apiRequest(\"POST\", \"/api/inspection-items\", {\n        inspectionId: id,\n        ...itemData,\n      });\n      return await response.json();\n    },\n    onSuccess: async (newItem) => {\n      console.log('[InspectionDetail] Item created:', newItem);\n      \n      // Optimistically update the cache\n      queryClient.setQueryData([\"/api/inspections\", id], (oldData: any) => {\n        if (!oldData) return oldData;\n        return {\n          ...oldData,\n          items: [...(oldData.items || []), newItem],\n        };\n      });\n      \n      // Invalidate and refetch to ensure we have the latest data\n      await queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      await queryClient.refetchQueries({ queryKey: [\"/api/inspections\", id] });\n      \n      setShowAddForm(false);\n      setNewItem({ category: \"\", itemName: \"\", photoUrl: \"\", conditionRating: 5, notes: \"\" });\n      toast({\n        title: \"Success\",\n        description: \"Inspection item added successfully\",\n      });\n    },\n    onError: (error: any) => {\n      console.error('[InspectionDetail] Error adding item:', error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add inspection item\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const analyzePhotoMutation = useMutation({\n    mutationFn: async (itemId: string) => {\n      return await apiRequest(\"POST\", \"/api/ai/analyze-photo\", { itemId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      toast({\n        title: \"Success\",\n        description: \"AI analysis completed (1 credit used)\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to analyze photo\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleAddItem = () => {\n    if (!newItem.category || !newItem.itemName) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Category and item name are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    addItemMutation.mutate(newItem);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"flex justify-center items-center h-64\">\n          <p className=\"text-muted-foreground\">Loading inspection...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!inspection) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <p className=\"text-lg font-medium\">Inspection not found</p>\n            <Link href=\"/inspections\">\n              <Button variant=\"outline\" className=\"mt-4\">\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Inspections\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, { variant: any; label: string }> = {\n      scheduled: { variant: \"secondary\", label: \"Scheduled\" },\n      in_progress: { variant: \"default\", label: \"In Progress\" },\n      completed: { variant: \"outline\", label: \"Completed\" },\n    };\n    const config = variants[status] || variants.scheduled;\n    return <Badge variant={config.variant}>{config.label}</Badge>;\n  };\n\n  const getTypeBadge = (type: string) => {\n    const labels: Record<string, string> = {\n      check_in: \"Check In\",\n      check_out: \"Check Out\",\n      routine: \"Routine\",\n      maintenance: \"Maintenance\",\n    };\n    return <Badge variant=\"outline\">{labels[type] || type}</Badge>;\n  };\n\n  const items = inspection?.items || [];\n  \n  // Debug logging\n  if (inspection) {\n    console.log('[InspectionDetail] Inspection data:', {\n      id: inspection.id,\n      itemsCount: items.length,\n      items: items,\n    });\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Link href=\"/inspections\">\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n            <ArrowLeft className=\"w-4 h-4\" />\n          </Button>\n        </Link>\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Inspection Details\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {inspection.property?.name || inspection.block?.name}\n          </p>\n        </div>\n        {inspection.status !== \"completed\" && (\n          <Button\n            onClick={() => completeInspection.mutate()}\n            disabled={completeInspection.isPending}\n            data-testid=\"button-complete\"\n          >\n            <CheckCircle className=\"w-4 h-4 mr-2\" />\n            {completeInspection.isPending ? \"Completing...\" : \"Mark Complete\"}\n          </Button>\n        )}\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Inspection Information</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Status:</span>\n              {getStatusBadge(inspection.status)}\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Type:</span>\n              {getTypeBadge(inspection.type)}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-sm\">\n                {inspection.scheduledDate\n                  ? format(new Date(inspection.scheduledDate), \"MMMM dd, yyyy\")\n                  : \"Not scheduled\"}\n              </span>\n            </div>\n            {inspection.completedDate && (\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle className=\"w-4 h-4 text-muted-foreground\" />\n                <span className=\"text-sm\">\n                  Completed: {format(new Date(inspection.completedDate), \"MMMM dd, yyyy\")}\n                </span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Property</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-1\">\n              <div className=\"flex items-center gap-2\">\n                <MapPin className=\"w-4 h-4 text-muted-foreground\" />\n                <span className=\"font-medium\">{inspection.property?.name || inspection.block?.name}</span>\n              </div>\n              <p className=\"text-sm text-muted-foreground ml-6\">\n                {inspection.property?.address || inspection.block?.address}\n              </p>\n            </div>\n            {inspection.clerk && (\n              <div className=\"space-y-1\">\n                <div className=\"flex items-center gap-2\">\n                  <User className=\"w-4 h-4 text-muted-foreground\" />\n                  <span className=\"text-sm text-muted-foreground\">Assigned Clerk:</span>\n                </div>\n                <p className=\"text-sm ml-6\">{inspection.clerk.email}</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {inspection.notes && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Notes</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm\">{inspection.notes}</p>\n          </CardContent>\n        </Card>\n      )}\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n          <div>\n            <CardTitle>Inspection Items</CardTitle>\n            <CardDescription>\n              Photos and condition assessments for this inspection\n            </CardDescription>\n          </div>\n          {inspection.status !== \"completed\" && (\n            <Button\n              onClick={() => setShowAddForm(!showAddForm)}\n              size=\"sm\"\n              data-testid=\"button-add-item\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Item\n            </Button>\n          )}\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {showAddForm && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Add New Inspection Item</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"category\">Category / Room</Label>\n                  <Select\n                    value={newItem.category}\n                    onValueChange={(value) => setNewItem({ ...newItem, category: value })}\n                  >\n                    <SelectTrigger id=\"category\" data-testid=\"select-category\">\n                      <SelectValue placeholder=\"Select category\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Kitchen\">Kitchen</SelectItem>\n                      <SelectItem value=\"Bathroom\">Bathroom</SelectItem>\n                      <SelectItem value=\"Living Room\">Living Room</SelectItem>\n                      <SelectItem value=\"Bedroom\">Bedroom</SelectItem>\n                      <SelectItem value=\"Hallway\">Hallway</SelectItem>\n                      <SelectItem value=\"Exterior\">Exterior</SelectItem>\n                      <SelectItem value=\"Other\">Other</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"itemName\">Item / Feature</Label>\n                  <Input\n                    id=\"itemName\"\n                    placeholder=\"e.g., Walls, Floors, Countertops, Appliances\"\n                    value={newItem.itemName}\n                    onChange={(e) => setNewItem({ ...newItem, itemName: e.target.value })}\n                    data-testid=\"input-item-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Photo (Optional)</Label>\n                  <ObjectUploader\n                    onGetUploadParameters={async () => {\n                      const response = await fetch('/api/objects/upload', {\n                        method: 'POST',\n                        credentials: 'include',\n                      });\n                      const { uploadURL } = await response.json();\n                      return {\n                        method: 'PUT',\n                        url: uploadURL,\n                      };\n                    }}\n                    onComplete={async (result) => {\n                      if (result.successful && result.successful[0]) {\n                        let uploadURL = result.successful[0].uploadURL;\n                        \n                        // Normalize URL: if absolute, extract pathname; if relative, use as is\n                        if (uploadURL && (uploadURL.startsWith('http://') || uploadURL.startsWith('https://'))) {\n                          try {\n                            const urlObj = new URL(uploadURL);\n                            uploadURL = urlObj.pathname;\n                          } catch (e) {\n                            console.error('[InspectionDetail] Invalid upload URL:', uploadURL);\n                          }\n                        }\n                        \n                        // Ensure it's a relative path starting with /objects/\n                        if (!uploadURL || !uploadURL.startsWith('/objects/')) {\n                          toast({\n                            title: \"Upload Error\",\n                            description: \"Invalid file URL format. Please try again.\",\n                            variant: \"destructive\",\n                          });\n                          return;\n                        }\n                        \n                        // Convert to absolute URL for ACL call\n                        const absoluteUrl = `${window.location.origin}${uploadURL}`;\n                        const response = await fetch('/api/objects/set-acl', {\n                          method: 'PUT',\n                          headers: { 'Content-Type': 'application/json' },\n                          credentials: 'include',\n                          body: JSON.stringify({ photoUrl: absoluteUrl }),\n                        });\n                        const { objectPath } = await response.json();\n                        setNewItem({ ...newItem, photoUrl: objectPath });\n                        toast({\n                          title: \"Photo uploaded\",\n                          description: \"Photo uploaded successfully\",\n                        });\n                      }\n                    }}\n                  >\n                    <Upload className=\"w-4 h-4 mr-2\" />\n                    {newItem.photoUrl ? \"Change Photo\" : \"Upload Photo\"}\n                  </ObjectUploader>\n                  {newItem.photoUrl && (\n                    <div className=\"space-y-2\">\n                      <div className=\"relative aspect-video rounded-md overflow-hidden bg-muted border\">\n                        <img\n                          src={newItem.photoUrl.startsWith('/objects/') ? newItem.photoUrl : `/objects/${newItem.photoUrl}`}\n                          alt=\"Preview\"\n                          className=\"object-cover w-full h-full\"\n                        />\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">Photo uploaded</p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Condition Rating: {newItem.conditionRating}/10</Label>\n                  <Slider\n                    value={[newItem.conditionRating]}\n                    onValueChange={(value) => setNewItem({ ...newItem, conditionRating: value[0] })}\n                    min={0}\n                    max={10}\n                    step={1}\n                    className=\"w-full\"\n                    data-testid=\"slider-condition\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    0 = Poor condition, 10 = Excellent condition\n                  </p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"notes\">Notes (Optional)</Label>\n                  <Textarea\n                    id=\"notes\"\n                    placeholder=\"Add any additional observations or details...\"\n                    value={newItem.notes}\n                    onChange={(e) => setNewItem({ ...newItem, notes: e.target.value })}\n                    rows={3}\n                    data-testid=\"textarea-notes\"\n                  />\n                </div>\n\n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={handleAddItem}\n                    disabled={addItemMutation.isPending}\n                    data-testid=\"button-save-item\"\n                  >\n                    {addItemMutation.isPending ? \"Saving...\" : \"Save Item\"}\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setShowAddForm(false);\n                      setNewItem({ category: \"\", itemName: \"\", photoUrl: \"\", conditionRating: 5, notes: \"\" });\n                    }}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {!showAddForm && items.length === 0 && (\n            <div className=\"text-center py-8\">\n              <Camera className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n              <p className=\"text-muted-foreground mb-2\">No inspection items yet</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Add inspection items to document the condition of this property\n              </p>\n            </div>\n          )}\n\n          {items.length > 0 && (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {items.map((item: any) => {\n                console.log('[InspectionDetail] Rendering item:', item);\n                return (\n                <Card key={item.id} data-testid={`card-item-${item.id}`}>\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div>\n                        <CardTitle className=\"text-base\">{item.itemName}</CardTitle>\n                        <CardDescription>{item.category}</CardDescription>\n                      </div>\n                      <Badge variant=\"secondary\" data-testid={`badge-rating-${item.id}`}>\n                        {item.conditionRating != null ? `${item.conditionRating}/10` : 'N/A'}\n                      </Badge>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    {item.photoUrl && (\n                      <div className=\"relative aspect-video rounded-md overflow-hidden bg-muted\">\n                        <img\n                          src={item.photoUrl.startsWith('/objects/') ? item.photoUrl : `/objects/${item.photoUrl}`}\n                          alt={item.itemName}\n                          className=\"object-cover w-full h-full\"\n                          data-testid={`img-item-${item.id}`}\n                        />\n                      </div>\n                    )}\n                    \n                    {item.notes && (\n                      <div className=\"p-3 bg-muted/50 rounded-md\">\n                        <p className=\"text-sm\" data-testid={`text-notes-${item.id}`}>\n                          {item.notes}\n                        </p>\n                      </div>\n                    )}\n                    \n                    {item.aiAnalysis && (\n                      <div className=\"p-3 bg-muted rounded-md\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                          <Sparkles className=\"w-4 h-4 text-primary\" />\n                          <span className=\"text-sm font-medium\">AI Analysis</span>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\" data-testid={`text-ai-${item.id}`}>\n                          {item.aiAnalysis}\n                        </p>\n                      </div>\n                    )}\n                    \n                    {!item.aiAnalysis && item.photoUrl && inspection.status !== \"completed\" && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => analyzePhotoMutation.mutate(item.id)}\n                        disabled={analyzePhotoMutation.isPending}\n                        data-testid={`button-analyze-${item.id}`}\n                        className=\"w-full\"\n                      >\n                        <Sparkles className=\"w-4 h-4 mr-2\" />\n                        {analyzePhotoMutation.isPending ? \"Analyzing...\" : \"Analyze with AI (1 credit)\"}\n                      </Button>\n                    )}\n                  </CardContent>\n                </Card>\n                );\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":21817},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"server/replitAuth.ts":{"content":"// Based on javascript_log_in_with_replit blueprint\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n\n// Role-based middleware\nexport const requireRole = (...allowedRoles: string[]): RequestHandler => {\n  return async (req, res, next) => {\n    const user = req.user as any;\n    if (!user?.claims?.sub) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n\n    const dbUser = await storage.getUser(user.claims.sub);\n    if (!dbUser) {\n      return res.status(401).json({ message: \"User not found\" });\n    }\n\n    if (!allowedRoles.includes(dbUser.role)) {\n      return res.status(403).json({ message: \"Forbidden: Insufficient permissions\" });\n    }\n\n    // Attach user to request for convenience\n    (req as any).dbUser = dbUser;\n    next();\n  };\n};\n","size_bytes":4939},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n\n/**\n * Normalizes a URL to a relative path starting with /objects/\n * Handles both absolute URLs (http://...) and relative paths (/objects/...)\n */\nfunction normalizeObjectUrl(url: string): string | null {\n  if (!url) return null;\n  \n  // If it's already a relative path starting with /objects/, return as is\n  if (url.startsWith('/objects/')) {\n    return url;\n  }\n  \n  // If it's an absolute URL, extract the pathname\n  if (url.startsWith('http://') || url.startsWith('https://')) {\n    try {\n      const urlObj = new URL(url);\n      const pathname = urlObj.pathname;\n      if (pathname.startsWith('/objects/')) {\n        return pathname;\n      }\n    } catch (e) {\n      // Invalid URL\n      return null;\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Extracts the file URL from an Uppy upload response.\n * The upload-direct endpoint returns: { url: \"/objects/...\", uploadURL: \"/objects/...\" }\n * This function checks multiple possible locations in the response structure.\n * Returns a normalized relative path starting with /objects/\n */\nexport function extractFileUrlFromUploadResponse(file: any, response?: any): string | null {\n  // Method 1: Check file.response.body (most reliable - Uppy stores PUT response here)\n  // Uppy may store it as a string or already parsed object\n  if (file?.response?.body) {\n    try {\n      let body = file.response.body;\n      // Try parsing if it's a string\n      if (typeof body === 'string') {\n        try {\n          body = JSON.parse(body);\n        } catch (e) {\n          // Not JSON, might be plain text URL\n          const normalized = normalizeObjectUrl(body);\n          if (normalized) return normalized;\n        }\n      }\n      \n      // Check for url or uploadURL in parsed body\n      if (typeof body === 'object' && body !== null) {\n        const url = body.url || body.uploadURL || body.path || body.pathname;\n        if (url) {\n          const normalized = normalizeObjectUrl(url);\n          if (normalized) return normalized;\n        }\n      }\n    } catch (e) {\n      // Error parsing, continue to next method\n    }\n  }\n  \n  // Method 2: Check file.response directly (sometimes Uppy stores it here)\n  if (file?.response) {\n    // Check various possible properties\n    const url = file.response.url || file.response.uploadURL || file.response.path || file.response.pathname;\n    if (url) {\n      const normalized = normalizeObjectUrl(url);\n      if (normalized) return normalized;\n    }\n    \n    // Also check if response itself is a string URL\n    if (typeof file.response === 'string') {\n      const normalized = normalizeObjectUrl(file.response);\n      if (normalized) return normalized;\n    }\n  }\n  \n  // Method 3: Check response.body\n  if (response?.body) {\n    try {\n      let body = response.body;\n      if (typeof body === 'string') {\n        try {\n          body = JSON.parse(body);\n        } catch (e) {\n          // Not JSON, might be plain text URL\n          const normalized = normalizeObjectUrl(body);\n          if (normalized) return normalized;\n        }\n      }\n      \n      if (typeof body === 'object' && body !== null) {\n        const url = body.url || body.uploadURL || body.path || body.pathname;\n        if (url) {\n          const normalized = normalizeObjectUrl(url);\n          if (normalized) return normalized;\n        }\n      }\n    } catch (e) {\n      // Not JSON or invalid\n    }\n  }\n  \n  // Method 4: Check top-level response properties\n  if (response) {\n    const url = response.url || response.uploadURL || response.path || response.pathname;\n    if (url) {\n      const normalized = normalizeObjectUrl(url);\n      if (normalized) return normalized;\n    }\n  }\n  \n  // Method 5: Check file.uploadURL (sometimes Uppy stores it here directly)\n  if (file?.uploadURL) {\n    const normalized = normalizeObjectUrl(file.uploadURL);\n    if (normalized) return normalized;\n  }\n  \n  // Method 6: Construct from objectId if available in metadata\n  if (file?.meta?.objectId) {\n    return `/objects/${file.meta.objectId}`;\n  }\n  \n  // Method 7: Extract objectId from upload URL (most reliable fallback)\n  if (file?.meta?.originalUploadURL) {\n    try {\n      const uploadUrl = file.meta.originalUploadURL;\n      const urlObj = new URL(uploadUrl);\n      const objectId = urlObj.searchParams.get('objectId');\n      if (objectId) {\n        return `/objects/${objectId}`;\n      }\n      // Also try extracting from pathname\n      const pathname = urlObj.pathname;\n      if (pathname.startsWith('/objects/')) {\n        return pathname;\n      }\n    } catch (e) {\n      // Invalid URL, continue\n    }\n  }\n  \n  // Method 8: Try to extract from the upload URL stored in file.source\n  if (file?.source) {\n    try {\n      const urlObj = new URL(file.source);\n      const objectId = urlObj.searchParams.get('objectId');\n      if (objectId) {\n        return `/objects/${objectId}`;\n      }\n    } catch (e) {\n      // Invalid URL\n    }\n  }\n  \n  return null;\n}\n","size_bytes":5071},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/hooks/useAuth.ts":{"content":"import { useQuery, useMutation, UseMutationResult } from \"@tanstack/react-query\";\nimport type { User, RegisterUser, LoginUser } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"../lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype AuthContextType = {\n  user: User | null;\n  isLoading: boolean;\n  error: Error | null;\n  loginMutation: UseMutationResult<User, Error, LoginUser>;\n  logoutMutation: UseMutationResult<void, Error, void>;\n  registerMutation: UseMutationResult<User, Error, RegisterUser>;\n};\n\nexport function useAuth() {\n  const { toast } = useToast();\n\n  const {\n    data: user,\n    error,\n    isLoading,\n  } = useQuery<User | undefined, Error>({\n    queryKey: [\"/api/auth/user\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/auth/user\", {\n        credentials: \"include\",\n      });\n      \n      // Return null if not authenticated (don't throw)\n      if (res.status === 401) {\n        return null;\n      }\n      \n      if (!res.ok) {\n        throw new Error(`Auth check failed: ${res.statusText}`);\n      }\n      \n      return await res.json();\n    },\n    retry: false,\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: LoginUser) => {\n      const res = await apiRequest(\"POST\", \"/api/login\", credentials);\n      return await res.json();\n    },\n    onSuccess: (user: User) => {\n      console.log('[LOGIN] User received from API:', user);\n      console.log('[LOGIN] User organizationId:', user.organizationId);\n      queryClient.setQueryData([\"/api/auth/user\"], user);\n      toast({\n        title: \"Welcome back!\",\n        description: `Logged in as ${user.firstName || user.username}`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Login failed\",\n        description: error.message || \"Invalid email or password\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (credentials: RegisterUser) => {\n      const res = await apiRequest(\"POST\", \"/api/register\", credentials);\n      return await res.json();\n    },\n    onSuccess: (user: User) => {\n      queryClient.setQueryData([\"/api/auth/user\"], user);\n      toast({\n        title: \"Account created!\",\n        description: \"Welcome to Inspect360\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Registration failed\",\n        description: error.message || \"Failed to create account\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", \"/api/logout\");\n    },\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/auth/user\"], null);\n      toast({\n        title: \"Logged out\",\n        description: \"You have been logged out successfully\",\n      });\n      // Force page reload to show landing page\n      window.location.href = \"/\";\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Logout failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return {\n    user: user ?? null,\n    isLoading,\n    error,\n    isAuthenticated: !!user,\n    loginMutation,\n    logoutMutation,\n    registerMutation,\n  };\n}\n","size_bytes":3296},"client/src/pages/Inspections.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, ClipboardList, Calendar, MapPin, User, Play, FileText, Filter } from \"lucide-react\";\nimport { Link, useLocation, useSearch } from \"wouter\";\nimport { format } from \"date-fns\";\n\nconst createInspectionSchema = z.object({\n  propertyId: z.string().min(1, \"Property is required\"),\n  type: z.enum([\"check_in\", \"check_out\", \"routine\", \"maintenance\"]),\n  scheduledDate: z.string().min(1, \"Scheduled date is required\"),\n  templateId: z.string().optional(),\n  clerkId: z.string().optional(),\n  notes: z.string().optional(),\n});\n\ntype CreateInspectionData = z.infer<typeof createInspectionSchema>;\n\nexport default function Inspections() {\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const searchParams = useSearch();\n  const urlPropertyId = new URLSearchParams(searchParams).get(\"propertyId\");\n  const shouldCreate = new URLSearchParams(searchParams).get(\"create\");\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [selectedPropertyId, setSelectedPropertyId] = useState<string>(\"\");\n  \n  // Filter state\n  const [filterBlockId, setFilterBlockId] = useState<string>(\"\");\n  const [filterPropertyId, setFilterPropertyId] = useState<string>(\"\");\n\n  const { data: inspections = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/inspections/my\"],\n  });\n\n  const { data: properties = [] } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n\n  const { data: clerks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/users/clerks\"],\n  });\n\n  // Fetch active templates filtered by property scope\n  const { data: templates = [] } = useQuery<any[]>({\n    queryKey: [\"/api/inspection-templates?scope=property&active=true\"],\n  });\n\n  const form = useForm<CreateInspectionData>({\n    resolver: zodResolver(createInspectionSchema),\n    defaultValues: {\n      propertyId: \"\",\n      type: \"routine\",\n      scheduledDate: new Date().toISOString().split(\"T\")[0],\n      templateId: \"__none__\",\n      clerkId: \"\",\n      notes: \"\",\n    },\n  });\n\n  // Pre-populate form and auto-open dialog if coming from property detail\n  useEffect(() => {\n    if (urlPropertyId && properties.length > 0) {\n      // Pre-populate property selection\n      form.setValue(\"propertyId\", urlPropertyId);\n      setSelectedPropertyId(urlPropertyId);\n      \n      // Auto-open dialog if create=true\n      if (shouldCreate === \"true\") {\n        setDialogOpen(true);\n        // Clear URL parameters after opening to keep URL clean\n        navigate(\"/inspections\", { replace: true });\n      }\n    }\n  }, [urlPropertyId, shouldCreate, properties, navigate]);\n\n  // Filter properties based on selected block\n  const filteredProperties = useMemo(() => {\n    if (!filterBlockId) return properties;\n    return properties.filter((p: any) => p.blockId === filterBlockId);\n  }, [properties, filterBlockId]);\n\n  // Filter inspections based on selected block and property\n  const filteredInspections = useMemo(() => {\n    let filtered = inspections;\n\n    if (filterBlockId) {\n      filtered = filtered.filter((inspection: any) => {\n        // Include inspections directly linked to the block\n        if (inspection.blockId === filterBlockId) return true;\n        // Include inspections linked to properties in this block\n        if (inspection.property?.blockId === filterBlockId) return true;\n        return false;\n      });\n    }\n\n    if (filterPropertyId) {\n      filtered = filtered.filter((inspection: any) => \n        inspection.propertyId === filterPropertyId\n      );\n    }\n\n    return filtered;\n  }, [inspections, filterBlockId, filterPropertyId]);\n\n  // Clear property filter when block filter changes\n  useEffect(() => {\n    if (filterBlockId && filterPropertyId) {\n      const property = properties.find((p: any) => p.id === filterPropertyId);\n      if (property && property.blockId !== filterBlockId) {\n        setFilterPropertyId(\"\");\n      }\n    }\n  }, [filterBlockId, filterPropertyId, properties]);\n\n  // Auto-select matching template when inspection type changes\n  const watchedType = form.watch(\"type\");\n  useEffect(() => {\n    if (templates.length === 0) return;\n    \n    // Map inspection types to template names\n    const typeToTemplateName: Record<string, string> = {\n      check_in: \"Check In\",\n      check_out: \"Check Out\",\n    };\n    \n    const expectedTemplateName = typeToTemplateName[watchedType];\n    \n    if (expectedTemplateName) {\n      // Auto-select matching template for check-in/check-out\n      const matchingTemplate = templates.find(\n        (t: any) => t.name === expectedTemplateName && t.isActive\n      );\n      if (matchingTemplate) {\n        form.setValue(\"templateId\", matchingTemplate.id);\n      } else {\n        // No matching template found - clear selection\n        form.setValue(\"templateId\", \"__none__\");\n      }\n    } else {\n      // Clear template selection for other types (routine, maintenance)\n      form.setValue(\"templateId\", \"__none__\");\n    }\n  }, [watchedType, templates]);\n\n  const createInspection = useMutation({\n    mutationFn: async (data: CreateInspectionData) => {\n      return await apiRequest(\"POST\", \"/api/inspections\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections/my\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection created successfully\",\n      });\n      setDialogOpen(false);\n      form.reset();\n      setSelectedPropertyId(\"\");\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create inspection\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: CreateInspectionData) => {\n    // Create payload and remove sentinel values\n    const payload: any = { ...data };\n    \n    // Remove templateId if it's the sentinel or empty\n    if (payload.templateId === \"__none__\" || !payload.templateId) {\n      delete payload.templateId;\n    }\n    \n    // Remove clerkId if it's the sentinel or empty\n    if (payload.clerkId === \"__none__\" || !payload.clerkId) {\n      delete payload.clerkId;\n    }\n    \n    createInspection.mutate(payload);\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, { variant: any; label: string }> = {\n      draft: { variant: \"secondary\", label: \"Draft\" },\n      in_progress: { variant: \"default\", label: \"In Progress\" },\n      completed: { variant: \"outline\", label: \"Completed\" },\n    };\n    const config = variants[status] || variants.draft;\n    return <Badge variant={config.variant}>{config.label}</Badge>;\n  };\n\n  const getTypeBadge = (type: string) => {\n    const labels: Record<string, string> = {\n      check_in: \"Check In\",\n      check_out: \"Check Out\",\n      routine: \"Routine\",\n      maintenance: \"Maintenance\",\n    };\n    return <Badge variant=\"outline\">{labels[type] || type}</Badge>;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"flex justify-center items-center h-64\">\n          <p className=\"text-muted-foreground\">Loading inspections...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Inspections</h1>\n          <p className=\"text-muted-foreground\">\n            Manage and conduct property inspections\n          </p>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-inspection\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              New Inspection\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Create New Inspection</DialogTitle>\n              <DialogDescription>\n                Schedule a new inspection for a property unit\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"propertyId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Property</FormLabel>\n                      <Select\n                        onValueChange={(value) => {\n                          field.onChange(value);\n                          setSelectedPropertyId(value);\n                        }}\n                        value={field.value}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-property\">\n                            <SelectValue placeholder=\"Select property\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {properties.map((property: any) => (\n                            <SelectItem key={property.id} value={property.id}>\n                              {property.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"type\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Inspection Type</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-type\">\n                            <SelectValue placeholder=\"Select type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"check_in\">Check In</SelectItem>\n                          <SelectItem value=\"check_out\">Check Out</SelectItem>\n                          <SelectItem value=\"routine\">Routine</SelectItem>\n                          <SelectItem value=\"maintenance\">Maintenance</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"templateId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Template (Optional)</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || \"__none__\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-template\">\n                            <SelectValue placeholder=\"No template\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"__none__\">No Template</SelectItem>\n                          {templates.map((template: any) => (\n                            <SelectItem key={template.id} value={template.id}>\n                              {template.name}\n                              {template.version > 1 && ` (v${template.version})`}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"scheduledDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Scheduled Date</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"date\"\n                          {...field}\n                          data-testid=\"input-scheduled-date\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"clerkId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Assign to Clerk (Optional)</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-clerk\">\n                            <SelectValue placeholder=\"Select clerk\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {clerks.map((clerk: any) => (\n                            <SelectItem key={clerk.id} value={clerk.id}>\n                              {clerk.firstName} {clerk.lastName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Any additional notes...\"\n                          {...field}\n                          data-testid=\"input-notes\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex gap-2 justify-end\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setDialogOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={createInspection.isPending}\n                    data-testid=\"button-submit\"\n                  >\n                    {createInspection.isPending ? \"Creating...\" : \"Create Inspection\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-wrap gap-4 items-end\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Filter className=\"w-4 h-4\" />\n              <span className=\"text-sm font-medium\">Filter by:</span>\n            </div>\n            <div className=\"flex-1 min-w-[200px] max-w-xs\">\n              <label className=\"text-sm font-medium mb-1.5 block\">Block</label>\n              <Select value={filterBlockId || \"__all__\"} onValueChange={(value) => setFilterBlockId(value === \"__all__\" ? \"\" : value)}>\n                <SelectTrigger data-testid=\"filter-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"__all__\">All blocks</SelectItem>\n                  {blocks.map((block: any) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex-1 min-w-[200px] max-w-xs\">\n              <label className=\"text-sm font-medium mb-1.5 block\">Property</label>\n              <Select \n                value={filterPropertyId || \"__all__\"} \n                onValueChange={(value) => setFilterPropertyId(value === \"__all__\" ? \"\" : value)}\n                disabled={!filterBlockId && filteredProperties.length === 0}\n              >\n                <SelectTrigger data-testid=\"filter-property\">\n                  <SelectValue placeholder=\"All properties\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"__all__\">All properties</SelectItem>\n                  {filteredProperties.map((property: any) => (\n                    <SelectItem key={property.id} value={property.id}>\n                      {property.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            {(filterBlockId || filterPropertyId) && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  setFilterBlockId(\"\");\n                  setFilterPropertyId(\"\");\n                }}\n                data-testid=\"button-clear-filters\"\n              >\n                Clear Filters\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {filteredInspections.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <ClipboardList className=\"w-12 h-12 text-muted-foreground mb-4\" />\n            <p className=\"text-lg font-medium\" data-testid=\"text-empty-state\">\n              {inspections.length === 0 ? \"No inspections yet\" : \"No inspections match your filters\"}\n            </p>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              {inspections.length === 0 \n                ? \"Create your first inspection to get started\"\n                : \"Try adjusting your filters or create a new inspection\"\n              }\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredInspections.map((inspection: any) => (\n            <Card key={inspection.id} className=\"hover-elevate\" data-testid={`card-inspection-${inspection.id}`}>\n              <CardHeader>\n                <div className=\"flex justify-between items-start gap-2\">\n                  <CardTitle className=\"text-lg\">\n                    {inspection.property?.name || \"Unknown Property\"}\n                  </CardTitle>\n                  {getStatusBadge(inspection.status)}\n                </div>\n                <CardDescription className=\"flex items-center gap-1\">\n                  <MapPin className=\"w-3 h-3\" />\n                  {inspection.property?.address || inspection.block?.address || \"No location\"}\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">Type:</span>\n                    {getTypeBadge(inspection.type)}\n                  </div>\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n                    <span>\n                      {inspection.scheduledDate\n                        ? format(new Date(inspection.scheduledDate), \"MMM dd, yyyy\")\n                        : \"Not scheduled\"}\n                    </span>\n                  </div>\n                  {inspection.clerk && (\n                    <div className=\"flex items-center gap-2 text-sm\">\n                      <User className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-muted-foreground\">\n                        {inspection.clerk.email}\n                      </span>\n                    </div>\n                  )}\n                </div>\n                \n                <div className=\"flex gap-2 flex-wrap\">\n                  {inspection.templateSnapshotJson && inspection.status !== \"completed\" && (\n                    <Button\n                      size=\"sm\"\n                      className=\"flex-1\"\n                      onClick={() => navigate(`/inspections/${inspection.id}/capture`)}\n                      data-testid={`button-start-capture-${inspection.id}`}\n                    >\n                      <Play className=\"w-4 h-4 mr-2\" />\n                      {inspection.status === \"in_progress\" ? \"Continue\" : \"Start\"}\n                    </Button>\n                  )}\n                  {inspection.templateSnapshotJson && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"flex-1\"\n                      onClick={() => navigate(`/inspections/${inspection.id}/report`)}\n                      data-testid={`button-view-report-${inspection.id}`}\n                    >\n                      <FileText className=\"w-4 h-4 mr-2\" />\n                      View Report\n                    </Button>\n                  )}\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"flex-1\"\n                    onClick={() => navigate(`/inspections/${inspection.id}`)}\n                    data-testid={`button-view-details-${inspection.id}`}\n                  >\n                    View Details\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":22876},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"client/src/pages/Compliance.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useSearch } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Calendar as CalendarComponent } from \"@/components/ui/calendar\";\nimport { Command, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem } from \"@/components/ui/command\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { FileText, Upload, AlertTriangle, ExternalLink, Calendar, ShieldAlert, Tag as TagIcon, X, Plus, Building2, Home, Check, CalendarIcon } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { format as formatDate, differenceInDays, isPast } from \"date-fns\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { insertComplianceDocumentSchema, type ComplianceDocument, type Tag, type Block, type Property } from \"@shared/schema\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { cn } from \"@/lib/utils\";\n\nconst DOCUMENT_TYPES = [\n  \"Fire Safety Certificate\",\n  \"Building Insurance\",\n  \"Electrical Safety Certificate\",\n  \"Gas Safety Certificate\",\n  \"EPC Certificate\",\n  \"HMO License\",\n  \"Planning Permission\",\n  \"Other\",\n];\n\nconst uploadFormSchema = insertComplianceDocumentSchema.omit({\n  organizationId: true,\n  uploadedBy: true,\n}).extend({\n  documentUrl: z.string().min(1, \"Please upload a document\"),\n  expiryDate: z.string().optional(),\n});\n\ntype UploadFormValues = z.infer<typeof uploadFormSchema>;\n\nexport default function Compliance() {\n  const { toast } = useToast();\n  const [open, setOpen] = useState(false);\n  const [selectedDoc, setSelectedDoc] = useState<string | null>(null);\n  const [tagDialogOpen, setTagDialogOpen] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n  const { user, isLoading: authLoading } = useAuth();\n  \n  // Get URL parameters for property or block context\n  const searchParams = useSearch();\n  const urlParams = new URLSearchParams(searchParams);\n  const propertyIdFromUrl = urlParams.get(\"propertyId\");\n  const blockIdFromUrl = urlParams.get(\"blockId\");\n\n  const { data: documents = [], isLoading } = useQuery<ComplianceDocument[]>({\n    queryKey: ['/api/compliance'],\n  });\n\n  const { data: expiringDocs = [] } = useQuery<ComplianceDocument[]>({\n    queryKey: ['/api/compliance/expiring'],\n    queryFn: () => fetch('/api/compliance/expiring?days=90').then(res => res.json()),\n  });\n\n  const { data: properties = [] } = useQuery<Property[]>({\n    queryKey: ['/api/properties'],\n    enabled: !!user?.organizationId,\n  });\n\n  const { data: blocks = [] } = useQuery<Block[]>({\n    queryKey: ['/api/blocks'],\n    enabled: !!user?.organizationId,\n  });\n\n  const { data: allTags = [] } = useQuery<Tag[]>({\n    queryKey: ['/api/tags'],\n    enabled: !!user?.organizationId,\n  });\n\n  const { data: docTags = [] } = useQuery<Tag[]>({\n    queryKey: ['/api/compliance', selectedDoc, 'tags'],\n    enabled: !!selectedDoc,\n  });\n\n  const form = useForm<UploadFormValues>({\n    resolver: zodResolver(uploadFormSchema),\n    defaultValues: {\n      documentType: \"\",\n      documentUrl: \"\",\n      expiryDate: undefined,\n      propertyId: undefined,\n      blockId: undefined,\n      status: \"current\",\n    },\n  });\n  \n  // Pre-populate property or block when dialog opens based on URL context\n  useEffect(() => {\n    if (open) {\n      const resetValues: Partial<UploadFormValues> = {\n        documentType: \"\",\n        documentUrl: \"\",\n        expiryDate: undefined,\n        status: \"current\",\n      };\n      \n      if (propertyIdFromUrl) {\n        resetValues.propertyId = propertyIdFromUrl;\n        resetValues.blockId = undefined;\n      } else if (blockIdFromUrl) {\n        resetValues.blockId = blockIdFromUrl;\n        resetValues.propertyId = undefined;\n      } else {\n        resetValues.propertyId = undefined;\n        resetValues.blockId = undefined;\n      }\n      \n      form.reset(resetValues as UploadFormValues);\n      setIsUploading(false); // Reset upload state when dialog opens\n    } else {\n      // Clean up when dialog closes to prevent stuck upload states\n      setIsUploading(false);\n      form.clearErrors();\n    }\n  }, [open, propertyIdFromUrl, blockIdFromUrl, form]);\n\n  const uploadMutation = useMutation({\n    mutationFn: async (data: UploadFormValues) => {\n      console.log('[Compliance] Sending upload request with data:', data);\n      try {\n        const payload = {\n          ...data,\n          expiryDate: data.expiryDate ? new Date(data.expiryDate) : null,\n        };\n        console.log('[Compliance] Upload payload:', payload);\n        const result = await apiRequest('POST', '/api/compliance', payload);\n        console.log('[Compliance] Upload successful:', result);\n        return result;\n      } catch (error: any) {\n        console.error('[Compliance] Upload error details:', error);\n        throw error;\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compliance'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/compliance/expiring'] });\n      toast({\n        title: \"Document uploaded\",\n        description: \"Compliance document uploaded successfully\",\n      });\n      setOpen(false);\n      form.reset();\n      setIsUploading(false);\n    },\n    onError: (error: any) => {\n      console.error('[Compliance] Error uploading compliance document:', error);\n      const errorMessage = error?.message || error?.response?.data?.message || 'Failed to upload document. Please try again.';\n      const validationErrors = error?.response?.data?.errors;\n      \n      toast({\n        title: \"Upload failed\",\n        description: validationErrors \n          ? `Validation error: ${validationErrors.map((e: any) => `${e.path.join('.')}: ${e.message}`).join(', ')}`\n          : errorMessage,\n        variant: \"destructive\",\n      });\n      setIsUploading(false);\n    }\n  });\n\n  const addTagMutation = useMutation({\n    mutationFn: ({ docId, tagId }: { docId: string; tagId: string }) =>\n      apiRequest('POST', `/api/compliance/${docId}/tags/${tagId}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compliance'] });\n      if (selectedDoc) {\n        queryClient.invalidateQueries({ queryKey: ['/api/compliance', selectedDoc, 'tags'] });\n      }\n    },\n  });\n\n  const removeTagMutation = useMutation({\n    mutationFn: ({ docId, tagId }: { docId: string; tagId: string }) =>\n      apiRequest('DELETE', `/api/compliance/${docId}/tags/${tagId}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compliance'] });\n      if (selectedDoc) {\n        queryClient.invalidateQueries({ queryKey: ['/api/compliance', selectedDoc, 'tags'] });\n      }\n    },\n  });\n\n  const onSubmit = (data: UploadFormValues) => {\n    console.log('[Compliance] Form submitted with data:', data);\n    \n    // Ensure documentType is set\n    if (!data.documentType) {\n      form.setError('documentType', {\n        type: 'manual',\n        message: 'Please select a document type'\n      });\n      toast({\n        title: \"Validation error\",\n        description: \"Please select a document type\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Ensure documentUrl is set\n    if (!data.documentUrl) {\n      form.setError('documentUrl', {\n        type: 'manual',\n        message: 'Please upload a document'\n      });\n      toast({\n        title: \"Validation error\",\n        description: \"Please upload a document\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    uploadMutation.mutate(data);\n  };\n\n  const getStatusBadge = (doc: ComplianceDocument) => {\n    if (!doc.expiryDate) {\n      return <Badge variant=\"secondary\" data-testid={`badge-status-${doc.id}`}>No Expiry</Badge>;\n    }\n    \n    const expiryDate = new Date(doc.expiryDate.toString());\n    const daysUntilExpiry = differenceInDays(expiryDate, new Date());\n    \n    if (isPast(expiryDate)) {\n      return (\n        <Badge variant=\"destructive\" data-testid={`badge-status-${doc.id}`}>\n          Expired\n        </Badge>\n      );\n    } else if (daysUntilExpiry <= 30) {\n      return (\n        <Badge \n          className=\"bg-yellow-600 dark:bg-yellow-500 text-white dark:text-black\" \n          data-testid={`badge-status-${doc.id}`}\n        >\n          Expiring Soon\n        </Badge>\n      );\n    } else if (daysUntilExpiry <= 90) {\n      return (\n        <Badge \n          className=\"bg-blue-600 dark:bg-blue-500 text-white dark:text-black\" \n          data-testid={`badge-status-${doc.id}`}\n        >\n          {daysUntilExpiry}d left\n        </Badge>\n      );\n    }\n    \n    return (\n      <Badge variant=\"outline\" data-testid={`badge-status-${doc.id}`}>\n        Current\n      </Badge>\n    );\n  };\n\n  const getPropertyName = (propertyId: string | null): string | null => {\n    if (!propertyId) return null;\n    const property = properties.find(p => p.id === propertyId);\n    return property?.name || null;\n  };\n\n  const getBlockName = (blockId: string | null): string | null => {\n    if (!blockId) return null;\n    const block = blocks.find(b => b.id === blockId);\n    return block?.name || null;\n  };\n\n  const expiredDocs = documents.filter(doc => \n    doc.expiryDate && isPast(new Date(doc.expiryDate.toString()))\n  );\n\n  const currentDocs = documents.filter(doc => \n    !doc.expiryDate || !isPast(new Date(doc.expiryDate.toString()))\n  );\n\n  if (authLoading) {\n    return (\n      <div className=\"p-4 md:p-8\">\n        <p className=\"text-muted-foreground\">Loading...</p>\n      </div>\n    );\n  }\n\n  if (!user || (user.role !== \"owner\" && user.role !== \"compliance\")) {\n    return (\n      <div className=\"p-4 md:p-8\">\n        <Alert className=\"border-yellow-500 bg-yellow-50 dark:bg-yellow-950\">\n          <ShieldAlert className=\"h-4 w-4 text-yellow-600\" />\n          <AlertDescription className=\"text-yellow-800 dark:text-yellow-200\">\n            Access denied. Only organization owners and compliance officers can access this page.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4 md:p-8 space-y-6\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl md:text-3xl font-bold text-foreground\" data-testid=\"heading-compliance\">\n            Compliance Center\n          </h1>\n          <p className=\"text-sm md:text-base text-muted-foreground mt-1\">\n            Manage compliance documents and certifications\n          </p>\n        </div>\n        \n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogTrigger asChild>\n            <Button className=\"bg-primary w-full sm:w-auto\" data-testid=\"button-upload-document\">\n              <Upload className=\"w-4 h-4 mr-2\" />\n              Upload Document\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Upload Compliance Document</DialogTitle>\n              <DialogDescription>\n                Upload a compliance document such as insurance certificates, safety certificates, or licenses. You can optionally associate it with a property or block and set an expiry date for renewal reminders.\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form \n                onSubmit={(e) => {\n                  e.preventDefault();\n                  console.log('[Compliance] Form submit event triggered');\n                  form.handleSubmit(onSubmit, (errors) => {\n                    console.error('[Compliance] Form validation errors:', errors);\n                    toast({\n                      title: \"Validation error\",\n                      description: \"Please fill in all required fields\",\n                      variant: \"destructive\",\n                    });\n                  })(e);\n                }} \n                className=\"space-y-4\"\n              >\n                <FormField\n                  control={form.control}\n                  name=\"documentType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Document Type</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-document-type\">\n                            <SelectValue placeholder=\"Select document type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {DOCUMENT_TYPES.map((type) => (\n                            <SelectItem key={type} value={type}>\n                              {type}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"propertyId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Property (Optional)</FormLabel>\n                        <Select \n                          onValueChange={(value) => field.onChange(value === \"none\" ? undefined : value)} \n                          value={field.value || \"none\"}\n                        >\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-property\">\n                              <SelectValue placeholder=\"Select property\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"none\">None</SelectItem>\n                            {properties.map((property) => (\n                              <SelectItem key={property.id} value={property.id}>\n                                {property.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"blockId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Block (Optional)</FormLabel>\n                        <Select \n                          onValueChange={(value) => field.onChange(value === \"none\" ? undefined : value)} \n                          value={field.value || \"none\"}\n                        >\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-block\">\n                              <SelectValue placeholder=\"Select block\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"none\">None</SelectItem>\n                            {blocks.map((block) => (\n                              <SelectItem key={block.id} value={block.id}>\n                                {block.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"documentUrl\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Document File *</FormLabel>\n                      <FormControl>\n                        <div className=\"space-y-2\">\n                          <ObjectUploader\n                            onGetUploadParameters={async () => {\n                              try {\n                                setIsUploading(true);\n                                const response = await fetch('/api/objects/upload', {\n                                  method: 'POST',\n                                  credentials: 'include',\n                                });\n                                \n                                if (!response.ok) {\n                                  setIsUploading(false);\n                                  toast({\n                                    title: \"Upload initialization failed\",\n                                    description: \"Failed to prepare upload. Please try again.\",\n                                    variant: \"destructive\",\n                                  });\n                                  throw new Error('Failed to initialize upload');\n                                }\n                                \n                                const { uploadURL } = await response.json();\n                                return {\n                                  method: 'PUT' as const,\n                                  url: uploadURL,\n                                };\n                              } catch (error: any) {\n                                setIsUploading(false);\n                                toast({\n                                  title: \"Upload initialization failed\",\n                                  description: error.message || 'Failed to prepare upload. Please try again.',\n                                  variant: \"destructive\",\n                                });\n                                throw error;\n                              }\n                            }}\n                            onComplete={async (result) => {\n                              try {\n                                // Check for upload failures first\n                                if (result.failed && result.failed.length > 0) {\n                                  throw new Error('Document upload failed');\n                                }\n                                \n                                if (result.successful && result.successful[0]) {\n                                  let uploadURL = result.successful[0].uploadURL;\n                                  \n                                  // Normalize URL: if absolute, extract pathname; if relative, use as is\n                                  if (uploadURL && (uploadURL.startsWith('http://') || uploadURL.startsWith('https://'))) {\n                                    try {\n                                      const urlObj = new URL(uploadURL);\n                                      uploadURL = urlObj.pathname;\n                                    } catch (e) {\n                                      console.error('[Compliance] Invalid upload URL:', uploadURL);\n                                      setIsUploading(false);\n                                      toast({\n                                        title: \"Upload Error\",\n                                        description: \"Invalid file URL format. Please try again.\",\n                                        variant: \"destructive\",\n                                      });\n                                      return;\n                                    }\n                                  }\n                                  \n                                  // Ensure it's a relative path starting with /objects/\n                                  if (!uploadURL || !uploadURL.startsWith('/objects/')) {\n                                    console.error('[Compliance] Invalid file URL format:', uploadURL);\n                                    setIsUploading(false);\n                                    toast({\n                                      title: \"Upload Error\",\n                                      description: \"Invalid file URL format. Please try again.\",\n                                      variant: \"destructive\",\n                                    });\n                                    return;\n                                  }\n                                  \n                                  // Convert to absolute URL for ACL call\n                                  const absoluteUrl = `${window.location.origin}${uploadURL}`;\n                                  const response = await fetch('/api/objects/set-acl', {\n                                    method: 'PUT',\n                                    headers: { 'Content-Type': 'application/json' },\n                                    credentials: 'include',\n                                    body: JSON.stringify({ photoUrl: absoluteUrl }),\n                                  });\n                                  \n                                  if (!response.ok) {\n                                    const errorData = await response.json().catch(() => ({}));\n                                    throw new Error(errorData.error || 'Failed to set document permissions');\n                                  }\n                                  \n                                  const { objectPath } = await response.json();\n                                  field.onChange(objectPath);\n                                  setIsUploading(false);\n                                  toast({\n                                    title: \"File uploaded\",\n                                    description: \"Document file uploaded successfully\",\n                                  });\n                                } else {\n                                  throw new Error('No file was uploaded');\n                                }\n                              } catch (error: any) {\n                                console.error('Error uploading document:', error);\n                                setIsUploading(false);\n                                toast({\n                                  title: \"Upload failed\",\n                                  description: error.message || 'Failed to upload document. Please try again.',\n                                  variant: \"destructive\",\n                                });\n                                form.setError('documentUrl', {\n                                  type: 'manual',\n                                  message: 'Upload failed. Please try again.'\n                                });\n                              }\n                            }}\n                          >\n                            <Upload className=\"w-4 h-4 mr-2\" />\n                            {isUploading ? 'Uploading...' : 'Select Document'}\n                          </ObjectUploader>\n                          {field.value && !isUploading && (\n                            <div className=\"flex items-center gap-2 text-sm text-green-600 dark:text-green-400\">\n                              <Check className=\"h-4 w-4\" />\n                              <span>Document uploaded successfully</span>\n                            </div>\n                          )}\n                          {form.formState.errors.documentUrl && (\n                            <p className=\"text-sm text-destructive\">\n                              {form.formState.errors.documentUrl.message}. Click \"Select Document\" to try again.\n                            </p>\n                          )}\n                        </div>\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"expiryDate\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-col\">\n                      <FormLabel className=\"flex items-center gap-2\">\n                        <CalendarIcon className=\"h-4 w-4\" />\n                        Expiry Date (Optional)\n                      </FormLabel>\n                      <Popover>\n                        <PopoverTrigger asChild>\n                          <FormControl>\n                            <Button\n                              variant=\"outline\"\n                              className={cn(\n                                \"w-full justify-start text-left font-normal\",\n                                !field.value && \"text-muted-foreground\"\n                              )}\n                              data-testid=\"button-expiry-date\"\n                            >\n                              <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                              {field.value ? formatDate(new Date(field.value), \"PPP\") : <span>Pick a date</span>}\n                            </Button>\n                          </FormControl>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-auto p-0 z-[70]\" align=\"start\">\n                          <CalendarComponent\n                            mode=\"single\"\n                            selected={field.value ? new Date(field.value) : undefined}\n                            onSelect={(date) => field.onChange(date ? date.toISOString() : undefined)}\n                            disabled={(date) => date < new Date(new Date().setHours(0, 0, 0, 0))}\n                            initialFocus\n                          />\n                        </PopoverContent>\n                      </Popover>\n                      <FormDescription>\n                        Set an expiry date to receive alerts when this document needs renewal\n                      </FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      setOpen(false);\n                      setIsUploading(false);\n                      form.reset();\n                    }}\n                    data-testid=\"button-cancel\"\n                    className=\"w-full sm:w-auto\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    className=\"bg-primary w-full sm:w-auto\"\n                    disabled={uploadMutation.isPending || isUploading || !form.watch('documentUrl') || !form.watch('documentType')}\n                    data-testid=\"button-submit-document\"\n                  >\n                    {uploadMutation.isPending ? \"Saving...\" : \"Upload Document\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {expiringDocs.length > 0 && (\n        <Alert className=\"border-yellow-500 bg-yellow-50 dark:bg-yellow-950\">\n          <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\n          <AlertDescription className=\"text-yellow-800 dark:text-yellow-200\">\n            <span className=\"font-semibold\">{expiringDocs.length} document(s)</span> expiring within 90 days. Please renew them soon.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {expiredDocs.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center gap-2\">\n            <AlertTriangle className=\"w-5 h-5 text-destructive\" />\n            <h2 className=\"text-xl font-semibold text-destructive\" data-testid=\"heading-expired\">\n              Expired Documents ({expiredDocs.length})\n            </h2>\n          </div>\n          <div className=\"grid gap-4\">\n            {expiredDocs.map((doc) => (\n              <DocumentCard\n                key={doc.id}\n                doc={doc}\n                getStatusBadge={getStatusBadge}\n                getPropertyName={getPropertyName}\n                getBlockName={getBlockName}\n                allTags={allTags}\n                docTags={selectedDoc === doc.id ? docTags : []}\n                selectedDoc={selectedDoc}\n                setSelectedDoc={setSelectedDoc}\n                setTagDialogOpen={setTagDialogOpen}\n                addTagMutation={addTagMutation}\n                removeTagMutation={removeTagMutation}\n              />\n            ))}\n          </div>\n          <Separator className=\"my-6\" />\n        </div>\n      )}\n\n      <div className=\"space-y-4\">\n        <h2 className=\"text-xl font-semibold\" data-testid=\"heading-current\">\n          {expiredDocs.length > 0 ? 'Current Documents' : 'All Documents'} ({currentDocs.length})\n        </h2>\n        \n        {isLoading ? (\n          <Card>\n            <CardContent className=\"p-8 text-center text-muted-foreground\">\n              Loading documents...\n            </CardContent>\n          </Card>\n        ) : currentDocs.length === 0 && expiredDocs.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center\">\n              <FileText className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n              <p className=\"text-muted-foreground\">No compliance documents uploaded yet.</p>\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Upload your first document to get started.\n              </p>\n            </CardContent>\n          </Card>\n        ) : currentDocs.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-8 text-center\">\n              <p className=\"text-muted-foreground\">All documents are expired. Please upload new documents.</p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-4\">\n            {currentDocs.map((doc) => (\n              <DocumentCard\n                key={doc.id}\n                doc={doc}\n                getStatusBadge={getStatusBadge}\n                getPropertyName={getPropertyName}\n                getBlockName={getBlockName}\n                allTags={allTags}\n                docTags={selectedDoc === doc.id ? docTags : []}\n                selectedDoc={selectedDoc}\n                setSelectedDoc={setSelectedDoc}\n                setTagDialogOpen={setTagDialogOpen}\n                addTagMutation={addTagMutation}\n                removeTagMutation={removeTagMutation}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\ninterface DocumentCardProps {\n  doc: ComplianceDocument;\n  getStatusBadge: (doc: ComplianceDocument) => JSX.Element;\n  getPropertyName: (id: string | null) => string | null;\n  getBlockName: (id: string | null) => string | null;\n  allTags: Tag[];\n  docTags: Tag[];\n  selectedDoc: string | null;\n  setSelectedDoc: (id: string | null) => void;\n  setTagDialogOpen: (open: boolean) => void;\n  addTagMutation: any;\n  removeTagMutation: any;\n}\n\nfunction DocumentCard({\n  doc,\n  getStatusBadge,\n  getPropertyName,\n  getBlockName,\n  allTags,\n  docTags,\n  selectedDoc,\n  setSelectedDoc,\n  setTagDialogOpen,\n  addTagMutation,\n  removeTagMutation,\n}: DocumentCardProps) {\n  const propertyName = getPropertyName(doc.propertyId);\n  const blockName = getBlockName(doc.blockId);\n  const [tagPopoverOpen, setTagPopoverOpen] = useState(false);\n\n  const handleAddTag = (tagId: string) => {\n    addTagMutation.mutate({ docId: doc.id, tagId });\n    setTagPopoverOpen(false);\n  };\n\n  const handleRemoveTag = (tagId: string) => {\n    removeTagMutation.mutate({ docId: doc.id, tagId });\n  };\n\n  const availableTags = allTags.filter(\n    tag => !docTags.some(dt => dt.id === tag.id)\n  );\n\n  return (\n    <Card className=\"hover-elevate\" data-testid={`card-document-${doc.id}`}>\n      <CardHeader>\n        <div className=\"flex flex-col md:flex-row md:items-start md:justify-between gap-4\">\n          <div className=\"flex-1 space-y-2\">\n            <CardTitle className=\"text-base md:text-lg flex items-center gap-2 flex-wrap\">\n              <FileText className=\"w-5 h-5 text-primary flex-shrink-0\" />\n              <span data-testid={`text-document-type-${doc.id}`} className=\"break-words\">\n                {doc.documentType}\n              </span>\n            </CardTitle>\n            \n            <div className=\"flex flex-wrap items-center gap-2 text-sm text-muted-foreground\">\n              {doc.expiryDate && (\n                <div className=\"flex items-center gap-1.5\">\n                  <Calendar className=\"w-4 h-4\" />\n                  <span data-testid={`text-expiry-date-${doc.id}`}>\n                    {formatDate(new Date(doc.expiryDate.toString()), 'PPP')}\n                  </span>\n                </div>\n              )}\n              \n              {propertyName && (\n                <div className=\"flex items-center gap-1.5\">\n                  <Home className=\"w-4 h-4\" />\n                  <span>{propertyName}</span>\n                </div>\n              )}\n              \n              {blockName && (\n                <div className=\"flex items-center gap-1.5\">\n                  <Building2 className=\"w-4 h-4\" />\n                  <span>{blockName}</span>\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex flex-wrap items-center gap-2\">\n              {selectedDoc === doc.id && docTags.map((tag) => (\n                <Badge\n                  key={tag.id}\n                  variant=\"outline\"\n                  style={{ \n                    borderColor: tag.color || undefined, \n                    backgroundColor: tag.color ? `${tag.color}15` : undefined,\n                    color: tag.color || undefined\n                  } as React.CSSProperties}\n                  className=\"gap-1\"\n                  data-testid={`badge-tag-${tag.id}`}\n                >\n                  {tag.name}\n                  <button\n                    onClick={() => handleRemoveTag(tag.id)}\n                    className=\"hover:bg-background/20 rounded-full p-0.5\"\n                    data-testid={`button-remove-tag-${tag.id}`}\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </button>\n                </Badge>\n              ))}\n              \n              {selectedDoc === doc.id && (\n                <Popover open={tagPopoverOpen} onOpenChange={setTagPopoverOpen}>\n                  <PopoverTrigger asChild>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"h-6 px-2 text-xs\"\n                      data-testid={`button-add-tag-${doc.id}`}\n                    >\n                      <Plus className=\"w-3 h-3 mr-1\" />\n                      Tag\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-64 p-0\" align=\"start\">\n                    <Command>\n                      <CommandInput placeholder=\"Search tags...\" />\n                      <CommandList>\n                        <CommandEmpty>No tags found.</CommandEmpty>\n                        <CommandGroup>\n                          {availableTags.map((tag) => (\n                            <CommandItem\n                              key={tag.id}\n                              onSelect={() => handleAddTag(tag.id)}\n                              data-testid={`option-tag-${tag.id}`}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <div\n                                  className=\"w-3 h-3 rounded-full flex-shrink-0\"\n                                  style={{ backgroundColor: tag.color || undefined } as React.CSSProperties}\n                                />\n                                <span>{tag.name}</span>\n                              </div>\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              )}\n              \n              {selectedDoc !== doc.id && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-6 px-2 text-xs\"\n                  onClick={() => setSelectedDoc(doc.id)}\n                  data-testid={`button-manage-tags-${doc.id}`}\n                >\n                  <TagIcon className=\"w-3 h-3 mr-1\" />\n                  Manage Tags\n                </Button>\n              )}\n            </div>\n          </div>\n          \n          <div className=\"flex flex-wrap items-center gap-2\">\n            {getStatusBadge(doc)}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              asChild\n              data-testid={`button-view-document-${doc.id}`}\n            >\n              <a href={doc.documentUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n                <ExternalLink className=\"w-4 h-4 mr-1\" />\n                View\n              </a>\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      {doc.createdAt && (\n        <CardContent className=\"pt-0\">\n          <p className=\"text-xs md:text-sm text-muted-foreground\">\n            Uploaded {formatDate(new Date(doc.createdAt.toString()), 'PPP')}\n          </p>\n        </CardContent>\n      )}\n    </Card>\n  );\n}\n","size_bytes":38259},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"server/db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\n// Create a PostgreSQL connection pool\n// Works with both standard PostgreSQL and Neon (which uses standard PostgreSQL protocol)\nexport const pool = new Pool({ \n  connectionString: process.env.DATABASE_URL,\n  // Additional connection options for better compatibility\n  ssl: process.env.DATABASE_URL?.includes('sslmode=require') ? { rejectUnauthorized: false } : undefined,\n});\n\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":687},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n    // Preserve fs config from viteConfig\n    fs: viteConfig.server?.fs,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  // Build output is in dist/public (from vite.config.ts)\n  const distPath = path.resolve(import.meta.dirname, \"..\", \"dist\", \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first with 'npm run build'`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2429},"client/src/pages/PropertyDetail.tsx":{"content":"import { useState } from \"react\";\nimport { useRoute, Link } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport ComplianceCalendar from \"@/components/ComplianceCalendar\";\nimport { insertComplianceDocumentSchema } from \"@shared/schema\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  ArrowLeft,\n  Building2,\n  Users,\n  ClipboardCheck,\n  Package,\n  FileCheck,\n  Wrench,\n  MapPin,\n  Calendar,\n  CheckCircle2,\n  AlertCircle,\n  User,\n  Upload,\n  Pencil,\n} from \"lucide-react\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { AddressInput } from \"@/components/AddressInput\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Property {\n  id: string;\n  name: string;\n  address: string;\n  blockId: string | null;\n  blockName?: string;\n  notes?: string | null;\n  organizationId: string;\n}\n\ninterface PropertyStats {\n  occupancyStatus: string;\n  complianceRate: number;\n  dueInspections: number;\n  overdueInspections: number;\n  maintenanceRequests: number;\n  inventoryCount: number;\n}\n\ninterface Tenant {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  role: string;\n}\n\ninterface Inspection {\n  id: string;\n  templateName: string;\n  scheduledDate: string;\n  status: string;\n  inspectorName?: string;\n  type?: string;\n}\n\ninterface InventoryItem {\n  id: string;\n  name: string;\n  category: string;\n  condition: string;\n  quantity: number;\n  datePurchased?: string | null;\n  expectedLifespanYears?: number | null;\n  description?: string | null;\n}\n\ninterface ComplianceDoc {\n  id: string;\n  documentName: string;\n  documentType: string;\n  expiryDate: string | null;\n  status: string;\n}\n\ninterface MaintenanceRequest {\n  id: string;\n  title: string;\n  priority: string;\n  status: string;\n  createdAt: string;\n  category: string;\n  description?: string;\n  reportedByName?: string;\n  assignedToName?: string;\n}\n\nconst DOCUMENT_TYPES = [\n  \"Fire Safety Certificate\",\n  \"Building Insurance\",\n  \"Electrical Safety Certificate\",\n  \"Gas Safety Certificate\",\n  \"EPC Certificate\",\n  \"HMO License\",\n  \"Planning Permission\",\n  \"Other\",\n];\n\nconst uploadFormSchema = insertComplianceDocumentSchema.extend({\n  documentUrl: z.string().min(1, \"Please upload a document\"),\n  expiryDate: z.string().optional(),\n});\n\ntype UploadFormValues = z.infer<typeof uploadFormSchema>;\n\nexport default function PropertyDetail() {\n  const [, params] = useRoute(\"/properties/:id\");\n  const propertyId = params?.id;\n  const [uploadDialogOpen, setUploadDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [editName, setEditName] = useState(\"\");\n  const [editAddress, setEditAddress] = useState(\"\");\n  const [editNotes, setEditNotes] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: property, isLoading: propertyLoading } = useQuery<Property>({\n    queryKey: [\"/api/properties\", propertyId],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch property\");\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: stats } = useQuery<PropertyStats>({\n    queryKey: [\"/api/properties\", propertyId, \"stats\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/stats`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch stats\");\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: tenants = [] } = useQuery<Tenant[]>({\n    queryKey: [\"/api/properties\", propertyId, \"tenants\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/tenants`, { credentials: \"include\" });\n      if (!res.ok) return [];\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: inspections = [] } = useQuery<Inspection[]>({\n    queryKey: [\"/api/properties\", propertyId, \"inspections\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/inspections`, { credentials: \"include\" });\n      if (!res.ok) return [];\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: inventory = [] } = useQuery<InventoryItem[]>({\n    queryKey: [\"/api/properties\", propertyId, \"inventory\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/inventory`, { credentials: \"include\" });\n      if (!res.ok) return [];\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: compliance = [] } = useQuery<ComplianceDoc[]>({\n    queryKey: [\"/api/properties\", propertyId, \"compliance\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/compliance`, { credentials: \"include\" });\n      if (!res.ok) return [];\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: complianceReport, isLoading: complianceReportLoading } = useQuery({\n    queryKey: [\"/api/properties\", propertyId, \"compliance-report\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/compliance-report`, { credentials: \"include\" });\n      if (!res.ok) return null;\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: maintenance = [] } = useQuery<MaintenanceRequest[]>({\n    queryKey: [\"/api/properties\", propertyId, \"maintenance\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/maintenance`, { credentials: \"include\" });\n      if (!res.ok) return [];\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const form = useForm<UploadFormValues>({\n    resolver: zodResolver(uploadFormSchema),\n    defaultValues: {\n      documentType: \"\",\n      documentUrl: \"\",\n      expiryDate: undefined,\n      propertyId: propertyId,\n      blockId: undefined,\n      status: \"current\",\n    },\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: (data: UploadFormValues) => apiRequest('POST', '/api/compliance', {\n      ...data,\n      expiryDate: data.expiryDate ? new Date(data.expiryDate) : null,\n    }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/properties', propertyId, 'compliance'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/compliance'] });\n      setUploadDialogOpen(false);\n      form.reset({\n        documentType: \"\",\n        documentUrl: \"\",\n        expiryDate: undefined,\n        propertyId: propertyId,\n        blockId: undefined,\n        status: \"current\",\n      });\n    },\n  });\n\n  const onSubmit = (data: UploadFormValues) => {\n    uploadMutation.mutate(data);\n  };\n\n  const updatePropertyMutation = useMutation({\n    mutationFn: async (data: { name: string; address: string; notes?: string }) => {\n      return await apiRequest(\"PATCH\", `/api/properties/${propertyId}`, data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/properties\", propertyId] });\n      await queryClient.refetchQueries({ queryKey: [\"/api/properties\"] });\n      toast({\n        title: \"Success\",\n        description: \"Property updated successfully\",\n      });\n      setEditDialogOpen(false);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update property\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenEditDialog = () => {\n    if (property) {\n      setEditName(property.name);\n      setEditAddress(property.address);\n      setEditNotes(property.notes || \"\");\n      setEditDialogOpen(true);\n    }\n  };\n\n  const handleEditSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!editName || !editAddress) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    updatePropertyMutation.mutate({\n      name: editName,\n      address: editAddress,\n      notes: editNotes || undefined,\n    });\n  };\n\n  if (propertyLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!property) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Property not found</p>\n          <Link href=\"/properties\">\n            <Button variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Properties\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center gap-4\">\n        <Link href={property.blockId ? `/blocks/${property.blockId}` : \"/properties\"}>\n          <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            {property.blockId && property.blockName ? `Back to ${property.blockName}` : \"Back to Properties\"}\n          </Button>\n        </Link>\n      </div>\n\n      {/* Property Header */}\n      <div>\n        <div className=\"flex items-start justify-between\">\n          <div className=\"space-y-2\">\n            <h1 className=\"text-3xl font-bold flex items-center gap-3\" data-testid=\"heading-property-name\">\n              <Building2 className=\"h-8 w-8 text-primary\" />\n              {property.name}\n            </h1>\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <MapPin className=\"h-4 w-4\" />\n              <span data-testid=\"text-property-address\">{property.address}</span>\n            </div>\n            {property.blockName && (\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"outline\" data-testid=\"badge-block\">\n                  Block: {property.blockName}\n                </Badge>\n              </div>\n            )}\n          </div>\n          <Button\n            variant=\"outline\"\n            onClick={handleOpenEditDialog}\n            data-testid=\"button-edit-property\"\n          >\n            <Pencil className=\"h-4 w-4 mr-2\" />\n            Edit Property\n          </Button>\n        </div>\n        {property.notes && (\n          <Card className=\"mt-4\">\n            <CardContent className=\"pt-6\">\n              <p className=\"text-sm text-muted-foreground\">{property.notes}</p>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Stats Overview */}\n      {stats && (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Occupancy</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.occupancyStatus}</div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Compliance</CardTitle>\n              <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.complianceRate}%</div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Inspections</CardTitle>\n              <ClipboardCheck className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                {stats.dueInspections + stats.overdueInspections}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                {stats.overdueInspections > 0 && `${stats.overdueInspections} overdue`}\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Maintenance</CardTitle>\n              <Wrench className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.maintenanceRequests}</div>\n              <p className=\"text-xs text-muted-foreground\">Open requests</p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Tabbed Content */}\n      <Tabs defaultValue=\"inspections\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"inspections\" data-testid=\"tab-inspections\">\n            <ClipboardCheck className=\"h-4 w-4 mr-2\" />\n            Inspections\n          </TabsTrigger>\n          <TabsTrigger value=\"tenants\" data-testid=\"tab-tenants\">\n            <Users className=\"h-4 w-4 mr-2\" />\n            Tenants\n          </TabsTrigger>\n          <TabsTrigger value=\"inventory\" data-testid=\"tab-inventory\">\n            <Package className=\"h-4 w-4 mr-2\" />\n            Inventory\n          </TabsTrigger>\n          <TabsTrigger value=\"compliance\" data-testid=\"tab-compliance\">\n            <FileCheck className=\"h-4 w-4 mr-2\" />\n            Compliance\n          </TabsTrigger>\n          <TabsTrigger value=\"maintenance\" data-testid=\"tab-maintenance\">\n            <Wrench className=\"h-4 w-4 mr-2\" />\n            Maintenance\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Inspections Tab */}\n        <TabsContent value=\"inspections\" className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <h2 className=\"text-xl font-semibold\">Inspections</h2>\n            <Link href={`/inspections?propertyId=${propertyId}&create=true`}>\n              <Button data-testid=\"button-new-inspection\">\n                <ClipboardCheck className=\"mr-2 h-4 w-4\" />\n                New Inspection\n              </Button>\n            </Link>\n          </div>\n          \n          {inspections.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <ClipboardCheck className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No inspections yet</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-3\">\n              {inspections.map((inspection) => (\n                <Link key={inspection.id} href={`/inspections/${inspection.id}`}>\n                  <Card className=\"hover-elevate cursor-pointer\" data-testid={`card-inspection-${inspection.id}`}>\n                    <CardHeader>\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"space-y-2 flex-1\">\n                          <CardTitle className=\"text-base\">{inspection.templateName}</CardTitle>\n                          <div className=\"flex flex-wrap items-center gap-3 text-sm text-muted-foreground\">\n                            <div className=\"flex items-center gap-1\">\n                              <Calendar className=\"h-3 w-3\" />\n                              <span>{new Date(inspection.scheduledDate).toLocaleDateString()}</span>\n                            </div>\n                            {inspection.inspectorName && (\n                              <div className=\"flex items-center gap-1\">\n                                <User className=\"h-3 w-3\" />\n                                <span>{inspection.inspectorName}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                        <Badge variant={\n                          inspection.status === 'completed' ? 'default' :\n                          inspection.status === 'in_progress' ? 'secondary' :\n                          'outline'\n                        }>\n                          {inspection.status.replace('_', ' ')}\n                        </Badge>\n                      </div>\n                    </CardHeader>\n                  </Card>\n                </Link>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Tenants Tab */}\n        <TabsContent value=\"tenants\" className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Tenants</h2>\n          \n          {tenants.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <User className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No tenants assigned</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {tenants.map((tenant) => (\n                <Card key={tenant.id} data-testid={`card-tenant-${tenant.id}`} className=\"hover-elevate\">\n                  <CardHeader>\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                        <User className=\"h-5 w-5 text-primary\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <CardTitle className=\"text-base mb-1\">\n                          {tenant.firstName} {tenant.lastName}\n                        </CardTitle>\n                        <CardDescription className=\"text-sm break-all\">\n                          {tenant.email}\n                        </CardDescription>\n                        <Badge variant=\"outline\" className=\"mt-2 text-xs\">\n                          Tenant\n                        </Badge>\n                      </div>\n                    </div>\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Inventory Tab */}\n        <TabsContent value=\"inventory\" className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <h2 className=\"text-xl font-semibold\">Asset Inventory</h2>\n            <Link href={`/asset-inventory?propertyId=${propertyId}`}>\n              <Button data-testid=\"button-new-inventory\">\n                <Package className=\"mr-2 h-4 w-4\" />\n                Add Item\n              </Button>\n            </Link>\n          </div>\n          \n          {inventory.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <Package className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No inventory items</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-3\">\n              {inventory.map((item) => (\n                <Card key={item.id} data-testid={`card-inventory-${item.id}`}>\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"space-y-2 flex-1\">\n                        <CardTitle className=\"text-base\">{item.name}</CardTitle>\n                        <CardDescription className=\"line-clamp-1\">{item.description || item.category}</CardDescription>\n                        <div className=\"flex flex-wrap gap-3 text-xs text-muted-foreground\">\n                          {item.datePurchased && (\n                            <span>Purchased: {new Date(item.datePurchased).toLocaleDateString()}</span>\n                          )}\n                          {item.expectedLifespanYears && (\n                            <span>Lifespan: {item.expectedLifespanYears} years</span>\n                          )}\n                        </div>\n                      </div>\n                      <Badge variant={\n                        item.condition === 'excellent' ? 'default' :\n                        item.condition === 'good' ? 'secondary' :\n                        item.condition === 'fair' ? 'outline' :\n                        'destructive'\n                      }>\n                        {item.condition}\n                      </Badge>\n                    </div>\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Compliance Tab */}\n        <TabsContent value=\"compliance\" className=\"space-y-6\">\n          {/* Annual Compliance Report */}\n          <ComplianceCalendar \n            report={complianceReport} \n            isLoading={complianceReportLoading}\n            entityType=\"property\"\n          />\n\n          {/* Compliance Documents Section */}\n          <div className=\"flex justify-between items-center\">\n            <h2 className=\"text-xl font-semibold\">Compliance Documents</h2>\n            <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-new-compliance\">\n                  <Upload className=\"mr-2 h-4 w-4\" />\n                  Upload Document\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Upload Compliance Document</DialogTitle>\n                </DialogHeader>\n                <Form {...form}>\n                  <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"documentType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Document Type</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-document-type\">\n                                <SelectValue placeholder=\"Select document type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {DOCUMENT_TYPES.map((type) => (\n                                <SelectItem key={type} value={type}>\n                                  {type}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"documentUrl\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Document File</FormLabel>\n                          <FormControl>\n                            <ObjectUploader\n                              onGetUploadParameters={async () => {\n                                const response = await fetch('/api/objects/upload', {\n                                  method: 'POST',\n                                  credentials: 'include',\n                                });\n                                const { uploadURL } = await response.json();\n                                return {\n                                  method: 'PUT',\n                                  url: uploadURL,\n                                };\n                              }}\n                              onComplete={async (result) => {\n                                if (result.successful && result.successful[0]) {\n                                  let uploadURL = result.successful[0].uploadURL;\n                                  \n                                  // Normalize URL: if absolute, extract pathname; if relative, use as is\n                                  if (uploadURL && (uploadURL.startsWith('http://') || uploadURL.startsWith('https://'))) {\n                                    try {\n                                      const urlObj = new URL(uploadURL);\n                                      uploadURL = urlObj.pathname;\n                                    } catch (e) {\n                                      console.error('[PropertyDetail] Invalid upload URL:', uploadURL);\n                                    }\n                                  }\n                                  \n                                  // Ensure it's a relative path starting with /objects/\n                                  if (!uploadURL || !uploadURL.startsWith('/objects/')) {\n                                    toast({\n                                      title: \"Upload Error\",\n                                      description: \"Invalid file URL format. Please try again.\",\n                                      variant: \"destructive\",\n                                    });\n                                    return;\n                                  }\n                                  \n                                  // Convert to absolute URL for ACL call\n                                  const absoluteUrl = `${window.location.origin}${uploadURL}`;\n                                  const response = await fetch('/api/objects/set-acl', {\n                                    method: 'PUT',\n                                    headers: { 'Content-Type': 'application/json' },\n                                    credentials: 'include',\n                                    body: JSON.stringify({ photoUrl: absoluteUrl }),\n                                  });\n                                  const { objectPath } = await response.json();\n                                  field.onChange(objectPath);\n                                }\n                              }}\n                            >\n                              <Upload className=\"w-4 h-4 mr-2\" />\n                              Select Document\n                            </ObjectUploader>\n                          </FormControl>\n                          {field.value && (\n                            <p className=\"text-sm text-muted-foreground mt-1\">\n                               Document selected\n                            </p>\n                          )}\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"expiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date (Optional)</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"date\"\n                              {...field}\n                              data-testid=\"input-expiry-date\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"flex flex-col-reverse sm:flex-row justify-end gap-2 pt-4\">\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => setUploadDialogOpen(false)}\n                        data-testid=\"button-cancel\"\n                        className=\"w-full sm:w-auto\"\n                      >\n                        Cancel\n                      </Button>\n                      <Button\n                        type=\"submit\"\n                        className=\"bg-primary w-full sm:w-auto\"\n                        disabled={uploadMutation.isPending}\n                        data-testid=\"button-submit-document\"\n                      >\n                        {uploadMutation.isPending ? \"Uploading...\" : \"Upload Document\"}\n                      </Button>\n                    </div>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n          \n          {compliance.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <FileCheck className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No compliance documents</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-3\">\n              {compliance.map((doc) => {\n                const expiryDate = doc.expiryDate ? new Date(doc.expiryDate) : null;\n                const now = new Date();\n                const daysUntilExpiry = expiryDate ? Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) : null;\n                \n                return (\n                  <Card key={doc.id} data-testid={`card-compliance-${doc.id}`}>\n                    <CardHeader>\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"space-y-2 flex-1\">\n                          <CardTitle className=\"text-base\">{doc.documentName}</CardTitle>\n                          <CardDescription>{doc.documentType}</CardDescription>\n                          {expiryDate && (\n                            <div className=\"flex flex-col gap-1\">\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                {doc.status === 'expired' ? (\n                                  <>\n                                    <AlertCircle className=\"h-3 w-3 text-destructive\" />\n                                    <span className=\"text-destructive font-medium\">\n                                      Expired {new Date(expiryDate).toLocaleDateString()}\n                                    </span>\n                                  </>\n                                ) : doc.status === 'expiring' ? (\n                                  <>\n                                    <AlertCircle className=\"h-3 w-3 text-orange-500\" />\n                                    <span className=\"text-orange-500 font-medium\">\n                                      Expires in {daysUntilExpiry} days ({new Date(expiryDate).toLocaleDateString()})\n                                    </span>\n                                  </>\n                                ) : (\n                                  <>\n                                    <CheckCircle2 className=\"h-3 w-3 text-green-600\" />\n                                    <span className=\"text-muted-foreground\">\n                                      Expires: {new Date(expiryDate).toLocaleDateString()}\n                                    </span>\n                                  </>\n                                )}\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                        <Badge variant={\n                          doc.status === 'expired' ? 'destructive' :\n                          doc.status === 'expiring' ? 'outline' :\n                          'default'\n                        }>\n                          {doc.status === 'expired' ? 'Expired' : doc.status === 'expiring' ? 'Expiring Soon' : 'Valid'}\n                        </Badge>\n                      </div>\n                    </CardHeader>\n                  </Card>\n                );\n              })}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Maintenance Tab */}\n        <TabsContent value=\"maintenance\" className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <h2 className=\"text-xl font-semibold\">Maintenance Requests</h2>\n            <Link href={`/maintenance/new?propertyId=${propertyId}`}>\n              <Button data-testid=\"button-new-maintenance\">\n                <Wrench className=\"mr-2 h-4 w-4\" />\n                New Request\n              </Button>\n            </Link>\n          </div>\n          \n          {maintenance.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <Wrench className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No maintenance requests</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-3\">\n              {maintenance.map((request) => (\n                <Card key={request.id} data-testid={`card-maintenance-${request.id}`}>\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"space-y-2 flex-1\">\n                        <CardTitle className=\"text-base\">{request.title}</CardTitle>\n                        {request.description && (\n                          <p className=\"text-sm text-muted-foreground line-clamp-2\">{request.description}</p>\n                        )}\n                        <div className=\"flex flex-wrap items-center gap-3 text-xs text-muted-foreground\">\n                          <div className=\"flex items-center gap-1\">\n                            <Calendar className=\"h-3 w-3\" />\n                            <span>{new Date(request.createdAt).toLocaleDateString()}</span>\n                          </div>\n                          {request.reportedByName && (\n                            <span>Reported by: {request.reportedByName}</span>\n                          )}\n                          {request.assignedToName && (\n                            <span>Assigned to: {request.assignedToName}</span>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex flex-col items-end gap-2\">\n                        <Badge variant={\n                          request.priority === 'urgent' ? 'destructive' :\n                          request.priority === 'high' ? 'default' :\n                          'secondary'\n                        }>\n                          {request.priority}\n                        </Badge>\n                        <Badge variant=\"outline\">{request.status.replace('_', ' ')}</Badge>\n                      </div>\n                    </div>\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Edit Property Dialog */}\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Property</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleEditSubmit} className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"edit-name\">Property Name *</Label>\n              <Input\n                id=\"edit-name\"\n                value={editName}\n                onChange={(e) => setEditName(e.target.value)}\n                placeholder=\"e.g., Flat 12, Unit 5B\"\n                data-testid=\"input-edit-property-name\"\n                required\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"edit-address\">Address *</Label>\n              <AddressInput\n                id=\"edit-address\"\n                value={editAddress}\n                onChange={setEditAddress}\n                placeholder=\"123 Main St, City, State ZIP\"\n                data-testid=\"input-edit-property-address\"\n                required\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"edit-notes\">Notes</Label>\n              <Textarea\n                id=\"edit-notes\"\n                value={editNotes}\n                onChange={(e) => setEditNotes(e.target.value)}\n                placeholder=\"Additional notes about this property...\"\n                data-testid=\"input-edit-property-notes\"\n              />\n            </div>\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={updatePropertyMutation.isPending}\n              data-testid=\"button-submit-edit-property\"\n            >\n              {updatePropertyMutation.isPending ? \"Updating...\" : \"Update Property\"}\n            </Button>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":37616},"client/src/components/ObjectUploader.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport type { ReactNode } from \"react\";\nimport Uppy from \"@uppy/core\";\nimport { DashboardModal } from \"@uppy/react\";\nimport AwsS3 from \"@uppy/aws-s3\";\nimport Webcam from \"@uppy/webcam\";\nimport \"@uppy/core/css/style.min.css\";\nimport \"@uppy/dashboard/css/style.min.css\";\nimport \"@uppy/webcam/css/style.min.css\";\nimport type { UploadResult } from \"@uppy/core\";\nimport { Button } from \"@/components/ui/button\";\nimport { extractFileUrlFromUploadResponse } from \"@/lib/utils\";\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  onGetUploadParameters: () => Promise<{\n    method: \"PUT\";\n    url: string;\n  }>;\n  onComplete?: (\n    result: UploadResult<Record<string, unknown>, Record<string, unknown>>\n  ) => void;\n  buttonClassName?: string;\n  children: ReactNode;\n}\n\nexport function ObjectUploader({\n  maxNumberOfFiles = 1,\n  maxFileSize = 10485760, // 10MB default\n  onGetUploadParameters,\n  onComplete,\n  buttonClassName,\n  children,\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [uppy] = useState(() => {\n    const uppyInstance = new Uppy({\n      restrictions: {\n        maxNumberOfFiles,\n        maxFileSize,\n      },\n      autoProceed: false,\n    })\n      .use(Webcam, {\n        modes: ['picture'],\n        facingMode: 'environment',\n      } as any)\n      .use(AwsS3, {\n        shouldUseMultipart: false,\n        async getUploadParameters(file: any) {\n          const params = await onGetUploadParameters();\n          \n          // Extract objectId from upload URL and store in metadata\n          try {\n            const uploadURL = params.url;\n            const urlObj = new URL(uploadURL);\n            const objectId = urlObj.searchParams.get('objectId');\n            if (objectId) {\n              uppyInstance.setFileMeta(file.id, { \n                originalUploadURL: uploadURL,\n                objectId: objectId,\n              });\n            } else {\n              uppyInstance.setFileMeta(file.id, { \n                originalUploadURL: uploadURL,\n              });\n            }\n          } catch (e) {\n            // If URL parsing fails, just store the upload URL\n            uppyInstance.setFileMeta(file.id, { \n              originalUploadURL: params.url,\n            });\n          }\n          \n          return params;\n        },\n      });\n    return uppyInstance;\n  });\n\n  useEffect(() => {\n    // Extract file URLs from upload responses and attach them to the result\n    const handleUploadSuccess = (file: any, response: any) => {\n      const fileUrl = extractFileUrlFromUploadResponse(file, response);\n      if (fileUrl) {\n        // Store the extracted URL in file metadata for later retrieval\n        file.meta = file.meta || {};\n        file.meta.extractedFileUrl = fileUrl;\n      }\n    };\n\n    uppy.on(\"upload-success\", handleUploadSuccess);\n\n    const handleComplete = (result: UploadResult<Record<string, unknown>, Record<string, unknown>>) => {\n      // Update successful files with extracted URLs\n      if (result.successful) {\n        result.successful = result.successful.map((file: any) => {\n          const extractedUrl = file.meta?.extractedFileUrl;\n          if (extractedUrl) {\n            return {\n              ...file,\n              uploadURL: extractedUrl, // Override with correct file URL\n            };\n          }\n          return file;\n        });\n      }\n      \n      onComplete?.(result);\n      \n      if (result.successful && result.successful.length > 0) {\n        setShowModal(false);\n      }\n    };\n\n    uppy.on(\"complete\", handleComplete);\n\n    return () => {\n      uppy.off(\"upload-success\", handleUploadSuccess);\n      uppy.off(\"complete\", handleComplete);\n    };\n  }, [uppy, onComplete]);\n\n  return (\n    <div>\n      <Button type=\"button\" onClick={() => setShowModal(true)} className={buttonClassName} data-testid=\"button-upload\">\n        {children}\n      </Button>\n\n      <DashboardModal\n        uppy={uppy}\n        open={showModal}\n        onRequestClose={() => setShowModal(false)}\n        proudlyDisplayPoweredByUppy={false}\n        plugins={['Webcam']}\n        note=\"\"\n        locale={{\n          strings: {\n            dropHint: '',\n            dropPasteImportBoth: '%{browseFiles} or use camera',\n            dropPasteBoth: '%{browseFiles} or use camera',\n            dropPasteFiles: '%{browseFiles} or use camera',\n            dropPasteFolders: '%{browseFiles} or use camera',\n            dropPasteImportFiles: '%{browseFiles} or use camera',\n            dropPasteImportFolders: '%{browseFiles} or use camera',\n            browseFiles: 'choose files',\n          }\n        }}\n      />\n    </div>\n  );\n}\n","size_bytes":4683},"client/src/pages/Comparisons.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, FileText, ArrowRight, AlertCircle } from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport type { ComparisonReport, Unit, Inspection, Property, InspectionItem } from \"@shared/schema\";\n\ntype ComparisonReportWithDetails = ComparisonReport & {\n  unit?: { unitNumber: string; property?: { name: string } };\n  checkInInspection?: Inspection;\n  checkOutInspection?: Inspection;\n};\n\ntype ItemComparisonData = {\n  checkIn: InspectionItem[];\n  checkOut: InspectionItem[];\n};\n\nexport default function Comparisons() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [isGenerateOpen, setIsGenerateOpen] = useState(false);\n  const [selectedUnitId, setSelectedUnitId] = useState<string>(\"\");\n  const [selectedCheckIn, setSelectedCheckIn] = useState<string>(\"\");\n  const [selectedCheckOut, setSelectedCheckOut] = useState<string>(\"\");\n  const [selectedReportId, setSelectedReportId] = useState<string | null>(null);\n\n  // Fetch all properties and units\n  const { data: properties = [] } = useQuery<Property[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: units = [] } = useQuery<Unit[]>({\n    queryKey: [\"/api/units\"],\n  });\n\n  // Fetch inspections for selected unit\n  const { data: unitInspections = [] } = useQuery<Inspection[], Error, Inspection[]>({\n    queryKey: [\"/api/inspections/my\"],\n    select: (inspections: Inspection[]) => \n      selectedUnitId \n        ? inspections.filter((i: Inspection) => i.unitId === selectedUnitId)\n        : [],\n  });\n\n  // Fetch all comparison reports\n  const { data: allReports = [], isLoading } = useQuery<ComparisonReport[]>({\n    queryKey: [\"/api/comparisons/all\"],\n    queryFn: async () => {\n      // Fetch comparison reports for all units\n      const reports: ComparisonReport[] = [];\n      for (const unit of units) {\n        const response = await fetch(`/api/comparisons/${unit.id}`);\n        const unitReports: ComparisonReport[] = await response.json();\n        reports.push(...unitReports);\n      }\n      return reports;\n    },\n    enabled: units.length > 0,\n  });\n\n  // Generate comparison mutation\n  const generateMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"/api/ai/generate-comparison\", \"POST\", {\n        unitId: selectedUnitId,\n        checkInInspectionId: selectedCheckIn,\n        checkOutInspectionId: selectedCheckOut,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/comparisons/all\"] });\n      // Invalidate organization query to update credit balance on dashboard and billing pages\n      if (user?.organizationId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n      }\n      setIsGenerateOpen(false);\n      setSelectedUnitId(\"\");\n      setSelectedCheckIn(\"\");\n      setSelectedCheckOut(\"\");\n      toast({\n        title: \"Success\",\n        description: \"Comparison report generated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to generate comparison report\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const checkInInspections = unitInspections.filter(i => i.type === \"check_in\");\n  const checkOutInspections = unitInspections.filter(i => i.type === \"check_out\");\n\n  const selectedReport = allReports.find(r => r.id === selectedReportId);\n  \n  // Type guard for item comparisons\n  const isItemComparisonData = (data: unknown): data is ItemComparisonData => {\n    if (!data || typeof data !== 'object' || data === null) return false;\n    return (\n      'checkIn' in data && Array.isArray(data.checkIn) && \n      'checkOut' in data && Array.isArray(data.checkOut)\n    );\n  };\n  \n  const itemComparisons = selectedReport?.itemComparisons && isItemComparisonData(selectedReport.itemComparisons)\n    ? selectedReport.itemComparisons\n    : null;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-comparisons\">Comparison Reports</h1>\n          <p className=\"text-muted-foreground\">AI-powered check-in vs check-out analysis</p>\n        </div>\n        <Dialog open={isGenerateOpen} onOpenChange={setIsGenerateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-generate-comparison\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Generate Report\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Generate Comparison Report</DialogTitle>\n              <DialogDescription>\n                Compare check-in and check-out inspections to identify changes (costs 2 credits)\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <Alert>\n                <AlertCircle className=\"w-4 h-4\" />\n                <AlertDescription>\n                  This AI analysis costs 2 inspection credits\n                </AlertDescription>\n              </Alert>\n\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Unit</label>\n                <Select value={selectedUnitId} onValueChange={setSelectedUnitId}>\n                  <SelectTrigger data-testid=\"select-unit\">\n                    <SelectValue placeholder=\"Select a unit\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {units.map((unit) => (\n                      <SelectItem key={unit.id} value={unit.id} data-testid={`option-unit-${unit.id}`}>\n                        Unit {unit.unitNumber}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {selectedUnitId && (\n                <>\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Check-in Inspection</label>\n                    <Select value={selectedCheckIn} onValueChange={setSelectedCheckIn}>\n                      <SelectTrigger data-testid=\"select-check-in\">\n                        <SelectValue placeholder=\"Select check-in inspection\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {checkInInspections.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">No check-in inspections found</div>\n                        ) : (\n                          checkInInspections.map((inspection) => (\n                            <SelectItem \n                              key={inspection.id} \n                              value={inspection.id}\n                              data-testid={`option-check-in-${inspection.id}`}\n                            >\n                              {format(new Date(inspection.scheduledDate?.toString() || Date.now()), 'PPP')}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Check-out Inspection</label>\n                    <Select value={selectedCheckOut} onValueChange={setSelectedCheckOut}>\n                      <SelectTrigger data-testid=\"select-check-out\">\n                        <SelectValue placeholder=\"Select check-out inspection\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {checkOutInspections.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">No check-out inspections found</div>\n                        ) : (\n                          checkOutInspections.map((inspection) => (\n                            <SelectItem \n                              key={inspection.id} \n                              value={inspection.id}\n                              data-testid={`option-check-out-${inspection.id}`}\n                            >\n                              {format(new Date(inspection.scheduledDate?.toString() || Date.now()), 'PPP')}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </>\n              )}\n\n              <Button \n                className=\"w-full\" \n                onClick={() => generateMutation.mutate()}\n                disabled={!selectedUnitId || !selectedCheckIn || !selectedCheckOut || generateMutation.isPending}\n                data-testid=\"button-submit-generate\"\n              >\n                {generateMutation.isPending ? \"Generating...\" : \"Generate Report (2 credits)\"}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Reports List */}\n      <div className=\"grid gap-4\">\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : allReports.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <FileText className=\"w-12 h-12 text-muted-foreground mb-4\" />\n              <p className=\"text-lg font-semibold mb-2\" data-testid=\"text-no-reports\">No comparison reports</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Generate your first comparison report to get started\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          allReports.map((report) => {\n            const unit = units.find(u => u.id === report.unitId);\n            const isExpanded = selectedReportId === report.id;\n\n            return (\n              <Card key={report.id} data-testid={`card-report-${report.id}`}>\n                <CardHeader>\n                  <div className=\"flex items-start justify-between gap-4\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg mb-2\" data-testid={`text-unit-${report.id}`}>\n                        Unit {unit?.unitNumber || \"Unknown\"}\n                      </CardTitle>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <span>Generated {format(new Date(report.createdAt?.toString() || Date.now()), 'PPP')}</span>\n                      </div>\n                    </div>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setSelectedReportId(isExpanded ? null : report.id)}\n                      data-testid={`button-toggle-${report.id}`}\n                    >\n                      {isExpanded ? \"Hide Details\" : \"View Details\"}\n                    </Button>\n                  </div>\n                </CardHeader>\n\n                {isExpanded && (\n                  <CardContent className=\"space-y-6\">\n                    {/* AI Summary */}\n                    <div>\n                      <h3 className=\"font-semibold mb-2\">AI Summary</h3>\n                      <div className=\"p-4 bg-muted rounded-md\">\n                        <p className=\"text-sm whitespace-pre-wrap\" data-testid={`text-summary-${report.id}`}>\n                          {report.aiSummary || \"No summary available\"}\n                        </p>\n                      </div>\n                    </div>\n\n                    {/* Item Comparisons */}\n                    {itemComparisons && (\n                      <div>\n                        <h3 className=\"font-semibold mb-4\">Item-by-Item Comparison</h3>\n                        <div className=\"space-y-4\">\n                          {itemComparisons.checkIn && itemComparisons.checkIn.length > 0 && (\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                              {/* Check-in Column */}\n                              <div>\n                                <div className=\"flex items-center gap-2 mb-3\">\n                                  <Badge variant=\"secondary\">Check-in</Badge>\n                                  <span className=\"text-sm text-muted-foreground\">\n                                    {format(new Date(report.createdAt?.toString() || Date.now()), 'PP')}\n                                  </span>\n                                </div>\n                                <div className=\"space-y-3\">\n                                  {itemComparisons.checkIn.map((item, idx: number) => (\n                                    <div \n                                      key={idx} \n                                      className=\"p-3 border rounded-md space-y-2\"\n                                      data-testid={`item-check-in-${idx}`}\n                                    >\n                                      {item.photoUrl && (\n                                        <img \n                                          src={item.photoUrl} \n                                          alt={item.itemName} \n                                          className=\"w-full h-32 object-cover rounded-md\"\n                                          data-testid={`photo-check-in-${idx}`}\n                                        />\n                                      )}\n                                      <div className=\"font-medium text-sm\">{item.itemName}</div>\n                                      <div className=\"text-xs text-muted-foreground\">{item.category}</div>\n                                      <div className=\"flex items-center gap-2\">\n                                        <span className=\"text-xs\">Condition:</span>\n                                        <Badge variant=\"outline\">\n                                          {item.conditionRating != null ? `${item.conditionRating}/10` : 'N/A'}\n                                        </Badge>\n                                      </div>\n                                      {item.aiAnalysis && (\n                                        <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                                          {item.aiAnalysis}\n                                        </p>\n                                      )}\n                                    </div>\n                                  ))}\n                                </div>\n                              </div>\n\n                              {/* Check-out Column */}\n                              <div>\n                                <div className=\"flex items-center gap-2 mb-3\">\n                                  <Badge variant=\"default\">Check-out</Badge>\n                                  <span className=\"text-sm text-muted-foreground\">\n                                    {format(new Date(report.createdAt?.toString() || Date.now()), 'PP')}\n                                  </span>\n                                </div>\n                                <div className=\"space-y-3\">\n                                  {itemComparisons.checkOut?.map((item, idx: number) => {\n                                    const checkInItem = itemComparisons.checkIn[idx];\n                                    const ratingChange = (item.conditionRating || 0) - (checkInItem?.conditionRating || 0);\n                                    \n                                    return (\n                                      <div \n                                        key={idx} \n                                        className=\"p-3 border rounded-md space-y-2\"\n                                        data-testid={`item-check-out-${idx}`}\n                                      >\n                                        {item.photoUrl && (\n                                          <img \n                                            src={item.photoUrl} \n                                            alt={item.itemName} \n                                            className=\"w-full h-32 object-cover rounded-md\"\n                                            data-testid={`photo-check-out-${idx}`}\n                                          />\n                                        )}\n                                        <div className=\"font-medium text-sm\">{item.itemName}</div>\n                                        <div className=\"text-xs text-muted-foreground\">{item.category}</div>\n                                        <div className=\"flex items-center gap-2\">\n                                          <span className=\"text-xs\">Condition:</span>\n                                          <Badge variant=\"outline\">\n                                            {item.conditionRating != null ? `${item.conditionRating}/10` : 'N/A'}\n                                          </Badge>\n                                          {item.conditionRating != null && checkInItem?.conditionRating != null && ratingChange !== 0 && (\n                                            <Badge \n                                              variant={ratingChange > 0 ? \"default\" : \"destructive\"}\n                                              className=\"text-xs\"\n                                            >\n                                              {ratingChange > 0 ? \"+\" : \"\"}{ratingChange}\n                                            </Badge>\n                                          )}\n                                        </div>\n                                        {item.aiAnalysis && (\n                                          <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                                            {item.aiAnalysis}\n                                          </p>\n                                        )}\n                                      </div>\n                                    );\n                                  })}\n                                </div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                )}\n              </Card>\n            );\n          })\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":19077},"server/objectAcl.ts":{"content":"// Local file ACL implementation\nimport { LocalFile } from \"./objectStorage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclPolicy {\n  owner: string;\n  visibility: \"public\" | \"private\";\n}\n\nexport async function setObjectAclPolicy(\n  objectFile: LocalFile,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  // Set custom metadata for our app's ACL logic\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\nexport async function getObjectAclPolicy(\n  objectFile: LocalFile,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  objectFile: LocalFile;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  // Public objects are always accessible for read\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  // Access control requires the user id\n  if (!userId) {\n    return false;\n  }\n\n  // The owner of the object can always access it\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  return false;\n}\n","size_bytes":1707},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"server/storage.ts":{"content":"import {\n  users,\n  adminUsers,\n  organizations,\n  contacts,\n  blocks,\n  properties,\n  inspections,\n  inspectionItems,\n  inspectionCategories,\n  inspectionTemplates,\n  inspectionTemplatePoints,\n  inspectionResponses,\n  templateCategories,\n  templateInventoryLinks,\n  inspectionEntries,\n  aiImageAnalyses,\n  complianceDocuments,\n  maintenanceRequests,\n  comparisonReports,\n  comparisonReportItems,\n  comparisonComments,\n  creditTransactions,\n  inventoryTemplates,\n  inventories,\n  inventoryItems,\n  workOrders,\n  workLogs,\n  assetInventory,\n  tags,\n  blockTags,\n  propertyTags,\n  userTags,\n  complianceDocumentTags,\n  assetInventoryTags,\n  maintenanceRequestTags,\n  contactTags,\n  dashboardPreferences,\n  tenantAssignments,\n  tenantAssignmentTags,\n  tenancyAttachments,\n  messageTemplates,\n  fixfloConfig,\n  fixfloWebhookLogs,\n  fixfloSyncState,\n  teams,\n  teamMembers,\n  teamCategories,\n  type User,\n  type UpsertUser,\n  type AdminUser,\n  type InsertAdminUser,\n  type FixfloConfig,\n  type InsertFixfloConfig,\n  type FixfloWebhookLog,\n  type InsertFixfloWebhookLog,\n  type FixfloSyncState,\n  type InsertFixfloSyncState,\n  type Organization,\n  type InsertOrganization,\n  type Contact,\n  type InsertContact,\n  type Block,\n  type InsertBlock,\n  type Property,\n  type InsertProperty,\n  type MessageTemplate,\n  type InsertMessageTemplate,\n  type Inspection,\n  type InsertInspection,\n  type InspectionItem,\n  type InsertInspectionItem,\n  type InspectionCategory,\n  type InsertInspectionCategory,\n  type InspectionTemplate,\n  type InsertInspectionTemplate,\n  type InspectionTemplatePoint,\n  type InsertInspectionTemplatePoint,\n  type InspectionResponse,\n  type InsertInspectionResponse,\n  type TemplateCategory,\n  type InsertTemplateCategory,\n  type TemplateInventoryLink,\n  type InsertTemplateInventoryLink,\n  type InspectionEntry,\n  type InsertInspectionEntry,\n  type AiImageAnalysis,\n  type InsertAiImageAnalysis,\n  type ComplianceDocument,\n  type InsertComplianceDocument,\n  type MaintenanceRequest,\n  type InsertMaintenanceRequest,\n  type ComparisonReport,\n  type InsertComparisonReport,\n  type CreditTransaction,\n  type InsertCreditTransaction,\n  type InventoryTemplate,\n  type InsertInventoryTemplate,\n  type Inventory,\n  type InsertInventory,\n  type InventoryItem,\n  type InsertInventoryItem,\n  type WorkOrder,\n  type InsertWorkOrder,\n  type WorkLog,\n  type InsertWorkLog,\n  type Team,\n  type InsertTeam,\n  type TeamMember,\n  type InsertTeamMember,\n  type TeamCategory,\n  type InsertTeamCategory,\n  type AssetInventory,\n  type InsertAssetInventory,\n  type Tag,\n  type InsertTag,\n  type DashboardPreferences,\n  type InsertDashboardPreferences,\n  type TenantAssignment,\n  type InsertTenantAssignment,\n  type TenancyAttachment,\n  type InsertTenancyAttachment,\n  plans,\n  type Plan,\n  type InsertPlan,\n  subscriptions,\n  type Subscription,\n  type InsertSubscription,\n  creditBatches,\n  type CreditBatch,\n  type InsertCreditBatch,\n  creditLedger,\n  type CreditLedger,\n  type InsertCreditLedger,\n  topupOrders,\n  type TopupOrder,\n  type InsertTopupOrder,\n  countryPricingOverrides,\n  type CountryPricingOverride,\n  type InsertCountryPricingOverride,\n  creditBundles,\n  type CreditBundle,\n  type InsertCreditBundle,\n  knowledgeBaseDocuments,\n  type KnowledgeBaseDocument,\n  type InsertKnowledgeBaseDocument,\n  chatConversations,\n  type ChatConversation,\n  type InsertChatConversation,\n  chatMessages,\n  type ChatMessage,\n  type InsertChatMessage,\n  tenantMaintenanceChats,\n  type TenantMaintenanceChat,\n  type InsertTenantMaintenanceChat,\n  tenantMaintenanceChatMessages,\n  type TenantMaintenanceChatMessage,\n  type InsertTenantMaintenanceChatMessage,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc, sql, gte, lte, ne, isNull, or } from \"drizzle-orm\";\nimport { alias } from \"drizzle-orm/pg-core\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: UpsertUser): Promise<User>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  getUsersByOrganization(organizationId: string): Promise<User[]>;\n  getUsersByOrganizationAndRole(organizationId: string, role: string): Promise<User[]>;\n  updateUser(id: string, updates: Partial<UpsertUser>): Promise<User>;\n  updateUserRole(id: string, role: string): Promise<User>;\n  updatePassword(id: string, hashedPassword: string): Promise<User>;\n  setResetToken(id: string, token: string, expiry: Date): Promise<User>;\n  clearResetToken(id: string): Promise<User>;\n  \n  // Organization operations\n  createOrganization(org: InsertOrganization): Promise<Organization>;\n  getOrganization(id: string): Promise<Organization | undefined>;\n  getOrganizationsByNormalizedEmail(email: string): Promise<Array<{ organizationId: string; organizationName: string; userRole: string }>>;\n  updateOrganization(id: string, updates: Partial<InsertOrganization>): Promise<Organization>;\n  updateOrganizationCredits(id: string, credits: number): Promise<Organization>;\n  updateOrganizationStripe(id: string, customerId: string, status: string): Promise<Organization>;\n  deductCredit(organizationId: string, amount: number, description: string): Promise<Organization>;\n  \n  // Contact operations\n  createContact(contact: InsertContact & { organizationId: string }): Promise<Contact>;\n  getContactsByOrganization(organizationId: string): Promise<Contact[]>;\n  getContact(id: string): Promise<Contact | undefined>;\n  updateContact(id: string, updates: Partial<InsertContact>): Promise<Contact>;\n  deleteContact(id: string): Promise<void>;\n  \n  // Property operations\n  createProperty(property: InsertProperty): Promise<Property>;\n  getPropertiesByOrganization(organizationId: string): Promise<Property[]>;\n  getPropertiesByBlock(blockId: string): Promise<Property[]>;\n  getProperty(id: string): Promise<Property | undefined>;\n  updateProperty(id: string, updates: Partial<InsertProperty>): Promise<Property>;\n  \n  // Inspection operations (Inspections can be on blocks OR properties)\n  createInspection(inspection: InsertInspection): Promise<Inspection>;\n  getInspectionsByProperty(propertyId: string): Promise<Inspection[]>;\n  getInspectionsByBlock(blockId: string): Promise<Inspection[]>;\n  getInspectionsByInspector(inspectorId: string): Promise<any[]>; // Returns inspections with property/block\n  getInspectionsByOrganization(organizationId: string): Promise<any[]>; // Returns inspections with property/block\n  getInspection(id: string): Promise<Inspection | undefined>;\n  updateInspectionStatus(id: string, status: string, completedDate?: Date): Promise<Inspection>;\n  updateInspection(id: string, updates: Partial<InsertInspection>): Promise<Inspection>;\n  \n  // Inspection Category operations\n  createInspectionCategory(category: InsertInspectionCategory): Promise<InspectionCategory>;\n  getInspectionCategories(organizationId: string): Promise<InspectionCategory[]>;\n  getInspectionCategory(id: string): Promise<InspectionCategory | undefined>;\n  updateInspectionCategory(id: string, updates: Partial<InsertInspectionCategory>): Promise<InspectionCategory>;\n  deleteInspectionCategory(id: string): Promise<void>;\n  \n  // Inspection Item operations\n  createInspectionItem(item: InsertInspectionItem): Promise<InspectionItem>;\n  getInspectionItems(inspectionId: string): Promise<InspectionItem[]>;\n  updateInspectionItemAI(id: string, aiAnalysis: string): Promise<InspectionItem>;\n  \n  // Compliance operations\n  createComplianceDocument(doc: InsertComplianceDocument): Promise<ComplianceDocument>;\n  getComplianceDocuments(organizationId: string): Promise<ComplianceDocument[]>;\n  updateComplianceStatus(id: string, status: string): Promise<ComplianceDocument>;\n  getExpiringCompliance(organizationId: string, daysAhead: number): Promise<ComplianceDocument[]>;\n  \n  // Maintenance operations\n  createMaintenanceRequest(request: InsertMaintenanceRequest): Promise<MaintenanceRequest>;\n  getMaintenanceRequestsByProperty(propertyId: string): Promise<MaintenanceRequest[]>;\n  getMaintenanceByOrganization(organizationId: string): Promise<any[]>;\n  updateMaintenanceStatus(id: string, status: string, assignedTo?: string): Promise<MaintenanceRequest>;\n  updateMaintenanceRequest(id: string, updates: Partial<InsertMaintenanceRequest>): Promise<MaintenanceRequest>;\n  \n  // Comparison Report operations\n  createComparisonReport(report: InsertComparisonReport): Promise<ComparisonReport>;\n  getComparisonReportsByProperty(propertyId: string): Promise<ComparisonReport[]>;\n  getComparisonReportsByOrganization(organizationId: string): Promise<ComparisonReport[]>;\n  getComparisonReport(id: string): Promise<ComparisonReport | undefined>;\n  updateComparisonReport(id: string, updates: Partial<InsertComparisonReport>): Promise<ComparisonReport>;\n  createComparisonReportItem(item: any): Promise<any>;\n  getComparisonReportItems(reportId: string): Promise<any[]>;\n  createComparisonComment(comment: any): Promise<any>;\n  getComparisonComments(reportId: string): Promise<any[]>;\n  \n  // Credit Transaction operations\n  createCreditTransaction(transaction: InsertCreditTransaction): Promise<CreditTransaction>;\n  getCreditTransactions(organizationId: string): Promise<CreditTransaction[]>;\n\n  // Subscription Plan operations\n  getPlans(): Promise<Plan[]>;\n  getActivePlans(): Promise<Plan[]>;\n  getPlan(id: string): Promise<Plan | undefined>;\n  getPlanByCode(code: string): Promise<Plan | undefined>;\n  createPlan(plan: InsertPlan): Promise<Plan>;\n  updatePlan(id: string, updates: Partial<InsertPlan>): Promise<Plan>;\n\n  // Country Pricing Override operations\n  getCountryPricingOverride(countryCode: string, planId: string): Promise<CountryPricingOverride | undefined>;\n  getCountryPricingOverridesByCountry(countryCode: string): Promise<CountryPricingOverride[]>;\n  getAllCountryPricingOverrides(): Promise<CountryPricingOverride[]>;\n  createCountryPricingOverride(override: InsertCountryPricingOverride): Promise<CountryPricingOverride>;\n  updateCountryPricingOverride(id: string, updates: Partial<InsertCountryPricingOverride>): Promise<CountryPricingOverride>;\n  deleteCountryPricingOverride(id: string): Promise<void>;\n\n  // Credit Bundle operations\n  getCreditBundles(): Promise<CreditBundle[]>;\n  getActiveCreditBundles(): Promise<CreditBundle[]>;\n  getCreditBundle(id: string): Promise<CreditBundle | undefined>;\n  createCreditBundle(bundle: InsertCreditBundle): Promise<CreditBundle>;\n  updateCreditBundle(id: string, updates: Partial<InsertCreditBundle>): Promise<CreditBundle>;\n  deleteCreditBundle(id: string): Promise<void>;\n\n  // Subscription operations\n  createSubscription(subscription: InsertSubscription): Promise<Subscription>;\n  getSubscription(id: string): Promise<Subscription | undefined>;\n  getSubscriptionByOrganization(organizationId: string): Promise<Subscription | undefined>;\n  getSubscriptionByStripeId(stripeSubscriptionId: string): Promise<Subscription | undefined>;\n  updateSubscription(id: string, updates: Partial<InsertSubscription>): Promise<Subscription>;\n  cancelSubscription(id: string): Promise<Subscription>;\n\n  // Credit Batch operations\n  createCreditBatch(batch: InsertCreditBatch): Promise<CreditBatch>;\n  getCreditBatch(id: string): Promise<CreditBatch | undefined>;\n  getCreditBatchesByOrganization(organizationId: string): Promise<CreditBatch[]>;\n  getAvailableCreditBatches(organizationId: string): Promise<CreditBatch[]>;\n  updateCreditBatch(id: string, updates: Partial<InsertCreditBatch>): Promise<CreditBatch>;\n  expireCreditBatch(id: string): Promise<CreditBatch>;\n\n  // Credit Ledger operations\n  createCreditLedgerEntry(entry: InsertCreditLedger): Promise<CreditLedger>;\n  getCreditLedgerByOrganization(organizationId: string, limit?: number): Promise<CreditLedger[]>;\n  getCreditBalance(organizationId: string): Promise<{ total: number; rolled: number; current: number; expiresOn: Date | null }>;\n\n  // Top-up Order operations\n  createTopupOrder(order: InsertTopupOrder): Promise<TopupOrder>;\n  getTopupOrder(id: string): Promise<TopupOrder | undefined>;\n  getTopupOrdersByOrganization(organizationId: string): Promise<TopupOrder[]>;\n  updateTopupOrder(id: string, updates: Partial<InsertTopupOrder>): Promise<TopupOrder>;\n\n  // Block operations\n  createBlock(block: InsertBlock & { organizationId: string }): Promise<Block>;\n  getBlocksByOrganization(organizationId: string): Promise<Block[]>;\n  getBlocksWithStats(organizationId: string): Promise<any[]>;\n  getBlock(id: string): Promise<Block | undefined>;\n  updateBlock(id: string, updates: Partial<InsertBlock>): Promise<Block>;\n  deleteBlock(id: string): Promise<void>;\n  getTenantAssignmentsByBlock(blockId: string): Promise<any[]>;\n  getBlockTenantStats(blockId: string): Promise<{ totalUnits: number; occupiedUnits: number; occupancyRate: number; totalMonthlyRent: number }>;\n  \n  // Tenant Assignment operations\n  createTenantAssignment(assignment: InsertTenantAssignment & { organizationId: string }): Promise<TenantAssignment>;\n  getTenantAssignment(id: string): Promise<TenantAssignment | undefined>;\n  updateTenantAssignment(id: string, updates: Partial<InsertTenantAssignment>): Promise<TenantAssignment>;\n  deleteTenantAssignment(id: string): Promise<void>;\n  getTenantAssignmentsByOrganization(organizationId: string): Promise<any[]>;\n  getTenantAssignmentsByProperty(propertyId: string, organizationId: string): Promise<any[]>;\n  getTenantAssignmentTags(tenantAssignmentId: string, organizationId: string): Promise<any[]>;\n  updateTenantAssignmentTags(tenantAssignmentId: string, tagIds: string[], organizationId: string): Promise<void>;\n  \n  // Tenancy Attachment operations\n  createTenancyAttachment(attachment: InsertTenancyAttachment & { organizationId: string }): Promise<TenancyAttachment>;\n  getTenancyAttachment(id: string, organizationId: string): Promise<TenancyAttachment | undefined>;\n  getTenancyAttachments(tenantAssignmentId: string, organizationId: string): Promise<TenancyAttachment[]>;\n  deleteTenancyAttachment(id: string, organizationId: string): Promise<void>;\n\n  // Inventory Template operations\n  createInventoryTemplate(template: InsertInventoryTemplate): Promise<InventoryTemplate>;\n  getInventoryTemplatesByOrganization(organizationId: string): Promise<InventoryTemplate[]>;\n  getInventoryTemplate(id: string): Promise<InventoryTemplate | undefined>;\n  updateInventoryTemplate(id: string, updates: Partial<InsertInventoryTemplate>): Promise<InventoryTemplate>;\n  deleteInventoryTemplate(id: string): Promise<void>;\n\n  // Inventory operations\n  createInventory(inventory: InsertInventory): Promise<Inventory>;\n  getInventoriesByProperty(propertyId: string): Promise<Inventory[]>;\n  getInventoriesByOrganization(organizationId: string): Promise<Inventory[]>;\n  getInventory(id: string): Promise<Inventory | undefined>;\n\n  // Inventory Item operations\n  createInventoryItem(item: InsertInventoryItem): Promise<InventoryItem>;\n  getInventoryItems(inventoryId: string): Promise<InventoryItem[]>;\n  updateInventoryItem(id: string, updates: Partial<InsertInventoryItem>): Promise<InventoryItem>;\n\n  // Work Order operations\n  createWorkOrder(workOrder: InsertWorkOrder): Promise<WorkOrder>;\n  getWorkOrdersByOrganization(organizationId: string): Promise<any[]>; // Returns with related data\n  getWorkOrdersByContractor(contractorId: string): Promise<any[]>; // Returns with related data\n  getWorkOrder(id: string): Promise<WorkOrder | undefined>;\n  updateWorkOrderStatus(id: string, status: string, completedAt?: Date): Promise<WorkOrder>;\n  updateWorkOrderCost(id: string, costActual: number, variationNotes?: string): Promise<WorkOrder>;\n\n  // Work Log operations\n  createWorkLog(log: InsertWorkLog): Promise<WorkLog>;\n  getWorkLogs(workOrderId: string): Promise<WorkLog[]>;\n\n  // Team operations\n  createTeam(team: InsertTeam & { organizationId: string }): Promise<Team>;\n  getTeamsByOrganization(organizationId: string): Promise<any[]>; // Returns with member count\n  getTeam(id: string): Promise<Team | undefined>;\n  updateTeam(id: string, updates: Partial<InsertTeam>): Promise<Team>;\n  deleteTeam(id: string): Promise<void>;\n  \n  // Team Member operations\n  addTeamMember(member: InsertTeamMember): Promise<TeamMember>;\n  getTeamMembers(teamId: string): Promise<any[]>; // Returns with user/contact details\n  removeTeamMember(id: string): Promise<void>;\n  \n  // Team Category operations\n  addTeamCategory(category: InsertTeamCategory): Promise<TeamCategory>;\n  getTeamCategories(teamId: string): Promise<TeamCategory[]>;\n  removeTeamCategory(id: string): Promise<void>;\n  getTeamByCategory(organizationId: string, category: string): Promise<Team | undefined>;\n\n  // Asset Inventory operations\n  createAssetInventory(asset: InsertAssetInventory): Promise<AssetInventory>;\n  getAssetInventoryByOrganization(organizationId: string): Promise<AssetInventory[]>;\n  getAssetInventoryByProperty(propertyId: string): Promise<AssetInventory[]>;\n  getAssetInventoryByBlock(blockId: string): Promise<AssetInventory[]>;\n  getAssetInventory(id: string): Promise<AssetInventory | undefined>;\n  updateAssetInventory(id: string, updates: Partial<InsertAssetInventory>): Promise<AssetInventory>;\n  deleteAssetInventory(id: string): Promise<void>;\n\n  // Inspection Template operations\n  createInspectionTemplate(template: InsertInspectionTemplate): Promise<InspectionTemplate>;\n  getInspectionTemplatesByOrganization(organizationId: string): Promise<InspectionTemplate[]>;\n  getInspectionTemplate(id: string): Promise<InspectionTemplate | undefined>;\n  updateInspectionTemplate(id: string, updates: Partial<InsertInspectionTemplate>): Promise<InspectionTemplate>;\n  deleteInspectionTemplate(id: string): Promise<void>;\n\n  // Inspection Template Point operations\n  createInspectionTemplatePoint(point: InsertInspectionTemplatePoint): Promise<InspectionTemplatePoint>;\n  getInspectionTemplatePoints(templateId: string): Promise<InspectionTemplatePoint[]>;\n  getInspectionTemplatePoint(id: string): Promise<InspectionTemplatePoint | undefined>;\n  updateInspectionTemplatePoint(id: string, updates: Partial<InsertInspectionTemplatePoint>): Promise<InspectionTemplatePoint>;\n  deleteInspectionTemplatePoint(id: string): Promise<void>;\n\n  // Inspection Response operations (Legacy - kept for backward compatibility)\n  createInspectionResponse(response: InsertInspectionResponse): Promise<InspectionResponse>;\n  getInspectionResponses(inspectionId: string): Promise<InspectionResponse[]>;\n  getInspectionResponse(id: string): Promise<InspectionResponse | undefined>;\n  updateInspectionResponse(id: string, updates: Partial<InsertInspectionResponse>): Promise<InspectionResponse>;\n  deleteInspectionResponse(id: string): Promise<void>;\n\n  // Template Category operations\n  createTemplateCategory(category: InsertTemplateCategory): Promise<TemplateCategory>;\n  getTemplateCategoriesByOrganization(organizationId: string): Promise<TemplateCategory[]>;\n  getTemplateCategory(id: string): Promise<TemplateCategory | undefined>;\n  updateTemplateCategory(id: string, updates: Partial<InsertTemplateCategory>): Promise<TemplateCategory>;\n  deleteTemplateCategory(id: string): Promise<void>;\n\n  // Template Inventory Link operations\n  createTemplateInventoryLink(link: InsertTemplateInventoryLink): Promise<TemplateInventoryLink>;\n  getTemplateInventoryLinks(templateId: string): Promise<TemplateInventoryLink[]>;\n  deleteTemplateInventoryLink(id: string): Promise<void>;\n\n  // Inspection Entry operations (New JSON-based system)\n  createInspectionEntry(entry: InsertInspectionEntry): Promise<InspectionEntry>;\n  createInspectionEntriesBatch(entries: InsertInspectionEntry[]): Promise<InspectionEntry[]>;\n  getInspectionEntries(inspectionId: string): Promise<InspectionEntry[]>;\n  getInspectionEntry(id: string): Promise<InspectionEntry | undefined>;\n  updateInspectionEntry(id: string, updates: Partial<InsertInspectionEntry>): Promise<InspectionEntry>;\n  deleteInspectionEntry(id: string): Promise<void>;\n  getEntriesByOfflineId(offlineId: string): Promise<InspectionEntry | undefined>;\n\n  // AI Image Analysis operations\n  createAiImageAnalysis(analysis: InsertAiImageAnalysis): Promise<AiImageAnalysis>;\n  getAiImageAnalysesByInspection(inspectionId: string): Promise<AiImageAnalysis[]>;\n  getAiImageAnalysesByEntry(entryId: string): Promise<AiImageAnalysis[]>;\n  getAiImageAnalysis(id: string): Promise<AiImageAnalysis | undefined>;\n\n  // Inspection Snapshot operations\n  updateInspectionSnapshots(id: string, templateSnapshot: any, inventorySnapshot: any, version: number): Promise<Inspection>;\n  getInspectionWithSnapshots(id: string): Promise<Inspection | undefined>;\n\n  // Tag operations\n  createTag(tag: InsertTag): Promise<Tag>;\n  getTagsByOrganization(organizationId: string): Promise<Tag[]>;\n  getTag(id: string): Promise<Tag | undefined>;\n  updateTag(id: string, updates: Partial<InsertTag>): Promise<Tag>;\n  deleteTag(id: string): Promise<void>;\n  \n  // Tag entity association operations\n  addTagToBlock(blockId: string, tagId: string): Promise<void>;\n  removeTagFromBlock(blockId: string, tagId: string): Promise<void>;\n  getTagsForBlock(blockId: string): Promise<Tag[]>;\n  \n  addTagToProperty(propertyId: string, tagId: string): Promise<void>;\n  removeTagFromProperty(propertyId: string, tagId: string): Promise<void>;\n  getTagsForProperty(propertyId: string): Promise<Tag[]>;\n  \n  addTagToUser(userId: string, tagId: string): Promise<void>;\n  removeTagFromUser(userId: string, tagId: string): Promise<void>;\n  getTagsForUser(userId: string): Promise<Tag[]>;\n  \n  addTagToComplianceDocument(complianceDocumentId: string, tagId: string): Promise<void>;\n  removeTagFromComplianceDocument(complianceDocumentId: string, tagId: string): Promise<void>;\n  getTagsForComplianceDocument(complianceDocumentId: string): Promise<Tag[]>;\n  \n  addTagToAssetInventory(assetInventoryId: string, tagId: string): Promise<void>;\n  removeTagFromAssetInventory(assetInventoryId: string, tagId: string): Promise<void>;\n  getTagsForAssetInventory(assetInventoryId: string): Promise<Tag[]>;\n  \n  addTagToMaintenanceRequest(maintenanceRequestId: string, tagId: string): Promise<void>;\n  removeTagFromMaintenanceRequest(maintenanceRequestId: string, tagId: string): Promise<void>;\n  getTagsForMaintenanceRequest(maintenanceRequestId: string): Promise<Tag[]>;\n  \n  // Tag search operations\n  searchByTags(organizationId: string, tagIds: string[]): Promise<{\n    blocks: any[];\n    properties: any[];\n    users: any[];\n    complianceDocuments: any[];\n    assetInventory: any[];\n    maintenanceRequests: any[];\n  }>;\n  \n  // Dashboard preferences operations\n  getDashboardPreferences(userId: string): Promise<any | undefined>;\n  updateDashboardPreferences(userId: string, enabledPanels: string[]): Promise<any>;\n\n  // Admin operations\n  getAdminByEmail(email: string): Promise<AdminUser | undefined>;\n  getAllAdmins(): Promise<AdminUser[]>;\n  createAdmin(admin: InsertAdminUser): Promise<AdminUser>;\n  updateAdmin(id: string, updates: Partial<AdminUser>): Promise<AdminUser>;\n  deleteAdmin(id: string): Promise<void>;\n  getAllOrganizationsWithOwners(): Promise<any[]>;\n  getOrganizationWithOwner(id: string): Promise<any | undefined>;\n\n  // Message Template operations\n  createMessageTemplate(template: any): Promise<any>;\n  getMessageTemplatesByOrganization(organizationId: string): Promise<any[]>;\n  getMessageTemplate(id: string): Promise<any | undefined>;\n  updateMessageTemplate(id: string, updates: any): Promise<any>;\n  deleteMessageTemplate(id: string): Promise<void>;\n  getBlockTenantsEmails(blockId: string, organizationId: string): Promise<{email: string; firstName?: string; lastName?: string;}[]>;\n  \n  // Fixflo Integration operations\n  getFixfloConfig(organizationId: string): Promise<FixfloConfig | undefined>;\n  upsertFixfloConfig(config: InsertFixfloConfig): Promise<FixfloConfig>;\n  updateFixfloHealthCheck(organizationId: string, updates: { lastHealthCheck: Date; healthCheckStatus: string; lastError: string | null; }): Promise<void>;\n  getFixfloSyncStates(organizationId: string): Promise<FixfloSyncState[]>;\n  upsertFixfloSyncState(syncState: InsertFixfloSyncState): Promise<FixfloSyncState>;\n  getFixfloWebhookLogs(organizationId: string, limit?: number): Promise<FixfloWebhookLog[]>;\n  createFixfloWebhookLog(log: InsertFixfloWebhookLog): Promise<FixfloWebhookLog>;\n  updateFixfloWebhookLog(id: string, updates: Partial<FixfloWebhookLog>): Promise<void>;\n\n  // Knowledge Base operations (for AI chatbot)\n  createKnowledgeBaseDocument(doc: InsertKnowledgeBaseDocument): Promise<KnowledgeBaseDocument>;\n  getKnowledgeBaseDocuments(activeOnly?: boolean): Promise<KnowledgeBaseDocument[]>;\n  getKnowledgeBaseDocument(id: string): Promise<KnowledgeBaseDocument | undefined>;\n  updateKnowledgeBaseDocument(id: string, updates: Partial<InsertKnowledgeBaseDocument>): Promise<KnowledgeBaseDocument>;\n  deleteKnowledgeBaseDocument(id: string): Promise<void>;\n  searchKnowledgeBase(query: string): Promise<KnowledgeBaseDocument[]>;\n\n  // Chat operations (for AI chatbot)\n  createChatConversation(conversation: InsertChatConversation): Promise<ChatConversation>;\n  getChatConversationsByUser(userId: string): Promise<ChatConversation[]>;\n  getChatConversation(id: string): Promise<ChatConversation | undefined>;\n  updateChatConversation(id: string, updates: Partial<InsertChatConversation>): Promise<ChatConversation>;\n  createChatMessage(message: InsertChatMessage): Promise<ChatMessage>;\n  getChatMessages(conversationId: string): Promise<ChatMessage[]>;\n\n  // Tenant operations\n  getTenancyByTenantId(tenantId: string): Promise<any>;\n  getTenantMaintenanceChats(tenantId: string): Promise<any[]>;\n  getMaintenanceChatById(chatId: string): Promise<any>;\n  getTenantMaintenanceChatMessages(chatId: string): Promise<any[]>;\n  createTenantMaintenanceChat(chat: any): Promise<any>;\n  createTenantMaintenanceChatMessage(message: any): Promise<any>;\n  updateTenantMaintenanceChat(chatId: string, updates: any): Promise<any>;\n  getMaintenanceRequestsByReporter(reporterId: string): Promise<MaintenanceRequest[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    // Use case-insensitive comparison for email lookup, ordered by creation date for determinism\n    const results = await db.select().from(users)\n      .where(sql`LOWER(${users.email}) = LOWER(${email})`)\n      .orderBy(users.createdAt);\n    \n    if (results.length > 1) {\n      console.warn(`[getUserByEmail] Multiple users found for normalized email ${email.toLowerCase()}: returning oldest (${results.length} total)`);\n    }\n    \n    return results[0];\n  }\n\n  async createUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db.insert(users).values(userData).returning();\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async getUsersByOrganization(organizationId: string): Promise<User[]> {\n    return await db\n      .select()\n      .from(users)\n      .where(eq(users.organizationId, organizationId))\n      .orderBy(users.role, users.email);\n  }\n\n  async getUsersByOrganizationAndRole(organizationId: string, role: string): Promise<User[]> {\n    return await db\n      .select()\n      .from(users)\n      .where(and(eq(users.organizationId, organizationId), eq(users.role, role as any)));\n  }\n\n  async updateUser(id: string, updates: Partial<UpsertUser>): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updateUserRole(id: string, role: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ role: role as any, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updatePassword(id: string, hashedPassword: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ password: hashedPassword, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async setResetToken(id: string, token: string, expiry: Date): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ resetToken: token, resetTokenExpiry: expiry, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async clearResetToken(id: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ resetToken: null, resetTokenExpiry: null, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  // Organization operations\n  async createOrganization(orgData: InsertOrganization): Promise<Organization> {\n    const [org] = await db.insert(organizations).values(orgData).returning();\n    return org;\n  }\n\n  async getOrganization(id: string): Promise<Organization | undefined> {\n    const [org] = await db.select().from(organizations).where(eq(organizations.id, id));\n    return org;\n  }\n\n  async getOrganizationsByNormalizedEmail(email: string): Promise<Array<{ organizationId: string; organizationName: string; userRole: string }>> {\n    const results = await db\n      .select({\n        organizationId: users.organizationId,\n        organizationName: organizations.name,\n        userRole: users.role,\n      })\n      .from(users)\n      .innerJoin(organizations, eq(users.organizationId, organizations.id))\n      .where(sql`LOWER(${users.email}) = LOWER(${email})`)\n      .orderBy(users.createdAt);\n    \n    // Filter out any null organizationIds and map to expected type\n    return results\n      .filter(r => r.organizationId !== null)\n      .map(r => ({\n        organizationId: r.organizationId!,\n        organizationName: r.organizationName,\n        userRole: r.userRole as string,\n      }));\n  }\n\n  async updateOrganizationCredits(id: string, credits: number): Promise<Organization> {\n    const [org] = await db\n      .update(organizations)\n      .set({ creditsRemaining: credits, updatedAt: new Date() })\n      .where(eq(organizations.id, id))\n      .returning();\n    return org;\n  }\n\n  async updateOrganizationStripe(id: string, customerId: string, status: string): Promise<Organization> {\n    const [org] = await db\n      .update(organizations)\n      .set({ \n        stripeCustomerId: customerId, \n        subscriptionStatus: status as any,\n        updatedAt: new Date() \n      })\n      .where(eq(organizations.id, id))\n      .returning();\n    return org;\n  }\n\n  async updateOrganization(id: string, updates: Partial<InsertOrganization>): Promise<Organization> {\n    const [org] = await db\n      .update(organizations)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(organizations.id, id))\n      .returning();\n    return org;\n  }\n\n  async deductCredit(organizationId: string, amount: number, description: string): Promise<Organization> {\n    const org = await this.getOrganization(organizationId);\n    if (!org) {\n      throw new Error(\"Organization not found\");\n    }\n\n    const currentCredits = org.creditsRemaining ?? 0;\n    if (currentCredits < amount) {\n      throw new Error(\"Insufficient credits\");\n    }\n\n    const newCredits = currentCredits - amount;\n    \n    await this.createCreditTransaction({\n      organizationId,\n      amount: -amount,\n      type: \"usage\",\n      description,\n    });\n\n    return await this.updateOrganizationCredits(organizationId, newCredits);\n  }\n\n  // Contact operations\n  async createContact(contactData: InsertContact & { organizationId: string }): Promise<Contact> {\n    const [contact] = await db.insert(contacts).values(contactData).returning();\n    return contact;\n  }\n\n  async getContactsByOrganization(organizationId: string): Promise<Contact[]> {\n    return await db\n      .select()\n      .from(contacts)\n      .where(eq(contacts.organizationId, organizationId))\n      .orderBy(contacts.lastName, contacts.firstName);\n  }\n\n  async getContact(id: string): Promise<Contact | undefined> {\n    const [contact] = await db.select().from(contacts).where(eq(contacts.id, id));\n    return contact;\n  }\n\n  async updateContact(id: string, updates: Partial<InsertContact>): Promise<Contact> {\n    const [contact] = await db\n      .update(contacts)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(contacts.id, id))\n      .returning();\n    return contact;\n  }\n\n  async deleteContact(id: string): Promise<void> {\n    await db.delete(contacts).where(eq(contacts.id, id));\n  }\n\n  // Property operations\n  async createProperty(propertyData: InsertProperty): Promise<Property> {\n    const [property] = await db.insert(properties).values(propertyData).returning();\n    return property;\n  }\n\n  async getPropertiesByOrganization(organizationId: string): Promise<Property[]> {\n    return await db\n      .select()\n      .from(properties)\n      .where(eq(properties.organizationId, organizationId))\n      .orderBy(desc(properties.createdAt));\n  }\n\n  async getPropertiesWithStatsByBlock(blockId: string): Promise<any[]> {\n    // Get all properties for this block (properties ARE units in new schema)\n    const blockProperties = await db\n      .select()\n      .from(properties)\n      .where(eq(properties.blockId, blockId));\n\n    if (blockProperties.length === 0) {\n      return [];\n    }\n\n    const propertyIds = blockProperties.map(p => p.id);\n\n    // Batch fetch all inspections for these properties\n    let allInspections: any[] = [];\n    if (propertyIds.length > 0) {\n      allInspections = await db\n        .select()\n        .from(inspections)\n        .where(sql`${inspections.propertyId} IN (${sql.join(propertyIds.map(id => sql`${id}`), sql`, `)})`);\n    }\n\n    // Group inspections by property\n    const inspectionsByProperty = new Map<string, typeof allInspections>();\n    allInspections.forEach(inspection => {\n      if (inspection.propertyId && !inspectionsByProperty.has(inspection.propertyId)) {\n        inspectionsByProperty.set(inspection.propertyId, []);\n      }\n      if (inspection.propertyId) {\n        inspectionsByProperty.get(inspection.propertyId)!.push(inspection);\n      }\n    });\n\n    // Calculate date ranges once\n    const now = new Date();\n    const thirtyDaysFromNow = new Date();\n    thirtyDaysFromNow.setDate(now.getDate() + 30);\n    const ninetyDaysAgo = new Date();\n    ninetyDaysAgo.setDate(now.getDate() - 90);\n\n    // Build stats for each property\n    const propertiesWithStats = blockProperties.map(property => {\n      // Get all inspections for this property\n      const propertyInspections = inspectionsByProperty.get(property.id) || [];\n\n      // Count inspections due in next 30 days\n      const inspectionsDue = propertyInspections.filter(insp => {\n        const scheduledDate = new Date(insp.scheduledDate);\n        return scheduledDate >= now && \n               scheduledDate <= thirtyDaysFromNow && \n               insp.status !== 'completed';\n      }).length;\n\n      // Count overdue inspections\n      const inspectionsOverdue = propertyInspections.filter(insp => {\n        const scheduledDate = new Date(insp.scheduledDate);\n        return scheduledDate < now && insp.status !== 'completed';\n      }).length;\n\n      // Calculate compliance rate (has recent completed inspection)\n      let complianceRate = 0;\n      let complianceStatus = 'No data';\n      const hasRecentInspection = propertyInspections.some(insp => {\n        const scheduledDate = new Date(insp.scheduledDate);\n        return scheduledDate >= ninetyDaysAgo && insp.status === 'completed';\n      });\n      complianceRate = hasRecentInspection ? 100 : 0;\n      complianceStatus = hasRecentInspection ? 'Compliant' : 'Needs inspection';\n\n      return {\n        ...property,\n        stats: {\n          complianceRate,\n          complianceStatus,\n          inspectionsDue,\n          inspectionsOverdue,\n        },\n      };\n    });\n\n    return propertiesWithStats;\n  }\n\n  async getProperty(id: string): Promise<Property | undefined> {\n    const [property] = await db.select().from(properties).where(eq(properties.id, id));\n    return property;\n  }\n\n  async getPropertiesByBlock(blockId: string): Promise<Property[]> {\n    return await db\n      .select()\n      .from(properties)\n      .where(eq(properties.blockId, blockId))\n      .orderBy(properties.name);\n  }\n\n  async updateProperty(id: string, updates: Partial<InsertProperty>): Promise<Property> {\n    const [property] = await db\n      .update(properties)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(properties.id, id))\n      .returning();\n    return property;\n  }\n\n  // Inspection operations\n  async createInspection(inspectionData: InsertInspection): Promise<Inspection> {\n    const [inspection] = await db.insert(inspections).values(inspectionData).returning();\n    return inspection;\n  }\n\n  async getInspectionsByProperty(propertyId: string): Promise<Inspection[]> {\n    return await db\n      .select()\n      .from(inspections)\n      .where(eq(inspections.propertyId, propertyId))\n      .orderBy(desc(inspections.scheduledDate));\n  }\n\n  async getInspectionsByBlock(blockId: string): Promise<Inspection[]> {\n    return await db\n      .select()\n      .from(inspections)\n      .where(eq(inspections.blockId, blockId))\n      .orderBy(desc(inspections.scheduledDate));\n  }\n\n  async getInspectionsByInspector(inspectorId: string): Promise<any[]> {\n    const results = await db\n      .select({\n        inspection: inspections,\n        property: properties,\n        block: blocks,\n        clerk: users,\n      })\n      .from(inspections)\n      .leftJoin(properties, eq(inspections.propertyId, properties.id))\n      .leftJoin(blocks, eq(inspections.blockId, blocks.id))\n      .leftJoin(users, eq(inspections.inspectorId, users.id))\n      .where(eq(inspections.inspectorId, inspectorId))\n      .orderBy(desc(inspections.scheduledDate));\n    \n    // Flatten the structure to match frontend expectations\n    return results.map(r => ({\n      ...r.inspection,\n      property: r.property,\n      block: r.block,\n      clerk: r.clerk,\n    }));\n  }\n\n  async getInspectionsByOrganization(organizationId: string): Promise<any[]> {\n    // Get all inspections for properties in this organization\n    const propertyResults = await db\n      .select({\n        inspection: inspections,\n        property: properties,\n        clerk: users,\n      })\n      .from(inspections)\n      .innerJoin(properties, eq(inspections.propertyId, properties.id))\n      .leftJoin(users, eq(inspections.inspectorId, users.id))\n      .where(eq(properties.organizationId, organizationId))\n      .orderBy(desc(inspections.scheduledDate));\n    \n    // Get all inspections for blocks in this organization\n    const blockResults = await db\n      .select({\n        inspection: inspections,\n        block: blocks,\n        clerk: users,\n      })\n      .from(inspections)\n      .innerJoin(blocks, eq(inspections.blockId, blocks.id))\n      .leftJoin(users, eq(inspections.inspectorId, users.id))\n      .where(eq(blocks.organizationId, organizationId))\n      .orderBy(desc(inspections.scheduledDate));\n    \n    // Combine and flatten the structure\n    const combined = [\n      ...propertyResults.map(r => ({\n        ...r.inspection,\n        property: r.property,\n        block: null,\n        clerk: r.clerk,\n      })),\n      ...blockResults.map(r => ({\n        ...r.inspection,\n        property: null,\n        block: r.block,\n        clerk: r.clerk,\n      })),\n    ];\n    \n    // Sort by scheduled date\n    return combined.sort((a, b) => {\n      const dateA = new Date(a.scheduledDate || 0).getTime();\n      const dateB = new Date(b.scheduledDate || 0).getTime();\n      return dateB - dateA;\n    });\n  }\n\n  async getInspection(id: string): Promise<Inspection | undefined> {\n    const [inspection] = await db.select().from(inspections).where(eq(inspections.id, id));\n    return inspection;\n  }\n\n  async updateInspectionStatus(id: string, status: string, completedDate?: Date): Promise<Inspection> {\n    const [inspection] = await db\n      .update(inspections)\n      .set({ \n        status: status as any, \n        completedDate: completedDate || new Date(),\n        updatedAt: new Date() \n      })\n      .where(eq(inspections.id, id))\n      .returning();\n    return inspection;\n  }\n\n  async updateInspection(id: string, updates: Partial<InsertInspection>): Promise<Inspection> {\n    const [inspection] = await db\n      .update(inspections)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inspections.id, id))\n      .returning();\n    \n    if (!inspection) {\n      throw new Error(\"Inspection not found\");\n    }\n    \n    return inspection;\n  }\n\n  // Inspection Item operations\n  async createInspectionItem(itemData: InsertInspectionItem): Promise<InspectionItem> {\n    const [item] = await db.insert(inspectionItems).values(itemData).returning();\n    return item;\n  }\n\n  async getInspectionItems(inspectionId: string): Promise<InspectionItem[]> {\n    return await db\n      .select()\n      .from(inspectionItems)\n      .where(eq(inspectionItems.inspectionId, inspectionId))\n      .orderBy(inspectionItems.category, inspectionItems.itemName);\n  }\n\n  async getInspectionItem(id: string): Promise<InspectionItem | undefined> {\n    const [item] = await db.select().from(inspectionItems).where(eq(inspectionItems.id, id));\n    return item;\n  }\n\n  async updateInspectionItemAI(id: string, aiAnalysis: string): Promise<InspectionItem> {\n    const [item] = await db\n      .update(inspectionItems)\n      .set({ aiAnalysis })\n      .where(eq(inspectionItems.id, id))\n      .returning();\n    return item;\n  }\n\n  // Compliance operations\n  async createComplianceDocument(docData: InsertComplianceDocument): Promise<ComplianceDocument> {\n    const [doc] = await db.insert(complianceDocuments).values(docData).returning();\n    return doc;\n  }\n\n  async getComplianceDocuments(organizationId: string): Promise<ComplianceDocument[]> {\n    return await db\n      .select()\n      .from(complianceDocuments)\n      .where(eq(complianceDocuments.organizationId, organizationId))\n      .orderBy(desc(complianceDocuments.expiryDate));\n  }\n\n  async updateComplianceStatus(id: string, status: string): Promise<ComplianceDocument> {\n    const [doc] = await db\n      .update(complianceDocuments)\n      .set({ status: status as any, updatedAt: new Date() })\n      .where(eq(complianceDocuments.id, id))\n      .returning();\n    return doc;\n  }\n\n  async getExpiringCompliance(organizationId: string, daysAhead: number): Promise<ComplianceDocument[]> {\n    const futureDate = new Date();\n    futureDate.setDate(futureDate.getDate() + daysAhead);\n    \n    return await db\n      .select()\n      .from(complianceDocuments)\n      .where(\n        and(\n          eq(complianceDocuments.organizationId, organizationId),\n          lte(complianceDocuments.expiryDate, futureDate)\n        )\n      )\n      .orderBy(complianceDocuments.expiryDate);\n  }\n\n  // Maintenance operations\n  async createMaintenanceRequest(requestData: InsertMaintenanceRequest): Promise<MaintenanceRequest> {\n    const [request] = await db.insert(maintenanceRequests).values(requestData).returning();\n    return request;\n  }\n\n  async getMaintenanceRequestsByProperty(propertyId: string): Promise<MaintenanceRequest[]> {\n    return await db\n      .select()\n      .from(maintenanceRequests)\n      .where(eq(maintenanceRequests.propertyId, propertyId))\n      .orderBy(desc(maintenanceRequests.createdAt));\n  }\n\n  async getMaintenanceByOrganization(organizationId: string): Promise<any[]> {\n    const reporterAlias = alias(users, 'reporter');\n    const assigneeAlias = alias(users, 'assignee');\n    \n    return await db\n      .select({\n        id: maintenanceRequests.id,\n        organizationId: maintenanceRequests.organizationId,\n        propertyId: maintenanceRequests.propertyId,\n        reportedBy: maintenanceRequests.reportedBy,\n        assignedTo: maintenanceRequests.assignedTo,\n        title: maintenanceRequests.title,\n        description: maintenanceRequests.description,\n        status: maintenanceRequests.status,\n        priority: maintenanceRequests.priority,\n        photoUrls: maintenanceRequests.photoUrls,\n        aiSuggestedFixes: maintenanceRequests.aiSuggestedFixes,\n        aiAnalysisJson: maintenanceRequests.aiAnalysisJson,\n        source: maintenanceRequests.source,\n        inspectionId: maintenanceRequests.inspectionId,\n        inspectionEntryId: maintenanceRequests.inspectionEntryId,\n        createdAt: maintenanceRequests.createdAt,\n        updatedAt: maintenanceRequests.updatedAt,\n        property: {\n          id: properties.id,\n          name: properties.name,\n          address: properties.address,\n        },\n        reportedByUser: {\n          firstName: reporterAlias.firstName,\n          lastName: reporterAlias.lastName,\n        },\n        assignedToUser: {\n          firstName: assigneeAlias.firstName,\n          lastName: assigneeAlias.lastName,\n        },\n      })\n      .from(maintenanceRequests)\n      .innerJoin(properties, eq(maintenanceRequests.propertyId, properties.id))\n      .leftJoin(reporterAlias, eq(maintenanceRequests.reportedBy, reporterAlias.id))\n      .leftJoin(assigneeAlias, eq(maintenanceRequests.assignedTo, assigneeAlias.id))\n      .where(eq(maintenanceRequests.organizationId, organizationId))\n      .orderBy(desc(maintenanceRequests.createdAt));\n  }\n\n  async updateMaintenanceStatus(id: string, status: string, assignedTo?: string): Promise<MaintenanceRequest> {\n    const updateData: any = { status: status as any, updatedAt: new Date() };\n    if (assignedTo !== undefined) {\n      updateData.assignedTo = assignedTo;\n    }\n    \n    const [request] = await db\n      .update(maintenanceRequests)\n      .set(updateData)\n      .where(eq(maintenanceRequests.id, id))\n      .returning();\n    return request;\n  }\n\n  async updateMaintenanceRequest(id: string, updates: Partial<InsertMaintenanceRequest>): Promise<MaintenanceRequest> {\n    const updateData = {\n      ...updates,\n      updatedAt: new Date(),\n    };\n    \n    const [request] = await db\n      .update(maintenanceRequests)\n      .set(updateData)\n      .where(eq(maintenanceRequests.id, id))\n      .returning();\n    return request;\n  }\n\n  // Comparison Report operations\n  async createComparisonReport(reportData: InsertComparisonReport): Promise<ComparisonReport> {\n    const [report] = await db.insert(comparisonReports).values(reportData).returning();\n    return report;\n  }\n\n  async getComparisonReportsByProperty(propertyId: string): Promise<ComparisonReport[]> {\n    return await db\n      .select()\n      .from(comparisonReports)\n      .where(eq(comparisonReports.propertyId, propertyId))\n      .orderBy(desc(comparisonReports.createdAt));\n  }\n\n  async getComparisonReportsByOrganization(organizationId: string): Promise<ComparisonReport[]> {\n    return await db\n      .select()\n      .from(comparisonReports)\n      .where(eq(comparisonReports.organizationId, organizationId))\n      .orderBy(desc(comparisonReports.createdAt));\n  }\n\n  async getComparisonReport(id: string): Promise<ComparisonReport | undefined> {\n    const [report] = await db.select().from(comparisonReports).where(eq(comparisonReports.id, id));\n    return report;\n  }\n\n  async updateComparisonReport(id: string, updates: Partial<InsertComparisonReport>): Promise<ComparisonReport> {\n    const updateData = {\n      ...updates,\n      updatedAt: new Date(),\n    };\n    \n    const [report] = await db\n      .update(comparisonReports)\n      .set(updateData)\n      .where(eq(comparisonReports.id, id))\n      .returning();\n    return report;\n  }\n\n  async createComparisonReportItem(itemData: any): Promise<any> {\n    const [item] = await db.insert(comparisonReportItems).values(itemData).returning();\n    return item;\n  }\n\n  async getComparisonReportItems(reportId: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(comparisonReportItems)\n      .where(eq(comparisonReportItems.comparisonReportId, reportId))\n      .orderBy(comparisonReportItems.createdAt);\n  }\n\n  async createComparisonComment(commentData: any): Promise<any> {\n    const [comment] = await db.insert(comparisonComments).values(commentData).returning();\n    return comment;\n  }\n\n  async getComparisonComments(reportId: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(comparisonComments)\n      .where(eq(comparisonComments.comparisonReportId, reportId))\n      .orderBy(comparisonComments.createdAt);\n  }\n  \n  // Inspection Category operations\n  async createInspectionCategory(categoryData: InsertInspectionCategory): Promise<InspectionCategory> {\n    const [category] = await db.insert(inspectionCategories).values(categoryData).returning();\n    return category;\n  }\n\n  async getInspectionCategories(organizationId: string): Promise<InspectionCategory[]> {\n    return await db\n      .select()\n      .from(inspectionCategories)\n      .where(eq(inspectionCategories.organizationId, organizationId))\n      .orderBy(inspectionCategories.sortOrder, inspectionCategories.name);\n  }\n\n  async getInspectionCategory(id: string): Promise<InspectionCategory | undefined> {\n    const [category] = await db.select().from(inspectionCategories).where(eq(inspectionCategories.id, id));\n    return category;\n  }\n\n  async updateInspectionCategory(id: string, updates: Partial<InsertInspectionCategory>): Promise<InspectionCategory> {\n    const [category] = await db\n      .update(inspectionCategories)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inspectionCategories.id, id))\n      .returning();\n    return category;\n  }\n\n  async deleteInspectionCategory(id: string): Promise<void> {\n    await db.delete(inspectionCategories).where(eq(inspectionCategories.id, id));\n  }\n\n  // Credit Transaction operations\n  async createCreditTransaction(transactionData: InsertCreditTransaction): Promise<CreditTransaction> {\n    const [transaction] = await db.insert(creditTransactions).values(transactionData).returning();\n    return transaction;\n  }\n\n  async getCreditTransactions(organizationId: string): Promise<CreditTransaction[]> {\n    return await db\n      .select()\n      .from(creditTransactions)\n      .where(eq(creditTransactions.organizationId, organizationId))\n      .orderBy(desc(creditTransactions.createdAt));\n  }\n\n  // Block operations\n  async createBlock(blockData: InsertBlock & { organizationId: string }): Promise<Block> {\n    const [block] = await db.insert(blocks).values(blockData).returning();\n    return block;\n  }\n\n  async getBlocksByOrganization(organizationId: string): Promise<Block[]> {\n    return await db\n      .select()\n      .from(blocks)\n      .where(eq(blocks.organizationId, organizationId))\n      .orderBy(blocks.name);\n  }\n\n  async getBlocksWithStats(organizationId: string): Promise<any[]> {\n    const allBlocks = await this.getBlocksByOrganization(organizationId);\n    \n    if (allBlocks.length === 0) {\n      return [];\n    }\n    \n    const blockIds = allBlocks.map(b => b.id);\n    \n    // Batch fetch all properties for all blocks at once (properties ARE units)\n    const allProperties = await db\n      .select()\n      .from(properties)\n      .where(and(\n        eq(properties.organizationId, organizationId),\n        sql`${properties.blockId} IN (${sql.join(blockIds.map(id => sql`${id}`), sql`, `)})`\n      ));\n    \n    // Group properties by block\n    const propertiesByBlock = new Map<string, typeof allProperties>();\n    allProperties.forEach(prop => {\n      if (prop.blockId) {\n        if (!propertiesByBlock.has(prop.blockId)) {\n          propertiesByBlock.set(prop.blockId, []);\n        }\n        propertiesByBlock.get(prop.blockId)!.push(prop);\n      }\n    });\n    \n    // Batch fetch all property-level inspections\n    const propertyIds = allProperties.map(p => p.id);\n    let propertyInspections: any[] = [];\n    if (propertyIds.length > 0) {\n      propertyInspections = await db\n        .select()\n        .from(inspections)\n        .where(sql`${inspections.propertyId} IN (${sql.join(propertyIds.map(id => sql`${id}`), sql`, `)})`);\n    }\n    \n    // Batch fetch all block-level inspections\n    let blockInspections: any[] = [];\n    if (blockIds.length > 0) {\n      blockInspections = await db\n        .select()\n        .from(inspections)\n        .where(sql`${inspections.blockId} IN (${sql.join(blockIds.map(id => sql`${id}`), sql`, `)})`);\n    }\n    \n    // Group inspections by property\n    const inspectionsByProperty = new Map<string, typeof propertyInspections>();\n    propertyInspections.forEach(inspection => {\n      if (inspection.propertyId && !inspectionsByProperty.has(inspection.propertyId)) {\n        inspectionsByProperty.set(inspection.propertyId, []);\n      }\n      if (inspection.propertyId) {\n        inspectionsByProperty.get(inspection.propertyId)!.push(inspection);\n      }\n    });\n    \n    // Group inspections by block\n    const inspectionsByBlock = new Map<string, typeof blockInspections>();\n    blockInspections.forEach(inspection => {\n      if (inspection.blockId && !inspectionsByBlock.has(inspection.blockId)) {\n        inspectionsByBlock.set(inspection.blockId, []);\n      }\n      if (inspection.blockId) {\n        inspectionsByBlock.get(inspection.blockId)!.push(inspection);\n      }\n    });\n    \n    // Calculate date ranges once\n    const now = new Date();\n    const thirtyDaysFromNow = new Date();\n    thirtyDaysFromNow.setDate(now.getDate() + 30);\n    const ninetyDaysAgo = new Date();\n    ninetyDaysAgo.setDate(now.getDate() - 90);\n    \n    // Build stats for each block\n    const blocksWithStats = allBlocks.map(block => {\n      const blockProperties = propertiesByBlock.get(block.id) || [];\n      const totalProperties = blockProperties.length;\n      \n      // Get all inspections for this block (both property-level and block-level)\n      const blockPropertyInspections = blockProperties.flatMap(prop => \n        inspectionsByProperty.get(prop.id) || []\n      );\n      const directBlockInspections = inspectionsByBlock.get(block.id) || [];\n      const allBlockInspections = [...blockPropertyInspections, ...directBlockInspections];\n      \n      // Count inspections due in next 30 days\n      const inspectionsDue = allBlockInspections.filter(insp => {\n        const scheduledDate = new Date(insp.scheduledDate);\n        return scheduledDate >= now && \n               scheduledDate <= thirtyDaysFromNow && \n               insp.status !== 'completed';\n      }).length;\n      \n      // Count overdue inspections\n      const overdueInspections = allBlockInspections.filter(insp => {\n        const scheduledDate = new Date(insp.scheduledDate);\n        return scheduledDate < now && insp.status !== 'completed';\n      }).length;\n      \n      // Calculate compliance rate (properties with recent completed inspections)\n      let complianceRate = 0;\n      if (totalProperties > 0) {\n        const propertiesWithRecentInspections = new Set<string>();\n        blockPropertyInspections.forEach(insp => {\n          const scheduledDate = new Date(insp.scheduledDate);\n          if (scheduledDate >= ninetyDaysAgo && insp.status === 'completed' && insp.propertyId) {\n            propertiesWithRecentInspections.add(insp.propertyId);\n          }\n        });\n        complianceRate = Math.round((propertiesWithRecentInspections.size / totalProperties) * 100);\n      }\n      \n      return {\n        ...block,\n        stats: {\n          totalProperties,\n          complianceRate,\n          inspectionsDue,\n          overdueInspections,\n        },\n      };\n    });\n    \n    return blocksWithStats;\n  }\n\n  async getBlock(id: string): Promise<Block | undefined> {\n    const [block] = await db.select().from(blocks).where(eq(blocks.id, id));\n    return block;\n  }\n\n  async updateBlock(id: string, updates: Partial<InsertBlock>): Promise<Block> {\n    const [block] = await db\n      .update(blocks)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(blocks.id, id))\n      .returning();\n    return block;\n  }\n\n  async deleteBlock(id: string): Promise<void> {\n    await db.delete(blocks).where(eq(blocks.id, id));\n  }\n\n  async getTenantAssignmentsByBlock(blockId: string): Promise<any[]> {\n    // Get all properties in the block\n    const blockProperties = await db\n      .select()\n      .from(properties)\n      .where(eq(properties.blockId, blockId));\n    \n    if (blockProperties.length === 0) {\n      return [];\n    }\n\n    const propertyIds = blockProperties.map(p => p.id);\n    \n    // Get all tenant assignments for properties in this block with user and property info\n    const assignments = await db\n      .select({\n        // Assignment info\n        assignmentId: tenantAssignments.id,\n        leaseStartDate: tenantAssignments.leaseStartDate,\n        leaseEndDate: tenantAssignments.leaseEndDate,\n        monthlyRent: tenantAssignments.monthlyRent,\n        depositAmount: tenantAssignments.depositAmount,\n        isActive: tenantAssignments.isActive,\n        // User info\n        userId: users.id,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        email: users.email,\n        phone: users.phone,\n        profileImageUrl: users.profileImageUrl,\n        // Property info\n        propertyId: properties.id,\n        propertyName: properties.name,\n        propertyAddress: properties.address,\n      })\n      .from(tenantAssignments)\n      .innerJoin(users, eq(tenantAssignments.tenantId, users.id))\n      .innerJoin(properties, eq(tenantAssignments.propertyId, properties.id))\n      .where(sql`${tenantAssignments.propertyId} IN (${sql.join(propertyIds.map(id => sql`${id}`), sql`, `)})`);\n\n    return assignments.map(a => ({\n      user: {\n        id: a.userId,\n        firstName: a.firstName,\n        lastName: a.lastName,\n        email: a.email,\n        phone: a.phone,\n        profileImageUrl: a.profileImageUrl,\n      },\n      property: {\n        id: a.propertyId,\n        name: a.propertyName,\n        address: a.propertyAddress,\n      },\n      assignment: {\n        id: a.assignmentId,\n        leaseStartDate: a.leaseStartDate,\n        leaseEndDate: a.leaseEndDate,\n        monthlyRent: a.monthlyRent,\n        depositAmount: a.depositAmount,\n        isActive: a.isActive,\n      },\n    }));\n  }\n\n  async getTenantAssignmentsByProperty(propertyId: string, organizationId: string): Promise<any[]> {\n    // Get all tenant assignments for this property with user info\n    // Enforce organization isolation by joining with properties table\n    const assignments = await db\n      .select({\n        // Assignment info\n        assignmentId: tenantAssignments.id,\n        leaseStartDate: tenantAssignments.leaseStartDate,\n        leaseEndDate: tenantAssignments.leaseEndDate,\n        monthlyRent: tenantAssignments.monthlyRent,\n        depositAmount: tenantAssignments.depositAmount,\n        isActive: tenantAssignments.isActive,\n        // User info\n        userId: users.id,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        email: users.email,\n        phone: users.phone,\n        profileImageUrl: users.profileImageUrl,\n      })\n      .from(tenantAssignments)\n      .innerJoin(users, eq(tenantAssignments.tenantId, users.id))\n      .innerJoin(properties, eq(tenantAssignments.propertyId, properties.id))\n      .where(\n        and(\n          eq(tenantAssignments.propertyId, propertyId),\n          eq(properties.organizationId, organizationId)\n        )\n      );\n\n    return assignments.map(a => ({\n      id: a.userId,\n      firstName: a.firstName,\n      lastName: a.lastName,\n      email: a.email,\n      phone: a.phone,\n      profileImageUrl: a.profileImageUrl,\n      role: 'tenant',\n      assignment: {\n        id: a.assignmentId,\n        leaseStartDate: a.leaseStartDate,\n        leaseEndDate: a.leaseEndDate,\n        monthlyRent: a.monthlyRent,\n        depositAmount: a.depositAmount,\n        isActive: a.isActive,\n      },\n    }));\n  }\n\n  async createTenantAssignment(assignment: InsertTenantAssignment & { organizationId: string }): Promise<TenantAssignment> {\n    const [created] = await db.insert(tenantAssignments).values(assignment).returning();\n    return created;\n  }\n\n  async getTenantAssignment(id: string): Promise<TenantAssignment | undefined> {\n    const [assignment] = await db.select().from(tenantAssignments).where(eq(tenantAssignments.id, id));\n    return assignment;\n  }\n\n  async updateTenantAssignment(id: string, updates: Partial<InsertTenantAssignment>): Promise<TenantAssignment> {\n    const [updated] = await db.update(tenantAssignments)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(tenantAssignments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTenantAssignment(id: string): Promise<void> {\n    await db.delete(tenantAssignments).where(eq(tenantAssignments.id, id));\n  }\n\n  async getTenantAssignmentsByOrganization(organizationId: string): Promise<any[]> {\n    const assignments = await db\n      .select()\n      .from(tenantAssignments)\n      .where(eq(tenantAssignments.organizationId, organizationId));\n    return assignments;\n  }\n\n  async getTenantAssignmentTags(tenantAssignmentId: string, organizationId: string): Promise<any[]> {\n    const result = await db\n      .select({\n        id: tags.id,\n        name: tags.name,\n        color: tags.color,\n      })\n      .from(tenantAssignmentTags)\n      .innerJoin(tags, eq(tenantAssignmentTags.tagId, tags.id))\n      .innerJoin(tenantAssignments, eq(tenantAssignmentTags.tenantAssignmentId, tenantAssignments.id))\n      .where(\n        and(\n          eq(tenantAssignmentTags.tenantAssignmentId, tenantAssignmentId),\n          eq(tenantAssignments.organizationId, organizationId)\n        )\n      );\n    \n    return result;\n  }\n\n  async updateTenantAssignmentTags(tenantAssignmentId: string, tagIds: string[], organizationId: string): Promise<void> {\n    // Verify tenant assignment belongs to organization\n    const assignment = await db\n      .select()\n      .from(tenantAssignments)\n      .where(\n        and(\n          eq(tenantAssignments.id, tenantAssignmentId),\n          eq(tenantAssignments.organizationId, organizationId)\n        )\n      );\n    \n    if (assignment.length === 0) {\n      throw new Error(\"Tenant assignment not found or access denied\");\n    }\n    \n    // Delete existing tags\n    await db.delete(tenantAssignmentTags).where(eq(tenantAssignmentTags.tenantAssignmentId, tenantAssignmentId));\n    \n    // Insert new tags\n    if (tagIds.length > 0) {\n      await db.insert(tenantAssignmentTags).values(\n        tagIds.map(tagId => ({\n          tenantAssignmentId,\n          tagId,\n        }))\n      );\n    }\n  }\n\n  async createTenancyAttachment(attachment: InsertTenancyAttachment & { organizationId: string }): Promise<TenancyAttachment> {\n    // Verify tenant assignment belongs to organization\n    const assignment = await db\n      .select()\n      .from(tenantAssignments)\n      .where(\n        and(\n          eq(tenantAssignments.id, attachment.tenantAssignmentId),\n          eq(tenantAssignments.organizationId, attachment.organizationId)\n        )\n      );\n    \n    if (assignment.length === 0) {\n      throw new Error(\"Tenant assignment not found or access denied\");\n    }\n    \n    const [created] = await db.insert(tenancyAttachments).values(attachment).returning();\n    return created;\n  }\n\n  async getTenancyAttachment(id: string, organizationId: string): Promise<TenancyAttachment | undefined> {\n    const [attachment] = await db\n      .select({\n        id: tenancyAttachments.id,\n        tenantAssignmentId: tenancyAttachments.tenantAssignmentId,\n        fileName: tenancyAttachments.fileName,\n        fileUrl: tenancyAttachments.fileUrl,\n        fileType: tenancyAttachments.fileType,\n        fileSize: tenancyAttachments.fileSize,\n        uploadedBy: tenancyAttachments.uploadedBy,\n        organizationId: tenancyAttachments.organizationId,\n        createdAt: tenancyAttachments.createdAt,\n      })\n      .from(tenancyAttachments)\n      .innerJoin(tenantAssignments, eq(tenancyAttachments.tenantAssignmentId, tenantAssignments.id))\n      .where(\n        and(\n          eq(tenancyAttachments.id, id),\n          eq(tenantAssignments.organizationId, organizationId)\n        )\n      );\n    \n    return attachment;\n  }\n\n  async getTenancyAttachments(tenantAssignmentId: string, organizationId: string): Promise<TenancyAttachment[]> {\n    return await db\n      .select({\n        id: tenancyAttachments.id,\n        tenantAssignmentId: tenancyAttachments.tenantAssignmentId,\n        fileName: tenancyAttachments.fileName,\n        fileUrl: tenancyAttachments.fileUrl,\n        fileType: tenancyAttachments.fileType,\n        fileSize: tenancyAttachments.fileSize,\n        uploadedBy: tenancyAttachments.uploadedBy,\n        organizationId: tenancyAttachments.organizationId,\n        createdAt: tenancyAttachments.createdAt,\n      })\n      .from(tenancyAttachments)\n      .innerJoin(tenantAssignments, eq(tenancyAttachments.tenantAssignmentId, tenantAssignments.id))\n      .where(\n        and(\n          eq(tenancyAttachments.tenantAssignmentId, tenantAssignmentId),\n          eq(tenantAssignments.organizationId, organizationId)\n        )\n      )\n      .orderBy(desc(tenancyAttachments.createdAt));\n  }\n\n  async deleteTenancyAttachment(id: string, organizationId: string): Promise<void> {\n    // Verify attachment belongs to organization\n    const attachment = await db\n      .select()\n      .from(tenancyAttachments)\n      .innerJoin(tenantAssignments, eq(tenancyAttachments.tenantAssignmentId, tenantAssignments.id))\n      .where(\n        and(\n          eq(tenancyAttachments.id, id),\n          eq(tenantAssignments.organizationId, organizationId)\n        )\n      );\n    \n    if (attachment.length === 0) {\n      throw new Error(\"Attachment not found or access denied\");\n    }\n    \n    await db.delete(tenancyAttachments).where(eq(tenancyAttachments.id, id));\n  }\n\n  async getBlockTenantStats(blockId: string): Promise<{ totalUnits: number; occupiedUnits: number; occupancyRate: number; totalMonthlyRent: number }> {\n    // Get all properties in the block (properties = units)\n    const blockProperties = await db\n      .select()\n      .from(properties)\n      .where(eq(properties.blockId, blockId));\n    \n    const totalUnits = blockProperties.length;\n\n    if (totalUnits === 0) {\n      return {\n        totalUnits: 0,\n        occupiedUnits: 0,\n        occupancyRate: 0,\n        totalMonthlyRent: 0,\n      };\n    }\n\n    const propertyIds = blockProperties.map(p => p.id);\n\n    // Get active tenant assignments for properties in this block\n    const activeAssignments = await db\n      .select({\n        propertyId: tenantAssignments.propertyId,\n        monthlyRent: tenantAssignments.monthlyRent,\n      })\n      .from(tenantAssignments)\n      .where(\n        and(\n          sql`${tenantAssignments.propertyId} IN (${sql.join(propertyIds.map(id => sql`${id}`), sql`, `)})`,\n          eq(tenantAssignments.isActive, true)\n        )\n      );\n\n    const occupiedUnits = activeAssignments.length;\n    const occupancyRate = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;\n    \n    // Calculate total monthly rent\n    const totalMonthlyRent = activeAssignments.reduce((sum, assignment) => {\n      return sum + (assignment.monthlyRent ? parseFloat(assignment.monthlyRent as string) : 0);\n    }, 0);\n\n    return {\n      totalUnits,\n      occupiedUnits,\n      occupancyRate,\n      totalMonthlyRent,\n    };\n  }\n\n  // Inventory Template operations\n  async createInventoryTemplate(templateData: InsertInventoryTemplate): Promise<InventoryTemplate> {\n    const [template] = await db.insert(inventoryTemplates).values(templateData).returning();\n    return template;\n  }\n\n  async getInventoryTemplatesByOrganization(organizationId: string): Promise<InventoryTemplate[]> {\n    return await db\n      .select()\n      .from(inventoryTemplates)\n      .where(eq(inventoryTemplates.organizationId, organizationId))\n      .orderBy(inventoryTemplates.name);\n  }\n\n  async getInventoryTemplate(id: string): Promise<InventoryTemplate | undefined> {\n    const [template] = await db.select().from(inventoryTemplates).where(eq(inventoryTemplates.id, id));\n    return template;\n  }\n\n  async updateInventoryTemplate(id: string, updates: Partial<InsertInventoryTemplate>): Promise<InventoryTemplate> {\n    const [template] = await db\n      .update(inventoryTemplates)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inventoryTemplates.id, id))\n      .returning();\n    return template;\n  }\n\n  async deleteInventoryTemplate(id: string): Promise<void> {\n    await db.delete(inventoryTemplates).where(eq(inventoryTemplates.id, id));\n  }\n\n  // Inventory operations\n  async createInventory(inventoryData: InsertInventory): Promise<Inventory> {\n    const [inventory] = await db.insert(inventories).values(inventoryData).returning();\n    return inventory;\n  }\n\n  async getInventoriesByProperty(propertyId: string): Promise<Inventory[]> {\n    return await db\n      .select()\n      .from(inventories)\n      .where(eq(inventories.propertyId, propertyId))\n      .orderBy(desc(inventories.version));\n  }\n\n  async getInventoriesByOrganization(organizationId: string): Promise<Inventory[]> {\n    return await db\n      .select()\n      .from(inventories)\n      .where(eq(inventories.organizationId, organizationId))\n      .orderBy(desc(inventories.createdAt));\n  }\n\n  async getInventory(id: string): Promise<Inventory | undefined> {\n    const [inventory] = await db.select().from(inventories).where(eq(inventories.id, id));\n    return inventory;\n  }\n\n  // Inventory Item operations\n  async createInventoryItem(itemData: InsertInventoryItem): Promise<InventoryItem> {\n    const [item] = await db.insert(inventoryItems).values(itemData).returning();\n    return item;\n  }\n\n  async getInventoryItems(inventoryId: string): Promise<InventoryItem[]> {\n    return await db\n      .select()\n      .from(inventoryItems)\n      .where(eq(inventoryItems.inventoryId, inventoryId))\n      .orderBy(inventoryItems.path);\n  }\n\n  async updateInventoryItem(id: string, updates: Partial<InsertInventoryItem>): Promise<InventoryItem> {\n    const [item] = await db\n      .update(inventoryItems)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inventoryItems.id, id))\n      .returning();\n    return item;\n  }\n\n  // Work Order operations\n  async createWorkOrder(workOrderData: InsertWorkOrder): Promise<WorkOrder> {\n    const [workOrder] = await db.insert(workOrders).values(workOrderData).returning();\n    return workOrder;\n  }\n\n  async getWorkOrdersByOrganization(organizationId: string): Promise<any[]> {\n    return await db\n      .select({\n        id: workOrders.id,\n        organizationId: workOrders.organizationId,\n        maintenanceRequestId: workOrders.maintenanceRequestId,\n        teamId: workOrders.teamId,\n        contractorId: workOrders.contractorId,\n        status: workOrders.status,\n        slaDue: workOrders.slaDue,\n        costEstimate: workOrders.costEstimate,\n        costActual: workOrders.costActual,\n        variationNotes: workOrders.variationNotes,\n        completedAt: workOrders.completedAt,\n        createdAt: workOrders.createdAt,\n        updatedAt: workOrders.updatedAt,\n        maintenanceRequest: {\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          priority: maintenanceRequests.priority,\n          propertyId: maintenanceRequests.propertyId,\n        },\n        contractor: {\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n        },\n        team: {\n          id: teams.id,\n          name: teams.name,\n          email: teams.email,\n        },\n      })\n      .from(workOrders)\n      .innerJoin(maintenanceRequests, eq(workOrders.maintenanceRequestId, maintenanceRequests.id))\n      .leftJoin(users, eq(workOrders.contractorId, users.id))\n      .leftJoin(teams, eq(workOrders.teamId, teams.id))\n      .where(eq(workOrders.organizationId, organizationId))\n      .orderBy(desc(workOrders.createdAt));\n  }\n\n  async getWorkOrdersByContractor(contractorId: string): Promise<any[]> {\n    return await db\n      .select({\n        id: workOrders.id,\n        organizationId: workOrders.organizationId,\n        maintenanceRequestId: workOrders.maintenanceRequestId,\n        contractorId: workOrders.contractorId,\n        status: workOrders.status,\n        slaDue: workOrders.slaDue,\n        costEstimate: workOrders.costEstimate,\n        costActual: workOrders.costActual,\n        variationNotes: workOrders.variationNotes,\n        completedAt: workOrders.completedAt,\n        createdAt: workOrders.createdAt,\n        updatedAt: workOrders.updatedAt,\n        maintenanceRequest: {\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          priority: maintenanceRequests.priority,\n          propertyId: maintenanceRequests.propertyId,\n        },\n      })\n      .from(workOrders)\n      .innerJoin(maintenanceRequests, eq(workOrders.maintenanceRequestId, maintenanceRequests.id))\n      .where(eq(workOrders.contractorId, contractorId))\n      .orderBy(desc(workOrders.createdAt));\n  }\n\n  async getWorkOrder(id: string): Promise<WorkOrder | undefined> {\n    const [workOrder] = await db.select().from(workOrders).where(eq(workOrders.id, id));\n    return workOrder;\n  }\n\n  async updateWorkOrderStatus(id: string, status: string, completedAt?: Date): Promise<WorkOrder> {\n    const updateData: any = { status: status as any, updatedAt: new Date() };\n    if (completedAt !== undefined) {\n      updateData.completedAt = completedAt;\n    }\n    \n    const [workOrder] = await db\n      .update(workOrders)\n      .set(updateData)\n      .where(eq(workOrders.id, id))\n      .returning();\n    return workOrder;\n  }\n\n  async updateWorkOrderCost(id: string, costActual: number, variationNotes?: string): Promise<WorkOrder> {\n    const updateData: any = { costActual, updatedAt: new Date() };\n    if (variationNotes !== undefined) {\n      updateData.variationNotes = variationNotes;\n    }\n    \n    const [workOrder] = await db\n      .update(workOrders)\n      .set(updateData)\n      .where(eq(workOrders.id, id))\n      .returning();\n    return workOrder;\n  }\n\n  // Work Log operations\n  async createWorkLog(logData: InsertWorkLog): Promise<WorkLog> {\n    const [log] = await db.insert(workLogs).values(logData).returning();\n    return log;\n  }\n\n  async getWorkLogs(workOrderId: string): Promise<WorkLog[]> {\n    return await db\n      .select()\n      .from(workLogs)\n      .where(eq(workLogs.workOrderId, workOrderId))\n      .orderBy(desc(workLogs.createdAt));\n  }\n\n  // Team operations\n  async createTeam(teamData: InsertTeam & { organizationId: string }): Promise<Team> {\n    const [team] = await db.insert(teams).values(teamData).returning();\n    return team;\n  }\n\n  async getTeamsByOrganization(organizationId: string): Promise<any[]> {\n    // Get teams with member count\n    return await db\n      .select({\n        id: teams.id,\n        organizationId: teams.organizationId,\n        name: teams.name,\n        description: teams.description,\n        email: teams.email,\n        isActive: teams.isActive,\n        createdAt: teams.createdAt,\n        updatedAt: teams.updatedAt,\n        memberCount: sql<number>`count(distinct ${teamMembers.id})::int`,\n      })\n      .from(teams)\n      .leftJoin(teamMembers, eq(teams.id, teamMembers.teamId))\n      .where(eq(teams.organizationId, organizationId))\n      .groupBy(teams.id)\n      .orderBy(desc(teams.createdAt));\n  }\n\n  async getTeam(id: string): Promise<Team | undefined> {\n    const [team] = await db.select().from(teams).where(eq(teams.id, id));\n    return team;\n  }\n\n  async updateTeam(id: string, updates: Partial<InsertTeam>): Promise<Team> {\n    const [team] = await db\n      .update(teams)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(teams.id, id))\n      .returning();\n    return team;\n  }\n\n  async deleteTeam(id: string): Promise<void> {\n    // Delete team members and categories first\n    await db.delete(teamMembers).where(eq(teamMembers.teamId, id));\n    await db.delete(teamCategories).where(eq(teamCategories.teamId, id));\n    await db.delete(teams).where(eq(teams.id, id));\n  }\n\n  // Team Member operations\n  async addTeamMember(memberData: InsertTeamMember): Promise<TeamMember> {\n    const [member] = await db.insert(teamMembers).values(memberData).returning();\n    return member;\n  }\n\n  async getTeamMembers(teamId: string): Promise<any[]> {\n    // Get team members with user/contact details\n    return await db\n      .select({\n        id: teamMembers.id,\n        teamId: teamMembers.teamId,\n        userId: teamMembers.userId,\n        contactId: teamMembers.contactId,\n        role: teamMembers.role,\n        createdAt: teamMembers.createdAt,\n        user: {\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          role: users.role,\n        },\n        contact: {\n          id: contacts.id,\n          firstName: contacts.firstName,\n          lastName: contacts.lastName,\n          email: contacts.email,\n          type: contacts.type,\n        },\n      })\n      .from(teamMembers)\n      .leftJoin(users, eq(teamMembers.userId, users.id))\n      .leftJoin(contacts, eq(teamMembers.contactId, contacts.id))\n      .where(eq(teamMembers.teamId, teamId))\n      .orderBy(teamMembers.createdAt);\n  }\n\n  async removeTeamMember(id: string): Promise<void> {\n    await db.delete(teamMembers).where(eq(teamMembers.id, id));\n  }\n\n  // Team Category operations\n  async addTeamCategory(categoryData: InsertTeamCategory): Promise<TeamCategory> {\n    const [category] = await db.insert(teamCategories).values(categoryData).returning();\n    return category;\n  }\n\n  async getTeamCategories(teamId: string): Promise<TeamCategory[]> {\n    return await db\n      .select()\n      .from(teamCategories)\n      .where(eq(teamCategories.teamId, teamId))\n      .orderBy(teamCategories.category);\n  }\n\n  async removeTeamCategory(id: string): Promise<void> {\n    await db.delete(teamCategories).where(eq(teamCategories.id, id));\n  }\n\n  async getTeamByCategory(organizationId: string, category: string): Promise<Team | undefined> {\n    // Find team assigned to a specific category\n    const [result] = await db\n      .select({\n        id: teams.id,\n        organizationId: teams.organizationId,\n        name: teams.name,\n        description: teams.description,\n        email: teams.email,\n        isActive: teams.isActive,\n        createdAt: teams.createdAt,\n        updatedAt: teams.updatedAt,\n      })\n      .from(teams)\n      .innerJoin(teamCategories, eq(teams.id, teamCategories.teamId))\n      .where(and(\n        eq(teams.organizationId, organizationId),\n        eq(teamCategories.category, category),\n        eq(teams.isActive, true)\n      ))\n      .limit(1);\n    return result;\n  }\n\n  // Asset Inventory operations\n  async createAssetInventory(assetData: InsertAssetInventory): Promise<AssetInventory> {\n    const [asset] = await db.insert(assetInventory).values(assetData).returning();\n    return asset;\n  }\n\n  async getAssetInventoryByOrganization(organizationId: string): Promise<AssetInventory[]> {\n    return await db\n      .select()\n      .from(assetInventory)\n      .where(eq(assetInventory.organizationId, organizationId))\n      .orderBy(desc(assetInventory.createdAt));\n  }\n\n  async getAssetInventoryByProperty(propertyId: string): Promise<AssetInventory[]> {\n    return await db\n      .select()\n      .from(assetInventory)\n      .where(eq(assetInventory.propertyId, propertyId))\n      .orderBy(desc(assetInventory.createdAt));\n  }\n\n  async getAssetInventoryByBlock(blockId: string): Promise<AssetInventory[]> {\n    return await db\n      .select()\n      .from(assetInventory)\n      .where(eq(assetInventory.blockId, blockId))\n      .orderBy(desc(assetInventory.createdAt));\n  }\n\n  async getAssetInventory(id: string): Promise<AssetInventory | undefined> {\n    const [asset] = await db\n      .select()\n      .from(assetInventory)\n      .where(eq(assetInventory.id, id));\n    return asset;\n  }\n\n  async getAssetById(id: string): Promise<AssetInventory | undefined> {\n    return this.getAssetInventory(id);\n  }\n\n  async updateAssetInventory(id: string, updates: Partial<InsertAssetInventory>): Promise<AssetInventory> {\n    const [asset] = await db\n      .update(assetInventory)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(assetInventory.id, id))\n      .returning();\n    return asset;\n  }\n\n  async deleteAssetInventory(id: string): Promise<void> {\n    await db.delete(assetInventory).where(eq(assetInventory.id, id));\n  }\n\n  // Inspection Template operations\n  async createInspectionTemplate(templateData: InsertInspectionTemplate): Promise<InspectionTemplate> {\n    const [template] = await db.insert(inspectionTemplates).values(templateData).returning();\n    return template;\n  }\n\n  async getInspectionTemplatesByOrganization(organizationId: string): Promise<InspectionTemplate[]> {\n    return await db\n      .select()\n      .from(inspectionTemplates)\n      .where(eq(inspectionTemplates.organizationId, organizationId))\n      .orderBy(desc(inspectionTemplates.createdAt));\n  }\n\n  async getInspectionTemplate(id: string): Promise<InspectionTemplate | undefined> {\n    const [template] = await db\n      .select()\n      .from(inspectionTemplates)\n      .where(eq(inspectionTemplates.id, id));\n    return template;\n  }\n\n  async updateInspectionTemplate(id: string, updates: Partial<InsertInspectionTemplate>): Promise<InspectionTemplate> {\n    const [template] = await db\n      .update(inspectionTemplates)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inspectionTemplates.id, id))\n      .returning();\n    return template;\n  }\n\n  async deleteInspectionTemplate(id: string): Promise<void> {\n    // First delete all template points associated with this template\n    await db.delete(inspectionTemplatePoints).where(eq(inspectionTemplatePoints.templateId, id));\n    // Then delete the template itself\n    await db.delete(inspectionTemplates).where(eq(inspectionTemplates.id, id));\n  }\n\n  // Inspection Template Point operations\n  async createInspectionTemplatePoint(pointData: InsertInspectionTemplatePoint): Promise<InspectionTemplatePoint> {\n    const [point] = await db.insert(inspectionTemplatePoints).values(pointData).returning();\n    return point;\n  }\n\n  async getInspectionTemplatePoints(templateId: string): Promise<InspectionTemplatePoint[]> {\n    return await db\n      .select()\n      .from(inspectionTemplatePoints)\n      .where(eq(inspectionTemplatePoints.templateId, templateId))\n      .orderBy(inspectionTemplatePoints.sortOrder);\n  }\n\n  async getInspectionTemplatePoint(id: string): Promise<InspectionTemplatePoint | undefined> {\n    const [point] = await db\n      .select()\n      .from(inspectionTemplatePoints)\n      .where(eq(inspectionTemplatePoints.id, id));\n    return point;\n  }\n\n  async updateInspectionTemplatePoint(id: string, updates: Partial<InsertInspectionTemplatePoint>): Promise<InspectionTemplatePoint> {\n    const [point] = await db\n      .update(inspectionTemplatePoints)\n      .set(updates)\n      .where(eq(inspectionTemplatePoints.id, id))\n      .returning();\n    return point;\n  }\n\n  async deleteInspectionTemplatePoint(id: string): Promise<void> {\n    await db.delete(inspectionTemplatePoints).where(eq(inspectionTemplatePoints.id, id));\n  }\n\n  // Inspection Response operations\n  async createInspectionResponse(responseData: InsertInspectionResponse): Promise<InspectionResponse> {\n    const [response] = await db.insert(inspectionResponses).values(responseData).returning();\n    return response;\n  }\n\n  async getInspectionResponses(inspectionId: string): Promise<InspectionResponse[]> {\n    return await db\n      .select()\n      .from(inspectionResponses)\n      .where(eq(inspectionResponses.inspectionId, inspectionId))\n      .orderBy(inspectionResponses.createdAt);\n  }\n\n  async getInspectionResponse(id: string): Promise<InspectionResponse | undefined> {\n    const [response] = await db\n      .select()\n      .from(inspectionResponses)\n      .where(eq(inspectionResponses.id, id));\n    return response;\n  }\n\n  async updateInspectionResponse(id: string, updates: Partial<InsertInspectionResponse>): Promise<InspectionResponse> {\n    const [response] = await db\n      .update(inspectionResponses)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inspectionResponses.id, id))\n      .returning();\n    return response;\n  }\n\n  async deleteInspectionResponse(id: string): Promise<void> {\n    await db.delete(inspectionResponses).where(eq(inspectionResponses.id, id));\n  }\n\n  // Tag operations\n  async createTag(tagData: InsertTag): Promise<Tag> {\n    const [tag] = await db.insert(tags).values(tagData).returning();\n    return tag;\n  }\n\n  async getTagsByOrganization(organizationId: string): Promise<Tag[]> {\n    return await db\n      .select()\n      .from(tags)\n      .where(eq(tags.organizationId, organizationId))\n      .orderBy(tags.name);\n  }\n\n  async getTag(id: string): Promise<Tag | undefined> {\n    const [tag] = await db\n      .select()\n      .from(tags)\n      .where(eq(tags.id, id));\n    return tag;\n  }\n\n  async updateTag(id: string, updates: Partial<InsertTag>): Promise<Tag> {\n    const [tag] = await db\n      .update(tags)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(tags.id, id))\n      .returning();\n    return tag;\n  }\n\n  async deleteTag(id: string): Promise<void> {\n    // Delete all tag associations first\n    await db.delete(blockTags).where(eq(blockTags.tagId, id));\n    await db.delete(propertyTags).where(eq(propertyTags.tagId, id));\n    await db.delete(userTags).where(eq(userTags.tagId, id));\n    await db.delete(complianceDocumentTags).where(eq(complianceDocumentTags.tagId, id));\n    await db.delete(assetInventoryTags).where(eq(assetInventoryTags.tagId, id));\n    await db.delete(maintenanceRequestTags).where(eq(maintenanceRequestTags.tagId, id));\n    // Delete the tag itself\n    await db.delete(tags).where(eq(tags.id, id));\n  }\n\n  // Block tag operations\n  async addTagToBlock(blockId: string, tagId: string): Promise<void> {\n    await db.insert(blockTags).values({ blockId, tagId });\n  }\n\n  async removeTagFromBlock(blockId: string, tagId: string): Promise<void> {\n    await db.delete(blockTags).where(\n      and(eq(blockTags.blockId, blockId), eq(blockTags.tagId, tagId))\n    );\n  }\n\n  async getTagsForBlock(blockId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(blockTags)\n      .innerJoin(tags, eq(blockTags.tagId, tags.id))\n      .where(eq(blockTags.blockId, blockId));\n    return result.map(r => r.tag);\n  }\n\n  // Property tag operations\n  async addTagToProperty(propertyId: string, tagId: string): Promise<void> {\n    await db.insert(propertyTags).values({ propertyId, tagId });\n  }\n\n  async removeTagFromProperty(propertyId: string, tagId: string): Promise<void> {\n    await db.delete(propertyTags).where(\n      and(eq(propertyTags.propertyId, propertyId), eq(propertyTags.tagId, tagId))\n    );\n  }\n\n  async getTagsForProperty(propertyId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(propertyTags)\n      .innerJoin(tags, eq(propertyTags.tagId, tags.id))\n      .where(eq(propertyTags.propertyId, propertyId));\n    return result.map(r => r.tag);\n  }\n\n  // User tag operations\n  async addTagToUser(userId: string, tagId: string): Promise<void> {\n    await db.insert(userTags).values({ userId, tagId });\n  }\n\n  async removeTagFromUser(userId: string, tagId: string): Promise<void> {\n    await db.delete(userTags).where(\n      and(eq(userTags.userId, userId), eq(userTags.tagId, tagId))\n    );\n  }\n\n  async getTagsForUser(userId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(userTags)\n      .innerJoin(tags, eq(userTags.tagId, tags.id))\n      .where(eq(userTags.userId, userId));\n    return result.map(r => r.tag);\n  }\n\n  // Compliance document tag operations\n  async addTagToComplianceDocument(complianceDocumentId: string, tagId: string): Promise<void> {\n    await db.insert(complianceDocumentTags).values({ complianceDocumentId, tagId });\n  }\n\n  async removeTagFromComplianceDocument(complianceDocumentId: string, tagId: string): Promise<void> {\n    await db.delete(complianceDocumentTags).where(\n      and(\n        eq(complianceDocumentTags.complianceDocumentId, complianceDocumentId),\n        eq(complianceDocumentTags.tagId, tagId)\n      )\n    );\n  }\n\n  async getTagsForComplianceDocument(complianceDocumentId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(complianceDocumentTags)\n      .innerJoin(tags, eq(complianceDocumentTags.tagId, tags.id))\n      .where(eq(complianceDocumentTags.complianceDocumentId, complianceDocumentId));\n    return result.map(r => r.tag);\n  }\n\n  // Asset inventory tag operations\n  async addTagToAssetInventory(assetInventoryId: string, tagId: string): Promise<void> {\n    await db.insert(assetInventoryTags).values({ assetInventoryId, tagId });\n  }\n\n  async removeTagFromAssetInventory(assetInventoryId: string, tagId: string): Promise<void> {\n    await db.delete(assetInventoryTags).where(\n      and(\n        eq(assetInventoryTags.assetInventoryId, assetInventoryId),\n        eq(assetInventoryTags.tagId, tagId)\n      )\n    );\n  }\n\n  async getTagsForAssetInventory(assetInventoryId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(assetInventoryTags)\n      .innerJoin(tags, eq(assetInventoryTags.tagId, tags.id))\n      .where(eq(assetInventoryTags.assetInventoryId, assetInventoryId));\n    return result.map(r => r.tag);\n  }\n\n  // Maintenance request tag operations\n  async addTagToMaintenanceRequest(maintenanceRequestId: string, tagId: string): Promise<void> {\n    await db.insert(maintenanceRequestTags).values({ maintenanceRequestId, tagId });\n  }\n\n  async removeTagFromMaintenanceRequest(maintenanceRequestId: string, tagId: string): Promise<void> {\n    await db.delete(maintenanceRequestTags).where(\n      and(\n        eq(maintenanceRequestTags.maintenanceRequestId, maintenanceRequestId),\n        eq(maintenanceRequestTags.tagId, tagId)\n      )\n    );\n  }\n\n  async getTagsForMaintenanceRequest(maintenanceRequestId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(maintenanceRequestTags)\n      .innerJoin(tags, eq(maintenanceRequestTags.tagId, tags.id))\n      .where(eq(maintenanceRequestTags.maintenanceRequestId, maintenanceRequestId));\n    return result.map(r => r.tag);\n  }\n\n  // Contact tag operations\n  async addTagToContact(contactId: string, tagId: string): Promise<void> {\n    await db.insert(contactTags).values({ contactId, tagId });\n  }\n\n  async removeTagFromContact(contactId: string, tagId: string): Promise<void> {\n    await db.delete(contactTags).where(\n      and(\n        eq(contactTags.contactId, contactId),\n        eq(contactTags.tagId, tagId)\n      )\n    );\n  }\n\n  async getTagsForContact(contactId: string): Promise<Tag[]> {\n    const result = await db\n      .select({ tag: tags })\n      .from(contactTags)\n      .innerJoin(tags, eq(contactTags.tagId, tags.id))\n      .where(eq(contactTags.contactId, contactId));\n    return result.map(r => r.tag);\n  }\n\n  // Tag search operations\n  async searchByTags(organizationId: string, tagIds: string[]): Promise<{\n    blocks: any[];\n    properties: any[];\n    users: any[];\n    complianceDocuments: any[];\n    assetInventory: any[];\n    maintenanceRequests: any[];\n  }> {\n    const results = {\n      blocks: [] as any[],\n      properties: [] as any[],\n      users: [] as any[],\n      complianceDocuments: [] as any[],\n      assetInventory: [] as any[],\n      maintenanceRequests: [] as any[],\n    };\n\n    if (tagIds.length === 0) {\n      return results;\n    }\n\n    // Search blocks with these tags\n    const blocksResult = await db\n      .select({ block: blocks })\n      .from(blockTags)\n      .innerJoin(blocks, eq(blockTags.blockId, blocks.id))\n      .where(\n        and(\n          sql`${blockTags.tagId} = ANY(${tagIds})`,\n          eq(blocks.organizationId, organizationId)\n        )\n      );\n    results.blocks = blocksResult.map(r => r.block);\n\n    // Search properties with these tags\n    const propertiesResult = await db\n      .select({ property: properties })\n      .from(propertyTags)\n      .innerJoin(properties, eq(propertyTags.propertyId, properties.id))\n      .where(\n        and(\n          sql`${propertyTags.tagId} = ANY(${tagIds})`,\n          eq(properties.organizationId, organizationId)\n        )\n      );\n    results.properties = propertiesResult.map(r => r.property);\n\n    // Search users with these tags\n    const usersResult = await db\n      .select({ user: users })\n      .from(userTags)\n      .innerJoin(users, eq(userTags.userId, users.id))\n      .where(\n        and(\n          sql`${userTags.tagId} = ANY(${tagIds})`,\n          eq(users.organizationId, organizationId)\n        )\n      );\n    results.users = usersResult.map(r => r.user);\n\n    // Search compliance documents with these tags\n    const complianceResult = await db\n      .select({ doc: complianceDocuments })\n      .from(complianceDocumentTags)\n      .innerJoin(complianceDocuments, eq(complianceDocumentTags.complianceDocumentId, complianceDocuments.id))\n      .where(\n        and(\n          sql`${complianceDocumentTags.tagId} = ANY(${tagIds})`,\n          eq(complianceDocuments.organizationId, organizationId)\n        )\n      );\n    results.complianceDocuments = complianceResult.map(r => r.doc);\n\n    // Search asset inventory with these tags\n    const assetResult = await db\n      .select({ asset: assetInventory })\n      .from(assetInventoryTags)\n      .innerJoin(assetInventory, eq(assetInventoryTags.assetInventoryId, assetInventory.id))\n      .where(\n        and(\n          sql`${assetInventoryTags.tagId} = ANY(${tagIds})`,\n          eq(assetInventory.organizationId, organizationId)\n        )\n      );\n    results.assetInventory = assetResult.map(r => r.asset);\n\n    // Search maintenance requests with these tags\n    const maintenanceResult = await db\n      .select({ request: maintenanceRequests })\n      .from(maintenanceRequestTags)\n      .innerJoin(maintenanceRequests, eq(maintenanceRequestTags.maintenanceRequestId, maintenanceRequests.id))\n      .where(\n        and(\n          sql`${maintenanceRequestTags.tagId} = ANY(${tagIds})`,\n          eq(maintenanceRequests.organizationId, organizationId)\n        )\n      );\n    results.maintenanceRequests = maintenanceResult.map(r => r.request);\n\n    return results;\n  }\n\n  // Dashboard preferences operations\n  async getDashboardPreferences(userId: string): Promise<DashboardPreferences | undefined> {\n    const [prefs] = await db\n      .select()\n      .from(dashboardPreferences)\n      .where(eq(dashboardPreferences.userId, userId));\n    return prefs;\n  }\n\n  async updateDashboardPreferences(userId: string, enabledPanels: string[]): Promise<DashboardPreferences> {\n    const existing = await this.getDashboardPreferences(userId);\n    \n    if (existing) {\n      const [updated] = await db\n        .update(dashboardPreferences)\n        .set({ \n          enabledPanels: JSON.stringify(enabledPanels),\n          updatedAt: new Date()\n        })\n        .where(eq(dashboardPreferences.userId, userId))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(dashboardPreferences)\n        .values({\n          userId,\n          enabledPanels: JSON.stringify(enabledPanels)\n        })\n        .returning();\n      return created;\n    }\n  }\n\n  // Template Category operations\n  async createTemplateCategory(categoryData: InsertTemplateCategory): Promise<TemplateCategory> {\n    const [category] = await db.insert(templateCategories).values(categoryData).returning();\n    return category;\n  }\n\n  async getTemplateCategoriesByOrganization(organizationId: string): Promise<TemplateCategory[]> {\n    return await db\n      .select()\n      .from(templateCategories)\n      .where(eq(templateCategories.organizationId, organizationId))\n      .orderBy(desc(templateCategories.createdAt));\n  }\n\n  async getTemplateCategory(id: string): Promise<TemplateCategory | undefined> {\n    const [category] = await db.select().from(templateCategories).where(eq(templateCategories.id, id));\n    return category;\n  }\n\n  async updateTemplateCategory(id: string, updates: Partial<InsertTemplateCategory>): Promise<TemplateCategory> {\n    const [updated] = await db\n      .update(templateCategories)\n      .set(updates)\n      .where(eq(templateCategories.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTemplateCategory(id: string): Promise<void> {\n    await db.delete(templateCategories).where(eq(templateCategories.id, id));\n  }\n\n  // Template Inventory Link operations\n  async createTemplateInventoryLink(linkData: InsertTemplateInventoryLink): Promise<TemplateInventoryLink> {\n    const [link] = await db.insert(templateInventoryLinks).values(linkData).returning();\n    return link;\n  }\n\n  async getTemplateInventoryLinks(templateId: string): Promise<TemplateInventoryLink[]> {\n    return await db\n      .select()\n      .from(templateInventoryLinks)\n      .where(eq(templateInventoryLinks.templateId, templateId));\n  }\n\n  async deleteTemplateInventoryLink(id: string): Promise<void> {\n    await db.delete(templateInventoryLinks).where(eq(templateInventoryLinks.id, id));\n  }\n\n  // Inspection Entry operations (New JSON-based system)\n  async createInspectionEntry(entryData: InsertInspectionEntry): Promise<InspectionEntry> {\n    const [entry] = await db.insert(inspectionEntries).values(entryData).returning();\n    return entry;\n  }\n\n  async createInspectionEntriesBatch(entriesData: InsertInspectionEntry[]): Promise<InspectionEntry[]> {\n    if (entriesData.length === 0) return [];\n    // Use onConflictDoUpdate to handle offline sync retries idempotently\n    // If offlineId exists, update the entry; otherwise insert new\n    const entries = await db\n      .insert(inspectionEntries)\n      .values(entriesData)\n      .onConflictDoUpdate({\n        target: inspectionEntries.offlineId,\n        set: {\n          sectionRef: sql`EXCLUDED.section_ref`,\n          itemRef: sql`EXCLUDED.item_ref`,\n          fieldKey: sql`EXCLUDED.field_key`,\n          fieldType: sql`EXCLUDED.field_type`,\n          valueJson: sql`EXCLUDED.value_json`,\n          note: sql`EXCLUDED.note`,\n          photos: sql`EXCLUDED.photos`,\n          videos: sql`EXCLUDED.videos`,\n          maintenanceFlag: sql`EXCLUDED.maintenance_flag`,\n          defectsJson: sql`EXCLUDED.defects_json`,\n          updatedAt: new Date()\n        }\n      })\n      .returning();\n    return entries;\n  }\n\n  async getInspectionEntries(inspectionId: string): Promise<InspectionEntry[]> {\n    return await db\n      .select()\n      .from(inspectionEntries)\n      .where(eq(inspectionEntries.inspectionId, inspectionId))\n      .orderBy(inspectionEntries.createdAt);\n  }\n\n  async getInspectionEntry(id: string): Promise<InspectionEntry | undefined> {\n    const [entry] = await db.select().from(inspectionEntries).where(eq(inspectionEntries.id, id));\n    return entry;\n  }\n\n  async updateInspectionEntry(id: string, updates: Partial<InsertInspectionEntry>): Promise<InspectionEntry> {\n    const [updated] = await db\n      .update(inspectionEntries)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(inspectionEntries.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteInspectionEntry(id: string): Promise<void> {\n    await db.delete(inspectionEntries).where(eq(inspectionEntries.id, id));\n  }\n\n  async getEntriesByOfflineId(offlineId: string): Promise<InspectionEntry | undefined> {\n    const [entry] = await db\n      .select()\n      .from(inspectionEntries)\n      .where(eq(inspectionEntries.offlineId, offlineId));\n    return entry;\n  }\n\n  // AI Image Analysis operations\n  async createAiImageAnalysis(analysisData: InsertAiImageAnalysis): Promise<AiImageAnalysis> {\n    const [analysis] = await db.insert(aiImageAnalyses).values(analysisData).returning();\n    return analysis;\n  }\n\n  async getAiImageAnalysesByInspection(inspectionId: string): Promise<AiImageAnalysis[]> {\n    return await db\n      .select()\n      .from(aiImageAnalyses)\n      .where(eq(aiImageAnalyses.inspectionId, inspectionId))\n      .orderBy(desc(aiImageAnalyses.createdAt));\n  }\n\n  async getAiImageAnalysesByEntry(entryId: string): Promise<AiImageAnalysis[]> {\n    return await db\n      .select()\n      .from(aiImageAnalyses)\n      .where(eq(aiImageAnalyses.inspectionEntryId, entryId))\n      .orderBy(desc(aiImageAnalyses.createdAt));\n  }\n\n  async getAiImageAnalysis(id: string): Promise<AiImageAnalysis | undefined> {\n    const [analysis] = await db.select().from(aiImageAnalyses).where(eq(aiImageAnalyses.id, id));\n    return analysis;\n  }\n\n  // Inspection Snapshot operations\n  async updateInspectionSnapshots(\n    id: string,\n    templateSnapshot: any,\n    inventorySnapshot: any,\n    version: number\n  ): Promise<Inspection> {\n    const [updated] = await db\n      .update(inspections)\n      .set({\n        templateSnapshotJson: templateSnapshot,\n        inventorySnapshotJson: inventorySnapshot,\n        templateVersion: version,\n        startedAt: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(inspections.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getInspectionWithSnapshots(id: string): Promise<Inspection | undefined> {\n    const [inspection] = await db.select().from(inspections).where(eq(inspections.id, id));\n    return inspection;\n  }\n\n  // Admin operations\n  async getAdminByEmail(email: string): Promise<AdminUser | undefined> {\n    const [admin] = await db.select().from(adminUsers).where(eq(adminUsers.email, email));\n    return admin;\n  }\n\n  async getAllAdmins(): Promise<AdminUser[]> {\n    return await db.select().from(adminUsers).orderBy(desc(adminUsers.createdAt));\n  }\n\n  async createAdmin(adminData: InsertAdminUser): Promise<AdminUser> {\n    const [admin] = await db.insert(adminUsers).values(adminData).returning();\n    return admin;\n  }\n\n  async updateAdmin(id: string, updates: Partial<AdminUser>): Promise<AdminUser> {\n    const [admin] = await db\n      .update(adminUsers)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(adminUsers.id, id))\n      .returning();\n    return admin;\n  }\n\n  async deleteAdmin(id: string): Promise<void> {\n    await db.delete(adminUsers).where(eq(adminUsers.id, id));\n  }\n\n  async getAllOrganizationsWithOwners(): Promise<any[]> {\n    return await db\n      .select({\n        id: organizations.id,\n        name: organizations.name,\n        subscriptionStatus: organizations.subscriptionStatus,\n        subscriptionLevel: organizations.subscriptionLevel,\n        isActive: organizations.isActive,\n        creditsRemaining: organizations.creditsRemaining,\n        stripeCustomerId: organizations.stripeCustomerId,\n        createdAt: organizations.createdAt,\n        owner: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          username: users.username,\n        },\n      })\n      .from(organizations)\n      .leftJoin(users, eq(organizations.ownerId, users.id))\n      .orderBy(desc(organizations.createdAt));\n  }\n\n  async getOrganizationWithOwner(id: string): Promise<any | undefined> {\n    const [result] = await db\n      .select({\n        id: organizations.id,\n        name: organizations.name,\n        subscriptionStatus: organizations.subscriptionStatus,\n        subscriptionLevel: organizations.subscriptionLevel,\n        isActive: organizations.isActive,\n        creditsRemaining: organizations.creditsRemaining,\n        stripeCustomerId: organizations.stripeCustomerId,\n        createdAt: organizations.createdAt,\n        updatedAt: organizations.updatedAt,\n        owner: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          username: users.username,\n        },\n      })\n      .from(organizations)\n      .leftJoin(users, eq(organizations.ownerId, users.id))\n      .where(eq(organizations.id, id));\n    return result;\n  }\n\n  // Message Template operations\n  async createMessageTemplate(templateData: InsertMessageTemplate): Promise<MessageTemplate> {\n    const [template] = await db.insert(messageTemplates).values(templateData).returning();\n    return template;\n  }\n\n  async getMessageTemplatesByOrganization(organizationId: string): Promise<MessageTemplate[]> {\n    return await db\n      .select()\n      .from(messageTemplates)\n      .where(eq(messageTemplates.organizationId, organizationId))\n      .orderBy(desc(messageTemplates.createdAt));\n  }\n\n  async getMessageTemplate(id: string): Promise<MessageTemplate | undefined> {\n    const [template] = await db\n      .select()\n      .from(messageTemplates)\n      .where(eq(messageTemplates.id, id));\n    return template;\n  }\n\n  async updateMessageTemplate(id: string, updates: Partial<InsertMessageTemplate>): Promise<MessageTemplate> {\n    const [template] = await db\n      .update(messageTemplates)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(messageTemplates.id, id))\n      .returning();\n    return template;\n  }\n\n  async deleteMessageTemplate(id: string): Promise<void> {\n    await db.delete(messageTemplates).where(eq(messageTemplates.id, id));\n  }\n\n  async getBlockTenantsEmails(blockId: string, organizationId: string): Promise<{email: string; firstName?: string; lastName?: string;}[]> {\n    const tenantsData = await db\n      .select({\n        email: users.email,\n        firstName: users.firstName,\n        lastName: users.lastName,\n      })\n      .from(tenantAssignments)\n      .innerJoin(users, eq(tenantAssignments.tenantId, users.id))\n      .innerJoin(properties, eq(tenantAssignments.propertyId, properties.id))\n      .where(\n        and(\n          eq(properties.blockId, blockId),\n          eq(properties.organizationId, organizationId),\n          eq(tenantAssignments.isActive, true)\n        )\n      );\n\n    return tenantsData.map(t => ({\n      email: t.email,\n      firstName: t.firstName ?? undefined,\n      lastName: t.lastName ?? undefined,\n    }));\n  }\n\n  // Fixflo Integration operations\n  async getFixfloConfig(organizationId: string): Promise<FixfloConfig | undefined> {\n    const [config] = await db\n      .select()\n      .from(fixfloConfig)\n      .where(eq(fixfloConfig.organizationId, organizationId));\n    return config;\n  }\n\n  async upsertFixfloConfig(configData: InsertFixfloConfig): Promise<FixfloConfig> {\n    const [config] = await db\n      .insert(fixfloConfig)\n      .values(configData)\n      .onConflictDoUpdate({\n        target: fixfloConfig.organizationId,\n        set: {\n          ...configData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return config;\n  }\n\n  // ==================== SUBSCRIPTION SYSTEM OPERATIONS ====================\n  \n  // Subscription Plan operations\n  async getPlans(): Promise<Plan[]> {\n    return await db.select().from(plans).orderBy(plans.monthlyPriceGbp);\n  }\n\n  async getActivePlans(): Promise<Plan[]> {\n    return await db\n      .select()\n      .from(plans)\n      .where(eq(plans.isActive, true))\n      .orderBy(plans.monthlyPriceGbp);\n  }\n\n  async getPlan(id: string): Promise<Plan | undefined> {\n    const [plan] = await db.select().from(plans).where(eq(plans.id, id));\n    return plan;\n  }\n\n  async getPlanByCode(code: string): Promise<Plan | undefined> {\n    const [plan] = await db.select().from(plans).where(eq(plans.code, code as any));\n    return plan;\n  }\n\n  async createPlan(planData: InsertPlan): Promise<Plan> {\n    const [plan] = await db.insert(plans).values(planData).returning();\n    return plan;\n  }\n\n  async updatePlan(id: string, updates: Partial<InsertPlan>): Promise<Plan> {\n    const [plan] = await db\n      .update(plans)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(plans.id, id))\n      .returning();\n    return plan;\n  }\n\n  // Country Pricing Override operations\n  async getCountryPricingOverride(countryCode: string, planId: string): Promise<CountryPricingOverride | undefined> {\n    const now = new Date();\n    const [override] = await db\n      .select()\n      .from(countryPricingOverrides)\n      .where(\n        and(\n          eq(countryPricingOverrides.countryCode, countryCode),\n          eq(countryPricingOverrides.planId, planId),\n          lte(countryPricingOverrides.activeFrom, now),\n          or(\n            isNull(countryPricingOverrides.activeTo),\n            gte(countryPricingOverrides.activeTo, now)\n          )\n        )\n      );\n    return override;\n  }\n\n  async getCountryPricingOverridesByCountry(countryCode: string): Promise<CountryPricingOverride[]> {\n    const now = new Date();\n    return await db\n      .select()\n      .from(countryPricingOverrides)\n      .where(\n        and(\n          eq(countryPricingOverrides.countryCode, countryCode),\n          lte(countryPricingOverrides.activeFrom, now),\n          or(\n            isNull(countryPricingOverrides.activeTo),\n            gte(countryPricingOverrides.activeTo, now)\n          )\n        )\n      );\n  }\n\n  async getAllCountryPricingOverrides(): Promise<CountryPricingOverride[]> {\n    return await db\n      .select()\n      .from(countryPricingOverrides)\n      .orderBy(countryPricingOverrides.countryCode, countryPricingOverrides.planId);\n  }\n\n  async createCountryPricingOverride(overrideData: InsertCountryPricingOverride): Promise<CountryPricingOverride> {\n    const [override] = await db.insert(countryPricingOverrides).values(overrideData).returning();\n    return override;\n  }\n\n  async updateCountryPricingOverride(id: string, updates: Partial<InsertCountryPricingOverride>): Promise<CountryPricingOverride> {\n    const [override] = await db\n      .update(countryPricingOverrides)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(countryPricingOverrides.id, id))\n      .returning();\n    return override;\n  }\n\n  async deleteCountryPricingOverride(id: string): Promise<void> {\n    await db.delete(countryPricingOverrides).where(eq(countryPricingOverrides.id, id));\n  }\n\n  // Credit Bundle operations\n  async getCreditBundles(): Promise<CreditBundle[]> {\n    return await db.select().from(creditBundles).orderBy(creditBundles.sortOrder, creditBundles.credits);\n  }\n\n  async getActiveCreditBundles(): Promise<CreditBundle[]> {\n    return await db\n      .select()\n      .from(creditBundles)\n      .where(eq(creditBundles.isActive, true))\n      .orderBy(creditBundles.sortOrder, creditBundles.credits);\n  }\n\n  async getCreditBundle(id: string): Promise<CreditBundle | undefined> {\n    const [bundle] = await db.select().from(creditBundles).where(eq(creditBundles.id, id));\n    return bundle;\n  }\n\n  async createCreditBundle(bundleData: InsertCreditBundle): Promise<CreditBundle> {\n    const [bundle] = await db.insert(creditBundles).values(bundleData).returning();\n    return bundle;\n  }\n\n  async updateCreditBundle(id: string, updates: Partial<InsertCreditBundle>): Promise<CreditBundle> {\n    const [bundle] = await db\n      .update(creditBundles)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(creditBundles.id, id))\n      .returning();\n    return bundle;\n  }\n\n  async deleteCreditBundle(id: string): Promise<void> {\n    await db.delete(creditBundles).where(eq(creditBundles.id, id));\n  }\n\n  // Subscription operations\n  async createSubscription(subscriptionData: InsertSubscription): Promise<Subscription> {\n    const [subscription] = await db.insert(subscriptions).values(subscriptionData).returning();\n    return subscription;\n  }\n\n  async getSubscription(id: string): Promise<Subscription | undefined> {\n    const [subscription] = await db.select().from(subscriptions).where(eq(subscriptions.id, id));\n    return subscription;\n  }\n\n  async getSubscriptionByOrganization(organizationId: string): Promise<Subscription | undefined> {\n    const [subscription] = await db\n      .select()\n      .from(subscriptions)\n      .where(eq(subscriptions.organizationId, organizationId))\n      .orderBy(desc(subscriptions.createdAt))\n      .limit(1);\n    return subscription;\n  }\n\n  async getSubscriptionByStripeId(stripeSubscriptionId: string): Promise<Subscription | undefined> {\n    const [subscription] = await db\n      .select()\n      .from(subscriptions)\n      .where(eq(subscriptions.stripeSubscriptionId, stripeSubscriptionId));\n    return subscription;\n  }\n\n  async updateSubscription(id: string, updates: Partial<InsertSubscription>): Promise<Subscription> {\n    const [subscription] = await db\n      .update(subscriptions)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(subscriptions.id, id))\n      .returning();\n    return subscription;\n  }\n\n  async cancelSubscription(id: string): Promise<Subscription> {\n    const [subscription] = await db\n      .update(subscriptions)\n      .set({ \n        cancelAtPeriodEnd: true,\n        status: 'cancelled' as any,\n        updatedAt: new Date() \n      })\n      .where(eq(subscriptions.id, id))\n      .returning();\n    return subscription;\n  }\n\n  // Credit Batch operations\n  async createCreditBatch(batchData: InsertCreditBatch): Promise<CreditBatch> {\n    const [batch] = await db.insert(creditBatches).values(batchData as any).returning();\n    return batch;\n  }\n\n  async getCreditBatch(id: string): Promise<CreditBatch | undefined> {\n    const [batch] = await db.select().from(creditBatches).where(eq(creditBatches.id, id));\n    return batch;\n  }\n\n  async getCreditBatchesByOrganization(organizationId: string): Promise<CreditBatch[]> {\n    return await db\n      .select()\n      .from(creditBatches)\n      .where(eq(creditBatches.organizationId, organizationId))\n      .orderBy(desc(creditBatches.grantedAt));\n  }\n\n  async getAvailableCreditBatches(organizationId: string): Promise<CreditBatch[]> {\n    const now = new Date();\n    return await db\n      .select()\n      .from(creditBatches)\n      .where(\n        and(\n          eq(creditBatches.organizationId, organizationId),\n          sql`${creditBatches.remainingQuantity} > 0`,\n          or(\n            isNull(creditBatches.expiresAt),\n            gte(creditBatches.expiresAt, now)\n          )\n        )\n      )\n      .orderBy(creditBatches.expiresAt, creditBatches.grantedAt); // FIFO: oldest expiry first\n  }\n\n  async updateCreditBatch(id: string, updates: Partial<InsertCreditBatch>): Promise<CreditBatch> {\n    const [batch] = await db\n      .update(creditBatches)\n      .set({ ...updates, updatedAt: new Date() } as any)\n      .where(eq(creditBatches.id, id))\n      .returning();\n    return batch;\n  }\n\n  async expireCreditBatch(id: string): Promise<CreditBatch> {\n    const [batch] = await db\n      .update(creditBatches)\n      .set({ \n        remainingQuantity: 0,\n        updatedAt: new Date() \n      })\n      .where(eq(creditBatches.id, id))\n      .returning();\n    return batch;\n  }\n\n  // Credit Ledger operations\n  async createCreditLedgerEntry(entryData: InsertCreditLedger): Promise<CreditLedger> {\n    const [entry] = await db.insert(creditLedger).values(entryData).returning();\n    return entry;\n  }\n\n  async getCreditLedgerByOrganization(organizationId: string, limit: number = 100): Promise<any[]> {\n    const results = await db\n      .select({\n        id: creditLedger.id,\n        organizationId: creditLedger.organizationId,\n        createdBy: creditLedger.createdBy,\n        source: creditLedger.source,\n        quantity: creditLedger.quantity,\n        batchId: creditLedger.batchId,\n        unitCostMinorUnits: creditLedger.unitCostMinorUnits,\n        notes: creditLedger.notes,\n        linkedEntityType: creditLedger.linkedEntityType,\n        linkedEntityId: creditLedger.linkedEntityId,\n        createdAt: creditLedger.createdAt,\n        createdByUser: {\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n        },\n      })\n      .from(creditLedger)\n      .leftJoin(users, eq(creditLedger.createdBy, users.id))\n      .where(eq(creditLedger.organizationId, organizationId))\n      .orderBy(desc(creditLedger.createdAt))\n      .limit(limit);\n    \n    return results;\n  }\n\n  async getCreditBalance(organizationId: string): Promise<{ total: number; rolled: number; current: number; expiresOn: Date | null }> {\n    const now = new Date();\n    const batches = await db\n      .select()\n      .from(creditBatches)\n      .where(\n        and(\n          eq(creditBatches.organizationId, organizationId),\n          sql`${creditBatches.remainingQuantity} > 0`,\n          or(\n            isNull(creditBatches.expiresAt),\n            gte(creditBatches.expiresAt, now)\n          )\n        )\n      );\n\n    let total = 0;\n    let rolled = 0;\n    let current = 0;\n    let earliestExpiry: Date | null = null;\n\n    for (const batch of batches) {\n      total += batch.remainingQuantity;\n      if (batch.rolled) {\n        rolled += batch.remainingQuantity;\n      } else {\n        current += batch.remainingQuantity;\n      }\n      if (batch.expiresAt && (!earliestExpiry || batch.expiresAt < earliestExpiry)) {\n        earliestExpiry = batch.expiresAt;\n      }\n    }\n\n    return { total, rolled, current, expiresOn: earliestExpiry };\n  }\n\n  // Top-up Order operations\n  async createTopupOrder(orderData: InsertTopupOrder): Promise<TopupOrder> {\n    const [order] = await db.insert(topupOrders).values(orderData).returning();\n    return order;\n  }\n\n  async getTopupOrder(id: string): Promise<TopupOrder | undefined> {\n    const [order] = await db.select().from(topupOrders).where(eq(topupOrders.id, id));\n    return order;\n  }\n\n  async getTopupOrdersByOrganization(organizationId: string): Promise<TopupOrder[]> {\n    return await db\n      .select()\n      .from(topupOrders)\n      .where(eq(topupOrders.organizationId, organizationId))\n      .orderBy(desc(topupOrders.createdAt));\n  }\n\n  async updateTopupOrder(id: string, updates: Partial<InsertTopupOrder>): Promise<TopupOrder> {\n    const [order] = await db\n      .update(topupOrders)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(topupOrders.id, id))\n      .returning();\n    return order;\n  }\n\n  async updateFixfloHealthCheck(\n    organizationId: string, \n    updates: { lastHealthCheck: Date; healthCheckStatus: string; lastError: string | null; }\n  ): Promise<void> {\n    await db\n      .update(fixfloConfig)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(fixfloConfig.organizationId, organizationId));\n  }\n\n  async getFixfloSyncStates(organizationId: string): Promise<FixfloSyncState[]> {\n    return await db\n      .select()\n      .from(fixfloSyncState)\n      .where(eq(fixfloSyncState.organizationId, organizationId))\n      .orderBy(desc(fixfloSyncState.lastSyncAt));\n  }\n\n  async upsertFixfloSyncState(syncStateData: InsertFixfloSyncState): Promise<FixfloSyncState> {\n    const [syncState] = await db\n      .insert(fixfloSyncState)\n      .values(syncStateData)\n      .onConflictDoUpdate({\n        target: [fixfloSyncState.organizationId, fixfloSyncState.entityType],\n        set: {\n          ...syncStateData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return syncState;\n  }\n\n  async getFixfloWebhookLogs(organizationId: string, limit: number = 50): Promise<FixfloWebhookLog[]> {\n    return await db\n      .select()\n      .from(fixfloWebhookLogs)\n      .where(eq(fixfloWebhookLogs.organizationId, organizationId))\n      .orderBy(desc(fixfloWebhookLogs.createdAt))\n      .limit(limit);\n  }\n\n  async createFixfloWebhookLog(logData: InsertFixfloWebhookLog): Promise<FixfloWebhookLog> {\n    const [log] = await db\n      .insert(fixfloWebhookLogs)\n      .values(logData)\n      .returning();\n    return log;\n  }\n\n  async updateFixfloWebhookLog(id: string, updates: Partial<FixfloWebhookLog>): Promise<void> {\n    await db\n      .update(fixfloWebhookLogs)\n      .set(updates)\n      .where(eq(fixfloWebhookLogs.id, id));\n  }\n\n  // Knowledge Base operations\n  async createKnowledgeBaseDocument(docData: InsertKnowledgeBaseDocument): Promise<KnowledgeBaseDocument> {\n    const [doc] = await db\n      .insert(knowledgeBaseDocuments)\n      .values(docData)\n      .returning();\n    return doc;\n  }\n\n  async getKnowledgeBaseDocuments(activeOnly: boolean = true): Promise<KnowledgeBaseDocument[]> {\n    if (activeOnly) {\n      return await db\n        .select()\n        .from(knowledgeBaseDocuments)\n        .where(eq(knowledgeBaseDocuments.isActive, true))\n        .orderBy(desc(knowledgeBaseDocuments.createdAt));\n    }\n    return await db\n      .select()\n      .from(knowledgeBaseDocuments)\n      .orderBy(desc(knowledgeBaseDocuments.createdAt));\n  }\n\n  async getKnowledgeBaseDocument(id: string): Promise<KnowledgeBaseDocument | undefined> {\n    const [doc] = await db\n      .select()\n      .from(knowledgeBaseDocuments)\n      .where(eq(knowledgeBaseDocuments.id, id));\n    return doc;\n  }\n\n  async updateKnowledgeBaseDocument(id: string, updates: Partial<InsertKnowledgeBaseDocument>): Promise<KnowledgeBaseDocument> {\n    const [doc] = await db\n      .update(knowledgeBaseDocuments)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(knowledgeBaseDocuments.id, id))\n      .returning();\n    return doc;\n  }\n\n  async deleteKnowledgeBaseDocument(id: string): Promise<void> {\n    await db\n      .delete(knowledgeBaseDocuments)\n      .where(eq(knowledgeBaseDocuments.id, id));\n  }\n\n  async searchKnowledgeBase(query: string): Promise<KnowledgeBaseDocument[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await db\n      .select()\n      .from(knowledgeBaseDocuments)\n      .where(\n        and(\n          eq(knowledgeBaseDocuments.isActive, true),\n          or(\n            sql`LOWER(${knowledgeBaseDocuments.title}) LIKE ${searchTerm}`,\n            sql`LOWER(${knowledgeBaseDocuments.extractedText}) LIKE ${searchTerm}`,\n            sql`LOWER(${knowledgeBaseDocuments.category}) LIKE ${searchTerm}`\n          )\n        )\n      )\n      .orderBy(desc(knowledgeBaseDocuments.createdAt));\n  }\n\n  // Chat operations\n  async createChatConversation(conversationData: InsertChatConversation): Promise<ChatConversation> {\n    const [conversation] = await db\n      .insert(chatConversations)\n      .values(conversationData)\n      .returning();\n    return conversation;\n  }\n\n  async getChatConversationsByUser(userId: string): Promise<ChatConversation[]> {\n    return await db\n      .select()\n      .from(chatConversations)\n      .where(\n        and(\n          eq(chatConversations.userId, userId),\n          eq(chatConversations.isActive, true)\n        )\n      )\n      .orderBy(desc(chatConversations.updatedAt));\n  }\n\n  async getChatConversation(id: string): Promise<ChatConversation | undefined> {\n    const [conversation] = await db\n      .select()\n      .from(chatConversations)\n      .where(eq(chatConversations.id, id));\n    return conversation;\n  }\n\n  async updateChatConversation(id: string, updates: Partial<InsertChatConversation>): Promise<ChatConversation> {\n    const [conversation] = await db\n      .update(chatConversations)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(chatConversations.id, id))\n      .returning();\n    return conversation;\n  }\n\n  async createChatMessage(messageData: InsertChatMessage): Promise<ChatMessage> {\n    const [message] = await db\n      .insert(chatMessages)\n      .values(messageData)\n      .returning();\n    \n    await db\n      .update(chatConversations)\n      .set({ updatedAt: new Date() })\n      .where(eq(chatConversations.id, messageData.conversationId));\n    \n    return message;\n  }\n\n  async getChatMessages(conversationId: string): Promise<ChatMessage[]> {\n    return await db\n      .select()\n      .from(chatMessages)\n      .where(eq(chatMessages.conversationId, conversationId))\n      .orderBy(chatMessages.createdAt);\n  }\n\n  // Tenant operations\n  async getTenancyByTenantId(tenantId: string): Promise<any> {\n    const [tenancy] = await db\n      .select()\n      .from(tenantAssignments)\n      .where(eq(tenantAssignments.tenantId, tenantId))\n      .orderBy(desc(tenantAssignments.createdAt));\n    return tenancy;\n  }\n\n  async getTenantMaintenanceChats(tenantId: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(tenantMaintenanceChats)\n      .where(eq(tenantMaintenanceChats.tenantId, tenantId))\n      .orderBy(desc(tenantMaintenanceChats.createdAt));\n  }\n\n  async getMaintenanceChatById(chatId: string): Promise<any> {\n    const [chat] = await db\n      .select()\n      .from(tenantMaintenanceChats)\n      .where(eq(tenantMaintenanceChats.id, chatId));\n    return chat;\n  }\n\n  async getTenantMaintenanceChatMessages(chatId: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(tenantMaintenanceChatMessages)\n      .where(eq(tenantMaintenanceChatMessages.chatId, chatId))\n      .orderBy(tenantMaintenanceChatMessages.createdAt);\n  }\n\n  async createTenantMaintenanceChat(chatData: any): Promise<any> {\n    const [chat] = await db\n      .insert(tenantMaintenanceChats)\n      .values(chatData)\n      .returning();\n    return chat;\n  }\n\n  async createTenantMaintenanceChatMessage(messageData: any): Promise<any> {\n    const [message] = await db\n      .insert(tenantMaintenanceChatMessages)\n      .values(messageData)\n      .returning();\n    return message;\n  }\n\n  async updateTenantMaintenanceChat(chatId: string, updates: any): Promise<any> {\n    const [chat] = await db\n      .update(tenantMaintenanceChats)\n      .set(updates)\n      .where(eq(tenantMaintenanceChats.id, chatId))\n      .returning();\n    return chat;\n  }\n\n  async getMaintenanceRequestsByReporter(reporterId: string): Promise<MaintenanceRequest[]> {\n    return await db\n      .select()\n      .from(maintenanceRequests)\n      .where(eq(maintenanceRequests.reportedBy, reporterId))\n      .orderBy(desc(maintenanceRequests.createdAt));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":126684},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"design_guidelines.md":{"content":"# Inspect360 Design Guidelines\n\n## Design Approach\n**Modern SaaS Design System** inspired by Linear's clarity, Notion's airiness, and contemporary dashboard aesthetics. Bright cyan and teal brand palette from the Inspect360 logo with clean white surfaces, soft shadows, and generous breathing room. PWA-optimized for mobile-first inspection workflows with seamless light/dark mode transitions. Professional, calming, and effortlessly modern.\n\n## Color System\n\n### Light Mode (Primary)\n- **Bright Cyan Primary:** 174 100% 42% (#00D5CC - brand primary from Inspect360 logo, CTAs, primary buttons)\n- **Teal Accent:** 193 40% 38% (#3B7A8C - from Inspect360 logo house, links, interactive elements)\n- **Powder Cyan Background:** 174 30% 97% (subtle surface tints, hover states)\n- **White Surface:** 0 0% 100% (main backgrounds, cards)\n- **Warm Gray 50:** 30 10% 98% (alternative surface, subtle sections)\n- **Warm Gray 200:** 30 8% 90% (borders, dividers)\n- **Warm Gray 600:** 30 5% 45% (secondary text)\n- **Warm Gray 900:** 30 8% 15% (primary text, headings)\n\n### Dark Mode\n- **Bright Cyan Primary:** 174 100% 48% (adjusted brightness for dark contrast)\n- **Teal Accent:** 193 40% 45% (links, accents on dark)\n- **Dark Surface Base:** 220 15% 12% (main background)\n- **Dark Surface Elevated:** 220 13% 16% (cards, modals)\n- **Dark Surface Subtle:** 220 10% 20% (hover states, sections)\n- **Dark Border:** 220 10% 25% (dividers)\n- **Gray 400:** 30 5% 70% (secondary text on dark)\n- **Gray 50:** 0 0% 98% (primary text on dark)\n\n## Typography\n\n**Font:** Inter, system-ui, sans-serif\n\n**Scale:**\n- **Display:** 48px/1.1, weight 600, -0.02em tracking\n- **H1:** 36px/1.2, weight 600\n- **H2:** 28px/1.3, weight 600\n- **H3:** 22px/1.4, weight 600\n- **H4:** 18px/1.5, weight 500\n- **Body Large:** 16px/1.6, weight 400\n- **Body:** 15px/1.6, weight 400\n- **Small:** 14px/1.5, weight 400\n- **Caption:** 13px/1.4, weight 500\n\n## Layout System\n\n**Spacing Primitives:** Tailwind units 3, 4, 6, 8, 12, 16, 20, 24\n- Card padding: p-6 (mobile), p-8 (desktop)\n- Section spacing: py-12 (mobile), py-20 (desktop)\n- Component gaps: gap-6 standard, gap-8 generous\n- Grid gaps: gap-4 (compact), gap-6 (relaxed)\n\n**Container:** Max 1280px, px-4 (mobile), px-6 (tablet), px-8 (desktop)\n\n**Navigation:**\n- Desktop: Left sidebar 256px, clean white with sky blue active states\n- Mobile: Bottom tab bar (PWA), sky blue icons for active\n- Top bar: Search, \"New Inspection\" CTA, org switcher, avatar\n\n## Component Design\n\n### Cards\n- White background (light) / Dark elevated (dark)\n- Border radius: 0.75rem (12px)\n- Soft shadow: `shadow-[0_2px_8px_rgba(0,0,0,0.04)]` (light), `shadow-[0_2px_12px_rgba(0,0,0,0.3)]` (dark)\n- Border: 1px warm-gray-200 (light) / dark-border (dark)\n- Hover: Lift shadow `shadow-[0_4px_16px_rgba(0,0,0,0.08)]`, translate -1px\n\n### Buttons\n**Primary (Sky Blue):**\n- Sky blue background, white text, weight 500\n- Pill-shaped: `rounded-full`\n- Padding: px-6 py-3 (desktop), px-5 py-2.5 (mobile)\n- Hover: Darken to `199 79% 56%`, no scale\n- Active: Darken further to `199 79% 50%`\n\n**Secondary:**\n- Cobalt text, transparent background, cobalt border (1px)\n- Pill-shaped, same padding\n- Hover: Powder blue background fill\n\n**Ghost on Images:**\n- White/10 background, white text, white/30 border\n- Backdrop blur: `backdrop-blur-md`\n- No custom hover states (inherits Button defaults)\n\n**Icon Buttons:** 44x44px minimum, circular, hover fills with powder blue\n\n### Inputs\n- 48px height minimum (touch-friendly)\n- Rounded: 0.75rem (matches cards)\n- Border: warm-gray-200, focus ring sky blue (2px)\n- Floating labels, permanent visibility on focus\n- Helper text: warm-gray-600\n\n### Badges\n- Pill-shaped (`rounded-full`), px-3 py-1\n- Sky blue: General info/pending\n- Cobalt: Links, clickable\n- Green (145 60% 50%): Success/completed\n- Amber (35 90% 55%): Warnings\n- Red (0 80% 55%): Critical\n\n### Data Displays\n- Charts: Cobalt primary, sky blue secondary\n- Tables: Alternating row tint (powder blue/5%)\n- Minimal grid lines (warm-gray-200)\n\n## Visual Language\n\n**Shadows:** Soft, layered depth\n- Resting cards: 0_2px_8px_rgba(0,0,0,0.04)\n- Hover cards: 0_4px_16px_rgba(0,0,0,0.08)\n- Modals: 0_8px_32px_rgba(0,0,0,0.12)\n- Floating elements: 0_12px_48px_rgba(0,0,0,0.15)\n\n**Spacing Philosophy:** Generous whitespace, never cramped\n- Minimum 24px between major sections\n- Card groups: gap-6 default\n- Dense data tables: Tighter spacing acceptable (gap-3)\n\n**Micro-Interactions:**\n- Fast, subtle: 150ms transitions\n- Button press: No scale transforms (clean, direct)\n- Card hover: Subtle lift only\n- Loading: Skeleton shimmer (sky blue tint)\n- Success: Checkmark draw + green badge fade-in\n\n## Key Screens\n\n### Dashboard (Owner)\n- Hero: Full-width image (60vh) of modern BTR property, soft gradient overlay (white to transparent), centered white text with shadow\n- KPI cards: 3-column grid (desktop), white cards with sky blue accent bars on left edge\n- Credits widget: Prominent sky blue card with cobalt badge for count\n- Charts: Cobalt lines/bars in white card containers\n\n### Clerk Mobile (PWA)\n- Full-screen card stack for inspections\n- Large sky blue \"Start Inspection\" pill button\n- Swipe gestures for completion\n- Photo capture: White overlay controls with backdrop blur\n- Offline banner: Sky blue with white text\n\n### Compliance Center\n- Timeline: Vertical with cobalt connecting line\n- Document cards: White with colored left border (green=ok, amber=soon, red=overdue)\n- Upload modal: Bottom sheet (mobile), centered modal (desktop), white with soft shadow\n\n### Tenant Portal\n- Multi-step form: Sky blue progress dots\n- Comparison viewer: Side-by-side white cards, cobalt divider\n- Comments: WhatsApp-style bubbles, sky blue for user, warm-gray-50 for others\n\n## Images\n\n**Placement:**\n- Landing hero: Full-bleed professional building photo (60vh), white text overlay, gradient fade to white\n- Feature sections: Alternating layout, rounded 0.75rem images\n- Dashboard: Optional subtle background pattern (10% opacity max)\n- Empty states: Simple line illustrations in sky blue/cobalt\n- Mobile: Minimize decorative images, functional clarity prioritized\n\n**Style:** Clean, bright professional photography of modern buildings, inspection tools, well-maintained interiors\n\n## Accessibility\n\n**Contrast:** WCAG AA minimum\n- Sky blue on white: 3.1:1 (backgrounds only, use white text on sky blue: 4.8:1)\n- Cobalt on white: 4.5:1 \n- Warm-gray-900 on white: 12:1 \n\n**Focus:** Sky blue ring (2px), offset 2px, visible on all interactive elements\n\n**PWA:** \n- Offline banner at top (sky blue)\n- Install prompt: Bottom sheet with sky blue CTA\n- Splash: White background, sky blue logo\n- App icon: Sky blue gradient\n\n## Voice & Microcopy\n\n**CTAs:** \"Start Inspection\", \"Create Comparison\", \"Upload Documents\", \"Invite Team\"\n\n**Empty:** \"No inspections scheduledcreate one to get started.\"\n\n**Alerts:** \"12 credits remainingconsider upgrading to avoid interruption.\"\n\n**Success:** \"Inspection complete! Syncing data...\"","size_bytes":7007},"client/src/pages/Credits.tsx":{"content":"import { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CreditCard, Plus, Minus } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\nexport default function Credits() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const locale = useLocale();\n  const [selectedCredits, setSelectedCredits] = useState(10);\n\n  const { data: transactions = [] } = useQuery({\n    queryKey: [\"/api/credits/transactions\"],\n  });\n\n  const checkout = useMutation({\n    mutationFn: async (credits: number) => {\n      return await apiRequest(\"/api/stripe/create-checkout\", \"POST\", { credits });\n    },\n    onSuccess: (data: any) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create checkout session\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const creditOptions = [\n    { amount: 10, price: 10, popular: false },\n    { amount: 50, price: 45, popular: true, discount: \"10% off\" },\n    { amount: 100, price: 80, popular: false, discount: \"20% off\" },\n  ];\n\n  const creditsRemaining = user?.organization?.creditsRemaining || 0;\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Inspection Credits</h1>\n        <p className=\"text-muted-foreground\">Manage your AI analysis credits</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CreditCard className=\"w-5 h-5\" />\n            Current Balance\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-4xl font-bold text-primary\" data-testid=\"text-credits-balance\">\n            {creditsRemaining} credits\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-2\">\n            Each credit allows for one AI photo analysis or comparison\n          </p>\n        </CardContent>\n      </Card>\n\n      <div>\n        <h2 className=\"text-2xl font-semibold mb-4\">Purchase Credits</h2>\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          {creditOptions.map((option) => (\n            <Card\n              key={option.amount}\n              className={`relative ${\n                option.popular ? \"border-accent border-2\" : \"\"\n              }`}\n            >\n              {option.popular && (\n                <Badge className=\"absolute -top-2 left-1/2 -translate-x-1/2 bg-accent\">\n                  Most Popular\n                </Badge>\n              )}\n              <CardHeader>\n                <CardTitle className=\"text-center\">\n                  {option.amount} Credits\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"text-center\">\n                  <div className=\"text-3xl font-bold\">{locale.formatCurrency(option.price * 100, false)}</div>\n                  {option.discount && (\n                    <Badge variant=\"secondary\" className=\"mt-2\">\n                      {option.discount}\n                    </Badge>\n                  )}\n                </div>\n                <Button\n                  className=\"w-full bg-primary\"\n                  onClick={() => checkout.mutate(option.amount)}\n                  disabled={checkout.isPending}\n                  data-testid={`button-purchase-${option.amount}`}\n                >\n                  Purchase\n                </Button>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Transaction History</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {transactions.length === 0 ? (\n            <p className=\"text-muted-foreground\">No transactions yet</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {transactions.map((transaction: any) => (\n                <div\n                  key={transaction.id}\n                  className=\"flex items-center justify-between p-3 border rounded-md\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    {transaction.amount > 0 ? (\n                      <Plus className=\"w-4 h-4 text-accent\" />\n                    ) : (\n                      <Minus className=\"w-4 h-4 text-muted-foreground\" />\n                    )}\n                    <div>\n                      <p className=\"font-medium\">{transaction.description}</p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {new Date(transaction.createdAt).toLocaleDateString()}\n                      </p>\n                    </div>\n                  </div>\n                  <div\n                    className={`font-semibold ${\n                      transaction.amount > 0 ? \"text-accent\" : \"text-muted-foreground\"\n                    }`}\n                  >\n                    {transaction.amount > 0 ? \"+\" : \"\"}\n                    {transaction.amount}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":5537},"server/objectStorage.ts":{"content":"// Local file system storage implementation\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport { promises as fs } from \"fs\";\nimport { join, dirname } from \"path\";\nimport { createReadStream, createWriteStream } from \"fs\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\n// Local file wrapper that mimics GCS File interface\nexport class LocalFile {\n  public name: string;\n  private filePath: string;\n  private metadataPath: string;\n\n  constructor(filePath: string) {\n    this.filePath = filePath;\n    this.name = filePath;\n    // Store metadata in a separate .meta.json file\n    this.metadataPath = `${filePath}.meta.json`;\n  }\n\n  async exists(): Promise<[boolean]> {\n    try {\n      await fs.access(this.filePath);\n      return [true];\n    } catch {\n      return [false];\n    }\n  }\n\n  async getMetadata(): Promise<[any]> {\n    const [exists] = await this.exists();\n    if (!exists) {\n      throw new Error(`File not found: ${this.filePath}`);\n    }\n\n    const stats = await fs.stat(this.filePath);\n    let metadata: any = {\n      size: stats.size,\n      contentType: this.getContentType(this.filePath),\n      updated: stats.mtime.toISOString(),\n    };\n\n    // Load custom metadata if it exists\n    try {\n      const metaData = await fs.readFile(this.metadataPath, 'utf-8');\n      const customMeta = JSON.parse(metaData);\n      metadata = { ...metadata, metadata: customMeta };\n    } catch {\n      // No custom metadata, that's fine\n    }\n\n    return [metadata];\n  }\n\n  async setMetadata(metadata: { metadata?: Record<string, string> }): Promise<void> {\n    if (metadata.metadata) {\n      // Store custom metadata in .meta.json file\n      await fs.mkdir(dirname(this.metadataPath), { recursive: true });\n      await fs.writeFile(this.metadataPath, JSON.stringify(metadata.metadata, null, 2));\n    }\n  }\n\n  createReadStream(): NodeJS.ReadableStream {\n    return createReadStream(this.filePath);\n  }\n\n  createWriteStream(): NodeJS.WritableStream {\n    return createWriteStream(this.filePath);\n  }\n\n  private getContentType(filePath: string): string {\n    const ext = filePath.split('.').pop()?.toLowerCase();\n    const contentTypes: Record<string, string> = {\n      'jpg': 'image/jpeg',\n      'jpeg': 'image/jpeg',\n      'png': 'image/png',\n      'gif': 'image/gif',\n      'webp': 'image/webp',\n      'pdf': 'application/pdf',\n      'doc': 'application/msword',\n      'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n      'txt': 'text/plain',\n      'json': 'application/json',\n    };\n    return contentTypes[ext || ''] || 'application/octet-stream';\n  }\n}\n\n// Get storage directory from environment or use default\nfunction getStorageDir(): string {\n  const storageDir = process.env.LOCAL_STORAGE_DIR || './storage';\n  return storageDir;\n}\n\n// Ensure storage directory exists\nasync function ensureStorageDir(): Promise<string> {\n  const storageDir = getStorageDir();\n  await fs.mkdir(storageDir, { recursive: true });\n  \n  // Ensure subdirectories exist\n  const privateDir = join(storageDir, process.env.PRIVATE_OBJECT_DIR || 'private');\n  await fs.mkdir(privateDir, { recursive: true });\n  \n  const publicPaths = (process.env.PUBLIC_OBJECT_SEARCH_PATHS || 'public').split(',');\n  for (const path of publicPaths) {\n    const publicDir = join(storageDir, path.trim());\n    await fs.mkdir(publicDir, { recursive: true });\n  }\n  \n  return storageDir;\n}\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      // Default to public directory in storage\n      return ['public'];\n    }\n    return paths;\n  }\n\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"private\";\n    return dir;\n  }\n\n  async searchPublicObject(filePath: string): Promise<LocalFile | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = join(getStorageDir(), searchPath, filePath);\n      const file = new LocalFile(fullPath);\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n    return null;\n  }\n\n  async downloadObject(file: LocalFile, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      \n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${\n          isPublic ? \"public\" : \"private\"\n        }, max-age=${cacheTtlSec}`,\n      });\n\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityUploadURL(): Promise<string> {\n    // Return a direct upload endpoint URL instead of signed URL\n    // The client will POST to this endpoint with the file\n    const objectId = randomUUID();\n    // Return full URL path that the client can use\n    return `/api/objects/upload-direct?objectId=${objectId}`;\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<LocalFile> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    const privateObjectDir = this.getPrivateObjectDir();\n    const fullPath = join(getStorageDir(), privateObjectDir, entityId);\n    const file = new LocalFile(fullPath);\n    \n    const [exists] = await file.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return file;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    // If it's already a normalized path, return it\n    if (rawPath.startsWith(\"/objects/\")) {\n      return rawPath;\n    }\n\n    // If it's a local file path, convert it\n    if (rawPath.startsWith(getStorageDir())) {\n      const relativePath = rawPath.replace(getStorageDir(), '').replace(/^[\\/\\\\]/, '');\n      const privateObjectDir = this.getPrivateObjectDir();\n      \n      if (relativePath.startsWith(privateObjectDir + '/')) {\n        const entityId = relativePath.slice(privateObjectDir.length + 1);\n        return `/objects/${entityId}`;\n      }\n    }\n\n    // If it's a URL, try to extract the path\n    try {\n      const url = new URL(rawPath);\n      if (url.pathname.startsWith('/objects/')) {\n        return url.pathname;\n      }\n    } catch {\n      // Not a valid URL, continue\n    }\n\n    return rawPath;\n  }\n\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/objects/\")) {\n      return normalizedPath;\n    }\n\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  async canAccessObjectEntity({\n    userId,\n    objectFile,\n    requestedPermission,\n  }: {\n    userId?: string;\n    objectFile: LocalFile;\n    requestedPermission?: ObjectPermission;\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n    });\n  }\n\n  // Helper method to save uploaded file\n  async saveUploadedFile(objectId: string, fileBuffer: Buffer, contentType?: string): Promise<string> {\n    await ensureStorageDir();\n    const privateObjectDir = this.getPrivateObjectDir();\n    const fileName = `${objectId}`;\n    const fullPath = join(getStorageDir(), privateObjectDir, fileName);\n    \n    // Ensure directory exists\n    await fs.mkdir(dirname(fullPath), { recursive: true });\n    \n    // Write file\n    await fs.writeFile(fullPath, fileBuffer);\n    \n    // Return normalized path\n    return `/objects/${fileName}`;\n  }\n}\n","size_bytes":8866},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-[60] grid w-full max-w-lg max-h-[85vh] translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 overflow-y-auto data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3879},"client/src/hooks/use-toast.ts":{"content":"import { useState, useEffect, type ReactNode } from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: ReactNode\n  description?: ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = useState<State>(memoryState)\n\n  useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3900},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"server/index.ts":{"content":"import \"dotenv/config\";\nimport express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = process.env.PORT ? parseInt(process.env.PORT, 10) : 5000;\n  // Use localhost on Windows, 0.0.0.0 on Unix systems (for Replit compatibility)\n  const host = process.env.HOST || (process.platform === \"win32\" ? \"localhost\" : \"0.0.0.0\");\n  \n  // Use traditional listen format for better Windows compatibility\n  // Windows doesn't support reusePort option\n  if (process.platform === \"win32\") {\n    server.listen(port, host, () => {\n      log(`serving on http://${host}:${port}`);\n    });\n  } else {\n    // Unix systems can use the options object with reusePort\n    server.listen({\n      port,\n      host,\n      reusePort: true,\n    }, () => {\n      log(`serving on http://${host}:${port}`);\n    });\n  }\n})();\n","size_bytes":2620},"replit.md":{"content":"# Inspect360 - AI-Powered Building Inspection Platform\n\n## Overview\nInspect360 is a PWA-first AI-powered building inspection platform designed to optimize Build-to-Rent (BTR) operations. It offers features such as role-based access, offline mobile inspections, AI-driven photo analysis and comparison reporting, compliance tracking with expiry alerts, a dedicated tenant portal, internal maintenance tracking, and a comprehensive subscription system with multi-currency support. The platform aims to streamline property management and enhance operational efficiency through its advanced AI capabilities and user-centric design.\n\n## User Preferences\n- Prioritize PWA-first mobile experience\n- Inspect360 branded color scheme: Bright Cyan (#00D5CC / HSL 174 100% 42%) primary, Teal (#3B7A8C / HSL 193 40% 38%) accents\n- Logo: attached_assets/Inspect360 Logo_1761302629835.png (bright cyan magnifying glass with teal house icon)\n- Clean, accessible enterprise UI with generous white space\n- Role-based feature access\n- Offline support for field inspections\n\n## System Architecture\nThe platform is built on a robust web architecture with a PWA-first approach, emphasizing a modern design system and branded color palette.\n\n### UI/UX Decisions\n- **Modern Clean Design System**: Utilizes Inter font, clean cards, soft shadows, subtle hover effects, and skeleton loaders with cyan shimmer.\n- **Color Scheme**: Bright Cyan for primary CTAs, Teal for accents/links, with white backgrounds and warm gray neutrals.\n- **Branding**: Prominent Inspect360 logo, responsive left sidebar navigation, and a top bar.\n\n### Technical Implementations\n- **Frontend**: React with TypeScript, Vite, Wouter, TanStack Query, Shadcn UI, Tailwind CSS.\n- **Backend**: Express.js, PostgreSQL with Drizzle ORM, Passport.js for authentication.\n- **Authentication**: Custom username/password authentication with session management, role-based access, and automated organization provisioning for self-registrations.\n- **Object Storage**: Google Cloud Storage for media files.\n- **Database Schema**: Comprehensive schema covering users, organizations, properties, inspections, compliance, maintenance, assets, and more.\n- **Role-Based Access**: Granular control ensuring multi-layer security and data isolation for different user roles (e.g., Inspection Clerks, Owners).\n- **Credit System**: Stripe-integrated, credit-based subscription model with multi-currency support and an Eco-Admin dashboard for plan and bundle management.\n- **AI Features**: Integration with OpenAI GPT-5 Vision for context-aware photo analysis, comparison reporting, maintenance triage, and an intelligent chatbot with knowledge base integration.\n- **PWA**: `manifest.json` and service worker for offline capabilities, caching, and install prompts.\n- **Inspection Templates System**: JSON-based templates with a flexible editor, versioning, and default BTR templates.\n- **Inspection Capture Workflow**: Comprehensive field inspection workflow with optimistic updates, review pages, native camera capture, and quick actions.\n- **Offline Queue System**: LocalStorage-based offline sync for inspection entries, assets, and maintenance requests.\n- **AI-Powered Tenant Maintenance Requests**: Multi-step tenant portal with AI-powered fix suggestions and image upload.\n- **Compliance Document Upload System**: Robust system with multi-layer error handling, state management, user feedback, and calendar popover for expiry dates.\n- **Collaborative Comparison Reports**: End-to-end check-out inspection comparison with AI analysis, asset-based depreciation, and electronic signatures.\n- **Team-Based Work Order Management**: System for work order assignment, notifications, and analytics with contractor email support.\n- **AI Chatbot with Knowledge Base**: Features knowledge base management (uploading PDF, DOCX, TXT), a GPT-5 powered chatbot with conversation history, and knowledge base-enhanced responses.\n- **Tag-Based Filtering System**: Reusable component for multi-select tag filtering across Blocks, Properties, and Tenant Assignments.\n- **Professional BTR Reports System**: Centralized reports hub with fully functional Inspections and Blocks reports, multi-criteria filtering, summary statistics, and server-side PDF export with branded cover pages using Puppeteer.\n- **Tenant Portal**: Dedicated PWA-first portal with separate authentication, a home dashboard, an AI preventative maintenance chatbot, and maintenance request tracking.\n\n## External Dependencies\n- **PostgreSQL (Neon)**: Primary database.\n- **OpenAI Vision API**: AI photo analysis, comparison, and chatbot.\n- **Stripe**: Payment processing for subscriptions and credits.\n- **Google Cloud Storage**: Object storage for media files.\n- **Resend**: Email service.\n- **Passport.js**: Authentication middleware.\n- **Drizzle ORM**: TypeScript ORM.\n- **Vite**: Frontend build tool.\n- **Wouter**: Frontend routing library.\n- **TanStack Query**: Data fetching and caching.\n- **Shadcn UI**: UI component library.\n- **Tailwind CSS**: Utility-first CSS framework.\n- **Uppy**: File upload library.\n- **Puppeteer**: Headless browser for server-side PDF generation.","size_bytes":5158},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-[70] max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5743},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE - Inspect360 Cyan/Teal Theme */\n:root {\n  --button-outline: rgba(0,0,0, .08);\n  --badge-outline: rgba(0,0,0, .04);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -6; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .02);\n  --elevate-2: rgba(0,0,0, .05);\n\n  /* Main backgrounds */\n  --background: 0 0% 100%;\n  --foreground: 30 8% 15%;\n\n  /* Borders */\n  --border: 30 8% 90%;\n\n  /* Cards - clean white */\n  --card: 0 0% 100%;\n  --card-foreground: 30 8% 15%;\n  --card-border: 30 8% 92%;\n\n  /* Sidebar - very light */\n  --sidebar: 0 0% 100%;\n  --sidebar-foreground: 30 8% 15%;\n  --sidebar-border: 30 8% 90%;\n  --sidebar-primary: 174 100% 42%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 174 30% 97%;\n  --sidebar-accent-foreground: 193 40% 38%;\n  --sidebar-ring: 174 100% 42%;\n\n  /* Popovers */\n  --popover: 0 0% 100%;\n  --popover-foreground: 30 8% 15%;\n  --popover-border: 30 8% 90%;\n\n  /* Primary - Bright Cyan (from Inspect360 logo) */\n  --primary: 174 100% 42%;\n  --primary-foreground: 0 0% 100%;\n\n  /* Secondary - Soft gray */\n  --secondary: 30 8% 92%;\n  --secondary-foreground: 30 8% 20%;\n\n  /* Muted */\n  --muted: 30 8% 95%;\n  --muted-foreground: 30 5% 45%;\n\n  /* Accent - Teal (from Inspect360 logo house) */\n  --accent: 193 40% 38%;\n  --accent-foreground: 0 0% 100%;\n\n  /* Destructive */\n  --destructive: 0 80% 55%;\n  --destructive-foreground: 0 0% 100%;\n\n  /* Input & Ring */\n  --input: 30 8% 88%;\n  --ring: 174 100% 42%;\n\n  /* Charts - Cyan/Teal Palette */\n  --chart-1: 174 100% 42%;\n  --chart-2: 193 40% 38%;\n  --chart-3: 145 60% 50%;\n  --chart-4: 35 90% 55%;\n  --chart-5: 280 60% 60%;\n\n  /* Typography */\n  --font-sans: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;\n\n  /* Border Radius */\n  --radius: 0.75rem; /* 12px - clean, modern */\n\n  /* Soft Shadows */\n  --shadow-2xs: 0 1px 2px 0 rgb(0 0 0 / 0.02);\n  --shadow-xs: 0 1px 3px 0 rgb(0 0 0 / 0.04), 0 1px 2px -1px rgb(0 0 0 / 0.02);\n  --shadow-sm: 0 2px 8px 0 rgb(0 0 0 / 0.04);\n  --shadow: 0 4px 12px -1px rgb(0 0 0 / 0.06), 0 2px 4px -2px rgb(0 0 0 / 0.03);\n  --shadow-md: 0 6px 16px -2px rgb(0 0 0 / 0.08), 0 3px 6px -3px rgb(0 0 0 / 0.04);\n  --shadow-lg: 0 8px 20px -4px rgb(0 0 0 / 0.10), 0 4px 8px -4px rgb(0 0 0 / 0.05);\n  --shadow-xl: 0 12px 28px -6px rgb(0 0 0 / 0.12), 0 6px 12px -6px rgb(0 0 0 / 0.06);\n  --shadow-2xl: 0 20px 40px -8px rgb(0 0 0 / 0.14), 0 8px 16px -8px rgb(0 0 0 / 0.07);\n\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* DARK MODE - Maintains clean aesthetic with proper contrast */\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 8;\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .03);\n  --elevate-2: rgba(255,255,255, .07);\n\n  /* Main backgrounds */\n  --background: 220 15% 12%;\n  --foreground: 0 0% 98%;\n\n  /* Borders */\n  --border: 220 10% 25%;\n\n  /* Cards */\n  --card: 220 13% 16%;\n  --card-foreground: 0 0% 98%;\n  --card-border: 220 10% 22%;\n\n  /* Sidebar */\n  --sidebar: 220 13% 16%;\n  --sidebar-foreground: 0 0% 98%;\n  --sidebar-border: 220 10% 25%;\n  --sidebar-primary: 174 100% 48%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 220 10% 20%;\n  --sidebar-accent-foreground: 174 100% 48%;\n  --sidebar-ring: 174 100% 48%;\n\n  /* Popovers */\n  --popover: 220 13% 16%;\n  --popover-foreground: 0 0% 98%;\n  --popover-border: 220 10% 25%;\n\n  /* Primary - Bright Cyan (adjusted for dark mode) */\n  --primary: 174 100% 48%;\n  --primary-foreground: 0 0% 100%;\n\n  /* Secondary */\n  --secondary: 220 10% 20%;\n  --secondary-foreground: 0 0% 95%;\n\n  /* Muted */\n  --muted: 220 10% 18%;\n  --muted-foreground: 30 5% 70%;\n\n  /* Accent - Teal (adjusted for dark mode) */\n  --accent: 193 40% 45%;\n  --accent-foreground: 0 0% 100%;\n\n  /* Destructive */\n  --destructive: 0 80% 60%;\n  --destructive-foreground: 0 0% 100%;\n\n  /* Input & Ring */\n  --input: 220 10% 30%;\n  --ring: 174 100% 48%;\n\n  /* Charts - Adjusted for dark */\n  --chart-1: 174 100% 48%;\n  --chart-2: 193 40% 45%;\n  --chart-3: 145 60% 58%;\n  --chart-4: 35 90% 60%;\n  --chart-5: 280 60% 68%;\n\n  /* Darker shadows */\n  --shadow-2xs: 0 1px 2px 0 rgb(0 0 0 / 0.30);\n  --shadow-xs: 0 1px 3px 0 rgb(0 0 0 / 0.40), 0 1px 2px -1px rgb(0 0 0 / 0.30);\n  --shadow-sm: 0 2px 8px 0 rgb(0 0 0 / 0.50);\n  --shadow: 0 4px 12px -1px rgb(0 0 0 / 0.55), 0 2px 4px -2px rgb(0 0 0 / 0.40);\n  --shadow-md: 0 6px 16px -2px rgb(0 0 0 / 0.60), 0 3px 6px -3px rgb(0 0 0 / 0.45);\n  --shadow-lg: 0 8px 20px -4px rgb(0 0 0 / 0.65), 0 4px 8px -4px rgb(0 0 0 / 0.50);\n  --shadow-xl: 0 12px 28px -6px rgb(0 0 0 / 0.70), 0 6px 12px -6px rgb(0 0 0 / 0.55);\n  --shadow-2xl: 0 20px 40px -8px rgb(0 0 0 / 0.75), 0 8px 16px -8px rgb(0 0 0 / 0.60);\n\n  /* Automatically computed borders */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Elevation System - Automatic contrast adjustment\n * \n * Usage:\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n */\n@layer utilities {\n\n  /* Hide search cancel button in Chrome */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* Escape hatches for default elevation */\n  .no-default-hover-elevate {}\n  .no-default-active-elevate {}\n\n  /* Toggle elevation system */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Hover/active elevation system */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* Clean Card System (replaces glassmorphic) */\n  .clean-card {\n    @apply bg-card border border-card-border shadow-sm rounded-xl;\n  }\n\n  .clean-card-hover {\n    @apply clean-card transition-all duration-200 ease-out;\n  }\n\n  .clean-card-hover:hover {\n    @apply shadow-md -translate-y-0.5;\n  }\n\n  /* Modern Transitions */\n  .transition-smooth {\n    @apply transition-all duration-200 ease-out;\n  }\n\n  .transition-fast {\n    @apply transition-all duration-150 ease-out;\n  }\n\n  /* Focus Ring */\n  .focus-ring {\n    @apply focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2;\n  }\n\n  /* Skeleton Loader with Shimmer */\n  @keyframes shimmer {\n    0% {\n      background-position: -1000px 0;\n    }\n    100% {\n      background-position: 1000px 0;\n    }\n  }\n\n  .skeleton {\n    @apply bg-muted rounded animate-pulse;\n    background-image: linear-gradient(\n      90deg,\n      hsl(var(--muted)) 0px,\n      hsl(174 100% 42% / 0.1) 40px,\n      hsl(var(--muted)) 80px\n    );\n    background-size: 1000px 100%;\n    animation: shimmer 2s infinite linear;\n  }\n\n  /* Uppy Modal Customization */\n  .uppy-Dashboard-inner {\n    background-color: hsl(var(--background)) !important;\n    border: 1px solid hsl(var(--border)) !important;\n    border-radius: var(--radius) !important;\n  }\n\n  .uppy-Dashboard-AddFiles {\n    border-color: hsl(var(--border)) !important;\n  }\n\n  .uppy-Dashboard-AddFiles-title {\n    color: hsl(var(--foreground)) !important;\n  }\n\n  .uppy-DashboardTab {\n    background-color: hsl(var(--card)) !important;\n    border: 1px solid hsl(var(--border)) !important;\n    border-radius: 0.5rem !important;\n    color: hsl(var(--foreground)) !important;\n    transition: all 150ms ease-out;\n  }\n\n  .uppy-DashboardTab:hover {\n    background-color: hsl(var(--accent)) !important;\n    color: hsl(var(--accent-foreground)) !important;\n    border-color: hsl(var(--accent)) !important;\n  }\n\n  .uppy-DashboardTab-btn {\n    display: flex !important;\n    flex-direction: column !important;\n    align-items: center !important;\n    gap: 0.5rem !important;\n    padding: 1.5rem 2rem !important;\n  }\n\n  .uppy-DashboardTab-name {\n    font-weight: 500 !important;\n    font-size: 0.875rem !important;\n  }\n\n  /* Make tabs display side by side on larger screens */\n  .uppy-Dashboard-AddFilesPanel {\n    display: flex !important;\n    flex-direction: column !important;\n    gap: 1.5rem !important;\n  }\n\n  .uppy-DashboardTabs {\n    display: grid !important;\n    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;\n    gap: 1rem !important;\n  }\n\n  @media (min-width: 640px) {\n    .uppy-DashboardTabs {\n      grid-template-columns: repeat(2, 1fr) !important;\n    }\n  }\n\n  .uppy-Dashboard-poweredBy {\n    display: none !important;\n  }\n\n  .uppy-StatusBar {\n    background-color: hsl(var(--muted)) !important;\n    border-top: 1px solid hsl(var(--border)) !important;\n  }\n\n  .uppy-StatusBar-progress {\n    background-color: hsl(var(--primary)) !important;\n  }\n\n  .uppy-size--md .uppy-Dashboard-AddFiles {\n    padding: 2rem !important;\n  }\n\n  /* Ensure Uppy modal has correct z-index and doesn't block parent dialog */\n  .uppy-Dashboard--modal {\n    z-index: 10001 !important;\n  }\n\n  .uppy-Dashboard--modal .uppy-Dashboard-overlay {\n    z-index: 10000 !important;\n  }\n}\n","size_bytes":13326},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","size_bytes":116},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport NotFound from \"@/pages/not-found\";\nimport Landing from \"@/pages/Landing\";\nimport Auth from \"@/pages/Auth\";\nimport ForgotPassword from \"@/pages/ForgotPassword\";\nimport ResetPassword from \"@/pages/ResetPassword\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport Properties from \"@/pages/Properties\";\nimport PropertyDetail from \"@/pages/PropertyDetail\";\nimport Credits from \"@/pages/Credits\";\nimport Billing from \"@/pages/Billing\";\nimport Profile from \"@/pages/Profile\";\nimport Inspections from \"@/pages/Inspections\";\nimport InspectionDetail from \"@/pages/InspectionDetail\";\nimport Compliance from \"@/pages/Compliance\";\nimport Maintenance from \"@/pages/Maintenance\";\nimport Analytics from \"@/pages/Analytics\";\nimport Reports from \"@/pages/Reports\";\nimport InspectionsReport from \"@/pages/InspectionsReport\";\nimport BlocksReport from \"@/pages/BlocksReport\";\nimport PropertiesReport from \"@/pages/PropertiesReport\";\nimport TenantsReport from \"@/pages/TenantsReport\";\nimport InventoryReport from \"@/pages/InventoryReport\";\nimport ComplianceReport from \"@/pages/ComplianceReport\";\nimport ComparisonReports from \"@/pages/ComparisonReports\";\nimport ComparisonReportDetail from \"@/pages/ComparisonReportDetail\";\nimport OrganizationSetup from \"@/pages/OrganizationSetup\";\nimport Team from \"@/pages/Team\";\nimport Blocks from \"@/pages/Blocks\";\nimport BlockDetail from \"@/pages/BlockDetail\";\nimport BlockTenants from \"@/pages/BlockTenants\";\nimport Settings from \"@/pages/Settings\";\nimport AssetInventory from \"@/pages/AssetInventory\";\nimport InspectionTemplates from \"@/pages/InspectionTemplates\";\nimport InspectionCapture from \"@/pages/InspectionCapture\";\nimport InspectionReview from \"@/pages/InspectionReview\";\nimport InspectionReport from \"@/pages/InspectionReport\";\nimport Contacts from \"@/pages/Contacts\";\nimport PropertyTenants from \"@/pages/PropertyTenants\";\nimport AdminLogin from \"@/pages/AdminLogin\";\nimport AdminDashboard from \"@/pages/AdminDashboard\";\nimport AdminTeam from \"@/pages/AdminTeam\";\nimport KnowledgeBase from \"@/pages/KnowledgeBase\";\nimport EcoAdmin from \"@/pages/EcoAdmin\";\nimport TenantLogin from \"@/pages/TenantLogin\";\nimport TenantHome from \"@/pages/TenantHome\";\nimport TenantMaintenance from \"@/pages/TenantMaintenance\";\nimport TenantRequests from \"@/pages/TenantRequests\";\nimport { Loader2 } from \"lucide-react\";\nimport { PWAInstallPrompt } from \"@/components/PWAInstallPrompt\";\nimport { UserProfileMenu } from \"@/components/UserProfileMenu\";\nimport { AIChatbot } from \"@/components/AIChatbot\";\nimport { LocaleProvider } from \"@/contexts/LocaleContext\";\n\nfunction AppContent() {\n  // Always call hooks at the top level\n  const { isAuthenticated, user, logoutMutation, isLoading } = useAuth();\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  // Not authenticated - show public routes (including admin and tenant routes)\n  if (!isAuthenticated && !isLoading) {\n    return (\n      <TooltipProvider>\n        <Switch>\n          <Route path=\"/\" component={Landing} />\n          <Route path=\"/auth\" component={Auth} />\n          <Route path=\"/forgot-password\" component={ForgotPassword} />\n          <Route path=\"/reset-password\" component={ResetPassword} />\n          <Route path=\"/admin/login\" component={AdminLogin} />\n          <Route path=\"/admin/dashboard\" component={AdminDashboard} />\n          <Route path=\"/admin/team\" component={AdminTeam} />\n          <Route path=\"/admin/knowledge-base\" component={KnowledgeBase} />\n          <Route path=\"/admin/eco-admin\" component={EcoAdmin} />\n          <Route path=\"/tenant/login\" component={TenantLogin} />\n          <Route component={NotFound} />\n        </Switch>\n        <PWAInstallPrompt />\n        <Toaster />\n      </TooltipProvider>\n    );\n  }\n\n  // Show loading while checking authentication status\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  // Tenant role - show tenant portal (no sidebar)\n  // Check this BEFORE organization check since tenants may not have organizationId\n  if (user && user.role === \"tenant\") {\n    return (\n      <TooltipProvider>\n        <div className=\"h-screen w-full flex flex-col\">\n          <main className=\"flex-1 overflow-auto bg-background\">\n            <Switch>\n              <Route path=\"/\" component={TenantHome} />\n              <Route path=\"/tenant/home\" component={TenantHome} />\n              <Route path=\"/tenant/maintenance\" component={TenantMaintenance} />\n              <Route path=\"/tenant/requests\" component={TenantRequests} />\n              <Route component={NotFound} />\n            </Switch>\n          </main>\n        </div>\n        <PWAInstallPrompt />\n        <Toaster />\n      </TooltipProvider>\n    );\n  }\n\n  // Authenticated but no organization - show onboarding (for staff users only)\n  if (user && !user.organizationId) {\n    return (\n      <TooltipProvider>\n        <Switch>\n          <Route path=\"*\" component={OrganizationSetup} />\n        </Switch>\n        <PWAInstallPrompt />\n        <Toaster />\n      </TooltipProvider>\n    );\n  }\n\n  // Authenticated with organization - show app with sidebar\n  return (\n    <TooltipProvider>\n      <SidebarProvider style={style as React.CSSProperties}>\n        <div className=\"flex h-screen w-full\">\n          <AppSidebar />\n          <div className=\"flex flex-col flex-1\">\n            <header className=\"flex items-center justify-between p-4 border-b bg-card\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <UserProfileMenu />\n            </header>\n            <main className=\"flex-1 overflow-auto bg-background\">\n              <Switch>\n                <Route path=\"/\" component={Dashboard} />\n                <Route path=\"/dashboard\" component={Dashboard} />\n                <Route path=\"/blocks/:id/tenants\" component={BlockTenants} />\n                <Route path=\"/blocks/:id\" component={BlockDetail} />\n              <Route path=\"/blocks\" component={Blocks} />\n                <Route path=\"/properties/:id/tenants\" component={PropertyTenants} />\n                <Route path=\"/properties/:id\" component={PropertyDetail} />\n                <Route path=\"/properties\" component={Properties} />\n                <Route path=\"/credits\" component={Credits} />\n                <Route path=\"/profile\" component={Profile} />\n                <Route path=\"/inspections\" component={Inspections} />\n                <Route path=\"/inspections/:id/capture\" component={InspectionCapture} />\n                <Route path=\"/inspections/:id/review\" component={InspectionReview} />\n                <Route path=\"/inspections/:id/report\" component={InspectionReport} />\n                <Route path=\"/inspections/:id\" component={InspectionDetail} />\n                <Route path=\"/compliance\" component={Compliance} />\n                <Route path=\"/maintenance\" component={Maintenance} />\n                <Route path=\"/analytics\" component={Analytics} />\n                <Route path=\"/reports/inspections\" component={InspectionsReport} />\n                <Route path=\"/reports/blocks\" component={BlocksReport} />\n                <Route path=\"/reports/properties\" component={PropertiesReport} />\n                <Route path=\"/reports/tenants\" component={TenantsReport} />\n                <Route path=\"/reports/inventory\" component={InventoryReport} />\n                <Route path=\"/reports/compliance\" component={ComplianceReport} />\n                <Route path=\"/reports\" component={Reports} />\n                <Route path=\"/comparisons/:id\" component={ComparisonReportDetail} />\n                <Route path=\"/comparisons\" component={ComparisonReports} />\n                <Route path=\"/team\" component={Team} />\n                <Route path=\"/contacts\" component={Contacts} />\n                <Route path=\"/asset-inventory\" component={AssetInventory} />\n                <Route path=\"/inspection-templates\" component={InspectionTemplates} />\n                <Route path=\"/billing\" component={Billing} />\n                <Route path=\"/settings\" component={Settings} />\n                <Route component={NotFound} />\n              </Switch>\n            </main>\n          </div>\n        </div>\n      </SidebarProvider>\n      <AIChatbot />\n      <PWAInstallPrompt />\n      <Toaster />\n    </TooltipProvider>\n  );\n}\n\nexport default function App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <LocaleProvider>\n        <AppContent />\n      </LocaleProvider>\n    </QueryClientProvider>\n  );\n}\n","size_bytes":9020},"client/src/components/app-sidebar.tsx":{"content":"import {\n  Building2,\n  ClipboardCheck,\n  FileText,\n  Home,\n  LayoutDashboard,\n  Settings,\n  Wrench,\n  Users,\n  CreditCard,\n  Boxes,\n  Clipboard,\n  Package,\n  List,\n  Contact,\n  GitCompare,\n  BarChart3,\n  FileBarChart,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from \"@/components/ui/sidebar\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Link, useLocation } from \"wouter\";\nimport logoUrl from \"@assets/Inspect360 Logo_1761302629835.png\";\n\nexport function AppSidebar() {\n  const { user } = useAuth();\n  const [location] = useLocation();\n\n  const mainMenuItems = [\n    {\n      title: \"Dashboard\",\n      url: \"/dashboard\",\n      icon: LayoutDashboard,\n      roles: [\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"],\n    },\n    {\n      title: \"Contacts\",\n      url: \"/contacts\",\n      icon: Contact,\n      roles: [\"owner\", \"clerk\", \"compliance\"],\n    },\n    {\n      title: \"Blocks\",\n      url: \"/blocks\",\n      icon: Boxes,\n      roles: [\"owner\", \"compliance\"],\n    },\n    {\n      title: \"Properties\",\n      url: \"/properties\",\n      icon: Building2,\n      roles: [\"owner\", \"compliance\"],\n    },\n    {\n      title: \"Inspections\",\n      url: \"/inspections\",\n      icon: ClipboardCheck,\n      roles: [\"owner\", \"clerk\"],\n    },\n    {\n      title: \"Compliance\",\n      url: \"/compliance\",\n      icon: FileText,\n      roles: [\"owner\", \"compliance\"],\n    },\n    {\n      title: \"Maintenance\",\n      url: \"/maintenance\",\n      icon: Wrench,\n      roles: [\"owner\", \"clerk\", \"tenant\", \"contractor\"],\n    },\n    {\n      title: \"Analytics\",\n      url: \"/analytics\",\n      icon: BarChart3,\n      roles: [\"owner\"],\n    },\n    {\n      title: \"Reports\",\n      url: \"/reports\",\n      icon: FileBarChart,\n      roles: [\"owner\", \"compliance\"],\n    },\n    {\n      title: \"Comparisons\",\n      url: \"/comparisons\",\n      icon: GitCompare,\n      roles: [\"owner\", \"clerk\", \"tenant\"],\n    },\n    {\n      title: \"Asset Inventory\",\n      url: \"/asset-inventory\",\n      icon: Package,\n      roles: [\"owner\", \"clerk\", \"compliance\"],\n    },\n  ];\n\n  const settingsMenuItems = [\n    {\n      title: \"Inspection Templates\",\n      url: \"/inspection-templates\",\n      icon: List,\n      roles: [\"owner\", \"compliance\"],\n    },\n    {\n      title: \"Team\",\n      url: \"/team\",\n      icon: Users,\n      roles: [\"owner\"],\n    },\n    {\n      title: \"Billing\",\n      url: \"/billing\",\n      icon: CreditCard,\n      roles: [\"owner\"],\n    },\n    {\n      title: \"Settings\",\n      url: \"/settings\",\n      icon: Settings,\n      roles: [\"owner\"],\n    },\n  ];\n\n  const filteredMainMenu = mainMenuItems.filter((item) =>\n    item.roles.includes(user?.role || \"\")\n  );\n\n  const filteredSettingsMenu = settingsMenuItems.filter((item) =>\n    item.roles.includes(user?.role || \"\")\n  );\n\n  return (\n    <Sidebar data-testid=\"sidebar-main\">\n      <SidebarHeader className=\"p-4 border-b\">\n        <div className=\"flex items-center gap-2\">\n          <img src={logoUrl} alt=\"Inspect360\" className=\"h-8\" />\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filteredMainMenu.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    data-active={location === item.url}\n                    className=\"data-[active=true]:bg-sidebar-accent\"\n                    data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"w-4 h-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {filteredSettingsMenu.length > 0 && (\n          <SidebarGroup>\n            <SidebarGroupLabel>Settings</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {filteredSettingsMenu.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton\n                      asChild\n                      data-active={location === item.url}\n                      className=\"data-[active=true]:bg-sidebar-accent\"\n                      data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}\n                    >\n                      <Link href={item.url}>\n                        <item.icon className=\"w-4 h-4\" />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n    </Sidebar>\n  );\n}\n","size_bytes":5037},"server/routes.ts":{"content":"// Backend API routes for Inspect360\nimport type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { randomUUID, createHash } from \"crypto\";\nimport { promises as fs } from \"fs\";\nimport { storage } from \"./storage\";\n\n/**\n * Detect image MIME type from file buffer using magic bytes\n * Returns a valid image MIME type (always starts with 'image/')\n */\nfunction detectImageMimeType(buffer: Buffer): string {\n  // Validate buffer\n  if (!buffer || buffer.length === 0) {\n    console.warn('[detectImageMimeType] Empty buffer, defaulting to image/jpeg');\n    return 'image/jpeg';\n  }\n\n  // Check file signatures (magic bytes)\n  if (buffer.length < 4) {\n    console.warn('[detectImageMimeType] Buffer too small, defaulting to image/jpeg');\n    return 'image/jpeg';\n  }\n\n  // JPEG: FF D8 FF (can be followed by E0, E1, etc.)\n  if (buffer[0] === 0xFF && buffer[1] === 0xD8 && buffer[2] === 0xFF) {\n    return 'image/jpeg';\n  }\n\n  // PNG: 89 50 4E 47 0D 0A 1A 0A\n  if (buffer[0] === 0x89 && buffer[1] === 0x50 && buffer[2] === 0x4E && buffer[3] === 0x47) {\n    return 'image/png';\n  }\n\n  // GIF: 47 49 46 38 (GIF8) or 47 49 46 39 (GIF9)\n  if (buffer[0] === 0x47 && buffer[1] === 0x49 && buffer[2] === 0x46 && \n      (buffer[3] === 0x38 || buffer[3] === 0x39)) {\n    return 'image/gif';\n  }\n\n  // WebP: Check for RIFF...WEBP\n  if (buffer.length >= 12 &&\n      buffer[0] === 0x52 && buffer[1] === 0x49 && buffer[2] === 0x46 && buffer[3] === 0x46 &&\n      buffer[8] === 0x57 && buffer[9] === 0x45 && buffer[10] === 0x42 && buffer[11] === 0x50) {\n    return 'image/webp';\n  }\n\n  // BMP: 42 4D\n  if (buffer[0] === 0x42 && buffer[1] === 0x4D) {\n    return 'image/bmp';\n  }\n\n  // Default to JPEG if we can't detect (most common image format)\n  // This ensures we always return a valid image MIME type\n  console.warn('[detectImageMimeType] Could not detect image type from magic bytes, defaulting to image/jpeg. First bytes:', \n    Array.from(buffer.slice(0, 8)).map(b => `0x${b.toString(16).padStart(2, '0')}`).join(' '));\n  return 'image/jpeg';\n}\nimport { setupAuth, isAuthenticated, requireRole, hashPassword, comparePasswords } from \"./auth\";\nimport { ObjectStorageService, ObjectNotFoundError } from \"./objectStorage\";\nimport { ObjectPermission } from \"./objectAcl\";\nimport { db } from \"./db\";\nimport { eq, and, lt, gt, desc } from \"drizzle-orm\";\nimport { getUncachableStripeClient, getStripeSecretKey } from \"./stripeClient\";\nimport OpenAI from \"openai\";\nimport bcrypt from \"bcryptjs\";\nimport { z } from \"zod\";\nimport multer from \"multer\";\nimport { format } from \"date-fns\";\nimport { devRouter } from \"./devRoutes\";\nimport { sendInspectionCompleteEmail, sendTeamWorkOrderNotification, sendContractorWorkOrderNotification } from \"./resend\";\nimport { DEFAULT_TEMPLATES } from \"./defaultTemplates\";\nimport { generateInspectionPDF } from \"./pdfService\";\nimport { extractTextFromFile, findRelevantChunks } from \"./documentProcessor\";\nimport {\n  insertBlockSchema,\n  insertContactSchema,\n  insertInventoryTemplateSchema,\n  insertInventorySchema,\n  insertInventoryItemSchema,\n  insertWorkOrderSchema,\n  insertWorkLogSchema,\n  insertAssetInventorySchema,\n  insertTagSchema,\n  insertTemplateCategorySchema,\n  insertInspectionTemplateSchema,\n  insertTemplateInventoryLinkSchema,\n  insertInspectionEntrySchema,\n  insertAiImageAnalysisSchema,\n  insertPropertySchema,\n  insertComplianceDocumentSchema,\n  insertMaintenanceRequestSchema,\n  insertInspectionSchema,\n  createOrganizationSchema,\n  createTeamMemberSchema,\n  updateTeamMemberSchema,\n  updateUserRoleSchema,\n  updateUserStatusSchema,\n  updateSelfProfileSchema,\n  updatePropertySchema,\n  updateComplianceDocumentSchema,\n  updateMaintenanceRequestSchema,\n  analyzePhotoSchema,\n  inspectFieldSchema,\n  generateComparisonSchema,\n  analyzeMaintenanceImageSchema,\n  updateContactSchema,\n  updateTagSchema,\n  updateDashboardPreferencesSchema,\n  updateTemplateCategorySchema,\n  updateInspectionSchema,\n  updateBlockSchema,\n  insertMessageTemplateSchema,\n  updateMessageTemplateSchema,\n  insertTenantAssignmentSchema,\n  updateTenantAssignmentSchema,\n  quickAddAssetSchema,\n  quickAddMaintenanceSchema,\n  quickUpdateAssetSchema,\n  maintenanceRequests,\n  teams,\n  teamMembers,\n  teamCategories,\n  insertPlanSchema,\n  insertCreditBundleSchema,\n  insertCountryPricingOverrideSchema,\n  creditBatches,\n  subscriptions\n} from \"@shared/schema\";\n\n// Initialize OpenAI using Replit AI Integrations (lazy initialization)\n// Using gpt-5 for vision analysis - the newest OpenAI model (released August 7, 2025), supports images and provides excellent results\n\n// Detect if running in a serverless environment (AWS Lambda, etc.)\nconst isServerless = process.env.AWS_LAMBDA_FUNCTION_NAME || process.env.VERCEL || process.env.NETLIFY;\n\n// Helper function to launch Puppeteer with appropriate configuration for local vs serverless\nasync function launchPuppeteerBrowser() {\n  const puppeteer = await import(\"puppeteer\");\n  \n  if (isServerless) {\n    // Serverless environment - use @sparticuz/chromium\n    const chromium = await import(\"@sparticuz/chromium\");\n    return await puppeteer.default.launch({\n      args: chromium.default.args,\n      executablePath: await chromium.default.executablePath(),\n      headless: true,\n    });\n  } else {\n    // Local development - use Puppeteer's bundled Chromium\n    return await puppeteer.default.launch({\n      headless: true,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-accelerated-2d-canvas',\n        '--no-first-run',\n        '--no-zygote',\n        '--disable-gpu'\n      ],\n    });\n  }\n}\n\n/**\n * Normalizes content for OpenAI Responses API format.\n * Converts legacy chat.completions format to responses.create format.\n * @param content - Array of content items with type \"text\" or \"image_url\"\n * @returns Array of normalized content items with type \"input_text\" or \"input_image\"\n * @throws Error if content type is not supported\n */\nfunction normalizeApiContent(content: any[]): any[] {\n  return content.map((item: any, index: number) => {\n    if (item.type === \"text\") {\n      return { type: \"input_text\", text: item.text };\n    } else if (item.type === \"image_url\") {\n      // Extract URL from object or use directly if already a string\n      const url = typeof item.image_url === 'string' ? item.image_url : item.image_url?.url;\n      if (!url) {\n        throw new Error(`[normalizeApiContent] Missing image URL at index ${index}`);\n      }\n      return { type: \"input_image\", image_url: url };\n    } else if (item.type === \"input_text\") {\n      // Already normalized - pass through\n      return item;\n    } else if (item.type === \"input_image\") {\n      // Already normalized - ensure URL is a string\n      if (typeof item.image_url !== 'string') {\n        throw new Error(`[normalizeApiContent] image_url must be a string at index ${index}, got ${typeof item.image_url}`);\n      }\n      return item;\n    } else {\n      throw new Error(`[normalizeApiContent] Unsupported content type at index ${index}: ${item.type}`);\n    }\n  });\n}\nlet openai: OpenAI | null = null;\nfunction getOpenAI(): OpenAI {\n  if (!openai) {\n    if (!process.env.AI_INTEGRATIONS_OPENAI_BASE_URL || !process.env.AI_INTEGRATIONS_OPENAI_API_KEY) {\n      throw new Error(\"OpenAI integration not configured. Please set up the AI Integrations.\");\n    }\n    openai = new OpenAI({\n      baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n      apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n    });\n  }\n  return openai;\n}\n\n// Helper function to get the base URL from request, respecting proxy headers\nfunction getBaseUrl(req: any): string {\n  // 1. Check environment variable first\n  if (process.env.BASE_URL) {\n    console.log(`[getBaseUrl] Using BASE_URL from env: ${process.env.BASE_URL}`);\n    return process.env.BASE_URL;\n  }\n\n  // 2. Check for proxy headers (X-Forwarded-Proto and X-Forwarded-Host)\n  const forwardedProto = req.headers['x-forwarded-proto'];\n  const forwardedHost = req.headers['x-forwarded-host'];\n  if (forwardedProto && forwardedHost) {\n    const url = `${forwardedProto}://${forwardedHost}`;\n    console.log(`[getBaseUrl] Using forwarded headers: ${url}`);\n    return url;\n  }\n\n  // 3. Check request origin header\n  if (req.headers.origin) {\n    try {\n      const url = new URL(req.headers.origin).origin;\n      console.log(`[getBaseUrl] Using origin header: ${url}`);\n      return url;\n    } catch (e) {\n      // Invalid origin, continue to next option\n    }\n  }\n\n  // 4. Check referer header (often more reliable than origin)\n  if (req.headers.referer || req.headers.referrer) {\n    try {\n      const referer = req.headers.referer || req.headers.referrer;\n      const url = new URL(referer).origin;\n      console.log(`[getBaseUrl] Using referer header: ${url}`);\n      return url;\n    } catch (e) {\n      // Invalid referer, continue to next option\n    }\n  }\n\n  // 5. Use req.protocol and req.get('host') (works with trust proxy)\n  const protocol = req.protocol || 'http';\n  const host = req.get('host');\n  if (host) {\n    const url = `${protocol}://${host}`;\n    console.log(`[getBaseUrl] Using req.protocol/host: ${url}`);\n    return url;\n  }\n\n  // 6. Fallback to localhost\n  const fallback = `http://localhost:${process.env.PORT || 5005}`;\n  console.log(`[getBaseUrl] Using fallback: ${fallback}`);\n  console.log(`[getBaseUrl] Debug info:`, {\n    hasOrigin: !!req.headers.origin,\n    hasReferer: !!(req.headers.referer || req.headers.referrer),\n    hasForwardedProto: !!forwardedProto,\n    hasForwardedHost: !!forwardedHost,\n    protocol: req.protocol,\n    host: req.get('host'),\n    headers: {\n      origin: req.headers.origin,\n      referer: req.headers.referer || req.headers.referrer,\n      'x-forwarded-proto': forwardedProto,\n      'x-forwarded-host': forwardedHost,\n    }\n  });\n  return fallback;\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // ==================== CONFIG ROUTES ====================\n  \n  // Get Google Maps API key (public endpoint, but API key is restricted by domain in Google Console)\n  app.get(\"/api/config/google-maps-key\", async (req: any, res) => {\n    try {\n      // Check all possible ways the key might be set\n      const apiKey = process.env.GOOGLE_MAPS_API_KEY?.trim() || \n                     process.env['GOOGLE_MAPS_API_KEY']?.trim();\n      \n      console.log('[Google Maps API] Checking API key:', {\n        exists: !!apiKey,\n        length: apiKey?.length || 0,\n        startsWith: apiKey?.substring(0, 10) || 'N/A',\n        rawEnvValue: process.env.GOOGLE_MAPS_API_KEY ? 'present' : 'missing',\n        allEnvKeys: Object.keys(process.env).filter(k => k.includes('GOOGLE')).join(', ')\n      });\n      \n      if (!apiKey || apiKey.length === 0) {\n        console.warn('[Google Maps API] API key not configured in environment variables');\n        console.warn('[Google Maps API] Available env vars with GOOGLE:', \n          Object.keys(process.env).filter(k => k.toUpperCase().includes('GOOGLE')));\n        // Return 200 with null to indicate API key is not configured\n        // This allows the client to gracefully handle missing API key\n        return res.json({ apiKey: null, configured: false });\n      }\n      console.log('[Google Maps API] API key found, returning to client (length:', apiKey.length, ')');\n      res.json({ apiKey, configured: true });\n    } catch (error) {\n      console.error(\"Error fetching Google Maps API key:\", error);\n      res.status(500).json({ error: \"Failed to fetch API key\", apiKey: null, configured: false });\n    }\n  });\n  // Auth middleware\n  await setupAuth(app);\n\n  // Configure multer for file uploads (memory storage for local file system)\n  const upload = multer({\n    storage: multer.memoryStorage(),\n    limits: {\n      fileSize: 100 * 1024 * 1024, // 100MB limit\n    },\n  });\n\n  // ==================== DEV ROUTES (Development Only) ====================\n  if (process.env.NODE_ENV === \"development\") {\n    app.use(\"/api/dev\", devRouter);\n  }\n\n  // ==================== AUTH ROUTES ====================\n  \n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Include organization info if user belongs to one\n      let organization = null;\n      if (user.organizationId) {\n        organization = await storage.getOrganization(user.organizationId);\n      }\n      \n      // Exclude password from response for security\n      const { password, ...userWithoutPassword } = user;\n      res.json({ ...userWithoutPassword, organization });\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  app.get('/api/auth/profile', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Exclude password from response for security\n      const { password, ...userWithoutPassword } = user;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error fetching profile:\", error);\n      res.status(500).json({ message: \"Failed to fetch profile\" });\n    }\n  });\n\n  app.patch('/api/auth/profile', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n\n      // Validate request body using the self-profile update schema\n      const validation = updateSelfProfileSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      if (Object.keys(validation.data).length === 0) {\n        return res.status(400).json({ message: \"No valid fields to update\" });\n      }\n\n      const updatedUser = await storage.updateUser(userId, validation.data);\n      \n      // Exclude password from response\n      const { password, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error updating profile:\", error);\n      res.status(500).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  // ==================== ORGANIZATION ROUTES ====================\n  \n  app.post(\"/api/organizations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Validate request body\n      const validation = createOrganizationSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Get current user data\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Create organization\n      const organization = await storage.createOrganization({\n        name: validation.data.name,\n        ownerId: userId,\n        creditsRemaining: 5, // Give 5 free credits to start\n      });\n\n      // Update user with organization ID and set role to owner (preserving all existing fields)\n      await storage.upsertUser({\n        ...user,\n        organizationId: organization.id,\n        role: \"owner\",\n      });\n\n      // Create initial credit transaction for free credits\n      await storage.createCreditTransaction({\n        organizationId: organization.id,\n        amount: 5,\n        type: \"purchase\",\n        description: \"Welcome credits\",\n      });\n\n      // Create default inspection templates (Check In and Check Out)\n      // Use defensive error handling so org creation succeeds even if template seeding fails\n      try {\n        for (const template of DEFAULT_TEMPLATES) {\n          await storage.createInspectionTemplate({\n            organizationId: organization.id,\n            name: template.name,\n            description: template.description,\n            scope: template.scope,\n            version: 1,\n            isActive: true,\n            structureJson: template.structureJson,\n            categoryId: template.categoryId,\n            createdBy: userId,\n          });\n        }\n        console.log(` Created ${DEFAULT_TEMPLATES.length} default templates for organization ${organization.id}`);\n      } catch (templateError) {\n        // Log the error but don't fail the entire organization creation\n        console.error(\"Warning: Failed to create default templates, but organization was created successfully:\", templateError);\n      }\n\n      // Create sample data for new organization (Block A, Property A, Joe Bloggs tenant)\n      // Use timestamp-based unique suffix for idempotency\n      try {\n        const uniqueSuffix = Date.now().toString(36); // Convert timestamp to base36 for shorter suffix\n        \n        // Create Block A\n        const blockA = await storage.createBlock({\n          organizationId: organization.id,\n          name: \"Block A\",\n          address: \"123 Sample Street, Sample City, SC 12345\",\n          notes: \"Sample block created automatically for demonstration purposes\",\n        });\n        console.log(` Created sample Block A for organization ${organization.id}`);\n\n        // Create Property A linked to Block A\n        const propertyA = await storage.createProperty({\n          organizationId: organization.id,\n          blockId: blockA.id,\n          name: \"Property A\",\n          address: \"Unit 101, Block A, 123 Sample Street, Sample City, SC 12345\",\n          sqft: 850,\n        });\n        console.log(` Created sample Property A for organization ${organization.id}`);\n\n        // Create sample tenant user \"Joe Bloggs\" with unique timestamp suffix\n        const tenantPassword = await hashPassword(\"password123\");\n        const joeBloggs = await storage.createUser({\n          email: `joe.bloggs+${uniqueSuffix}@inspect360.demo`,\n          username: `joe_bloggs_${uniqueSuffix}`,\n          password: tenantPassword,\n          firstName: \"Joe\",\n          lastName: \"Bloggs\",\n          role: \"tenant\",\n          organizationId: organization.id,\n          isActive: true,\n        });\n        console.log(` Created sample tenant Joe Bloggs (${joeBloggs.email}) for organization ${organization.id}`);\n\n        // Create contact record for Joe Bloggs\n        await storage.createContact({\n          organizationId: organization.id,\n          type: 'tenant',\n          firstName: \"Joe\",\n          lastName: \"Bloggs\",\n          email: `joe.bloggs+${uniqueSuffix}@inspect360.demo`,\n          phone: \"+44 7700 900123\",\n          linkedUserId: joeBloggs.id,\n          notes: \"Sample tenant contact created automatically for demonstration purposes\",\n        });\n        console.log(` Created contact record for Joe Bloggs`);\n\n        // Create tenant assignment linking Joe Bloggs to Property A\n        const tenantAssignment = await storage.createTenantAssignment({\n          organizationId: organization.id,\n          propertyId: propertyA.id,\n          tenantId: joeBloggs.id,\n          leaseStartDate: new Date(),\n          leaseEndDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year from now\n          monthlyRent: \"1200.00\",\n          depositAmount: \"1200.00\",\n          isActive: true,\n          notes: \"Sample tenant assignment created for demonstration purposes\",\n        });\n        console.log(` Created tenant assignment for Joe Bloggs in Property A`);\n        console.log(` Sample data setup complete - Block A, Property A, and tenant Joe Bloggs created successfully`);\n      } catch (sampleDataError) {\n        // Log detailed error for debugging but don't fail the organization creation\n        console.error(\"Warning: Failed to create sample data (organization was still created successfully):\", {\n          error: sampleDataError instanceof Error ? sampleDataError.message : String(sampleDataError),\n          organizationId: organization.id,\n        });\n      }\n\n      res.json(organization);\n    } catch (error) {\n      console.error(\"Error creating organization:\", error);\n      res.status(500).json({ message: \"Failed to create organization\" });\n    }\n  });\n\n  app.get(\"/api/organizations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const organizationId = req.params.id;\n      \n      const user = await storage.getUser(userId);\n      if (!user?.organizationId || user.organizationId !== organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const organization = await storage.getOrganization(organizationId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n\n      res.json(organization);\n    } catch (error) {\n      console.error(\"Error fetching organization:\", error);\n      res.status(500).json({ message: \"Failed to fetch organization\" });\n    }\n  });\n\n  // ==================== TEAM MANAGEMENT ROUTES ====================\n  \n  app.get(\"/api/team\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n      \n      const organizationId = user.organizationId;\n\n      // Fetch all users but exclude tenants (they should appear in Contacts instead)\n      const allUsers = await storage.getUsersByOrganization(organizationId);\n      const teamMembers = allUsers.filter(u => u.role !== 'tenant');\n      res.json(teamMembers);\n    } catch (error) {\n      console.error(\"Error fetching team members:\", error);\n      res.status(500).json({ message: \"Failed to fetch team members\" });\n    }\n  });\n\n  app.patch(\"/api/team/:userId/role\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const requesterId = req.user.id;\n      const requester = await storage.getUser(requesterId);\n      \n      if (!requester?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n      \n      const { userId } = req.params;\n      const organizationId = requester.organizationId;\n\n      // Validate request body\n      const validation = updateUserRoleSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Verify the user belongs to the same organization\n      const targetUser = await storage.getUser(userId);\n      if (!targetUser || targetUser.organizationId !== organizationId) {\n        return res.status(403).json({ message: \"User not found in your organization\" });\n      }\n\n      // Prevent changing own role\n      if (userId === req.user.id) {\n        return res.status(400).json({ message: \"Cannot change your own role\" });\n      }\n\n      const updatedUser = await storage.updateUserRole(userId, validation.data.role);\n      res.json(updatedUser);\n    } catch (error) {\n      console.error(\"Error updating user role:\", error);\n      res.status(500).json({ message: \"Failed to update user role\" });\n    }\n  });\n\n  // Toggle user active status\n  app.patch(\"/api/team/:userId/status\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const requesterId = req.user.id;\n      const requester = await storage.getUser(requesterId);\n      \n      if (!requester?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n      \n      const { userId } = req.params;\n\n      // Validate request body\n      const validation = updateUserStatusSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Verify the user belongs to the same organization\n      const targetUser = await storage.getUser(userId);\n      if (!targetUser || targetUser.organizationId !== requester.organizationId) {\n        return res.status(403).json({ message: \"User not found in your organization\" });\n      }\n\n      // Prevent disabling own account\n      if (userId === req.user.id) {\n        return res.status(400).json({ message: \"Cannot change your own account status\" });\n      }\n\n      const updatedUser = await storage.updateUser(userId, { isActive: validation.data.isActive });\n      const { password: _, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error updating user status:\", error);\n      res.status(500).json({ message: \"Failed to update user status\" });\n    }\n  });\n\n  app.post(\"/api/team\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const requesterId = req.user.id;\n      const requester = await storage.getUser(requesterId);\n      \n      if (!requester?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Validate request body\n      const validation = createTeamMemberSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { email, firstName, lastName, username, password, role, phone, address, skills, education, profileImageUrl, certificateUrls } = validation.data;\n\n      // Hash password before creating user\n      const hashedPassword = await hashPassword(password);\n\n      // Create team member with organization ID\n      const newUser = await storage.createUser({\n        email,\n        firstName,\n        lastName,\n        username,\n        password: hashedPassword,\n        role,\n        phone,\n        address,\n        skills,\n        education,\n        profileImageUrl,\n        certificateUrls,\n        organizationId: requester.organizationId,\n      });\n\n      // If the user is a tenant, automatically create a corresponding contact\n      if (role === 'tenant') {\n        try {\n          await storage.createContact({\n            organizationId: requester.organizationId,\n            type: 'tenant',\n            firstName: firstName || '',\n            lastName: lastName || '',\n            email: email,\n            phone: phone || undefined,\n            profileImageUrl: profileImageUrl || undefined,\n            linkedUserId: newUser.id,\n            notes: 'Automatically created from tenant user',\n          });\n          console.log(` Created contact record for tenant user ${newUser.id}`);\n        } catch (contactError) {\n          // Log error but don't fail the user creation\n          console.error(`Warning: Failed to create contact for tenant user ${newUser.id}:`, contactError);\n        }\n      }\n\n      // Don't return password\n      const { password: _, ...userWithoutPassword } = newUser;\n      res.json(userWithoutPassword);\n    } catch (error: any) {\n      console.error(\"Error creating team member:\", error);\n      if (error.message?.includes(\"duplicate\") || error.message?.includes(\"unique\")) {\n        res.status(400).json({ message: \"Email or username already exists\" });\n      } else {\n        res.status(500).json({ message: \"Failed to create team member\" });\n      }\n    }\n  });\n\n  app.patch(\"/api/team/:userId\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const requesterId = req.user.id;\n      const requester = await storage.getUser(requesterId);\n      \n      if (!requester?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n      \n      const { userId } = req.params;\n\n      // Validate request body\n      const validation = updateTeamMemberSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Verify the user belongs to the same organization\n      const targetUser = await storage.getUser(userId);\n      if (!targetUser || targetUser.organizationId !== requester.organizationId) {\n        return res.status(403).json({ message: \"User not found in your organization\" });\n      }\n\n      if (Object.keys(validation.data).length === 0) {\n        return res.status(400).json({ message: \"No valid fields to update\" });\n      }\n\n      const updatedUser = await storage.updateUser(userId, validation.data);\n      \n      // Don't return password\n      const { password, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error updating team member:\", error);\n      res.status(500).json({ message: \"Failed to update team member\" });\n    }\n  });\n\n  // ==================== CONTACT ROUTES ====================\n\n  app.get(\"/api/contacts\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      const contacts = await storage.getContactsByOrganization(user.organizationId);\n      \n      // Fetch tags for each contact\n      const contactsWithTags = await Promise.all(\n        contacts.map(async (contact) => {\n          const tags = await storage.getTagsForContact(contact.id);\n          return { ...contact, tags };\n        })\n      );\n      \n      res.json(contactsWithTags);\n    } catch (error) {\n      console.error(\"Error fetching contacts:\", error);\n      res.status(500).json({ error: \"Failed to fetch contacts\" });\n    }\n  });\n\n  app.get(\"/api/contacts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      const contact = await storage.getContact(req.params.id);\n      \n      if (!contact) {\n        return res.status(404).json({ error: \"Contact not found\" });\n      }\n      \n      if (contact.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      res.json(contact);\n    } catch (error) {\n      console.error(\"Error fetching contact:\", error);\n      res.status(500).json({ error: \"Failed to fetch contact\" });\n    }\n  });\n\n  app.post(\"/api/contacts\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      const validation = insertContactSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ error: \"Invalid request data\", details: validation.error });\n      }\n      \n      const contact = await storage.createContact({\n        ...validation.data,\n        organizationId: user.organizationId\n      });\n      \n      res.status(201).json(contact);\n    } catch (error) {\n      console.error(\"Error creating contact:\", error);\n      res.status(500).json({ error: \"Failed to create contact\" });\n    }\n  });\n\n  // Sync tenant users to contacts (migration endpoint for existing tenants)\n  app.post(\"/api/contacts/sync-tenants\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      // Get all tenant users in the organization\n      const allUsers = await storage.getUsersByOrganization(user.organizationId);\n      const tenantUsers = allUsers.filter(u => u.role === 'tenant');\n      \n      // Get all existing contacts to check for linkedUserId\n      const existingContacts = await storage.getContactsByOrganization(user.organizationId);\n      const linkedUserIds = new Set(\n        existingContacts\n          .filter(c => c.linkedUserId)\n          .map(c => c.linkedUserId)\n      );\n      \n      // Create contacts for tenant users that don't have one yet\n      const results = {\n        total: tenantUsers.length,\n        created: 0,\n        skipped: 0,\n        errors: [] as string[],\n      };\n      \n      for (const tenant of tenantUsers) {\n        if (linkedUserIds.has(tenant.id)) {\n          results.skipped++;\n          continue;\n        }\n        \n        try {\n          await storage.createContact({\n            organizationId: user.organizationId,\n            type: 'tenant',\n            firstName: tenant.firstName || '',\n            lastName: tenant.lastName || '',\n            email: tenant.email,\n            phone: tenant.phone || undefined,\n            profileImageUrl: tenant.profileImageUrl || undefined,\n            linkedUserId: tenant.id,\n            notes: 'Migrated from tenant user',\n          });\n          results.created++;\n          console.log(` Created contact for tenant user ${tenant.id}`);\n        } catch (contactError) {\n          results.errors.push(`Failed to create contact for ${tenant.email}: ${contactError instanceof Error ? contactError.message : String(contactError)}`);\n          console.error(`Error creating contact for tenant ${tenant.id}:`, contactError);\n        }\n      }\n      \n      res.json(results);\n    } catch (error) {\n      console.error(\"Error syncing tenants to contacts:\", error);\n      res.status(500).json({ error: \"Failed to sync tenants\" });\n    }\n  });\n\n  app.patch(\"/api/contacts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      const contact = await storage.getContact(req.params.id);\n      \n      if (!contact) {\n        return res.status(404).json({ error: \"Contact not found\" });\n      }\n      \n      if (contact.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Validate request body\n      const validation = updateContactSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n      \n      const updatedContact = await storage.updateContact(req.params.id, validation.data);\n      res.json(updatedContact);\n    } catch (error) {\n      console.error(\"Error updating contact:\", error);\n      res.status(500).json({ error: \"Failed to update contact\" });\n    }\n  });\n\n  app.delete(\"/api/contacts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n      \n      const contact = await storage.getContact(req.params.id);\n      \n      if (!contact) {\n        return res.status(404).json({ error: \"Contact not found\" });\n      }\n      \n      if (contact.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteContact(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting contact:\", error);\n      res.status(500).json({ error: \"Failed to delete contact\" });\n    }\n  });\n\n  // ==================== PROPERTY ROUTES ====================\n  \n  app.post(\"/api/properties\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n      \n      // Validate request body\n      const validation = insertPropertySchema.omit({ organizationId: true }).safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { name, address, blockId } = validation.data;\n\n      const property = await storage.createProperty({\n        organizationId: user.organizationId,\n        name,\n        address,\n        blockId: blockId || null,\n      });\n\n      res.json(property);\n    } catch (error) {\n      console.error(\"Error creating property:\", error);\n      res.status(500).json({ message: \"Failed to create property\" });\n    }\n  });\n\n  app.get(\"/api/properties\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const properties = await storage.getPropertiesByOrganization(user.organizationId);\n      res.json(properties);\n    } catch (error) {\n      console.error(\"Error fetching properties:\", error);\n      res.status(500).json({ message: \"Failed to fetch properties\" });\n    }\n  });\n\n  app.get(\"/api/properties/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const property = await storage.getProperty(id);\n      \n      if (!property) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      res.json(property);\n    } catch (error) {\n      console.error(\"Error fetching property:\", error);\n      res.status(500).json({ message: \"Failed to fetch property\" });\n    }\n  });\n\n  // Get property stats\n  app.get(\"/api/properties/:id/stats\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      // Get inspections for this property\n      const inspections = await storage.getInspectionsByProperty(id);\n      const now = new Date();\n      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n      \n      // Overdue: scheduled date is before today\n      const overdueInspections = inspections.filter(i => \n        i.status === 'scheduled' && i.scheduledDate && new Date(i.scheduledDate) < today\n      ).length;\n      \n      // Due soon: scheduled date is today or in the near future (next 7 days)\n      const weekFromNow = new Date(today);\n      weekFromNow.setDate(weekFromNow.getDate() + 7);\n      const dueInspections = inspections.filter(i => \n        i.status === 'scheduled' && i.scheduledDate && \n        new Date(i.scheduledDate) >= today &&\n        new Date(i.scheduledDate) <= weekFromNow\n      ).length;\n\n      // Get compliance docs for this property\n      const allComplianceDocs = await storage.getComplianceDocuments(user.organizationId);\n      const complianceDocs = allComplianceDocs.filter((d: any) => d.propertyId === id);\n      const validDocs = complianceDocs.filter((d: any) => {\n        if (!d.expiryDate) return true;\n        return new Date(d.expiryDate) > now;\n      }).length;\n      const complianceRate = complianceDocs.length > 0 \n        ? Math.round((validDocs / complianceDocs.length) * 100)\n        : 100;\n\n      // Get maintenance requests\n      const maintenanceRequests = await storage.getMaintenanceRequestsByProperty(id);\n      const openRequests = maintenanceRequests.filter(m => \n        m.status !== 'completed' && m.status !== 'closed'\n      ).length;\n\n      // Get inventory count\n      const inventory = await storage.getAssetInventoryByProperty(id);\n      \n      // Get tenants\n      const tenants = await storage.getUsersByOrganizationAndRole(user.organizationId, \"tenant\");\n      const propertyTenants = tenants.filter((t: any) => t.propertyId === id);\n\n      res.json({\n        occupancyStatus: propertyTenants.length > 0 ? `${propertyTenants.length} Tenant${propertyTenants.length > 1 ? 's' : ''}` : 'Vacant',\n        complianceRate,\n        dueInspections,\n        overdueInspections,\n        maintenanceRequests: openRequests,\n        inventoryCount: inventory.length,\n      });\n    } catch (error) {\n      console.error(\"Error fetching property stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch property stats\" });\n    }\n  });\n\n  // Get property tenants\n  app.get(\"/api/properties/:id/tenants\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      // Use tenant_assignments table to get property tenants with organization isolation\n      const tenants = await storage.getTenantAssignmentsByProperty(id, user.organizationId);\n\n      res.json(tenants);\n    } catch (error) {\n      console.error(\"Error fetching property tenants:\", error);\n      res.status(500).json({ message: \"Failed to fetch tenants\" });\n    }\n  });\n\n  // Get property inspections\n  app.get(\"/api/properties/:id/inspections\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      const inspections = await storage.getInspectionsByProperty(id);\n      \n      // Enhance with template names and inspector info\n      const enhancedInspections = await Promise.all(inspections.map(async (inspection: any) => {\n        let templateName = 'Unknown Template';\n        if (inspection.templateId) {\n          const template = await storage.getInspectionTemplate(inspection.templateId);\n          if (template) templateName = template.name;\n        }\n\n        let inspectorName = undefined;\n        if (inspection.inspectorId) {\n          const inspector = await storage.getUser(inspection.inspectorId);\n          if (inspector) inspectorName = `${inspector.firstName} ${inspector.lastName}`;\n        }\n\n        return {\n          id: inspection.id,\n          templateName,\n          scheduledDate: inspection.scheduledDate,\n          status: inspection.status,\n          inspectorName,\n        };\n      }));\n\n      res.json(enhancedInspections);\n    } catch (error) {\n      console.error(\"Error fetching property inspections:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspections\" });\n    }\n  });\n\n  // Get property inventory\n  app.get(\"/api/properties/:id/inventory\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      const inventory = await storage.getAssetInventoryByProperty(id);\n      \n      // Enhance with formatted data for BTR managers\n      const enhancedInventory = inventory.map((item: any) => ({\n        id: item.id,\n        name: item.name,\n        description: item.description,\n        category: item.category || 'General',\n        condition: item.condition,\n        quantity: 1, // Default quantity\n        datePurchased: item.datePurchased,\n        expectedLifespanYears: item.expectedLifespanYears,\n        photoUrl: item.photos?.[0] || null, // Use first photo from photos array\n      }));\n\n      res.json(enhancedInventory);\n    } catch (error) {\n      console.error(\"Error fetching property inventory:\", error);\n      res.status(500).json({ message: \"Failed to fetch inventory\" });\n    }\n  });\n\n  // Get property compliance documents\n  app.get(\"/api/properties/:id/compliance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      const allComplianceDocs = await storage.getComplianceDocuments(user.organizationId);\n      const complianceDocs = allComplianceDocs.filter((d: any) => d.propertyId === id);\n      \n      // Add status based on expiry and enhance with names\n      const now = new Date();\n      const enhancedDocs = complianceDocs.map((doc: any) => {\n        let status = 'valid';\n        if (doc.expiryDate) {\n          const expiryDate = new Date(doc.expiryDate);\n          const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n          \n          if (daysUntilExpiry < 0) {\n            status = 'expired';\n          } else if (daysUntilExpiry <= 30) {\n            status = 'expiring';\n          } else {\n            status = 'valid';\n          }\n        }\n        \n        return {\n          id: doc.id,\n          documentName: doc.documentType, // Use documentType as name\n          documentType: doc.documentType,\n          documentUrl: doc.documentUrl,\n          expiryDate: doc.expiryDate,\n          status,\n          uploadedAt: doc.createdAt,\n        };\n      });\n\n      res.json(enhancedDocs);\n    } catch (error) {\n      console.error(\"Error fetching property compliance:\", error);\n      res.status(500).json({ message: \"Failed to fetch compliance documents\" });\n    }\n  });\n\n  // Get property annual compliance report\n  app.get(\"/api/properties/:id/compliance-report\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      // Get all inspections for this property\n      const allInspections = await storage.getInspectionsByProperty(id);\n      \n      // Get all inspection templates\n      const templates = await storage.getInspectionTemplatesByOrganization(user.organizationId);\n      const activeTemplates = templates.filter(t => t.isActive && (t.scope === 'property' || t.scope === 'both'));\n      \n      // Build compliance data by template and month\n      const currentYear = new Date().getFullYear();\n      const months = [\n        'January', 'February', 'March', 'April', 'May', 'June',\n        'July', 'August', 'September', 'October', 'November', 'December'\n      ];\n      \n      const complianceData = activeTemplates.map(template => {\n        const templateInspections = allInspections.filter(i => i.templateId === template.id);\n        \n        const monthData = months.map((monthName, monthIndex) => {\n          // Find inspections scheduled for this month\n          const monthInspections = templateInspections.filter(inspection => {\n            if (!inspection.scheduledDate) return false;\n            const schedDate = new Date(inspection.scheduledDate);\n            return schedDate.getFullYear() === currentYear && schedDate.getMonth() === monthIndex;\n          });\n          \n          if (monthInspections.length === 0) {\n            return { month: monthName, status: 'not_scheduled', count: 0 };\n          }\n          \n          const now = new Date();\n          const completedCount = monthInspections.filter(i => i.status === 'completed').length;\n          const overdueCount = monthInspections.filter(i => {\n            if (i.status === 'completed' || !i.scheduledDate) return false;\n            const schedDate = new Date(i.scheduledDate);\n            return schedDate < now;\n          }).length;\n          \n          const dueCount = monthInspections.filter(i => {\n            if (i.status === 'completed' || !i.scheduledDate) return false;\n            const schedDate = new Date(i.scheduledDate);\n            const daysUntil = Math.ceil((schedDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n            return daysUntil >= 0 && daysUntil <= 30;\n          }).length;\n          \n          let status = 'not_scheduled';\n          if (overdueCount > 0) {\n            status = 'overdue';\n          } else if (completedCount === monthInspections.length) {\n            status = 'completed';\n          } else if (dueCount > 0) {\n            status = 'due';\n          } else {\n            status = 'scheduled';\n          }\n          \n          return {\n            month: monthName,\n            status,\n            count: monthInspections.length,\n            completed: completedCount,\n            overdue: overdueCount,\n          };\n        });\n        \n        // Calculate compliance percentage for this template\n        const totalScheduled = monthData.reduce((sum, m) => sum + m.count, 0);\n        const totalCompleted = monthData.reduce((sum, m) => sum + (m.completed || 0), 0);\n        const complianceRate = totalScheduled > 0 ? Math.round((totalCompleted / totalScheduled) * 100) : 0;\n        \n        return {\n          templateId: template.id,\n          templateName: template.name,\n          monthData,\n          complianceRate,\n          totalScheduled,\n          totalCompleted,\n        };\n      });\n      \n      // Calculate overall compliance\n      const totalScheduled = complianceData.reduce((sum, t) => sum + t.totalScheduled, 0);\n      const totalCompleted = complianceData.reduce((sum, t) => sum + t.totalCompleted, 0);\n      const overallCompliance = totalScheduled > 0 ? Math.round((totalCompleted / totalScheduled) * 100) : 100;\n      \n      res.json({\n        year: currentYear,\n        months,\n        templates: complianceData,\n        overallCompliance,\n        totalScheduled,\n        totalCompleted,\n      });\n    } catch (error) {\n      console.error(\"Error fetching property compliance report:\", error);\n      res.status(500).json({ message: \"Failed to fetch compliance report\" });\n    }\n  });\n\n  // Get property maintenance requests\n  app.get(\"/api/properties/:id/maintenance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const property = await storage.getProperty(id);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      const maintenance = await storage.getMaintenanceRequestsByProperty(id);\n      \n      // Enhance with user info\n      const enhancedMaintenance = await Promise.all(maintenance.map(async (request: any) => {\n        let reportedByName = 'Unknown';\n        if (request.reportedBy) {\n          const reporter = await storage.getUser(request.reportedBy);\n          if (reporter) reportedByName = `${reporter.firstName} ${reporter.lastName}`;\n        }\n\n        let assignedToName = undefined;\n        if (request.assignedTo) {\n          const assignee = await storage.getUser(request.assignedTo);\n          if (assignee) assignedToName = `${assignee.firstName} ${assignee.lastName}`;\n        }\n\n        return {\n          id: request.id,\n          title: request.title,\n          description: request.description,\n          priority: request.priority,\n          status: request.status,\n          category: request.source || 'general', // Use source as category for now\n          createdAt: request.createdAt,\n          reportedByName,\n          assignedToName,\n          photoUrl: request.photoUrl,\n        };\n      }));\n\n      res.json(enhancedMaintenance);\n    } catch (error) {\n      console.error(\"Error fetching property maintenance:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance requests\" });\n    }\n  });\n\n  // ==================== USER ROUTES ====================\n  \n  app.get(\"/api/users/clerks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const users = await storage.getUsersByOrganizationAndRole(user.organizationId, \"clerk\");\n      // Filter to only return active clerks\n      const activeClerks = users.filter(u => u.isActive !== false);\n      res.json(activeClerks);\n    } catch (error) {\n      console.error(\"Error fetching clerks:\", error);\n      res.status(500).json({ message: \"Failed to fetch clerks\" });\n    }\n  });\n\n  app.get(\"/api/users/role/tenant\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const users = await storage.getUsersByOrganizationAndRole(user.organizationId, \"tenant\");\n      // Filter to only return active tenants\n      const activeTenants = users.filter(u => u.isActive !== false);\n      res.json(activeTenants);\n    } catch (error) {\n      console.error(\"Error fetching tenants:\", error);\n      res.status(500).json({ message: \"Failed to fetch tenants\" });\n    }\n  });\n\n  // ==================== PROPERTY BY BLOCK ROUTES ====================\n  \n  // Get properties by block\n  app.get(\"/api/blocks/:blockId/properties\", isAuthenticated, async (req, res) => {\n    try {\n      const { blockId } = req.params;\n      const properties = await storage.getPropertiesByBlock(blockId);\n      res.json(properties);\n    } catch (error) {\n      console.error(\"Error fetching properties for block:\", error);\n      res.status(500).json({ message: \"Failed to fetch properties\" });\n    }\n  });\n\n  // ==================== INSPECTION ROUTES ====================\n  \n  app.post(\"/api/inspections\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const currentUser = await storage.getUser(userId);\n      const { propertyId, blockId, type, scheduledDate, notes, clerkId, templateId } = req.body;\n      \n      // Must specify either propertyId OR blockId (not both)\n      if ((!propertyId && !blockId) || (propertyId && blockId)) {\n        return res.status(400).json({ message: \"Must specify either propertyId OR blockId (not both)\" });\n      }\n      \n      if (!type) {\n        return res.status(400).json({ message: \"Inspection type is required\" });\n      }\n\n      if (!currentUser?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Use provided clerkId if available, otherwise assign to current user\n      let inspectorId = userId;\n      \n      if (clerkId) {\n        // Validate that the clerk belongs to the same organization\n        const clerk = await storage.getUser(clerkId);\n        if (!clerk || clerk.organizationId !== currentUser.organizationId) {\n          return res.status(400).json({ message: \"Invalid clerk assignment - clerk must belong to your organization\" });\n        }\n        inspectorId = clerkId;\n      }\n\n      // Handle template snapshot creation\n      let templateSnapshotJson = null;\n      let templateVersion = null;\n      let finalTemplateId = templateId;\n      \n      if (!finalTemplateId) {\n        const orgTemplates = await storage.getInspectionTemplatesByOrganization(currentUser.organizationId);\n        \n        if (type === 'check_in') {\n          const checkInTemplate = orgTemplates.find(t => \n            t.name.toLowerCase().includes('check in') && t.isActive\n          );\n          if (checkInTemplate) {\n            finalTemplateId = checkInTemplate.id;\n            console.log(`Auto-selected Check In template: ${checkInTemplate.id}`);\n          }\n        } else if (type === 'check_out') {\n          const checkOutTemplate = orgTemplates.find(t => \n            t.name.toLowerCase().includes('check out') && t.isActive\n          );\n          if (checkOutTemplate) {\n            finalTemplateId = checkOutTemplate.id;\n            console.log(`Auto-selected Check Out template: ${checkOutTemplate.id}`);\n          }\n        }\n      }\n      \n      if (finalTemplateId) {\n        const template = await storage.getInspectionTemplate(finalTemplateId);\n        if (!template) {\n          return res.status(404).json({ message: \"Template not found\" });\n        }\n        \n        if (template.organizationId !== currentUser.organizationId) {\n          return res.status(403).json({ message: \"Template does not belong to your organization\" });\n        }\n        \n        const isPropertyInspection = !!propertyId;\n        const isBlockInspection = !!blockId;\n        \n        if (isPropertyInspection && template.scope === 'block') {\n          return res.status(400).json({ message: \"Cannot use block-scoped template for property inspection\" });\n        }\n        if (isBlockInspection && template.scope === 'property') {\n          return res.status(400).json({ message: \"Cannot use property-scoped template for block inspection\" });\n        }\n        \n        templateSnapshotJson = template.structureJson;\n        templateVersion = template.version;\n      }\n\n      const inspection = await storage.createInspection({\n        organizationId: currentUser.organizationId,\n        propertyId: propertyId || null,\n        blockId: blockId || null,\n        inspectorId,\n        type,\n        scheduledDate: scheduledDate ? new Date(scheduledDate) : new Date(),\n        notes,\n        templateId: finalTemplateId || null,\n        templateVersion,\n        templateSnapshotJson: templateSnapshotJson as any,\n      });\n\n      res.json(inspection);\n    } catch (error) {\n      console.error(\"Error creating inspection:\", error);\n      console.error(\"Request body:\", req.body);\n      console.error(\"Error details:\", error instanceof Error ? error.message : String(error));\n      res.status(500).json({ \n        message: \"Failed to create inspection\",\n        error: error instanceof Error ? error.message : String(error)\n      });\n    }\n  });\n\n  app.get(\"/api/inspections/my\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      // Owners see all inspections in their organization\n      // Clerks see only inspections assigned to them\n      let inspections;\n      if (user.role === \"owner\" || user.role === \"compliance\") {\n        inspections = await storage.getInspectionsByOrganization(user.organizationId);\n      } else {\n        inspections = await storage.getInspectionsByInspector(userId);\n      }\n      \n      res.json(inspections);\n    } catch (error) {\n      console.error(\"Error fetching inspections:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspections\" });\n    }\n  });\n\n  app.get(\"/api/inspections/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const inspection = await storage.getInspection(id);\n      \n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Verify access: Clerks can only view inspections assigned to them\n      if (user.role !== \"owner\" && user.role !== \"compliance\") {\n        if (inspection.inspectorId !== userId) {\n          return res.status(403).json({ message: \"Access denied: Inspection not assigned to you\" });\n        }\n      }\n\n      // Verify organization ownership\n      if (inspection.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied: Inspection does not belong to your organization\" });\n      }\n\n      // Fetch inspection items\n      const items = await storage.getInspectionItems(id);\n      console.log(`[GET /api/inspections/:id] Fetched ${items.length} items for inspection ${id}`);\n\n      // Fetch related data\n      let property = null;\n      let block = null;\n      let clerk = null;\n\n      if (inspection.propertyId) {\n        property = await storage.getProperty(inspection.propertyId);\n      }\n      if (inspection.blockId) {\n        block = await storage.getBlock(inspection.blockId);\n      }\n      if (inspection.inspectorId) {\n        clerk = await storage.getUser(inspection.inspectorId);\n      }\n\n      const response = {\n        ...inspection,\n        items,\n        property,\n        block,\n        clerk,\n      };\n      \n      console.log(`[GET /api/inspections/:id] Returning inspection with ${response.items.length} items`);\n      res.json(response);\n    } catch (error) {\n      console.error(\"Error fetching inspection:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspection\" });\n    }\n  });\n\n  // Generate PDF report for inspection\n  app.get(\"/api/inspections/:id/pdf\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"No organization found\" });\n      }\n\n      // Get inspection\n      const inspection = await storage.getInspection(id);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Verify organization ownership\n      if (inspection.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Fetch property and inspector data\n      let property = null;\n      let inspector = null;\n\n      if (inspection.propertyId) {\n        property = await storage.getProperty(inspection.propertyId);\n      }\n\n      if (inspection.inspectorId) {\n        inspector = await storage.getUser(inspection.inspectorId);\n      }\n\n      // Build full inspection object with relations\n      const fullInspection = {\n        ...inspection,\n        property: property || undefined,\n        inspector: inspector || undefined,\n      };\n\n      // Get inspection entries\n      const entries = await storage.getInspectionEntries(id);\n\n      // Build base URL for converting relative image paths to absolute\n      const protocol = req.protocol;\n      const host = req.get('host');\n      const baseUrl = `${protocol}://${host}`;\n\n      // Generate PDF\n      const pdfBuffer = await generateInspectionPDF(fullInspection as any, entries, baseUrl);\n\n      // Set headers for PDF download\n      const propertyName = property?.name || \"inspection\";\n      const filename = `${propertyName.replace(/[^a-zA-Z0-9]/g, \"_\")}_inspection_report.pdf`;\n      \n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.setHeader(\"Content-Length\", pdfBuffer.length);\n      \n      res.send(pdfBuffer);\n    } catch (error) {\n      console.error(\"Error generating PDF:\", error);\n      res.status(500).json({ message: \"Failed to generate PDF report\" });\n    }\n  });\n\n  // General PATCH endpoint for updating inspection fields\n  app.patch(\"/api/inspections/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"No organization found\" });\n      }\n\n      // Get inspection and verify ownership\n      const inspection = await storage.getInspection(id);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Verify organization ownership via property or block\n      let ownerOrgId: string | null = null;\n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property) {\n          return res.status(404).json({ message: \"Property not found\" });\n        }\n        ownerOrgId = property.organizationId;\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block) {\n          return res.status(404).json({ message: \"Block not found\" });\n        }\n        ownerOrgId = block.organizationId;\n      }\n\n      if (ownerOrgId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Verify access: Clerks can only update inspections assigned to them\n      if (user.role !== \"owner\" && user.role !== \"compliance\") {\n        if (inspection.inspectorId !== user.id) {\n          return res.status(403).json({ message: \"Access denied: Inspection not assigned to you\" });\n        }\n      }\n\n      // Validate and update inspection\n      const validation = updateInspectionSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Convert date strings to Date objects for storage\n      const updates: any = { ...validation.data };\n      if (updates.scheduledDate && typeof updates.scheduledDate === 'string') {\n        updates.scheduledDate = new Date(updates.scheduledDate);\n      }\n      if (updates.startedAt && typeof updates.startedAt === 'string') {\n        updates.startedAt = new Date(updates.startedAt);\n      }\n      if (updates.completedDate && typeof updates.completedDate === 'string') {\n        updates.completedDate = new Date(updates.completedDate);\n      }\n      if (updates.submittedAt && typeof updates.submittedAt === 'string') {\n        updates.submittedAt = new Date(updates.submittedAt);\n      }\n\n      // NOTE: Credit consumption removed from manual status changes\n      // Credits are only consumed during actual inspection submission workflow\n      // This allows flexible status management without credit restrictions\n\n      const updatedInspection = await storage.updateInspection(id, updates);\n      \n      // Send email if status changed to completed\n      if (validation.data.status === \"completed\" && inspection.status !== \"completed\") {\n        try {\n          const inspector = await storage.getUser(inspection.inspectorId);\n          const inspectorName = inspector ? `${inspector.firstName || ''} ${inspector.lastName || ''}`.trim() || inspector.username : 'Unknown Inspector';\n          \n          let propertyName: string | undefined;\n          let blockName: string | undefined;\n          \n          if (inspection.propertyId) {\n            const property = await storage.getProperty(inspection.propertyId);\n            propertyName = property?.name;\n          } else if (inspection.blockId) {\n            const block = await storage.getBlock(inspection.blockId);\n            blockName = block?.name;\n          }\n\n          if (ownerOrgId) {\n            const owners = await storage.getUsersByOrganization(ownerOrgId);\n            const owner = owners.find(u => u.role === 'owner');\n            \n            if (owner && owner.email) {\n              await sendInspectionCompleteEmail(\n                owner.email,\n                `${owner.firstName || ''} ${owner.lastName || ''}`.trim() || owner.email,\n                {\n                  type: inspection.type,\n                  propertyName,\n                  blockName,\n                  inspectorName,\n                  completedDate: updatedInspection.completedDate || new Date(),\n                  inspectionId: inspection.id\n                }\n              );\n            }\n          }\n        } catch (emailError) {\n          console.error('Failed to send inspection complete email:', emailError);\n        }\n      }\n\n      res.json(updatedInspection);\n    } catch (error) {\n      console.error(\"Error updating inspection:\", error);\n      res.status(500).json({ message: \"Failed to update inspection\" });\n    }\n  });\n\n  app.patch(\"/api/inspections/:id/status\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { status } = req.body;\n      \n      // Get inspection details before updating\n      const inspection = await storage.getInspection(id);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n      \n      // NOTE: Credit consumption removed from manual status changes\n      // Credits are only consumed during actual inspection submission workflow\n      // This allows flexible status management without credit restrictions\n\n      // Update status\n      const updatedInspection = await storage.updateInspectionStatus(\n        id,\n        status,\n        status === \"completed\" ? new Date() : undefined\n      );\n\n      // Send email notification to owner when inspection is completed\n      if (status === \"completed\") {\n        try {\n          // Get inspector details\n          const inspector = await storage.getUser(inspection.inspectorId);\n          const inspectorName = inspector ? `${inspector.firstName || ''} ${inspector.lastName || ''}`.trim() || inspector.username : 'Unknown Inspector';\n          \n          // Get property or block name\n          let propertyName: string | undefined;\n          let blockName: string | undefined;\n          let organizationId: string | undefined;\n          \n          if (inspection.propertyId) {\n            const property = await storage.getProperty(inspection.propertyId);\n            propertyName = property?.name;\n            organizationId = property?.organizationId;\n          } else if (inspection.blockId) {\n            const block = await storage.getBlock(inspection.blockId);\n            blockName = block?.name;\n            organizationId = block?.organizationId;\n          }\n\n          // Get organization owner's email\n          if (organizationId) {\n            const owners = await storage.getUsersByOrganization(organizationId);\n            const owner = owners.find(u => u.role === 'owner');\n            \n            if (owner && owner.email) {\n              await sendInspectionCompleteEmail(\n                owner.email, // Email address\n                `${owner.firstName || ''} ${owner.lastName || ''}`.trim() || owner.email,\n                {\n                  type: inspection.type,\n                  propertyName,\n                  blockName,\n                  inspectorName,\n                  completedDate: updatedInspection.completedDate || new Date(),\n                  inspectionId: inspection.id\n                }\n              );\n              console.log(`Inspection complete email sent to owner: ${owner.email}`);\n            } else {\n              console.warn('No owner found for organization or owner has no email:', organizationId);\n            }\n          }\n        } catch (emailError) {\n          // Log email error but don't fail the request\n          console.error('Failed to send inspection complete email:', emailError);\n        }\n      }\n\n      res.json(updatedInspection);\n    } catch (error) {\n      console.error(\"Error updating inspection status:\", error);\n      res.status(500).json({ message: \"Failed to update inspection status\" });\n    }\n  });\n\n  // ==================== INSPECTION RESPONSE ROUTES ====================\n\n  // Create or update inspection response\n  app.post(\"/api/inspections/:inspectionId/responses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify inspection exists\n      const inspection = await storage.getInspection(req.params.inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ error: \"Inspection not found\" });\n      }\n\n      // Verify inspection belongs to user's organization via property or block\n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property || property.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block || block.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      }\n\n      // Prevent inspectionId override from request body\n      const { inspectionId: _, ...safeBody } = req.body;\n      const response = await storage.createInspectionResponse({\n        ...safeBody,\n        inspectionId: req.params.inspectionId,\n      });\n\n      res.json(response);\n    } catch (error) {\n      console.error(\"Error creating inspection response:\", error);\n      res.status(500).json({ error: \"Failed to create inspection response\" });\n    }\n  });\n\n  // Get all responses for an inspection\n  app.get(\"/api/inspections/:inspectionId/responses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify inspection exists\n      const inspection = await storage.getInspection(req.params.inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ error: \"Inspection not found\" });\n      }\n\n      // Verify inspection belongs to user's organization via property or block\n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property || property.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block || block.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      }\n\n      const responses = await storage.getInspectionResponses(req.params.inspectionId);\n      res.json(responses);\n    } catch (error) {\n      console.error(\"Error fetching inspection responses:\", error);\n      res.status(500).json({ error: \"Failed to fetch inspection responses\" });\n    }\n  });\n\n  // Update inspection response\n  app.patch(\"/api/inspection-responses/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Get the response to find its inspection\n      const existingResponse = await storage.getInspectionResponse(req.params.id);\n      if (!existingResponse) {\n        return res.status(404).json({ error: \"Response not found\" });\n      }\n\n      // Verify the inspection belongs to user's organization\n      const inspection = await storage.getInspection(existingResponse.inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ error: \"Inspection not found\" });\n      }\n\n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property || property.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block || block.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      }\n\n      // Prevent inspectionId changes in updates\n      const { inspectionId: _, ...safeUpdates } = req.body;\n      const updated = await storage.updateInspectionResponse(req.params.id, safeUpdates);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating inspection response:\", error);\n      res.status(500).json({ error: \"Failed to update inspection response\" });\n    }\n  });\n\n  // Delete inspection response\n  app.delete(\"/api/inspection-responses/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Get the response to find its inspection\n      const existingResponse = await storage.getInspectionResponse(req.params.id);\n      if (!existingResponse) {\n        return res.status(404).json({ error: \"Response not found\" });\n      }\n\n      // Verify the inspection belongs to user's organization\n      const inspection = await storage.getInspection(existingResponse.inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ error: \"Inspection not found\" });\n      }\n\n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property || property.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block || block.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      }\n\n      await storage.deleteInspectionResponse(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting inspection response:\", error);\n      res.status(500).json({ error: \"Failed to delete inspection response\" });\n    }\n  });\n\n  // ==================== INSPECTION ITEM ROUTES ====================\n  \n  app.post(\"/api/inspection-items\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { inspectionId, category, itemName, photoUrl, conditionRating, notes } = req.body;\n      \n      if (!inspectionId || !category || !itemName) {\n        return res.status(400).json({ message: \"Inspection ID, category, and item name are required\" });\n      }\n\n      const item = await storage.createInspectionItem({\n        inspectionId,\n        category,\n        itemName,\n        photoUrl: photoUrl || null,\n        conditionRating: conditionRating || null,\n        notes: notes || null,\n      });\n\n      console.log(`[POST /api/inspection-items] Created item:`, {\n        id: item.id,\n        inspectionId: item.inspectionId,\n        category: item.category,\n        itemName: item.itemName,\n      });\n\n      res.json(item);\n    } catch (error) {\n      console.error(\"Error creating inspection item:\", error);\n      res.status(500).json({ message: \"Failed to create inspection item\" });\n    }\n  });\n\n  // ==================== AI ANALYSIS ROUTES ====================\n  \n  app.post(\"/api/ai/analyze-photo\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Validate request body\n      const validation = analyzePhotoSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { itemId } = validation.data;\n\n      // Get the inspection item\n      const item = await storage.getInspectionItem(itemId);\n      \n      if (!item || !item.photoUrl) {\n        return res.status(400).json({ message: \"Inspection item not found or has no photo\" });\n      }\n\n      // Get user and verify organization membership\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Verify the inspection item belongs to the user's organization\n      const inspection = await storage.getInspection(item.inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Check ownership via property OR block\n      let ownerOrgId: string | null = null;\n      \n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property) {\n          return res.status(404).json({ message: \"Property not found\" });\n        }\n        ownerOrgId = property.organizationId;\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block) {\n          return res.status(404).json({ message: \"Block not found\" });\n        }\n        ownerOrgId = block.organizationId;\n      } else {\n        return res.status(400).json({ message: \"Inspection has no property or block assigned\" });\n      }\n\n      // Verify organization ownership\n      if (ownerOrgId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied: Inspection item does not belong to your organization\" });\n      }\n\n      // Check credits AFTER verifying ownership\n      const organization = await storage.getOrganization(user.organizationId);\n      if (!organization || (organization.creditsRemaining ?? 0) < 1) {\n        return res.status(402).json({ message: \"Insufficient credits\" });\n      }\n\n      // Convert photo to base64 data URL\n      console.log(\"[Inspection Item Analysis] Converting photo to base64:\", item.photoUrl);\n      \n      let photoUrl: string;\n      if (item.photoUrl.startsWith(\"http\")) {\n        // External URL - use directly\n        photoUrl = item.photoUrl;\n      } else {\n        // Internal object storage - convert to base64\n        try {\n          const objectStorageService = new ObjectStorageService();\n          // Ensure path starts with /objects/\n          const photoPath = item.photoUrl.startsWith('/objects/') ? item.photoUrl : `/objects/${item.photoUrl}`;\n          const objectFile = await objectStorageService.getObjectEntityFile(photoPath);\n          \n          // Read the file contents using fs.readFile first\n          const photoBuffer = await fs.readFile(objectFile.name);\n          \n          // Always detect MIME type from buffer for reliability\n          let mimeType = detectImageMimeType(photoBuffer);\n          \n          // Get metadata for logging purposes\n          const [metadata] = await objectFile.getMetadata();\n          const metadataContentType = metadata.contentType;\n          \n          console.log(`[Inspection Item Analysis] MIME type detection:`, {\n            detected: mimeType,\n            fromMetadata: metadataContentType,\n            bufferSize: photoBuffer.length,\n          });\n          \n          // Ensure we have a valid image MIME type\n          if (!mimeType || !mimeType.startsWith('image/')) {\n            console.warn(`[Inspection Item Analysis] Invalid MIME type detected: ${mimeType}, defaulting to image/jpeg`);\n            mimeType = 'image/jpeg';\n          }\n          \n          // Convert to base64 data URL\n          const base64Image = photoBuffer.toString('base64');\n          photoUrl = `data:${mimeType};base64,${base64Image}`;\n          \n          console.log(\"[Inspection Item Analysis] Converted to base64 data URL:\", photoPath, `(${mimeType})`);\n        } catch (error: any) {\n          // Safely log error without circular reference issues\n          const errorMessage = error?.message || String(error);\n          console.error(\"[Inspection Item Analysis] Error converting photo to base64:\", {\n            photoUrl: item.photoUrl,\n            message: errorMessage,\n            errorType: error?.constructor?.name,\n          });\n          if (error instanceof ObjectNotFoundError) {\n            throw new Error(`Photo not found: ${item.photoUrl}. The file may have been deleted or moved.`);\n          }\n          throw new Error(`Failed to load photo for analysis: ${item.photoUrl}. ${errorMessage}`);\n        }\n      }\n\n      // Call OpenAI Vision API using Responses API\n      const response = await getOpenAI().responses.create({\n        model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n        input: [\n          {\n            role: \"user\",\n            content: normalizeApiContent([\n              {\n                type: \"text\",\n                text: `Analyze this ${item.category} - ${item.itemName} photo from a property inspection. Provide a detailed condition assessment including any damage, wear, cleanliness issues, or notable features. Be specific and objective.`\n              },\n              {\n                type: \"image_url\",\n                image_url: photoUrl\n              }\n            ])\n          }\n        ],\n        max_output_tokens: 300,\n      });\n\n      let analysis = response.output_text || response.output?.[0]?.content?.[0]?.text || \"Unable to analyze image\";\n      \n      // Strip markdown asterisks from the response\n      analysis = analysis.replace(/\\*\\*/g, '');\n\n      // Update the item with AI analysis\n      await storage.updateInspectionItemAI(itemId, analysis);\n\n      // Deduct credit\n      await storage.updateOrganizationCredits(\n        organization.id,\n        (organization.creditsRemaining ?? 0) - 1\n      );\n\n      await storage.createCreditTransaction({\n        organizationId: organization.id,\n        amount: -1,\n        type: \"inspection\",\n        description: `AI photo analysis: ${item.category} - ${item.itemName}`,\n      });\n\n      res.json({ analysis });\n    } catch (error: any) {\n      // Safely log error without circular reference issues\n      const errorMessage = error?.message || String(error);\n      console.error(\"Error analyzing photo:\", {\n        message: errorMessage,\n        status: error?.status,\n        code: error?.code,\n      });\n      res.status(500).json({ message: \"Failed to analyze photo\" });\n    }\n  });\n\n  // AI field-level inspection analysis\n  app.post(\"/api/ai/inspect-field\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Validate request body\n      const validation = inspectFieldSchema.safeParse(req.body);\n      if (!validation.success) {\n        console.error(\"[InspectAI] Validation failed:\", validation.error.errors);\n        console.error(\"[InspectAI] Request body:\", req.body);\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { inspectionId, fieldKey, fieldLabel, fieldDescription, photos } = validation.data;\n\n      // Get user and verify organization membership\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Verify the inspection belongs to the user's organization\n      const inspection = await storage.getInspection(inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Check ownership via property OR block\n      let ownerOrgId: string | null = null;\n      \n      if (inspection.propertyId) {\n        const property = await storage.getProperty(inspection.propertyId);\n        if (!property) {\n          return res.status(404).json({ message: \"Property not found\" });\n        }\n        ownerOrgId = property.organizationId;\n      } else if (inspection.blockId) {\n        const block = await storage.getBlock(inspection.blockId);\n        if (!block) {\n          return res.status(404).json({ message: \"Block not found\" });\n        }\n        ownerOrgId = block.organizationId;\n      } else {\n        return res.status(400).json({ message: \"Inspection has no property or block assigned\" });\n      }\n\n      // Verify organization ownership\n      if (ownerOrgId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied: Inspection does not belong to your organization\" });\n      }\n\n      // Check credits (1 credit per field inspection)\n      const organization = await storage.getOrganization(user.organizationId);\n      if (!organization || (organization.creditsRemaining ?? 0) < 1) {\n        return res.status(402).json({ message: \"Insufficient credits\" });\n      }\n\n      // Construct image data URLs - download images and convert to base64\n      const objectStorageService = new ObjectStorageService();\n      const photoUrls = await Promise.all(photos.map(async (photo) => {\n        // If already a full HTTP URL, use it directly\n        if (photo.startsWith(\"http\")) {\n          return photo;\n        }\n        \n        // If it's an /objects/ path, download the image and convert to base64 data URL\n        try {\n          // Ensure path starts with /objects/\n          const photoPath = photo.startsWith('/objects/') ? photo : `/objects/${photo}`;\n          const objectFile = await objectStorageService.getObjectEntityFile(photoPath);\n          \n          // Read the file contents using fs.readFile first\n          const fileBuffer = await fs.readFile(objectFile.name);\n          \n          // Always detect MIME type from buffer for reliability\n          let contentType = detectImageMimeType(fileBuffer);\n          \n          // Get metadata for logging purposes\n          const [metadata] = await objectFile.getMetadata();\n          const metadataContentType = metadata.contentType;\n          \n          console.log(`[InspectAI] MIME type detection:`, {\n            detected: contentType,\n            fromMetadata: metadataContentType,\n            bufferSize: fileBuffer.length,\n          });\n          \n          // Ensure we have a valid image MIME type\n          if (!contentType || !contentType.startsWith('image/')) {\n            console.warn(`[InspectAI] Invalid MIME type detected: ${contentType}, defaulting to image/jpeg`);\n            contentType = 'image/jpeg';\n          }\n          \n          // Convert to base64 data URL\n          const base64Data = fileBuffer.toString('base64');\n          const dataUrl = `data:${contentType};base64,${base64Data}`;\n          \n          console.log(`[InspectAI] Converted photo to base64 data URL: ${photoPath} (${contentType}, ${base64Data.length} bytes)`);\n          return dataUrl;\n        } catch (error: any) {\n          // Safely log error without circular reference issues\n          const errorMessage = error?.message || String(error);\n          console.error(\"[InspectAI] Error converting photo to base64:\", {\n            photo,\n            message: errorMessage,\n            errorType: error?.constructor?.name,\n          });\n          if (error instanceof ObjectNotFoundError) {\n            throw new Error(`Photo not found: ${photo}. The file may have been deleted or moved.`);\n          }\n          throw new Error(`Failed to load photo for analysis: ${photo}. ${errorMessage}`);\n        }\n      }));\n\n      // Build the prompt with field context - emphasizing focus on the specific inspection point\n      let promptText = `You are analyzing a property inspection photo. Focus SPECIFICALLY on: \"${fieldLabel}\"`;\n      if (fieldDescription) {\n        promptText += `\\nContext: ${fieldDescription}`;\n      }\n      promptText += `\\n\\nIMPORTANT: The photo may show an entire room or area, but you must focus your analysis ONLY on \"${fieldLabel}\". Ignore other elements in the photo that are not directly related to this inspection point.\n\nI have ${photoUrls.length} image(s). Provide a comprehensive inspection report for \"${fieldLabel}\" including:\n1. Overall condition assessment of the ${fieldLabel}\n2. Any visible damage, defects, or wear on the ${fieldLabel}\n3. Cleanliness and maintenance issues related to the ${fieldLabel}\n4. Notable features or observations about the ${fieldLabel}\n5. Recommendations for the ${fieldLabel} (if any)\n\nBe thorough, specific, and objective about the ${fieldLabel}. Do not comment on items outside the scope of \"${fieldLabel}\". This will be used in a professional property inspection report.`;\n\n      // Build content array with text and all images\n      const content: any[] = [\n        {\n          type: \"text\",\n          text: promptText\n        }\n      ];\n\n      // Add all photos - use string format directly for normalizeApiContent\n      photoUrls.forEach((url, index) => {\n        content.push({\n          type: \"image_url\",\n          image_url: url // Pass as string, normalizeApiContent will handle it\n        });\n      });\n\n      console.log(\"[InspectAI] Sending to OpenAI - Photo URLs:\", photoUrls.length, \"photos\");\n      console.log(\"[InspectAI] Content structure:\", JSON.stringify(content.map(c => ({ type: c.type, hasUrl: !!c.image_url })), null, 2));\n\n      // Call OpenAI Vision API using Responses API\n      // Set max_output_tokens to 10000 to allow for very detailed analysis\n      const response = await getOpenAI().responses.create({\n        model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n        input: [\n          {\n            role: \"user\",\n            content: normalizeApiContent(content)\n          }\n        ],\n        max_output_tokens: 10000, // Increased to 10000 to allow very detailed responses\n      });\n\n      // Check if response is incomplete due to token limit\n      if (response.status === \"incomplete\") {\n        const reason = response.incomplete_details?.reason;\n        console.error(\"[InspectAI] Response is incomplete:\", {\n          reason,\n          maxOutputTokens: response.max_output_tokens,\n          outputTokens: response.usage?.output_tokens,\n          reasoningTokens: response.usage?.output_tokens_details?.reasoning_tokens,\n        });\n        \n        if (reason === \"max_output_tokens\") {\n          // Return user-friendly message instead of throwing error\n          return res.status(200).json({ \n            analysis: \"Token limit exceeded. Please try again later.\",\n            tokenExceeded: true \n          });\n        } else {\n          throw new Error(`The analysis response is incomplete: ${reason || \"unknown reason\"}. Please try again.`);\n        }\n      }\n\n      console.log(\"[InspectAI] OpenAI Response structure:\", {\n        status: response.status,\n        hasOutputText: !!response.output_text,\n        outputTextLength: response.output_text?.length || 0,\n        hasOutput: !!response.output,\n        outputLength: response.output?.length || 0,\n        outputFirstItem: response.output?.[0] ? {\n          type: response.output[0].type,\n          hasContent: !!response.output[0].content,\n          contentLength: response.output[0].content?.length || 0,\n          firstContentType: response.output[0].content?.[0]?.type,\n          firstContentText: response.output[0].content?.[0]?.text?.substring(0, 100) || 'N/A'\n        } : null,\n      });\n\n      // Try multiple ways to extract the analysis text\n      let analysis = \"\";\n      \n      // Method 1: Direct output_text (most common)\n      if (response.output_text && response.output_text.trim().length > 0) {\n        analysis = response.output_text;\n        console.log(\"[InspectAI] Using output_text\");\n      }\n      // Method 2: output[0].content[0].text\n      else if (response.output?.[0]?.content?.[0]?.text) {\n        analysis = response.output[0].content[0].text;\n        console.log(\"[InspectAI] Using output[0].content[0].text\");\n      }\n      // Method 3: Check for text type in output array\n      else if (response.output) {\n        // Look for any output item with text content\n        for (const outputItem of response.output) {\n          if (outputItem.type === \"text\" && outputItem.text) {\n            analysis = outputItem.text;\n            console.log(\"[InspectAI] Using output item with type 'text'\");\n            break;\n          }\n          if (outputItem.content) {\n            for (const contentItem of outputItem.content) {\n              if (contentItem.type === \"text\" && contentItem.text) {\n                analysis = contentItem.text;\n                console.log(\"[InspectAI] Using content item with type 'text'\");\n                break;\n              }\n            }\n            if (analysis) break;\n          }\n        }\n      }\n      // Method 4: Check response directly\n      else if (typeof response === 'string') {\n        analysis = response;\n        console.log(\"[InspectAI] Response is a string\");\n      }\n      \n      // Validate we got analysis text\n      if (!analysis || analysis.trim().length === 0) {\n        console.error(\"[InspectAI] Analysis text is empty. Response:\", JSON.stringify(response, null, 2));\n        throw new Error(\"OpenAI API returned an empty analysis. The response may have been incomplete. Please try again.\");\n      }\n      \n      // Strip markdown asterisks from the response\n      analysis = analysis.replace(/\\*\\*/g, '');\n\n      // Deduct credit\n      await storage.updateOrganizationCredits(\n        organization.id,\n        (organization.creditsRemaining ?? 0) - 1\n      );\n\n      await storage.createCreditTransaction({\n        organizationId: organization.id,\n        amount: -1,\n        type: \"inspection\",\n        description: `InspectAI field analysis: ${fieldLabel}`,\n      });\n\n      res.json({ analysis });\n    } catch (error: any) {\n      // Safely log error without circular reference issues\n      const errorMessage = error?.message || String(error);\n      const errorStack = error?.stack;\n      console.error(\"Error analyzing field:\", {\n        message: errorMessage,\n        stack: errorStack?.substring(0, 500), // Limit stack trace length\n        status: error?.status,\n        code: error?.code,\n        type: error?.type,\n        param: error?.param,\n      });\n      \n      // Return more specific error message\n      const userMessage = errorMessage.includes(\"OpenAI\") \n        ? \"AI service returned an error. Please try again.\"\n        : errorMessage.includes(\"credits\")\n        ? \"Insufficient credits for AI analysis\"\n        : errorMessage.includes(\"unexpected response format\") || errorMessage.includes(\"empty analysis\")\n        ? \"AI service returned an invalid response. Please try again.\"\n        : \"Failed to analyze field. Please try again.\";\n      \n      res.status(500).json({ message: userMessage });\n    }\n  });\n\n  // Get matching Check-In inspection for reference during Check-Out\n  app.get(\"/api/inspections/:id/check-in-reference\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id: checkOutInspectionId } = req.params;\n      \n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Get the current inspection (should be check-out)\n      const currentInspection = await storage.getInspection(checkOutInspectionId);\n      if (!currentInspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Verify ownership\n      let ownerOrgId: string | null = null;\n      if (currentInspection.propertyId) {\n        const property = await storage.getProperty(currentInspection.propertyId);\n        if (!property) {\n          return res.status(404).json({ message: \"Property not found\" });\n        }\n        ownerOrgId = property.organizationId;\n      } else if (currentInspection.blockId) {\n        const block = await storage.getBlock(currentInspection.blockId);\n        if (!block) {\n          return res.status(404).json({ message: \"Block not found\" });\n        }\n        ownerOrgId = block.organizationId;\n      }\n\n      if (ownerOrgId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Only return check-in reference if current inspection is check-out\n      if (currentInspection.type !== \"check_out\") {\n        return res.json({ checkInInspection: null, checkInEntries: [] });\n      }\n\n      // Find the most recent completed check-in for the same property\n      if (!currentInspection.propertyId) {\n        return res.json({ checkInInspection: null, checkInEntries: [] });\n      }\n\n      const allInspections = await storage.getInspectionsByOrganization(user.organizationId);\n      const checkInInspections = allInspections\n        .filter((i: any) => \n          i.propertyId === currentInspection.propertyId && \n          i.type === \"check_in\" && \n          i.status === \"completed\"\n        )\n        .sort((a: any, b: any) => \n          new Date(b.completedDate || b.scheduledDate).getTime() - \n          new Date(a.completedDate || a.scheduledDate).getTime()\n        );\n\n      if (checkInInspections.length === 0) {\n        return res.json({ checkInInspection: null, checkInEntries: [] });\n      }\n\n      const checkInInspection = checkInInspections[0];\n      const checkInEntries = await storage.getInspectionEntries(checkInInspection.id);\n\n      res.json({ \n        checkInInspection, \n        checkInEntries \n      });\n    } catch (error) {\n      console.error(\"Error fetching check-in reference:\", error);\n      res.status(500).json({ message: \"Failed to fetch check-in reference\" });\n    }\n  });\n\n  // Auto-create comparison report for a property (finds last check-in and check-out)\n  app.post(\"/api/comparison-reports/auto\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const { propertyId, checkOutInspectionId, fieldKey } = req.body;\n      \n      if (!propertyId) {\n        return res.status(400).json({ message: \"Property ID is required\" });\n      }\n      \n      // Store context for potential future use (e.g., auto-scrolling to the field)\n      const context = { checkOutInspectionId, fieldKey };\n\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Verify property ownership\n      const property = await storage.getProperty(propertyId);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Not authorized to access this property\" });\n      }\n\n      // Check if a comparison report already exists for this property\n      const existingReports = await storage.getComparisonReportsByProperty(propertyId);\n      if (existingReports && existingReports.length > 0) {\n        // Return the most recent report\n        const latestReport = existingReports.sort((a: any, b: any) => \n          new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n        )[0];\n        return res.json({ report: latestReport, created: false });\n      }\n\n      // Get all inspections for this property\n      const allInspections = await storage.getInspectionsByOrganization(user.organizationId);\n      const propertyInspections = allInspections.filter((i: any) => i.propertyId === propertyId);\n\n      // Find the most recent completed check-in and check-out inspections\n      const checkInInspections = propertyInspections\n        .filter((i: any) => i.type === \"check_in\" && i.status === \"completed\")\n        .sort((a: any, b: any) => new Date(b.completedDate || b.scheduledDate).getTime() - new Date(a.completedDate || a.scheduledDate).getTime());\n\n      const checkOutInspections = propertyInspections\n        .filter((i: any) => i.type === \"check_out\" && i.status === \"completed\")\n        .sort((a: any, b: any) => new Date(b.completedDate || b.scheduledDate).getTime() - new Date(a.completedDate || a.scheduledDate).getTime());\n\n      if (checkInInspections.length === 0) {\n        return res.status(400).json({ message: \"No completed check-in inspection found for this property\" });\n      }\n\n      if (checkOutInspections.length === 0) {\n        return res.status(400).json({ message: \"No completed check-out inspection found for this property\" });\n      }\n\n      const lastCheckIn = checkInInspections[0];\n      const lastCheckOut = checkOutInspections[0];\n\n      // Get tenant assigned to property (optional - may be null for vacant units)\n      const tenantAssignments = await storage.getTenantAssignmentsByProperty(propertyId, user.organizationId);\n      const activeTenant = tenantAssignments.find(ta => ta.isActive);\n\n      // Check credits (2 credits for comparison report generation)\n      const organization = await storage.getOrganization(user.organizationId);\n      if (!organization || (organization.creditsRemaining ?? 0) < 2) {\n        return res.status(402).json({ message: \"Insufficient credits (2 required for comparison report)\" });\n      }\n\n      // Get inspection entries marked for review from check-out inspection\n      const checkOutEntries = await storage.getInspectionEntries(lastCheckOut.id);\n      const markedEntries = checkOutEntries.filter(entry => entry.markedForReview);\n\n      if (markedEntries.length === 0) {\n        return res.status(400).json({ message: \"No inspection entries marked for review. Please mark items for review during check-out inspection.\" });\n      }\n\n      // Get all check-in entries for matching\n      const checkInEntries = await storage.getInspectionEntries(lastCheckIn.id);\n\n      console.log(`[Auto-Create Comparison] Creating report for property ${propertyId}`, {\n        checkInId: lastCheckIn.id,\n        checkOutId: lastCheckOut.id,\n        hasTenant: !!activeTenant,\n        tenantId: activeTenant?.tenantId || null\n      });\n\n      // Create comparison report (tenant may be null for vacant units)\n      const report = await storage.createComparisonReport({\n        organizationId: user.organizationId,\n        propertyId,\n        checkInInspectionId: lastCheckIn.id,\n        checkOutInspectionId: lastCheckOut.id,\n        tenantId: activeTenant?.tenantId || null,\n        status: \"draft\",\n        totalEstimatedCost: \"0\",\n        aiAnalysisJson: { summary: \"Processing...\", items: [] },\n        generatedBy: user.id,\n      });\n\n      // Process marked entries asynchronously (same logic as the regular endpoint)\n      (async () => {\n        try {\n          let totalCost = 0;\n          const itemAnalyses: any[] = [];\n\n          for (const checkOutEntry of markedEntries) {\n            const checkInEntry = checkInEntries.find(\n              e => e.sectionRef === checkOutEntry.sectionRef && \n                   e.fieldKey === checkOutEntry.fieldKey\n            );\n\n            let aiComparison: any = { summary: \"No images to compare\" };\n            let estimatedCost = 0;\n            let depreciation = 0;\n\n            if (checkOutEntry.photos && checkOutEntry.photos.length > 0) {\n              try {\n                const checkInPhotos = checkInEntry?.photos || [];\n                const checkOutPhotos = checkOutEntry.photos || [];\n\n                const imageContent: any[] = [];\n                \n                if (checkInPhotos.length > 0) {\n                  imageContent.push({\n                    type: \"text\",\n                    text: \"CHECK-IN PHOTOS (baseline condition):\"\n                  });\n                  checkInPhotos.slice(0, 2).forEach((url) => {\n                    imageContent.push({\n                      type: \"image_url\",\n                      image_url: { url, detail: \"high\" }\n                    });\n                  });\n                }\n\n                imageContent.push({\n                  type: \"text\",\n                  text: \"CHECK-OUT PHOTOS (current condition):\"\n                });\n                checkOutPhotos.slice(0, 2).forEach((url) => {\n                  imageContent.push({\n                    type: \"image_url\",\n                    image_url: { url, detail: \"high\" }\n                  });\n                });\n\n                const prompt = `Compare check-in vs check-out condition. Analyze damage, wear, cleanliness. Provide:\n1. Brief damage assessment (2-3 sentences)\n2. Estimated repair/cleaning cost in GBP (number only, or 0 if minimal)\n3. Recommended action (repair/clean/replace/acceptable)\n\nFormat: \nDAMAGE: [assessment]\nCOST: [number]\nACTION: [recommendation]`;\n\n                imageContent.unshift({\n                  type: \"text\",\n                  text: prompt\n                });\n\n                if (!openai) {\n                  throw new Error(\"OpenAI client not initialized\");\n                }\n\n                const visionResponse = await openai.responses.create({\n                  model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n                  input: [{ role: \"user\", content: normalizeApiContent(imageContent) }],\n                  max_output_tokens: 500,\n                });\n\n                const analysis = visionResponse.output_text || visionResponse.output?.[0]?.content?.[0]?.text || \"\";\n                const costMatch = analysis.match(/COST:\\s*?(\\d+)/i) || analysis.match(/COST:\\s*(\\d+)/i);\n                estimatedCost = costMatch ? parseInt(costMatch[1]) : 0;\n\n                aiComparison = {\n                  summary: analysis.replace(/\\*\\*/g, ''),\n                  checkInPhotos,\n                  checkOutPhotos,\n                  estimatedCost\n                };\n\n              } catch (visionError) {\n                console.error(\"Vision API error:\", visionError);\n                aiComparison = { summary: \"Error analyzing images\", error: true };\n              }\n            }\n\n            const finalCost = Math.max(0, estimatedCost - depreciation);\n            totalCost += finalCost;\n\n            await storage.createComparisonReportItem({\n              comparisonReportId: report.id,\n              checkInEntryId: checkInEntry?.id || null,\n              checkOutEntryId: checkOutEntry.id,\n              sectionRef: checkOutEntry.sectionRef,\n              itemRef: checkOutEntry.itemRef || null,\n              fieldKey: checkOutEntry.fieldKey,\n              aiComparisonJson: aiComparison,\n              estimatedCost: estimatedCost.toString(),\n              depreciation: depreciation.toString(),\n              finalCost: finalCost.toString(),\n            });\n\n            itemAnalyses.push({\n              sectionRef: checkOutEntry.sectionRef,\n              fieldKey: checkOutEntry.fieldKey,\n              analysis: aiComparison.summary,\n              cost: finalCost\n            });\n          }\n\n          await storage.updateComparisonReport(report.id, {\n            totalEstimatedCost: totalCost.toString(),\n            aiAnalysisJson: {\n              summary: `Comparison complete. ${markedEntries.length} items analyzed. Total estimated cost: ${totalCost}`,\n              items: itemAnalyses\n            }\n          });\n\n          await storage.updateOrganizationCredits(\n            organization.id,\n            (organization.creditsRemaining ?? 0) - 2\n          );\n\n          await storage.createCreditTransaction({\n            organizationId: organization.id,\n            amount: -2,\n            type: \"comparison\",\n            description: `Comparison report generation for property`,\n            relatedId: report.id,\n          });\n\n        } catch (asyncError) {\n          console.error(\"Error in async comparison processing:\", asyncError);\n        }\n      })();\n\n      res.json({ report, created: true });\n    } catch (error) {\n      console.error(\"Error auto-creating comparison report:\", error);\n      res.status(500).json({ message: \"Failed to auto-create comparison report\" });\n    }\n  });\n\n  // Generate comparison report from check-out inspection (comprehensive version with liability assessment)\n  app.post(\"/api/comparison-reports\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      // Validate request body\n      const validation = generateComparisonSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { propertyId, checkInInspectionId, checkOutInspectionId } = validation.data;\n\n      // Check user authorization\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Verify property ownership\n      const property = await storage.getProperty(propertyId);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Not authorized to access this property\" });\n      }\n\n      // Get tenant assigned to property (optional - may be null for vacant units)\n      const tenantAssignments = await storage.getTenantAssignmentsByProperty(propertyId, user.organizationId);\n      const activeTenant = tenantAssignments.find(ta => ta.isActive);\n\n      // Check credits (2 credits for comparison report generation)\n      const organization = await storage.getOrganization(user.organizationId);\n      if (!organization || (organization.creditsRemaining ?? 0) < 2) {\n        return res.status(402).json({ message: \"Insufficient credits (2 required for comparison report)\" });\n      }\n\n      // Get inspection entries marked for review from check-out inspection\n      const checkOutEntries = await storage.getInspectionEntries(checkOutInspectionId);\n      const markedEntries = checkOutEntries.filter(entry => entry.markedForReview);\n\n      if (markedEntries.length === 0) {\n        return res.status(400).json({ message: \"No inspection entries marked for review. Please mark items for review during check-out inspection.\" });\n      }\n\n      // Get all check-in entries for matching\n      const checkInEntries = await storage.getInspectionEntries(checkInInspectionId);\n\n      console.log(`[Manual Create Comparison] Creating report for property ${propertyId}`, {\n        checkInInspectionId,\n        checkOutInspectionId,\n        hasTenant: !!activeTenant,\n        tenantId: activeTenant?.tenantId || null\n      });\n\n      // Create comparison report (tenant may be null for vacant units)\n      const report = await storage.createComparisonReport({\n        organizationId: user.organizationId,\n        propertyId,\n        checkInInspectionId,\n        checkOutInspectionId,\n        tenantId: activeTenant?.tenantId || null,\n        status: \"draft\",\n        totalEstimatedCost: \"0\",\n        aiAnalysisJson: { summary: \"Processing...\", items: [] },\n        generatedBy: user.id,\n      });\n\n      // Process each marked entry asynchronously (don't block response)\n      // In production, this would be a background job\n      (async () => {\n        try {\n          let totalCost = 0;\n          const itemAnalyses: any[] = [];\n\n          for (const checkOutEntry of markedEntries) {\n            // Find matching check-in entry\n            const checkInEntry = checkInEntries.find(\n              e => e.sectionRef === checkOutEntry.sectionRef && \n                   e.fieldKey === checkOutEntry.fieldKey\n            );\n\n            let aiComparison: any = { summary: \"No images to compare\" };\n            let estimatedCost = 0;\n            let depreciation = 0;\n\n            // AI image comparison using OpenAI Vision API\n            if (checkOutEntry.photos && checkOutEntry.photos.length > 0) {\n              try {\n                const checkInPhotos = checkInEntry?.photos || [];\n                const checkOutPhotos = checkOutEntry.photos || [];\n\n                // Prepare image content for Vision API\n                const imageContent: any[] = [];\n                \n                // Add check-in photos (if available)\n                if (checkInPhotos.length > 0) {\n                  imageContent.push({\n                    type: \"text\",\n                    text: \"CHECK-IN PHOTOS (baseline condition):\"\n                  });\n                  checkInPhotos.slice(0, 2).forEach((url) => {\n                    imageContent.push({\n                      type: \"image_url\",\n                      image_url: { url }\n                    });\n                  });\n                }\n\n                // Add check-out photos\n                imageContent.push({\n                  type: \"text\",\n                  text: \"CHECK-OUT PHOTOS (current condition):\"\n                });\n                checkOutPhotos.slice(0, 2).forEach((url) => {\n                  imageContent.push({\n                    type: \"image_url\",\n                    image_url: { url }\n                  });\n                });\n\n                // Call OpenAI Vision API\n                const prompt = `You are an expert building inspector analyzing property conditions for a Build-to-Rent operation.\n\nCompare the check-in photos (baseline) with the check-out photos (current condition) for:\nSection: ${checkOutEntry.sectionRef}\nField: ${checkOutEntry.fieldKey}\n\nProvide a detailed analysis in JSON format:\n{\n  \"differences\": \"Describe visible differences between check-in and check-out\",\n  \"damage\": \"List any damage, wear, or deterioration observed\",\n  \"severity\": \"low|medium|high\",\n  \"repair_description\": \"What repairs are needed\",\n  \"estimated_cost_range\": {\"min\": number, \"max\": number}\n}\n\nBe objective and specific. Focus on actionable repairs.`;\n\n                const response = await getOpenAI().responses.create({\n                  model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n                  input: [\n                    {\n                      role: \"user\",\n                      content: normalizeApiContent([\n                        { type: \"text\", text: prompt },\n                        ...imageContent\n                      ])\n                    }\n                  ],\n                  max_output_tokens: 600,\n                });\n\n                let aiResponse = response.output_text || response.output?.[0]?.content?.[0]?.text || \"{}\";\n                \n                // Strip markdown asterisks from the response\n                aiResponse = aiResponse.replace(/\\*\\*/g, '');\n                \n                try {\n                  aiComparison = JSON.parse(aiResponse);\n                  // Use mid-point of cost range as estimate\n                  estimatedCost = ((aiComparison.estimated_cost_range?.min || 0) + \n                                   (aiComparison.estimated_cost_range?.max || 0)) / 2;\n                } catch {\n                  aiComparison = { summary: aiResponse };\n                }\n\n              } catch (error) {\n                console.error(\"Error in AI comparison:\", error);\n                aiComparison = { error: \"Failed to analyze images\" };\n              }\n            }\n\n            // Calculate depreciation using actual asset data\n            if (checkOutEntry.assetInventoryId) {\n              try {\n                const asset = await storage.getAssetById(checkOutEntry.assetInventoryId);\n                if (asset && asset.purchasePrice && asset.datePurchased) {\n                  const purchasePrice = parseFloat(asset.purchasePrice);\n                  const purchaseDate = new Date(asset.datePurchased);\n                  const currentDate = new Date();\n                  \n                  // Calculate years since purchase\n                  const yearsSincePurchase = (currentDate.getTime() - purchaseDate.getTime()) / (1000 * 60 * 60 * 24 * 365.25);\n                  \n                  // Use asset's depreciation rate or calculate from expected lifespan\n                  let annualDepreciationAmount = 0;\n                  if (asset.depreciationPerYear) {\n                    annualDepreciationAmount = parseFloat(asset.depreciationPerYear);\n                  } else if (asset.expectedLifespanYears && asset.expectedLifespanYears > 0) {\n                    annualDepreciationAmount = purchasePrice / asset.expectedLifespanYears;\n                  }\n                  \n                  // If no depreciation data available, fall back to 10%\n                  if (annualDepreciationAmount > 0) {\n                    // Calculate total accumulated depreciation\n                    const accumulatedDepreciation = annualDepreciationAmount * yearsSincePurchase;\n                    \n                    // Apply depreciation as percentage of repair cost\n                    // If asset has depreciated 50% and repair costs $100, tenant pays $50\n                    const depreciationPercentage = Math.min(1.0, accumulatedDepreciation / purchasePrice);\n                    depreciation = estimatedCost * depreciationPercentage;\n                  } else {\n                    // Asset exists but has no depreciation metadata: use 10% fallback\n                    depreciation = estimatedCost * 0.10;\n                  }\n                } else {\n                  // Fallback: 10% depreciation if asset data is incomplete\n                  depreciation = estimatedCost * 0.10;\n                }\n              } catch (error) {\n                console.error(\"Error calculating asset depreciation:\", error);\n                depreciation = estimatedCost * 0.10;\n              }\n            } else {\n              // No linked asset: use conservative 10% depreciation\n              depreciation = estimatedCost * 0.10;\n            }\n\n            const finalCost = Math.max(0, estimatedCost - depreciation);\n            totalCost += finalCost;\n\n            itemAnalyses.push({\n              sectionRef: checkOutEntry.sectionRef,\n              fieldKey: checkOutEntry.fieldKey,\n              checkInPhotos: checkInEntry?.photos || [],\n              checkOutPhotos: checkOutEntry.photos || [],\n              aiComparison,\n              estimatedCost,\n              depreciation,\n              finalCost,\n            });\n\n            // Create comparison report item\n            await storage.createComparisonReportItem({\n              comparisonReportId: report.id,\n              checkInEntryId: checkInEntry?.id || null,\n              checkOutEntryId: checkOutEntry.id,\n              sectionRef: checkOutEntry.sectionRef,\n              itemRef: checkOutEntry.itemRef,\n              fieldKey: checkOutEntry.fieldKey,\n              aiComparisonJson: aiComparison,\n              estimatedCost: estimatedCost.toFixed(2),\n              depreciation: depreciation.toFixed(2),\n              finalCost: finalCost.toFixed(2),\n            });\n          }\n\n          // Update report with total cost and analysis\n          await storage.updateComparisonReport(report.id, {\n            totalEstimatedCost: totalCost.toFixed(2),\n            aiAnalysisJson: { \n              summary: `Analyzed ${markedEntries.length} items. Total estimated cost: $${totalCost.toFixed(2)}`, \n              items: itemAnalyses \n            },\n            status: \"under_review\",\n          });\n\n        } catch (error) {\n          console.error(\"Error processing comparison items:\", error);\n        }\n      })();\n\n      // Deduct credits\n      await storage.updateOrganizationCredits(\n        organization.id,\n        (organization.creditsRemaining ?? 0) - 2\n      );\n\n      await storage.createCreditTransaction({\n        organizationId: organization.id,\n        amount: -2,\n        type: \"comparison\",\n        description: `Comparison report generation for property`,\n        relatedId: report.id,\n      });\n\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error generating comparison report:\", error);\n      res.status(500).json({ message: \"Failed to generate comparison report\" });\n    }\n  });\n\n  app.get(\"/api/comparisons/:propertyId\", isAuthenticated, async (req, res) => {\n    try {\n      const { propertyId } = req.params;\n      const reports = await storage.getComparisonReportsByProperty(propertyId);\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Error fetching comparisons:\", error);\n      res.status(500).json({ message: \"Failed to fetch comparisons\" });\n    }\n  });\n\n  // List all comparison reports for organization (operators only)\n  app.get(\"/api/comparison-reports\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const reports = await storage.getComparisonReportsByOrganization(user.organizationId);\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Error fetching comparison reports:\", error);\n      res.status(500).json({ message: \"Failed to fetch comparison reports\" });\n    }\n  });\n\n  // Get single comparison report with items\n  app.get(\"/api/comparison-reports/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const report = await storage.getComparisonReport(id);\n      if (!report) {\n        return res.status(404).json({ message: \"Comparison report not found\" });\n      }\n\n      // Verify organization ownership\n      if (report.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Get report items\n      const items = await storage.getComparisonReportItems(id);\n\n      res.json({ ...report, items });\n    } catch (error) {\n      console.error(\"Error fetching comparison report:\", error);\n      res.status(500).json({ message: \"Failed to fetch comparison report\" });\n    }\n  });\n\n  // Update comparison report status\n  app.patch(\"/api/comparison-reports/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const report = await storage.getComparisonReport(id);\n      if (!report) {\n        return res.status(404).json({ message: \"Comparison report not found\" });\n      }\n\n      // Verify organization ownership\n      if (report.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate status updates\n      const { status } = req.body;\n      const validStatuses = [\"draft\", \"under_review\", \"awaiting_signatures\", \"signed\", \"filed\"];\n      if (status && !validStatuses.includes(status)) {\n        return res.status(400).json({ message: \"Invalid status value\" });\n      }\n\n      const updatedReport = await storage.updateComparisonReport(id, req.body);\n      res.json(updatedReport);\n    } catch (error) {\n      console.error(\"Error updating comparison report:\", error);\n      res.status(500).json({ message: \"Failed to update comparison report\" });\n    }\n  });\n\n  // Get comparison report comments\n  app.get(\"/api/comparison-reports/:id/comments\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const report = await storage.getComparisonReport(id);\n      if (!report) {\n        return res.status(404).json({ message: \"Comparison report not found\" });\n      }\n\n      // Verify organization ownership\n      if (report.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const comments = await storage.getComparisonComments(id);\n      res.json(comments);\n    } catch (error) {\n      console.error(\"Error fetching comments:\", error);\n      res.status(500).json({ message: \"Failed to fetch comments\" });\n    }\n  });\n\n  // Add comparison report comment\n  app.post(\"/api/comparison-reports/:id/comments\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { content } = req.body;\n      const user = await storage.getUser(req.user.id);\n      \n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      if (!content || content.trim().length === 0) {\n        return res.status(400).json({ message: \"Comment content is required\" });\n      }\n\n      const report = await storage.getComparisonReport(id);\n      if (!report) {\n        return res.status(404).json({ message: \"Comparison report not found\" });\n      }\n\n      // Verify organization ownership\n      if (report.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const comment = await storage.createComparisonComment({\n        comparisonReportId: id,\n        userId: user.id,\n        content: content.trim(),\n        isInternal: user.role !== \"tenant\", // Tenant comments are visible, operator comments can be internal\n      });\n\n      res.json(comment);\n    } catch (error) {\n      console.error(\"Error creating comment:\", error);\n      res.status(500).json({ message: \"Failed to create comment\" });\n    }\n  });\n\n  // Electronic signature for comparison reports\n  app.post(\"/api/comparison-reports/:id/sign\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { signature } = req.body; // Typed name\n      const user = await storage.getUser(req.user.id);\n      \n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      if (!signature || signature.trim().length === 0) {\n        return res.status(400).json({ message: \"Signature (typed name) is required\" });\n      }\n\n      const report = await storage.getComparisonReport(id);\n      if (!report) {\n        return res.status(404).json({ message: \"Comparison report not found\" });\n      }\n\n      // Verify organization ownership\n      if (report.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Get IP address from request\n      const ipAddress = req.ip || req.connection?.remoteAddress || \"unknown\";\n\n      // Determine who is signing\n      const isOperator = user.role === \"owner\" || user.role === \"clerk\";\n      const isTenant = user.role === \"tenant\";\n\n      if (!isOperator && !isTenant) {\n        return res.status(403).json({ message: \"Only operators and tenants can sign comparison reports\" });\n      }\n\n      // Check if already signed by this party\n      if (isOperator && report.operatorSignature) {\n        return res.status(400).json({ message: \"Operator has already signed this report\" });\n      }\n      if (isTenant && report.tenantSignature) {\n        return res.status(400).json({ message: \"Tenant has already signed this report\" });\n      }\n\n      // Update signature fields\n      const updates: any = {};\n      const now = new Date();\n\n      if (isOperator) {\n        updates.operatorSignature = signature.trim();\n        updates.operatorSignedAt = now;\n        updates.operatorSignedIp = ipAddress;\n      } else if (isTenant) {\n        updates.tenantSignature = signature.trim();\n        updates.tenantSignedAt = now;\n        updates.tenantSignedIp = ipAddress;\n      }\n\n      // Check if both parties have now signed\n      const bothSigned = (\n        (isOperator || report.operatorSignature) && \n        (isTenant || report.tenantSignature)\n      );\n\n      if (bothSigned) {\n        updates.status = \"signed\";\n      }\n\n      const updatedReport = await storage.updateComparisonReport(id, updates);\n      res.json(updatedReport);\n    } catch (error) {\n      console.error(\"Error signing comparison report:\", error);\n      res.status(500).json({ message: \"Failed to sign comparison report\" });\n    }\n  });\n\n  // ==================== COMPLIANCE ROUTES ====================\n  \n  app.post(\"/api/compliance\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Validate request body\n      // Note: expiryDate is coerced to Date by the schema using z.coerce.date()\n      const validation = insertComplianceDocumentSchema.omit({ organizationId: true, uploadedBy: true }).safeParse(req.body);\n      if (!validation.success) {\n        console.error(\"Compliance document validation errors:\", validation.error.errors);\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { documentType, documentUrl, expiryDate, propertyId, blockId } = validation.data;\n\n      const doc = await storage.createComplianceDocument({\n        organizationId: user.organizationId,\n        propertyId: propertyId || null,\n        blockId: blockId || null,\n        documentType,\n        documentUrl,\n        // expiryDate is already a Date object from z.coerce.date() validation\n        expiryDate: expiryDate || null,\n        uploadedBy: userId,\n      });\n\n      res.json(doc);\n    } catch (error) {\n      console.error(\"Error creating compliance document:\", error);\n      res.status(500).json({ message: \"Failed to create compliance document\" });\n    }\n  });\n\n  app.get(\"/api/compliance\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const docs = await storage.getComplianceDocuments(user.organizationId);\n      res.json(docs);\n    } catch (error) {\n      console.error(\"Error fetching compliance documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch compliance documents\" });\n    }\n  });\n\n  app.get(\"/api/compliance/expiring\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const daysAhead = parseInt(req.query.days as string) || 90;\n      const docs = await storage.getExpiringCompliance(user.organizationId, daysAhead);\n      res.json(docs);\n    } catch (error) {\n      console.error(\"Error fetching expiring compliance:\", error);\n      res.status(500).json({ message: \"Failed to fetch expiring compliance\" });\n    }\n  });\n\n  // ==================== MAINTENANCE ROUTES ====================\n  \n  // AI analyze maintenance image for fix suggestions\n  app.post(\"/api/maintenance/analyze-image\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Validate request body\n      const validation = analyzeMaintenanceImageSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { imageUrl, issueDescription } = validation.data;\n\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Check if organization has credits\n      const organization = await storage.getOrganization(user.organizationId);\n      const currentCredits = organization?.creditsRemaining ?? 0;\n      if (!organization || currentCredits < 1) {\n        return res.status(402).json({ \n          message: \"Insufficient credits. Please purchase more credits to use AI analysis.\",\n          creditsRemaining: currentCredits\n        });\n      }\n\n      // Call OpenAI Vision API for maintenance issue analysis\n      const openaiInstance = getOpenAI();\n      const prompt = issueDescription \n        ? `You are a maintenance expert analyzing a property maintenance issue. The tenant reports: \"${issueDescription}\". \n           Analyze the image and provide:\n           1. A brief assessment of the issue (2-3 sentences)\n           2. 3-5 possible DIY fixes the tenant can try immediately\n           3. Whether this requires professional help\n           Format your response in clear sections.`\n        : `You are a maintenance expert analyzing a property maintenance issue. \n           Analyze the image and provide:\n           1. A brief assessment of what maintenance issue you can see (2-3 sentences)\n           2. 3-5 possible DIY fixes that can be tried immediately\n           3. Whether this requires professional help\n           Format your response in clear sections.`;\n\n      const response = await openaiInstance.responses.create({\n        model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n        input: [\n          {\n            role: \"user\",\n            content: normalizeApiContent([\n              { type: \"text\", text: prompt },\n              { type: \"image_url\", image_url: imageUrl }\n            ])\n          }\n        ],\n        max_output_tokens: 800,\n      });\n\n      const suggestedFixes = response.output_text || response.output?.[0]?.content?.[0]?.text || \"Unable to analyze the image at this time.\";\n\n      // Deduct credit\n      await storage.deductCredit(user.organizationId, 1, \"AI maintenance image analysis\");\n\n      res.json({ \n        suggestedFixes,\n        analysis: {\n          model: \"gpt-5\",\n          timestamp: new Date().toISOString()\n        },\n        creditsRemaining: currentCredits - 1\n      });\n    } catch (error) {\n      console.error(\"Error analyzing maintenance image:\", error);\n      res.status(500).json({ message: \"Failed to analyze image\" });\n    }\n  });\n  \n  app.post(\"/api/maintenance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n\n      // Get user to check organization\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Validate request body\n      const validation = insertMaintenanceRequestSchema.omit({ organizationId: true, reportedBy: true }).safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { propertyId, title, description, priority, photoUrls, aiSuggestedFixes, aiAnalysisJson, inspectionId, inspectionEntryId, source } = validation.data;\n\n      // Verify property exists and belongs to the same organization\n      const property = await storage.getProperty(propertyId);\n      if (!property) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n      \n      if (property.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied: Property belongs to a different organization\" });\n      }\n\n      const request = await storage.createMaintenanceRequest({\n        organizationId: user.organizationId,\n        propertyId,\n        reportedBy: userId,\n        title,\n        description: description || null,\n        priority: priority || \"medium\",\n        photoUrls: photoUrls || null,\n        aiSuggestedFixes: aiSuggestedFixes || null,\n        aiAnalysisJson: aiAnalysisJson || null,\n        source: source || (user.role === \"tenant\" ? \"tenant_portal\" : \"manual\"),\n        inspectionId: inspectionId || null,\n        inspectionEntryId: inspectionEntryId || null,\n      });\n\n      res.json(request);\n    } catch (error) {\n      console.error(\"Error creating maintenance request:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance request\" });\n    }\n  });\n\n  // Quick-add maintenance request from inspection (with offline support)\n  app.post(\"/api/maintenance/quick\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n\n      // Get user to check organization\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Validate request body with quick-add schema\n      const validation = quickAddMaintenanceSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      const { propertyId, title, description, priority, photoUrls, inspectionId, inspectionEntryId, source } = validation.data;\n\n      // Verify property exists and belongs to the same organization\n      const property = await storage.getProperty(propertyId);\n      if (!property) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n      \n      if (property.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied: Property belongs to a different organization\" });\n      }\n\n      // If inspectionId provided, verify it exists and belongs to the same organization\n      if (inspectionId) {\n        const inspection = await storage.getInspection(inspectionId);\n        if (!inspection) {\n          return res.status(404).json({ message: \"Inspection not found\" });\n        }\n\n        // Verify organization via property or block\n        let ownerOrgId: string | null = null;\n        if (inspection.propertyId) {\n          const inspectionProperty = await storage.getProperty(inspection.propertyId);\n          ownerOrgId = inspectionProperty?.organizationId || null;\n        } else if (inspection.blockId) {\n          const block = await storage.getBlock(inspection.blockId);\n          ownerOrgId = block?.organizationId || null;\n        }\n\n        if (ownerOrgId !== user.organizationId) {\n          return res.status(403).json({ message: \"Access denied: Inspection does not belong to your organization\" });\n        }\n      }\n\n      const request = await storage.createMaintenanceRequest({\n        organizationId: user.organizationId,\n        propertyId,\n        reportedBy: userId,\n        title,\n        description: description || null,\n        priority: priority || \"medium\",\n        photoUrls: photoUrls || null,\n        source: source || \"inspection\",\n        inspectionId: inspectionId || null,\n        inspectionEntryId: inspectionEntryId || null,\n      });\n\n      res.json(request);\n    } catch (error) {\n      console.error(\"Error creating quick-add maintenance request:\", error);\n      res.status(500).json({ message: \"Failed to create maintenance request\" });\n    }\n  });\n\n  app.get(\"/api/maintenance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const requests = await storage.getMaintenanceByOrganization(user.organizationId);\n      res.json(requests);\n    } catch (error) {\n      console.error(\"Error fetching maintenance requests:\", error);\n      res.status(500).json({ message: \"Failed to fetch maintenance requests\" });\n    }\n  });\n\n  app.patch(\"/api/maintenance/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getUser(req.user.id);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"Unauthorized\" });\n      }\n\n      // Fetch the maintenance request to verify organization ownership\n      const existingRequests = await storage.getMaintenanceByOrganization(user.organizationId);\n      const existingRequest = existingRequests.find(r => r.id === id);\n      \n      if (!existingRequest) {\n        return res.status(404).json({ message: \"Maintenance request not found\" });\n      }\n\n      // Verify organization ownership\n      if (existingRequest.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Unauthorized to update this request\" });\n      }\n\n      // Only owners and clerks can edit maintenance requests\n      if (user.role !== \"owner\" && user.role !== \"clerk\") {\n        return res.status(403).json({ message: \"Insufficient permissions\" });\n      }\n\n      // Validate request body\n      const validation = updateMaintenanceRequestSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validation.error.errors \n        });\n      }\n\n      // Prevent organizationId from being changed\n      const { organizationId: _, ...safeUpdates } = validation.data as any;\n\n      // Use the new updateMaintenanceRequest method for full updates\n      const request = await storage.updateMaintenanceRequest(id, safeUpdates);\n      res.json(request);\n    } catch (error) {\n      console.error(\"Error updating maintenance request:\", error);\n      res.status(500).json({ message: \"Failed to update maintenance request\" });\n    }\n  });\n\n  // ==================== CREDIT ROUTES ====================\n  \n  app.get(\"/api/credits/transactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.json([]);\n      }\n\n      const transactions = await storage.getCreditTransactions(user.organizationId);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching credit transactions:\", error);\n      res.status(500).json({ message: \"Failed to fetch credit transactions\" });\n    }\n  });\n\n  // ==================== STRIPE ROUTES ====================\n  \n  app.post(\"/api/stripe/create-checkout\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const organization = await storage.getOrganization(user.organizationId);\n      if (!organization) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n\n      const { credits } = req.body;\n      const amount = credits * 100; // $1 per credit, in cents\n\n      const stripe = await getUncachableStripeClient();\n      const session = await stripe.checkout.sessions.create({\n        payment_method_types: [\"card\"],\n        line_items: [\n          {\n            price_data: {\n              currency: \"usd\",\n              product_data: {\n                name: `${credits} Inspection Credits`,\n                description: \"Credits for AI-powered property inspections\",\n              },\n              unit_amount: 100, // $1 per credit\n            },\n            quantity: credits,\n          },\n        ],\n        mode: \"payment\",\n        success_url: `${req.headers.origin}/dashboard?payment=success`,\n        cancel_url: `${req.headers.origin}/dashboard?payment=cancelled`,\n        client_reference_id: organization.id,\n        metadata: {\n          organizationId: organization.id,\n          credits: credits.toString(),\n        },\n      });\n\n      res.json({ url: session.url });\n    } catch (error) {\n      console.error(\"Error creating checkout session:\", error);\n      res.status(500).json({ message: \"Failed to create checkout session\" });\n    }\n  });\n\n  app.post(\"/api/stripe/webhook\", async (req, res) => {\n    const sig = req.headers['stripe-signature'];\n    \n    try {\n      const stripe = await getUncachableStripeClient();\n      const event = stripe.webhooks.constructEvent(\n        req.body,\n        sig!,\n        process.env.STRIPE_WEBHOOK_SECRET || \"whsec_test\"\n      );\n\n      if (event.type === 'checkout.session.completed') {\n        const session = event.data.object as any;\n        const organizationId = session.metadata.organizationId;\n        const credits = parseInt(session.metadata.credits);\n\n        // Add credits to organization\n        const organization = await storage.getOrganization(organizationId);\n        if (organization) {\n          await storage.updateOrganizationCredits(\n            organizationId,\n            (organization.creditsRemaining ?? 0) + credits\n          );\n\n          await storage.createCreditTransaction({\n            organizationId,\n            amount: credits,\n            type: \"purchase\",\n            description: `Purchased ${credits} credits via Stripe`,\n          });\n        }\n      }\n\n      res.json({ received: true });\n    } catch (error) {\n      console.error(\"Stripe webhook error:\", error);\n      res.status(400).send(`Webhook Error`);\n    }\n  });\n\n  // ==================== BLOCK ROUTES ====================\n  \n  app.post(\"/api/blocks\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Validate request body with Zod\n      const parseResult = insertBlockSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          details: parseResult.error.errors \n        });\n      }\n\n      const block = await storage.createBlock({\n        ...parseResult.data,\n        organizationId: user.organizationId,\n      });\n      res.status(201).json(block);\n    } catch (error: any) {\n      console.error(\"Error creating block:\", error);\n      res.status(500).json({ error: \"Failed to create block\" });\n    }\n  });\n\n  app.get(\"/api/blocks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const blocks = await storage.getBlocksWithStats(user.organizationId);\n      res.json(blocks);\n    } catch (error) {\n      console.error(\"Error fetching blocks:\", error);\n      res.status(500).json({ error: \"Failed to fetch blocks\" });\n    }\n  });\n\n  app.get(\"/api/blocks/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const block = await storage.getBlock(req.params.id);\n      if (!block) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n\n      // Verify organization ownership\n      if (block.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json(block);\n    } catch (error) {\n      console.error(\"Error fetching block:\", error);\n      res.status(500).json({ error: \"Failed to fetch block\" });\n    }\n  });\n\n  app.get(\"/api/blocks/:id/properties\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const blockId = req.params.id;\n      \n      // Verify block belongs to user's organization\n      const block = await storage.getBlock(blockId);\n      if (!block || block.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n\n      const properties = await storage.getPropertiesWithStatsByBlock(blockId);\n      res.json(properties);\n    } catch (error) {\n      console.error(\"Error fetching block properties:\", error);\n      res.status(500).json({ error: \"Failed to fetch block properties\" });\n    }\n  });\n\n  // Get block annual compliance report\n  app.get(\"/api/blocks/:id/compliance-report\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const block = await storage.getBlock(id);\n      if (!block || block.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Block not found\" });\n      }\n\n      // Get all inspections for this block\n      const allInspections = await storage.getInspectionsByBlock(id);\n      \n      // Get all inspection templates\n      const templates = await storage.getInspectionTemplatesByOrganization(user.organizationId);\n      const activeTemplates = templates.filter(t => t.isActive && (t.scope === 'block' || t.scope === 'both'));\n      \n      // Build compliance data by template and month\n      const currentYear = new Date().getFullYear();\n      const months = [\n        'January', 'February', 'March', 'April', 'May', 'June',\n        'July', 'August', 'September', 'October', 'November', 'December'\n      ];\n      \n      const complianceData = activeTemplates.map(template => {\n        const templateInspections = allInspections.filter(i => i.templateId === template.id);\n        \n        const monthData = months.map((monthName, monthIndex) => {\n          // Find inspections scheduled for this month\n          const monthInspections = templateInspections.filter(inspection => {\n            if (!inspection.scheduledDate) return false;\n            const schedDate = new Date(inspection.scheduledDate);\n            return schedDate.getFullYear() === currentYear && schedDate.getMonth() === monthIndex;\n          });\n          \n          if (monthInspections.length === 0) {\n            return { month: monthName, status: 'not_scheduled', count: 0 };\n          }\n          \n          const now = new Date();\n          const completedCount = monthInspections.filter(i => i.status === 'completed').length;\n          const overdueCount = monthInspections.filter(i => {\n            if (i.status === 'completed' || !i.scheduledDate) return false;\n            const schedDate = new Date(i.scheduledDate);\n            return schedDate < now;\n          }).length;\n          \n          const dueCount = monthInspections.filter(i => {\n            if (i.status === 'completed' || !i.scheduledDate) return false;\n            const schedDate = new Date(i.scheduledDate);\n            const daysUntil = Math.ceil((schedDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n            return daysUntil >= 0 && daysUntil <= 30;\n          }).length;\n          \n          let status = 'not_scheduled';\n          if (overdueCount > 0) {\n            status = 'overdue';\n          } else if (completedCount === monthInspections.length) {\n            status = 'completed';\n          } else if (dueCount > 0) {\n            status = 'due';\n          } else {\n            status = 'scheduled';\n          }\n          \n          return {\n            month: monthName,\n            status,\n            count: monthInspections.length,\n            completed: completedCount,\n            overdue: overdueCount,\n          };\n        });\n        \n        // Calculate compliance percentage for this template\n        const totalScheduled = monthData.reduce((sum, m) => sum + m.count, 0);\n        const totalCompleted = monthData.reduce((sum, m) => sum + (m.completed || 0), 0);\n        const complianceRate = totalScheduled > 0 ? Math.round((totalCompleted / totalScheduled) * 100) : 0;\n        \n        return {\n          templateId: template.id,\n          templateName: template.name,\n          monthData,\n          complianceRate,\n          totalScheduled,\n          totalCompleted,\n        };\n      });\n      \n      // Calculate overall compliance\n      const totalScheduled = complianceData.reduce((sum, t) => sum + t.totalScheduled, 0);\n      const totalCompleted = complianceData.reduce((sum, t) => sum + t.totalCompleted, 0);\n      const overallCompliance = totalScheduled > 0 ? Math.round((totalCompleted / totalScheduled) * 100) : 100;\n      \n      res.json({\n        year: currentYear,\n        months,\n        templates: complianceData,\n        overallCompliance,\n        totalScheduled,\n        totalCompleted,\n      });\n    } catch (error) {\n      console.error(\"Error fetching block compliance report:\", error);\n      res.status(500).json({ message: \"Failed to fetch compliance report\" });\n    }\n  });\n\n  app.patch(\"/api/blocks/:id\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify organization ownership\n      const existing = await storage.getBlock(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Validate request body (partial update) with Zod\n      const parseResult = insertBlockSchema.partial().safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          details: parseResult.error.errors \n        });\n      }\n\n      const block = await storage.updateBlock(req.params.id, parseResult.data);\n      res.json(block);\n    } catch (error: any) {\n      console.error(\"Error updating block:\", error);\n      res.status(500).json({ error: \"Failed to update block\" });\n    }\n  });\n\n  app.delete(\"/api/blocks/:id\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify organization ownership\n      const existing = await storage.getBlock(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.deleteBlock(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting block:\", error);\n      res.status(500).json({ error: \"Failed to delete block\" });\n    }\n  });\n\n  // Get tenant information for a block\n  app.get(\"/api/blocks/:blockId/tenants\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const { blockId } = req.params;\n\n      // Verify block belongs to user's organization\n      const block = await storage.getBlock(blockId);\n      if (!block) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n      if (block.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Get stats and tenant assignments\n      const stats = await storage.getBlockTenantStats(blockId);\n      const tenants = await storage.getTenantAssignmentsByBlock(blockId);\n\n      res.json({\n        stats,\n        tenants,\n      });\n    } catch (error) {\n      console.error(\"Error fetching block tenants:\", error);\n      res.status(500).json({ error: \"Failed to fetch block tenants\" });\n    }\n  });\n\n  // Broadcast message to all block tenants\n  app.post(\"/api/blocks/:blockId/broadcast\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const { blockId } = req.params;\n      const { templateId, subject, body } = req.body;\n\n      // Verify block belongs to user's organization\n      const block = await storage.getBlock(blockId);\n      if (!block) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n      if (block.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Get organization for name\n      const organization = await storage.getOrganization(user.organizationId);\n\n      // Prepare message template\n      let templateData: { subject: string; body: string };\n      \n      if (templateId) {\n        // Use existing template\n        const template = await storage.getMessageTemplate(templateId);\n        if (!template || template.organizationId !== user.organizationId) {\n          return res.status(404).json({ error: \"Template not found\" });\n        }\n        templateData = { subject: template.subject, body: template.body };\n      } else if (subject && body) {\n        // Use custom message\n        templateData = { subject, body };\n      } else {\n        return res.status(400).json({ error: \"Either templateId or subject and body must be provided\" });\n      }\n\n      // Get all tenant emails for this block\n      const recipients = await storage.getBlockTenantsEmails(blockId, user.organizationId);\n\n      if (recipients.length === 0) {\n        return res.status(404).json({ error: \"No active tenants found for this block\" });\n      }\n\n      // Send broadcast\n      const { broadcastMessageToTenants } = await import('./resend');\n      const result = await broadcastMessageToTenants(\n        recipients,\n        templateData,\n        {\n          blockName: block.name,\n          organizationName: organization?.name || 'Your Property Management',\n        }\n      );\n\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error broadcasting message:\", error);\n      res.status(500).json({ error: \"Failed to broadcast message\" });\n    }\n  });\n\n  // ==================== MESSAGE TEMPLATE ROUTES ====================\n\n  app.get(\"/api/message-templates\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const templates = await storage.getMessageTemplatesByOrganization(user.organizationId);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching message templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch message templates\" });\n    }\n  });\n\n  app.post(\"/api/message-templates\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertMessageTemplateSchema.safeParse(req.body);\n      if (!validatedData.success) {\n        return res.status(400).json({ error: \"Invalid request data\", details: validatedData.error.errors });\n      }\n\n      const template = await storage.createMessageTemplate({\n        ...validatedData.data,\n        organizationId: user.organizationId,\n        createdBy: userId,\n      });\n\n      res.status(201).json(template);\n    } catch (error) {\n      console.error(\"Error creating message template:\", error);\n      res.status(500).json({ error: \"Failed to create message template\" });\n    }\n  });\n\n  app.put(\"/api/message-templates/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const existing = await storage.getMessageTemplate(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n\n      const validatedData = updateMessageTemplateSchema.safeParse(req.body);\n      if (!validatedData.success) {\n        return res.status(400).json({ error: \"Invalid request data\", details: validatedData.error.errors });\n      }\n\n      const updated = await storage.updateMessageTemplate(req.params.id, validatedData.data);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating message template:\", error);\n      res.status(500).json({ error: \"Failed to update message template\" });\n    }\n  });\n\n  app.delete(\"/api/message-templates/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const existing = await storage.getMessageTemplate(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n\n      await storage.deleteMessageTemplate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting message template:\", error);\n      res.status(500).json({ error: \"Failed to delete message template\" });\n    }\n  });\n\n  // ==================== TENANT ASSIGNMENT ROUTES ====================\n\n  app.post(\"/api/tenant-assignments\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Transform request body to match schema expectations\n      // Dates come as ISO strings but Zod expects Date objects\n      // Numeric fields come as numbers but Drizzle expects strings\n      const transformedBody: any = {\n        ...req.body,\n      };\n      \n      // Convert date strings to Date objects\n      if (req.body.leaseStartDate && typeof req.body.leaseStartDate === 'string') {\n        transformedBody.leaseStartDate = new Date(req.body.leaseStartDate);\n      }\n      if (req.body.leaseEndDate && typeof req.body.leaseEndDate === 'string') {\n        transformedBody.leaseEndDate = new Date(req.body.leaseEndDate);\n      }\n      \n      // Convert numeric fields to strings (Drizzle numeric fields expect strings)\n      if (req.body.monthlyRent !== undefined && req.body.monthlyRent !== null) {\n        transformedBody.monthlyRent = String(req.body.monthlyRent);\n      }\n      if (req.body.depositAmount !== undefined && req.body.depositAmount !== null) {\n        transformedBody.depositAmount = String(req.body.depositAmount);\n      }\n      \n      const validatedData = insertTenantAssignmentSchema.safeParse(transformedBody);\n      if (!validatedData.success) {\n        console.error(\"[Tenant Assignment] Validation errors:\", validatedData.error.errors);\n        console.error(\"[Tenant Assignment] Request body:\", req.body);\n        console.error(\"[Tenant Assignment] Transformed body:\", transformedBody);\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          message: validatedData.error.errors[0]?.message || \"Validation failed\",\n          details: validatedData.error.errors \n        });\n      }\n\n      // Verify property belongs to user's organization\n      const property = await storage.getProperty(validatedData.data.propertyId);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Property not found\" });\n      }\n\n      // Verify tenant user exists and has tenant role\n      const tenantUser = await storage.getUser(validatedData.data.tenantId);\n      if (!tenantUser || tenantUser.role !== 'tenant' || tenantUser.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant user not found\" });\n      }\n\n      const assignment = await storage.createTenantAssignment({\n        ...validatedData.data,\n        organizationId: user.organizationId,\n      });\n\n      res.status(201).json(assignment);\n    } catch (error) {\n      console.error(\"Error creating tenant assignment:\", error);\n      res.status(500).json({ error: \"Failed to create tenant assignment\" });\n    }\n  });\n\n  app.put(\"/api/tenant-assignments/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const existing = await storage.getTenantAssignment(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      // Transform request body before validation (same as POST endpoint)\n      const transformedBody = { ...req.body };\n\n      // Convert date strings or Date objects to Date objects for Zod validation\n      if (req.body.leaseStartDate !== undefined && req.body.leaseStartDate !== null) {\n        if (typeof req.body.leaseStartDate === 'string') {\n          transformedBody.leaseStartDate = new Date(req.body.leaseStartDate);\n        } else if (req.body.leaseStartDate instanceof Date) {\n          transformedBody.leaseStartDate = req.body.leaseStartDate;\n        }\n      }\n      if (req.body.leaseEndDate !== undefined && req.body.leaseEndDate !== null) {\n        if (typeof req.body.leaseEndDate === 'string') {\n          transformedBody.leaseEndDate = new Date(req.body.leaseEndDate);\n        } else if (req.body.leaseEndDate instanceof Date) {\n          transformedBody.leaseEndDate = req.body.leaseEndDate;\n        }\n      }\n\n      // Convert numeric fields to strings (Drizzle numeric fields expect strings)\n      if (req.body.monthlyRent !== undefined && req.body.monthlyRent !== null) {\n        transformedBody.monthlyRent = String(req.body.monthlyRent);\n      }\n      if (req.body.depositAmount !== undefined && req.body.depositAmount !== null) {\n        transformedBody.depositAmount = String(req.body.depositAmount);\n      }\n\n      const validatedData = updateTenantAssignmentSchema.safeParse(transformedBody);\n      if (!validatedData.success) {\n        console.error(\"[Tenant Assignment Update] Validation errors:\", validatedData.error.errors);\n        console.error(\"[Tenant Assignment Update] Request body:\", req.body);\n        console.error(\"[Tenant Assignment Update] Transformed body:\", transformedBody);\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          message: validatedData.error.errors[0]?.message || \"Validation failed\",\n          details: validatedData.error.errors \n        });\n      }\n\n      const updated = await storage.updateTenantAssignment(req.params.id, validatedData.data);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating tenant assignment:\", error);\n      res.status(500).json({ error: \"Failed to update tenant assignment\" });\n    }\n  });\n\n  app.delete(\"/api/tenant-assignments/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const existing = await storage.getTenantAssignment(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      await storage.deleteTenantAssignment(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting tenant assignment:\", error);\n      res.status(500).json({ error: \"Failed to delete tenant assignment\" });\n    }\n  });\n\n  // Get tags for a tenant assignment\n  app.get(\"/api/tenant-assignments/:id/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const assignment = await storage.getTenantAssignment(req.params.id);\n      if (!assignment || assignment.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      const tags = await storage.getTenantAssignmentTags(req.params.id, user.organizationId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching tenant assignment tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch tags\" });\n    }\n  });\n\n  // Update tags for a tenant assignment\n  app.put(\"/api/tenant-assignments/:id/tags\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const assignment = await storage.getTenantAssignment(req.params.id);\n      if (!assignment || assignment.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      const { tagIds } = req.body;\n      if (!Array.isArray(tagIds)) {\n        return res.status(400).json({ error: \"tagIds must be an array\" });\n      }\n\n      await storage.updateTenantAssignmentTags(req.params.id, tagIds, user.organizationId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error updating tenant assignment tags:\", error);\n      res.status(500).json({ error: \"Failed to update tags\" });\n    }\n  });\n\n  // Send portal credentials to tenant\n  app.post(\"/api/tenant-assignments/:id/send-password\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const assignment = await storage.getTenantAssignment(req.params.id);\n      if (!assignment || assignment.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      // Get tenant user details\n      const tenant = await storage.getUser(assignment.tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant user not found\" });\n      }\n\n      // Generate a temporary password\n      const tempPassword = Math.random().toString(36).slice(-10) + Math.random().toString(36).slice(-10).toUpperCase();\n      const hashedPassword = await bcrypt.hash(tempPassword, 10);\n\n      // Update tenant password\n      await storage.upsertUser({\n        ...tenant,\n        password: hashedPassword,\n      });\n\n      // Send email with credentials using Resend\n      const { Resend } = await import('resend');\n      const resend = new Resend(process.env.RESEND_API_KEY);\n\n      const fullName = [tenant.firstName, tenant.lastName].filter(Boolean).join(\" \") || tenant.email;\n      \n      await resend.emails.send({\n        from: 'Inspect360 <noreply@inspect360.app>',\n        to: tenant.email,\n        subject: 'Your Tenant Portal Credentials',\n        html: `\n          <h2>Welcome to Your Tenant Portal</h2>\n          <p>Hello ${fullName},</p>\n          <p>Your tenant portal credentials have been set up. You can now access the portal to:</p>\n          <ul>\n            <li>View your property and lease details</li>\n            <li>Submit maintenance requests</li>\n            <li>Chat with our AI assistant for quick fixes</li>\n          </ul>\n          <p><strong>Login URL:</strong> ${process.env.BASE_URL || 'http://localhost:5000'}/tenant/login</p>\n          <p><strong>Email:</strong> ${tenant.email}</p>\n          <p><strong>Temporary Password:</strong> ${tempPassword}</p>\n          <p><em>Please change your password after your first login.</em></p>\n          <br/>\n          <p>Best regards,<br/>The Inspect360 Team</p>\n        `,\n      });\n\n      res.json({ success: true, message: \"Credentials sent successfully\" });\n    } catch (error) {\n      console.error(\"Error sending tenant password:\", error);\n      res.status(500).json({ error: \"Failed to send credentials\" });\n    }\n  });\n\n  // Get attachments for a tenant assignment\n  app.get(\"/api/tenant-assignments/:id/attachments\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const assignment = await storage.getTenantAssignment(req.params.id);\n      if (!assignment || assignment.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      const attachments = await storage.getTenancyAttachments(req.params.id, user.organizationId);\n      res.json(attachments);\n    } catch (error) {\n      console.error(\"Error fetching tenancy attachments:\", error);\n      res.status(500).json({ error: \"Failed to fetch attachments\" });\n    }\n  });\n\n  // Upload tenancy attachment\n  app.post(\"/api/tenancy-attachments\", isAuthenticated, requireRole(\"owner\", \"clerk\"), upload.single('file'), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const { tenantAssignmentId } = req.body;\n      if (!tenantAssignmentId) {\n        return res.status(400).json({ error: \"tenantAssignmentId is required\" });\n      }\n\n      // Verify assignment belongs to user's organization\n      const assignment = await storage.getTenantAssignment(tenantAssignmentId);\n      if (!assignment || assignment.organizationId !== user.organizationId) {\n        return res.status(404).json({ error: \"Tenant assignment not found\" });\n      }\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      // Upload to local storage using ObjectStorageService\n      const objectStorageService = new ObjectStorageService();\n      const objectId = randomUUID();\n      const normalizedPath = await objectStorageService.saveUploadedFile(\n        objectId,\n        req.file.buffer,\n        req.file.mimetype\n      );\n\n      // Convert relative path to absolute URL\n      const baseUrl = getBaseUrl(req);\n      const fileUrl = `${baseUrl}${normalizedPath}`;\n\n      // Set ACL to public so it can be accessed\n      try {\n        await objectStorageService.trySetObjectEntityAclPolicy(normalizedPath, {\n          owner: userId,\n          visibility: \"public\",\n        });\n      } catch (error) {\n        console.warn(\"Failed to set ACL for tenancy attachment:\", error);\n      }\n\n      // Create attachment record\n      const attachment = await storage.createTenancyAttachment({\n        tenantAssignmentId,\n        fileName: req.file.originalname,\n        fileUrl: normalizedPath, // Store relative path, convert to absolute when serving\n        fileType: req.file.mimetype,\n        fileSize: req.file.size,\n        uploadedBy: userId,\n        organizationId: user.organizationId,\n      });\n\n      res.status(201).json({\n        ...attachment,\n        fileUrl: fileUrl, // Return absolute URL in response\n      });\n    } catch (error) {\n      console.error(\"Error uploading tenancy attachment:\", error);\n      res.status(500).json({ error: \"Failed to upload attachment\" });\n    }\n  });\n\n  // Delete tenancy attachment\n  app.delete(\"/api/tenancy-attachments/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify attachment belongs to user's organization and delete it\n      await storage.deleteTenancyAttachment(req.params.id, user.organizationId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting tenancy attachment:\", error);\n      res.status(500).json({ error: \"Failed to delete attachment\" });\n    }\n  });\n\n  // ==================== ASSET INVENTORY ROUTES ====================\n\n  app.post(\"/api/asset-inventory\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertAssetInventorySchema.parse(req.body);\n\n      const asset = await storage.createAssetInventory({\n        ...validatedData,\n        organizationId: user.organizationId,\n      });\n      res.status(201).json(asset);\n    } catch (error: any) {\n      console.error(\"Error creating asset inventory:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create asset inventory\" });\n    }\n  });\n\n  // Quick-add asset from inspection (with offline support)\n  app.post(\"/api/asset-inventory/quick\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Validate request body with quick-add schema\n      const validation = quickAddAssetSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          details: validation.error.errors \n        });\n      }\n\n      const { name, category, condition, cleanliness, location, description, propertyId, blockId, photos, inspectionId, inspectionEntryId } = validation.data;\n\n      // Verify property or block exists and belongs to the same organization\n      if (propertyId) {\n        const property = await storage.getProperty(propertyId);\n        if (!property) {\n          return res.status(404).json({ error: \"Property not found\" });\n        }\n        if (property.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied: Property belongs to a different organization\" });\n        }\n      }\n\n      if (blockId) {\n        const block = await storage.getBlock(blockId);\n        if (!block) {\n          return res.status(404).json({ error: \"Block not found\" });\n        }\n        if (block.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied: Block belongs to a different organization\" });\n        }\n      }\n\n      // If inspectionId provided, verify it exists and belongs to the same organization\n      if (inspectionId) {\n        const inspection = await storage.getInspection(inspectionId);\n        if (!inspection) {\n          return res.status(404).json({ error: \"Inspection not found\" });\n        }\n\n        // Verify organization via property or block\n        let ownerOrgId: string | null = null;\n        if (inspection.propertyId) {\n          const inspectionProperty = await storage.getProperty(inspection.propertyId);\n          ownerOrgId = inspectionProperty?.organizationId || null;\n        } else if (inspection.blockId) {\n          const inspectionBlock = await storage.getBlock(inspection.blockId);\n          ownerOrgId = inspectionBlock?.organizationId || null;\n        }\n\n        if (ownerOrgId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied: Inspection does not belong to your organization\" });\n        }\n      }\n\n      const asset = await storage.createAssetInventory({\n        organizationId: user.organizationId,\n        name,\n        category: category || null,\n        condition,\n        cleanliness: cleanliness || null,\n        location: location || null,\n        description: description || null,\n        propertyId: propertyId || null,\n        blockId: blockId || null,\n        photos: photos || null,\n        inspectionId: inspectionId || null,\n        inspectionEntryId: inspectionEntryId || null,\n      });\n\n      res.status(201).json(asset);\n    } catch (error: any) {\n      console.error(\"Error creating quick-add asset:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create asset\" });\n    }\n  });\n\n  // Quick-update asset from inspection (with offline support)\n  app.patch(\"/api/asset-inventory/:id/quick\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const { id } = req.params;\n\n      // Verify asset exists and belongs to user's organization\n      const existingAsset = await storage.getAssetInventory(id);\n      if (!existingAsset) {\n        return res.status(404).json({ error: \"Asset not found\" });\n      }\n      if (existingAsset.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied: Asset belongs to a different organization\" });\n      }\n\n      // Validate request body with quick-update schema\n      const validation = quickUpdateAssetSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          error: \"Invalid request data\", \n          details: validation.error.errors \n        });\n      }\n\n      const { condition, cleanliness, location, notes, photos, inspectionId, inspectionEntryId, offlineId } = validation.data;\n\n      // Check for duplicate offline requests (deduplication)\n      if (offlineId) {\n        // In a production system, you'd store processed offlineIds in a cache/db\n        // For now, we'll just log and continue (idempotent operation)\n        console.log(`Processing offline update with ID: ${offlineId}`);\n      }\n\n      // If inspectionId provided, verify it exists and belongs to the same organization\n      if (inspectionId) {\n        const inspection = await storage.getInspection(inspectionId);\n        if (!inspection) {\n          return res.status(404).json({ error: \"Inspection not found\" });\n        }\n\n        // Verify organization via property or block\n        let ownerOrgId: string | null = null;\n        if (inspection.propertyId) {\n          const inspectionProperty = await storage.getProperty(inspection.propertyId);\n          ownerOrgId = inspectionProperty?.organizationId || null;\n        } else if (inspection.blockId) {\n          const inspectionBlock = await storage.getBlock(inspection.blockId);\n          ownerOrgId = inspectionBlock?.organizationId || null;\n        }\n\n        if (ownerOrgId !== user.organizationId) {\n          return res.status(403).json({ error: \"Access denied: Inspection does not belong to your organization\" });\n        }\n      }\n\n      // Build update object with only provided fields\n      // Map notes to description for consistency with asset table schema\n      const updateData: any = {};\n      if (condition !== undefined) updateData.condition = condition;\n      if (cleanliness !== undefined) updateData.cleanliness = cleanliness;\n      if (location !== undefined) updateData.location = location;\n      if (notes !== undefined) updateData.description = notes; // Map notes -> description\n      if (photos !== undefined) updateData.photos = photos;\n      if (inspectionId !== undefined) updateData.inspectionId = inspectionId;\n      if (inspectionEntryId !== undefined) updateData.inspectionEntryId = inspectionEntryId;\n\n      const updatedAsset = await storage.updateAssetInventory(id, updateData);\n\n      res.json(updatedAsset);\n    } catch (error: any) {\n      console.error(\"Error updating quick-update asset:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to update asset\" });\n    }\n  });\n\n  app.get(\"/api/asset-inventory\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const assets = await storage.getAssetInventoryByOrganization(user.organizationId);\n      res.json(assets);\n    } catch (error) {\n      console.error(\"Error fetching asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to fetch asset inventory\" });\n    }\n  });\n\n  app.get(\"/api/asset-inventory/property/:propertyId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify property belongs to user's organization\n      const property = await storage.getProperty(req.params.propertyId);\n      if (!property) {\n        return res.status(404).json({ error: \"Property not found\" });\n      }\n      if (property.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const assets = await storage.getAssetInventoryByProperty(req.params.propertyId);\n      res.json(assets);\n    } catch (error) {\n      console.error(\"Error fetching property asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to fetch property asset inventory\" });\n    }\n  });\n\n  app.get(\"/api/asset-inventory/block/:blockId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify block belongs to user's organization\n      const block = await storage.getBlock(req.params.blockId);\n      if (!block) {\n        return res.status(404).json({ error: \"Block not found\" });\n      }\n      if (block.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const assets = await storage.getAssetInventoryByBlock(req.params.blockId);\n      res.json(assets);\n    } catch (error) {\n      console.error(\"Error fetching block asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to fetch block asset inventory\" });\n    }\n  });\n\n  app.get(\"/api/asset-inventory/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const asset = await storage.getAssetInventory(req.params.id);\n      if (!asset) {\n        return res.status(404).json({ error: \"Asset not found\" });\n      }\n\n      // Verify organization ownership\n      if (asset.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json(asset);\n    } catch (error) {\n      console.error(\"Error fetching asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to fetch asset inventory\" });\n    }\n  });\n\n  app.patch(\"/api/asset-inventory/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify organization ownership\n      const existing = await storage.getAssetInventory(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Asset not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Remove organizationId from request body (should not be updated)\n      const { organizationId: _, ...updateData } = req.body;\n\n      // Validate and coerce dates\n      const validatedData = insertAssetInventorySchema.partial().parse(updateData);\n\n      const asset = await storage.updateAssetInventory(req.params.id, validatedData);\n      res.json(asset);\n    } catch (error: any) {\n      console.error(\"Error updating asset inventory:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to update asset inventory\" });\n    }\n  });\n\n  app.delete(\"/api/asset-inventory/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify organization ownership\n      const existing = await storage.getAssetInventory(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Asset not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.deleteAssetInventory(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to delete asset inventory\" });\n    }\n  });\n\n  // ==================== INVENTORY TEMPLATE ROUTES ====================\n  \n  app.post(\"/api/inventory-templates\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertInventoryTemplateSchema.parse(req.body);\n\n      const template = await storage.createInventoryTemplate({\n        ...validatedData,\n        organizationId: user.organizationId,\n      });\n      res.status(201).json(template);\n    } catch (error: any) {\n      console.error(\"Error creating inventory template:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create inventory template\" });\n    }\n  });\n\n  app.get(\"/api/inventory-templates\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const templates = await storage.getInventoryTemplatesByOrganization(user.organizationId);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching inventory templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch inventory templates\" });\n    }\n  });\n\n  app.get(\"/api/inventory-templates/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const template = await storage.getInventoryTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n\n      if (template.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching inventory template:\", error);\n      res.status(500).json({ error: \"Failed to fetch inventory template\" });\n    }\n  });\n\n  app.patch(\"/api/inventory-templates/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const existing = await storage.getInventoryTemplate(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const validatedData = insertInventoryTemplateSchema.partial().parse(req.body);\n\n      const template = await storage.updateInventoryTemplate(req.params.id, validatedData);\n      res.json(template);\n    } catch (error: any) {\n      console.error(\"Error updating inventory template:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to update inventory template\" });\n    }\n  });\n\n  app.delete(\"/api/inventory-templates/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const existing = await storage.getInventoryTemplate(req.params.id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      if (existing.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.deleteInventoryTemplate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting inventory template:\", error);\n      res.status(500).json({ error: \"Failed to delete inventory template\" });\n    }\n  });\n\n  // ==================== INVENTORY ROUTES ====================\n  \n  app.post(\"/api/inventories\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertInventorySchema.parse(req.body);\n\n      const inventory = await storage.createInventory({\n        ...validatedData,\n        organizationId: user.organizationId,\n      });\n      res.status(201).json(inventory);\n    } catch (error: any) {\n      console.error(\"Error creating inventory:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create inventory\" });\n    }\n  });\n\n  app.get(\"/api/properties/:propertyId/inventories\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify property belongs to user's organization\n      const property = await storage.getProperty(req.params.propertyId);\n      if (!property) {\n        return res.status(404).json({ error: \"Property not found\" });\n      }\n      if (property.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const inventories = await storage.getInventoriesByProperty(req.params.propertyId);\n      res.json(inventories);\n    } catch (error) {\n      console.error(\"Error fetching inventories:\", error);\n      res.status(500).json({ error: \"Failed to fetch inventories\" });\n    }\n  });\n\n  app.get(\"/api/inventories/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const inventory = await storage.getInventory(req.params.id);\n      if (!inventory) {\n        return res.status(404).json({ error: \"Inventory not found\" });\n      }\n\n      if (inventory.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json(inventory);\n    } catch (error) {\n      console.error(\"Error fetching inventory:\", error);\n      res.status(500).json({ error: \"Failed to fetch inventory\" });\n    }\n  });\n\n  // ==================== INVENTORY ITEM ROUTES ====================\n  \n  app.post(\"/api/inventory-items\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertInventoryItemSchema.parse(req.body);\n\n      // Verify parent inventory belongs to user's organization\n      const inventory = await storage.getInventory(validatedData.inventoryId);\n      if (!inventory || inventory.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const item = await storage.createInventoryItem(validatedData);\n      res.status(201).json(item);\n    } catch (error: any) {\n      console.error(\"Error creating inventory item:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create inventory item\" });\n    }\n  });\n\n  app.get(\"/api/inventories/:inventoryId/items\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify inventory belongs to user's organization\n      const inventory = await storage.getInventory(req.params.inventoryId);\n      if (!inventory || inventory.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const items = await storage.getInventoryItems(req.params.inventoryId);\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching inventory items:\", error);\n      res.status(500).json({ error: \"Failed to fetch inventory items\" });\n    }\n  });\n\n  app.patch(\"/api/inventory-items/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Note: This requires fetching the item first to verify access via parent inventory\n      // For efficiency, we could add a getInventoryItem method to storage\n      const validatedData = insertInventoryItemSchema.partial().parse(req.body);\n\n      const item = await storage.updateInventoryItem(req.params.id, validatedData);\n      res.json(item);\n    } catch (error: any) {\n      console.error(\"Error updating inventory item:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to update inventory item\" });\n    }\n  });\n\n  // ==================== WORK ORDER ROUTES ====================\n  \n  app.post(\"/api/work-orders\", isAuthenticated, requireRole(\"owner\", \"contractor\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertWorkOrderSchema.parse(req.body);\n\n      // Security: Validate teamId belongs to organization if provided\n      if (validatedData.teamId) {\n        const team = await storage.getTeam(validatedData.teamId);\n        if (!team || team.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Team not found or access denied\" });\n        }\n      }\n\n      // Security: Validate contractorId belongs to organization if provided\n      if (validatedData.contractorId) {\n        const contractor = await storage.getUser(validatedData.contractorId);\n        if (!contractor || contractor.organizationId !== user.organizationId) {\n          return res.status(403).json({ error: \"Contractor not found or access denied\" });\n        }\n      }\n\n      const workOrder = await storage.createWorkOrder({\n        ...validatedData,\n        organizationId: user.organizationId,\n      });\n\n      // Send email notification to team if teamId is provided (best-effort, non-blocking)\n      if (validatedData.teamId) {\n        try {\n          const team = await storage.getTeam(validatedData.teamId);\n          const maintenanceRequest = await db\n            .select()\n            .from(maintenanceRequests)\n            .where(eq(maintenanceRequests.id, validatedData.maintenanceRequestId))\n            .limit(1)\n            .then(rows => rows[0]);\n          \n          if (team?.email && maintenanceRequest) {\n            // Fetch property details if available\n            let propertyName: string | undefined;\n            if (maintenanceRequest.propertyId) {\n              const property = await storage.getProperty(maintenanceRequest.propertyId);\n              propertyName = property?.name;\n            }\n\n            await sendTeamWorkOrderNotification(\n              team.email,\n              team.name,\n              {\n                id: workOrder.id,\n                maintenanceTitle: maintenanceRequest.title,\n                maintenanceDescription: maintenanceRequest.description || undefined,\n                priority: maintenanceRequest.priority,\n                propertyName,\n                slaDue: validatedData.slaDue ? new Date(validatedData.slaDue) : null,\n                costEstimate: validatedData.costEstimate || null,\n              }\n            );\n            console.log(`Team notification email sent successfully for work order ${workOrder.id} to team ${team.name} (${team.email})`);\n          }\n        } catch (emailError) {\n          // Log email failures but don't block work order creation\n          console.error(`Failed to send team notification email for work order ${workOrder.id}:`, emailError);\n          console.error(`Email error details:`, {\n            workOrderId: workOrder.id,\n            teamId: validatedData.teamId,\n            error: emailError instanceof Error ? emailError.message : 'Unknown error',\n          });\n        }\n      }\n\n      // Send email notification to contractor if contractorId is provided (best-effort, non-blocking)\n      if (validatedData.contractorId) {\n        try {\n          const contractor = await storage.getUser(validatedData.contractorId);\n          const maintenanceRequest = await db\n            .select()\n            .from(maintenanceRequests)\n            .where(eq(maintenanceRequests.id, validatedData.maintenanceRequestId))\n            .limit(1)\n            .then(rows => rows[0]);\n          \n          if (contractor?.email && maintenanceRequest) {\n            // Fetch property details if available\n            let propertyName: string | undefined;\n            if (maintenanceRequest.propertyId) {\n              const property = await storage.getProperty(maintenanceRequest.propertyId);\n              propertyName = property?.name;\n            }\n\n            const contractorName = contractor.firstName \n              ? `${contractor.firstName}${contractor.lastName ? ' ' + contractor.lastName : ''}`\n              : contractor.username;\n\n            await sendContractorWorkOrderNotification(\n              contractor.email,\n              contractorName,\n              {\n                id: workOrder.id,\n                maintenanceTitle: maintenanceRequest.title,\n                maintenanceDescription: maintenanceRequest.description || undefined,\n                priority: maintenanceRequest.priority,\n                propertyName,\n                slaDue: validatedData.slaDue ? new Date(validatedData.slaDue) : null,\n                costEstimate: validatedData.costEstimate || null,\n              }\n            );\n            console.log(`Contractor notification email sent successfully for work order ${workOrder.id} to ${contractorName} (${contractor.email})`);\n          }\n        } catch (emailError) {\n          // Log email failures but don't block work order creation\n          console.error(`Failed to send contractor notification email for work order ${workOrder.id}:`, emailError);\n          console.error(`Email error details:`, {\n            workOrderId: workOrder.id,\n            contractorId: validatedData.contractorId,\n            error: emailError instanceof Error ? emailError.message : 'Unknown error',\n          });\n        }\n      }\n\n      res.status(201).json(workOrder);\n    } catch (error: any) {\n      console.error(\"Error creating work order:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create work order\" });\n    }\n  });\n\n  app.get(\"/api/work-orders\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // If user is a contractor, show only their work orders\n      const workOrders = user.role === \"contractor\"\n        ? await storage.getWorkOrdersByContractor(userId)\n        : await storage.getWorkOrdersByOrganization(user.organizationId);\n      \n      res.json(workOrders);\n    } catch (error) {\n      console.error(\"Error fetching work orders:\", error);\n      res.status(500).json({ error: \"Failed to fetch work orders\" });\n    }\n  });\n\n  app.get(\"/api/work-orders/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const workOrder = await storage.getWorkOrder(req.params.id);\n      if (!workOrder) {\n        return res.status(404).json({ error: \"Work order not found\" });\n      }\n\n      // Verify access: owner/org members can see all, contractors can only see their assigned orders\n      if (user.role === \"contractor\") {\n        if (workOrder.contractorId !== userId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (workOrder.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json(workOrder);\n    } catch (error) {\n      console.error(\"Error fetching work order:\", error);\n      res.status(500).json({ error: \"Failed to fetch work order\" });\n    }\n  });\n\n  app.patch(\"/api/work-orders/:id/status\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const workOrder = await storage.getWorkOrder(req.params.id);\n      if (!workOrder) {\n        return res.status(404).json({ error: \"Work order not found\" });\n      }\n\n      // Verify access\n      if (user.role === \"contractor\") {\n        if (workOrder.contractorId !== userId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (workOrder.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { status } = req.body;\n      const completedAt = status === \"completed\" ? new Date() : undefined;\n      const updated = await storage.updateWorkOrderStatus(req.params.id, status, completedAt);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating work order status:\", error);\n      res.status(500).json({ error: \"Failed to update work order status\" });\n    }\n  });\n\n  app.patch(\"/api/work-orders/:id/cost\", isAuthenticated, requireRole(\"owner\", \"contractor\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const workOrder = await storage.getWorkOrder(req.params.id);\n      if (!workOrder) {\n        return res.status(404).json({ error: \"Work order not found\" });\n      }\n\n      // Verify access\n      if (user.role === \"contractor\") {\n        if (workOrder.contractorId !== userId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (workOrder.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { costActual, variationNotes } = req.body;\n      const updated = await storage.updateWorkOrderCost(req.params.id, costActual, variationNotes);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating work order cost:\", error);\n      res.status(500).json({ error: \"Failed to update work order cost\" });\n    }\n  });\n\n  // ==================== WORK LOG ROUTES ====================\n  \n  app.post(\"/api/work-logs\", isAuthenticated, requireRole(\"owner\", \"contractor\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const validatedData = insertWorkLogSchema.parse(req.body);\n\n      // Verify parent work order belongs to user's organization or contractor\n      const workOrder = await storage.getWorkOrder(validatedData.workOrderId);\n      if (!workOrder) {\n        return res.status(404).json({ error: \"Work order not found\" });\n      }\n\n      // Verify access\n      if (user.role === \"contractor\") {\n        if (workOrder.contractorId !== userId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (workOrder.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const log = await storage.createWorkLog(validatedData);\n      res.status(201).json(log);\n    } catch (error: any) {\n      console.error(\"Error creating work log:\", error);\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      res.status(500).json({ error: \"Failed to create work log\" });\n    }\n  });\n\n  app.get(\"/api/work-orders/:workOrderId/logs\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Verify work order belongs to user's organization or contractor\n      const workOrder = await storage.getWorkOrder(req.params.workOrderId);\n      if (!workOrder) {\n        return res.status(404).json({ error: \"Work order not found\" });\n      }\n\n      // Verify access\n      if (user.role === \"contractor\") {\n        if (workOrder.contractorId !== userId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (workOrder.organizationId !== user.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const logs = await storage.getWorkLogs(req.params.workOrderId);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching work logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch work logs\" });\n    }\n  });\n\n  // Get work order analytics\n  app.get(\"/api/analytics/work-orders\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      // Get all work orders for the organization\n      const workOrders = await storage.getWorkOrdersByOrganization(user.organizationId);\n\n      // Batch fetch all teams to avoid N+1 queries\n      const allTeams = await storage.getTeamsByOrganization(user.organizationId);\n      const teamsById = new Map(allTeams.map(t => [t.id, t]));\n\n      // Batch fetch all maintenance requests to avoid N+1 queries\n      const maintenanceRequestIds = workOrders.map(wo => wo.maintenanceRequestId);\n      const maintenanceRequestsData = await db\n        .select()\n        .from(maintenanceRequests)\n        .where(eq(maintenanceRequests.organizationId, user.organizationId));\n      const maintenanceRequestsById = new Map(maintenanceRequestsData.map(mr => [mr.id, mr]));\n\n      // Map work order statuses to UI groupings\n      // assigned/waiting_parts  \"open\", in_progress  \"in_progress\", completed  \"completed\", rejected  \"rejected\"\n      const statusDistribution: { [key: string]: number } = {\n        open: 0,\n        in_progress: 0,\n        completed: 0,\n        rejected: 0,\n      };\n      \n      for (const wo of workOrders) {\n        if (wo.status === \"assigned\" || wo.status === \"waiting_parts\") {\n          statusDistribution.open++;\n        } else if (wo.status === \"in_progress\") {\n          statusDistribution.in_progress++;\n        } else if (wo.status === \"completed\") {\n          statusDistribution.completed++;\n        } else if (wo.status === \"rejected\") {\n          statusDistribution.rejected++;\n        }\n      }\n\n      // Calculate priority distribution from linked maintenance requests\n      const priorityDistribution: { [key: string]: number } = {};\n      for (const wo of workOrders) {\n        const mr = maintenanceRequestsById.get(wo.maintenanceRequestId);\n        if (mr?.priority) {\n          priorityDistribution[mr.priority] = (priorityDistribution[mr.priority] || 0) + 1;\n        }\n      }\n\n      // Calculate average resolution time for completed work orders\n      const completedWorkOrders = workOrders.filter(wo => wo.status === \"completed\" && wo.completedAt && wo.createdAt);\n      const averageResolutionTimeMinutes = completedWorkOrders.length > 0\n        ? completedWorkOrders.reduce((sum, wo) => {\n            const resolutionTime = wo.completedAt!.getTime() - wo.createdAt!.getTime();\n            return sum + (resolutionTime / (1000 * 60)); // Convert to minutes\n          }, 0) / completedWorkOrders.length\n        : 0;\n\n      // Calculate team distribution\n      const teamDistribution: { [key: string]: { name: string; count: number } } = {};\n      for (const wo of workOrders) {\n        if (wo.teamId) {\n          if (!teamDistribution[wo.teamId]) {\n            const team = teamsById.get(wo.teamId);\n            teamDistribution[wo.teamId] = {\n              name: team?.name || 'Unknown Team',\n              count: 0\n            };\n          }\n          teamDistribution[wo.teamId].count++;\n        }\n      }\n\n      // Calculate category distribution from linked maintenance requests\n      const categoryDistribution: { [key: string]: number } = {};\n      for (const wo of workOrders) {\n        const mr = maintenanceRequestsById.get(wo.maintenanceRequestId);\n        if (mr?.category) {\n          categoryDistribution[mr.category] = (categoryDistribution[mr.category] || 0) + 1;\n        }\n      }\n\n      res.json({\n        total: workOrders.length,\n        statusDistribution,\n        priorityDistribution,\n        teamDistribution,\n        categoryDistribution,\n        averageResolutionTimeMinutes: Math.round(averageResolutionTimeMinutes),\n      });\n    } catch (error) {\n      console.error(\"Error fetching work order analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch analytics\" });\n    }\n  });\n\n  // ==================== TAG ROUTES ====================\n  \n  // Create a new tag\n  app.post(\"/api/tags\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user || !user.organizationId) {\n        return res.status(403).json({ error: \"User not associated with an organization\" });\n      }\n\n      const validatedData = insertTagSchema.parse({\n        ...req.body,\n        organizationId: user.organizationId,\n      });\n\n      const tag = await storage.createTag(validatedData);\n      res.json(tag);\n    } catch (error: any) {\n      console.error(\"Error creating tag:\", error);\n      res.status(400).json({ error: error.message || \"Failed to create tag\" });\n    }\n  });\n\n  // Get all tags for the organization\n  app.get(\"/api/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user || !user.organizationId) {\n        return res.status(403).json({ error: \"User not associated with an organization\" });\n      }\n\n      const tags = await storage.getTagsByOrganization(user.organizationId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch tags\" });\n    }\n  });\n\n  // Update a tag\n  app.patch(\"/api/tags/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      const tag = await storage.getTag(req.params.id);\n\n      if (!tag) {\n        return res.status(404).json({ error: \"Tag not found\" });\n      }\n\n      if (tag.organizationId !== user?.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const updated = await storage.updateTag(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating tag:\", error);\n      res.status(500).json({ error: \"Failed to update tag\" });\n    }\n  });\n\n  // Delete a tag\n  app.delete(\"/api/tags/:id\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      const tag = await storage.getTag(req.params.id);\n\n      if (!tag) {\n        return res.status(404).json({ error: \"Tag not found\" });\n      }\n\n      if (tag.organizationId !== user?.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.deleteTag(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting tag:\", error);\n      res.status(500).json({ error: \"Failed to delete tag\" });\n    }\n  });\n\n  // Add tag to block\n  app.post(\"/api/blocks/:blockId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      const block = await storage.getBlock(req.params.blockId);\n      const tag = await storage.getTag(req.params.tagId);\n\n      if (!block || !tag) {\n        return res.status(404).json({ error: \"Block or tag not found\" });\n      }\n\n      if (block.organizationId !== user?.organizationId || tag.organizationId !== user?.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.addTagToBlock(req.params.blockId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to block:\", error);\n      res.status(500).json({ error: \"Failed to add tag to block\" });\n    }\n  });\n\n  // Remove tag from block\n  app.delete(\"/api/blocks/:blockId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromBlock(req.params.blockId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from block:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from block\" });\n    }\n  });\n\n  // Get tags for block\n  app.get(\"/api/blocks/:blockId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForBlock(req.params.blockId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching block tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch block tags\" });\n    }\n  });\n\n  // Add tag to property\n  app.post(\"/api/properties/:propertyId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      const property = await storage.getProperty(req.params.propertyId);\n      const tag = await storage.getTag(req.params.tagId);\n\n      if (!property || !tag) {\n        return res.status(404).json({ error: \"Property or tag not found\" });\n      }\n\n      if (property.organizationId !== user?.organizationId || tag.organizationId !== user?.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.addTagToProperty(req.params.propertyId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to property:\", error);\n      res.status(500).json({ error: \"Failed to add tag to property\" });\n    }\n  });\n\n  // Remove tag from property\n  app.delete(\"/api/properties/:propertyId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromProperty(req.params.propertyId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from property:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from property\" });\n    }\n  });\n\n  // Get tags for property\n  app.get(\"/api/properties/:propertyId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForProperty(req.params.propertyId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching property tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch property tags\" });\n    }\n  });\n\n  // Add tag to user\n  app.post(\"/api/users/:userId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      const targetUser = await storage.getUser(req.params.userId);\n      const tag = await storage.getTag(req.params.tagId);\n\n      if (!targetUser || !tag) {\n        return res.status(404).json({ error: \"User or tag not found\" });\n      }\n\n      if (targetUser.organizationId !== user?.organizationId || tag.organizationId !== user?.organizationId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await storage.addTagToUser(req.params.userId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to user:\", error);\n      res.status(500).json({ error: \"Failed to add tag to user\" });\n    }\n  });\n\n  // Remove tag from user\n  app.delete(\"/api/users/:userId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromUser(req.params.userId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from user:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from user\" });\n    }\n  });\n\n  // Get tags for user\n  app.get(\"/api/users/:userId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForUser(req.params.userId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching user tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch user tags\" });\n    }\n  });\n\n  // Add tag to compliance document\n  app.post(\"/api/compliance/:complianceId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      await storage.addTagToComplianceDocument(req.params.complianceId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to compliance document:\", error);\n      res.status(500).json({ error: \"Failed to add tag to compliance document\" });\n    }\n  });\n\n  // Remove tag from compliance document\n  app.delete(\"/api/compliance/:complianceId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"compliance\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromComplianceDocument(req.params.complianceId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from compliance document:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from compliance document\" });\n    }\n  });\n\n  // Get tags for compliance document\n  app.get(\"/api/compliance/:complianceId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForComplianceDocument(req.params.complianceId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching compliance document tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch compliance document tags\" });\n    }\n  });\n\n  // Add tag to asset inventory\n  app.post(\"/api/asset-inventory/:assetId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.addTagToAssetInventory(req.params.assetId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to add tag to asset inventory\" });\n    }\n  });\n\n  // Remove tag from asset inventory\n  app.delete(\"/api/asset-inventory/:assetId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromAssetInventory(req.params.assetId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from asset inventory:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from asset inventory\" });\n    }\n  });\n\n  // Get tags for asset inventory\n  app.get(\"/api/asset-inventory/:assetId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForAssetInventory(req.params.assetId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching asset inventory tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch asset inventory tags\" });\n    }\n  });\n\n  // Add tag to maintenance request\n  app.post(\"/api/maintenance/:requestId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.addTagToMaintenanceRequest(req.params.requestId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to maintenance request:\", error);\n      res.status(500).json({ error: \"Failed to add tag to maintenance request\" });\n    }\n  });\n\n  // Remove tag from maintenance request\n  app.delete(\"/api/maintenance/:requestId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromMaintenanceRequest(req.params.requestId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from maintenance request:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from maintenance request\" });\n    }\n  });\n\n  // Get tags for maintenance request\n  app.get(\"/api/maintenance/:requestId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForMaintenanceRequest(req.params.requestId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching maintenance request tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch maintenance request tags\" });\n    }\n  });\n\n  // Add tag to contact\n  app.post(\"/api/contacts/:contactId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      await storage.addTagToContact(req.params.contactId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error adding tag to contact:\", error);\n      res.status(500).json({ error: \"Failed to add tag to contact\" });\n    }\n  });\n\n  // Remove tag from contact\n  app.delete(\"/api/contacts/:contactId/tags/:tagId\", isAuthenticated, requireRole(\"owner\", \"clerk\", \"compliance\"), async (req: any, res) => {\n    try {\n      await storage.removeTagFromContact(req.params.contactId, req.params.tagId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing tag from contact:\", error);\n      res.status(500).json({ error: \"Failed to remove tag from contact\" });\n    }\n  });\n\n  // Get tags for contact\n  app.get(\"/api/contacts/:contactId/tags\", isAuthenticated, async (req: any, res) => {\n    try {\n      const tags = await storage.getTagsForContact(req.params.contactId);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching contact tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch contact tags\" });\n    }\n  });\n\n  // Search entities by tags\n  app.post(\"/api/tags/search\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user || !user.organizationId) {\n        return res.status(403).json({ error: \"User not associated with an organization\" });\n      }\n\n      const { tagIds } = req.body;\n      if (!Array.isArray(tagIds)) {\n        return res.status(400).json({ error: \"tagIds must be an array\" });\n      }\n\n      const results = await storage.searchByTags(user.organizationId, tagIds);\n      res.json(results);\n    } catch (error) {\n      console.error(\"Error searching by tags:\", error);\n      res.status(500).json({ error: \"Failed to search by tags\" });\n    }\n  });\n\n  // ==================== DASHBOARD PREFERENCES ROUTES ====================\n  \n  // Define role-based panel permissions\n  const PANEL_PERMISSIONS: Record<string, string[]> = {\n    stats: [\"owner\", \"clerk\", \"compliance\"],\n    inspections: [\"owner\", \"clerk\"],\n    compliance: [\"owner\", \"compliance\"],\n    maintenance: [\"owner\", \"clerk\"],\n    assets: [\"owner\", \"clerk\"],\n    workOrders: [\"owner\", \"contractor\"],\n    inspectionTrend: [\"owner\", \"clerk\"],\n    statusDistribution: [\"owner\", \"clerk\", \"compliance\"],\n    credits: [\"owner\"],\n  };\n\n  // Get allowed panels for a role\n  function getAllowedPanels(role: string): string[] {\n    return Object.keys(PANEL_PERMISSIONS).filter(panel => \n      PANEL_PERMISSIONS[panel].includes(role)\n    );\n  }\n\n  // Filter panels based on role permissions\n  function filterPanelsByRole(panels: string[], role: string): string[] {\n    const allowed = getAllowedPanels(role);\n    return panels.filter(panel => allowed.includes(panel));\n  }\n\n  // Get dashboard preferences\n  app.get(\"/api/dashboard/preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      const prefs = await storage.getDashboardPreferences(userId);\n      \n      // Default panels based on role\n      const defaultPanels = getAllowedPanels(user.role);\n      \n      if (!prefs) {\n        return res.json({ enabledPanels: defaultPanels });\n      }\n\n      // Parse enabled panels if stored as string\n      let enabledPanels = prefs.enabledPanels;\n      if (typeof enabledPanels === \"string\") {\n        enabledPanels = JSON.parse(enabledPanels);\n      }\n\n      // Filter panels to only those allowed for user's role\n      const filteredPanels = filterPanelsByRole(enabledPanels as string[], user.role);\n      \n      res.json({ enabledPanels: filteredPanels });\n    } catch (error) {\n      console.error(\"Error fetching dashboard preferences:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboard preferences\" });\n    }\n  });\n\n  // Update dashboard preferences\n  app.put(\"/api/dashboard/preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      const { enabledPanels } = req.body;\n      \n      if (!Array.isArray(enabledPanels)) {\n        return res.status(400).json({ error: \"enabledPanels must be an array\" });\n      }\n\n      // Filter panels to only those allowed for user's role\n      const filteredPanels = filterPanelsByRole(enabledPanels, user.role);\n\n      const prefs = await storage.updateDashboardPreferences(userId, filteredPanels);\n      res.json({ ...prefs, enabledPanels: filteredPanels });\n    } catch (error) {\n      console.error(\"Error updating dashboard preferences:\", error);\n      res.status(500).json({ error: \"Failed to update dashboard preferences\" });\n    }\n  });\n\n  // ==================== INSPECTION TEMPLATE ROUTES ====================\n\n  // Template Categories\n  app.get(\"/api/template-categories\", isAuthenticated, requireRole('owner', 'clerk', 'compliance'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const categories = await storage.getTemplateCategoriesByOrganization(user.organizationId);\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching template categories:\", error);\n      res.status(500).json({ message: \"Failed to fetch template categories\" });\n    }\n  });\n\n  app.post(\"/api/template-categories\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const validatedData = insertTemplateCategorySchema.parse({\n        ...req.body,\n        organizationId: user.organizationId\n      });\n      const category = await storage.createTemplateCategory(validatedData);\n      res.status(201).json(category);\n    } catch (error) {\n      console.error(\"Error creating template category:\", error);\n      res.status(400).json({ message: \"Failed to create template category\" });\n    }\n  });\n\n  app.put(\"/api/template-categories/:id\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      // Verify ownership\n      const existing = await storage.getTemplateCategory(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      const category = await storage.updateTemplateCategory(req.params.id, req.body);\n      res.json(category);\n    } catch (error) {\n      console.error(\"Error updating template category:\", error);\n      res.status(400).json({ message: \"Failed to update template category\" });\n    }\n  });\n\n  app.delete(\"/api/template-categories/:id\", isAuthenticated, requireRole('owner'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const existing = await storage.getTemplateCategory(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      await storage.deleteTemplateCategory(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting template category:\", error);\n      res.status(500).json({ message: \"Failed to delete template category\" });\n    }\n  });\n\n  // Inspection Templates\n  app.get(\"/api/inspection-templates\", isAuthenticated, requireRole('owner', 'clerk', 'compliance'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const { scope, categoryId, active } = req.query;\n      let templates = await storage.getInspectionTemplatesByOrganization(user.organizationId);\n      \n      // Apply filtering based on query parameters\n      if (scope && scope !== 'all') {\n        if (scope === 'both') {\n          // When filtering by \"both\", show ONLY templates with scope='both'\n          templates = templates.filter(t => t.scope === 'both');\n        } else {\n          // When filtering by specific scope (property/block), also include templates with scope='both'\n          templates = templates.filter(t => t.scope === scope || t.scope === 'both');\n        }\n      }\n      if (categoryId && categoryId !== 'all') {\n        templates = templates.filter(t => t.categoryId === categoryId);\n      }\n      if (active !== undefined && active !== 'all') {\n        const isActive = active === 'true';\n        templates = templates.filter(t => t.isActive === isActive);\n      }\n      \n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching inspection templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspection templates\" });\n    }\n  });\n\n  app.get(\"/api/inspection-templates/:id\", isAuthenticated, requireRole('owner', 'clerk', 'compliance'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const template = await storage.getInspectionTemplate(req.params.id);\n      if (!template || template.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching inspection template:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspection template\" });\n    }\n  });\n\n  app.post(\"/api/inspection-templates\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const validatedData = insertInspectionTemplateSchema.parse({\n        ...req.body,\n        organizationId: user.organizationId,\n        createdBy: req.user.id\n      });\n      const template = await storage.createInspectionTemplate(validatedData);\n      res.status(201).json(template);\n    } catch (error) {\n      console.error(\"Error creating inspection template:\", error);\n      res.status(400).json({ message: \"Failed to create inspection template\" });\n    }\n  });\n\n  app.put(\"/api/inspection-templates/:id\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const existing = await storage.getInspectionTemplate(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      // Prepare updates - stringify structureJson if it's an object\n      const updates: any = { ...req.body };\n      if (updates.structureJson && typeof updates.structureJson !== 'string') {\n        updates.structureJson = JSON.stringify(updates.structureJson);\n      }\n      \n      // Remove fields that shouldn't be updated via API\n      delete updates.id;\n      delete updates.organizationId;\n      delete updates.createdBy;\n      delete updates.createdAt;\n      delete updates.updatedAt;\n      \n      const template = await storage.updateInspectionTemplate(req.params.id, updates);\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error updating inspection template:\", error);\n      res.status(400).json({ message: \"Failed to update inspection template\" });\n    }\n  });\n\n  app.delete(\"/api/inspection-templates/:id\", isAuthenticated, requireRole('owner'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const existing = await storage.getInspectionTemplate(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      await storage.deleteInspectionTemplate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting inspection template:\", error);\n      res.status(500).json({ message: \"Failed to delete inspection template\" });\n    }\n  });\n\n  // Clone template (create new version)\n  app.post(\"/api/inspection-templates/:id/clone\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const existing = await storage.getInspectionTemplate(req.params.id);\n      if (!existing || existing.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      // Create new template with incremented version\n      const newVersion = existing.version + 1;\n      const clonedTemplate = await storage.createInspectionTemplate({\n        organizationId: user.organizationId,\n        name: req.body.name || `${existing.name} (v${newVersion})`,\n        description: req.body.description || existing.description,\n        categoryId: existing.categoryId,\n        scope: existing.scope,\n        structureJson: existing.structureJson as any,\n        version: newVersion,\n        parentTemplateId: existing.parentTemplateId || existing.id,\n        isActive: req.body.isActive ?? false,\n        createdBy: req.user.id\n      });\n      \n      res.status(201).json(clonedTemplate);\n    } catch (error) {\n      console.error(\"Error cloning inspection template:\", error);\n      res.status(400).json({ message: \"Failed to clone inspection template\" });\n    }\n  });\n\n  // Template Inventory Links\n  app.get(\"/api/inspection-templates/:templateId/inventory-links\", isAuthenticated, requireRole('owner', 'clerk', 'compliance'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const template = await storage.getInspectionTemplate(req.params.templateId);\n      if (!template || template.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      const links = await storage.getTemplateInventoryLinks(req.params.templateId);\n      res.json(links);\n    } catch (error) {\n      console.error(\"Error fetching template inventory links:\", error);\n      res.status(500).json({ message: \"Failed to fetch template inventory links\" });\n    }\n  });\n\n  app.post(\"/api/template-inventory-links\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const validatedData = insertTemplateInventoryLinkSchema.parse(req.body);\n      // Verify template ownership\n      const template = await storage.getInspectionTemplate(validatedData.templateId);\n      if (!template || template.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Unauthorized\" });\n      }\n      const link = await storage.createTemplateInventoryLink(validatedData);\n      res.status(201).json(link);\n    } catch (error) {\n      console.error(\"Error creating template inventory link:\", error);\n      res.status(400).json({ message: \"Failed to create template inventory link\" });\n    }\n  });\n\n  app.delete(\"/api/template-inventory-links/:id\", isAuthenticated, requireRole('owner', 'clerk'), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      await storage.deleteTemplateInventoryLink(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting template inventory link:\", error);\n      res.status(500).json({ message: \"Failed to delete template inventory link\" });\n    }\n  });\n\n  // Inspection Entries\n  app.get(\"/api/inspections/:inspectionId/entries\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const entries = await storage.getInspectionEntries(req.params.inspectionId);\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching inspection entries:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspection entries\" });\n    }\n  });\n\n  app.get(\"/api/inspection-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const entry = await storage.getInspectionEntry(req.params.id);\n      if (!entry) {\n        return res.status(404).json({ message: \"Entry not found\" });\n      }\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error fetching inspection entry:\", error);\n      res.status(500).json({ message: \"Failed to fetch inspection entry\" });\n    }\n  });\n\n  app.post(\"/api/inspection-entries\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const validatedData = insertInspectionEntrySchema.parse(req.body);\n      const entry = await storage.createInspectionEntry(validatedData);\n      res.status(201).json(entry);\n    } catch (error) {\n      console.error(\"Error creating inspection entry:\", error);\n      res.status(400).json({ message: \"Failed to create inspection entry\" });\n    }\n  });\n\n  // Batch create entries (for offline sync)\n  app.post(\"/api/inspection-entries/batch\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const { entries } = req.body;\n      if (!Array.isArray(entries)) {\n        return res.status(400).json({ message: \"entries must be an array\" });\n      }\n      const validatedEntries = entries.map(e => insertInspectionEntrySchema.parse(e));\n      const created = await storage.createInspectionEntriesBatch(validatedEntries);\n      res.status(201).json(created);\n    } catch (error) {\n      console.error(\"Error batch creating inspection entries:\", error);\n      res.status(400).json({ message: \"Failed to batch create inspection entries\" });\n    }\n  });\n\n  app.put(\"/api/inspection-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const entry = await storage.updateInspectionEntry(req.params.id, req.body);\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error updating inspection entry:\", error);\n      res.status(400).json({ message: \"Failed to update inspection entry\" });\n    }\n  });\n\n  app.patch(\"/api/inspection-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const entry = await storage.updateInspectionEntry(req.params.id, req.body);\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error updating inspection entry:\", error);\n      res.status(400).json({ message: \"Failed to update inspection entry\" });\n    }\n  });\n\n  app.delete(\"/api/inspection-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      await storage.deleteInspectionEntry(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting inspection entry:\", error);\n      res.status(500).json({ message: \"Failed to delete inspection entry\" });\n    }\n  });\n\n  // AI Image Analyses\n  app.get(\"/api/inspections/:inspectionId/ai-analyses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const analyses = await storage.getAiImageAnalysesByInspection(req.params.inspectionId);\n      res.json(analyses);\n    } catch (error) {\n      console.error(\"Error fetching AI analyses:\", error);\n      res.status(500).json({ message: \"Failed to fetch AI analyses\" });\n    }\n  });\n\n  app.get(\"/api/inspection-entries/:entryId/ai-analyses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      const analyses = await storage.getAiImageAnalysesByEntry(req.params.entryId);\n      res.json(analyses);\n    } catch (error) {\n      console.error(\"Error fetching AI analyses:\", error);\n      res.status(500).json({ message: \"Failed to fetch AI analyses\" });\n    }\n  });\n\n  app.post(\"/api/ai-analyses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user || !user.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const { inspectionId, inspectionEntryId, imageUrl, context } = req.body;\n\n      // Verify user has access to this inspection\n      const inspection = await storage.getInspection(inspectionId);\n      if (!inspection) {\n        return res.status(404).json({ message: \"Inspection not found\" });\n      }\n\n      // Check if organization has credits\n      const org = await storage.getOrganization(user.organizationId);\n      if (!org || (org.creditsRemaining ?? 0) < 1) {\n        return res.status(402).json({ message: \"Insufficient AI credits\" });\n      }\n\n      // Convert image URL to base64 data URL (for internal object storage)\n      console.log(\"[Individual Photo Analysis] Processing photo:\", imageUrl);\n      \n      let dataUrl: string;\n      if (imageUrl.startsWith(\"http\")) {\n        // External URL - use directly\n        dataUrl = imageUrl;\n        console.log(\"[Individual Photo Analysis] Using external URL directly\");\n      } else {\n        // Internal object storage - convert to base64\n        try {\n          const objectStorageService = new ObjectStorageService();\n          // Ensure path starts with /objects/\n          const photoPath = imageUrl.startsWith('/objects/') ? imageUrl : `/objects/${imageUrl}`;\n          const objectFile = await objectStorageService.getObjectEntityFile(photoPath);\n          \n          // Read the file contents using fs.readFile first\n          const photoBuffer = await fs.readFile(objectFile.name);\n          \n          // Always detect MIME type from buffer for reliability\n          let mimeType = detectImageMimeType(photoBuffer);\n          \n          // Get metadata for logging purposes\n          const [metadata] = await objectFile.getMetadata();\n          const metadataContentType = metadata.contentType;\n          \n          console.log(`[Individual Photo Analysis] MIME type detection:`, {\n            detected: mimeType,\n            fromMetadata: metadataContentType,\n            bufferSize: photoBuffer.length,\n            firstBytes: Array.from(photoBuffer.slice(0, 12)).map(b => `0x${b.toString(16).padStart(2, '0')}`).join(' ')\n          });\n          \n          // Ensure we have a valid image MIME type\n          if (!mimeType || !mimeType.startsWith('image/')) {\n            console.warn(`[Individual Photo Analysis] Invalid MIME type detected: ${mimeType}, defaulting to image/jpeg`);\n            mimeType = 'image/jpeg';\n          }\n          \n          // Convert to base64 data URL\n          const base64Image = photoBuffer.toString('base64');\n          dataUrl = `data:${mimeType};base64,${base64Image}`;\n          \n          // Validate the data URL format\n          if (!dataUrl.startsWith(`data:${mimeType};base64,`)) {\n            throw new Error(`Invalid data URL format: ${dataUrl.substring(0, 50)}...`);\n          }\n          \n          console.log(\"[Individual Photo Analysis] Converted to base64 data URL:\", photoPath, `(${mimeType}, ${base64Image.length} bytes)`);\n        } catch (error: any) {\n          // Safely log error without circular reference issues\n          const errorMessage = error?.message || String(error);\n          console.error(\"[Individual Photo Analysis] Error converting photo to base64:\", {\n            imageUrl,\n            message: errorMessage,\n            errorType: error?.constructor?.name,\n          });\n          if (error instanceof ObjectNotFoundError) {\n            throw new Error(`Photo not found: ${imageUrl}. The file may have been deleted or moved.`);\n          }\n          throw new Error(`Failed to load photo for analysis: ${imageUrl}. ${errorMessage}`);\n        }\n      }\n\n      // Call OpenAI Vision API using Responses API\n      const openaiClient = getOpenAI();\n      const response = await openaiClient.responses.create({\n        model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n        input: [\n          {\n            role: \"user\",\n            content: normalizeApiContent([\n              {\n                type: \"text\",\n                text: context || \"Analyze this inspection photo. Identify the room/item, assess its condition, note any defects, damage, or issues that require attention. Provide a detailed assessment.\"\n              },\n              {\n                type: \"image_url\",\n                image_url: dataUrl\n              }\n            ])\n          }\n        ],\n        max_output_tokens: 500\n      });\n\n      let analysisText = response.output_text || response.output?.[0]?.content?.[0]?.text || \"\";\n      \n      // Strip markdown asterisks from the response\n      analysisText = analysisText.replace(/\\*\\*/g, '');\n\n      // Deduct credit\n      await storage.updateOrganizationCredits(user.organizationId, (org.creditsRemaining ?? 0) - 1);\n\n      // Save analysis\n      const validatedData = insertAiImageAnalysisSchema.parse({\n        inspectionId: inspectionId || undefined,\n        inspectionEntryId: inspectionEntryId || undefined,\n        mediaUrl: imageUrl, // Schema expects mediaUrl, not imageUrl\n        mediaType: \"photo\",\n        model: \"gpt-5\",\n        resultJson: { text: analysisText, model: \"gpt-5\" },\n      });\n      const analysis = await storage.createAiImageAnalysis(validatedData);\n\n      res.status(201).json({ ...analysis, remainingCredits: (org.creditsRemaining ?? 0) - 1 });\n    } catch (error: any) {\n      // Safely log error without circular reference issues\n      const errorMessage = error?.message || String(error);\n      const errorStack = error?.stack;\n      console.error(\"Error creating AI analysis:\", {\n        message: errorMessage,\n        stack: errorStack,\n        status: error?.status,\n        code: error?.code,\n        type: error?.type,\n      });\n      res.status(500).json({ message: \"Failed to create AI analysis\" });\n    }\n  });\n\n  // ==================== OBJECT STORAGE ROUTES ====================\n  \n  app.get(\"/objects/:objectPath(*)\", async (req: any, res) => {\n    const userId = req.user?.claims?.sub || req.user?.id;\n    const objectStorageService = new ObjectStorageService();\n    try {\n      const objectFile = await objectStorageService.getObjectEntityFile(req.path);\n      const canAccess = await objectStorageService.canAccessObjectEntity({\n        objectFile,\n        userId: userId,\n        requestedPermission: ObjectPermission.READ,\n      });\n      if (!canAccess) {\n        return res.sendStatus(401);\n      }\n      objectStorageService.downloadObject(objectFile, res);\n    } catch (error) {\n      console.error(\"Error checking object access:\", error);\n      if (error instanceof ObjectNotFoundError) {\n        return res.sendStatus(404);\n      }\n      return res.sendStatus(500);\n    }\n  });\n\n  app.post(\"/api/objects/upload\", isAuthenticated, async (req, res) => {\n    try {\n      const objectStorageService = new ObjectStorageService();\n      const relativePath = await objectStorageService.getObjectEntityUploadURL();\n      \n      // Convert relative path to absolute URL\n      const baseUrl = getBaseUrl(req);\n      const uploadURL = `${baseUrl}${relativePath}`;\n      \n      res.json({ uploadURL });\n    } catch (error: any) {\n      console.error(\"Error generating upload URL:\", error);\n      res.status(500).json({ error: \"Failed to generate upload URL\" });\n    }\n  });\n\n  // Direct upload endpoint for local storage (returns upload URL that points to upload-file)\n  // Supports both POST (multer) and PUT (raw body) for compatibility with Uppy AwsS3 plugin\n  app.post(\"/api/objects/upload-direct\", isAuthenticated, upload.single('file'), async (req: any, res: any) => {\n    try {\n      const objectId = req.query.objectId || randomUUID();\n      const objectStorageService = new ObjectStorageService();\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const normalizedPath = await objectStorageService.saveUploadedFile(\n        objectId as string,\n        req.file.buffer,\n        req.file.mimetype\n      );\n\n      // Generate ETag for S3 compatibility (Uppy AwsS3 plugin requires this)\n      const etag = createHash('md5').update(req.file.buffer).digest('hex');\n      \n      // Set ETag header for S3 compatibility (required by Uppy)\n      res.set('ETag', `\"${etag}\"`);\n      // Also set CORS headers to allow reading ETag\n      res.set('Access-Control-Expose-Headers', 'ETag');\n\n      // Set ACL to public\n      const userId = req.user?.claims?.sub || req.user?.id;\n      if (userId) {\n        try {\n          await objectStorageService.trySetObjectEntityAclPolicy(normalizedPath, {\n            owner: userId,\n            visibility: \"public\",\n          });\n        } catch (error) {\n          console.warn(\"Failed to set ACL:\", error);\n        }\n      }\n\n      res.json({ \n        url: normalizedPath,\n        uploadURL: normalizedPath\n      });\n    } catch (error) {\n      console.error(\"Error in upload-direct:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  // Handle PUT requests (for Uppy AwsS3 plugin - raw body, not multer)\n  app.put(\"/api/objects/upload-direct\", isAuthenticated, async (req: any, res: any) => {\n    try {\n      const objectId = req.query.objectId || randomUUID();\n      const objectStorageService = new ObjectStorageService();\n\n      // For PUT requests, read raw body\n      const chunks: Buffer[] = [];\n      req.on('data', (chunk: Buffer) => chunks.push(chunk));\n      req.on('end', async () => {\n        try {\n          const fileBuffer = Buffer.concat(chunks);\n          \n          if (fileBuffer.length === 0) {\n            return res.status(400).json({ error: \"No file uploaded\" });\n          }\n\n          // Get content type from headers\n          const contentType = req.headers['content-type'] || 'application/octet-stream';\n\n          const normalizedPath = await objectStorageService.saveUploadedFile(\n            objectId as string,\n            fileBuffer,\n            contentType\n          );\n\n          // Generate ETag for S3 compatibility (Uppy AwsS3 plugin requires this)\n          const etag = createHash('md5').update(fileBuffer).digest('hex');\n          \n          // Set ETag header for S3 compatibility (required by Uppy)\n          res.set('ETag', `\"${etag}\"`);\n          // Also set CORS headers to allow reading ETag\n          res.set('Access-Control-Expose-Headers', 'ETag');\n\n          // Set ACL to public\n          const userId = req.user?.claims?.sub || req.user?.id;\n          if (userId) {\n            try {\n              await objectStorageService.trySetObjectEntityAclPolicy(normalizedPath, {\n                owner: userId,\n                visibility: \"public\",\n              });\n            } catch (error) {\n              console.warn(\"Failed to set ACL:\", error);\n            }\n          }\n\n          res.status(200).json({ \n            url: normalizedPath,\n            uploadURL: normalizedPath\n          });\n        } catch (error) {\n          console.error(\"Error in upload-direct PUT:\", error);\n          res.status(500).json({ error: \"Internal server error\" });\n        }\n      });\n    } catch (error) {\n      console.error(\"Error in upload-direct PUT:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  // File upload endpoint using multer\n  app.post(\"/api/objects/upload-file\", isAuthenticated, upload.single('file'), async (req: any, res) => {\n    try {\n      const objectId = req.query.objectId || randomUUID();\n      const objectStorageService = new ObjectStorageService();\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const normalizedPath = await objectStorageService.saveUploadedFile(\n        objectId as string,\n        req.file.buffer,\n        req.file.mimetype\n      );\n\n      // Set ACL to public by default\n      const userId = req.user?.claims?.sub || req.user?.id;\n      if (userId) {\n        try {\n          await objectStorageService.trySetObjectEntityAclPolicy(normalizedPath, {\n            owner: userId,\n            visibility: \"public\",\n          });\n        } catch (error) {\n          console.warn(\"Failed to set ACL for uploaded file:\", error);\n        }\n      }\n\n      res.json({ \n        url: normalizedPath,\n        path: normalizedPath,\n        objectId: objectId\n      });\n    } catch (error) {\n      console.error(\"Error uploading file:\", error);\n      res.status(500).json({ error: \"Failed to upload file\" });\n    }\n  });\n\n  // Alternative endpoint for S3-compatible clients (like Uppy)\n  app.post(\"/api/object-storage/upload\", isAuthenticated, upload.single('file'), async (req: any, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const objectId = randomUUID();\n      const objectStorageService = new ObjectStorageService();\n\n      const normalizedPath = await objectStorageService.saveUploadedFile(\n        objectId,\n        req.file.buffer,\n        req.file.mimetype\n      );\n\n      // Set ACL to public\n      const userId = req.user?.claims?.sub || req.user?.id;\n      if (userId) {\n        try {\n          await objectStorageService.trySetObjectEntityAclPolicy(normalizedPath, {\n            owner: userId,\n            visibility: \"public\",\n          });\n        } catch (error) {\n          console.warn(\"Failed to set ACL:\", error);\n        }\n      }\n\n      // Return S3-compatible response\n      res.json({\n        url: normalizedPath,\n        key: normalizedPath,\n        bucket: \"local\",\n      });\n    } catch (error) {\n      console.error(\"Error in S3-compatible upload:\", error);\n      res.status(500).json({ error: \"Failed to upload file\" });\n    }\n  });\n\n  app.post(\"/api/objects/normalize\", isAuthenticated, async (req, res) => {\n    const { photoUrl } = req.body;\n    if (!photoUrl) {\n      return res.status(400).json({ error: \"photoUrl is required\" });\n    }\n    const objectStorageService = new ObjectStorageService();\n    const normalizedPath = objectStorageService.normalizeObjectEntityPath(photoUrl);\n    res.json({ normalizedPath });\n  });\n\n  app.put(\"/api/objects/set-acl\", isAuthenticated, async (req: any, res) => {\n    if (!req.body.photoUrl) {\n      return res.status(400).json({ error: \"photoUrl is required\" });\n    }\n\n    const userId = req.user?.claims?.sub;\n\n    try {\n      const objectStorageService = new ObjectStorageService();\n      const objectPath = await objectStorageService.trySetObjectEntityAclPolicy(\n        req.body.photoUrl,\n        {\n          owner: userId,\n          visibility: \"public\",\n        },\n      );\n\n      res.status(200).json({ objectPath });\n    } catch (error) {\n      console.error(\"Error setting object ACL:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  // Fix existing photos - make them public\n  app.post(\"/api/objects/fix-acls\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ error: \"No organization found\" });\n      }\n\n      const objectStorageService = new ObjectStorageService();\n      \n      // Get all assets with photos\n      const assets = await storage.getAssetInventoryByOrganization(user.organizationId);\n      const photosToFix: string[] = [];\n      \n      for (const asset of assets) {\n        if (asset.photos && asset.photos.length > 0) {\n          photosToFix.push(...asset.photos);\n        }\n      }\n      \n      // Get all inspection entries with photos\n      const inspections = await storage.getInspectionsByOrganization(user.organizationId);\n      for (const inspection of inspections) {\n        const entries = await storage.getInspectionEntries(inspection.id);\n        for (const entry of entries) {\n          if (entry.photos && entry.photos.length > 0) {\n            photosToFix.push(...entry.photos);\n          }\n        }\n      }\n      \n      // Update ACL for each photo\n      const fixed: string[] = [];\n      const errors: string[] = [];\n      \n      for (const photoPath of photosToFix) {\n        try {\n          await objectStorageService.trySetObjectEntityAclPolicy(\n            photoPath,\n            {\n              owner: userId,\n              visibility: \"public\",\n            },\n          );\n          fixed.push(photoPath);\n        } catch (error) {\n          console.error(`Failed to fix ACL for ${photoPath}:`, error);\n          errors.push(photoPath);\n        }\n      }\n      \n      res.json({ \n        message: `Fixed ${fixed.length} photos (assets + inspections), ${errors.length} errors`,\n        fixed: fixed.length,\n        errors: errors.length \n      });\n    } catch (error) {\n      console.error(\"Error fixing ACLs:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  // ==================== ADMIN ROUTES ====================\n  \n  // Admin authentication middleware\n  const isAdminAuthenticated = (req: any, res: any, next: any) => {\n    if (req.session && (req.session as any).adminUser) {\n      return next();\n    }\n    return res.status(401).json({ message: \"Unauthorized - Admin access required\" });\n  };\n\n  // Admin Login\n  app.post(\"/api/admin/login\", async (req, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email and password are required\" });\n      }\n\n      const adminUser = await storage.getAdminByEmail(email);\n      \n      if (!adminUser) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      const isValidPassword = await bcrypt.compare(password, adminUser.password);\n      \n      if (!isValidPassword) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      // Set admin session\n      (req.session as any).adminUser = {\n        id: adminUser.id,\n        email: adminUser.email,\n        firstName: adminUser.firstName,\n        lastName: adminUser.lastName,\n      };\n\n      res.json({\n        id: adminUser.id,\n        email: adminUser.email,\n        firstName: adminUser.firstName,\n        lastName: adminUser.lastName,\n      });\n    } catch (error) {\n      console.error(\"Admin login error:\", error);\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // Admin Logout\n  app.post(\"/api/admin/logout\", (req, res) => {\n    (req.session as any).adminUser = null;\n    res.json({ message: \"Logged out successfully\" });\n  });\n\n  // Get current admin user\n  app.get(\"/api/admin/me\", isAdminAuthenticated, (req: any, res) => {\n    res.json(req.session.adminUser);\n  });\n\n  // ==================== ADMIN INSTANCE MANAGEMENT ====================\n\n  // Get all instances (organizations) with owner details\n  app.get(\"/api/admin/instances\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const instances = await storage.getAllOrganizationsWithOwners();\n      res.json(instances);\n    } catch (error) {\n      console.error(\"Error fetching instances:\", error);\n      res.status(500).json({ message: \"Failed to fetch instances\" });\n    }\n  });\n\n  // Get single instance details\n  app.get(\"/api/admin/instances/:id\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const instance = await storage.getOrganizationWithOwner(req.params.id);\n      if (!instance) {\n        return res.status(404).json({ message: \"Instance not found\" });\n      }\n      res.json(instance);\n    } catch (error) {\n      console.error(\"Error fetching instance:\", error);\n      res.status(500).json({ message: \"Failed to fetch instance\" });\n    }\n  });\n\n  // Update instance (subscription level, credits, active status)\n  app.patch(\"/api/admin/instances/:id\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const { subscriptionLevel, creditsRemaining, isActive } = req.body;\n      const updated = await storage.updateOrganization(req.params.id, {\n        subscriptionLevel,\n        creditsRemaining,\n        isActive,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating instance:\", error);\n      res.status(500).json({ message: \"Failed to update instance\" });\n    }\n  });\n\n  // Disable/Enable instance\n  app.post(\"/api/admin/instances/:id/toggle-status\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const org = await storage.getOrganization(req.params.id);\n      if (!org) {\n        return res.status(404).json({ message: \"Instance not found\" });\n      }\n      \n      const updated = await storage.updateOrganization(req.params.id, {\n        isActive: !org.isActive,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error toggling instance status:\", error);\n      res.status(500).json({ message: \"Failed to toggle status\" });\n    }\n  });\n\n  // ==================== ADMIN TEAM MANAGEMENT ====================\n\n  // Get all admin users\n  app.get(\"/api/admin/team\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const admins = await storage.getAllAdmins();\n      // Remove password from response\n      const sanitizedAdmins = admins.map(({ password, ...admin }) => admin);\n      res.json(sanitizedAdmins);\n    } catch (error) {\n      console.error(\"Error fetching admin team:\", error);\n      res.status(500).json({ message: \"Failed to fetch admin team\" });\n    }\n  });\n\n  // Create admin user\n  app.post(\"/api/admin/team\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const { email, password, firstName, lastName } = req.body;\n      \n      if (!email || !password || !firstName || !lastName) {\n        return res.status(400).json({ message: \"All fields are required\" });\n      }\n\n      const hashedPassword = await bcrypt.hash(password, 10);\n\n      const admin = await storage.createAdmin({\n        email,\n        password: hashedPassword,\n        firstName,\n        lastName,\n      });\n\n      // Remove password from response\n      const { password: _, ...sanitizedAdmin } = admin;\n      res.json(sanitizedAdmin);\n    } catch (error: any) {\n      console.error(\"Error creating admin:\", error);\n      if (error.message?.includes(\"duplicate\") || error.code === \"23505\") {\n        return res.status(400).json({ message: \"Email already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to create admin\" });\n    }\n  });\n\n  // Update admin user\n  app.patch(\"/api/admin/team/:id\", isAdminAuthenticated, async (req, res) => {\n    try {\n      const { email, firstName, lastName, password } = req.body;\n      const updateData: any = { email, firstName, lastName };\n\n      if (password) {\n        updateData.password = await bcrypt.hash(password, 10);\n      }\n\n      const admin = await storage.updateAdmin(req.params.id, updateData);\n      const { password: _, ...sanitizedAdmin } = admin;\n      res.json(sanitizedAdmin);\n    } catch (error) {\n      console.error(\"Error updating admin:\", error);\n      res.status(500).json({ message: \"Failed to update admin\" });\n    }\n  });\n\n  // Delete admin user\n  app.delete(\"/api/admin/team/:id\", isAdminAuthenticated, async (req: any, res) => {\n    try {\n      // Prevent self-deletion\n      if (req.params.id === req.session.adminUser.id) {\n        return res.status(400).json({ message: \"Cannot delete your own account\" });\n      }\n\n      await storage.deleteAdmin(req.params.id);\n      res.json({ message: \"Admin deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting admin:\", error);\n      res.status(500).json({ message: \"Failed to delete admin\" });\n    }\n  });\n\n  // ==================== FIXFLO INTEGRATION ROUTES ====================\n\n  // Get Fixflo configuration for current organization\n  app.get(\"/api/fixflo/config\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n      \n      const config = await storage.getFixfloConfig(user.organizationId);\n      if (!config) {\n        return res.status(404).json({ message: \"Fixflo not configured for this organization\" });\n      }\n\n      // Don't send the bearer token to the frontend\n      const { bearerToken: _, ...safeConfig } = config;\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error fetching Fixflo config:\", error);\n      res.status(500).json({ message: \"Failed to fetch Fixflo configuration\" });\n    }\n  });\n\n  // Update Fixflo configuration\n  app.post(\"/api/fixflo/config\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const { baseUrl, bearerToken, webhookVerifyToken, isEnabled } = req.body;\n      \n      if (!baseUrl || !bearerToken) {\n        return res.status(400).json({ message: \"Base URL and Bearer Token are required\" });\n      }\n\n      const config = await storage.upsertFixfloConfig({\n        organizationId: user.organizationId,\n        baseUrl,\n        bearerToken,\n        webhookVerifyToken,\n        isEnabled: isEnabled ?? false,\n      });\n\n      // Don't send the bearer token back\n      const { bearerToken: _, ...safeConfig } = config;\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error updating Fixflo config:\", error);\n      res.status(500).json({ message: \"Failed to update Fixflo configuration\" });\n    }\n  });\n\n  // Health check Fixflo API connection\n  app.post(\"/api/fixflo/health-check\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const config = await storage.getFixfloConfig(user.organizationId);\n      if (!config) {\n        return res.status(404).json({ message: \"Fixflo not configured\" });\n      }\n\n      const { createFixfloClient, FixfloClientError } = await import(\"./services/fixflo-client\");\n      const client = await createFixfloClient(config);\n      const isHealthy = await client.healthCheck();\n\n      await storage.updateFixfloHealthCheck(user.organizationId, {\n        lastHealthCheck: new Date(),\n        healthCheckStatus: isHealthy ? \"healthy\" : \"error\",\n        lastError: isHealthy ? null : \"Health check failed\",\n      });\n\n      res.json({ healthy: isHealthy });\n    } catch (error: any) {\n      console.error(\"Error performing Fixflo health check:\", error);\n      \n      const user = await storage.getUser(req.user.id);\n      if (user?.organizationId) {\n        await storage.updateFixfloHealthCheck(user.organizationId, {\n          lastHealthCheck: new Date(),\n          healthCheckStatus: \"error\",\n          lastError: error.message || \"Unknown error\",\n        });\n      }\n\n      res.status(500).json({ \n        healthy: false, \n        message: error.message || \"Health check failed\" \n      });\n    }\n  });\n\n  // Create issue in Fixflo from maintenance request\n  app.post(\"/api/fixflo/issues\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const { maintenanceRequestId, propertyId, title, description, priority, category } = req.body;\n\n      if (!maintenanceRequestId || !propertyId) {\n        return res.status(400).json({ message: \"Maintenance request ID and property ID are required\" });\n      }\n\n      // Get Fixflo config\n      const config = await storage.getFixfloConfig(user.organizationId);\n      if (!config?.isEnabled) {\n        return res.status(400).json({ message: \"Fixflo integration is not enabled\" });\n      }\n\n      // Get property to check for Fixflo property ID\n      const property = await storage.getProperty(propertyId);\n      if (!property || property.organizationId !== user.organizationId) {\n        return res.status(404).json({ message: \"Property not found\" });\n      }\n\n      if (!property.fixfloPropertyId) {\n        return res.status(400).json({ \n          message: \"Property is not mapped to Fixflo. Please configure property mapping first.\" \n        });\n      }\n\n      // Create issue in Fixflo\n      const { createFixfloClient } = await import(\"./services/fixflo-client\");\n      const client = await createFixfloClient(config);\n      \n      const fixfloResponse = await client.createIssue({\n        propertyId: property.fixfloPropertyId,\n        title,\n        description,\n        priority: priority || \"medium\",\n        category,\n        externalRef: maintenanceRequestId,\n      });\n\n      // Update maintenance request with Fixflo IDs\n      await storage.updateMaintenanceRequest(maintenanceRequestId, {\n        fixfloIssueId: fixfloResponse.id,\n        fixfloJobId: fixfloResponse.jobId,\n        fixfloStatus: fixfloResponse.status,\n        fixfloSyncedAt: new Date(),\n      });\n\n      res.json({\n        success: true,\n        fixfloIssueId: fixfloResponse.id,\n        fixfloJobId: fixfloResponse.jobId,\n        status: fixfloResponse.status,\n      });\n    } catch (error: any) {\n      console.error(\"Error creating Fixflo issue:\", error);\n      res.status(500).json({ \n        message: \"Failed to create issue in Fixflo\",\n        error: error.message \n      });\n    }\n  });\n\n  // Update issue in Fixflo\n  app.patch(\"/api/fixflo/issues/:issueId\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const { issueId } = req.params;\n      const { priority, status, assignedAgentId, notes } = req.body;\n\n      // Get Fixflo config\n      const config = await storage.getFixfloConfig(user.organizationId);\n      if (!config?.isEnabled) {\n        return res.status(400).json({ message: \"Fixflo integration is not enabled\" });\n      }\n\n      // Update issue in Fixflo\n      const { createFixfloClient } = await import(\"./services/fixflo-client\");\n      const client = await createFixfloClient(config);\n      \n      const fixfloResponse = await client.updateIssue(issueId, {\n        priority,\n        status,\n        notes,\n      });\n\n      // If contractor was assigned, do that separately\n      if (assignedAgentId) {\n        await client.assignContractor(issueId, assignedAgentId);\n      }\n\n      res.json({\n        success: true,\n        status: fixfloResponse.status,\n      });\n    } catch (error: any) {\n      console.error(\"Error updating Fixflo issue:\", error);\n      res.status(500).json({ \n        message: \"Failed to update issue in Fixflo\",\n        error: error.message \n      });\n    }\n  });\n\n  // Get Fixflo sync state for organization\n  app.get(\"/api/fixflo/sync-state\", isAuthenticated, requireRole(\"owner\", \"clerk\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const syncStates = await storage.getFixfloSyncStates(user.organizationId);\n      res.json(syncStates);\n    } catch (error) {\n      console.error(\"Error fetching Fixflo sync state:\", error);\n      res.status(500).json({ message: \"Failed to fetch sync state\" });\n    }\n  });\n\n  // Get Fixflo webhook logs for debugging\n  app.get(\"/api/fixflo/webhook-logs\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(403).json({ message: \"User not in organization\" });\n      }\n\n      const limit = parseInt(req.query.limit as string) || 50;\n      const logs = await storage.getFixfloWebhookLogs(user.organizationId, limit);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching Fixflo webhook logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch webhook logs\" });\n    }\n  });\n\n  // Inbound webhook endpoint from Fixflo\n  app.post(\"/api/integrations/fixflo/webhook\", async (req, res) => {\n    const { processFixfloWebhook } = await import(\"./services/fixflo-webhook-processor\");\n    \n    try {\n      // Get the organization ID from webhook payload or headers\n      const organizationId = req.body.organizationId || req.headers[\"x-organization-id\"];\n      \n      if (!organizationId) {\n        console.error(\"[Fixflo Webhook] No organization ID provided\");\n        return res.status(400).json({ message: \"Organization ID required\" });\n      }\n\n      // Get Fixflo config to verify webhook token\n      const config = await storage.getFixfloConfig(organizationId as string);\n      if (!config) {\n        console.error(\"[Fixflo Webhook] No config found for organization:\", organizationId);\n        return res.status(404).json({ message: \"Fixflo not configured for this organization\" });\n      }\n\n      // Verify webhook token if configured\n      const webhookToken = req.headers[\"x-fixflo-webhook-token\"];\n      if (config.webhookVerifyToken && webhookToken !== config.webhookVerifyToken) {\n        console.error(\"[Fixflo Webhook] Invalid webhook token\");\n        return res.status(403).json({ message: \"Invalid webhook token\" });\n      }\n\n      const payload = req.body;\n      const eventType = payload.eventType || payload.event || \"Unknown\";\n      \n      // Create webhook log for audit trail\n      const webhookLog = await storage.createFixfloWebhookLog({\n        organizationId: organizationId as string,\n        eventType,\n        fixfloIssueId: payload.issueId || payload.Issue?.Id,\n        fixfloJobId: payload.jobId || payload.Job?.Id,\n        payloadJson: payload,\n        processingStatus: \"pending\",\n        retryCount: 0,\n      });\n\n      // Return 200 immediately to acknowledge receipt\n      res.status(200).json({ received: true, webhookLogId: webhookLog.id });\n\n      // Process webhook asynchronously\n      processFixfloWebhook(webhookLog.id, organizationId as string, payload, storage)\n        .catch((error: any) => {\n          console.error(\"[Fixflo Webhook] Processing error:\", error);\n        });\n\n    } catch (error: any) {\n      console.error(\"[Fixflo Webhook] Error receiving webhook:\", error);\n      res.status(500).json({ \n        message: \"Failed to process webhook\",\n        error: error.message \n      });\n    }\n  });\n\n  // ==================== SUBSCRIPTION & BILLING ROUTES ====================\n  \n  const { subscriptionService } = await import(\"./subscriptionService\");\n\n  // Get all active subscription plans\n  app.get(\"/api/billing/plans\", async (req, res) => {\n    try {\n      const plans = await storage.getActivePlans();\n      res.json(plans);\n    } catch (error: any) {\n      console.error(\"Error fetching plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch plans\" });\n    }\n  });\n\n  // Get pricing for a specific plan and country\n  app.get(\"/api/billing/plans/:planId/pricing\", async (req, res) => {\n    try {\n      const { planId } = req.params;\n      const countryCode = (req.query.country as string) || \"GB\";\n      \n      const pricing = await subscriptionService.getEffectivePricing(planId, countryCode);\n      res.json(pricing);\n    } catch (error: any) {\n      console.error(\"Error fetching pricing:\", error);\n      res.status(500).json({ message: \"Failed to fetch pricing\", error: error.message });\n    }\n  });\n\n  // Create Stripe checkout session for subscription\n  app.post(\"/api/billing/checkout\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const { planCode, billingPeriod } = req.body;\n      if (!planCode) {\n        return res.status(400).json({ message: \"Plan code is required\" });\n      }\n\n      const org = await storage.getOrganization(user.organizationId);\n      if (!org) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n\n      // Get plan\n      const plan = await storage.getPlanByCode(planCode);\n      if (!plan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n\n      // Determine billing interval and price\n      const isAnnual = billingPeriod === \"annual\";\n      const interval = isAnnual ? \"year\" : \"month\";\n      \n      // Get effective pricing based on organization's country\n      const pricing = await subscriptionService.getEffectivePricing(\n        plan.id,\n        org.countryCode || \"GB\"\n      );\n\n      // Use annual price if available and annual billing is selected, otherwise use monthly\n      let unitAmount = pricing.monthlyPrice;\n      if (isAnnual && plan.annualPriceGbp) {\n        // Convert annual price to minor units (it's already in pence)\n        unitAmount = plan.annualPriceGbp;\n      } else if (isAnnual && !plan.annualPriceGbp) {\n        // Fallback: calculate annual from monthly if no annual price set\n        unitAmount = pricing.monthlyPrice * 12;\n      }\n\n      // Create or get Stripe customer\n      let stripeCustomerId = org.stripeCustomerId;\n      if (!stripeCustomerId) {\n        const stripe = await getUncachableStripeClient();\n        const customer = await stripe.customers.create({\n          email: user.email,\n          name: org.name,\n          metadata: {\n            organizationId: org.id,\n            countryCode: org.countryCode || \"GB\",\n          },\n        });\n        stripeCustomerId = customer.id;\n        await storage.updateOrganizationStripe(org.id, stripeCustomerId, \"inactive\");\n      }\n\n      // Create checkout session\n      const baseUrl = getBaseUrl(req);\n      \n      const successUrl = `${baseUrl}/billing?success=true&session_id={CHECKOUT_SESSION_ID}`;\n      const cancelUrl = `${baseUrl}/billing?canceled=true`;\n      \n      console.log(`[Subscription Checkout] Creating session with:`, {\n        successUrl,\n        cancelUrl,\n        planCode,\n        billingPeriod: interval,\n        unitAmount,\n        organizationId: org.id\n      });\n      \n      const stripe = await getUncachableStripeClient();\n      const session = await stripe.checkout.sessions.create({\n        customer: stripeCustomerId,\n        mode: \"subscription\",\n        line_items: [\n          {\n            price_data: {\n              currency: pricing.currency.toLowerCase(),\n              product_data: {\n                name: plan.name,\n                description: `${pricing.includedCredits} inspection credits per month`,\n              },\n              recurring: {\n                interval: interval as \"month\" | \"year\",\n              },\n              unit_amount: unitAmount,\n            },\n            quantity: 1,\n          },\n        ],\n        success_url: successUrl,\n        cancel_url: cancelUrl,\n        metadata: {\n          organizationId: org.id,\n          planId: plan.id,\n          planCode: plan.code,\n          includedCredits: pricing.includedCredits.toString(),\n          billingPeriod: interval,\n        },\n      });\n\n      console.log(`[Subscription Checkout] Session created:`, {\n        sessionId: session.id,\n        checkoutUrl: session.url\n      });\n\n      res.json({ url: session.url });\n    } catch (error: any) {\n      console.error(\"Error creating checkout session:\", error);\n      const errorMessage = error.message || \"Unknown error\";\n      const errorDetails = error.type ? `Stripe ${error.type}: ${errorMessage}` : errorMessage;\n      res.status(500).json({ \n        message: \"Failed to create checkout session\", \n        error: errorDetails,\n        details: process.env.NODE_ENV === \"development\" ? error.stack : undefined\n      });\n    }\n  });\n\n  // Create Stripe customer portal session\n  app.post(\"/api/billing/portal\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const org = await storage.getOrganization(user.organizationId);\n      if (!org?.stripeCustomerId) {\n        return res.status(400).json({ message: \"No active Stripe customer\" });\n      }\n\n      const baseUrl = getBaseUrl(req);\n      \n      const stripe = await getUncachableStripeClient();\n      const session = await stripe.billingPortal.sessions.create({\n        customer: org.stripeCustomerId,\n        return_url: `${baseUrl}/billing`,\n      });\n\n      res.json({ url: session.url });\n    } catch (error: any) {\n      console.error(\"Error creating portal session:\", error);\n      res.status(500).json({ message: \"Failed to create portal session\", error: error.message });\n    }\n  });\n\n  // Process completed checkout session (fallback for when webhooks don't fire)\n  app.post(\"/api/billing/process-session\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const { sessionId } = req.body;\n      if (!sessionId) {\n        return res.status(400).json({ message: \"Session ID is required\" });\n      }\n\n      console.log(`[Process Session] Retrieving session ${sessionId} for org ${user.organizationId}`);\n\n      // Retrieve the session from Stripe\n      const stripe = await getUncachableStripeClient();\n      const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n      // Check if we're in test mode (test keys start with sk_test_)\n      const secretKey = await getStripeSecretKey();\n      const isTestMode = secretKey.startsWith('sk_test_');\n\n      console.log(`[Process Session] Test mode: ${isTestMode}, Payment status: ${session.payment_status}, Subscription: ${session.subscription || 'none'}`);\n\n      // Verify the session belongs to this organization\n      if (session.metadata?.organizationId !== user.organizationId) {\n        console.error(`[Process Session] SECURITY: Session org mismatch - Session org: ${session.metadata?.organizationId}, User org: ${user.organizationId}`);\n        return res.status(403).json({ message: \"Session does not belong to your organization\" });\n      }\n\n      // In test mode, allow processing even if payment_status isn't \"paid\"\n      // In production, require payment_status to be \"paid\"\n      if (!isTestMode && session.payment_status !== \"paid\") {\n        console.log(`[Process Session] Payment not completed (non-test mode). Status: ${session.payment_status}`);\n        return res.status(400).json({ message: \"Payment not completed\", status: session.payment_status });\n      }\n\n      if (isTestMode && session.payment_status !== \"paid\") {\n        console.log(`[Process Session] TEST MODE: Processing despite payment_status: ${session.payment_status}`);\n      }\n\n      const { organizationId, planId, includedCredits, topupOrderId, packSize, billingPeriod } = session.metadata || {};\n\n      // CRITICAL SECURITY CHECK: Double-verify the organizationId in metadata matches the user's org\n      if (organizationId !== user.organizationId) {\n        console.error(`[Process Session] SECURITY: Metadata org mismatch - Metadata org: ${organizationId}, User org: ${user.organizationId}`);\n        return res.status(403).json({ message: \"Session metadata does not match your organization\" });\n      }\n\n      console.log(`[Process Session] Processing session:`, {\n        sessionId,\n        mode: session.mode,\n        topupOrderId,\n        planId,\n        includedCredits,\n        packSize,\n        billingPeriod,\n        verifiedOrganizationId: organizationId,\n        metadata: session.metadata\n      });\n\n      // Validate metadata\n      if (!planId && !topupOrderId) {\n        console.error(`[Process Session] Missing required metadata: planId=${planId}, topupOrderId=${topupOrderId}`);\n        return res.status(400).json({ message: \"Session metadata is incomplete. Missing planId or topupOrderId.\" });\n      }\n\n      // Check if this is a top-up payment (one-time) vs subscription\n      if (topupOrderId && packSize) {\n        // Check if already processed\n        const existingOrder = await storage.getTopupOrder(topupOrderId);\n        if (existingOrder && existingOrder.status === \"paid\") {\n          console.log(`[Process Session] Top-up already processed: ${topupOrderId}`);\n          return res.json({ message: \"Already processed\", processed: true });\n        }\n\n        // CRITICAL SECURITY CHECK: Verify the top-up order belongs to this organization\n        if (existingOrder && existingOrder.organizationId !== user.organizationId) {\n          console.error(`[Process Session] SECURITY: Top-up order org mismatch - Order org: ${existingOrder.organizationId}, User org: ${user.organizationId}`);\n          return res.status(403).json({ message: \"Top-up order does not belong to your organization\" });\n        }\n\n        if (!existingOrder) {\n          console.error(`[Process Session] Top-up order not found: ${topupOrderId}`);\n          return res.status(404).json({ message: \"Top-up order not found\" });\n        }\n\n        // Handle top-up payment\n        console.log(`[Process Session] Processing top-up of ${packSize} credits for verified org ${user.organizationId}`);\n        \n        await storage.updateTopupOrder(topupOrderId, {\n          status: \"paid\" as any,\n        });\n\n        // Grant credits to the VERIFIED organization (user.organizationId) not the metadata\n        const { subscriptionService: subService } = await import(\"./subscriptionService\");\n        await subService.grantCredits(\n          user.organizationId,\n          parseInt(packSize),\n          \"topup\",\n          undefined,\n          { topupOrderId, adminNotes: `Stripe session: ${sessionId}`, createdBy: user.id }\n        );\n\n        console.log(`[Process Session] Granted ${packSize} credits to verified org ${user.organizationId}`);\n        return res.json({ message: \"Credits granted successfully\", processed: true });\n      } \n      \n      // Handle subscription payment\n      if (planId) {\n        try {\n          // Check if subscription already exists by organization (prevent duplicates)\n          const existingOrgSubscription = await storage.getSubscriptionByOrganization(user.organizationId);\n          if (existingOrgSubscription) {\n            console.log(`[Process Session] Organization already has subscription, skipping duplicate`);\n            return res.json({ message: \"Organization already has active subscription\", processed: true, alreadyProcessed: true });\n          }\n\n          // Handle subscription ID - might not exist in test mode\n          let subscriptionId = session.subscription as string | null;\n          let subscription: any = null;\n\n          if (subscriptionId) {\n            // Check if subscription already exists by Stripe subscription ID\n            const existingSubscription = await storage.getSubscriptionByStripeId(subscriptionId);\n            if (existingSubscription) {\n              console.log(`[Process Session] Subscription already exists: ${subscriptionId}`);\n              return res.json({ message: \"Subscription already activated\", processed: true, alreadyProcessed: true });\n            }\n\n            // Try to retrieve subscription from Stripe\n            try {\n              subscription = await stripe.subscriptions.retrieve(subscriptionId);\n              console.log(`[Process Session] Retrieved subscription from Stripe: ${subscriptionId}`);\n            } catch (error: any) {\n              console.warn(`[Process Session] Could not retrieve subscription ${subscriptionId}: ${error.message}`);\n              if (!isTestMode) {\n                throw new Error(`Failed to retrieve subscription: ${error.message}`);\n              }\n              // In test mode, continue without subscription object\n              console.log(`[Process Session] TEST MODE: Continuing without Stripe subscription object`);\n            }\n          } else if (isTestMode) {\n            // In test mode, create a mock subscription ID if none exists\n            subscriptionId = `sub_test_${Date.now()}_${user.organizationId}`;\n            console.log(`[Process Session] TEST MODE: Using mock subscription ID: ${subscriptionId}`);\n          } else {\n            return res.status(400).json({ message: \"No subscription found in session\" });\n          }\n\n          console.log(`[Process Session] Creating subscription from session for verified org ${user.organizationId}${isTestMode ? \" (TEST MODE)\" : \"\"}`);\n\n          // Update organization with Stripe customer ID (use VERIFIED org)\n          if (session.customer) {\n            try {\n              await storage.updateOrganizationStripe(user.organizationId, session.customer as string, \"active\");\n            } catch (error: any) {\n              console.warn(`[Process Session] Could not update organization Stripe: ${error.message}`);\n            }\n          }\n          \n          // Get plan details\n          const plan = await storage.getPlan(planId);\n          if (!plan) {\n            throw new Error(`Plan not found: ${planId}`);\n          }\n\n          // Get organization for pricing\n          const org = await storage.getOrganization(user.organizationId);\n          let pricing: any = null;\n          if (org) {\n            try {\n              const { subscriptionService: subService } = await import(\"./subscriptionService\");\n              pricing = await subService.getEffectivePricing(plan.id, org.countryCode || \"GB\");\n            } catch (error: any) {\n              console.warn(`[Process Session] Could not get pricing: ${error.message}, using plan defaults`);\n            }\n          }\n\n          // Calculate period dates\n          const now = new Date();\n          const interval = billingPeriod || \"month\";\n          \n          // Helper function to safely create Date from Stripe timestamp\n          const safeDateFromTimestamp = (timestamp: any, fallback: Date): Date => {\n            if (!timestamp || typeof timestamp !== 'number' || isNaN(timestamp)) {\n              return fallback;\n            }\n            const date = new Date(timestamp * 1000);\n            return isNaN(date.getTime()) ? fallback : date;\n          };\n          \n          const periodStart = subscription \n            ? safeDateFromTimestamp((subscription as any).current_period_start, now)\n            : now;\n          const periodEnd = subscription\n            ? safeDateFromTimestamp((subscription as any).current_period_end, \n                new Date(now.getTime() + (interval === \"year\" ? 365 : 30) * 24 * 60 * 60 * 1000))\n            : new Date(now.getTime() + (interval === \"year\" ? 365 : 30) * 24 * 60 * 60 * 1000);\n          const billingCycleAnchor = subscription\n            ? safeDateFromTimestamp((subscription as any).billing_cycle_anchor, now)\n            : now;\n\n          // Get price from subscription or plan\n          const monthlyPrice = subscription?.items?.data?.[0]?.price?.unit_amount \n            || (pricing?.monthlyPrice) \n            || plan.monthlyPriceGbp;\n\n          // Validate includedCredits\n          const creditsToGrant = parseInt(includedCredits || \"0\");\n          if (!creditsToGrant || isNaN(creditsToGrant)) {\n            throw new Error(`Invalid includedCredits: ${includedCredits}`);\n          }\n\n          // Create subscription record (use VERIFIED org)\n          console.log(`[Process Session] Creating subscription with data:`, {\n            organizationId: user.organizationId,\n            planId: plan.id,\n            planCode: plan.code,\n            planName: plan.name,\n            monthlyPrice: monthlyPrice,\n            includedCredits: creditsToGrant,\n            stripeSubscriptionId: subscriptionId,\n            status: (subscription?.status || \"active\")\n          });\n          \n          const createdSubscription = await storage.createSubscription({\n            organizationId: user.organizationId,\n            planSnapshotJson: {\n              planId: plan.id,\n              planCode: plan.code,\n              planName: plan.name,\n              monthlyPrice: monthlyPrice,\n              includedCredits: creditsToGrant,\n              currency: (subscription?.currency || pricing?.currency || \"GBP\").toUpperCase(),\n            },\n            stripeSubscriptionId: subscriptionId,\n            billingCycleAnchor: billingCycleAnchor,\n            currentPeriodStart: periodStart,\n            currentPeriodEnd: periodEnd,\n            status: (subscription?.status || \"active\") as any,\n            cancelAtPeriodEnd: subscription?.cancel_at_period_end || false,\n          });\n\n          console.log(`[Process Session] Subscription created successfully:`, {\n            id: createdSubscription.id,\n            organizationId: createdSubscription.organizationId,\n            planName: createdSubscription.planSnapshotJson?.planName,\n            status: createdSubscription.status\n          });\n\n          // Small delay to ensure database transaction is committed\n          await new Promise(resolve => setTimeout(resolve, 100));\n\n          // Verify subscription was saved by fetching it back\n          const verifySubscription = await storage.getSubscriptionByOrganization(user.organizationId);\n          if (!verifySubscription) {\n            console.error(`[Process Session] ERROR: Subscription was created but cannot be retrieved!`);\n            console.error(`[Process Session] Created subscription ID: ${createdSubscription.id}`);\n            console.error(`[Process Session] Organization ID: ${user.organizationId}`);\n            throw new Error(\"Subscription was created but cannot be retrieved\");\n          }\n          console.log(`[Process Session] Verified subscription exists in database:`, {\n            id: verifySubscription.id,\n            organizationId: verifySubscription.organizationId,\n            planName: verifySubscription.planSnapshotJson?.planName,\n            status: verifySubscription.status\n          });\n\n          // Grant initial credits (use VERIFIED org)\n          try {\n            const { subscriptionService: subService } = await import(\"./subscriptionService\");\n            await subService.grantCredits(\n              user.organizationId,\n              creditsToGrant,\n              \"plan_inclusion\",\n              periodEnd,\n              { subscriptionId: subscriptionId, createdBy: user.id, adminNotes: isTestMode ? \"TEST MODE - No payment charged\" : undefined }\n            );\n            console.log(`[Process Session] Granted ${creditsToGrant} credits successfully`);\n          } catch (creditError: any) {\n            console.error(`[Process Session] Error granting credits:`, creditError);\n            // Don't fail the whole request if credits fail - subscription is already created\n            console.warn(`[Process Session] Continuing despite credit grant error`);\n          }\n\n          console.log(`[Process Session] Created subscription and granted ${creditsToGrant} credits to verified org ${user.organizationId}${isTestMode ? \" (TEST MODE)\" : \"\"}`);\n          return res.json({ message: \"Subscription activated successfully\", processed: true });\n        } catch (subscriptionError: any) {\n          console.error(`[Process Session] Error in subscription processing:`, subscriptionError);\n          console.error(`[Process Session] Subscription error stack:`, subscriptionError.stack);\n          throw subscriptionError; // Re-throw to be caught by outer catch\n        }\n      }\n\n      res.json({ message: \"Session processed\", processed: false });\n    } catch (error: any) {\n      console.error(\"[Process Session] Error processing session:\", error);\n      console.error(\"[Process Session] Error stack:\", error.stack);\n      console.error(\"[Process Session] Error details:\", {\n        message: error.message,\n        type: error.type,\n        code: error.code,\n        statusCode: error.statusCode\n      });\n      res.status(500).json({ \n        message: \"Failed to process session\", \n        error: error.message,\n        details: process.env.NODE_ENV === \"development\" ? error.stack : undefined\n      });\n    }\n  });\n\n  // Stripe webhook handler\n  app.post(\"/api/billing/webhook\", async (req, res) => {\n    const sig = req.headers[\"stripe-signature\"] as string;\n    \n    let event: any;\n    try {\n      // In production, verify the webhook signature\n      // For now, we'll accept the event as-is\n      event = req.body;\n\n      console.log(`[Stripe Webhook] Received event: ${event.type}`);\n\n      switch (event.type) {\n        case \"checkout.session.completed\": {\n          const session = event.data.object;\n          const { organizationId, planId, includedCredits, topupOrderId, packSize } = session.metadata;\n\n          console.log(`[Stripe Webhook] Checkout completed:`, {\n            organizationId,\n            planId,\n            topupOrderId,\n            packSize,\n            sessionId: session.id,\n            mode: session.mode\n          });\n\n          // CRITICAL SECURITY CHECK: Verify organization exists\n          const org = await storage.getOrganization(organizationId);\n          if (!org) {\n            console.error(`[Stripe Webhook] SECURITY: Organization not found: ${organizationId}`);\n            break;\n          }\n\n          // Check if this is a top-up payment (one-time) vs subscription\n          if (topupOrderId && packSize) {\n            // CRITICAL SECURITY CHECK: Verify top-up order belongs to this organization\n            const topupOrder = await storage.getTopupOrder(topupOrderId);\n            if (!topupOrder) {\n              console.error(`[Stripe Webhook] SECURITY: Top-up order not found: ${topupOrderId}`);\n              break;\n            }\n            if (topupOrder.organizationId !== organizationId) {\n              console.error(`[Stripe Webhook] SECURITY: Top-up order org mismatch - Order org: ${topupOrder.organizationId}, Session org: ${organizationId}`);\n              break;\n            }\n\n            // Check if already processed\n            if (topupOrder.status === \"paid\") {\n              console.log(`[Stripe Webhook] Top-up already processed: ${topupOrderId}`);\n              break;\n            }\n\n            // Handle top-up payment\n            console.log(`[Stripe Webhook] Processing top-up of ${packSize} credits for verified org: ${organizationId}`);\n            \n            // Update top-up order status\n            await storage.updateTopupOrder(topupOrderId, {\n              status: \"paid\" as any,\n            });\n\n            // Grant credits to VERIFIED organization\n            await subscriptionService.grantCredits(\n              organizationId,\n              parseInt(packSize),\n              \"topup\",\n              undefined,\n              { topupOrderId, adminNotes: `Stripe webhook session: ${session.id}` }\n            );\n\n            console.log(`[Stripe Webhook] Granted ${packSize} credits to verified org ${organizationId} via top-up`);\n            break;\n          }\n\n          // Handle subscription payment\n          if (session.subscription && planId) {\n            // CRITICAL SECURITY CHECK: Verify customer matches organization\n            if (session.customer !== org.stripeCustomerId) {\n              console.error(`[Stripe Webhook] SECURITY: Customer mismatch - Session customer: ${session.customer}, Org customer: ${org.stripeCustomerId}`);\n              // Update org with new customer ID if it's empty\n              if (!org.stripeCustomerId) {\n                console.log(`[Stripe Webhook] Updating org ${organizationId} with customer ${session.customer}`);\n                await storage.updateOrganizationStripe(organizationId, session.customer, \"active\");\n              } else {\n                break; // Reject if customer mismatch and org already has a customer\n              }\n            }\n\n            // Check if subscription already exists\n            const existingSubscription = await storage.getSubscriptionByStripeId(session.subscription);\n            if (existingSubscription) {\n              console.log(`[Stripe Webhook] Subscription already exists: ${session.subscription}`);\n              break;\n            }\n\n            const stripe = await getUncachableStripeClient();\n            const subscription = await stripe.subscriptions.retrieve(session.subscription);\n            const plan = await storage.getPlan(planId);\n            \n            if (plan) {\n              console.log(`[Stripe Webhook] Creating subscription for verified org ${organizationId}`);\n\n              // Helper function to safely create Date from Stripe timestamp\n              const safeDateFromTimestamp = (timestamp: any, fallback: Date): Date => {\n                if (!timestamp || typeof timestamp !== 'number' || isNaN(timestamp)) {\n                  return fallback;\n                }\n                const date = new Date(timestamp * 1000);\n                return isNaN(date.getTime()) ? fallback : date;\n              };\n              \n              const now = new Date();\n              const defaultPeriodEnd = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days default\n              \n              await storage.createSubscription({\n                organizationId,\n                planSnapshotJson: {\n                  planId: plan.id,\n                  planCode: plan.code,\n                  planName: plan.name,\n                  monthlyPrice: plan.monthlyPriceGbp,\n                  includedCredits: parseInt(includedCredits),\n                  currency: (subscription as any).currency.toUpperCase(),\n                },\n                stripeSubscriptionId: (subscription as any).id,\n                billingCycleAnchor: safeDateFromTimestamp((subscription as any).billing_cycle_anchor, now),\n                currentPeriodStart: safeDateFromTimestamp((subscription as any).current_period_start, now),\n                currentPeriodEnd: safeDateFromTimestamp((subscription as any).current_period_end, defaultPeriodEnd),\n                status: (subscription as any).status as any,\n                cancelAtPeriodEnd: (subscription as any).cancel_at_period_end || false,\n              });\n\n              // Grant initial credits to VERIFIED organization\n              await subscriptionService.grantCredits(\n                organizationId,\n                parseInt(includedCredits),\n                \"plan_inclusion\",\n                new Date((subscription as any).current_period_end * 1000),\n                { subscriptionId: (subscription as any).id }\n              );\n\n              console.log(`[Stripe Webhook] Granted ${includedCredits} credits to verified org ${organizationId}`);\n            }\n          }\n          break;\n        }\n\n        case \"invoice.paid\": {\n          const invoice = event.data.object;\n          \n          if (invoice.subscription) {\n            const stripe = await getUncachableStripeClient();\n            const subscription = await stripe.subscriptions.retrieve(invoice.subscription);\n            const dbSubscription = await storage.getSubscriptionByStripeId(subscription.id);\n\n            if (dbSubscription) {\n              // Helper function to safely create Date from Stripe timestamp\n              const safeDateFromTimestamp = (timestamp: any, fallback: Date): Date => {\n                if (!timestamp || typeof timestamp !== 'number' || isNaN(timestamp)) {\n                  return fallback;\n                }\n                const date = new Date(timestamp * 1000);\n                return isNaN(date.getTime()) ? fallback : date;\n              };\n              \n              const now = new Date();\n              const defaultPeriodEnd = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days default\n              \n              // Update subscription period\n              await storage.updateSubscription(dbSubscription.id, {\n                currentPeriodStart: safeDateFromTimestamp((subscription as any).current_period_start, dbSubscription.currentPeriodStart || now),\n                currentPeriodEnd: safeDateFromTimestamp((subscription as any).current_period_end, dbSubscription.currentPeriodEnd || defaultPeriodEnd),\n                status: (subscription as any).status as any,\n              });\n\n              // Process rollover and grant new cycle credits\n              await subscriptionService.processRollover(\n                dbSubscription.organizationId,\n                new Date((subscription as any).current_period_end * 1000)\n              );\n\n              // Grant new cycle credits\n              await subscriptionService.grantCredits(\n                dbSubscription.organizationId,\n                dbSubscription.planSnapshotJson.includedCredits,\n                \"plan_inclusion\",\n                new Date((subscription as any).current_period_end * 1000),\n                { subscriptionId: (subscription as any).id }\n              );\n\n              console.log(`[Stripe Webhook] New billing cycle for org ${dbSubscription.organizationId}`);\n            }\n          }\n          break;\n        }\n\n        case \"invoice.payment_failed\": {\n          const invoice = event.data.object;\n          \n          if (invoice.subscription) {\n            const stripe = await getUncachableStripeClient();\n            const subscription = await stripe.subscriptions.retrieve(invoice.subscription);\n            const dbSubscription = await storage.getSubscriptionByStripeId(subscription.id);\n\n            if (dbSubscription) {\n              await storage.updateSubscription(dbSubscription.id, {\n                status: \"inactive\" as any,\n              });\n              \n              console.log(`[Stripe Webhook] Payment failed for org ${dbSubscription.organizationId}`);\n            }\n          }\n          break;\n        }\n\n        case \"customer.subscription.deleted\": {\n          const subscription = event.data.object;\n          const dbSubscription = await storage.getSubscriptionByStripeId(subscription.id);\n\n          if (dbSubscription) {\n            await storage.cancelSubscription(dbSubscription.id);\n            console.log(`[Stripe Webhook] Subscription canceled for org ${dbSubscription.organizationId}`);\n          }\n          break;\n        }\n      }\n\n      res.json({ received: true });\n    } catch (error: any) {\n      console.error(`[Stripe Webhook] Error processing webhook:`, error);\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Get credit balance\n  app.get(\"/api/credits/balance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const balance = await storage.getCreditBalance(user.organizationId);\n      \n      // Get ledger to calculate consumed credits\n      const ledger = await storage.getCreditLedgerByOrganization(user.organizationId, 10000);\n      \n      let consumed = 0;\n      let expired = 0;\n      \n      for (const entry of ledger) {\n        if (entry.quantity < 0) {\n          // Negative quantities are consumption\n          consumed += Math.abs(entry.quantity);\n        }\n      }\n      \n      // Get expired batches\n      const expiredBatches = await db\n        .select()\n        .from(creditBatches)\n        .where(\n          and(\n            eq(creditBatches.organizationId, user.organizationId),\n            lt(creditBatches.expiresAt, new Date()),\n            gt(creditBatches.remainingQuantity, 0)\n          )\n        );\n      \n      for (const batch of expiredBatches) {\n        expired += batch.remainingQuantity;\n      }\n      \n      // Return in the format the frontend expects\n      res.json({\n        available: balance.total,\n        consumed,\n        expired\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching credit balance:\", error);\n      res.status(500).json({ message: \"Failed to fetch credit balance\" });\n    }\n  });\n\n  // Get credit ledger\n  app.get(\"/api/credits/ledger\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const limit = parseInt(req.query.limit as string) || 100;\n      const ledger = await storage.getCreditLedgerByOrganization(user.organizationId, limit);\n      res.json(ledger);\n    } catch (error: any) {\n      console.error(\"Error fetching credit ledger:\", error);\n      res.status(500).json({ message: \"Failed to fetch credit ledger\" });\n    }\n  });\n\n  // Create top-up checkout session\n  app.post(\"/api/credits/topup/checkout\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      const { packSize } = req.body;\n      if (!packSize || ![100, 250, 500, 1000].includes(packSize)) {\n        return res.status(400).json({ message: \"Invalid pack size. Must be 100, 250, 500, or 1000\" });\n      }\n\n      const org = await storage.getOrganization(user.organizationId);\n      if (!org) {\n        return res.status(404).json({ message: \"Organization not found\" });\n      }\n\n      // Get pricing based on pack size (pence per credit)\n      const pricingTiers: Record<number, number> = {\n        100: 400,   // 4.00 per credit\n        250: 300,   // 3.00 per credit\n        500: 200,   // 2.00 per credit\n        1000: 150,  // 1.50 per credit\n      };\n      const unitPrice = pricingTiers[packSize];\n      const totalPrice = packSize * unitPrice;\n      const currency = \"GBP\"; // Could be determined by country\n\n      // Create top-up order\n      const order = await storage.createTopupOrder({\n        organizationId: org.id,\n        packSize,\n        currency: currency as any,\n        unitPriceMinorUnits: unitPrice,\n        totalPriceMinorUnits: totalPrice,\n        status: \"pending\" as any,\n      });\n\n      // Create Stripe checkout session\n      const baseUrl = getBaseUrl(req);\n      \n      const stripe = await getUncachableStripeClient();\n      const session = await stripe.checkout.sessions.create({\n        customer: org.stripeCustomerId || undefined,\n        mode: \"payment\",\n        line_items: [\n          {\n            price_data: {\n              currency: currency.toLowerCase(),\n              product_data: {\n                name: `${packSize} Inspection Credits`,\n                description: \"Credit top-up for inspections\",\n              },\n              unit_amount: totalPrice,\n            },\n            quantity: 1,\n          },\n        ],\n        success_url: `${baseUrl}/billing?topup_success=true&session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: `${baseUrl}/billing?topup_canceled=true`,\n        metadata: {\n          organizationId: org.id,\n          topupOrderId: order.id,\n          packSize: packSize.toString(),\n        },\n      });\n\n      // Update order with payment intent\n      await storage.updateTopupOrder(order.id, {\n        stripePaymentIntentId: session.payment_intent as string,\n      });\n\n      res.json({ url: session.url, orderId: order.id });\n    } catch (error: any) {\n      console.error(\"Error creating topup checkout:\", error);\n      res.status(500).json({ message: \"Failed to create topup checkout\", error: error.message });\n    }\n  });\n\n  // Admin: Grant credits\n  app.post(\"/api/admin/credits/grant\", isAuthenticated, requireRole(\"owner\"), async (req: any, res) => {\n    try {\n      const { organizationId, quantity, reason } = req.body;\n      const user = await storage.getUser(req.user.id);\n      \n      if (!organizationId || !quantity || quantity <= 0) {\n        return res.status(400).json({ message: \"Invalid request\" });\n      }\n\n      await subscriptionService.grantCredits(\n        organizationId,\n        quantity,\n        \"admin_grant\",\n        undefined,\n        { adminNotes: reason || \"Admin grant\", createdBy: user?.id }\n      );\n\n      res.json({ success: true, granted: quantity });\n    } catch (error: any) {\n      console.error(\"Error granting credits:\", error);\n      res.status(500).json({ message: \"Failed to grant credits\", error: error.message });\n    }\n  });\n\n  // ==================== ECO-ADMIN ROUTES (Country Pricing Configuration) ====================\n\n  // Get all country pricing overrides\n  app.get(\"/api/admin/country-pricing\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Check if user is admin\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const overrides = await storage.getAllCountryPricingOverrides();\n      res.json(overrides);\n    } catch (error: any) {\n      console.error(\"Error fetching country pricing:\", error);\n      res.status(500).json({ message: \"Failed to fetch country pricing\" });\n    }\n  });\n\n  // Create country pricing override\n  app.post(\"/api/admin/country-pricing\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Check if user is admin\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertCountryPricingOverrideSchema.parse(req.body);\n      const override = await storage.createCountryPricingOverride(validated);\n      res.json(override);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid country pricing data\", errors: error.errors });\n      }\n      console.error(\"Error creating country pricing:\", error);\n      res.status(500).json({ message: \"Failed to create country pricing\", error: error.message });\n    }\n  });\n\n  // Update country pricing override\n  app.patch(\"/api/admin/country-pricing/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Check if user is admin\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertCountryPricingOverrideSchema.partial().parse(req.body);\n      const { id } = req.params;\n      const override = await storage.updateCountryPricingOverride(id, validated);\n      res.json(override);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid country pricing data\", errors: error.errors });\n      }\n      console.error(\"Error updating country pricing:\", error);\n      res.status(500).json({ message: \"Failed to update country pricing\", error: error.message });\n    }\n  });\n\n  // Delete country pricing override\n  app.delete(\"/api/admin/country-pricing/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      // Check if user is admin\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      await storage.deleteCountryPricingOverride(id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting country pricing:\", error);\n      res.status(500).json({ message: \"Failed to delete country pricing\", error: error.message });\n    }\n  });\n\n  // ==================== SUBSCRIPTION PLAN ROUTES (Eco-Admin) ====================\n\n  // Get all plans\n  app.get(\"/api/admin/plans\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const plans = await storage.getPlans();\n      res.json(plans);\n    } catch (error: any) {\n      console.error(\"Error fetching plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch plans\" });\n    }\n  });\n\n  // Get active plans\n  app.get(\"/api/admin/plans/active\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const plans = await storage.getActivePlans();\n      res.json(plans);\n    } catch (error: any) {\n      console.error(\"Error fetching active plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch active plans\" });\n    }\n  });\n\n  // Create new plan\n  app.post(\"/api/admin/plans\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertPlanSchema.parse(req.body);\n      const plan = await storage.createPlan(validated);\n      res.json(plan);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid plan data\", errors: error.errors });\n      }\n      console.error(\"Error creating plan:\", error);\n      res.status(500).json({ message: \"Failed to create plan\", error: error.message });\n    }\n  });\n\n  // Update plan\n  app.patch(\"/api/admin/plans/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertPlanSchema.partial().parse(req.body);\n      const { id } = req.params;\n      const plan = await storage.updatePlan(id, validated);\n      res.json(plan);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid plan data\", errors: error.errors });\n      }\n      console.error(\"Error updating plan:\", error);\n      res.status(500).json({ message: \"Failed to update plan\", error: error.message });\n    }\n  });\n\n  // ==================== CREDIT BUNDLE ROUTES (Eco-Admin) ====================\n\n  // Get all credit bundles\n  app.get(\"/api/admin/bundles\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const bundles = await storage.getCreditBundles();\n      res.json(bundles);\n    } catch (error: any) {\n      console.error(\"Error fetching bundles:\", error);\n      res.status(500).json({ message: \"Failed to fetch bundles\" });\n    }\n  });\n\n  // Get active credit bundles\n  app.get(\"/api/admin/bundles/active\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const bundles = await storage.getActiveCreditBundles();\n      res.json(bundles);\n    } catch (error: any) {\n      console.error(\"Error fetching active bundles:\", error);\n      res.status(500).json({ message: \"Failed to fetch active bundles\" });\n    }\n  });\n\n  // Create new credit bundle\n  app.post(\"/api/admin/bundles\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertCreditBundleSchema.parse(req.body);\n      const bundle = await storage.createCreditBundle(validated);\n      res.json(bundle);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid bundle data\", errors: error.errors });\n      }\n      console.error(\"Error creating bundle:\", error);\n      res.status(500).json({ message: \"Failed to create bundle\", error: error.message });\n    }\n  });\n\n  // Update credit bundle\n  app.patch(\"/api/admin/bundles/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const validated = insertCreditBundleSchema.partial().parse(req.body);\n      const { id } = req.params;\n      const bundle = await storage.updateCreditBundle(id, validated);\n      res.json(bundle);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid bundle data\", errors: error.errors });\n      }\n      console.error(\"Error updating bundle:\", error);\n      res.status(500).json({ message: \"Failed to update bundle\", error: error.message });\n    }\n  });\n\n  // Delete credit bundle\n  app.delete(\"/api/admin/bundles/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const adminUser = await storage.getAdminByEmail(req.user.email);\n      if (!adminUser) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      await storage.deleteCreditBundle(id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting bundle:\", error);\n      res.status(500).json({ message: \"Failed to delete bundle\", error: error.message });\n    }\n  });\n\n  // Get current organization subscription\n  app.get(\"/api/billing/subscription\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      console.log(`[Get Subscription] Fetching subscription for org: ${user.organizationId}, user: ${user.id}`);\n      \n      // Get all subscriptions for this org to debug\n      const allSubscriptions = await db\n        .select()\n        .from(subscriptions)\n        .where(eq(subscriptions.organizationId, user.organizationId));\n      \n      console.log(`[Get Subscription] Found ${allSubscriptions.length} subscription(s) for org ${user.organizationId}:`, \n        allSubscriptions.map(s => ({ id: s.id, status: s.status, planName: s.planSnapshotJson?.planName }))\n      );\n      \n      const subscription = await storage.getSubscriptionByOrganization(user.organizationId);\n      \n      if (subscription) {\n        console.log(`[Get Subscription] Returning subscription:`, {\n          id: subscription.id,\n          planName: subscription.planSnapshotJson?.planName,\n          status: subscription.status,\n          organizationId: subscription.organizationId,\n          currentPeriodStart: subscription.currentPeriodStart,\n          currentPeriodEnd: subscription.currentPeriodEnd\n        });\n      } else {\n        console.log(`[Get Subscription] No subscription found for org: ${user.organizationId}`);\n        console.log(`[Get Subscription] All subscriptions in DB for this org:`, allSubscriptions);\n      }\n      \n      res.json(subscription || null);\n    } catch (error: any) {\n      console.error(\"[Get Subscription] Error fetching subscription:\", error);\n      console.error(\"[Get Subscription] Error stack:\", error.stack);\n      res.status(500).json({ message: \"Failed to fetch subscription\", error: error.message });\n    }\n  });\n\n  // Get aggregate credit balance across all organizations for normalized email (detects duplicates)\n  app.get(\"/api/billing/aggregate-credits\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId || !user.email) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Get all organizations associated with this normalized email\n      const orgs = await storage.getOrganizationsByNormalizedEmail(user.email);\n      \n      // Get credit balances for each organization\n      const orgBalances = await Promise.all(\n        orgs.map(async (org) => {\n          const balance = await storage.getCreditBalance(org.organizationId);\n          return {\n            organizationId: org.organizationId,\n            organizationName: org.organizationName,\n            userRole: org.userRole,\n            credits: balance.total,\n            consumed: balance.consumed,\n            expired: balance.expired,\n          };\n        })\n      );\n\n      // Calculate aggregate totals\n      const totalCredits = orgBalances.reduce((sum, org) => sum + org.credits, 0);\n      const totalConsumed = orgBalances.reduce((sum, org) => sum + org.consumed, 0);\n      const totalExpired = orgBalances.reduce((sum, org) => sum + org.expired, 0);\n      \n      // Find current org balance\n      const currentOrgBalance = orgBalances.find(org => org.organizationId === user.organizationId);\n      \n      res.json({\n        primaryOrganizationCredits: currentOrgBalance?.credits || 0,\n        duplicateOrganizations: orgBalances.filter(org => org.organizationId !== user.organizationId),\n        allOrganizations: orgBalances,\n        totalCredits,\n        totalConsumed,\n        totalExpired,\n        hasDuplicates: orgBalances.length > 1,\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching aggregate credits:\", error);\n      res.status(500).json({ message: \"Failed to fetch aggregate credits\" });\n    }\n  });\n\n  // User/Contact endpoints for team management (restricted)\n  \n  // Get users for team management (admin/owner only)\n  app.get(\"/api/users\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can view users\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const users = await storage.getUsersByOrganization(user.organizationId);\n      \n      // Return minimal user data for team selection\n      const sanitizedUsers = users.map(u => ({\n        id: u.id,\n        firstName: u.firstName,\n        lastName: u.lastName,\n        email: u.email,\n        role: u.role,\n      }));\n      \n      res.json(sanitizedUsers);\n    } catch (error: any) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  // Get contacts for team management (admin/owner only)\n  app.get(\"/api/contacts\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can view contacts\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const contacts = await storage.getContactsByOrganization(user.organizationId);\n      \n      // Return minimal contact data for team selection\n      const sanitizedContacts = contacts.map(c => ({\n        id: c.id,\n        firstName: c.firstName,\n        lastName: c.lastName,\n        email: c.email,\n        type: c.type,\n      }));\n      \n      res.json(sanitizedContacts);\n    } catch (error: any) {\n      console.error(\"Error fetching contacts:\", error);\n      res.status(500).json({ message: \"Failed to fetch contacts\" });\n    }\n  });\n\n  // Team Management Routes\n  \n  // Get all teams for organization\n  app.get(\"/api/teams\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can view teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const teams = await storage.getTeamsByOrganization(user.organizationId);\n      res.json(teams);\n    } catch (error: any) {\n      console.error(\"Error fetching teams:\", error);\n      res.status(500).json({ message: \"Failed to fetch teams\" });\n    }\n  });\n\n  // Get single team\n  app.get(\"/api/teams/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can view teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      const team = await storage.getTeam(id);\n\n      if (!team) {\n        return res.status(404).json({ message: \"Team not found\" });\n      }\n\n      // Verify team belongs to user's organization\n      if (team.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      res.json(team);\n    } catch (error: any) {\n      console.error(\"Error fetching team:\", error);\n      res.status(500).json({ message: \"Failed to fetch team\" });\n    }\n  });\n\n  // Create team\n  // Create team with members and categories (atomic transaction)\n  app.post(\"/api/teams/full\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can create teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Validate request body\n      const bodySchema = z.object({\n        name: z.string().min(1),\n        description: z.string().optional(),\n        email: z.string().email(),\n        isActive: z.boolean().optional(),\n        userIds: z.array(z.string()).optional(),\n        contactIds: z.array(z.string()).optional(),\n        categories: z.array(z.string()).optional(),\n      });\n\n      const validationResult = bodySchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({\n          message: \"Invalid request data\",\n          errors: validationResult.error.errors,\n        });\n      }\n\n      const { name, description, email, isActive, userIds, contactIds, categories } = validationResult.data;\n\n      // Create team with members and categories in a single transaction\n      try {\n        const result = await db.transaction(async (tx) => {\n          // 1. Create team\n          const [createdTeam] = await tx.insert(teams).values({\n            organizationId: user.organizationId,\n            name,\n            description,\n            email,\n            isActive: isActive ?? true,\n          }).returning();\n\n          // 2. Add user members\n          if (userIds && Array.isArray(userIds) && userIds.length > 0) {\n            await tx.insert(teamMembers).values(\n              userIds.map(userId => ({\n                teamId: createdTeam.id,\n                userId,\n                contactId: null,\n                role: 'member' as const,\n              }))\n            );\n          }\n\n          // 3. Add contractor members\n          if (contactIds && Array.isArray(contactIds) && contactIds.length > 0) {\n            await tx.insert(teamMembers).values(\n              contactIds.map(contactId => ({\n                teamId: createdTeam.id,\n                userId: null,\n                contactId,\n                role: 'contractor' as const,\n              }))\n            );\n          }\n\n          // 4. Add categories\n          if (categories && Array.isArray(categories) && categories.length > 0) {\n            await tx.insert(teamCategories).values(\n              categories.map(category => ({\n                teamId: createdTeam.id,\n                category,\n              }))\n            );\n          }\n\n          // Return created team with counts\n          const finalMembers = await tx\n            .select()\n            .from(teamMembers)\n            .where(eq(teamMembers.teamId, createdTeam.id));\n\n          const finalCategories = await tx\n            .select()\n            .from(teamCategories)\n            .where(eq(teamCategories.teamId, createdTeam.id));\n\n          return {\n            ...createdTeam,\n            memberCount: finalMembers.length,\n            categories: finalCategories.map(c => c.category),\n          };\n        });\n\n        res.status(201).json(result);\n      } catch (error: any) {\n        // Transaction automatically rolled back on error\n        throw error;\n      }\n    } catch (error: any) {\n      console.error(\"Error creating team:\", error);\n      res.status(500).json({ message: \"Failed to create team\", error: error.message });\n    }\n  });\n\n  // Simple team creation (without members/categories)\n  app.post(\"/api/teams\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can create teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { name, description, email, isActive } = req.body;\n\n      if (!name || !email) {\n        return res.status(400).json({ message: \"Name and email are required\" });\n      }\n\n      const team = await storage.createTeam({\n        organizationId: user.organizationId,\n        name,\n        description,\n        email,\n        isActive: isActive ?? true,\n      });\n\n      res.status(201).json(team);\n    } catch (error: any) {\n      console.error(\"Error creating team:\", error);\n      res.status(500).json({ message: \"Failed to create team\" });\n    }\n  });\n\n  // Update team\n  app.patch(\"/api/teams/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can update teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      const team = await storage.getTeam(id);\n\n      if (!team) {\n        return res.status(404).json({ message: \"Team not found\" });\n      }\n\n      // Verify team belongs to user's organization\n      if (team.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { name, description, email, isActive } = req.body;\n      const updates: any = {};\n      if (name !== undefined) updates.name = name;\n      if (description !== undefined) updates.description = description;\n      if (email !== undefined) updates.email = email;\n      if (isActive !== undefined) updates.isActive = isActive;\n\n      const updatedTeam = await storage.updateTeam(id, updates);\n      res.json(updatedTeam);\n    } catch (error: any) {\n      console.error(\"Error updating team:\", error);\n      res.status(500).json({ message: \"Failed to update team\" });\n    }\n  });\n\n  // Update team with members and categories (server-side batched)\n  app.patch(\"/api/teams/:id/full\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Only admins and owners can update teams\n      if (!['admin', 'owner'].includes(user.role)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      \n      // Validate request body\n      const bodySchema = z.object({\n        name: z.string().min(1).optional(),\n        description: z.string().optional(),\n        email: z.string().email().optional(),\n        isActive: z.boolean().optional(),\n        userIds: z.array(z.string()).optional(),\n        contactIds: z.array(z.string()).optional(),\n        categories: z.array(z.string()).optional(),\n      });\n      \n      const validationResult = bodySchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Invalid request data\", \n          errors: validationResult.error.errors \n        });\n      }\n      \n      const { name, description, email, isActive, userIds, contactIds, categories } = validationResult.data;\n\n      const team = await storage.getTeam(id);\n      if (!team) {\n        return res.status(404).json({ message: \"Team not found\" });\n      }\n\n      // Verify team belongs to user's organization\n      if (team.organizationId !== user.organizationId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Begin database transaction for atomic updates\n      try {\n        const result = await db.transaction(async (tx) => {\n          // 1. Update team details\n          const teamUpdates: any = {};\n          if (name !== undefined) teamUpdates.name = name;\n          if (description !== undefined) teamUpdates.description = description;\n          if (email !== undefined) teamUpdates.email = email;\n          if (isActive !== undefined) teamUpdates.isActive = isActive;\n          \n          const [updatedTeam] = await tx\n            .update(teams)\n            .set(teamUpdates)\n            .where(eq(teams.id, id))\n            .returning();\n\n          // 2. Update members - delete all and recreate\n          await tx.delete(teamMembers).where(eq(teamMembers.teamId, id));\n\n          // Add new user members\n          if (userIds && Array.isArray(userIds) && userIds.length > 0) {\n            await tx.insert(teamMembers).values(\n              userIds.map(userId => ({\n                teamId: id,\n                userId,\n                contactId: null,\n                role: 'member' as const,\n              }))\n            );\n          }\n\n          // Add new contractor members\n          if (contactIds && Array.isArray(contactIds) && contactIds.length > 0) {\n            await tx.insert(teamMembers).values(\n              contactIds.map(contactId => ({\n                teamId: id,\n                userId: null,\n                contactId,\n                role: 'contractor' as const,\n              }))\n            );\n          }\n\n          // 3. Update categories - delete all and recreate\n          await tx.delete(teamCategories).where(eq(teamCategories.teamId, id));\n\n          if (categories && Array.isArray(categories) && categories.length > 0) {\n            await tx.insert(teamCategories).values(\n              categories.map(category => ({\n                teamId: id,\n                category,\n              }))\n            );\n          }\n\n          // Return updated team with counts\n          const finalMembers = await tx\n            .select()\n            .from(teamMembers)\n            .where(eq(teamMembers.teamId, id));\n\n          const finalCategories = await tx\n            .select()\n            .from(teamCategories)\n            .where(eq(teamCategories.teamId, id));\n\n          return {\n            ...updatedTeam,\n            memberCount: finalMembers.length,\n            categories: finalCategories.map(c => c.category),\n          };\n        });\n\n        res.json(result);\n      } catch (error: any) {\n        // Transaction automatically rolled back on error\n        throw error;\n      }\n    } catch (error: any) {\n      console.error(\"Error updating team:\", error);\n      res.status(500).json({ message: \"Failed to update team\", error: error.message });\n    }\n  });\n\n  // Delete team\n  app.delete(\"/api/teams/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const user = await storage.getUser(req.user.id);\n      if (!user?.organizationId) {\n        return res.status(400).json({ message: \"User must belong to an organization\" });\n      }\n\n      // Onl","size_bytes":360000},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/pages/Maintenance.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Plus, Wrench, Upload, Sparkles, Loader2, X, Check, ChevronsUpDown, Pencil, Clipboard, Calendar, DollarSign, User as UserIcon, AlertCircle, CheckCircle2, Clock } from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport { FixfloSyncButton } from \"@/components/FixfloSyncButton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertMaintenanceRequestSchema } from \"@shared/schema\";\nimport type { MaintenanceRequest, Property, User } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport Uppy from \"@uppy/core\";\nimport AwsS3 from \"@uppy/aws-s3\";\nimport { Dashboard } from \"@uppy/react\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { cn } from \"@/lib/utils\";\n\ntype MaintenanceRequestWithDetails = MaintenanceRequest & {\n  property?: { name: string; address: string };\n  reportedByUser?: { firstName: string; lastName: string };\n  assignedToUser?: { firstName: string; lastName: string };\n};\n\ninterface WorkOrder {\n  id: string;\n  status: string;\n  slaDue?: string | null;\n  costEstimate?: number | null;\n  costActual?: number | null;\n  createdAt: string;\n  maintenanceRequest: {\n    id: string;\n    title: string;\n    description?: string;\n    priority: string;\n  };\n  contractor?: {\n    id?: string;\n    firstName?: string;\n    lastName?: string;\n    email: string;\n  } | null;\n  team?: {\n    id?: string;\n    name?: string;\n    email?: string;\n  } | null;\n}\n\nconst workOrderStatusColors: Record<string, string> = {\n  assigned: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\",\n  in_progress: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300\",\n  waiting_parts: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300\",\n  completed: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\",\n  rejected: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300\",\n};\n\nconst priorityColors: Record<string, string> = {\n  low: \"bg-gray-100 text-gray-800\",\n  medium: \"bg-blue-100 text-blue-800\",\n  high: \"bg-orange-100 text-orange-800\",\n  urgent: \"bg-red-100 text-red-800\",\n};\n\nconst createMaintenanceSchema = insertMaintenanceRequestSchema\n  .omit({ organizationId: true }) // Backend adds this from session\n  .extend({\n    title: z.string().min(1, \"Title is required\"),\n    propertyId: z.string().min(1, \"Property is required\"),\n    priority: z.enum([\"low\", \"medium\", \"high\"]),\n  });\n\nexport default function Maintenance() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const locale = useLocale();\n  const [, navigate] = useLocation();\n  const searchParams = useSearch();\n  const urlPropertyId = new URLSearchParams(searchParams).get(\"propertyId\");\n  const shouldCreate = new URLSearchParams(searchParams).get(\"create\");\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [isAutoOpening, setIsAutoOpening] = useState(false);\n  const [editingRequest, setEditingRequest] = useState<MaintenanceRequestWithDetails | null>(null);\n  const [selectedStatus, setSelectedStatus] = useState<string>(\"all\");\n  const [uploadedImages, setUploadedImages] = useState<string[]>([]);\n  const [aiSuggestions, setAiSuggestions] = useState<string>(\"\");\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [currentStep, setCurrentStep] = useState<\"form\" | \"images\" | \"suggestions\" | \"review\">(\"form\");\n  const uppyRef = useRef<Uppy | null>(null);\n  \n  // Work order creation state\n  const [isWorkOrderDialogOpen, setIsWorkOrderDialogOpen] = useState(false);\n  const [selectedRequestForWorkOrder, setSelectedRequestForWorkOrder] = useState<MaintenanceRequestWithDetails | null>(null);\n\n  // Handle dialog state change\n  const handleDialogChange = (open: boolean) => {\n    setIsCreateOpen(open);\n    if (open && !editingRequest && !isAutoOpening) {\n      // Reset form when opening dialog for a new request (unless auto-opening from URL)\n      form.reset();\n      setCurrentStep(\"form\");\n      setUploadedImages([]);\n      setAiSuggestions(\"\");\n    }\n    if (!open) {\n      // Clear editing state when closing\n      setEditingRequest(null);\n      setUploadedImages([]);\n      setAiSuggestions(\"\");\n      setIsAutoOpening(false);\n    }\n    // Don't reset when closing - it would cancel any pending form submission\n    // Form will be reset in the mutation onSuccess callback after successful submission\n  };\n\n  // Fetch maintenance requests\n  const { data: requests = [], isLoading } = useQuery<MaintenanceRequestWithDetails[]>({\n    queryKey: [\"/api/maintenance\"],\n  });\n\n  // Fetch properties\n  const { data: properties = [] } = useQuery<Property[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  // Fetch organization clerks (for assignment)\n  const { data: clerks = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users/clerks\"],\n    enabled: user?.role === \"owner\",\n  });\n\n  // Fetch work orders (only for owners and contractors)\n  const { data: workOrders = [], isLoading: workOrdersLoading } = useQuery<WorkOrder[]>({\n    queryKey: [\"/api/work-orders\"],\n    enabled: user?.role === \"owner\" || user?.role === \"contractor\",\n  });\n\n  // Fetch teams for work order assignment\n  const { data: teams = [] } = useQuery<any[]>({\n    queryKey: [\"/api/teams\"],\n    enabled: user?.role === \"owner\",\n  });\n\n  // Fetch contractors for work order assignment\n  const { data: contractors = [] } = useQuery<any[]>({\n    queryKey: [\"/api/contacts\"],\n    enabled: user?.role === \"owner\",\n  });\n\n  // Work order creation mutation\n  const createWorkOrderMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"POST\", \"/api/work-orders\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/maintenance\"] });\n      setIsWorkOrderDialogOpen(false);\n      setSelectedRequestForWorkOrder(null);\n      toast({ title: \"Work order created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create work order\", variant: \"destructive\" });\n    },\n  });\n\n  // Work order status update mutation\n  const updateWorkOrderStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/work-orders/${id}/status`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n      toast({ title: \"Work order status updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update work order status\", variant: \"destructive\" });\n    },\n  });\n\n  // Initialize Uppy for image uploads\n  useEffect(() => {\n    if (isCreateOpen && user?.role === \"tenant\" && !uppyRef.current) {\n      const uppy = new Uppy({\n        restrictions: {\n          maxFileSize: 10 * 1024 * 1024, // 10MB\n          maxNumberOfFiles: 5,\n          allowedFileTypes: [\"image/*\"],\n        },\n        autoProceed: false,\n      });\n\n      uppy.use(AwsS3, {\n        shouldUseMultipart: false,\n        async getUploadParameters(file) {\n          try {\n            const response = await fetch(\"/api/objects/upload\", {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              credentials: \"include\",\n            });\n\n            if (!response.ok) {\n              throw new Error(`Failed to get upload URL: ${response.statusText}`);\n            }\n\n            const data = await response.json();\n            \n            if (!data.uploadURL) {\n              throw new Error(\"Invalid upload URL response\");\n            }\n\n            // Ensure URL is absolute\n            let uploadURL = data.uploadURL;\n            if (uploadURL.startsWith('/')) {\n              // Convert relative URL to absolute\n              uploadURL = `${window.location.origin}${uploadURL}`;\n            }\n\n            // Validate URL\n            try {\n              new URL(uploadURL);\n            } catch (e) {\n              throw new Error(`Invalid upload URL format: ${uploadURL}`);\n            }\n\n            // Extract objectId from upload URL and store in metadata\n            try {\n              const urlObj = new URL(uploadURL);\n              const objectId = urlObj.searchParams.get('objectId');\n              if (objectId) {\n                uppy.setFileMeta(file.id, { \n                  originalUploadURL: uploadURL,\n                  objectId: objectId,\n                });\n              } else {\n                uppy.setFileMeta(file.id, { \n                  originalUploadURL: uploadURL,\n                });\n              }\n            } catch (e) {\n              uppy.setFileMeta(file.id, { \n                originalUploadURL: uploadURL,\n              });\n            }\n            \n            return {\n              method: \"PUT\" as const,\n              url: uploadURL,\n              headers: {\n                \"Content-Type\": file.type || \"application/octet-stream\",\n              },\n              fields: {},\n            };\n          } catch (error: any) {\n            console.error(\"[Maintenance] Upload URL error:\", error);\n            throw new Error(`Failed to get upload URL: ${error.message}`);\n          }\n        },\n      });\n\n      uppy.on(\"upload-success\", async (file, response) => {\n        // Import the helper function\n        const { extractFileUrlFromUploadResponse } = await import(\"@/lib/utils\");\n        let fileUrl = extractFileUrlFromUploadResponse(file, response);\n        \n        // If extraction failed, try to use objectId from metadata as fallback\n        if (!fileUrl && file?.meta?.objectId) {\n          fileUrl = `/objects/${file.meta.objectId}`;\n          console.log('[Maintenance] Using objectId fallback:', fileUrl);\n        }\n        \n        if (fileUrl) {\n          // Convert relative path to absolute URL for display\n          const absoluteUrl = fileUrl.startsWith('/') \n            ? `${window.location.origin}${fileUrl}`\n            : fileUrl;\n          \n          setUploadedImages((prev) => {\n            if (prev.includes(absoluteUrl)) {\n              return prev; // Avoid duplicates\n            }\n            return [...prev, absoluteUrl];\n          });\n          \n          // Set ACL in background\n          fetch('/api/objects/set-acl', {\n            method: 'PUT',\n            headers: { 'Content-Type': 'application/json' },\n            credentials: 'include',\n            body: JSON.stringify({ photoUrl: absoluteUrl }),\n          }).catch(error => {\n            console.error('[Maintenance] Error setting ACL:', error);\n          });\n        } else {\n          console.error('[Maintenance] No upload URL found in response:', { file, response });\n        }\n      });\n\n      uppyRef.current = uppy;\n    }\n\n    return () => {\n      if (uppyRef.current) {\n        uppyRef.current.clear();\n        uppyRef.current = null;\n      }\n    };\n  }, [isCreateOpen, user?.role]);\n\n  // AI analyze image mutation\n  const analyzeMutation = useMutation({\n    mutationFn: async ({ imageUrl, description }: { imageUrl: string; description: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/maintenance/analyze-image\", {\n        imageUrl,\n        issueDescription: description,\n      });\n      return await res.json();\n    },\n    onSuccess: (data: any) => {\n      setAiSuggestions(data.suggestedFixes);\n      setCurrentStep(\"suggestions\");\n      toast({\n        title: \"AI Analysis Complete\",\n        description: \"Review the suggested fixes below\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Analysis Failed\",\n        description: error.message || \"Failed to analyze image\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create maintenance request mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: z.infer<typeof createMaintenanceSchema> & { \n      photoUrls?: string[]; \n      aiSuggestedFixes?: string;\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/maintenance\", data);\n      return await res.json();\n    },\n    onSuccess: async () => {\n      try {\n        console.log(\"[Maintenance] Request created successfully, refetching queries...\");\n        \n        // Explicitly refetch to ensure we get the latest data\n        await queryClient.refetchQueries({ queryKey: [\"/api/maintenance\"] });\n        \n        console.log(\"[Maintenance] Refetch complete, showing toast...\");\n        \n        toast({\n          title: \"Success\",\n          description: \"Maintenance request created successfully\",\n        });\n        \n        console.log(\"[Maintenance] Cleaning up form state...\");\n        \n        setIsCreateOpen(false);\n        form.reset();\n        setUploadedImages([]);\n        setAiSuggestions(\"\");\n        setCurrentStep(\"form\");\n        \n        console.log(\"[Maintenance] Form cleanup complete\");\n      } catch (error) {\n        console.error(\"[Maintenance] Error in onSuccess:\", error);\n        toast({\n          title: \"Warning\",\n          description: \"Request created but there was an issue refreshing the list\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error) => {\n      console.error(\"[Maintenance] Failed to create maintenance request:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to create maintenance request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update maintenance request mutation\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<z.infer<typeof createMaintenanceSchema>> & { photoUrls?: string[]; aiSuggestedFixes?: string } }) => {\n      const res = await apiRequest(\"PATCH\", `/api/maintenance/${id}`, data);\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/maintenance\"] });\n      toast({\n        title: \"Success\",\n        description: \"Maintenance request updated successfully\",\n      });\n      \n      setIsCreateOpen(false);\n      setEditingRequest(null);\n      form.reset();\n      setUploadedImages([]);\n      setAiSuggestions(\"\");\n      setCurrentStep(\"form\");\n    },\n    onError: (error) => {\n      console.error(\"[Maintenance] Failed to update maintenance request:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to update maintenance request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update status mutation\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status, assignedTo }: { id: string; status: string; assignedTo?: string }) => {\n      const res = await apiRequest(\"PATCH\", `/api/maintenance/${id}`, { status, assignedTo });\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/maintenance\"] });\n      toast({\n        title: \"Success\",\n        description: \"Maintenance request updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update maintenance request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const form = useForm<z.infer<typeof createMaintenanceSchema>>({\n    resolver: zodResolver(createMaintenanceSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      propertyId: \"\",\n      priority: \"medium\",\n      reportedBy: user?.id || \"\",\n    },\n  });\n\n  // Handle URL parameters for auto-opening dialog and pre-populating\n  useEffect(() => {\n    if (urlPropertyId && shouldCreate === \"true\" && properties.length > 0) {\n      // Set flag to prevent form reset\n      setIsAutoOpening(true);\n      // Pre-populate property before opening dialog\n      form.setValue(\"propertyId\", urlPropertyId);\n      // Auto-open dialog\n      setIsCreateOpen(true);\n      // Clear URL parameters after opening to keep URL clean\n      navigate(\"/maintenance\", { replace: true });\n    }\n  }, [urlPropertyId, shouldCreate, properties, navigate]);\n\n  const handleImageStep = async () => {\n    if (uploadedImages.length === 0) {\n      toast({\n        title: \"Image Required\",\n        description: \"Please upload at least one image of the issue\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Get AI analysis\n    setIsAnalyzing(true);\n    try {\n      await analyzeMutation.mutateAsync({\n        imageUrl: uploadedImages[0],\n        description: form.getValues(\"description\") || form.getValues(\"title\"),\n      });\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  const onSubmit = (data: z.infer<typeof createMaintenanceSchema>) => {\n    // For tenants, require images and show AI suggestions first\n    if (user?.role === \"tenant\" && currentStep === \"form\" && !editingRequest) {\n      setCurrentStep(\"images\");\n      return;\n    }\n\n    // Submit with images and AI suggestions\n    const payload = { \n      ...data, \n      reportedBy: user?.id || \"\",\n      photoUrls: uploadedImages.length > 0 ? uploadedImages : undefined,\n      aiSuggestedFixes: aiSuggestions || undefined,\n    };\n    \n    if (editingRequest) {\n      updateMutation.mutate({ id: editingRequest.id, data: payload });\n    } else {\n      createMutation.mutate(payload);\n    }\n  };\n\n  // Handle edit button click\n  const handleEdit = (request: MaintenanceRequestWithDetails) => {\n    setEditingRequest(request);\n    form.reset({\n      title: request.title,\n      description: request.description || \"\",\n      propertyId: request.propertyId,\n      priority: request.priority as \"low\" | \"medium\" | \"high\",\n      reportedBy: request.reportedBy || \"\",\n    });\n    setUploadedImages(request.photoUrls || []);\n    setAiSuggestions(request.aiSuggestedFixes || \"\");\n    setCurrentStep(\"form\");\n    setIsCreateOpen(true);\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    const variants: Record<string, { variant: \"default\" | \"secondary\" | \"destructive\"; label: string }> = {\n      low: { variant: \"secondary\", label: \"Low\" },\n      medium: { variant: \"default\", label: \"Medium\" },\n      high: { variant: \"destructive\", label: \"High\" },\n    };\n    const config = variants[priority] || variants.medium;\n    return <Badge variant={config.variant} data-testid={`badge-priority-${priority}`}>{config.label}</Badge>;\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, { variant: \"default\" | \"secondary\" | \"outline\"; label: string }> = {\n      open: { variant: \"outline\", label: \"Open\" },\n      assigned: { variant: \"secondary\", label: \"Assigned\" },\n      \"in-progress\": { variant: \"default\", label: \"In Progress\" },\n      completed: { variant: \"secondary\", label: \"Completed\" },\n    };\n    const config = variants[status] || variants.open;\n    return <Badge variant={config.variant} data-testid={`badge-status-${status}`}>{config.label}</Badge>;\n  };\n\n  // Filter by status and tenant (if tenant user)\n  let filteredRequests = selectedStatus === \"all\" \n    ? requests \n    : requests.filter(r => r.status === selectedStatus);\n  \n  // Tenants should only see their own requests\n  if (user?.role === \"tenant\") {\n    filteredRequests = filteredRequests.filter(r => r.reportedBy === user.id);\n  }\n\n  // Work order helper functions\n  const formatCurrency = (amount?: number | null) => {\n    if (!amount) return \"N/A\";\n    return `$${(amount / 100).toFixed(2)}`;\n  };\n\n  const getWorkOrderStatusIcon = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <CheckCircle2 className=\"h-4 w-4\" />;\n      case \"in_progress\":\n      case \"waiting_parts\":\n        return <Clock className=\"h-4 w-4\" />;\n      case \"rejected\":\n        return <AlertCircle className=\"h-4 w-4\" />;\n      default:\n        return <UserIcon className=\"h-4 w-4\" />;\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-3\" data-testid=\"heading-maintenance\">\n            <Wrench className=\"w-8 h-8 text-primary\" />\n            Maintenance\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {user?.role === \"tenant\" \n              ? \"Submit and track your maintenance requests\" \n              : \"Manage maintenance requests and contractor work orders\"}\n          </p>\n        </div>\n        <Dialog open={isCreateOpen} onOpenChange={handleDialogChange}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-request\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              New Request\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingRequest \n                  ? \"Edit Maintenance Request\" \n                  : user?.role === \"tenant\" ? \"Report Maintenance Issue\" : \"Create Maintenance Request\"}\n              </DialogTitle>\n              <DialogDescription>\n                {user?.role === \"tenant\" && currentStep === \"images\" \n                  ? \"Upload photos of the issue for AI analysis\"\n                  : user?.role === \"tenant\" && currentStep === \"suggestions\"\n                  ? \"Review AI-suggested fixes before submitting\"\n                  : \"Submit a new maintenance request for a property\"}\n              </DialogDescription>\n            </DialogHeader>\n\n            {/* Tenant Multi-Step Flow */}\n            {user?.role === \"tenant\" ? (\n              <div className=\"space-y-4\">\n                {/* Step 1: Basic Form */}\n                {currentStep === \"form\" && (\n                  <Form {...form}>\n                    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={form.control}\n                        name=\"title\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>What's the issue?</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"e.g., Leaking faucet\" data-testid=\"input-title\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"propertyId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Which property?</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-property\">\n                                  <SelectValue placeholder=\"Select your property\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {properties.map((property) => (\n                                  <SelectItem key={property.id} value={property.id}>{property.name}</SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"description\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Details</FormLabel>\n                            <FormControl>\n                              <Textarea {...field} value={field.value || \"\"} placeholder=\"Describe the issue...\" data-testid=\"input-description\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <Button type=\"submit\" className=\"w-full\" data-testid=\"button-next-upload\">\n                        Next: Upload Photos <Upload className=\"w-4 h-4 ml-2\" />\n                      </Button>\n                    </form>\n                  </Form>\n                )}\n\n                {/* Step 2: Image Upload */}\n                {currentStep === \"images\" && uppyRef.current && (\n                  <div className=\"space-y-4\">\n                    <Dashboard uppy={uppyRef.current} proudlyDisplayPoweredByUppy={false} height={300} />\n                    <div className=\"flex flex-col gap-2\">\n                      {uploadedImages.length > 0 && (\n                        <p className=\"text-sm text-muted-foreground\">{uploadedImages.length} image(s) uploaded</p>\n                      )}\n                      <div className=\"flex gap-2\">\n                        <Button variant=\"outline\" onClick={() => setCurrentStep(\"form\")} className=\"flex-1\" data-testid=\"button-back-to-form\">Back</Button>\n                        <Button onClick={handleImageStep} disabled={isAnalyzing} className=\"flex-1\" data-testid=\"button-get-ai-suggestions\">\n                          {isAnalyzing ? (\n                            <><Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> Analyzing...</>\n                          ) : (\n                            <><Sparkles className=\"w-4 h-4 mr-2\" /> Get AI Suggestions</>\n                          )}\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Step 3: AI Suggestions */}\n                {currentStep === \"suggestions\" && (\n                  <div className=\"space-y-4\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Sparkles className=\"w-5 h-5 text-primary\" />\n                          AI-Suggested Fixes\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-3\">\n                        <p className=\"text-sm whitespace-pre-wrap\">{aiSuggestions}</p>\n                      </CardContent>\n                    </Card>\n                    <div className=\"flex gap-2\">\n                      <Button variant=\"outline\" onClick={() => setCurrentStep(\"images\")} className=\"flex-1\" data-testid=\"button-back-to-images\">Back</Button>\n                      <Button onClick={form.handleSubmit(onSubmit)} disabled={createMutation.isPending} className=\"flex-1\" data-testid=\"button-submit-final\">\n                        {createMutation.isPending ? \"Submitting...\" : \"Submit Request\"}\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            ) : (\n              /* Standard Form for Non-Tenants with Image Upload and AI */\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"title\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Title</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"e.g., Leaking faucet\" data-testid=\"input-title\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"propertyId\"\n                    render={({ field }) => {\n                      const [propertyComboboxOpen, setPropertyComboboxOpen] = useState(false);\n                      return (\n                        <FormItem className=\"flex flex-col\">\n                          <FormLabel>Property</FormLabel>\n                          <Popover open={propertyComboboxOpen} onOpenChange={setPropertyComboboxOpen}>\n                            <PopoverTrigger asChild>\n                              <FormControl>\n                                <Button\n                                  variant=\"outline\"\n                                  role=\"combobox\"\n                                  className={cn(\n                                    \"justify-between\",\n                                    !field.value && \"text-muted-foreground\"\n                                  )}\n                                  data-testid=\"select-property\"\n                                >\n                                  {field.value\n                                    ? properties.find((property) => property.id === field.value)?.name +\n                                      (properties.find((property) => property.id === field.value)?.address \n                                        ? ` - ${properties.find((property) => property.id === field.value)?.address}`\n                                        : \"\")\n                                    : \"Select a property\"}\n                                  <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                                </Button>\n                              </FormControl>\n                            </PopoverTrigger>\n                            <PopoverContent className=\"w-[400px] p-0\">\n                              <Command>\n                                <CommandInput placeholder=\"Search properties...\" />\n                                <CommandList>\n                                  <CommandEmpty>No property found.</CommandEmpty>\n                                  <CommandGroup>\n                                    {properties.map((property) => (\n                                      <CommandItem\n                                        key={property.id}\n                                        value={`${property.name} ${property.address || \"\"}`}\n                                        onSelect={() => {\n                                          field.onChange(property.id);\n                                          setPropertyComboboxOpen(false);\n                                        }}\n                                      >\n                                        <Check\n                                          className={cn(\n                                            \"mr-2 h-4 w-4\",\n                                            property.id === field.value\n                                              ? \"opacity-100\"\n                                              : \"opacity-0\"\n                                          )}\n                                        />\n                                        <div className=\"flex flex-col\">\n                                          <span>{property.name}</span>\n                                          {property.address && (\n                                            <span className=\"text-sm text-muted-foreground\">{property.address}</span>\n                                          )}\n                                        </div>\n                                      </CommandItem>\n                                    ))}\n                                  </CommandGroup>\n                                </CommandList>\n                              </Command>\n                            </PopoverContent>\n                          </Popover>\n                          <FormMessage />\n                        </FormItem>\n                      );\n                    }}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"priority\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Priority</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-priority\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Low</SelectItem>\n                            <SelectItem value=\"medium\">Medium</SelectItem>\n                            <SelectItem value=\"high\">High</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"description\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Description</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || \"\"} placeholder=\"Provide details...\" data-testid=\"input-description\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  {/* Image Upload Section */}\n                  <div className=\"space-y-2\">\n                    <FormLabel>Photos (Optional)</FormLabel>\n                    <ObjectUploader\n                      maxNumberOfFiles={5}\n                      onGetUploadParameters={async () => {\n                        const response = await fetch('/api/objects/upload', {\n                          method: 'POST',\n                          credentials: 'include',\n                        });\n                        const { uploadURL } = await response.json();\n                        return {\n                          method: 'PUT',\n                          url: uploadURL,\n                        };\n                      }}\n                      onComplete={async (result) => {\n                        try {\n                          if (result.successful && result.successful.length > 0) {\n                            const newPaths: string[] = [];\n                            for (const file of result.successful) {\n                              let uploadURL = file.uploadURL;\n                              \n                              // Normalize URL: if absolute, extract pathname; if relative, use as is\n                              if (uploadURL && (uploadURL.startsWith('http://') || uploadURL.startsWith('https://'))) {\n                                try {\n                                  const urlObj = new URL(uploadURL);\n                                  uploadURL = urlObj.pathname;\n                                } catch (e) {\n                                  console.error('[Maintenance] Invalid upload URL:', uploadURL);\n                                  continue; // Skip this file\n                                }\n                              }\n                              \n                              // Ensure it's a relative path starting with /objects/\n                              if (!uploadURL || !uploadURL.startsWith('/objects/')) {\n                                console.error('[Maintenance] Invalid file URL format:', uploadURL);\n                                continue; // Skip this file\n                              }\n                              \n                              // Convert to absolute URL for ACL call\n                              const absoluteUrl = `${window.location.origin}${uploadURL}`;\n                              const response = await fetch('/api/objects/set-acl', {\n                                method: 'PUT',\n                                headers: { 'Content-Type': 'application/json' },\n                                credentials: 'include',\n                                body: JSON.stringify({ photoUrl: absoluteUrl }),\n                              });\n                              \n                              if (!response.ok) {\n                                throw new Error('Failed to set photo permissions');\n                              }\n                              \n                              const { objectPath } = await response.json();\n                              newPaths.push(objectPath);\n                            }\n                            \n                            if (newPaths.length > 0) {\n                              setUploadedImages(prev => [...prev, ...newPaths]);\n                            } else {\n                              toast({\n                                title: \"Upload Error\",\n                                description: \"No photos were uploaded successfully. Please try again.\",\n                                variant: \"destructive\",\n                              });\n                            }\n                          }\n                        } catch (error) {\n                          console.error('[Maintenance] Photo upload error:', error);\n                          toast({\n                            title: \"Upload Error\",\n                            description: \"Failed to upload one or more photos. Please try again.\",\n                            variant: \"destructive\",\n                          });\n                        }\n                      }}\n                      buttonClassName=\"w-full\"\n                    >\n                      <Upload className=\"w-4 h-4 mr-2\" />\n                      Upload Photos\n                    </ObjectUploader>\n                    {uploadedImages.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 mt-2\">\n                        {uploadedImages.map((img, idx) => (\n                          <div key={idx} className=\"relative\" data-testid={`photo-preview-${idx}`}>\n                            <img \n                              src={img} \n                              alt={`Upload ${idx + 1}`} \n                              className=\"h-20 w-20 object-cover rounded border\"\n                            />\n                            <Button\n                              type=\"button\"\n                              variant=\"destructive\"\n                              size=\"icon\"\n                              className=\"absolute -top-2 -right-2 h-6 w-6\"\n                              onClick={() => setUploadedImages(prev => prev.filter((_, i) => i !== idx))}\n                              data-testid={`button-remove-photo-${idx}`}\n                            >\n                              <X className=\"h-3 w-3\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  {/* AI Analysis Button */}\n                  {uploadedImages.length > 0 && !aiSuggestions && (\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={async () => {\n                        setIsAnalyzing(true);\n                        try {\n                          await analyzeMutation.mutateAsync({\n                            imageUrl: uploadedImages[0],\n                            description: form.getValues(\"description\") || form.getValues(\"title\"),\n                          });\n                        } finally {\n                          setIsAnalyzing(false);\n                        }\n                      }}\n                      disabled={isAnalyzing}\n                      className=\"w-full\"\n                      data-testid=\"button-analyze-images\"\n                    >\n                      {isAnalyzing ? (\n                        <><Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> Analyzing...</>\n                      ) : (\n                        <><Sparkles className=\"w-4 h-4 mr-2\" /> Get AI Suggestions</>\n                      )}\n                    </Button>\n                  )}\n\n                  {/* AI Suggestions Display */}\n                  {aiSuggestions && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2 text-sm\">\n                          <Sparkles className=\"w-4 h-4 text-primary\" />\n                          AI-Suggested Fixes\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <p className=\"text-sm whitespace-pre-wrap\">{aiSuggestions}</p>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  <Button type=\"submit\" className=\"w-full\" disabled={createMutation.isPending || updateMutation.isPending} data-testid=\"button-submit-request\">\n                    {createMutation.isPending || updateMutation.isPending \n                      ? editingRequest ? \"Updating...\" : \"Creating...\" \n                      : editingRequest ? \"Update Request\" : \"Create Request\"}\n                  </Button>\n                </form>\n              </Form>\n            )}\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Tabs for Requests and Work Orders */}\n      <Tabs defaultValue=\"requests\" className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"requests\" data-testid=\"tab-requests\">\n            <Wrench className=\"w-4 h-4 mr-2\" />\n            Requests\n          </TabsTrigger>\n          {(user?.role === \"owner\" || user?.role === \"contractor\") && (\n            <TabsTrigger value=\"work-orders\" data-testid=\"tab-work-orders\">\n              <Clipboard className=\"w-4 h-4 mr-2\" />\n              Work Orders\n            </TabsTrigger>\n          )}\n        </TabsList>\n\n        {/* REQUESTS TAB */}\n        <TabsContent value=\"requests\" className=\"space-y-6\">\n          {/* Status Filter (hidden for tenants) */}\n          {user?.role !== \"tenant\" && (\n        <div className=\"flex gap-2\">\n          {[\"all\", \"open\", \"assigned\", \"in-progress\", \"completed\"].map((status) => (\n            <Button\n              key={status}\n              variant={selectedStatus === status ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setSelectedStatus(status)}\n              data-testid={`button-filter-${status}`}\n            >\n              {status === \"all\" ? \"All\" : status.charAt(0).toUpperCase() + status.slice(1).replace(\"-\", \" \")}\n            </Button>\n          ))}\n        </div>\n      )}\n\n      {/* Maintenance Requests List */}\n      <div className=\"grid gap-4\">\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : filteredRequests.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <Wrench className=\"w-12 h-12 text-muted-foreground mb-4\" />\n              <p className=\"text-lg font-semibold mb-2\" data-testid=\"text-no-requests\">No maintenance requests</p>\n              <p className=\"text-sm text-muted-foreground\">\n                {selectedStatus === \"all\" \n                  ? \"Create your first maintenance request to get started\"\n                  : `No ${selectedStatus.replace(\"-\", \" \")} requests found`}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          filteredRequests.map((request) => (\n            <Card key={request.id} data-testid={`card-request-${request.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-4\">\n                  <div className=\"flex-1\">\n                    <CardTitle className=\"text-lg mb-2\" data-testid={`text-title-${request.id}`}>\n                      {request.title}\n                    </CardTitle>\n                    <div className=\"flex flex-wrap gap-2 text-sm text-muted-foreground\">\n                      <span data-testid={`text-property-${request.id}`}>\n                        {request.property?.name || \"Unknown\"}\n                      </span>\n                      {request.property?.address && (\n                        <span> {request.property.address}</span>\n                      )}\n                      <span> Created {format(new Date(request.createdAt?.toString() || Date.now()), 'PPP')}</span>\n                    </div>\n                  </div>\n                  <div className=\"flex flex-col items-end gap-2\">\n                    <div className=\"flex items-center gap-2\">\n                      {(user?.role === \"owner\" || user?.role === \"clerk\") && (\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => handleEdit(request)}\n                          data-testid={`button-edit-${request.id}`}\n                        >\n                          <Pencil className=\"w-4 h-4\" />\n                        </Button>\n                      )}\n                      <div className=\"flex flex-col gap-2\">\n                        {getPriorityBadge(request.priority)}\n                        {getStatusBadge(request.status)}\n                      </div>\n                    </div>\n                    {(user?.role === \"owner\" || user?.role === \"clerk\") && (\n                      <FixfloSyncButton\n                        requestId={request.id}\n                        propertyId={request.propertyId}\n                        fixfloIssueId={request.fixfloIssueId}\n                        fixfloStatus={request.fixfloStatus}\n                        fixfloContractorName={request.fixfloContractorName}\n                        title={request.title}\n                      />\n                    )}\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {request.description && (\n                  <p className=\"text-sm text-muted-foreground\" data-testid={`text-description-${request.id}`}>\n                    {request.description}\n                  </p>\n                )}\n                \n                <div className=\"flex items-center justify-between gap-4 pt-4 border-t\">\n                  <div className=\"text-sm\">\n                    <span className=\"text-muted-foreground\">Reported by: </span>\n                    <span data-testid={`text-reporter-${request.id}`}>\n                      {request.reportedByUser \n                        ? `${request.reportedByUser.firstName} ${request.reportedByUser.lastName}`\n                        : \"Unknown\"}\n                    </span>\n                    {request.assignedToUser && (\n                      <>\n                        <span className=\"text-muted-foreground\">  Assigned to: </span>\n                        <span data-testid={`text-assignee-${request.id}`}>\n                          {request.assignedToUser.firstName} {request.assignedToUser.lastName}\n                        </span>\n                      </>\n                    )}\n                  </div>\n                  \n                  {user?.role === \"owner\" && request.status !== \"completed\" && (\n                    <div className=\"flex gap-2\">\n                      <Select\n                        value={request.status}\n                        onValueChange={(status) => \n                          updateStatusMutation.mutate({ id: request.id, status })\n                        }\n                      >\n                        <SelectTrigger className=\"w-40\" data-testid={`select-status-${request.id}`}>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"open\" data-testid={`option-status-open-${request.id}`}>Open</SelectItem>\n                          <SelectItem value=\"assigned\" data-testid={`option-status-assigned-${request.id}`}>Assigned</SelectItem>\n                          <SelectItem value=\"in-progress\" data-testid={`option-status-progress-${request.id}`}>In Progress</SelectItem>\n                          <SelectItem value=\"completed\" data-testid={`option-status-completed-${request.id}`}>Completed</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      \n                      {!request.assignedTo && clerks.length > 0 && (\n                        <Select\n                          onValueChange={(assignedTo) =>\n                            updateStatusMutation.mutate({ \n                              id: request.id, \n                              status: \"assigned\",\n                              assignedTo \n                            })\n                          }\n                        >\n                          <SelectTrigger className=\"w-40\" data-testid={`select-assign-${request.id}`}>\n                            <SelectValue placeholder=\"Assign to...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {clerks.map((clerk) => (\n                                <SelectItem \n                                  key={clerk.id} \n                                  value={clerk.id}\n                                  data-testid={`option-clerk-${clerk.id}`}\n                                >\n                                  {clerk.firstName} {clerk.lastName}\n                                </SelectItem>\n                              ))}\n                          </SelectContent>\n                        </Select>\n                      )}\n                      \n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setSelectedRequestForWorkOrder(request);\n                          setIsWorkOrderDialogOpen(true);\n                        }}\n                        data-testid={`button-create-work-order-${request.id}`}\n                      >\n                        <Clipboard className=\"w-4 h-4 mr-2\" />\n                        Create Work Order\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n        </TabsContent>\n\n        {/* WORK ORDERS TAB */}\n        <TabsContent value=\"work-orders\" className=\"space-y-6\">\n          {workOrdersLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading work orders...</div>\n          ) : workOrders.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <UserIcon className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No work orders</h3>\n                <p className=\"text-muted-foreground text-center\">\n                  {user?.role === \"contractor\"\n                    ? \"You don't have any assigned work orders yet\"\n                    : \"Create work orders from maintenance requests\"}\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4\">\n              {workOrders.map((workOrder) => (\n                <Card key={workOrder.id} data-testid={`card-work-order-${workOrder.id}`}>\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                          {getWorkOrderStatusIcon(workOrder.status)}\n                          <CardTitle className=\"text-lg\">\n                            {workOrder.maintenanceRequest.title}\n                          </CardTitle>\n                          <Badge className={priorityColors[workOrder.maintenanceRequest.priority]}>\n                            {workOrder.maintenanceRequest.priority}\n                          </Badge>\n                        </div>\n                        <CardDescription>\n                          {workOrder.maintenanceRequest.description || \"No description provided\"}\n                        </CardDescription>\n                      </div>\n                      <Badge className={workOrderStatusColors[workOrder.status]}>\n                        {workOrder.status.replace(\"_\", \" \")}\n                      </Badge>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                      {workOrder.team && (\n                        <div className=\"flex items-center gap-2 text-sm\">\n                          <UserIcon className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <p className=\"font-medium\">Assigned Team</p>\n                            <p className=\"text-muted-foreground\" data-testid={`text-team-${workOrder.id}`}>\n                              {workOrder.team.name}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n\n                      {workOrder.contractor && (\n                        <div className=\"flex items-center gap-2 text-sm\">\n                          <UserIcon className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <p className=\"font-medium\">Contractor</p>\n                            <p className=\"text-muted-foreground\">\n                              {workOrder.contractor.firstName} {workOrder.contractor.lastName}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n\n                      {workOrder.slaDue && (\n                        <div className=\"flex items-center gap-2 text-sm\">\n                          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <p className=\"font-medium\">SLA Due</p>\n                            <p className=\"text-muted-foreground\">\n                              {formatDistanceToNow(new Date(workOrder.slaDue), { addSuffix: true })}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n\n                      {(workOrder.costEstimate || workOrder.costActual) && (\n                        <div className=\"flex items-center gap-2 text-sm\">\n                          <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <p className=\"font-medium\">Cost</p>\n                            <p className=\"text-muted-foreground\">\n                              {workOrder.costActual \n                                ? `Actual: ${formatCurrency(workOrder.costActual)}`\n                                : `Est: ${formatCurrency(workOrder.costEstimate)}`}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                        <div>\n                          <p className=\"font-medium\">Created</p>\n                          <p className=\"text-muted-foreground\">\n                            {formatDistanceToNow(new Date(workOrder.createdAt), { addSuffix: true })}\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n\n                    {user?.role === \"contractor\" && workOrder.status !== \"completed\" && workOrder.status !== \"rejected\" && (\n                      <div className=\"mt-4 flex items-center gap-2\">\n                        <label className=\"text-sm font-medium\">Update Status:</label>\n                        <Select\n                          value={workOrder.status}\n                          onValueChange={(status) => updateWorkOrderStatusMutation.mutate({ id: workOrder.id, status })}\n                        >\n                          <SelectTrigger className=\"w-48\" data-testid={`select-work-order-status-${workOrder.id}`}>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"assigned\">Assigned</SelectItem>\n                            <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                            <SelectItem value=\"waiting_parts\">Waiting Parts</SelectItem>\n                            <SelectItem value=\"completed\">Completed</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Work Order Creation Dialog */}\n      {selectedRequestForWorkOrder && (\n        <Dialog open={isWorkOrderDialogOpen} onOpenChange={setIsWorkOrderDialogOpen}>\n          <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-create-work-order\">\n            <DialogHeader>\n              <DialogTitle>Create Work Order</DialogTitle>\n              <DialogDescription>\n                Create a work order from maintenance request: {selectedRequestForWorkOrder.title}\n              </DialogDescription>\n            </DialogHeader>\n            <WorkOrderForm\n              maintenanceRequest={selectedRequestForWorkOrder}\n              teams={teams}\n              contractors={contractors}\n              onSubmit={(data) => createWorkOrderMutation.mutate(data)}\n              isSubmitting={createWorkOrderMutation.isPending}\n            />\n          </DialogContent>\n        </Dialog>\n      )}\n    </div>\n  );\n}\n\n// Work Order Creation Form Component\nfunction WorkOrderForm({\n  maintenanceRequest,\n  teams,\n  contractors,\n  onSubmit,\n  isSubmitting,\n}: {\n  maintenanceRequest: MaintenanceRequestWithDetails;\n  teams: any[];\n  contractors: any[];\n  onSubmit: (data: any) => void;\n  isSubmitting: boolean;\n}) {\n  const [selectedTeamId, setSelectedTeamId] = useState<string>(\"\");\n  const [selectedContractorId, setSelectedContractorId] = useState<string>(\"\");\n  const [slaDue, setSlaDue] = useState<string>(\"\");\n  const [costEstimate, setCostEstimate] = useState<string>(\"\");\n\n  // Auto-suggest team based on maintenance request category\n  useEffect(() => {\n    if (maintenanceRequest.category && teams.length > 0) {\n      // Find team that has this category assigned\n      const suggestedTeam = teams.find((team: any) => \n        team.categories?.includes(maintenanceRequest.category)\n      );\n      if (suggestedTeam) {\n        setSelectedTeamId(suggestedTeam.id);\n      }\n    }\n  }, [maintenanceRequest.category, teams]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    onSubmit({\n      maintenanceRequestId: maintenanceRequest.id,\n      teamId: selectedTeamId || undefined,\n      contractorId: selectedContractorId || undefined,\n      slaDue: slaDue ? new Date(slaDue).toISOString() : undefined,\n      costEstimate: costEstimate ? Math.round(parseFloat(costEstimate) * 100) : undefined,\n      status: \"assigned\",\n    });\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <label className=\"text-sm font-medium\" htmlFor=\"team\">\n          Assign to Team\n          {maintenanceRequest.category && selectedTeamId && (\n            <span className=\"ml-2 text-xs text-muted-foreground\">(Auto-suggested based on category)</span>\n          )}\n        </label>\n        <Select value={selectedTeamId} onValueChange={setSelectedTeamId}>\n          <SelectTrigger id=\"team\" data-testid=\"select-team\">\n            <SelectValue placeholder=\"Select a team (optional)\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"none\">None</SelectItem>\n            {teams.map((team: any) => (\n              <SelectItem key={team.id} value={team.id} data-testid={`option-team-${team.id}`}>\n                {team.name}\n                {team.email && ` (${team.email})`}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <label className=\"text-sm font-medium\" htmlFor=\"contractor\">\n          Assign to Contractor\n        </label>\n        <Select value={selectedContractorId} onValueChange={setSelectedContractorId}>\n          <SelectTrigger id=\"contractor\" data-testid=\"select-contractor\">\n            <SelectValue placeholder=\"Select a contractor (optional)\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"none\">None</SelectItem>\n            {contractors.filter((c: any) => c.role === \"contractor\").map((contractor: any) => (\n              <SelectItem key={contractor.id} value={contractor.id} data-testid={`option-contractor-${contractor.id}`}>\n                {contractor.firstName} {contractor.lastName}\n                {contractor.email && ` (${contractor.email})`}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <label className=\"text-sm font-medium\" htmlFor=\"sla-due\">\n          SLA Due Date\n        </label>\n        <Input\n          id=\"sla-due\"\n          type=\"datetime-local\"\n          value={slaDue}\n          onChange={(e) => setSlaDue(e.target.value)}\n          data-testid=\"input-sla-due\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <label className=\"text-sm font-medium\" htmlFor=\"cost-estimate\">\n          Cost Estimate ({locale.currencySymbol})\n        </label>\n        <Input\n          id=\"cost-estimate\"\n          type=\"number\"\n          step=\"0.01\"\n          placeholder=\"0.00\"\n          value={costEstimate}\n          onChange={(e) => setCostEstimate(e.target.value)}\n          data-testid=\"input-cost-estimate\"\n        />\n      </div>\n\n      <div className=\"flex justify-end gap-2 pt-4\">\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          onClick={() => {}}\n          disabled={isSubmitting}\n          data-testid=\"button-cancel-work-order\"\n        >\n          Cancel\n        </Button>\n        <Button\n          type=\"submit\"\n          disabled={isSubmitting}\n          data-testid=\"button-submit-work-order\"\n        >\n          {isSubmitting ? (\n            <>\n              <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n              Creating...\n            </>\n          ) : (\n            \"Create Work Order\"\n          )}\n        </Button>\n      </div>\n    </form>\n  );\n}\n","size_bytes":64126},"client/src/pages/OrganizationSetup.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Building2 } from \"lucide-react\";\n\nconst organizationSchema = z.object({\n  name: z.string().min(2, \"Organization name must be at least 2 characters\"),\n});\n\ntype OrganizationForm = z.infer<typeof organizationSchema>;\n\nexport default function OrganizationSetup() {\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const form = useForm<OrganizationForm>({\n    resolver: zodResolver(organizationSchema),\n    defaultValues: {\n      name: \"\",\n    },\n  });\n\n  const createOrgMutation = useMutation({\n    mutationFn: async (data: OrganizationForm) => {\n      return await apiRequest(\"POST\", \"/api/organizations\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Success\",\n        description: \"Organization created successfully!\",\n      });\n      // Navigate to dashboard after creating organization\n      setTimeout(() => {\n        navigate(\"/dashboard\");\n      }, 500);\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create organization\",\n      });\n    },\n  });\n\n  const onSubmit = async (data: OrganizationForm) => {\n    setIsSubmitting(true);\n    try {\n      await createOrgMutation.mutateAsync(data);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center\">\n              <Building2 className=\"w-8 h-8 text-primary\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl\">Welcome to Inspect360</CardTitle>\n          <CardDescription>\n            Let's get started by creating your organization\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Organization Name</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Acme Property Management\" \n                        {...field} \n                        data-testid=\"input-org-name\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      This is the name of your property management company\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={isSubmitting}\n                data-testid=\"button-create-org\"\n              >\n                {isSubmitting ? \"Creating...\" : \"Create Organization\"}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":4027},"client/src/pages/Team.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Users, Mail, Phone, MapPin, Plus, Upload, X, GraduationCap, Briefcase, Tag, FileText, Search, Filter } from \"lucide-react\";\nimport type { User } from \"@shared/schema\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { AddressInput } from \"@/components/AddressInput\";\nimport { PhoneInput } from \"@/components/PhoneInput\";\n\nexport default function Team() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  \n  // Filter states\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState<string>(\"all\");\n  const [skillsFilter, setSkillsFilter] = useState(\"\");\n  const [educationFilter, setEducationFilter] = useState(\"\");\n  \n  // Form states\n  const [firstName, setFirstName] = useState(\"\");\n  const [lastName, setLastName] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  const [role, setRole] = useState<string>(\"clerk\");\n  const [skills, setSkills] = useState<string[]>([]);\n  const [skillInput, setSkillInput] = useState(\"\");\n  const [education, setEducation] = useState(\"\");\n  const [profileImageUrl, setProfileImageUrl] = useState(\"\");\n  const [certificateUrls, setCertificateUrls] = useState<string[]>([]);\n  const [address, setAddress] = useState({\n    street: \"\",\n    city: \"\",\n    state: \"\",\n    postalCode: \"\",\n    country: \"\",\n    formatted: \"\"\n  });\n\n  const { data: teamMembers, isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/team\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest(\"POST\", \"/api/team\", data);\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ message: \"Unknown error\" }));\n        throw new Error(errorData.message || errorData.errors?.[0]?.message || `Server error: ${res.status}`);\n      }\n      return await res.json();\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/team\"] });\n      toast({ title: \"Team member created successfully\" });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      console.error('[Team] Create error:', error);\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create team member\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ userId, data }: { userId: string; data: any }) => {\n      const res = await apiRequest(\"PATCH\", `/api/team/${userId}`, data);\n      return await res.json();\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/team\"] });\n      toast({ title: \"Team member updated successfully\" });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update team member\",\n      });\n    },\n  });\n\n  const updateRoleMutation = useMutation({\n    mutationFn: async ({ userId, role }: { userId: string; role: string }) => {\n      return await apiRequest(\"PATCH\", `/api/team/${userId}/role`, { role });\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/team\"] });\n      toast({ title: \"Role updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update role\",\n      });\n    },\n  });\n\n  const toggleStatusMutation = useMutation({\n    mutationFn: async ({ userId, isActive }: { userId: string; isActive: boolean }) => {\n      return await apiRequest(\"PATCH\", `/api/team/${userId}/status`, { isActive });\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/team\"] });\n      toast({ \n        title: \"Status updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update status\",\n      });\n    },\n  });\n\n  const handleOpenCreate = () => {\n    setEditingUser(null);\n    resetForm();\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (user: User) => {\n    setEditingUser(user);\n    setFirstName(user.firstName || \"\");\n    setLastName(user.lastName || \"\");\n    setEmail(user.email);\n    setUsername(user.username);\n    setPassword(\"\"); // Don't show existing password\n    setPhone(user.phone || \"\");\n    setRole(user.role);\n    setSkills(user.skills || []);\n    setEducation(user.education || \"\");\n    setProfileImageUrl(user.profileImageUrl || \"\");\n    setCertificateUrls(user.certificateUrls || []);\n    setAddress({\n      street: user.address?.street || \"\",\n      city: user.address?.city || \"\",\n      state: user.address?.state || \"\",\n      postalCode: user.address?.postalCode || \"\",\n      country: user.address?.country || \"\",\n      formatted: user.address?.formatted || \"\"\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingUser(null);\n    resetForm();\n  };\n\n  const resetForm = () => {\n    setFirstName(\"\");\n    setLastName(\"\");\n    setEmail(\"\");\n    setUsername(\"\");\n    setPassword(\"\");\n    setPhone(\"\");\n    setRole(\"clerk\");\n    setSkills([]);\n    setSkillInput(\"\");\n    setEducation(\"\");\n    setProfileImageUrl(\"\");\n    setCertificateUrls([]);\n    setAddress({\n      street: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"\",\n      formatted: \"\"\n    });\n  };\n\n  const handleSubmit = () => {\n    // Validate required fields\n    if (!email || !email.trim()) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Email is required\",\n      });\n      return;\n    }\n    \n    // Validate email format\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(email.trim())) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Please enter a valid email address\",\n      });\n      return;\n    }\n    \n    if (!username || !username.trim()) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Username is required\",\n      });\n      return;\n    }\n    \n    if (username.trim().length < 3) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Username must be at least 3 characters\",\n      });\n      return;\n    }\n\n    if (!editingUser && (!password || password.length < 6)) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Password is required and must be at least 6 characters\",\n      });\n      return;\n    }\n    \n    // Validate role\n    const validRoles = [\"owner\", \"clerk\", \"compliance\", \"tenant\", \"contractor\"];\n    if (!validRoles.includes(role)) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Please select a valid role\",\n      });\n      return;\n    }\n\n    // Check if any address field has data\n    const hasAddress = address.street || address.city || address.state || address.postalCode || address.country;\n    \n    // Generate formatted address if we have address data\n    const formattedAddress = hasAddress ? {\n      ...address,\n      formatted: [address.street, address.city, address.state, address.postalCode, address.country]\n        .filter(Boolean)\n        .join(\", \")\n    } : undefined;\n\n    if (editingUser) {\n      // For updates: exclude email, username, password (not allowed in updateTeamMemberSchema)\n      const updateData = {\n        firstName,\n        lastName,\n        phone,\n        role,\n        skills,\n        education,\n        profileImageUrl: profileImageUrl || \"\",\n        certificateUrls: certificateUrls.filter(url => {\n          const trimmed = url.trim();\n          // Filter out empty strings and ensure valid format\n          return trimmed !== \"\" && (trimmed.startsWith(\"/objects/\") || trimmed.startsWith(\"http://\") || trimmed.startsWith(\"https://\"));\n        }),\n        address: formattedAddress,\n      };\n      updateMutation.mutate({ userId: editingUser.id, data: updateData });\n    } else {\n      // For creates: include all fields\n      // Validate profileImageUrl format\n      let validProfileImageUrl: string | undefined = undefined;\n      if (profileImageUrl && profileImageUrl.trim() !== \"\") {\n        const trimmed = profileImageUrl.trim();\n        if (trimmed.startsWith(\"/objects/\") || trimmed.startsWith(\"http://\") || trimmed.startsWith(\"https://\")) {\n          validProfileImageUrl = trimmed;\n        } else {\n          toast({\n            variant: \"destructive\",\n            title: \"Validation Error\",\n            description: \"Profile image URL must be a valid URL or start with /objects/\",\n          });\n          return;\n        }\n      }\n      \n      // Filter and validate certificateUrls\n      const validCertificateUrls = certificateUrls\n        .map(url => url.trim())\n        .filter(url => {\n          if (url === \"\") return false;\n          // Must be a valid URL or start with /objects/\n          return url.startsWith(\"/objects/\") || url.startsWith(\"http://\") || url.startsWith(\"https://\");\n        });\n      \n      const createData = {\n        firstName: firstName.trim() || undefined,\n        lastName: lastName.trim() || undefined,\n        email: email.trim(),\n        username: username.trim(),\n        password: password.trim(),\n        phone: phone.trim() || undefined,\n        role,\n        skills: skills.length > 0 ? skills : undefined,\n        education: education.trim() || undefined,\n        profileImageUrl: validProfileImageUrl || undefined,\n        certificateUrls: validCertificateUrls.length > 0 ? validCertificateUrls : undefined,\n        address: formattedAddress,\n      };\n      \n      console.log('[Team] Creating team member with data:', { ...createData, password: '***' });\n      createMutation.mutate(createData);\n    }\n  };\n\n  const addSkill = () => {\n    if (skillInput.trim() && !skills.includes(skillInput.trim())) {\n      setSkills([...skills, skillInput.trim()]);\n      setSkillInput(\"\");\n    }\n  };\n\n  const removeSkill = (skill: string) => {\n    setSkills(skills.filter(s => s !== skill));\n  };\n\n  const getRoleBadgeVariant = (role: string) => {\n    switch (role) {\n      case \"owner\":\n        return \"default\";\n      case \"clerk\":\n        return \"secondary\";\n      case \"compliance\":\n        return \"outline\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getRoleLabel = (role: string) => {\n    switch (role) {\n      case \"owner\":\n        return \"Owner/Operator\";\n      case \"clerk\":\n        return \"Inventory Clerk\";\n      case \"compliance\":\n        return \"Compliance Officer\";\n      case \"tenant\":\n        return \"Tenant\";\n      default:\n        return role.charAt(0).toUpperCase() + role.slice(1);\n    }\n  };\n\n  const formatAddress = (addr: any) => {\n    if (!addr) return \"\";\n    return addr.formatted || [addr.street, addr.city, addr.state, addr.postalCode, addr.country].filter(Boolean).join(\", \");\n  };\n\n  // Filter team members based on search and filter criteria\n  const filteredTeamMembers = teamMembers?.filter((member) => {\n    // Search query filter (name, email, username)\n    if (searchQuery) {\n      const query = searchQuery.toLowerCase();\n      const matchesName = `${member.firstName} ${member.lastName}`.toLowerCase().includes(query);\n      const matchesEmail = member.email?.toLowerCase().includes(query);\n      const matchesUsername = member.username?.toLowerCase().includes(query);\n      \n      if (!matchesName && !matchesEmail && !matchesUsername) {\n        return false;\n      }\n    }\n\n    // Role filter\n    if (roleFilter !== \"all\" && member.role !== roleFilter) {\n      return false;\n    }\n\n    // Skills filter\n    if (skillsFilter) {\n      const skillQuery = skillsFilter.toLowerCase();\n      const hasMatchingSkill = member.skills?.some(skill => \n        skill.toLowerCase().includes(skillQuery)\n      );\n      if (!hasMatchingSkill) {\n        return false;\n      }\n    }\n\n    // Education filter\n    if (educationFilter) {\n      const eduQuery = educationFilter.toLowerCase();\n      if (!member.education?.toLowerCase().includes(eduQuery)) {\n        return false;\n      }\n    }\n\n    return true;\n  }) || [];\n\n  const clearFilters = () => {\n    setSearchQuery(\"\");\n    setRoleFilter(\"all\");\n    setSkillsFilter(\"\");\n    setEducationFilter(\"\");\n  };\n\n  const hasActiveFilters = searchQuery || roleFilter !== \"all\" || skillsFilter || educationFilter;\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 md:p-8 lg:p-12\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <Users className=\"w-8 h-8 text-primary\" />\n          <div>\n            <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Team Management</h1>\n            <p className=\"text-lg text-muted-foreground mt-1\">Loading team members...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 md:p-8 lg:p-12 space-y-8\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Team Management</h1>\n          <p className=\"text-lg text-muted-foreground mt-1\">Manage your team members and their profiles</p>\n        </div>\n        <Button onClick={handleOpenCreate} size=\"lg\" data-testid=\"button-create-team-member\">\n          <Plus className=\"mr-2 h-5 w-5\" />\n          Add Team Member\n        </Button>\n      </div>\n\n      {/* Filters */}\n      <Card className=\"p-6\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Filter className=\"w-5 h-5 text-primary\" />\n          <h2 className=\"text-lg font-semibold\">Filter Team Members</h2>\n          {hasActiveFilters && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={clearFilters}\n              className=\"ml-auto\"\n              data-testid=\"button-clear-filters\"\n            >\n              Clear Filters\n            </Button>\n          )}\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {/* Search */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"search\">Search</Label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                id=\"search\"\n                placeholder=\"Name, email, username...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-team\"\n              />\n            </div>\n          </div>\n\n          {/* Role Filter */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"role-filter\">Role</Label>\n            <Select value={roleFilter} onValueChange={setRoleFilter}>\n              <SelectTrigger id=\"role-filter\" data-testid=\"select-role-filter\">\n                <SelectValue placeholder=\"All Roles\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Roles</SelectItem>\n                <SelectItem value=\"owner\">Owner/Operator</SelectItem>\n                <SelectItem value=\"clerk\">Inventory Clerk</SelectItem>\n                <SelectItem value=\"compliance\">Compliance Officer</SelectItem>\n                <SelectItem value=\"tenant\">Tenant</SelectItem>\n                <SelectItem value=\"contractor\">Contractor</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Skills Filter */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"skills-filter\">Skills</Label>\n            <div className=\"relative\">\n              <Tag className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                id=\"skills-filter\"\n                placeholder=\"e.g., Property Inspector\"\n                value={skillsFilter}\n                onChange={(e) => setSkillsFilter(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-skills-filter\"\n              />\n            </div>\n          </div>\n\n          {/* Education Filter */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"education-filter\">Education</Label>\n            <div className=\"relative\">\n              <GraduationCap className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                id=\"education-filter\"\n                placeholder=\"e.g., MBA, Bachelor\"\n                value={educationFilter}\n                onChange={(e) => setEducationFilter(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-education-filter\"\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* Results count */}\n        <div className=\"mt-4 text-sm text-muted-foreground\">\n          Showing {filteredTeamMembers.length} of {teamMembers?.length || 0} team members\n          {hasActiveFilters && \" (filtered)\"}\n        </div>\n      </Card>\n\n      {/* Team Members List */}\n      <div className=\"grid gap-6\">\n        {filteredTeamMembers.length > 0 ? (\n          filteredTeamMembers.map((member) => (\n            <Card key={member.id} className=\"hover-elevate\" data-testid={`card-team-member-${member.id}`}>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-start gap-6\">\n                  {/* Avatar */}\n                  <Avatar className=\"h-16 w-16\" key={`avatar-${member.id}-${member.profileImageUrl || 'no-image'}`}>\n                    <AvatarImage src={member.profileImageUrl || undefined} />\n                    <AvatarFallback className=\"bg-primary/10 text-primary text-lg\">\n                      {member.firstName?.[0]}{member.lastName?.[0]}\n                    </AvatarFallback>\n                  </Avatar>\n\n                  {/* Main Info */}\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-3 mb-2 flex-wrap\">\n                      <h3 className=\"text-xl font-semibold\" data-testid={`text-name-${member.id}`}>\n                        {member.firstName && member.lastName\n                          ? `${member.firstName} ${member.lastName}`\n                          : member.username}\n                      </h3>\n                      <Badge variant={getRoleBadgeVariant(member.role)} data-testid={`badge-role-${member.id}`}>\n                        {getRoleLabel(member.role)}\n                      </Badge>\n                      <Badge \n                        variant={member.isActive ? \"default\" : \"secondary\"} \n                        data-testid={`badge-status-${member.id}`}\n                      >\n                        {member.isActive ? \"Active\" : \"Inactive\"}\n                      </Badge>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-muted-foreground\">\n                      {member.email && (\n                        <div className=\"flex items-center gap-2\">\n                          <Mail className=\"w-4 h-4\" />\n                          <span>{member.email}</span>\n                        </div>\n                      )}\n                      {member.phone && (\n                        <div className=\"flex items-center gap-2\">\n                          <Phone className=\"w-4 h-4\" />\n                          <span>{member.phone}</span>\n                        </div>\n                      )}\n                      {member.address && (\n                        <div className=\"flex items-center gap-2 md:col-span-2\">\n                          <MapPin className=\"w-4 h-4 flex-shrink-0\" />\n                          <span className=\"truncate\">{formatAddress(member.address)}</span>\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Skills */}\n                    {member.skills && member.skills.length > 0 && (\n                      <div className=\"flex items-center gap-2 mt-3 flex-wrap\">\n                        <Briefcase className=\"w-4 h-4 text-muted-foreground\" />\n                        {member.skills.map((skill, idx) => (\n                          <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                            {skill}\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Actions */}\n                  <div className=\"flex flex-col gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleOpenEdit(member)}\n                      data-testid={`button-edit-${member.id}`}\n                    >\n                      Edit Profile\n                    </Button>\n                    <Button\n                      variant={member.isActive ? \"destructive\" : \"default\"}\n                      size=\"sm\"\n                      onClick={() => toggleStatusMutation.mutate({ userId: member.id, isActive: !member.isActive })}\n                      disabled={toggleStatusMutation.isPending}\n                      data-testid={`button-toggle-status-${member.id}`}\n                    >\n                      {member.isActive ? \"Disable Account\" : \"Enable Account\"}\n                    </Button>\n                    <Select\n                      value={member.role}\n                      onValueChange={(role) => updateRoleMutation.mutate({ userId: member.id, role })}\n                      disabled={updateRoleMutation.isPending}\n                    >\n                      <SelectTrigger className=\"w-40\" data-testid={`select-role-${member.id}`}>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"owner\">Owner/Operator</SelectItem>\n                        <SelectItem value=\"clerk\">Inventory Clerk</SelectItem>\n                        <SelectItem value=\"compliance\">Compliance Officer</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        ) : (\n          <Card>\n            <CardContent className=\"p-12 text-center\">\n              {hasActiveFilters ? (\n                <>\n                  <Search className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <h3 className=\"text-lg font-semibold mb-2\">No Matching Team Members</h3>\n                  <p className=\"text-muted-foreground mb-4\">\n                    No team members match your current filters. Try adjusting your search criteria.\n                  </p>\n                  <Button onClick={clearFilters} variant=\"outline\">\n                    <X className=\"mr-2 h-4 w-4\" />\n                    Clear Filters\n                  </Button>\n                </>\n              ) : (\n                <>\n                  <Users className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                  <h3 className=\"text-lg font-semibold mb-2\">No Team Members</h3>\n                  <p className=\"text-muted-foreground mb-4\">\n                    Add your first team member to get started\n                  </p>\n                  <Button onClick={handleOpenCreate}>\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Add Team Member\n                  </Button>\n                </>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingUser ? \"Edit Team Member\" : \"Add Team Member\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingUser\n                ? \"Update team member profile information\"\n                : \"Create a new team member with complete profile\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <Tabs defaultValue=\"basic\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"basic\">Basic Info</TabsTrigger>\n              <TabsTrigger value=\"professional\">Professional</TabsTrigger>\n              <TabsTrigger value=\"documents\">Documents</TabsTrigger>\n            </TabsList>\n\n            {/* Basic Info Tab */}\n            <TabsContent value=\"basic\" className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"firstName\">First Name *</Label>\n                  <Input\n                    id=\"firstName\"\n                    value={firstName}\n                    onChange={(e) => setFirstName(e.target.value)}\n                    placeholder=\"John\"\n                    data-testid=\"input-first-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"lastName\">Last Name *</Label>\n                  <Input\n                    id=\"lastName\"\n                    value={lastName}\n                    onChange={(e) => setLastName(e.target.value)}\n                    placeholder=\"Doe\"\n                    data-testid=\"input-last-name\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email Address *</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  placeholder=\"john.doe@example.com\"\n                  data-testid=\"input-email\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Username *</Label>\n                <Input\n                  id=\"username\"\n                  value={username}\n                  onChange={(e) => setUsername(e.target.value)}\n                  placeholder=\"johndoe\"\n                  data-testid=\"input-username\"\n                />\n              </div>\n\n              {!editingUser && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"password\">Password *</Label>\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    placeholder=\"Enter password\"\n                    data-testid=\"input-password\"\n                  />\n                </div>\n              )}\n\n              <div className=\"space-y-2\">\n                <PhoneInput\n                  id=\"phone\"\n                  value={phone}\n                  onChange={(value) => setPhone(value)}\n                  placeholder=\"Enter phone number\"\n                  data-testid=\"input-phone\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"role\">Role / Permission Level *</Label>\n                <Select value={role} onValueChange={setRole}>\n                  <SelectTrigger data-testid=\"select-role\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"owner\">Owner/Operator</SelectItem>\n                    <SelectItem value=\"clerk\">Inventory Clerk</SelectItem>\n                    <SelectItem value=\"compliance\">Compliance Officer</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* Address Fields */}\n              <div className=\"space-y-4 border-t pt-4\">\n                <Label className=\"text-base font-semibold flex items-center gap-2\">\n                  <MapPin className=\"w-4 h-4\" />\n                  Address\n                </Label>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"street\">Street Address</Label>\n                  <AddressInput\n                    id=\"street\"\n                    value={address.street}\n                    onChange={(value) => setAddress({ ...address, street: value, formatted: \"\" })}\n                    placeholder=\"123 Main Street\"\n                    data-testid=\"input-street\"\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"city\">City</Label>\n                    <Input\n                      id=\"city\"\n                      value={address.city}\n                      onChange={(e) => setAddress({ ...address, city: e.target.value, formatted: \"\" })}\n                      placeholder=\"London\"\n                      data-testid=\"input-city\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"state\">State/County</Label>\n                    <Input\n                      id=\"state\"\n                      value={address.state}\n                      onChange={(e) => setAddress({ ...address, state: e.target.value, formatted: \"\" })}\n                      placeholder=\"Greater London\"\n                      data-testid=\"input-state\"\n                    />\n                  </div>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"postalCode\">Postal Code</Label>\n                    <Input\n                      id=\"postalCode\"\n                      value={address.postalCode}\n                      onChange={(e) => setAddress({ ...address, postalCode: e.target.value, formatted: \"\" })}\n                      placeholder=\"W1A 1AA\"\n                      data-testid=\"input-postal-code\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"country\">Country</Label>\n                    <Input\n                      id=\"country\"\n                      value={address.country}\n                      onChange={(e) => setAddress({ ...address, country: e.target.value, formatted: \"\" })}\n                      placeholder=\"United Kingdom\"\n                      data-testid=\"input-country\"\n                    />\n                  </div>\n                </div>\n              </div>\n            </TabsContent>\n\n            {/* Professional Tab */}\n            <TabsContent value=\"professional\" className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-base font-semibold flex items-center gap-2\">\n                  <Briefcase className=\"w-4 h-4\" />\n                  Skills\n                </Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    value={skillInput}\n                    onChange={(e) => setSkillInput(e.target.value)}\n                    onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addSkill())}\n                    placeholder=\"Add a skill and press Enter\"\n                    data-testid=\"input-skill\"\n                  />\n                  <Button type=\"button\" onClick={addSkill} variant=\"outline\">\n                    <Plus className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n                <div className=\"flex flex-wrap gap-2 mt-2\">\n                  {skills.map((skill, idx) => (\n                    <Badge key={idx} variant=\"secondary\" className=\"gap-2\">\n                      {skill}\n                      <X\n                        className=\"w-3 h-3 cursor-pointer\"\n                        onClick={() => removeSkill(skill)}\n                      />\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"education\" className=\"text-base font-semibold flex items-center gap-2\">\n                  <GraduationCap className=\"w-4 h-4\" />\n                  Education\n                </Label>\n                <Textarea\n                  id=\"education\"\n                  value={education}\n                  onChange={(e) => setEducation(e.target.value)}\n                  placeholder=\"Enter educational background, certifications, degrees...\"\n                  rows={4}\n                  data-testid=\"textarea-education\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"profileImage\">Profile Image</Label>\n                <ObjectUploader\n                  maxNumberOfFiles={1}\n                  onGetUploadParameters={async () => {\n                    const response = await fetch('/api/objects/upload', {\n                      method: 'POST',\n                      credentials: 'include',\n                    });\n                    const { uploadURL } = await response.json();\n                    return {\n                      method: 'PUT',\n                      url: uploadURL,\n                    };\n                  }}\n                  onComplete={async (result) => {\n                    try {\n                      if (result.successful && result.successful.length > 0) {\n                        let fileUrl = result.successful[0].uploadURL;\n                        \n                        // Normalize URL: if absolute, extract pathname; if relative, use as is\n                        if (fileUrl && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {\n                          try {\n                            const urlObj = new URL(fileUrl);\n                            fileUrl = urlObj.pathname;\n                          } catch (e) {\n                            console.error('[Team] Invalid file URL:', fileUrl);\n                            throw new Error('Invalid file URL format');\n                          }\n                        }\n                        \n                        // Ensure it's a valid file path (should start with /objects/)\n                        if (!fileUrl || !fileUrl.startsWith('/objects/')) {\n                          console.error('[Team] Invalid file URL format:', fileUrl);\n                          throw new Error('Invalid file URL format. Expected path starting with /objects/');\n                        }\n                        \n                        // Convert to absolute URL for ACL call\n                        const absoluteUrl = `${window.location.origin}${fileUrl}`;\n                        \n                        const response = await fetch('/api/objects/set-acl', {\n                          method: 'PUT',\n                          headers: { 'Content-Type': 'application/json' },\n                          credentials: 'include',\n                          body: JSON.stringify({ photoUrl: absoluteUrl }),\n                        });\n                        \n                        if (!response.ok) {\n                          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n                          throw new Error(errorData.error || 'Failed to set photo permissions');\n                        }\n                        \n                        const { objectPath } = await response.json();\n                        setProfileImageUrl(objectPath || fileUrl);\n                      }\n                    } catch (error: any) {\n                      console.error('[Team] Profile image upload error:', error);\n                      toast({\n                        title: \"Upload Error\",\n                        description: error.message || \"Failed to upload profile image. Please try again.\",\n                        variant: \"destructive\",\n                      });\n                    }\n                  }}\n                  buttonClassName=\"w-full\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Upload Profile Image\n                </ObjectUploader>\n                {profileImageUrl && (\n                  <div className=\"relative inline-block\">\n                    <img \n                      src={profileImageUrl} \n                      alt=\"Profile preview\" \n                      className=\"h-24 w-24 object-cover rounded-full border-2\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"destructive\"\n                      size=\"icon\"\n                      className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full\"\n                      onClick={() => setProfileImageUrl(\"\")}\n                      data-testid=\"button-remove-profile-image\"\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n\n            {/* Documents Tab */}\n            <TabsContent value=\"documents\" className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-base font-semibold flex items-center gap-2\">\n                  <FileText className=\"w-4 h-4\" />\n                  Certificates & Documents\n                </Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Upload professional certificates, licenses, or other relevant documents (PDF, images, etc.)\n                </p>\n              </div>\n\n              {/* Upload Certificates */}\n              <div className=\"space-y-2\">\n                <Label>Upload Certificates</Label>\n                <ObjectUploader\n                  maxNumberOfFiles={10}\n                  onGetUploadParameters={async () => {\n                    const response = await fetch('/api/objects/upload', {\n                      method: 'POST',\n                      credentials: 'include',\n                    });\n                    const { uploadURL } = await response.json();\n                    return {\n                      method: 'PUT',\n                      url: uploadURL,\n                    };\n                  }}\n                  onComplete={async (result) => {\n                    try {\n                      if (result.successful && result.successful.length > 0) {\n                        const newPaths: string[] = [];\n                        for (const file of result.successful) {\n                          let fileUrl = file.uploadURL;\n                          \n                          // Ensure it's a valid file path (should start with /objects/)\n                          if (!fileUrl || !fileUrl.startsWith('/objects/')) {\n                            // If it's an absolute URL, extract the path\n                            if (fileUrl && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {\n                              try {\n                                const urlObj = new URL(fileUrl);\n                                fileUrl = urlObj.pathname;\n                              } catch (e) {\n                                console.error('[Team] Invalid certificate URL:', fileUrl);\n                                continue; // Skip this file\n                              }\n                            } else {\n                              console.error('[Team] Invalid certificate URL format:', fileUrl);\n                              continue; // Skip this file\n                            }\n                          }\n                          \n                          // Convert to absolute URL for ACL call\n                          const absoluteUrl = fileUrl.startsWith('/') \n                            ? `${window.location.origin}${fileUrl}`\n                            : fileUrl;\n                          \n                          const response = await fetch('/api/objects/set-acl', {\n                            method: 'PUT',\n                            headers: { 'Content-Type': 'application/json' },\n                            credentials: 'include',\n                            body: JSON.stringify({ photoUrl: absoluteUrl }),\n                          });\n                          \n                          if (!response.ok) {\n                            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n                            console.error('[Team] Failed to set ACL for certificate:', errorData);\n                            continue; // Skip this file but continue with others\n                          }\n                          \n                          const { objectPath } = await response.json();\n                          newPaths.push(objectPath || fileUrl);\n                        }\n                        \n                        if (newPaths.length > 0) {\n                          setCertificateUrls([...certificateUrls, ...newPaths]);\n                          toast({\n                            title: \"Success\",\n                            description: `${newPaths.length} certificate(s) uploaded successfully`,\n                          });\n                        } else {\n                          throw new Error('No certificates were uploaded successfully');\n                        }\n                      }\n                    } catch (error: any) {\n                      console.error('[Team] Certificate upload error:', error);\n                      toast({\n                        title: \"Upload Error\",\n                        description: error.message || \"Failed to upload one or more certificates. Please try again.\",\n                        variant: \"destructive\",\n                      });\n                    }\n                  }}\n                  buttonClassName=\"w-full\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Upload Certificates\n                </ObjectUploader>\n                {certificateUrls.length > 0 && (\n                  <div className=\"space-y-2 mt-2\">\n                    <p className=\"text-sm text-muted-foreground\">{certificateUrls.length} certificate(s) uploaded</p>\n                    {certificateUrls.map((url, idx) => (\n                      <div key={idx} className=\"flex items-center gap-2 p-2 border rounded\">\n                        <FileText className=\"w-4 h-4 text-muted-foreground flex-shrink-0\" />\n                        <span className=\"text-sm flex-1 truncate\">{url.split('/').pop()}</span>\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6\"\n                          onClick={() => setCertificateUrls(certificateUrls.filter((_, i) => i !== idx))}\n                          data-testid={`button-remove-certificate-${idx}`}\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n          </Tabs>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={handleCloseDialog}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={createMutation.isPending || updateMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {createMutation.isPending || updateMutation.isPending\n                ? \"Saving...\"\n                : editingUser\n                ? \"Update Profile\"\n                : \"Create Team Member\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":45207},"server/auth.ts":{"content":"// Custom username/password authentication using passport-local\nimport passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport { Express } from \"express\";\nimport session from \"express-session\";\nimport { scrypt, randomBytes, timingSafeEqual } from \"crypto\";\nimport { promisify } from \"util\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\nimport { User as DbUser, registerUserSchema, loginUserSchema } from \"@shared/schema\";\n\ndeclare global {\n  namespace Express {\n    interface User extends DbUser {}\n  }\n}\n\nconst scryptAsync = promisify(scrypt);\n\n// Password hashing utilities\nexport async function hashPassword(password: string): Promise<string> {\n  const salt = randomBytes(16).toString(\"hex\");\n  const buf = (await scryptAsync(password, salt, 64)) as Buffer;\n  return `${buf.toString(\"hex\")}.${salt}`;\n}\n\nexport async function comparePasswords(\n  supplied: string,\n  stored: string\n): Promise<boolean> {\n  const [hashed, salt] = stored.split(\".\");\n  const hashedBuf = Buffer.from(hashed, \"hex\");\n  const suppliedBuf = (await scryptAsync(supplied, salt, 64)) as Buffer;\n  return timingSafeEqual(hashedBuf, suppliedBuf);\n}\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: true, // Enable auto-creation in development\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: true,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: false, // Disable secure in development\n      sameSite: 'lax',\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  // Configure passport-local strategy to use email instead of username\n  passport.use(\n    new LocalStrategy(\n      { usernameField: 'email' },\n      async (email, password, done) => {\n        try {\n          // Normalize email to lowercase for case-insensitive matching\n          const normalizedEmail = email.toLowerCase().trim();\n          const user = await storage.getUserByEmail(normalizedEmail);\n          if (!user) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n          \n          const isValid = await comparePasswords(password, user.password);\n          if (!isValid) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n          \n          // Check if user account is active\n          if (!user.isActive) {\n            return done(null, false, { message: \"Account has been disabled. Please contact your administrator.\" });\n          }\n          \n          return done(null, user);\n        } catch (error) {\n          return done(error);\n        }\n      }\n    )\n  );\n\n  passport.serializeUser((user, done) => {\n    done(null, user.id);\n  });\n\n  passport.deserializeUser(async (id: string, done) => {\n    try {\n      const user = await storage.getUser(id);\n      done(null, user);\n    } catch (error) {\n      done(error);\n    }\n  });\n\n  // Registration endpoint\n  app.post(\"/api/register\", async (req, res, next) => {\n    try {\n      // Validate input\n      const validatedData = registerUserSchema.parse(req.body);\n\n      // Normalize email to lowercase for case-insensitive storage\n      const normalizedEmail = validatedData.email.toLowerCase().trim();\n\n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(validatedData.username);\n      if (existingUser) {\n        return res.status(400).json({ message: \"Username already exists\" });\n      }\n\n      // Check if email already exists\n      const existingEmail = await storage.getUserByEmail(normalizedEmail);\n      if (existingEmail) {\n        return res.status(400).json({ message: \"Email already exists\" });\n      }\n\n      // Hash password and create user\n      const hashedPassword = await hashPassword(validatedData.password);\n      const user = await storage.createUser({\n        ...validatedData,\n        email: normalizedEmail,\n        password: hashedPassword,\n      });\n\n      // Automatically create organization using the username (company name) field\n      // Only create organization for owner role\n      if (user.role === \"owner\") {\n        try {\n          // Get and validate country code from registration or default to GB\n          const { COMMON_COUNTRIES } = await import('../shared/countryUtils');\n          let countryCode = validatedData.countryCode || \"GB\";\n          \n          // Validate country code against supported countries\n          const isValidCountry = COMMON_COUNTRIES.some(c => c.code === countryCode);\n          if (!isValidCountry) {\n            console.warn(`Invalid country code ${countryCode} provided, defaulting to GB`);\n            countryCode = \"GB\";\n          }\n          \n          // Create organization using username as company name\n          const organization = await storage.createOrganization({\n            name: validatedData.username, // Company name from registration form\n            ownerId: user.id,\n            countryCode: countryCode,\n            creditsRemaining: 5, // Give 5 free credits to start\n          });\n\n          // Update user with organization ID and set role to owner\n          const updatedUser = await storage.upsertUser({\n            ...user,\n            organizationId: organization.id,\n            role: \"owner\",\n          });\n\n          // Create initial credit transaction for free credits\n          await storage.createCreditTransaction({\n            organizationId: organization.id,\n            amount: 5,\n            type: \"purchase\",\n            description: \"Welcome credits\",\n          });\n\n          // Create default inspection templates\n          try {\n            const { DEFAULT_TEMPLATES } = await import('./defaultTemplates');\n            for (const template of DEFAULT_TEMPLATES) {\n              await storage.createInspectionTemplate({\n                organizationId: organization.id,\n                name: template.name,\n                description: template.description,\n                scope: template.scope,\n                version: 1,\n                isActive: true,\n                structureJson: template.structureJson,\n                categoryId: template.categoryId,\n                createdBy: user.id,\n              });\n            }\n            console.log(` Created default templates for new organization ${organization.id}`);\n          } catch (templateError) {\n            console.error(\"Warning: Failed to create default templates:\", templateError);\n          }\n\n          // Create sample data (Block A, Property A, Joe Bloggs tenant)\n          try {\n            const uniqueSuffix = Date.now().toString(36);\n            \n            // Create Block A\n            const blockA = await storage.createBlock({\n              organizationId: organization.id,\n              name: \"Block A\",\n              address: \"123 Sample Street, Sample City, SC 12345\",\n              notes: \"Sample block created automatically for demonstration purposes\",\n            });\n\n            // Create Property A linked to Block A\n            const propertyA = await storage.createProperty({\n              organizationId: organization.id,\n              blockId: blockA.id,\n              name: \"Property A\",\n              address: \"Unit 101, Block A, 123 Sample Street, Sample City, SC 12345\",\n              sqft: 850,\n            });\n\n            // Create sample tenant user \"Joe Bloggs\"\n            const tenantPassword = await hashPassword(\"password123\");\n            const joeBloggs = await storage.createUser({\n              email: `joe.bloggs+${uniqueSuffix}@inspect360.demo`,\n              username: `joe_bloggs_${uniqueSuffix}`,\n              password: tenantPassword,\n              firstName: \"Joe\",\n              lastName: \"Bloggs\",\n              role: \"tenant\",\n              organizationId: organization.id,\n              isActive: true,\n            });\n\n            // Create tenant assignment\n            await storage.createTenantAssignment({\n              organizationId: organization.id,\n              propertyId: propertyA.id,\n              tenantId: joeBloggs.id,\n              leaseStartDate: new Date(),\n              leaseEndDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\n              monthlyRent: \"1200.00\",\n              depositAmount: \"1200.00\",\n              isActive: true,\n              notes: \"Sample tenant assignment created for demonstration purposes\",\n            });\n\n            console.log(` Sample data created for organization ${organization.id}`);\n          } catch (sampleDataError) {\n            console.error(\"Warning: Failed to create sample data:\", sampleDataError);\n          }\n\n          // Log user in after registration with updated user data\n          req.login(updatedUser, (err) => {\n            if (err) return next(err);\n            \n            // Don't send password to client\n            const { password, resetToken, resetTokenExpiry, ...userWithoutPassword } = updatedUser;\n            res.status(201).json(userWithoutPassword);\n          });\n        } catch (orgError) {\n          console.error(\"Error creating organization during registration:\", orgError);\n          // If org creation fails, still log the user in but without org\n          req.login(user, (err) => {\n            if (err) return next(err);\n            const { password, resetToken, resetTokenExpiry, ...userWithoutPassword } = user;\n            res.status(201).json(userWithoutPassword);\n          });\n        }\n      } else {\n        // For non-owner roles, just log them in normally\n        req.login(user, (err) => {\n          if (err) return next(err);\n          \n          // Don't send password to client\n          const { password, resetToken, resetTokenExpiry, ...userWithoutPassword } = user;\n          res.status(201).json(userWithoutPassword);\n        });\n      }\n    } catch (error: any) {\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ \n          message: \"Validation error\", \n          errors: error.errors \n        });\n      }\n      console.error(\"Registration error:\", error);\n      res.status(500).json({ message: \"Registration failed\" });\n    }\n  });\n\n  // Login endpoint\n  app.post(\"/api/login\", (req, res, next) => {\n    try {\n      // Validate input\n      loginUserSchema.parse(req.body);\n\n      passport.authenticate(\"local\", (err: any, user: DbUser | false, info: any) => {\n        if (err) {\n          return next(err);\n        }\n        if (!user) {\n          return res.status(401).json({ \n            message: info?.message || \"Invalid email or password\" \n          });\n        }\n        \n        req.login(user, (err) => {\n          if (err) return next(err);\n          \n          // Explicitly save the session before responding\n          req.session.save((saveErr) => {\n            if (saveErr) {\n              console.error('[LOGIN ERROR] Session save failed:', saveErr);\n              return next(saveErr);\n            }\n            \n            // Don't send password to client\n            const { password, resetToken, resetTokenExpiry, ...userWithoutPassword } = user;\n            console.log('[LOGIN SUCCESS] User object being sent:', JSON.stringify({\n              id: userWithoutPassword.id,\n              email: userWithoutPassword.email,\n              role: userWithoutPassword.role,\n              organizationId: userWithoutPassword.organizationId,\n            }));\n            res.json(userWithoutPassword);\n          });\n        });\n      })(req, res, next);\n    } catch (error: any) {\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ \n          message: \"Validation error\", \n          errors: error.errors \n        });\n      }\n      res.status(401).json({ message: \"Invalid username or password\" });\n    }\n  });\n\n  // Logout endpoint\n  app.post(\"/api/logout\", (req, res, next) => {\n    req.logout((err) => {\n      if (err) return next(err);\n      res.json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  // Get current user endpoint\n  app.get(\"/api/user\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    \n    // Fetch organization to get country code\n    let organizationCountryCode = \"GB\"; // Default\n    if (req.user.organizationId) {\n      const org = await storage.getOrganization(req.user.organizationId);\n      if (org) {\n        organizationCountryCode = org.countryCode || \"GB\";\n      }\n    }\n    \n    // Don't send password to client, add organizationCountryCode\n    const { password, resetToken, resetTokenExpiry, ...userWithoutPassword } = req.user;\n    res.json({ ...userWithoutPassword, organizationCountryCode });\n  });\n\n  // Forgot password - request reset token\n  app.post(\"/api/forgot-password\", async (req, res) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ message: \"Email is required\" });\n      }\n\n      // Normalize email to lowercase for case-insensitive matching\n      const normalizedEmail = email.toLowerCase().trim();\n      const user = await storage.getUserByEmail(normalizedEmail);\n      if (!user) {\n        // Don't reveal if email exists\n        return res.json({ \n          message: \"If that email exists, a password reset link has been sent\" \n        });\n      }\n\n      // Generate reset token (6-digit code for simplicity)\n      const resetToken = Math.floor(100000 + Math.random() * 900000).toString();\n      const expiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n\n      await storage.setResetToken(user.id, resetToken, expiry);\n\n      // Send password reset email\n      try {\n        const { sendPasswordResetEmail } = await import('./resend');\n        const displayName = user.firstName \n          ? `${user.firstName}${user.lastName ? ' ' + user.lastName : ''}`\n          : user.username;\n        await sendPasswordResetEmail(\n          user.email,\n          displayName,\n          resetToken\n        );\n      } catch (emailError) {\n        console.error('Failed to send password reset email:', emailError);\n        // Don't fail the request if email fails - token is still set\n      }\n      \n      res.json({ \n        message: \"If that email exists, a password reset link has been sent\"\n      });\n    } catch (error) {\n      console.error(\"Forgot password error:\", error);\n      res.status(500).json({ message: \"Failed to process request\" });\n    }\n  });\n\n  // Reset password with token\n  app.post(\"/api/reset-password\", async (req, res) => {\n    try {\n      const { email, token, newPassword } = req.body;\n\n      if (!email || !token || !newPassword) {\n        return res.status(400).json({ message: \"Email, token, and new password are required\" });\n      }\n\n      if (newPassword.length < 6) {\n        return res.status(400).json({ message: \"Password must be at least 6 characters\" });\n      }\n\n      // Normalize email to lowercase for case-insensitive matching\n      const normalizedEmail = email.toLowerCase().trim();\n      const user = await storage.getUserByEmail(normalizedEmail);\n      if (!user || !user.resetToken || !user.resetTokenExpiry) {\n        return res.status(400).json({ message: \"Invalid or expired reset token\" });\n      }\n\n      // Check if token matches and hasn't expired\n      if (user.resetToken !== token || new Date() > user.resetTokenExpiry) {\n        return res.status(400).json({ message: \"Invalid or expired reset token\" });\n      }\n\n      // Update password and clear reset token\n      const hashedPassword = await hashPassword(newPassword);\n      await storage.updatePassword(user.id, hashedPassword);\n      await storage.clearResetToken(user.id);\n\n      res.json({ message: \"Password reset successfully\" });\n    } catch (error) {\n      console.error(\"Reset password error:\", error);\n      res.status(500).json({ message: \"Failed to reset password\" });\n    }\n  });\n}\n\n// Middleware to check if user is authenticated\nexport function isAuthenticated(req: any, res: any, next: any) {\n  if (req.isAuthenticated()) {\n    return next();\n  }\n  res.status(401).json({ message: \"Unauthorized\" });\n}\n\n// Role-based middleware\nexport function requireRole(...allowedRoles: string[]) {\n  return async (req: any, res: any, next: any) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n\n    if (!allowedRoles.includes(req.user.role)) {\n      return res.status(403).json({ \n        message: \"Forbidden: Insufficient permissions\" \n      });\n    }\n\n    next();\n  };\n}\n","size_bytes":16871},"client/src/pages/ForgotPassword.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Loader2, ArrowLeft } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function ForgotPassword() {\n  const [email, setEmail] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      await apiRequest(\"POST\", \"/api/forgot-password\", { email });\n      toast({\n        title: \"Reset code sent\",\n        description: \"Check your email for the 6-digit reset code\",\n      });\n      // Redirect to reset password page with email\n      navigate(`/reset-password?email=${encodeURIComponent(email)}`);\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send reset email\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex h-screen\">\n      {/* Left Column - Form */}\n      <div className=\"flex flex-1 items-center justify-center p-8 bg-background\">\n        <div className=\"w-full max-w-md\">\n          <Card>\n            <CardHeader className=\"space-y-1\">\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => navigate(\"/auth\")}\n                  data-testid=\"button-back\"\n                >\n                  <ArrowLeft className=\"h-4 w-4\" />\n                </Button>\n                <CardTitle className=\"text-2xl font-bold\">Forgot Password</CardTitle>\n              </div>\n              <CardDescription>\n                Enter your email address and we'll send you instructions to reset your password\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email address</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={email}\n                    onChange={(e) => setEmail(e.target.value)}\n                    placeholder=\"Enter your email\"\n                    required\n                    disabled={isLoading}\n                    data-testid=\"input-email\"\n                  />\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={isLoading || !email}\n                  data-testid=\"button-submit\"\n                >\n                  {isLoading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                  Send reset instructions\n                </Button>\n\n                <div className=\"text-center\">\n                  <button\n                    type=\"button\"\n                    className=\"text-sm text-primary hover:underline transition-all\"\n                    onClick={() => navigate(\"/reset-password\")}\n                    data-testid=\"button-have-code\"\n                  >\n                    Already have a reset code?\n                  </button>\n                </div>\n              </form>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Right Column - Hero (Same as Auth page) */}\n      <div className=\"hidden lg:flex lg:flex-1 items-center justify-center p-12 relative overflow-hidden\">\n        <div className=\"absolute inset-0 bg-[#00D6C1]\"></div>\n        <div className=\"absolute inset-0 bg-gradient-to-br from-[#00D6C1] via-[#00D6C1]/80 to-[#00D6C1]/60\"></div>\n\n        <div className=\"relative z-10 max-w-lg text-white\">\n          <h2 className=\"text-3xl font-bold mb-4\">Secure Account Recovery</h2>\n          <p className=\"text-lg text-white/90\">\n            We'll send you a secure link to reset your password. The link will expire in 1 hour for your security.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":4420},"client/src/lib/protected-route.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route, RouteProps } from \"wouter\";\n\nexport function ProtectedRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":718},"client/src/pages/Auth.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Loader2, Building2, Eye, EyeOff, FileCheck, Lock } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport logoUrl from \"@assets/Inspect360 Logo_1761302629835.png\";\nimport { getCachedUserCountry } from \"@/lib/geolocation\";\nimport { COMMON_COUNTRIES } from \"@shared/countryUtils\";\n\nexport default function Auth() {\n  const [isLogin, setIsLogin] = useState(true);\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const { loginMutation, registerMutation, user } = useAuth();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n\n  // Login form state\n  const [loginEmail, setLoginEmail] = useState(\"\");\n  const [loginPassword, setLoginPassword] = useState(\"\");\n\n  // Registration form state\n  const [firstName, setFirstName] = useState(\"\");\n  const [lastName, setLastName] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [countryCode, setCountryCode] = useState(\"GB\");\n\n  // Auto-detect country on component mount\n  useEffect(() => {\n    getCachedUserCountry().then((result) => {\n      if (result?.countryCode) {\n        // Validate detected country is in our supported list\n        const isSupported = COMMON_COUNTRIES.some(c => c.code === result.countryCode);\n        if (isSupported) {\n          setCountryCode(result.countryCode);\n        } else {\n          console.warn(`Detected country ${result.countryCode} not in supported list, using GB`);\n          setCountryCode(\"GB\");\n        }\n      }\n    }).catch((error) => {\n      console.error(\"Failed to detect country, using default GB:\", error);\n      setCountryCode(\"GB\");\n    });\n  }, []);\n\n  async function handleLogin(e: React.FormEvent) {\n    e.preventDefault();\n    \n    if (!loginEmail || !loginPassword) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Please fill in all fields\",\n      });\n      return;\n    }\n\n    try {\n      const result = await loginMutation.mutateAsync({\n        email: loginEmail,\n        password: loginPassword,\n      });\n      \n      if (result) {\n        navigate(\"/dashboard\");\n      }\n    } catch (error) {\n      // Error is already handled by useAuth's onError, but we catch here to prevent unhandled rejection\n      console.error(\"Login error:\", error);\n    }\n  }\n\n  async function handleRegister(e: React.FormEvent) {\n    e.preventDefault();\n\n    // Validation\n    if (!firstName || !lastName || !email || !username || !password || !confirmPassword) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Please fill in all fields\",\n      });\n      return;\n    }\n\n    if (password !== confirmPassword) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Passwords don't match\",\n      });\n      return;\n    }\n\n    if (password.length < 6) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Password must be at least 6 characters\",\n      });\n      return;\n    }\n\n    try {\n      const result = await registerMutation.mutateAsync({\n        firstName,\n        lastName,\n        email,\n        username,\n        password,\n        countryCode,\n        role: \"owner\", // All self-registrations are owners\n      });\n\n      if (result) {\n        navigate(\"/dashboard\");\n      }\n    } catch (error) {\n      // Error is already handled by useAuth's onError, but we catch here to prevent unhandled rejection\n      console.error(\"Registration error:\", error);\n    }\n  }\n\n  if (user) {\n    navigate(\"/dashboard\");\n    return null;\n  }\n\n  return (\n    <div className=\"flex h-screen\">\n      {/* Left Column - Form */}\n      <div className=\"flex flex-1 items-center justify-center p-4 md:p-8 bg-background\">\n        <div className=\"w-full max-w-md\">\n          {/* Logo above card */}\n          <div className=\"flex justify-center mb-8\">\n            <img src={logoUrl} alt=\"Inspect360\" className=\"h-14\" />\n          </div>\n          \n          <Card className=\"border-border/60\">\n            <CardHeader className=\"space-y-3 pb-6\">\n              <CardTitle className=\"text-2xl font-bold text-center\">\n                {isLogin ? \"Welcome back\" : \"Create account\"}\n              </CardTitle>\n              <CardDescription className=\"text-center text-base\">\n                {isLogin\n                  ? \"Enter your credentials to access your account\"\n                  : \"Fill in your details to create your Inspect360 account\"}\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {isLogin ? (\n                <form onSubmit={handleLogin} className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"login-email\">Email Address</Label>\n                    <Input\n                      id=\"login-email\"\n                      type=\"email\"\n                      placeholder=\"Enter your email address\"\n                      value={loginEmail}\n                      onChange={(e) => setLoginEmail(e.target.value)}\n                      disabled={loginMutation.isPending}\n                      data-testid=\"input-email\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"login-password\">Password</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"login-password\"\n                        type={showPassword ? \"text\" : \"password\"}\n                        placeholder=\"Enter your password\"\n                        value={loginPassword}\n                        onChange={(e) => setLoginPassword(e.target.value)}\n                        disabled={loginMutation.isPending}\n                        data-testid=\"input-password\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        data-testid=\"button-toggle-password\"\n                      >\n                        {showPassword ? (\n                          <EyeOff className=\"h-4 w-4\" />\n                        ) : (\n                          <Eye className=\"h-4 w-4\" />\n                        )}\n                      </button>\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center justify-end\">\n                    <button\n                      type=\"button\"\n                      className=\"text-sm text-primary hover:underline transition-all\"\n                      onClick={() => navigate(\"/forgot-password\")}\n                      data-testid=\"button-forgot-password\"\n                    >\n                      Forgot password?\n                    </button>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full h-11 font-medium\"\n                    disabled={loginMutation.isPending}\n                    data-testid=\"button-login\"\n                  >\n                    {loginMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Sign in\n                  </Button>\n                </form>\n              ) : (\n                <form onSubmit={handleRegister} className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"first-name\">First name</Label>\n                      <Input\n                        id=\"first-name\"\n                        type=\"text\"\n                        placeholder=\"John\"\n                        value={firstName}\n                        onChange={(e) => setFirstName(e.target.value)}\n                        disabled={registerMutation.isPending}\n                        data-testid=\"input-first-name\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"last-name\">Last name</Label>\n                      <Input\n                        id=\"last-name\"\n                        type=\"text\"\n                        placeholder=\"Doe\"\n                        value={lastName}\n                        onChange={(e) => setLastName(e.target.value)}\n                        disabled={registerMutation.isPending}\n                        data-testid=\"input-last-name\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"register-email\">Email</Label>\n                    <Input\n                      id=\"register-email\"\n                      type=\"email\"\n                      placeholder=\"john@example.com\"\n                      value={email}\n                      onChange={(e) => setEmail(e.target.value)}\n                      disabled={registerMutation.isPending}\n                      data-testid=\"input-email\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"company-name\">Company Name</Label>\n                    <Input\n                      id=\"company-name\"\n                      type=\"text\"\n                      placeholder=\"Acme Property Management\"\n                      value={username}\n                      onChange={(e) => setUsername(e.target.value)}\n                      disabled={registerMutation.isPending}\n                      data-testid=\"input-register-username\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"country\">Country</Label>\n                    <Select\n                      value={countryCode}\n                      onValueChange={setCountryCode}\n                      disabled={registerMutation.isPending}\n                    >\n                      <SelectTrigger id=\"country\" data-testid=\"select-country\">\n                        <SelectValue placeholder=\"Select country\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {COMMON_COUNTRIES.map((country) => (\n                          <SelectItem \n                            key={country.code} \n                            value={country.code}\n                            data-testid={`option-country-${country.code}`}\n                          >\n                            {country.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"register-password\">Password</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"register-password\"\n                        type={showPassword ? \"text\" : \"password\"}\n                        placeholder=\"Create a strong password\"\n                        value={password}\n                        onChange={(e) => setPassword(e.target.value)}\n                        disabled={registerMutation.isPending}\n                        data-testid=\"input-register-password\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        data-testid=\"button-toggle-password\"\n                      >\n                        {showPassword ? (\n                          <EyeOff className=\"h-4 w-4\" />\n                        ) : (\n                          <Eye className=\"h-4 w-4\" />\n                        )}\n                      </button>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"confirm-password\">Confirm Password</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"confirm-password\"\n                        type={showConfirmPassword ? \"text\" : \"password\"}\n                        placeholder=\"Confirm your password\"\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        disabled={registerMutation.isPending}\n                        data-testid=\"input-confirm-password\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        data-testid=\"button-toggle-confirm-password\"\n                      >\n                        {showConfirmPassword ? (\n                          <EyeOff className=\"h-4 w-4\" />\n                        ) : (\n                          <Eye className=\"h-4 w-4\" />\n                        )}\n                      </button>\n                    </div>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full h-11 font-medium\"\n                    disabled={registerMutation.isPending}\n                    data-testid=\"button-register\"\n                  >\n                    {registerMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Create account\n                  </Button>\n                </form>\n              )}\n\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 flex items-center\">\n                  <span className=\"w-full border-t\" />\n                </div>\n                <div className=\"relative flex justify-center text-xs uppercase\">\n                  <span className=\"bg-card px-2 text-muted-foreground\">\n                    {isLogin ? \"New to Inspect360?\" : \"Already a member?\"}\n                  </span>\n                </div>\n              </div>\n\n              <div className=\"text-center\">\n                {isLogin ? (\n                  <button\n                    type=\"button\"\n                    className=\"text-sm text-primary hover:underline font-medium transition-all\"\n                    onClick={() => setIsLogin(false)}\n                    data-testid=\"button-switch-register\"\n                  >\n                    Create your account\n                  </button>\n                ) : (\n                  <button\n                    type=\"button\"\n                    className=\"text-sm text-primary hover:underline font-medium transition-all\"\n                    onClick={() => setIsLogin(true)}\n                    data-testid=\"button-switch-login\"\n                  >\n                    Sign in to your account\n                  </button>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Right Column - Hero (hidden on mobile/tablet) */}\n      <div className=\"hidden lg:flex flex-1 items-center justify-center p-12 relative overflow-hidden\">\n        {/* Inspect360 brand gradient - Bright Cyan to Teal */}\n        <div className=\"absolute inset-0 bg-gradient-to-br from-[#00D5CC] via-[#3B7A8C] to-[#06283F]\"></div>\n        {/* Subtle overlay for better text contrast */}\n        <div className=\"absolute inset-0 bg-[#06283F]/40\"></div>\n\n        {/* Content */}\n        <div className=\"relative z-10 max-w-lg space-y-8 text-white\">\n          <div className=\"mb-8\">\n            <img src={logoUrl} alt=\"Inspect360\" className=\"h-16 filter brightness-0 invert\" />\n          </div>\n          <div>\n            <h1 className=\"text-4xl font-bold mb-4\">AI-Powered Building Inspections</h1>\n            <p className=\"text-lg text-white/90\">\n              Streamline your Build-to-Rent operations with mobile-first inspections, AI photo analysis, and comprehensive compliance tracking.\n            </p>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"flex items-start gap-4\">\n              <div className=\"bg-[#4FE5DD] p-3 rounded-lg\">\n                <Eye className=\"h-6 w-6 text-[#3B7A8C]\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">AI Photo Analysis</h3>\n                <p className=\"text-sm text-white/80\">\n                  Powered by GPT-5 Vision for detailed condition assessments\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-4\">\n              <div className=\"bg-[#4FE5DD] p-3 rounded-lg\">\n                <Building2 className=\"h-6 w-6 text-[#3B7A8C]\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Offline Mobile Inspections</h3>\n                <p className=\"text-sm text-white/80\">\n                  Conduct field inspections without internet connectivity\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-4\">\n              <div className=\"bg-[#4FE5DD] p-3 rounded-lg\">\n                <FileCheck className=\"h-6 w-6 text-[#3B7A8C]\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Compliance Tracking</h3>\n                <p className=\"text-sm text-white/80\">\n                  Automated expiry alerts for certifications and licenses\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-4\">\n              <div className=\"bg-[#4FE5DD] p-3 rounded-lg\">\n                <Lock className=\"h-6 w-6 text-[#3B7A8C]\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Role-Based Access</h3>\n                <p className=\"text-sm text-white/80\">\n                  Secure access for owners, clerks, compliance officers, and tenants\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":18945},"client/public/sw.js":{"content":"const CACHE_NAME = 'inspect360-v2';\nconst RUNTIME_CACHE = 'inspect360-runtime-v2';\n\n// App shell - essential files for offline functionality\nconst APP_SHELL = [\n  '/',\n  '/index.html',\n  '/manifest.json'\n];\n\n// Install event - cache app shell\nself.addEventListener('install', (event) => {\n  console.log('[Service Worker] Installing...');\n  event.waitUntil(\n    caches.open(CACHE_NAME)\n      .then((cache) => {\n        console.log('[Service Worker] Caching app shell');\n        // Use addAll but catch errors gracefully\n        return Promise.allSettled(\n          APP_SHELL.map(url => \n            cache.add(url).catch(err => {\n              console.warn(`[Service Worker] Failed to cache ${url}:`, err);\n              return null;\n            })\n          )\n        ).then(() => self.skipWaiting());\n      })\n      .catch((err) => {\n        console.warn('[Service Worker] Install failed (non-critical):', err);\n        // Still skip waiting even if caching fails\n        return self.skipWaiting();\n      })\n  );\n});\n\n// Activate event - clean up old caches\nself.addEventListener('activate', (event) => {\n  console.log('[Service Worker] Activating...');\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames.map((cacheName) => {\n          // Delete all old caches (including old versions)\n          if (cacheName !== CACHE_NAME && cacheName !== RUNTIME_CACHE) {\n            console.log('[Service Worker] Deleting old cache:', cacheName);\n            return caches.delete(cacheName);\n          }\n        })\n      );\n    }).then(() => {\n      // Clear any API responses that might have been cached in the runtime cache\n      return caches.open(RUNTIME_CACHE).then((cache) => {\n        return cache.keys().then((keys) => {\n          const apiKeys = keys.filter((request) => {\n            try {\n              const url = new URL(request.url);\n              return url.pathname.startsWith('/api/');\n            } catch {\n              return false;\n            }\n          });\n          return Promise.all(\n            apiKeys.map((key) => {\n              console.log('[Service Worker] Removing cached API response:', key.url);\n              return cache.delete(key);\n            })\n          );\n        });\n      }).catch((err) => {\n        console.warn('[Service Worker] Error cleaning API cache:', err);\n      });\n    }).then(() => self.clients.claim())\n  );\n});\n\n// Fetch event - serve from cache, fallback to network\nself.addEventListener('fetch', (event) => {\n  // Skip non-GET requests\n  if (event.request.method !== 'GET') {\n    return;\n  }\n\n  // Skip cross-origin requests\n  if (!event.request.url.startsWith(self.location.origin)) {\n    return;\n  }\n\n  const url = new URL(event.request.url);\n  \n  // CRITICAL: Never cache API requests - always fetch fresh from network\n  // This ensures credit balance, subscriptions, and other dynamic data are always up-to-date\n  if (url.pathname.startsWith('/api/')) {\n    // For API requests, use network-first strategy (always fetch from network)\n    event.respondWith(\n      fetch(event.request)\n        .then((networkResponse) => {\n          // Don't cache API responses - they need to be fresh\n          return networkResponse;\n        })\n        .catch((error) => {\n          console.warn('[Service Worker] API fetch failed:', event.request.url, error);\n          throw error;\n        })\n    );\n    return;\n  }\n\n  // For static assets (HTML, CSS, JS, images), use cache-first strategy\n  event.respondWith(\n    caches.match(event.request).then((cachedResponse) => {\n      if (cachedResponse) {\n        // Return cached version and update cache in background (stale-while-revalidate)\n        event.waitUntil(\n          fetch(event.request).then((networkResponse) => {\n            // Only cache static assets, not API responses\n            if (networkResponse && networkResponse.status === 200 && networkResponse.type !== 'error') {\n              return caches.open(RUNTIME_CACHE).then((cache) => {\n                cache.put(event.request, networkResponse.clone());\n              });\n            }\n          }).catch(() => {\n            // Network failed, but we have cache - that's fine\n          })\n        );\n        return cachedResponse;\n      }\n\n      // Not in cache - fetch from network\n      return fetch(event.request).then((networkResponse) => {\n        // Only cache static assets (not API responses)\n        if (networkResponse && networkResponse.status === 200 && networkResponse.type !== 'error') {\n          const responseClone = networkResponse.clone();\n          caches.open(RUNTIME_CACHE).then((cache) => {\n            // Only cache if response is valid and not a stream\n            if (responseClone.body) {\n              cache.put(event.request, responseClone).catch((err) => {\n                console.warn('[Service Worker] Failed to cache response:', err);\n              });\n            }\n          }).catch((err) => {\n            console.warn('[Service Worker] Failed to open cache:', err);\n          });\n        }\n        return networkResponse;\n      }).catch((error) => {\n        console.warn('[Service Worker] Fetch failed:', event.request.url, error);\n        throw error;\n      });\n    })\n  );\n});\n\n// Background sync event - for future implementation\nself.addEventListener('sync', (event) => {\n  console.log('[Service Worker] Background sync:', event.tag);\n  if (event.tag === 'sync-inspections') {\n    event.waitUntil(syncInspections());\n  }\n});\n\n// Sync offline inspection queue\nasync function syncInspections() {\n  console.log('[Service Worker] Syncing inspections...');\n  \n  try {\n    // Get all active clients\n    const clients = await self.clients.matchAll({ includeUncontrolled: true, type: 'window' });\n    \n    if (clients.length === 0) {\n      console.log('[Service Worker] No active clients to sync with - sync will retry later');\n      // Reject so Background Sync will retry when a client becomes available\n      return Promise.reject(new Error('No active clients available for sync'));\n    }\n    \n    // Create a MessageChannel to wait for the client's response\n    const messageChannel = new MessageChannel();\n    \n    // Set up promise to wait for client response\n    const syncPromise = new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => {\n        reject(new Error('Sync timeout - no response from client'));\n      }, 30000); // 30 second timeout\n      \n      messageChannel.port1.onmessage = (event) => {\n        clearTimeout(timeout);\n        \n        if (event.data && event.data.type === 'SYNC_RESULT') {\n          console.log(`[Service Worker] Sync complete: ${event.data.success} succeeded, ${event.data.failed} failed`);\n          \n          if (event.data.failed > 0) {\n            // Some items failed - reject so Background Sync will retry\n            reject(new Error(`Sync partially failed: ${event.data.failed} items`));\n          } else {\n            resolve(event.data);\n          }\n        } else if (event.data && event.data.type === 'SYNC_ERROR') {\n          reject(new Error(event.data.error || 'Sync failed'));\n        } else {\n          reject(new Error('Invalid sync response'));\n        }\n      };\n    });\n    \n    // Send sync request to client with MessageChannel port\n    clients[0].postMessage({\n      type: 'REQUEST_SYNC'\n    }, [messageChannel.port2]);\n    \n    console.log('[Service Worker] Sync request sent to client, waiting for completion...');\n    \n    // Wait for the client to complete the sync\n    return await syncPromise;\n  } catch (error) {\n    console.error('[Service Worker] Sync error:', error);\n    return Promise.reject(error);\n  }\n}\n\n// Message event - for communication with client\nself.addEventListener('message', (event) => {\n  console.log('[Service Worker] Message received:', event.data);\n  if (event.data && event.data.type === 'SKIP_WAITING') {\n    self.skipWaiting();\n  }\n});\n","size_bytes":7897},"client/src/pages/BlockDetail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport ComplianceCalendar from \"@/components/ComplianceCalendar\";\nimport { ArrowLeft, Building2, MapPin, Users, CheckCircle2, Calendar, AlertTriangle, FileCheck } from \"lucide-react\";\n\ninterface PropertyStats {\n  totalUnits: number;\n  occupiedUnits: number;\n  occupancyStatus: string;\n  complianceRate: number;\n  complianceStatus: string;\n  inspectionsDue: number;\n  inspectionsOverdue: number;\n}\n\ninterface Property {\n  id: string;\n  name: string;\n  address: string;\n  blockId: string | null;\n  stats: PropertyStats;\n}\n\ninterface Block {\n  id: string;\n  name: string;\n  address: string;\n  notes?: string | null;\n}\n\nexport default function BlockDetail() {\n  const [, params] = useRoute(\"/blocks/:id\");\n  const blockId = params?.id;\n\n  const { data: block, isLoading: blockLoading } = useQuery<Block>({\n    queryKey: [\"/api/blocks\", blockId],\n    queryFn: async () => {\n      const res = await fetch(`/api/blocks/${blockId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch block\");\n      return res.json();\n    },\n    enabled: !!blockId,\n  });\n\n  const { data: properties = [], isLoading: propertiesLoading } = useQuery<Property[]>({\n    queryKey: [\"/api/blocks\", blockId, \"properties\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/blocks/${blockId}/properties`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch properties\");\n      return res.json();\n    },\n    enabled: !!blockId,\n  });\n\n  const { data: complianceReport, isLoading: complianceReportLoading } = useQuery({\n    queryKey: [\"/api/blocks\", blockId, \"compliance-report\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/blocks/${blockId}/compliance-report`, { credentials: \"include\" });\n      if (!res.ok) return null;\n      return res.json();\n    },\n    enabled: !!blockId,\n  });\n\n  if (blockLoading || propertiesLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!block) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Block not found</p>\n          <Link href=\"/blocks\">\n            <Button variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Blocks\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      {/* Header */}\n      <div className=\"mb-6\">\n        <Link href=\"/blocks\">\n          <Button variant=\"ghost\" className=\"mb-4\" data-testid=\"button-back-to-blocks\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to Blocks\n          </Button>\n        </Link>\n        \n        <div className=\"flex items-start justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n              <Building2 className=\"h-8 w-8 text-primary\" />\n              {block.name}\n            </h1>\n            <p className=\"text-muted-foreground mt-2 flex items-center gap-2\">\n              <MapPin className=\"h-4 w-4\" />\n              {block.address}\n            </p>\n            {block.notes && (\n              <p className=\"text-sm text-muted-foreground mt-3 bg-muted p-3 rounded-md\">\n                {block.notes}\n              </p>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <Tabs defaultValue=\"properties\" className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"properties\" data-testid=\"tab-properties\">\n            <Building2 className=\"h-4 w-4 mr-2\" />\n            Properties ({properties.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"compliance\" data-testid=\"tab-compliance\">\n            <FileCheck className=\"h-4 w-4 mr-2\" />\n            Compliance\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Properties Tab */}\n        <TabsContent value=\"properties\" className=\"space-y-4\">\n          {properties.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <Building2 className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No properties yet</h3>\n                <p className=\"text-muted-foreground text-center mb-4\">\n                  Properties assigned to this block will appear here\n                </p>\n                <Link href=\"/properties\">\n                  <Button>View All Properties</Button>\n                </Link>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4\">\n              {properties.map((property) => (\n                <Link key={property.id} href={`/properties/${property.id}`}>\n                  <Card className=\"hover-elevate cursor-pointer\" data-testid={`card-property-${property.id}`}>\n                    <CardHeader>\n                      <div className=\"flex items-start justify-between\">\n                        <div>\n                          <CardTitle className=\"flex items-center gap-2\">\n                            <Building2 className=\"h-5 w-5 text-primary\" />\n                            {property.name}\n                          </CardTitle>\n                          <p className=\"text-sm text-muted-foreground mt-1\">{property.address}</p>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                        {/* Occupancy */}\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2 text-sm font-medium\">\n                            <Users className=\"h-4 w-4 text-muted-foreground\" />\n                            Occupancy\n                          </div>\n                          <p className=\"text-sm font-semibold\">{property.stats?.occupancyStatus || 'No data'}</p>\n                        </div>\n\n                        {/* Compliance */}\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2 text-sm font-medium\">\n                            <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n                            Compliance\n                          </div>\n                          <Badge \n                            variant={(property.stats?.complianceRate || 0) >= 80 ? \"default\" : \"destructive\"}\n                            className=\"text-xs\"\n                          >\n                            {property.stats?.complianceStatus || 'No data'}\n                          </Badge>\n                        </div>\n\n                        {/* Due Soon */}\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2 text-sm font-medium\">\n                            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                            Due Soon\n                          </div>\n                          <Badge \n                            variant={(property.stats?.inspectionsDue || 0) > 0 ? \"secondary\" : \"outline\"}\n                            className=\"text-xs\"\n                          >\n                            {property.stats?.inspectionsDue || 0} inspection{(property.stats?.inspectionsDue || 0) !== 1 ? 's' : ''}\n                          </Badge>\n                        </div>\n\n                        {/* Overdue */}\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2 text-sm font-medium\">\n                            <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\n                            Overdue\n                          </div>\n                          <Badge \n                            variant={(property.stats?.inspectionsOverdue || 0) > 0 ? \"destructive\" : \"outline\"}\n                            className=\"text-xs\"\n                          >\n                            {property.stats?.inspectionsOverdue || 0} inspection{(property.stats?.inspectionsOverdue || 0) !== 1 ? 's' : ''}\n                          </Badge>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </Link>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Compliance Tab */}\n        <TabsContent value=\"compliance\" className=\"space-y-6\">\n          <ComplianceCalendar \n            report={complianceReport} \n            isLoading={complianceReportLoading}\n            entityType=\"block\"\n          />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":9193},"client/src/pages/WorkOrders.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Calendar, DollarSign, User, AlertCircle, CheckCircle2, Clock } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\ninterface WorkOrder {\n  id: string;\n  status: string;\n  slaDue?: string | null;\n  costEstimate?: number | null;\n  costActual?: number | null;\n  createdAt: string;\n  maintenanceRequest: {\n    id: string;\n    title: string;\n    description?: string;\n    priority: string;\n  };\n  contractor?: {\n    firstName?: string;\n    lastName?: string;\n    email: string;\n  };\n}\n\nconst statusColors: Record<string, string> = {\n  assigned: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\",\n  in_progress: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300\",\n  waiting_parts: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300\",\n  completed: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\",\n  rejected: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300\",\n};\n\nconst priorityColors: Record<string, string> = {\n  low: \"bg-gray-100 text-gray-800\",\n  medium: \"bg-blue-100 text-blue-800\",\n  high: \"bg-orange-100 text-orange-800\",\n  urgent: \"bg-red-100 text-red-800\",\n};\n\nexport default function WorkOrders() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const locale = useLocale();\n\n  const { data: workOrders = [], isLoading } = useQuery<WorkOrder[]>({\n    queryKey: [\"/api/work-orders\"],\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/work-orders/${id}/status`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/work-orders\"] });\n      toast({ title: \"Status updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update status\", variant: \"destructive\" });\n    },\n  });\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <CheckCircle2 className=\"h-4 w-4\" />;\n      case \"in_progress\":\n      case \"waiting_parts\":\n        return <Clock className=\"h-4 w-4\" />;\n      case \"rejected\":\n        return <AlertCircle className=\"h-4 w-4\" />;\n      default:\n        return <User className=\"h-4 w-4\" />;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold\">Work Orders</h1>\n        <p className=\"text-muted-foreground\">\n          {user?.role === \"contractor\" \n            ? \"View and manage your assigned work orders\" \n            : \"Manage contractor work orders and assignments\"}\n        </p>\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-8\">Loading work orders...</div>\n      ) : workOrders.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <User className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No work orders</h3>\n            <p className=\"text-muted-foreground text-center\">\n              {user?.role === \"contractor\"\n                ? \"You don't have any assigned work orders yet\"\n                : \"Create work orders from maintenance requests\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {workOrders.map((workOrder) => (\n            <Card key={workOrder.id} data-testid={`card-work-order-${workOrder.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      {getStatusIcon(workOrder.status)}\n                      <CardTitle className=\"text-lg\">\n                        {workOrder.maintenanceRequest.title}\n                      </CardTitle>\n                      <Badge className={priorityColors[workOrder.maintenanceRequest.priority]}>\n                        {workOrder.maintenanceRequest.priority}\n                      </Badge>\n                    </div>\n                    <CardDescription>\n                      {workOrder.maintenanceRequest.description || \"No description provided\"}\n                    </CardDescription>\n                  </div>\n                  <Badge className={statusColors[workOrder.status]}>\n                    {workOrder.status.replace(\"_\", \" \")}\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                  {workOrder.contractor && (\n                    <div className=\"flex items-center gap-2 text-sm\">\n                      <User className=\"h-4 w-4 text-muted-foreground\" />\n                      <div>\n                        <p className=\"font-medium\">Contractor</p>\n                        <p className=\"text-muted-foreground\">\n                          {workOrder.contractor.firstName} {workOrder.contractor.lastName}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n\n                  {workOrder.slaDue && (\n                    <div className=\"flex items-center gap-2 text-sm\">\n                      <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                      <div>\n                        <p className=\"font-medium\">SLA Due</p>\n                        <p className=\"text-muted-foreground\">\n                          {formatDistanceToNow(new Date(workOrder.slaDue), { addSuffix: true })}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n\n                  {(workOrder.costEstimate || workOrder.costActual) && (\n                    <div className=\"flex items-center gap-2 text-sm\">\n                      <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                      <div>\n                        <p className=\"font-medium\">Cost</p>\n                        <p className=\"text-muted-foreground\">\n                          {workOrder.costActual \n                            ? `Actual: ${locale.formatCurrency(workOrder.costActual)}`\n                            : `Est: ${locale.formatCurrency(workOrder.costEstimate || 0)}`}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                    <div>\n                      <p className=\"font-medium\">Created</p>\n                      <p className=\"text-muted-foreground\">\n                        {formatDistanceToNow(new Date(workOrder.createdAt), { addSuffix: true })}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n\n                {user?.role === \"contractor\" && workOrder.status !== \"completed\" && workOrder.status !== \"rejected\" && (\n                  <div className=\"mt-4 flex items-center gap-2\">\n                    <label className=\"text-sm font-medium\">Update Status:</label>\n                    <Select\n                      value={workOrder.status}\n                      onValueChange={(status) => updateStatusMutation.mutate({ id: workOrder.id, status })}\n                    >\n                      <SelectTrigger className=\"w-48\" data-testid={`select-status-${workOrder.id}`}>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"assigned\">Assigned</SelectItem>\n                        <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                        <SelectItem value=\"waiting_parts\">Waiting Parts</SelectItem>\n                        <SelectItem value=\"completed\">Completed</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":8717},"client/src/pages/Blocks.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Building, Pencil, Trash2, Users, CheckCircle2, Calendar, AlertTriangle, Search, Package, ClipboardCheck, FileText, Home } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { TagInput } from \"@/components/TagInput\";\nimport { TagFilter } from \"@/components/TagFilter\";\nimport { AddressInput } from \"@/components/AddressInput\";\nimport type { Tag } from \"@shared/schema\";\nimport { Tag as TagIcon } from \"lucide-react\";\n\ninterface BlockStats {\n  totalProperties: number;\n  totalUnits: number;\n  occupiedUnits: number;\n  occupancyRate: number;\n  complianceRate: number;\n  inspectionsDue: number;\n  overdueInspections: number;\n}\n\ninterface Block {\n  id: string;\n  organizationId: string;\n  name: string;\n  address: string;\n  notes?: string | null;\n  createdAt: string | null;\n  updatedAt: string | null;\n  stats?: BlockStats;\n  tags?: Tag[];\n}\n\nexport default function Blocks() {\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [editingBlock, setEditingBlock] = useState<Block | null>(null);\n  const [name, setName] = useState(\"\");\n  const [address, setAddress] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n  const [selectedTags, setSelectedTags] = useState<Tag[]>([]);\n  const [filterTags, setFilterTags] = useState<Tag[]>([]);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: blocks = [], isLoading } = useQuery<Block[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  // Fetch tags for all blocks\n  const blockIds = useMemo(() => blocks.map(b => b.id).sort().join(','), [blocks]);\n  const { data: blockTagsMap = {} } = useQuery<Record<string, Tag[]>>({\n    queryKey: [\"/api/blocks/tags\", blockIds],\n    enabled: blocks.length > 0,\n    queryFn: async () => {\n      const tagPromises = blocks.map(async (block) => {\n        try {\n          const res = await fetch(`/api/blocks/${block.id}/tags`, { credentials: \"include\" });\n          if (res.ok) {\n            const tags = await res.json();\n            return { blockId: block.id, tags };\n          }\n        } catch (error) {\n          console.error(`Error fetching tags for block ${block.id}:`, error);\n        }\n        return { blockId: block.id, tags: [] };\n      });\n      \n      const results = await Promise.all(tagPromises);\n      return results.reduce((acc, { blockId, tags }) => {\n        acc[blockId] = tags;\n        return acc;\n      }, {} as Record<string, Tag[]>);\n    },\n  });\n\n  // Merge tags into blocks\n  const blocksWithTags = useMemo(() => {\n    return blocks.map(block => ({\n      ...block,\n      tags: blockTagsMap[block.id] || [],\n    }));\n  }, [blocks, blockTagsMap]);\n\n  // Filter blocks by search query and tags\n  const filteredBlocks = useMemo(() => {\n    let filtered = blocksWithTags;\n\n    // Filter by search query\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(block => \n        block.name.toLowerCase().includes(query) ||\n        block.address.toLowerCase().includes(query)\n      );\n    }\n\n    // Filter by tags (show blocks that have ALL selected tags)\n    if (filterTags.length > 0) {\n      filtered = filtered.filter(block => {\n        if (!block.tags || block.tags.length === 0) return false;\n        return filterTags.every(filterTag =>\n          block.tags!.some(blockTag => blockTag.id === filterTag.id)\n        );\n      });\n    }\n\n    return filtered;\n  }, [blocksWithTags, searchQuery, filterTags]);\n\n  const createBlockMutation = useMutation({\n    mutationFn: async (data: { name: string; address: string; notes?: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/blocks\", data);\n      return await res.json();\n    },\n    onSuccess: async (newBlock) => {\n      // Add tags to the new block if any are selected\n      if (selectedTags.length > 0) {\n        await updateBlockTags(newBlock.id, selectedTags);\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks/tags\"] });\n      toast({ title: \"Block created successfully\" });\n      handleCloseDialog();\n    },\n    onError: (error: any) => {\n      console.error(\"Block creation error:\", error);\n      const message = error?.message || \"Failed to create block\";\n      toast({ title: message, variant: \"destructive\" });\n    },\n  });\n\n  const updateBlockMutation = useMutation({\n    mutationFn: async (data: { id: string; name: string; address: string; notes?: string }) => {\n      return apiRequest(\"PATCH\", `/api/blocks/${data.id}`, { \n        name: data.name, \n        address: data.address, \n        notes: data.notes \n      });\n    },\n    onSuccess: async (_, variables) => {\n      // Update tags for the block\n      await updateBlockTags(variables.id, selectedTags);\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks/tags\"] });\n      toast({ title: \"Block updated successfully\" });\n      handleCloseDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update block\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteBlockMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/blocks/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks/tags\"] });\n      toast({ title: \"Block deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete block\", variant: \"destructive\" });\n    },\n  });\n\n  const handleOpenCreate = () => {\n    setEditingBlock(null);\n    setName(\"\");\n    setAddress(\"\");\n    setNotes(\"\");\n    setSelectedTags([]);\n    setIsCreateOpen(true);\n  };\n\n  const handleOpenEdit = async (block: Block) => {\n    setEditingBlock(block);\n    setName(block.name);\n    setAddress(block.address);\n    setNotes(block.notes || \"\");\n    \n    // Fetch tags for this block\n    try {\n      const res = await fetch(`/api/blocks/${block.id}/tags`, { credentials: \"include\" });\n      if (res.ok) {\n        const tags = await res.json();\n        setSelectedTags(tags);\n      }\n    } catch (error) {\n      console.error(\"Error fetching block tags:\", error);\n    }\n    \n    setIsCreateOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsCreateOpen(false);\n    setEditingBlock(null);\n    setName(\"\");\n    setAddress(\"\");\n    setNotes(\"\");\n    setSelectedTags([]);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!name || !address) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (editingBlock) {\n      updateBlockMutation.mutate({\n        id: editingBlock.id,\n        name,\n        address,\n        notes: notes || undefined\n      });\n    } else {\n      createBlockMutation.mutate({\n        name,\n        address,\n        notes: notes || undefined\n      });\n    }\n  };\n\n  const updateBlockTags = async (blockId: string, tags: Tag[]) => {\n    // Get current tags for the block\n    try {\n      const res = await fetch(`/api/blocks/${blockId}/tags`, { credentials: \"include\" });\n      const currentTags = res.ok ? await res.json() : [];\n      \n      // Remove tags that are no longer selected\n      for (const currentTag of currentTags) {\n        if (!tags.find(t => t.id === currentTag.id)) {\n          await apiRequest(\"DELETE\", `/api/blocks/${blockId}/tags/${currentTag.id}`);\n        }\n      }\n      \n      // Add new tags\n      for (const tag of tags) {\n        if (!currentTags.find((t: Tag) => t.id === tag.id)) {\n          await apiRequest(\"POST\", `/api/blocks/${blockId}/tags/${tag.id}`);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error updating block tags:\", error);\n    }\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Are you sure you want to delete this block? This cannot be undone.\")) {\n      deleteBlockMutation.mutate(id);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 md:p-8 lg:p-12 space-y-8\">\n      {/* Modern Header */}\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n        <div className=\"space-y-1\">\n          <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Blocks & Buildings</h1>\n          <p className=\"text-lg text-muted-foreground\">Manage your property complexes and building blocks</p>\n        </div>\n        <Button onClick={handleOpenCreate} size=\"lg\" className=\"transition-smooth\" data-testid=\"button-create-block\">\n          <Plus className=\"mr-2 h-5 w-5\" />\n          New Block\n        </Button>\n      </div>\n\n      {/* Modern Search Filter */}\n      {blocks.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"max-w-2xl\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-4 top-1/2 transform -translate-y-1/2 text-muted-foreground h-5 w-5\" />\n              <Input\n                placeholder=\"Search blocks by name or address...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-12 h-12 text-base glass-card border-border/50\"\n                data-testid=\"input-search-blocks\"\n              />\n            </div>\n          </div>\n          <TagFilter\n            selectedTags={filterTags}\n            onTagsChange={setFilterTags}\n            placeholder=\"Filter by tags...\"\n          />\n        </div>\n      )}\n\n      {/* Content Area */}\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-24\">\n          <div className=\"flex flex-col items-center gap-4\">\n            <div className=\"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin\" />\n            <p className=\"text-muted-foreground\">Loading blocks...</p>\n          </div>\n        </div>\n      ) : blocks.length === 0 ? (\n        <Card className=\"glass-card-strong\">\n          <CardContent className=\"flex flex-col items-center justify-center py-16 md:py-24\">\n            <div className=\"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mb-6\">\n              <Building className=\"h-10 w-10 text-primary\" />\n            </div>\n            <h3 className=\"text-2xl font-semibold mb-3\">No blocks yet</h3>\n            <p className=\"text-muted-foreground text-center mb-6 max-w-md\">\n              Create your first building block to organize properties and streamline management\n            </p>\n            <Button onClick={handleOpenCreate} size=\"lg\" className=\"transition-smooth\" data-testid=\"button-create-first-block\">\n              <Plus className=\"mr-2 h-5 w-5\" />\n              Create Block\n            </Button>\n          </CardContent>\n        </Card>\n      ) : filteredBlocks.length === 0 ? (\n        <Card className=\"glass-card\">\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <Search className=\"h-8 w-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-xl font-semibold mb-2\">No blocks found</h3>\n            <p className=\"text-muted-foreground text-center mb-6\">\n              Try adjusting your search query\n            </p>\n            <Button variant=\"outline\" onClick={() => setSearchQuery(\"\")} className=\"transition-smooth\">\n              Clear Search\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3\">\n          {filteredBlocks.map((block) => (\n            <Card key={block.id} data-testid={`card-block-${block.id}`} className=\"glass-card card-hover-lift overflow-hidden\">\n              <CardHeader className=\"pb-4\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <Link href={`/blocks/${block.id}`} className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-3 cursor-pointer group\">\n                      <div className=\"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0 group-hover:bg-primary/20 transition-smooth\">\n                        <Building className=\"h-5 w-5 text-primary\" />\n                      </div>\n                      <CardTitle className=\"text-xl font-bold truncate\">{block.name}</CardTitle>\n                    </div>\n                    <CardDescription className=\"line-clamp-2 cursor-pointer mt-3 text-base\">{block.address}</CardDescription>\n                  </Link>\n                  <div className=\"flex gap-1 flex-shrink-0\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={(e) => {\n                        e.preventDefault();\n                        handleOpenEdit(block);\n                      }}\n                      className=\"transition-smooth\"\n                      data-testid={`button-edit-block-${block.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={(e) => {\n                        e.preventDefault();\n                        handleDelete(block.id);\n                      }}\n                      className=\"transition-smooth\"\n                      data-testid={`button-delete-block-${block.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4 text-destructive\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-5 pt-0\">\n                {/* Divider */}\n                <div className=\"h-px bg-border/30\" />\n\n                {/* Stats Grid */}\n                <div className=\"grid grid-cols-2 gap-5\">\n                  {/* Occupancy */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-lg bg-chart-3/10 flex items-center justify-center\">\n                        <Users className=\"h-4 w-4 text-chart-3\" />\n                      </div>\n                      <span className=\"text-xs font-medium text-muted-foreground\">Occupancy</span>\n                    </div>\n                    <div className=\"flex items-baseline gap-2\">\n                      <span className=\"text-2xl font-bold\" data-testid={`badge-occupancy-${block.id}`}>\n                        {block.stats?.occupancyRate || 0}%\n                      </span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {block.stats?.occupiedUnits || 0}/{block.stats?.totalUnits || 0}\n                      </span>\n                    </div>\n                  </div>\n\n                  {/* Compliance */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${(block.stats?.complianceRate || 0) >= 80 ? 'bg-accent/10' : 'bg-destructive/10'}`}>\n                        <CheckCircle2 className={`h-4 w-4 ${(block.stats?.complianceRate || 0) >= 80 ? 'text-accent' : 'text-destructive'}`} />\n                      </div>\n                      <span className=\"text-xs font-medium text-muted-foreground\">Compliance</span>\n                    </div>\n                    <div className=\"flex items-baseline gap-2\">\n                      <span className={`text-2xl font-bold ${(block.stats?.complianceRate || 0) >= 80 ? 'text-accent' : 'text-destructive'}`} data-testid={`badge-compliance-${block.id}`}>\n                        {block.stats?.complianceRate || 0}%\n                      </span>\n                    </div>\n                  </div>\n\n                  {/* Due Soon */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center\">\n                        <Calendar className=\"h-4 w-4 text-primary\" />\n                      </div>\n                      <span className=\"text-xs font-medium text-muted-foreground\">Due Soon</span>\n                    </div>\n                    <div className=\"flex items-baseline gap-2\">\n                      <span className=\"text-2xl font-bold\" data-testid={`badge-due-${block.id}`}>\n                        {block.stats?.inspectionsDue || 0}\n                      </span>\n                    </div>\n                  </div>\n\n                  {/* Overdue */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${(block.stats?.overdueInspections || 0) > 0 ? 'bg-destructive/10' : 'bg-muted'}`}>\n                        <AlertTriangle className={`h-4 w-4 ${(block.stats?.overdueInspections || 0) > 0 ? 'text-destructive' : 'text-muted-foreground'}`} />\n                      </div>\n                      <span className=\"text-xs font-medium text-muted-foreground\">Overdue</span>\n                    </div>\n                    <div className=\"flex items-baseline gap-2\">\n                      <span className={`text-2xl font-bold ${(block.stats?.overdueInspections || 0) > 0 ? 'text-destructive' : ''}`} data-testid={`badge-overdue-${block.id}`}>\n                        {block.stats?.overdueInspections || 0}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Notes */}\n                {block.notes && (\n                  <>\n                    <div className=\"h-px bg-border/30\" />\n                    <div className=\"space-y-1\">\n                      <span className=\"text-xs font-medium text-muted-foreground\">Notes</span>\n                      <p className=\"text-sm text-foreground line-clamp-2\">{block.notes}</p>\n                    </div>\n                  </>\n                )}\n\n                {/* Tags */}\n                {block.tags && block.tags.length > 0 && (\n                  <>\n                    <div className=\"h-px bg-border/30\" />\n                    <div className=\"space-y-2\">\n                      <span className=\"text-xs font-medium text-muted-foreground\">Tags</span>\n                      <div className=\"flex flex-wrap gap-1.5\">\n                        {block.tags.map(tag => (\n                          <Badge\n                            key={tag.id}\n                            variant=\"secondary\"\n                            className=\"gap-1 text-xs\"\n                            style={{ backgroundColor: tag.color || undefined }}\n                            data-testid={`tag-${block.id}-${tag.id}`}\n                          >\n                            <TagIcon className=\"h-3 w-3\" />\n                            {tag.name}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  </>\n                )}\n                \n                {/* Quick Actions */}\n                <div className=\"h-px bg-border/30\" />\n                <div className=\"flex items-center justify-around -mx-2\">\n                  <Link href={`/properties?blockId=${block.id}`}>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"flex flex-col h-auto py-2 px-3\"\n                      data-testid={`button-properties-${block.id}`}\n                    >\n                      <Home className=\"h-4 w-4 mb-1\" />\n                      <span className=\"text-xs\">Properties</span>\n                    </Button>\n                  </Link>\n                  <Link href={`/asset-inventory?blockId=${block.id}`}>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"flex flex-col h-auto py-2 px-3\"\n                      data-testid={`button-inventory-${block.id}`}\n                    >\n                      <Package className=\"h-4 w-4 mb-1\" />\n                      <span className=\"text-xs\">Inventory</span>\n                    </Button>\n                  </Link>\n                  <Link href={`/inspections?blockId=${block.id}&create=true`}>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"flex flex-col h-auto py-2 px-3\"\n                      data-testid={`button-inspect-${block.id}`}\n                    >\n                      <ClipboardCheck className=\"h-4 w-4 mb-1\" />\n                      <span className=\"text-xs\">Inspect</span>\n                    </Button>\n                  </Link>\n                  <Link href={`/blocks/${block.id}/tenants`}>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"flex flex-col h-auto py-2 px-3\"\n                      data-testid={`button-tenants-${block.id}`}\n                    >\n                      <Users className=\"h-4 w-4 mb-1\" />\n                      <span className=\"text-xs\">Tenants</span>\n                    </Button>\n                  </Link>\n                  <Link href={`/compliance?blockId=${block.id}`}>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"flex flex-col h-auto py-2 px-3\"\n                      data-testid={`button-compliance-${block.id}`}\n                    >\n                      <FileText className=\"h-4 w-4 mb-1\" />\n                      <span className=\"text-xs\">Compliance</span>\n                    </Button>\n                  </Link>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{editingBlock ? \"Edit Block\" : \"Create New Block\"}</DialogTitle>\n            <DialogDescription>\n              {editingBlock ? \"Update the block details below\" : \"Add a new building block to your organization\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Block Name *</Label>\n              <Input\n                id=\"name\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                placeholder=\"e.g., Block A, East Wing, Tower 1\"\n                data-testid=\"input-block-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"address\">Address *</Label>\n              <AddressInput\n                id=\"address\"\n                value={address}\n                onChange={setAddress}\n                placeholder=\"123 Main Street, City, Postcode\"\n                data-testid=\"input-block-address\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">Notes</Label>\n              <Textarea\n                id=\"notes\"\n                value={notes}\n                onChange={(e) => setNotes(e.target.value)}\n                placeholder=\"Additional information about this block\"\n                rows={3}\n                data-testid=\"input-block-notes\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Tags</Label>\n              <TagInput\n                selectedTags={selectedTags}\n                onTagsChange={setSelectedTags}\n                placeholder=\"Add tags to organize this block...\"\n              />\n            </div>\n\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={handleCloseDialog} data-testid=\"button-cancel\">\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createBlockMutation.isPending || updateBlockMutation.isPending}\n                data-testid=\"button-submit-block\"\n              >\n                {editingBlock ? \"Update\" : \"Create\"} Block\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":25355},"attached_assets/SPECIFICATION.md":{"content":"# Inspect360 - Comprehensive Feature Specification\n\nThis document contains the full product specification for Inspect360, including planned features beyond the current MVP implementation.\n\n## Current Implementation Status\n\nThe current MVP uses:\n- **Backend:** Express.js + PostgreSQL + Drizzle ORM\n- **Frontend:** React + Vite + Wouter\n- **Auth:** Passport.js Local Strategy (username/password)\n- **Storage:** Google Cloud Storage via Replit Object Storage\n- **AI:** OpenAI Vision API via Replit AI Integrations\n- **Payments:** Stripe\n\nThis specification document describes an alternative architecture (Supabase + Next.js) and extended features. We reference this spec for feature ideas while maintaining our current tech stack.\n\n---\n\n## 1. Team Structure & Roles\n\nEach user belongs to an organisation and has one role. Dashboards and permissions are role-scoped via RLS.\n\n**Owner Operator:** full org control, billing/credits, invite users, all data visibility.\n\n**Inventory Clerk (Inspector):** sees assigned inspections, creates/edits their inspections, no billing.\n\n**Compliance Officer:** CRUD compliance docs/checks, read inspections, no billing.\n\n**Contractor:** reads assigned work orders, uploads logs/photos, limited PII.\n\n**Tenant:** portal access for their property only; can log maintenance, view summaries/comparisons, comment.\n\n## 2. Data Model\n\nAll tables have id uuid pk default gen_random_uuid(), created_at timestamptz default now(), updated_at timestamptz default now().\n\n### 2.1 Core tenancy\n\n**organisations**(name, billing_email, stripe_customer_id, stripe_sub_id, plan, monthly_credits int, credits_used int, billing_period_start, billing_period_end)\n\n**profiles**(user_id uuid, organisation_id uuid, full_name, role enum, phone, current_property_id uuid nullable)\n\n**memberships**(organisation_id, user_id, role, status enum(invited|active|disabled))\n\n### 2.2 Estate\n\n**blocks**(organisation_id, name, address_json, notes)\n\n**properties**(organisation_id, block_id, unit_ref, bedrooms, bathrooms, floor, sqft, status enum(occupied|vacant), current_tenant_profile_id uuid nullable)\n\n### 2.3 Contacts & Tags\n\n**contacts**(organisation_id, type enum(person|company), name, email, phone, role_note)\n\n**tags**(organisation_id, label, color)\n\n**tag_links**(tag_id, entity_type text, entity_id uuid)\nentity_type in ['contact','document','inspection','property','maintenance_request']\n\n### 2.4 Compliance\n\n**compliance_docs**(organisation_id, block_id?, property_id?, title, type, issuer, reference_no, issue_date, expiry_date, file_url, status enum(valid|expiring|expired))\n\n**compliance_rules**(code, name, description, frequency_days int, applies_to enum(block|property)) (seed)\n\n**compliance_checks**(organisation_id, rule_id, target_type enum(block|property), target_id uuid, due_date, status enum(due|done|overdue), completed_by uuid nullable)\n\n### 2.5 Inventory\n\n**inventory_templates**(organisation_id, name, json_schema jsonb)\n\n**inventories**(organisation_id, property_id, template_id, version int, is_active bool)\n\n**inventory_items**(inventory_id, path text, item_name, baseline_condition int, baseline_cleanliness int, baseline_photos text[])\n\n### 2.6 Inspections\n\n**inspections**(organisation_id, property_id, type enum(check_in|check_out|routine), scheduled_at, assigned_to uuid, started_at, submitted_at, status enum(scheduled|in_progress|submitted|approved), latitude numeric, longitude numeric, offline_id text)\n\n**inspection_entries**(inspection_id, inventory_item_id, condition_rating int, cleanliness_rating int, notes text, photos text[], defects_json jsonb, maintenance_flag bool)\n\n**ai_image_analyses**(inspection_entry_id, model text, result_json jsonb, confidence numeric, annotations_url text)\n\n**comparison_reports**(organisation_id, property_id, baseline_inspection_id, target_inspection_id, diff_json jsonb, liability enum(tenant|operator|shared|none), summary_text text, resolved bool)\n\n**comparison_comments**(report_id, author_profile_id, message text, role_at_time text, resolved bool)\n\n### 2.7 Maintenance\n\n**maintenance_requests**(organisation_id, property_id, raised_by_type enum(tenant|staff), raised_by_profile_id uuid, source enum(tenant_portal|internal|inspection), title, description, priority enum(low|med|high|urgent), status enum(new|triage|assigned|in_progress|waiting_parts|completed|rejected), photos text[])\n\n**work_orders**(organisation_id, request_id, contractor_profile_id, sla_due timestamptz, cost_estimate numeric, cost_actual numeric, variation_json jsonb, completed_at)\n\n**work_logs**(work_order_id, note, photos text[], time_spent_minutes int)\n\n### 2.8 Scheduling & Credits\n\n**schedules**(organisation_id, assignee_profile_id, inspection_id, start_at, end_at, status enum(assigned|accepted|declined|done))\n\n**credit_ledger**(organisation_id, reason enum(inspection_submit|manual_adjust|stripe_renewal), delta int, balance_after int, meta_json jsonb)\n\n### 2.9 Documents & Audit\n\n**documents**(organisation_id, entity_type text, entity_id uuid, title, file_url, mime_type, uploaded_by uuid, tags text[])\n\n**audit_events**(organisation_id, actor_profile_id, action, entity_type, entity_id, diff_json jsonb, ip text, user_agent text)\n\n**Indexes:**\nComposite (organisation_id, property_id), (organisation_id, status), (organisation_id, scheduled_at) on hot tables; GIN on JSONB where needed.\n\n## 3. RLS (Row-Level Security)  Policy Sketch\n\nEnable RLS on all tables.\n\n**Org member read:** organisation_id IN (SELECT organisation_id FROM memberships WHERE user_id = auth.uid() AND status='active')\n\n**Role-based write:** Allow per role on specific tables (e.g., inspectors can insert/update their inspections where assigned_to = profiles.id).\n\n**Tenant scoping:** Tenants can select rows where properties.id = profiles.current_property_id.\n\n**Contractor scoping:** Contractors can select work_orders where contractor_profile_id = profiles.id.\n\n## 4. Storage Buckets\n\n- inspection-photos/ORG/INSPECTION/...\n- compliance-docs/ORG/...\n- work-order-photos/ORG/...\n- reports/ORG/... (PDFs)\n\nUse short-TTL signed URLs client-side; uploads via PWA queue when offline.\n\n## 5. PWA (Priority #1)\n\n### Manifest\n\n```json\n{\n  \"name\": \"Inspect360\",\n  \"short_name\": \"Inspect360\",\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"theme_color\": \"#003764\",\n  \"background_color\": \"#ffffff\",\n  \"icons\": [{ \"src\": \"/icons/icon-512.png\", \"sizes\": \"512x512\", \"type\": \"image/png\" }]\n}\n```\n\n### Service Worker Requirements\n\n- Cache app shell (/, CSS/JS) using stale-while-revalidate.\n- Cache inspection forms & reference data (inventory) for offline.\n- Background Sync queue: inspections, photos, maintenance requests.\n- Local store mapping offline_id  server id to dedupe on retry.\n- \"Sync Center\" UI to show pending uploads & retry.\n\n## 6. AI Edge Functions\n\n### ai_analyse_image\n- Input: { inspection_entry_id, image_urls[] }\n- Output: { result_json (labels,bboxes,scores), annotations_url }\n- Write to ai_image_analyses.\n\n### generate_comparison_report\n- Input: { baseline_inspection_id, target_inspection_id }\n- Process: Match by inventory_item_id, compute deltas (condition/cleanliness), merge AI detections, suggest liability.\n- Output: insert into comparison_reports + return report_id.\n\n## 7. Stripe Billing & Credits\n\n**Plans:** Starter (100), Growth (500), Scale (2000). Annual variants. Optional metered overage.\n\n### Flow\n\nCheckout  customer.subscription.updated webhook  set organisations.plan, monthly_credits, credits_used=0 and ledger entry stripe_renewal.\n\nOn inspection submit: server check credits_used < monthly_credits; increment credits_used and write ledger inspection_submit. If exceeded and no overage  block with upgrade CTA.\n\n### Edge Function: stripe_webhook\nHandle checkout.session.completed, customer.subscription.updated, invoice.paid, customer.subscription.deleted. Idempotency via Stripe event.id + audit_events.\n\n## 8. App Routes (Next.js App Router)\n\n- /login | /register\n- /app (layout)\n  - /app/dashboard (role-aware)\n  - /app/blocks | /app/blocks/[id]\n  - /app/properties | /app/properties/[id]\n  - /app/inspections | /app/inspections/[id]\n  - /app/inspections/new\n  - /app/comparisons/[id]\n  - /app/maintenance | /app/maintenance/[id]\n  - /app/compliance | /app/compliance/upload\n  - /app/contacts | /app/tags\n  - /app/billing\n  - /app/settings\n\n- /tenant (separate layout)\n  - /tenant/login (magic link)\n  - /tenant/home\n  - /tenant/maintenance\n  - /tenant/comparisons/[id]\n\n## 9. Key Screens & UX\n\n**Owner Dashboard:** credits used vs plan, inspections this period, compliance %, high-risk AI flags, open maintenance.\n\n**Clerk \"My Day\" (PWA):** assigned list, start inspection, offline banner, photo capture, autosave, submit.\n\n**Compliance Center:** expiring in 30/60/90, upload doc, status chips.\n\n**Maintenance Board:** Kanban by status; SLA highlighting; contractor assignment.\n\n**Tenant Portal:** log request, track status, view comparison, comment thread.\n\n## 10. API/Handlers (server)\n\n- POST /api/inspections/:id/submit  validate, consume credit, queue AI batch.\n- POST /api/ai/analyse  proxy to Edge Function.\n- POST /api/comparisons  create report.\n- POST /api/maintenance  create request.\n- POST /api/stripe/webhook  billing sync.\n- GET /api/dashboards/role  role metrics payload.\n\nJWT from Supabase; server verifies and enforces org/role.\n\n## 11. Seed Data\n\n**Inventory templates:** Studio, 1-bed, 2-bed with standard rooms/items.\n\n**Compliance rules:** Gas, EICR, Fire Alarm with frequencies.\n\n**Tags:** mold-risk, water-ingress, H&S, VIP, warranty.\n\n## 12. Env Vars\n\n```\nNEXT_PUBLIC_SUPABASE_URL=\nNEXT_PUBLIC_SUPABASE_ANON_KEY=\nSUPABASE_SERVICE_ROLE_KEY=\n\nSTRIPE_SECRET_KEY=\nSTRIPE_WEBHOOK_SECRET=\n\nAI_PROVIDER=openai\nAI_API_KEY=\n```\n\n## 13. Definition of Done (MVP)\n\n- PWA installable; offline inspection capture with background sync.\n- RLS correctly restricts all roles/orgs.\n- Create  assign  submit inspection with photos; AI analysis recorded.\n- Comparison report generation and thread with tenant.\n- Tenant portal logs/reads maintenance and comparison summaries.\n- Compliance upload + expiry status with alerts.\n- Stripe checkout + credits gating on submission.\n- Role dashboards populated.\n- Audit trail on key mutations.\n\n## 14. Nice-to-Have (Phase 2)\n\nRoute optimization for clerks, push notifications, contractor marketplace, OCR for compliance docs, photo de-dup/compression, white-label org themes.\n\n## 15. Brand/UI Notes\n\n**Palette (from logo):**\n- Navy #003764 (primary)\n- Green #59B677 (CTA/success)\n- Deep Blue #000092 (secondary accents)\n- Black #000000 (text)\n\n**Components:**\n- Cards: white, rounded-xl, subtle shadows.\n- Primary button: navy; focus ring green. \n- CTA button: green.\n- Accessibility: WCAG AA contrast; visible focus states.\n","size_bytes":10799},"client/src/pages/Settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Settings as SettingsIcon, Tags, Users, Plus, Edit2, Trash2, Plug, UsersIcon } from \"lucide-react\";\nimport { insertInspectionCategorySchema, type InspectionCategory } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport Team from \"./Team\";\nimport FixfloIntegrationSettings from \"@/components/FixfloIntegrationSettings\";\nimport SettingsTeamsPanel from \"@/components/SettingsTeamsPanel\";\n\nconst categoryFormSchema = insertInspectionCategorySchema.extend({\n  name: z.string().min(1, \"Category name is required\"),\n  sortOrder: z.coerce.number().min(0, \"Sort order must be 0 or greater\"),\n});\n\ntype CategoryFormValues = z.infer<typeof categoryFormSchema>;\n\nexport default function Settings() {\n  const { toast } = useToast();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingCategory, setEditingCategory] = useState<InspectionCategory | null>(null);\n\n  // Fetch inspection categories\n  const { data: categories, isLoading: categoriesLoading } = useQuery<InspectionCategory[]>({\n    queryKey: [\"/api/inspection-categories\"],\n  });\n\n  // Create category mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: CategoryFormValues) => {\n      return await apiRequest(\"POST\", \"/api/inspection-categories\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-categories\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection category created successfully\",\n      });\n      setIsCreateDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create category\",\n      });\n    },\n  });\n\n  // Update category mutation\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<CategoryFormValues> }) => {\n      return await apiRequest(\"PATCH\", `/api/inspection-categories/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-categories\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection category updated successfully\",\n      });\n      setEditingCategory(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update category\",\n      });\n    },\n  });\n\n  // Delete category mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await apiRequest(\"DELETE\", `/api/inspection-categories/${id}`);\n      // DELETE endpoints typically return 204 No Content with empty body\n      // Only parse JSON if there's content\n      if (res.status === 204 || res.headers.get(\"content-length\") === \"0\") {\n        return null;\n      }\n      const text = await res.text();\n      return text ? JSON.parse(text) : null;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-categories\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection category deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to delete category\",\n      });\n    },\n  });\n\n  const createForm = useForm<CategoryFormValues>({\n    resolver: zodResolver(categoryFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      sortOrder: 0,\n    },\n  });\n\n  const editForm = useForm<CategoryFormValues>({\n    resolver: zodResolver(categoryFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      sortOrder: 0,\n    },\n  });\n\n  // Update edit form when editingCategory changes\n  if (editingCategory && editForm.getValues().name !== editingCategory.name) {\n    editForm.reset({\n      name: editingCategory.name,\n      description: editingCategory.description ?? \"\",\n      sortOrder: editingCategory.sortOrder ?? 0,\n    });\n  }\n\n  const onCreateSubmit = (data: CategoryFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: CategoryFormValues) => {\n    if (editingCategory) {\n      updateMutation.mutate({ id: editingCategory.id, data });\n    }\n  };\n\n  return (\n    <div className=\"p-8 bg-background min-h-screen\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"flex items-center gap-3 mb-8\">\n          <div className=\"p-3 rounded-2xl bg-primary/10 backdrop-blur-xl\">\n            <SettingsIcon className=\"w-8 h-8 text-primary\" />\n          </div>\n          <div>\n            <h1 className=\"text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-primary/60\">\n              Settings\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">Manage your organization configuration</p>\n          </div>\n        </div>\n\n        <Tabs defaultValue=\"categories\" className=\"w-full\">\n          <TabsList className=\"grid w-full max-w-3xl grid-cols-4 mb-8\">\n            <TabsTrigger value=\"categories\" className=\"gap-2\" data-testid=\"tab-inspection-categories\">\n              <Tags className=\"w-4 h-4\" />\n              Inspection Categories\n            </TabsTrigger>\n            <TabsTrigger value=\"teams\" className=\"gap-2\" data-testid=\"tab-teams\">\n              <UsersIcon className=\"w-4 h-4\" />\n              Teams\n            </TabsTrigger>\n            <TabsTrigger value=\"team\" className=\"gap-2\" data-testid=\"tab-team-members\">\n              <Users className=\"w-4 h-4\" />\n              Team Members\n            </TabsTrigger>\n            <TabsTrigger value=\"integrations\" className=\"gap-2\" data-testid=\"tab-integrations\">\n              <Plug className=\"w-4 h-4\" />\n              Integrations\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"categories\" className=\"space-y-6\">\n            <Card className=\"border-2 rounded-2xl bg-card/80 backdrop-blur-xl shadow-lg\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"text-2xl\">Inspection Categories</CardTitle>\n                    <CardDescription className=\"mt-2\">\n                      Manage inspection item categories for consistent reporting\n                    </CardDescription>\n                  </div>\n                  <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button className=\"gap-2\" data-testid=\"button-create-category\">\n                        <Plus className=\"w-4 h-4\" />\n                        Add Category\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>Create Inspection Category</DialogTitle>\n                        <DialogDescription>\n                          Add a new category for organizing inspection items\n                        </DialogDescription>\n                      </DialogHeader>\n                      <Form {...createForm}>\n                        <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                          <FormField\n                            control={createForm.control}\n                            name=\"name\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Category Name</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"e.g., Kitchen, Bathroom, Living Room\" {...field} data-testid=\"input-category-name\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={createForm.control}\n                            name=\"description\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Description (Optional)</FormLabel>\n                                <FormControl>\n                                  <Input placeholder=\"Brief description of this category\" {...field} value={field.value ?? \"\"} data-testid=\"input-category-description\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={createForm.control}\n                            name=\"sortOrder\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Sort Order</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" placeholder=\"0\" {...field} data-testid=\"input-category-sort-order\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <DialogFooter>\n                            <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-category\">\n                              {createMutation.isPending ? \"Creating...\" : \"Create Category\"}\n                            </Button>\n                          </DialogFooter>\n                        </form>\n                      </Form>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {categoriesLoading ? (\n                  <div className=\"text-center py-12 text-muted-foreground\">Loading categories...</div>\n                ) : !categories || categories.length === 0 ? (\n                  <div className=\"text-center py-12\">\n                    <Tags className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground/40\" />\n                    <p className=\"text-muted-foreground\">No inspection categories yet</p>\n                    <p className=\"text-sm text-muted-foreground/60 mt-1\">\n                      Create categories to organize your inspection items\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"grid gap-4\">\n                    {categories\n                      .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))\n                      .map((category) => (\n                        <Card key={category.id} className=\"bg-muted/30 hover-elevate\" data-testid={`category-card-${category.id}`}>\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex-1\">\n                                <h3 className=\"font-semibold text-lg\">{category.name}</h3>\n                                {category.description && (\n                                  <p className=\"text-sm text-muted-foreground mt-1\">{category.description}</p>\n                                )}\n                                <p className=\"text-xs text-muted-foreground/60 mt-1\">Sort Order: {category.sortOrder || 0}</p>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Dialog open={editingCategory?.id === category.id} onOpenChange={(open) => !open && setEditingCategory(null)}>\n                                  <DialogTrigger asChild>\n                                    <Button variant=\"ghost\" size=\"sm\" onClick={() => setEditingCategory(category)} data-testid={`button-edit-category-${category.id}`}>\n                                      <Edit2 className=\"w-4 h-4\" />\n                                    </Button>\n                                  </DialogTrigger>\n                                  <DialogContent>\n                                    <DialogHeader>\n                                      <DialogTitle>Edit Inspection Category</DialogTitle>\n                                      <DialogDescription>\n                                        Update the category details\n                                      </DialogDescription>\n                                    </DialogHeader>\n                                    <Form {...editForm}>\n                                      <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n                                        <FormField\n                                          control={editForm.control}\n                                          name=\"name\"\n                                          render={({ field }) => (\n                                            <FormItem>\n                                              <FormLabel>Category Name</FormLabel>\n                                              <FormControl>\n                                                <Input {...field} data-testid=\"input-edit-category-name\" />\n                                              </FormControl>\n                                              <FormMessage />\n                                            </FormItem>\n                                          )}\n                                        />\n                                        <FormField\n                                          control={editForm.control}\n                                          name=\"description\"\n                                          render={({ field }) => (\n                                            <FormItem>\n                                              <FormLabel>Description (Optional)</FormLabel>\n                                              <FormControl>\n                                                <Input {...field} value={field.value ?? \"\"} data-testid=\"input-edit-category-description\" />\n                                              </FormControl>\n                                              <FormMessage />\n                                            </FormItem>\n                                          )}\n                                        />\n                                        <FormField\n                                          control={editForm.control}\n                                          name=\"sortOrder\"\n                                          render={({ field }) => (\n                                            <FormItem>\n                                              <FormLabel>Sort Order</FormLabel>\n                                              <FormControl>\n                                                <Input type=\"number\" {...field} data-testid=\"input-edit-category-sort-order\" />\n                                              </FormControl>\n                                              <FormMessage />\n                                            </FormItem>\n                                          )}\n                                        />\n                                        <DialogFooter>\n                                          <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-category\">\n                                            {updateMutation.isPending ? \"Updating...\" : \"Update Category\"}\n                                          </Button>\n                                        </DialogFooter>\n                                      </form>\n                                    </Form>\n                                  </DialogContent>\n                                </Dialog>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    if (confirm(\"Are you sure you want to delete this category?\")) {\n                                      deleteMutation.mutate(category.id);\n                                    }\n                                  }}\n                                  disabled={deleteMutation.isPending}\n                                  data-testid={`button-delete-category-${category.id}`}\n                                >\n                                  <Trash2 className=\"w-4 h-4 text-destructive\" />\n                                </Button>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"teams\">\n            <SettingsTeamsPanel />\n          </TabsContent>\n\n          <TabsContent value=\"team\">\n            <Team />\n          </TabsContent>\n\n          <TabsContent value=\"integrations\">\n            <FixfloIntegrationSettings />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","size_bytes":18109},"client/src/pages/AssetInventory.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useSearch, Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { extractFileUrlFromUploadResponse } from \"@/lib/utils\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport { Package, Plus, Edit2, Trash2, Building2, Home, Calendar, Wrench, Search, DollarSign, FileText, MapPin, Tag as TagIcon, ArrowLeft } from \"lucide-react\";\nimport type { AssetInventory, Property, Block } from \"@shared/schema\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format } from \"date-fns\";\nimport Uppy from \"@uppy/core\";\nimport { Dashboard } from \"@uppy/react\";\nimport AwsS3 from \"@uppy/aws-s3\";\n\nconst conditionLabels = {\n  excellent: \"Excellent\",\n  good: \"Good\",\n  fair: \"Fair\",\n  poor: \"Poor\",\n  needs_replacement: \"Needs Replacement\",\n};\n\nconst cleanlinessLabels = {\n  very_clean: \"Very Clean\",\n  clean: \"Clean\",\n  acceptable: \"Acceptable\",\n  needs_cleaning: \"Needs Cleaning\",\n  not_applicable: \"Not Applicable\",\n};\n\nconst assetCategories = [\n  \"HVAC\",\n  \"Appliances\",\n  \"Furniture\",\n  \"Plumbing\",\n  \"Electrical\",\n  \"Flooring\",\n  \"Windows & Doors\",\n  \"Security\",\n  \"Landscaping\",\n  \"Lighting\",\n  \"Kitchen Equipment\",\n  \"Bathroom Fixtures\",\n  \"Other\",\n];\n\n// Helper function to normalize photo URLs (convert relative to absolute)\nconst normalizePhotoUrl = (url: string | null | undefined): string | null => {\n  if (!url) return null;\n  \n  // If already absolute URL, return as is\n  if (url.startsWith('http://') || url.startsWith('https://')) {\n    return url;\n  }\n  \n  // If relative path, convert to absolute\n  if (url.startsWith('/')) {\n    return `${window.location.origin}${url}`;\n  }\n  \n  // Return as is if it's already in a valid format\n  return url;\n};\n\nexport default function AssetInventory() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const locale = useLocale();\n  const searchParams = useSearch();\n  const urlParams = new URLSearchParams(searchParams);\n  const blockIdFromUrl = urlParams.get(\"blockId\");\n  const propertyIdFromUrl = urlParams.get(\"propertyId\");\n  \n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingAsset, setEditingAsset] = useState<AssetInventory | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [filterCategory, setFilterCategory] = useState<string>(\"all\");\n  const [filterCondition, setFilterCondition] = useState<string>(\"all\");\n  const [filterLocation, setFilterLocation] = useState<string>(\"all\");\n  const [uploadedPhotos, setUploadedPhotos] = useState<string[]>([]);\n\n  // Form state\n  const [formData, setFormData] = useState<Partial<AssetInventory>>({});\n\n  // Fetch assets\n  const { data: assets, isLoading } = useQuery<AssetInventory[]>({\n    queryKey: [\"/api/asset-inventory\"],\n  });\n\n  // Fetch properties\n  const { data: properties } = useQuery<Property[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  // Fetch blocks\n  const { data: blocks } = useQuery<Block[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  // Auto-filter by block or property if in URL\n  useEffect(() => {\n    if (blockIdFromUrl) {\n      setFilterLocation(blockIdFromUrl);\n    } else if (propertyIdFromUrl) {\n      setFilterLocation(propertyIdFromUrl);\n    }\n  }, [blockIdFromUrl, propertyIdFromUrl]);\n\n  // Find the current block if filtering by block\n  const currentBlock = useMemo(() => {\n    if (!blockIdFromUrl || !blocks) return null;\n    return blocks.find(b => b.id === blockIdFromUrl);\n  }, [blockIdFromUrl, blocks]);\n\n  // Find the current property if filtering by property\n  const currentProperty = useMemo(() => {\n    if (!propertyIdFromUrl || !properties) return null;\n    return properties.find(p => p.id === propertyIdFromUrl);\n  }, [propertyIdFromUrl, properties]);\n\n  // Create/Update mutations\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<AssetInventory>) => {\n      if (editingAsset) {\n        const res = await apiRequest(\"PATCH\", `/api/asset-inventory/${editingAsset.id}`, data);\n        return await res.json();\n      } else {\n        const res = await apiRequest(\"POST\", \"/api/asset-inventory\", data);\n        return await res.json();\n      }\n    },\n    onSuccess: (result, variables) => {\n      // Invalidate global asset inventory query\n      queryClient.invalidateQueries({ queryKey: [\"/api/asset-inventory\"] });\n      \n      // Invalidate property-specific inventory query if propertyId exists in submitted data\n      if (variables.propertyId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/properties\", variables.propertyId, \"inventory\"] });\n      }\n      \n      // Invalidate block-specific inventory query if blockId exists in submitted data\n      if (variables.blockId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/blocks\", variables.blockId, \"inventory\"] });\n      }\n      \n      // Also invalidate URL-based context if different from submitted data\n      if (propertyIdFromUrl && propertyIdFromUrl !== variables.propertyId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/properties\", propertyIdFromUrl, \"inventory\"] });\n      }\n      if (blockIdFromUrl && blockIdFromUrl !== variables.blockId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/blocks\", blockIdFromUrl, \"inventory\"] });\n      }\n      \n      toast({\n        title: \"Success\",\n        description: editingAsset ? \"Asset updated successfully\" : \"Asset created successfully\",\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to save asset\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await apiRequest(\"DELETE\", `/api/asset-inventory/${id}`);\n      // DELETE endpoints typically return 204 No Content with empty body\n      // Only parse JSON if there's content\n      if (res.status === 204 || res.headers.get(\"content-length\") === \"0\") {\n        return null;\n      }\n      const text = await res.text();\n      return text ? JSON.parse(text) : null;\n    },\n    onSuccess: () => {\n      // Invalidate global asset inventory\n      queryClient.invalidateQueries({ queryKey: [\"/api/asset-inventory\"] });\n      \n      // Invalidate all property and block inventory queries\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\"], predicate: (query) => \n        query.queryKey[2] === \"inventory\"\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocks\"], predicate: (query) => \n        query.queryKey[2] === \"inventory\"\n      });\n      \n      toast({\n        title: \"Success\",\n        description: \"Asset deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to delete asset\",\n      });\n    },\n  });\n\n  const uppy = useMemo(() => {\n    const uppyInstance = new Uppy({\n      restrictions: {\n        maxFileSize: 10 * 1024 * 1024,\n        maxNumberOfFiles: 10,\n        allowedFileTypes: ['image/*'],\n      },\n      autoProceed: false,\n    });\n\n    uppyInstance.use(AwsS3, {\n      shouldUseMultipart: false,\n      getUploadParameters: async (file) => {\n        try {\n          const response = await fetch('/api/objects/upload', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            credentials: 'include',\n          });\n\n          if (!response.ok) {\n            throw new Error(`Failed to get upload URL: ${response.statusText}`);\n          }\n\n          const data = await response.json();\n          \n          if (!data.uploadURL) {\n            throw new Error(\"Invalid upload URL response\");\n          }\n\n          // Ensure URL is absolute\n          let uploadURL = data.uploadURL;\n          if (uploadURL.startsWith('/')) {\n            // Convert relative URL to absolute\n            uploadURL = `${window.location.origin}${uploadURL}`;\n          }\n\n          // Validate URL\n          try {\n            new URL(uploadURL);\n          } catch (e) {\n            throw new Error(`Invalid upload URL format: ${uploadURL}`);\n          }\n\n          // Extract objectId from upload URL for later use\n          const urlObj = new URL(uploadURL);\n          const objectId = urlObj.searchParams.get('objectId') || urlObj.pathname.split('/').pop() || '';\n          \n          // Store metadata for later retrieval\n          uppyInstance.setFileMeta(file.id, { \n            originalUploadURL: uploadURL,\n            objectId: objectId,\n          });\n\n          return {\n            method: 'PUT',\n            url: uploadURL,\n            fields: {},\n            headers: {\n              'Content-Type': file.type || 'application/octet-stream',\n            },\n          };\n        } catch (error: any) {\n          console.error(\"[AssetInventory] Upload URL error:\", error);\n          throw new Error(`Failed to get upload URL: ${error.message}`);\n        }\n      },\n    });\n\n    uppyInstance.on('upload-success', async (file, response) => {\n      console.log('[AssetInventory] Upload success event:', { \n        file: { id: file?.id, name: file?.name, meta: file?.meta },\n        response,\n        fileResponse: file?.response,\n        fullFile: file\n      });\n      \n      // Extract the file URL from the PUT response using the utility function\n      // This handles both absolute and relative URLs and normalizes to /objects/...\n      let photoUrl = extractFileUrlFromUploadResponse(file, response);\n      \n      // If extraction failed, try to use objectId from metadata as fallback\n      if (!photoUrl && file?.meta?.objectId) {\n        photoUrl = `/objects/${file.meta.objectId}`;\n        console.log('[AssetInventory] Using objectId fallback:', photoUrl);\n      }\n      \n      if (!photoUrl) {\n        console.error('[AssetInventory] No photo URL found. Full debug info:', {\n          fileResponse: file?.response,\n          response,\n          fileMeta: file?.meta,\n          fileKeys: file ? Object.keys(file) : null,\n          responseKeys: response ? Object.keys(response) : null\n        });\n        toast({\n          variant: \"destructive\",\n          title: \"Upload Error\",\n          description: \"Upload succeeded but could not get photo URL. Please try again.\",\n        });\n        return;\n      }\n      \n      // photoUrl is already normalized to a relative path starting with /objects/\n      // Convert relative path to absolute URL for display\n      const absolutePhotoUrl = `${window.location.origin}${photoUrl}`;\n      console.log('[AssetInventory] Final photo URL:', absolutePhotoUrl);\n      \n      // Add photo to preview immediately\n      setUploadedPhotos(prev => {\n        // Avoid duplicates\n        if (prev.includes(absolutePhotoUrl)) {\n          return prev;\n        }\n        return [...prev, absolutePhotoUrl];\n      });\n      \n      // Set ACL for the uploaded photo (in background, don't block UI)\n      fetch('/api/objects/set-acl', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({ photoUrl: absolutePhotoUrl }),\n      })\n      .then(async (aclResponse) => {\n        if (aclResponse.ok) {\n          const { objectPath } = await aclResponse.json();\n          // If objectPath is different, update it (though it should be the same)\n          if (objectPath && objectPath !== photoUrl) {\n            const finalUrl = objectPath.startsWith('/') \n              ? `${window.location.origin}${objectPath}` \n              : objectPath;\n            \n            setUploadedPhotos(prev => {\n              const index = prev.indexOf(absolutePhotoUrl);\n              if (index >= 0) {\n                const updated = [...prev];\n                updated[index] = finalUrl;\n                return updated;\n              }\n              return prev;\n            });\n          }\n        }\n      })\n      .catch(error => {\n        console.error('[AssetInventory] Error setting ACL (non-blocking):', error);\n      });\n      \n      toast({\n        title: \"Photo uploaded\",\n        description: \"Photo has been uploaded successfully\",\n      });\n    });\n\n    return uppyInstance;\n  }, [toast]);\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingAsset(null);\n    setFormData({});\n    setUploadedPhotos([]);\n    uppy.cancelAll();\n  };\n\n  const handleOpenDialog = (asset?: AssetInventory) => {\n    if (asset) {\n      setEditingAsset(asset);\n      setFormData(asset);\n      setUploadedPhotos(asset.photos || []);\n    } else {\n      // Pre-populate property or block based on URL context\n      const initialFormData: Partial<AssetInventory> = {};\n      if (propertyIdFromUrl) {\n        initialFormData.propertyId = propertyIdFromUrl;\n      } else if (blockIdFromUrl) {\n        initialFormData.blockId = blockIdFromUrl;\n      }\n      setFormData(initialFormData);\n      setUploadedPhotos([]);\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Helper to convert dates - handles string inputs, Date objects, and undefined\n    const convertDate = (value: any) => {\n      if (!value || value === '') return null;\n      if (value instanceof Date) return value;\n      // If it's a string, try to parse it\n      const parsed = new Date(value);\n      return isNaN(parsed.getTime()) ? null : parsed;\n    };\n    \n    // Explicitly build submit data with proper type conversions\n    const submitData: any = {\n      organizationId: user?.organizationId || formData.organizationId,\n      name: formData.name,\n      category: formData.category || null,\n      description: formData.description || null,\n      condition: formData.condition,\n      cleanliness: formData.cleanliness || null,\n      propertyId: formData.propertyId || null,\n      blockId: formData.blockId || null,\n      location: formData.location || null,\n      datePurchased: convertDate(formData.datePurchased),\n      purchasePrice: formData.purchasePrice || null,\n      expectedLifespanYears: formData.expectedLifespanYears || null,\n      depreciationPerYear: formData.depreciationPerYear || null,\n      currentValue: formData.currentValue || null,\n      supplier: formData.supplier || null,\n      supplierContact: formData.supplierContact || null,\n      serialNumber: formData.serialNumber || null,\n      modelNumber: formData.modelNumber || null,\n      warrantyExpiryDate: convertDate(formData.warrantyExpiryDate),\n      lastMaintenanceDate: convertDate(formData.lastMaintenanceDate),\n      nextMaintenanceDate: convertDate(formData.nextMaintenanceDate),\n      maintenanceNotes: formData.maintenanceNotes || null,\n      photos: uploadedPhotos.length > 0 ? uploadedPhotos : formData.photos || [],\n      documents: formData.documents || [],\n    };\n\n    saveMutation.mutate(submitData);\n  };\n\n  // Calculate current value based on purchase price and depreciation\n  const calculateCurrentValue = (purchasePrice: number, depreciationPerYear: number, datePurchased: Date) => {\n    const yearsOwned = Math.floor((Date.now() - new Date(datePurchased).getTime()) / (1000 * 60 * 60 * 24 * 365));\n    const totalDepreciation = depreciationPerYear * yearsOwned;\n    return Math.max(0, purchasePrice - totalDepreciation);\n  };\n\n  // Filter assets\n  const filteredAssets = useMemo(() => {\n    if (!assets) return [];\n    \n    return assets.filter(asset => {\n      const matchesSearch = searchTerm === \"\" ||\n        asset.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        asset.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        asset.location?.toLowerCase().includes(searchTerm.toLowerCase());\n      \n      const matchesCategory = filterCategory === \"all\" || asset.category === filterCategory;\n      const matchesCondition = filterCondition === \"all\" || asset.condition === filterCondition;\n      const matchesLocation = filterLocation === \"all\" || asset.propertyId === filterLocation || asset.blockId === filterLocation;\n      \n      return matchesSearch && matchesCategory && matchesCondition && matchesLocation;\n    });\n  }, [assets, searchTerm, filterCategory, filterCondition, filterLocation]);\n\n  // Get unique locations\n  const locations = useMemo(() => {\n    const locs: Array<{ id: string; name: string; type: \"property\" | \"block\" }> = [];\n    properties?.forEach(p => locs.push({ id: p.id, name: p.address, type: \"property\" }));\n    blocks?.forEach(b => locs.push({ id: b.id, name: b.name, type: \"block\" }));\n    return locs;\n  }, [properties, blocks]);\n\n  if (isLoading) {\n    return <div className=\"p-8\">Loading...</div>;\n  }\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      {/* Header with optional block or property breadcrumb */}\n      {currentBlock && (\n        <Link href={`/blocks/${currentBlock.id}`}>\n          <Button variant=\"ghost\" className=\"mb-2\" data-testid=\"button-back-to-block\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to {currentBlock.name}\n          </Button>\n        </Link>\n      )}\n      {currentProperty && (\n        <Link href={`/properties/${currentProperty.id}`}>\n          <Button variant=\"ghost\" className=\"mb-2\" data-testid=\"button-back-to-property\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to {currentProperty.name}\n          </Button>\n        </Link>\n      )}\n      \n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">\n            {currentBlock \n              ? `${currentBlock.name} - Asset Inventory` \n              : currentProperty \n              ? `${currentProperty.name} - Asset Inventory`\n              : 'Asset Inventory'\n            }\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {currentBlock \n              ? `Assets and equipment in ${currentBlock.name}` \n              : currentProperty\n              ? `Assets and equipment in ${currentProperty.name}`\n              : 'Manage physical assets and equipment across your properties'\n            }\n          </p>\n        </div>\n\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-asset\" style={{ backgroundColor: '#00D2BD' }} className=\"hover:opacity-90\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Asset\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>{editingAsset ? \"Edit Asset\" : \"Add New Asset\"}</DialogTitle>\n              <DialogDescription>\n                {editingAsset ? \"Update asset information\" : \"Add a new asset to your inventory\"}\n              </DialogDescription>\n            </DialogHeader>\n\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\n              {/* Basic Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Basic Information</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"name\">Asset Name *</Label>\n                    <Input\n                      id=\"name\"\n                      value={formData.name || \"\"}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      placeholder=\"e.g., Refrigerator - Unit 101\"\n                      required\n                      data-testid=\"input-asset-name\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"category\">Category</Label>\n                    <Select\n                      value={formData.category || \"\"}\n                      onValueChange={(value) => setFormData({ ...formData, category: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-category\">\n                        <SelectValue placeholder=\"Select category\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {assetCategories.map((cat) => (\n                          <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"condition\">Condition *</Label>\n                    <Select\n                      value={formData.condition || \"\"}\n                      onValueChange={(value) => setFormData({ ...formData, condition: value as any })}\n                    >\n                      <SelectTrigger data-testid=\"select-condition\">\n                        <SelectValue placeholder=\"Select condition\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {Object.entries(conditionLabels).map(([value, label]) => (\n                          <SelectItem key={value} value={value}>{label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"cleanliness\">Cleanliness</Label>\n                    <Select\n                      value={formData.cleanliness || \"\"}\n                      onValueChange={(value) => setFormData({ ...formData, cleanliness: value as any })}\n                    >\n                      <SelectTrigger data-testid=\"select-cleanliness\">\n                        <SelectValue placeholder=\"Select cleanliness\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {Object.entries(cleanlinessLabels).map(([value, label]) => (\n                          <SelectItem key={value} value={value}>{label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"description\">Description</Label>\n                  <Textarea\n                    id=\"description\"\n                    value={formData.description || \"\"}\n                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                    placeholder=\"Detailed description of the asset...\"\n                    rows={3}\n                    data-testid=\"textarea-description\"\n                  />\n                </div>\n              </div>\n\n              {/* Location & Assignment */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Location & Assignment</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"property\">Property</Label>\n                    <Select\n                      value={formData.propertyId || \"\"}\n                      onValueChange={(value) => setFormData({ ...formData, propertyId: value, blockId: undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-property\">\n                        <SelectValue placeholder=\"Select property\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {properties?.map((property) => (\n                          <SelectItem key={property.id} value={property.id}>\n                            {property.address}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"block\">Block</Label>\n                    <Select\n                      value={formData.blockId || \"\"}\n                      onValueChange={(value) => setFormData({ ...formData, blockId: value, propertyId: undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-block\">\n                        <SelectValue placeholder=\"Select block\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {blocks?.map((block) => (\n                          <SelectItem key={block.id} value={block.id}>\n                            {block.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"col-span-2\">\n                    <Label htmlFor=\"location\">Specific Location</Label>\n                    <Input\n                      id=\"location\"\n                      value={formData.location || \"\"}\n                      onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n                      placeholder=\"e.g., Unit 101 - Kitchen, Common Area - Lobby\"\n                      data-testid=\"input-location\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Purchase & Financial Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Purchase & Financial Information</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"datePurchased\">Date Purchased</Label>\n                    <Input\n                      id=\"datePurchased\"\n                      type=\"date\"\n                      value={formData.datePurchased ? format(new Date(formData.datePurchased), 'yyyy-MM-dd') : \"\"}\n                      onChange={(e) => setFormData({ ...formData, datePurchased: e.target.value ? new Date(e.target.value) as any : undefined })}\n                      data-testid=\"input-date-purchased\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"purchasePrice\">Purchase Price ({locale.currencySymbol})</Label>\n                    <Input\n                      id=\"purchasePrice\"\n                      type=\"number\"\n                      step=\"0.01\"\n                      value={formData.purchasePrice?.toString() || \"\"}\n                      onChange={(e) => setFormData({ ...formData, purchasePrice: e.target.value as any })}\n                      placeholder=\"0.00\"\n                      data-testid=\"input-purchase-price\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"expectedLifespanYears\">Expected Lifespan (years)</Label>\n                    <Input\n                      id=\"expectedLifespanYears\"\n                      type=\"number\"\n                      value={formData.expectedLifespanYears?.toString() || \"\"}\n                      onChange={(e) => setFormData({ ...formData, expectedLifespanYears: parseInt(e.target.value) as any })}\n                      placeholder=\"10\"\n                      data-testid=\"input-lifespan\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"depreciationPerYear\">Depreciation per Year ({locale.currencySymbol})</Label>\n                    <Input\n                      id=\"depreciationPerYear\"\n                      type=\"number\"\n                      step=\"0.01\"\n                      value={formData.depreciationPerYear?.toString() || \"\"}\n                      onChange={(e) => setFormData({ ...formData, depreciationPerYear: e.target.value as any })}\n                      placeholder=\"0.00\"\n                      data-testid=\"input-depreciation\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Supplier & Product Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Supplier & Product Information</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"supplier\">Supplier</Label>\n                    <Input\n                      id=\"supplier\"\n                      value={formData.supplier || \"\"}\n                      onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}\n                      placeholder=\"e.g., Home Depot, Lowe's\"\n                      data-testid=\"input-supplier\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"supplierContact\">Supplier Contact</Label>\n                    <Input\n                      id=\"supplierContact\"\n                      value={formData.supplierContact || \"\"}\n                      onChange={(e) => setFormData({ ...formData, supplierContact: e.target.value })}\n                      placeholder=\"Phone or email\"\n                      data-testid=\"input-supplier-contact\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"serialNumber\">Serial Number</Label>\n                    <Input\n                      id=\"serialNumber\"\n                      value={formData.serialNumber || \"\"}\n                      onChange={(e) => setFormData({ ...formData, serialNumber: e.target.value })}\n                      placeholder=\"SN-123456\"\n                      data-testid=\"input-serial-number\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"modelNumber\">Model Number</Label>\n                    <Input\n                      id=\"modelNumber\"\n                      value={formData.modelNumber || \"\"}\n                      onChange={(e) => setFormData({ ...formData, modelNumber: e.target.value })}\n                      placeholder=\"Model-XYZ\"\n                      data-testid=\"input-model-number\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"warrantyExpiryDate\">Warranty Expiry Date</Label>\n                    <Input\n                      id=\"warrantyExpiryDate\"\n                      type=\"date\"\n                      value={formData.warrantyExpiryDate ? format(new Date(formData.warrantyExpiryDate), 'yyyy-MM-dd') : \"\"}\n                      onChange={(e) => setFormData({ ...formData, warrantyExpiryDate: e.target.value ? new Date(e.target.value) as any : undefined })}\n                      data-testid=\"input-warranty-expiry\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Maintenance Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Maintenance Information</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"lastMaintenanceDate\">Last Maintenance Date</Label>\n                    <Input\n                      id=\"lastMaintenanceDate\"\n                      type=\"date\"\n                      value={formData.lastMaintenanceDate ? format(new Date(formData.lastMaintenanceDate), 'yyyy-MM-dd') : \"\"}\n                      onChange={(e) => setFormData({ ...formData, lastMaintenanceDate: e.target.value ? new Date(e.target.value) as any : undefined })}\n                      data-testid=\"input-last-maintenance\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"nextMaintenanceDate\">Next Maintenance Date</Label>\n                    <Input\n                      id=\"nextMaintenanceDate\"\n                      type=\"date\"\n                      value={formData.nextMaintenanceDate ? format(new Date(formData.nextMaintenanceDate), 'yyyy-MM-dd') : \"\"}\n                      onChange={(e) => setFormData({ ...formData, nextMaintenanceDate: e.target.value ? new Date(e.target.value) as any : undefined })}\n                      data-testid=\"input-next-maintenance\"\n                    />\n                  </div>\n\n                  <div className=\"col-span-2\">\n                    <Label htmlFor=\"maintenanceNotes\">Maintenance Notes</Label>\n                    <Textarea\n                      id=\"maintenanceNotes\"\n                      value={formData.maintenanceNotes || \"\"}\n                      onChange={(e) => setFormData({ ...formData, maintenanceNotes: e.target.value })}\n                      placeholder=\"Notes about maintenance history or requirements...\"\n                      rows={3}\n                      data-testid=\"textarea-maintenance-notes\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Photos */}\n              <div className=\"space-y-4\">\n                <h3 className=\"font-semibold text-lg\">Photos</h3>\n                {uploadedPhotos.length > 0 && (\n                  <div className=\"grid grid-cols-4 gap-2\">\n                    {uploadedPhotos.map((url, index) => (\n                      <div key={index} className=\"relative\">\n                        <img src={normalizePhotoUrl(url) || url} alt={`Asset photo ${index + 1}`} className=\"w-full h-24 object-cover rounded\" />\n                        <Button\n                          type=\"button\"\n                          size=\"icon\"\n                          variant=\"destructive\"\n                          className=\"absolute top-1 right-1 h-6 w-6\"\n                          onClick={() => setUploadedPhotos(prev => prev.filter((_, i) => i !== index))}\n                        >\n                          <Trash2 className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n                <Dashboard uppy={uppy} proudlyDisplayPoweredByUppy={false} height={300} />\n              </div>\n\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={handleCloseDialog}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={saveMutation.isPending} data-testid=\"button-submit-asset\">\n                  {editingAsset ? \"Update Asset\" : \"Create Asset\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Filters */}\n      <div className=\"flex gap-4 items-center flex-wrap\">\n        <div className=\"relative flex-1 min-w-[300px]\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search assets by name, description, or location...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-assets\"\n          />\n        </div>\n\n        <Select value={filterCategory} onValueChange={setFilterCategory}>\n          <SelectTrigger className=\"w-48\" data-testid=\"select-filter-category\">\n            <SelectValue placeholder=\"All Categories\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Categories</SelectItem>\n            {assetCategories.map((cat) => (\n              <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        <Select value={filterCondition} onValueChange={setFilterCondition}>\n          <SelectTrigger className=\"w-48\" data-testid=\"select-filter-condition\">\n            <SelectValue placeholder=\"All Conditions\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Conditions</SelectItem>\n            {Object.entries(conditionLabels).map(([value, label]) => (\n              <SelectItem key={value} value={value}>{label}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        <Select value={filterLocation} onValueChange={setFilterLocation}>\n          <SelectTrigger className=\"w-48\" data-testid=\"select-filter-location\">\n            <SelectValue placeholder=\"All Locations\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Locations</SelectItem>\n            {locations.map((loc) => (\n              <SelectItem key={loc.id} value={loc.id}>\n                {loc.type === \"property\" ? <Home className=\"w-3 h-3 inline mr-1\" /> : <Building2 className=\"w-3 h-3 inline mr-1\" />}\n                {loc.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Assets Grid */}\n      {!filteredAssets || filteredAssets.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <Package className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">\n              {searchTerm || filterCategory !== \"all\" || filterCondition !== \"all\" ? \"No Assets Found\" : \"No Assets Yet\"}\n            </h3>\n            <p className=\"text-muted-foreground mb-4\">\n              {searchTerm || filterCategory !== \"all\" || filterCondition !== \"all\"\n                ? \"Try adjusting your search or filters\"\n                : \"Get started by adding your first asset\"}\n            </p>\n            {!searchTerm && filterCategory === \"all\" && filterCondition === \"all\" && (\n              <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-first-asset\" style={{ backgroundColor: '#00D2BD' }} className=\"hover:opacity-90\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Your First Asset\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredAssets.map((asset) => (\n            <Card key={asset.id} className=\"hover-elevate\" data-testid={`card-asset-${asset.id}`}>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"text-lg truncate\">{asset.name}</CardTitle>\n                    <div className=\"flex gap-2 mt-2 flex-wrap\">\n                      {asset.category && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          <TagIcon className=\"w-3 h-3 mr-1\" />\n                          {asset.category}\n                        </Badge>\n                      )}\n                      <Badge variant={\n                        asset.condition === \"excellent\" ? \"default\" :\n                        asset.condition === \"good\" ? \"secondary\" :\n                        asset.condition === \"fair\" ? \"outline\" :\n                        \"destructive\"\n                      } className=\"text-xs\">\n                        {conditionLabels[asset.condition]}\n                      </Badge>\n                    </div>\n                  </div>\n\n                  <div className=\"flex gap-1\">\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      onClick={() => handleOpenDialog(asset)}\n                      data-testid={`button-edit-${asset.id}`}\n                    >\n                      <Edit2 className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      onClick={() => {\n                        if (confirm(\"Are you sure you want to delete this asset?\")) {\n                          deleteMutation.mutate(asset.id);\n                        }\n                      }}\n                      data-testid={`button-delete-${asset.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n\n              <CardContent className=\"space-y-3\">\n                {asset.photos && asset.photos.length > 0 && (() => {\n                  const firstPhoto = normalizePhotoUrl(asset.photos[0]);\n                  return firstPhoto ? (\n                    <div className=\"relative h-32 rounded overflow-hidden\">\n                      <img src={firstPhoto} alt={asset.name} className=\"w-full h-full object-cover\" onError={(e) => {\n                        console.error('Failed to load image:', firstPhoto);\n                        (e.target as HTMLImageElement).style.display = 'none';\n                      }} />\n                      {asset.photos.length > 1 && (\n                        <Badge className=\"absolute top-2 right-2 text-xs\">\n                          +{asset.photos.length - 1} more\n                        </Badge>\n                      )}\n                    </div>\n                  ) : null;\n                })()}\n\n                <div className=\"space-y-2 text-sm\">\n                  {asset.location && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <MapPin className=\"w-4 h-4 shrink-0\" />\n                      <span className=\"truncate\">{asset.location}</span>\n                    </div>\n                  )}\n\n                  {asset.purchasePrice && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <DollarSign className=\"w-4 h-4 shrink-0\" />\n                      <span>Purchase: {locale.formatCurrency(parseFloat(asset.purchasePrice.toString()) * 100, false)}</span>\n                    </div>\n                  )}\n\n                  {asset.datePurchased && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Calendar className=\"w-4 h-4 shrink-0\" />\n                      <span>Purchased: {format(new Date(asset.datePurchased), 'MMM d, yyyy')}</span>\n                    </div>\n                  )}\n\n                  {asset.lastMaintenanceDate && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Wrench className=\"w-4 h-4 shrink-0\" />\n                      <span>Last Maintained: {format(new Date(asset.lastMaintenanceDate), 'MMM d, yyyy')}</span>\n                    </div>\n                  )}\n\n                  {asset.description && (\n                    <div className=\"flex items-start gap-2 text-muted-foreground\">\n                      <FileText className=\"w-4 h-4 shrink-0 mt-0.5\" />\n                      <span className=\"line-clamp-2\">{asset.description}</span>\n                    </div>\n                  )}\n\n                  {asset.cleanliness && asset.cleanliness in cleanlinessLabels && (\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Cleanliness:</span>\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        {cleanlinessLabels[asset.cleanliness as keyof typeof cleanlinessLabels]}\n                      </Badge>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":43821},"client/src/pages/InspectionTemplates.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Edit2, Trash2, FileText, Copy, Eye, Layers, Search, X, ArrowUpDown } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { insertInspectionTemplateSchema, insertTemplateCategorySchema, type InspectionTemplate, type TemplateCategory } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { TemplateBuilder } from \"../components/TemplateBuilder\";\n\n// Form schemas\nconst templateFormSchema = insertInspectionTemplateSchema.extend({\n  name: z.string().min(1, \"Template name is required\"),\n  structureJson: z.any(), // Will be validated by the builder\n});\n\nconst categoryFormSchema = insertTemplateCategorySchema.extend({\n  name: z.string().min(1, \"Category name is required\"),\n});\n\ntype TemplateFormValues = z.infer<typeof templateFormSchema>;\ntype CategoryFormValues = z.infer<typeof categoryFormSchema>;\n\nexport default function InspectionTemplates() {\n  const { toast } = useToast();\n  const [selectedTemplate, setSelectedTemplate] = useState<InspectionTemplate | null>(null);\n  const [isBuilderOpen, setIsBuilderOpen] = useState(false);\n  const [editingTemplate, setEditingTemplate] = useState<InspectionTemplate | null>(null);\n  const [isCategoryDialogOpen, setIsCategoryDialogOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState<string>(\"\");\n  const [filterCategory, setFilterCategory] = useState<string>(\"all\");\n  const [filterScope, setFilterScope] = useState<string>(\"all\");\n  const [filterActive, setFilterActive] = useState<string>(\"all\");\n  const [sortBy, setSortBy] = useState<string>(\"name-asc\");\n\n  // Fetch templates (server-side filtering)\n  const { data: rawTemplates, isLoading: templatesLoading } = useQuery<InspectionTemplate[]>({\n    queryKey: [\"/api/inspection-templates\", filterCategory, filterScope, filterActive],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (filterCategory !== \"all\") params.append(\"categoryId\", filterCategory);\n      if (filterScope !== \"all\") params.append(\"scope\", filterScope);\n      if (filterActive !== \"all\") params.append(\"active\", filterActive);\n      const query = params.toString();\n      const response = await fetch(`/api/inspection-templates${query ? `?${query}` : \"\"}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch templates\");\n      return response.json();\n    },\n  });\n\n  // Client-side filtering and sorting\n  const templates = useMemo(() => {\n    if (!rawTemplates) return [];\n    \n    // Create a copy to avoid mutating rawTemplates\n    let filtered = [...rawTemplates];\n    \n    // Apply search filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(t => \n        t.name.toLowerCase().includes(query) ||\n        (t.description?.toLowerCase().includes(query))\n      );\n    }\n    \n    // Apply sorting (create new sorted array)\n    const sorted = [...filtered].sort((a, b) => {\n      switch (sortBy) {\n        case \"name-asc\":\n          return a.name.localeCompare(b.name);\n        case \"name-desc\":\n          return b.name.localeCompare(a.name);\n        case \"newest\": {\n          // Fallback to updatedAt if createdAt is missing\n          const aTime = new Date(a.createdAt || a.updatedAt || Date.now()).getTime();\n          const bTime = new Date(b.createdAt || b.updatedAt || Date.now()).getTime();\n          return bTime - aTime;\n        }\n        case \"oldest\": {\n          // Fallback to updatedAt if createdAt is missing\n          const aTime = new Date(a.createdAt || a.updatedAt || Date.now()).getTime();\n          const bTime = new Date(b.createdAt || b.updatedAt || Date.now()).getTime();\n          return aTime - bTime;\n        }\n        case \"version\":\n          return (b.version || 1) - (a.version || 1);\n        default:\n          return 0;\n      }\n    });\n    \n    return sorted;\n  }, [rawTemplates, searchQuery, sortBy]);\n\n  // Fetch categories\n  const { data: categories } = useQuery<TemplateCategory[]>({\n    queryKey: [\"/api/template-categories\"],\n  });\n\n  // Category form\n  const categoryForm = useForm<CategoryFormValues>({\n    resolver: zodResolver(categoryFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      color: \"#5AB5E8\",\n    },\n  });\n\n  // Create category mutation\n  const createCategoryMutation = useMutation({\n    mutationFn: async (data: CategoryFormValues) => {\n      return await apiRequest(\"POST\", \"/api/template-categories\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/template-categories\"] });\n      toast({\n        title: \"Success\",\n        description: \"Category created successfully\",\n      });\n      setIsCategoryDialogOpen(false);\n      categoryForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create category\",\n      });\n    },\n  });\n\n  // Delete template mutation\n  const deleteTemplateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/inspection-templates/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-templates\"] });\n      toast({\n        title: \"Success\",\n        description: \"Template deleted successfully\",\n      });\n      if (selectedTemplate) {\n        setSelectedTemplate(null);\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to delete template\",\n      });\n    },\n  });\n\n  // Clone template mutation\n  const cloneTemplateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"POST\", `/api/inspection-templates/${id}/clone`, {\n        name: undefined, // Let backend auto-generate name\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-templates\"] });\n      toast({\n        title: \"Success\",\n        description: \"Template cloned successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to clone template\",\n      });\n    },\n  });\n\n  // Toggle active mutation\n  const toggleActiveMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      return await apiRequest(\"PUT\", `/api/inspection-templates/${id}`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspection-templates\"] });\n      toast({\n        title: \"Success\",\n        description: \"Template status updated\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update template\",\n      });\n    },\n  });\n\n  const handleCreateTemplate = () => {\n    setEditingTemplate(null);\n    setIsBuilderOpen(true);\n  };\n\n  const handleEditTemplate = (template: InspectionTemplate) => {\n    setEditingTemplate(template);\n    setIsBuilderOpen(true);\n  };\n\n  const handleCloseBuilder = () => {\n    setIsBuilderOpen(false);\n    setEditingTemplate(null);\n  };\n\n  const handleBuilderSave = () => {\n    // Cache invalidation is handled by TemplateBuilder\n    handleCloseBuilder();\n  };\n\n  const clearAllFilters = () => {\n    setSearchQuery(\"\");\n    setFilterCategory(\"all\");\n    setFilterScope(\"all\");\n    setFilterActive(\"all\");\n    setSortBy(\"name-asc\");\n  };\n\n  const hasActiveFilters = searchQuery.trim() || filterCategory !== \"all\" || filterScope !== \"all\" || filterActive !== \"all\" || sortBy !== \"name-asc\";\n\n  return (\n    <div className=\"container mx-auto p-8 space-y-8\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-4xl font-semibold tracking-tight\">Inspection Templates</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Create reusable inspection templates with flexible JSON-based structures\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <Button\n            variant=\"outline\"\n            onClick={() => setIsCategoryDialogOpen(true)}\n            data-testid=\"button-manage-categories\"\n          >\n            <Layers className=\"w-4 h-4 mr-2\" />\n            Categories\n          </Button>\n          <Button\n            onClick={handleCreateTemplate}\n            size=\"lg\"\n            data-testid=\"button-create-template\"\n          >\n            <Plus className=\"w-5 h-5 mr-2\" />\n            New Template\n          </Button>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card className=\"shadow-sm rounded-xl\">\n        <CardContent className=\"p-6\">\n          <div className=\"space-y-4\">\n            {/* Search Bar */}\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search templates by name or description...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9 pr-9\"\n                data-testid=\"input-search-templates\"\n              />\n              {searchQuery && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7\"\n                  onClick={() => setSearchQuery(\"\")}\n                  data-testid=\"button-clear-search\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              )}\n            </div>\n\n            {/* Filter Controls Row */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Category</label>\n                <Select value={filterCategory} onValueChange={setFilterCategory}>\n                  <SelectTrigger data-testid=\"select-filter-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Categories</SelectItem>\n                    {categories?.map((cat) => (\n                      <SelectItem key={cat.id} value={cat.id}>\n                        {cat.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Scope</label>\n                <Select value={filterScope} onValueChange={setFilterScope}>\n                  <SelectTrigger data-testid=\"select-filter-scope\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Scopes</SelectItem>\n                    <SelectItem value=\"property\">Property</SelectItem>\n                    <SelectItem value=\"block\">Block</SelectItem>\n                    <SelectItem value=\"both\">Both</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Status</label>\n                <Select value={filterActive} onValueChange={setFilterActive}>\n                  <SelectTrigger data-testid=\"select-filter-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Status</SelectItem>\n                    <SelectItem value=\"true\">Active Only</SelectItem>\n                    <SelectItem value=\"false\">Inactive Only</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Sort By</label>\n                <Select value={sortBy} onValueChange={setSortBy}>\n                  <SelectTrigger data-testid=\"select-sort-by\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"name-asc\">Name (A-Z)</SelectItem>\n                    <SelectItem value=\"name-desc\">Name (Z-A)</SelectItem>\n                    <SelectItem value=\"newest\">Newest First</SelectItem>\n                    <SelectItem value=\"oldest\">Oldest First</SelectItem>\n                    <SelectItem value=\"version\">Highest Version</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            {/* Results Count and Clear Filters */}\n            <div className=\"flex items-center justify-between pt-2\">\n              <div className=\"text-sm text-muted-foreground\">\n                {templatesLoading ? (\n                  \"Loading...\"\n                ) : (\n                  <span data-testid=\"text-result-count\">\n                    Showing <span className=\"font-semibold text-foreground\">{templates?.length || 0}</span> {templates?.length === 1 ? \"template\" : \"templates\"}\n                    {rawTemplates && templates && rawTemplates.length !== templates.length && (\n                      <span className=\"ml-1\">(filtered from {rawTemplates.length})</span>\n                    )}\n                  </span>\n                )}\n              </div>\n              {hasActiveFilters && (\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={clearAllFilters}\n                  data-testid=\"button-clear-filters\"\n                >\n                  <X className=\"w-4 h-4 mr-2\" />\n                  Clear Filters\n                </Button>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Templates Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {templatesLoading ? (\n          // Loading skeletons\n          Array.from({ length: 6 }).map((_, i) => (\n            <Card key={i} className=\"shadow-sm rounded-xl\">\n              <CardHeader>\n                <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                <div className=\"flex gap-2 mt-2\">\n                  <Skeleton className=\"h-5 w-16\" />\n                  <Skeleton className=\"h-5 w-16\" />\n                  <Skeleton className=\"h-5 w-12\" />\n                </div>\n                <Skeleton className=\"h-10 w-full mt-2\" />\n              </CardHeader>\n              <CardContent>\n                <Skeleton className=\"h-9 w-full\" />\n              </CardContent>\n            </Card>\n          ))\n        ) : !templates || templates.length === 0 ? (\n          <Card className=\"col-span-full shadow-sm rounded-xl\">\n            <CardContent className=\"text-center py-12\">\n              <FileText className=\"w-16 h-16 mx-auto text-muted-foreground mb-4\" />\n              {hasActiveFilters ? (\n                <>\n                  <h3 className=\"text-lg font-semibold mb-2\">No templates match your filters</h3>\n                  <p className=\"text-muted-foreground mb-6\">\n                    Try adjusting your search or filter criteria\n                  </p>\n                  <Button variant=\"outline\" onClick={clearAllFilters} data-testid=\"button-clear-filters-empty\">\n                    <X className=\"w-4 h-4 mr-2\" />\n                    Clear All Filters\n                  </Button>\n                </>\n              ) : (\n                <>\n                  <h3 className=\"text-lg font-semibold mb-2\">No templates yet</h3>\n                  <p className=\"text-muted-foreground mb-6\">\n                    Create your first inspection template to get started\n                  </p>\n                  <Button onClick={handleCreateTemplate} data-testid=\"button-create-first-template\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Create Template\n                  </Button>\n                </>\n              )}\n            </CardContent>\n          </Card>\n        ) : (\n          templates.map((template) => {\n            const category = categories?.find((c) => c.id === template.categoryId);\n            return (\n              <Card\n                key={template.id}\n                className=\"shadow-sm rounded-xl hover-elevate transition-all\"\n                data-testid={`card-template-${template.id}`}\n              >\n                <CardHeader>\n                  <div className=\"flex items-start justify-between gap-2\">\n                    <div className=\"flex-1 min-w-0\">\n                      <CardTitle className=\"text-lg truncate\" data-testid={`text-template-name-${template.id}`}>\n                        {template.name}\n                      </CardTitle>\n                      <div className=\"flex items-center gap-2 mt-2\">\n                        {category && (\n                          <Badge variant=\"outline\" style={{ borderColor: category.color || \"#5AB5E8\" }}>\n                            {category.name}\n                          </Badge>\n                        )}\n                        <Badge variant={template.scope === \"both\" ? \"default\" : \"secondary\"}>\n                          {template.scope}\n                        </Badge>\n                        <Badge variant=\"outline\">v{template.version}</Badge>\n                      </div>\n                    </div>\n                    <Switch\n                      checked={template.isActive ?? true}\n                      onCheckedChange={(checked) => {\n                        toggleActiveMutation.mutate({ id: template.id, isActive: checked });\n                      }}\n                      data-testid={`switch-active-${template.id}`}\n                    />\n                  </div>\n                  {template.description && (\n                    <CardDescription className=\"line-clamp-2 mt-2\">\n                      {template.description}\n                    </CardDescription>\n                  )}\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"flex-1\"\n                      onClick={() => handleEditTemplate(template)}\n                      data-testid={`button-edit-template-${template.id}`}\n                    >\n                      <Edit2 className=\"w-4 h-4 mr-2\" />\n                      Edit\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => cloneTemplateMutation.mutate(template.id)}\n                      data-testid={`button-clone-template-${template.id}`}\n                    >\n                      <Copy className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        if (confirm(\"Are you sure you want to delete this template?\")) {\n                          deleteTemplateMutation.mutate(template.id);\n                        }\n                      }}\n                      data-testid={`button-delete-template-${template.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })\n        )}\n      </div>\n\n      {/* Template Builder Dialog */}\n      {isBuilderOpen && (\n        <TemplateBuilder\n          template={editingTemplate}\n          categories={categories || []}\n          onClose={handleCloseBuilder}\n          onSave={handleBuilderSave}\n        />\n      )}\n\n      {/* Category Dialog */}\n      <Dialog open={isCategoryDialogOpen} onOpenChange={setIsCategoryDialogOpen}>\n        <DialogContent data-testid=\"dialog-category-form\">\n          <DialogHeader>\n            <DialogTitle>Manage Categories</DialogTitle>\n            <DialogDescription>\n              Create and organize template categories\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...categoryForm}>\n            <form onSubmit={categoryForm.handleSubmit((data) => createCategoryMutation.mutate(data))} className=\"space-y-4\">\n              <FormField\n                control={categoryForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Category Name</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"e.g., Move-In, Move-Out, Routine\"\n                        {...field}\n                        data-testid=\"input-category-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={categoryForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description (Optional)</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Describe this category...\"\n                        {...field}\n                        value={field.value || \"\"}\n                        data-testid=\"input-category-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={categoryForm.control}\n                name=\"color\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Color</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"color\"\n                        {...field}\n                        value={field.value || \"#5AB5E8\"}\n                        data-testid=\"input-category-color\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsCategoryDialogOpen(false)}\n                  data-testid=\"button-cancel-category\"\n                >\n                  Close\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createCategoryMutation.isPending}\n                  data-testid=\"button-save-category\"\n                >\n                  {createCategoryMutation.isPending ? \"Creating...\" : \"Create Category\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n\n          {/* Existing Categories List */}\n          {categories && categories.length > 0 && (\n            <div className=\"mt-6 space-y-2\">\n              <h4 className=\"font-medium text-sm\">Existing Categories</h4>\n              <div className=\"space-y-2\">\n                {categories.map((cat) => (\n                  <div\n                    key={cat.id}\n                    className=\"flex items-center gap-3 p-3 rounded-lg bg-muted\"\n                  >\n                    <div\n                      className=\"w-4 h-4 rounded-full\"\n                      style={{ backgroundColor: cat.color || \"#5AB5E8\" }}\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium text-sm\">{cat.name}</p>\n                      {cat.description && (\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {cat.description}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":25313},"client/src/pages/Contacts.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Users, Plus, Search, Mail, Phone, Building2, Briefcase, Globe, MapPin, Trash2, Edit, Tag, X } from \"lucide-react\";\nimport type { Contact, Tag as TagType } from \"@shared/schema\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { AddressInput } from \"@/components/AddressInput\";\nimport { PhoneInput } from \"@/components/PhoneInput\";\nimport { parsePhoneNumber, combinePhoneNumber, getPhoneCodeForCountry } from \"@shared/phoneCountryCodes\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\ntype ContactWithTags = Omit<Contact, 'tags'> & { tags?: TagType[] };\n\nconst contactTypeLabels: Record<string, string> = {\n  internal: \"Internal\",\n  contractor: \"Contractor\",\n  lead: \"Lead\",\n  company: \"Company\",\n  partner: \"Partner\",\n  vendor: \"Vendor\",\n  tenant: \"Tenant\",\n  other: \"Other\",\n};\n\nconst contactTypeBadgeVariants: Record<string, \"default\" | \"secondary\" | \"outline\"> = {\n  internal: \"default\",\n  contractor: \"secondary\",\n  lead: \"outline\",\n  company: \"default\",\n  partner: \"default\",\n  vendor: \"secondary\",\n  tenant: \"default\",\n  other: \"outline\",\n};\n\nexport default function Contacts() {\n  const { toast } = useToast();\n  const { countryCode: userCountryCode } = useLocale();\n  const defaultPhoneCode = getPhoneCodeForCountry(userCountryCode);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [filterTag, setFilterTag] = useState<string>(\"all\");\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingContact, setEditingContact] = useState<ContactWithTags | null>(null);\n  const [selectedTags, setSelectedTags] = useState<string[]>([]);\n  const [newTagName, setNewTagName] = useState(\"\");\n  const [phoneValue, setPhoneValue] = useState<string>(\"\");\n\n  const { data: contacts, isLoading } = useQuery<ContactWithTags[]>({\n    queryKey: [\"/api/contacts\"],\n  });\n\n  const { data: allTags } = useQuery<TagType[]>({\n    queryKey: [\"/api/tags\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest(\"POST\", \"/api/contacts\", data);\n      return await res.json();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to save contact\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      const res = await apiRequest(\"PATCH\", `/api/contacts/${id}`, data);\n      return await res.json();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update contact\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/contacts/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contacts\"] });\n      toast({\n        title: \"Success\",\n        description: \"Contact deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to delete contact\",\n      });\n    },\n  });\n\n  const addTagMutation = useMutation({\n    mutationFn: async ({ contactId, tagId }: { contactId: string; tagId: string }) => {\n      return await apiRequest(\"POST\", `/api/contacts/${contactId}/tags/${tagId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contacts\"] });\n    },\n  });\n\n  const removeTagMutation = useMutation({\n    mutationFn: async ({ contactId, tagId }: { contactId: string; tagId: string }) => {\n      return await apiRequest(\"DELETE\", `/api/contacts/${contactId}/tags/${tagId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contacts\"] });\n    },\n  });\n\n  const createTagMutation = useMutation({\n    mutationFn: async (data: { name: string; color?: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/tags\", data);\n      return await res.json() as TagType;\n    },\n    onSuccess: async (newTag: TagType) => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/tags\"] });\n      setSelectedTags(prev => [...prev, newTag.id]);\n      setNewTagName(\"\");\n      toast({\n        title: \"Success\",\n        description: \"Tag created successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create tag\",\n      });\n    },\n  });\n\n  const handleCreateTag = () => {\n    if (!newTagName.trim()) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Please enter a tag name\",\n      });\n      return;\n    }\n    \n    // Generate a random color for the new tag\n    const colors = [\"#00D5CC\", \"#3B7A8C\", \"#10b981\", \"#f59e0b\", \"#ef4444\", \"#8b5cf6\", \"#ec4899\"];\n    const randomColor = colors[Math.floor(Math.random() * colors.length)];\n    \n    createTagMutation.mutate({ name: newTagName.trim(), color: randomColor });\n  };\n\n  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    \n    // Use phoneValue from state (already combined)\n    const parsedPhone = parsePhoneNumber(phoneValue);\n    \n    const data = {\n      type: formData.get(\"type\") as string,\n      firstName: formData.get(\"firstName\") as string,\n      lastName: formData.get(\"lastName\") as string,\n      email: formData.get(\"email\") as string || undefined,\n      phone: phoneValue || undefined, // Combined phone number\n      countryCode: parsedPhone.countryCode || defaultPhoneCode, // Extract country code for schema compatibility\n      companyName: formData.get(\"companyName\") as string || undefined,\n      jobTitle: formData.get(\"jobTitle\") as string || undefined,\n      address: formData.get(\"address\") as string || undefined,\n      city: formData.get(\"city\") as string || undefined,\n      state: formData.get(\"state\") as string || undefined,\n      postalCode: formData.get(\"postalCode\") as string || undefined,\n      country: formData.get(\"country\") as string || undefined,\n      website: formData.get(\"website\") as string || undefined,\n      notes: formData.get(\"notes\") as string || undefined,\n    };\n\n    try {\n      let contactId: string;\n      \n      if (editingContact) {\n        await updateMutation.mutateAsync({ id: editingContact.id, data });\n        contactId = editingContact.id;\n        \n        // Update tags: remove old tags, add new tags\n        const oldTagIds = editingContact.tags?.map(t => t.id) || [];\n        const tagsToRemove = oldTagIds.filter(id => !selectedTags.includes(id));\n        const tagsToAdd = selectedTags.filter(id => !oldTagIds.includes(id));\n        \n        for (const tagId of tagsToRemove) {\n          await removeTagMutation.mutateAsync({ contactId, tagId });\n        }\n        for (const tagId of tagsToAdd) {\n          await addTagMutation.mutateAsync({ contactId, tagId });\n        }\n      } else {\n        const result = await createMutation.mutateAsync(data);\n        contactId = result.id;\n        \n        // Add tags to new contact\n        for (const tagId of selectedTags) {\n          await addTagMutation.mutateAsync({ contactId, tagId });\n        }\n      }\n      \n      // Invalidate and refetch contacts to ensure fresh data\n      queryClient.invalidateQueries({ queryKey: [\"/api/contacts\"] });\n      await queryClient.refetchQueries({ queryKey: [\"/api/contacts\"] });\n      \n      setDialogOpen(false);\n      setEditingContact(null);\n      setSelectedTags([]);\n      setPhoneValue(\"\");\n      \n      toast({\n        title: \"Success\",\n        description: editingContact ? \"Contact updated successfully\" : \"Contact created successfully\",\n      });\n    } catch (error) {\n      // Error handling is done in mutations\n    }\n  };\n\n  const filteredContacts = contacts?.filter((contact) => {\n    const matchesSearch =\n      searchTerm === \"\" ||\n      `${contact.firstName} ${contact.lastName}`.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      contact.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      contact.companyName?.toLowerCase().includes(searchTerm.toLowerCase());\n\n    const matchesType = filterType === \"all\" || contact.type === filterType;\n\n    const matchesTag = filterTag === \"all\" || contact.tags?.some(tag => tag.id === filterTag);\n\n    return matchesSearch && matchesType && matchesTag;\n  });\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-8\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <Users className=\"w-8 h-8 text-primary\" />\n            <div>\n              <h1 className=\"text-3xl font-semibold\">Contacts</h1>\n              <p className=\"text-muted-foreground\">Loading contacts...</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8\">\n      <div className=\"max-w-6xl mx-auto space-y-6\">\n        <div className=\"flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-3\">\n            <Users className=\"w-8 h-8 text-primary\" />\n            <div>\n              <h1 className=\"text-3xl font-semibold\">Contacts</h1>\n              <p className=\"text-muted-foreground\">\n                Manage internal team members and external contacts\n              </p>\n            </div>\n          </div>\n\n          <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n            <DialogTrigger asChild>\n              <Button\n                onClick={() => {\n                  setEditingContact(null);\n                  setPhoneValue(\"\");\n                }}\n                data-testid=\"button-add-contact\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Contact\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>\n                  {editingContact ? \"Edit Contact\" : \"Add New Contact\"}\n                </DialogTitle>\n                <DialogDescription>\n                  {editingContact\n                    ? \"Update contact information\"\n                    : \"Create a new contact entry\"}\n                </DialogDescription>\n              </DialogHeader>\n\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"type\">Contact Type *</Label>\n                    <Select\n                      name=\"type\"\n                      defaultValue={editingContact?.type || \"other\"}\n                      required\n                    >\n                      <SelectTrigger data-testid=\"select-contact-type\">\n                        <SelectValue placeholder=\"Select type\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"internal\">Internal</SelectItem>\n                        <SelectItem value=\"contractor\">Contractor</SelectItem>\n                        <SelectItem value=\"lead\">Lead</SelectItem>\n                        <SelectItem value=\"company\">Company</SelectItem>\n                        <SelectItem value=\"partner\">Partner</SelectItem>\n                        <SelectItem value=\"vendor\">Vendor</SelectItem>\n                        <SelectItem value=\"tenant\">Tenant</SelectItem>\n                        <SelectItem value=\"other\">Other</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"companyName\">Company Name</Label>\n                    <Input\n                      id=\"companyName\"\n                      name=\"companyName\"\n                      defaultValue={editingContact?.companyName || \"\"}\n                      placeholder=\"Acme Corporation\"\n                      data-testid=\"input-company-name\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"firstName\">First Name *</Label>\n                    <Input\n                      id=\"firstName\"\n                      name=\"firstName\"\n                      defaultValue={editingContact?.firstName || \"\"}\n                      required\n                      placeholder=\"John\"\n                      data-testid=\"input-first-name\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"lastName\">Last Name *</Label>\n                    <Input\n                      id=\"lastName\"\n                      name=\"lastName\"\n                      defaultValue={editingContact?.lastName || \"\"}\n                      required\n                      placeholder=\"Doe\"\n                      data-testid=\"input-last-name\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"email\">Email</Label>\n                    <Input\n                      id=\"email\"\n                      name=\"email\"\n                      type=\"email\"\n                      defaultValue={editingContact?.email || \"\"}\n                      placeholder=\"john@example.com\"\n                      data-testid=\"input-email\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"jobTitle\">Job Title</Label>\n                    <Input\n                      id=\"jobTitle\"\n                      name=\"jobTitle\"\n                      defaultValue={editingContact?.jobTitle || \"\"}\n                      placeholder=\"Property Manager\"\n                      data-testid=\"input-job-title\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <PhoneInput\n                    id=\"phone\"\n                    name=\"phone\"\n                    value={phoneValue}\n                    onChange={(value) => setPhoneValue(value)}\n                    placeholder=\"Enter phone number\"\n                    data-testid=\"input-phone\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"address\">Address</Label>\n                  <AddressInput\n                    id=\"address\"\n                    name=\"address\"\n                    defaultValue={editingContact?.address || \"\"}\n                    placeholder=\"123 Main Street\"\n                    data-testid=\"input-address\"\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div>\n                    <Label htmlFor=\"city\">City</Label>\n                    <Input\n                      id=\"city\"\n                      name=\"city\"\n                      defaultValue={editingContact?.city || \"\"}\n                      placeholder=\"New York\"\n                      data-testid=\"input-city\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"state\">State</Label>\n                    <Input\n                      id=\"state\"\n                      name=\"state\"\n                      defaultValue={editingContact?.state || \"\"}\n                      placeholder=\"NY\"\n                      data-testid=\"input-state\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"postalCode\">Postal Code</Label>\n                    <Input\n                      id=\"postalCode\"\n                      name=\"postalCode\"\n                      defaultValue={editingContact?.postalCode || \"\"}\n                      placeholder=\"10001\"\n                      data-testid=\"input-postal-code\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"country\">Country</Label>\n                    <Input\n                      id=\"country\"\n                      name=\"country\"\n                      defaultValue={editingContact?.country || \"\"}\n                      placeholder=\"United States\"\n                      data-testid=\"input-country\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"website\">Website</Label>\n                    <Input\n                      id=\"website\"\n                      name=\"website\"\n                      type=\"url\"\n                      defaultValue={editingContact?.website || \"\"}\n                      placeholder=\"https://example.com\"\n                      data-testid=\"input-website\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"notes\">Notes</Label>\n                  <Textarea\n                    id=\"notes\"\n                    name=\"notes\"\n                    defaultValue={editingContact?.notes || \"\"}\n                    placeholder=\"Additional notes or information\"\n                    data-testid=\"input-notes\"\n                    rows={3}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Tags</Label>\n                  <div className=\"flex flex-wrap gap-2 mb-2\">\n                    {selectedTags.map((tagId) => {\n                      const tag = allTags?.find(t => t.id === tagId);\n                      if (!tag) return null;\n                      return (\n                        <Badge\n                          key={tagId}\n                          variant=\"outline\"\n                          className=\"gap-1\"\n                          style={{ borderColor: tag.color || undefined }}\n                          data-testid={`badge-selected-tag-${tagId}`}\n                        >\n                          {tag.name}\n                          <X\n                            className=\"w-3 h-3 cursor-pointer hover:text-destructive\"\n                            onClick={() => setSelectedTags(prev => prev.filter(id => id !== tagId))}\n                          />\n                        </Badge>\n                      );\n                    })}\n                  </div>\n                  <Select\n                    value=\"\"\n                    onValueChange={(value) => {\n                      if (value && !selectedTags.includes(value)) {\n                        setSelectedTags(prev => [...prev, value]);\n                      }\n                    }}\n                  >\n                    <SelectTrigger data-testid=\"select-add-tag\">\n                      <SelectValue placeholder=\"Add existing tag...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {allTags?.filter(tag => !selectedTags.includes(tag.id)).map((tag) => (\n                        <SelectItem key={tag.id} value={tag.id}>\n                          {tag.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  \n                  <div className=\"flex gap-2 items-end pt-2\">\n                    <div className=\"flex-1\">\n                      <Label htmlFor=\"new-tag-name\" className=\"text-sm text-muted-foreground\">\n                        Or create new tag\n                      </Label>\n                      <Input\n                        id=\"new-tag-name\"\n                        value={newTagName}\n                        onChange={(e) => setNewTagName(e.target.value)}\n                        placeholder=\"Enter new tag name...\"\n                        onKeyDown={(e) => {\n                          if (e.key === \"Enter\") {\n                            e.preventDefault();\n                            handleCreateTag();\n                          }\n                        }}\n                        data-testid=\"input-new-tag-name\"\n                      />\n                    </div>\n                    <Button\n                      type=\"button\"\n                      onClick={handleCreateTag}\n                      disabled={createTagMutation.isPending || !newTagName.trim()}\n                      data-testid=\"button-create-tag\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Create Tag\n                    </Button>\n                  </div>\n                </div>\n\n                <DialogFooter>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      setDialogOpen(false);\n                      setEditingContact(null);\n                    }}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={createMutation.isPending || updateMutation.isPending}\n                    data-testid=\"button-submit-contact\"\n                  >\n                    {editingContact ? \"Update Contact\" : \"Create Contact\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        <div className=\"flex gap-4 items-center\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search contacts by name, email, or company...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-contacts\"\n            />\n          </div>\n\n          <Select value={filterType} onValueChange={setFilterType}>\n            <SelectTrigger className=\"w-48\" data-testid=\"select-filter-type\">\n              <SelectValue placeholder=\"Filter by type\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Types</SelectItem>\n              <SelectItem value=\"internal\">Internal</SelectItem>\n              <SelectItem value=\"contractor\">Contractor</SelectItem>\n              <SelectItem value=\"lead\">Lead</SelectItem>\n              <SelectItem value=\"company\">Company</SelectItem>\n              <SelectItem value=\"partner\">Partner</SelectItem>\n              <SelectItem value=\"vendor\">Vendor</SelectItem>\n              <SelectItem value=\"tenant\">Tenant</SelectItem>\n              <SelectItem value=\"other\">Other</SelectItem>\n            </SelectContent>\n          </Select>\n\n          <Select value={filterTag} onValueChange={setFilterTag}>\n            <SelectTrigger className=\"w-48\" data-testid=\"select-filter-tag\">\n              <SelectValue placeholder=\"Filter by tag\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Tags</SelectItem>\n              {allTags?.map((tag) => (\n                <SelectItem key={tag.id} value={tag.id}>\n                  {tag.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {!filteredContacts || filteredContacts.length === 0 ? (\n          <Card>\n            <CardContent className=\"p-12 text-center\">\n              <Users className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">\n                {searchTerm || filterType !== \"all\" ? \"No Contacts Found\" : \"No Contacts Yet\"}\n              </h3>\n              <p className=\"text-muted-foreground mb-4\">\n                {searchTerm || filterType !== \"all\"\n                  ? \"Try adjusting your search or filters\"\n                  : \"Get started by adding your first contact\"}\n              </p>\n              {!searchTerm && filterType === \"all\" && (\n                <Button onClick={() => setDialogOpen(true)} data-testid=\"button-add-first-contact\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add Your First Contact\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {filteredContacts.map((contact) => (\n              <Card key={contact.id} className=\"hover-elevate\" data-testid={`card-contact-${contact.id}`}>\n                <CardContent className=\"p-6 space-y-4\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                      <Avatar>\n                        <AvatarImage src={contact.profileImageUrl || undefined} />\n                        <AvatarFallback className=\"bg-primary/10 text-primary\">\n                          {getInitials(contact.firstName, contact.lastName)}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-semibold truncate\" data-testid={`text-name-${contact.id}`}>\n                          {contact.firstName} {contact.lastName}\n                        </h3>\n                        <Badge\n                          variant={contactTypeBadgeVariants[contact.type]}\n                          className=\"mt-1\"\n                          data-testid={`badge-type-${contact.id}`}\n                        >\n                          {contactTypeLabels[contact.type]}\n                        </Badge>\n                      </div>\n                    </div>\n\n                    <div className=\"flex gap-1\">\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        onClick={() => {\n                          setEditingContact(contact);\n                          setSelectedTags(contact.tags?.map(t => t.id) || []);\n                          // Combine country code and phone for PhoneInput\n                          const combinedPhone = combinePhoneNumber(\n                            contact.countryCode || defaultPhoneCode,\n                            contact.phone || \"\"\n                          );\n                          setPhoneValue(combinedPhone);\n                          setDialogOpen(true);\n                        }}\n                        data-testid={`button-edit-${contact.id}`}\n                      >\n                        <Edit className=\"w-4 h-4\" />\n                      </Button>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        onClick={() => {\n                          if (confirm(\"Are you sure you want to delete this contact?\")) {\n                            deleteMutation.mutate(contact.id);\n                          }\n                        }}\n                        data-testid={`button-delete-${contact.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2 text-sm\">\n                    {contact.companyName && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Building2 className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"truncate\">{contact.companyName}</span>\n                      </div>\n                    )}\n\n                    {contact.jobTitle && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Briefcase className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"truncate\">{contact.jobTitle}</span>\n                      </div>\n                    )}\n\n                    {contact.email && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Mail className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"truncate\" data-testid={`text-email-${contact.id}`}>\n                          {contact.email}\n                        </span>\n                      </div>\n                    )}\n\n                    {contact.phone && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Phone className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"truncate\" data-testid={`text-phone-${contact.id}`}>\n                          {contact.phone}\n                        </span>\n                      </div>\n                    )}\n\n                    {contact.city && contact.state && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <MapPin className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"truncate\">\n                          {contact.city}, {contact.state}\n                        </span>\n                      </div>\n                    )}\n\n                    {contact.website && (\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Globe className=\"w-4 h-4 shrink-0\" />\n                        <a\n                          href={contact.website}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"truncate hover:text-primary transition-colors\"\n                        >\n                          {contact.website}\n                        </a>\n                      </div>\n                    )}\n                  </div>\n\n                  {contact.tags && contact.tags.length > 0 && (\n                    <div className=\"flex flex-wrap gap-1.5 pt-2 border-t\">\n                      {contact.tags.map((tag) => (\n                        <Badge\n                          key={tag.id}\n                          variant=\"secondary\"\n                          className=\"text-xs\"\n                          style={{\n                            borderColor: tag.color || undefined,\n                            backgroundColor: tag.color ? `${tag.color}15` : undefined,\n                          }}\n                          data-testid={`badge-tag-${tag.id}`}\n                        >\n                          <Tag className=\"w-3 h-3 mr-1\" />\n                          {tag.name}\n                        </Badge>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":31866},"client/src/components/TagInput.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { X, Plus, Tag as TagIcon } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tag } from \"@shared/schema\";\n\ninterface TagInputProps {\n  selectedTags: Tag[];\n  onTagsChange: (tags: Tag[]) => void;\n  placeholder?: string;\n}\n\nexport function TagInput({ selectedTags, onTagsChange, placeholder = \"Add tags...\" }: TagInputProps) {\n  const [open, setOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [newTagName, setNewTagName] = useState(\"\");\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const { data: allTags = [] } = useQuery<Tag[]>({\n    queryKey: [\"/api/tags\"],\n  });\n\n  const createTagMutation = useMutation({\n    mutationFn: async (name: string) => {\n      const res = await apiRequest(\"POST\", \"/api/tags\", { name, color: getRandomColor() });\n      return res.json();\n    },\n    onSuccess: async () => {\n      // Wait for the tags query to refetch so new tag appears in dropdown\n      await queryClient.refetchQueries({ queryKey: [\"/api/tags\"] });\n    },\n  });\n\n  const handleCreateTag = async () => {\n    if (!newTagName.trim()) return;\n\n    const tag = await createTagMutation.mutateAsync(newTagName.trim()) as Tag;\n    onTagsChange([...selectedTags, tag]);\n    setNewTagName(\"\");\n    setSearchQuery(\"\");\n    setOpen(false); // Close popover after creating tag\n  };\n\n  const handleAddTag = (tag: Tag) => {\n    if (!selectedTags.find(t => t.id === tag.id)) {\n      onTagsChange([...selectedTags, tag]);\n    }\n    setSearchQuery(\"\");\n  };\n\n  const handleRemoveTag = (tagId: string) => {\n    onTagsChange(selectedTags.filter(t => t.id !== tagId));\n  };\n\n  const filteredTags = allTags.filter(tag =>\n    !selectedTags.find(t => t.id === tag.id) &&\n    tag.name.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const showCreateOption = searchQuery.trim() && !allTags.find(t =>\n    t.name.toLowerCase() === searchQuery.toLowerCase()\n  );\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex flex-wrap gap-2\">\n        {selectedTags.map(tag => (\n          <Badge\n            key={tag.id}\n            variant=\"secondary\"\n            className=\"gap-1\"\n            style={{ backgroundColor: tag.color || undefined }}\n            data-testid={`tag-badge-${tag.id}`}\n          >\n            <TagIcon className=\"h-3 w-3\" />\n            {tag.name}\n            <button\n              type=\"button\"\n              onClick={() => handleRemoveTag(tag.id)}\n              className=\"ml-1 hover:bg-black/10 rounded-full\"\n              data-testid={`button-remove-tag-${tag.id}`}\n            >\n              <X className=\"h-3 w-3\" />\n            </button>\n          </Badge>\n        ))}\n        \n        <Popover open={open} onOpenChange={setOpen}>\n          <PopoverTrigger asChild>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"h-6 px-2 rounded-full\"\n              data-testid=\"button-add-tag\"\n            >\n              <Plus className=\"h-3 w-3 mr-1\" />\n              Add Tag\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-64 p-2 z-[70]\" align=\"start\">\n            <div className=\"space-y-2\">\n              <Input\n                ref={inputRef}\n                placeholder={placeholder}\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                onKeyDown={(e) => {\n                  if (e.key === \"Enter\" && showCreateOption) {\n                    e.preventDefault();\n                    setNewTagName(searchQuery);\n                    handleCreateTag();\n                  }\n                }}\n                data-testid=\"input-tag-search\"\n              />\n              \n              <div className=\"max-h-48 overflow-y-auto space-y-1\">\n                {showCreateOption && (\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setNewTagName(searchQuery);\n                      handleCreateTag();\n                    }}\n                    className=\"w-full flex items-center gap-2 px-2 py-1.5 text-sm hover-elevate rounded-md\"\n                    data-testid=\"button-create-tag\"\n                  >\n                    <Plus className=\"h-4 w-4\" />\n                    Create \"{searchQuery}\"\n                  </button>\n                )}\n                \n                {filteredTags.map(tag => (\n                  <button\n                    key={tag.id}\n                    type=\"button\"\n                    onClick={() => handleAddTag(tag)}\n                    className=\"w-full flex items-center gap-2 px-2 py-1.5 text-sm hover-elevate rounded-md\"\n                    data-testid={`button-select-tag-${tag.id}`}\n                  >\n                    <div\n                      className=\"w-3 h-3 rounded-full\"\n                      style={{ backgroundColor: tag.color || '#6B7280' }}\n                    />\n                    {tag.name}\n                  </button>\n                ))}\n                \n                {!showCreateOption && filteredTags.length === 0 && (\n                  <div className=\"text-sm text-muted-foreground text-center py-2\">\n                    No tags found\n                  </div>\n                )}\n              </div>\n            </div>\n          </PopoverContent>\n        </Popover>\n      </div>\n    </div>\n  );\n}\n\nfunction getRandomColor(): string {\n  const colors = [\n    \"#5AB5E8\", // Sky blue (primary)\n    \"#3B82F6\", // Blue\n    \"#8B5CF6\", // Purple\n    \"#EC4899\", // Pink\n    \"#10B981\", // Green\n    \"#F59E0B\", // Amber\n    \"#EF4444\", // Red\n    \"#6366F1\", // Indigo\n  ];\n  return colors[Math.floor(Math.random() * colors.length)];\n}\n","size_bytes":6089},"client/src/components/TagSearch.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Search, Building, Home, Users, FileText, Package, Wrench, Tag as TagIcon, X } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\nimport type { Tag } from \"@shared/schema\";\n\ninterface TagSearchProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\ninterface SearchResults {\n  blocks: any[];\n  properties: any[];\n  users: any[];\n  complianceDocuments: any[];\n  assetInventory: any[];\n  maintenanceRequests: any[];\n}\n\nexport function TagSearch({ open, onOpenChange }: TagSearchProps) {\n  const [, setLocation] = useLocation();\n  const [selectedTags, setSelectedTags] = useState<Tag[]>([]);\n  const [searchResults, setSearchResults] = useState<SearchResults | null>(null);\n\n  const { data: allTags = [] } = useQuery<Tag[]>({\n    queryKey: [\"/api/tags\"],\n  });\n\n  const searchMutation = useMutation({\n    mutationFn: async (tagIds: string[]) => {\n      const res = await apiRequest(\"POST\", \"/api/tags/search\", { tagIds });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setSearchResults(data);\n    },\n  });\n\n  const handleTagSelect = (tag: Tag) => {\n    if (selectedTags.find(t => t.id === tag.id)) {\n      const newTags = selectedTags.filter(t => t.id !== tag.id);\n      setSelectedTags(newTags);\n      if (newTags.length > 0) {\n        searchMutation.mutate(newTags.map(t => t.id));\n      } else {\n        setSearchResults(null);\n      }\n    } else {\n      const newTags = [...selectedTags, tag];\n      setSelectedTags(newTags);\n      searchMutation.mutate(newTags.map(t => t.id));\n    }\n  };\n\n  const handleClear = () => {\n    setSelectedTags([]);\n    setSearchResults(null);\n  };\n\n  const handleNavigate = (path: string) => {\n    setLocation(path);\n    onOpenChange(false);\n    handleClear();\n  };\n\n  const getTotalResults = () => {\n    if (!searchResults) return 0;\n    return (\n      searchResults.blocks.length +\n      searchResults.properties.length +\n      searchResults.users.length +\n      searchResults.complianceDocuments.length +\n      searchResults.assetInventory.length +\n      searchResults.maintenanceRequests.length\n    );\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-3xl max-h-[80vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Search className=\"h-5 w-5\" />\n            Search by Tags\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* Tag Selection */}\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <label className=\"text-sm font-medium\">Select Tags:</label>\n              {selectedTags.length > 0 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleClear}\n                  data-testid=\"button-clear-tags\"\n                >\n                  Clear\n                </Button>\n              )}\n            </div>\n            <div className=\"flex flex-wrap gap-2 p-4 border rounded-lg min-h-[60px]\">\n              {allTags.map(tag => (\n                <Badge\n                  key={tag.id}\n                  variant={selectedTags.find(t => t.id === tag.id) ? \"default\" : \"outline\"}\n                  className=\"cursor-pointer gap-1\"\n                  style={{\n                    backgroundColor: selectedTags.find(t => t.id === tag.id) ? tag.color || undefined : undefined,\n                    borderColor: tag.color || undefined,\n                  }}\n                  onClick={() => handleTagSelect(tag)}\n                  data-testid={`tag-filter-${tag.id}`}\n                >\n                  <TagIcon className=\"h-3 w-3\" />\n                  {tag.name}\n                </Badge>\n              ))}\n              {allTags.length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">No tags available. Create tags in the Properties, Blocks, or other sections.</p>\n              )}\n            </div>\n          </div>\n\n          {/* Search Results */}\n          {searchMutation.isPending && (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Searching...\n            </div>\n          )}\n\n          {searchResults && (\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"font-medium\">\n                  Results ({getTotalResults()})\n                </h3>\n              </div>\n\n              <ScrollArea className=\"h-[400px] border rounded-lg p-4\">\n                <div className=\"space-y-6\">\n                  {/* Blocks */}\n                  {searchResults.blocks.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <Building className=\"h-4 w-4\" />\n                        Blocks ({searchResults.blocks.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.blocks.map(block => (\n                          <button\n                            key={block.id}\n                            onClick={() => handleNavigate(`/blocks`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-block-${block.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{block.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">{block.address}</p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Properties */}\n                  {searchResults.properties.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <Home className=\"h-4 w-4\" />\n                        Properties ({searchResults.properties.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.properties.map(property => (\n                          <button\n                            key={property.id}\n                            onClick={() => handleNavigate(`/properties`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-property-${property.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{property.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">{property.address}</p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Users/Tenants */}\n                  {searchResults.users.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <Users className=\"h-4 w-4\" />\n                        Team Members ({searchResults.users.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.users.map(user => (\n                          <button\n                            key={user.id}\n                            onClick={() => handleNavigate(`/team`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-user-${user.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{user.firstName} {user.lastName}</p>\n                              <p className=\"text-sm text-muted-foreground\">{user.email}  {user.role}</p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Compliance Documents */}\n                  {searchResults.complianceDocuments.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <FileText className=\"h-4 w-4\" />\n                        Compliance Documents ({searchResults.complianceDocuments.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.complianceDocuments.map(doc => (\n                          <button\n                            key={doc.id}\n                            onClick={() => handleNavigate(`/compliance`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-compliance-${doc.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{doc.documentType}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {doc.issueDate && new Date(doc.issueDate).toLocaleDateString()}\n                              </p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Asset Inventory */}\n                  {searchResults.assetInventory.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <Package className=\"h-4 w-4\" />\n                        Asset Inventory ({searchResults.assetInventory.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.assetInventory.map(asset => (\n                          <button\n                            key={asset.id}\n                            onClick={() => handleNavigate(`/inventory`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-asset-${asset.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{asset.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">{asset.category}</p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Maintenance Requests */}\n                  {searchResults.maintenanceRequests.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                        <Wrench className=\"h-4 w-4\" />\n                        Maintenance Requests ({searchResults.maintenanceRequests.length})\n                      </div>\n                      <div className=\"space-y-1\">\n                        {searchResults.maintenanceRequests.map(request => (\n                          <button\n                            key={request.id}\n                            onClick={() => handleNavigate(`/maintenance`)}\n                            className=\"w-full flex items-center justify-between p-2 hover-elevate rounded-md text-left\"\n                            data-testid={`result-maintenance-${request.id}`}\n                          >\n                            <div>\n                              <p className=\"font-medium\">{request.title}</p>\n                              <p className=\"text-sm text-muted-foreground\">{request.status}</p>\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {getTotalResults() === 0 && (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      No results found for the selected tags\n                    </div>\n                  )}\n                </div>\n              </ScrollArea>\n            </div>\n          )}\n\n          {!searchResults && !searchMutation.isPending && selectedTags.length === 0 && (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Select one or more tags to search\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":13479},"client/src/components/TemplateBuilder.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Trash2, GripVertical, Save, X, Eye, Code, ChevronDown, ChevronRight } from \"lucide-react\";\nimport { type InspectionTemplate, type TemplateCategory } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\n\n// UI-specific schema - only includes fields user can edit\n// Backend will populate organizationId, createdBy, createdAt, updatedAt\nconst templateMetaSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  description: z.string().optional(),\n  scope: z.enum([\"property\", \"block\", \"both\"]),\n  categoryId: z.number().optional(),\n  isActive: z.boolean().default(true),\n  version: z.number().default(1),\n  structureJson: z.any(),\n});\n\ntype TemplateMetaForm = z.infer<typeof templateMetaSchema>;\n\ninterface TemplateField {\n  id: string; // Primary identifier for the field\n  key: string; // Legacy property kept for compatibility\n  label: string;\n  type: string;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[];\n  validation?: any;\n  depends_on?: string;\n  includeCondition?: boolean;\n  includeCleanliness?: boolean;\n}\n\ninterface TemplateSection {\n  id: string;\n  title: string;\n  description?: string;\n  repeatable?: boolean;\n  fields: TemplateField[];\n}\n\ninterface TemplateStructure {\n  sections: TemplateSection[];\n}\n\nconst FIELD_TYPES = [\n  { value: \"short_text\", label: \"Short Text\" },\n  { value: \"long_text\", label: \"Long Text\" },\n  { value: \"number\", label: \"Number\" },\n  { value: \"rating\", label: \"Rating (1-5)\" },\n  { value: \"select\", label: \"Dropdown\" },\n  { value: \"multiselect\", label: \"Multiple Select\" },\n  { value: \"boolean\", label: \"Yes/No\" },\n  { value: \"date\", label: \"Date\" },\n  { value: \"time\", label: \"Time\" },\n  { value: \"datetime\", label: \"Date & Time\" },\n  { value: \"photo\", label: \"Single Photo\" },\n  { value: \"photo_array\", label: \"Multiple Photos\" },\n  { value: \"video\", label: \"Video\" },\n  { value: \"gps\", label: \"GPS Location\" },\n  { value: \"signature\", label: \"Signature\" },\n];\n\ninterface TemplateBuilderProps {\n  template: InspectionTemplate | null;\n  categories: TemplateCategory[];\n  onClose: () => void;\n  onSave: () => void;\n}\n\nexport function TemplateBuilder({ template, categories, onClose, onSave }: TemplateBuilderProps) {\n  const { toast } = useToast();\n  const [previewMode, setPreviewMode] = useState(false);\n  \n  // Parse existing structure or create default\n  const rawStructure: TemplateStructure = template?.structureJson \n    ? (typeof template.structureJson === 'string' ? JSON.parse(template.structureJson) : template.structureJson as TemplateStructure)\n    : { sections: [] };\n  \n  // Migrate old templates: ensure all fields have both id and key\n  const initialStructure: TemplateStructure = {\n    sections: rawStructure.sections.map(section => ({\n      ...section,\n      fields: section.fields.map(field => ({\n        ...field,\n        id: field.id || field.key, // Use existing id or fall back to key\n        key: field.key || field.id, // Ensure key exists too\n      })),\n    })),\n  };\n\n  const [structure, setStructure] = useState<TemplateStructure>(initialStructure);\n  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set());\n\n  const form = useForm<TemplateMetaForm>({\n    resolver: zodResolver(templateMetaSchema),\n    defaultValues: {\n      name: template?.name || \"\",\n      description: template?.description || \"\",\n      scope: template?.scope || \"property\",\n      categoryId: template?.categoryId !== null && template?.categoryId !== undefined ? template.categoryId : undefined,\n      isActive: template?.isActive ?? true,\n      version: template?.version || 1,\n      structureJson: initialStructure,\n    },\n  });\n\n  // Save mutation\n  const saveMutation = useMutation({\n    mutationFn: async (data: TemplateMetaForm) => {\n      const payload = {\n        ...data,\n        structureJson: structure,\n      };\n      if (template) {\n        return await apiRequest(\"PUT\", `/api/inspection-templates/${template.id}`, payload);\n      } else {\n        return await apiRequest(\"POST\", \"/api/inspection-templates\", payload);\n      }\n    },\n    onSuccess: async () => {\n      // Refetch queries and wait for fresh data before closing dialog\n      await queryClient.refetchQueries({ queryKey: [\"/api/inspection-templates\"] });\n      if (template) {\n        await queryClient.refetchQueries({ queryKey: [\"/api/inspection-templates\", template.id] });\n      }\n      toast({\n        title: \"Success\",\n        description: template ? \"Template updated successfully\" : \"Template created successfully\",\n      });\n      onSave();\n      onClose(); // Close the modal after successful save\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to save template\",\n      });\n    },\n  });\n\n  const handleSave = () => {\n    form.handleSubmit((data) => {\n      saveMutation.mutate(data);\n    })();\n  };\n\n  const addSection = () => {\n    const newSection: TemplateSection = {\n      id: `section_${Date.now()}`,\n      title: \"New Section\",\n      fields: [],\n    };\n    setStructure({ sections: [...structure.sections, newSection] });\n    setExpandedSections(new Set([...Array.from(expandedSections), newSection.id]));\n  };\n\n  const updateSection = (sectionId: string, updates: Partial<TemplateSection>) => {\n    setStructure({\n      sections: structure.sections.map((s) =>\n        s.id === sectionId ? { ...s, ...updates } : s\n      ),\n    });\n  };\n\n  const deleteSection = (sectionId: string) => {\n    setStructure({\n      sections: structure.sections.filter((s) => s.id !== sectionId),\n    });\n    const newExpanded = new Set(expandedSections);\n    newExpanded.delete(sectionId);\n    setExpandedSections(newExpanded);\n  };\n\n  const addField = (sectionId: string) => {\n    const section = structure.sections.find((s) => s.id === sectionId);\n    if (!section) return;\n\n    const fieldId = `field_${Date.now()}`;\n    const newField: TemplateField = {\n      id: fieldId,\n      key: fieldId, // Keep key same as id for compatibility\n      label: \"New Field\",\n      type: \"short_text\",\n      required: false,\n    };\n\n    updateSection(sectionId, {\n      fields: [...section.fields, newField],\n    });\n  };\n\n  const updateField = (sectionId: string, fieldKey: string, updates: Partial<TemplateField>) => {\n    const section = structure.sections.find((s) => s.id === sectionId);\n    if (!section) return;\n\n    updateSection(sectionId, {\n      fields: section.fields.map((f) =>\n        f.key === fieldKey ? { ...f, ...updates } : f\n      ),\n    });\n  };\n\n  const deleteField = (sectionId: string, fieldKey: string) => {\n    const section = structure.sections.find((s) => s.id === sectionId);\n    if (!section) return;\n\n    updateSection(sectionId, {\n      fields: section.fields.filter((f) => f.key !== fieldKey),\n    });\n  };\n\n  const toggleSection = (sectionId: string) => {\n    const newExpanded = new Set(expandedSections);\n    if (newExpanded.has(sectionId)) {\n      newExpanded.delete(sectionId);\n    } else {\n      newExpanded.add(sectionId);\n    }\n    setExpandedSections(newExpanded);\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-6xl h-[90vh] p-0 gap-0 flex flex-col\">\n        <DialogHeader className=\"p-6 pb-4 border-b\">\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle className=\"text-2xl\">\n              {template ? \"Edit Template\" : \"Create Template\"}\n            </DialogTitle>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setPreviewMode(!previewMode)}\n                data-testid=\"button-toggle-preview\"\n              >\n                {previewMode ? <Code className=\"w-4 h-4 mr-2\" /> : <Eye className=\"w-4 h-4 mr-2\" />}\n                {previewMode ? \"Edit\" : \"Preview\"}\n              </Button>\n              <Button\n                onClick={handleSave}\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-template\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                {saveMutation.isPending ? \"Saving...\" : \"Save Template\"}\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={onClose} data-testid=\"button-close-builder\">\n                <X className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </div>\n        </DialogHeader>\n\n        <div className=\"flex-1 overflow-auto p-6\">\n          {previewMode ? (\n            <div className=\"space-y-6\">\n              <Card className=\"shadow-sm\">\n                <CardHeader>\n                  <CardTitle>Preview Mode</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <pre className=\"text-xs bg-muted p-4 rounded-lg overflow-auto\">\n                    {JSON.stringify({ ...form.getValues(), structureJson: structure }, null, 2)}\n                  </pre>\n                </CardContent>\n              </Card>\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n              {/* Template Metadata */}\n              <div className=\"lg:col-span-1 space-y-6\">\n                <Card className=\"shadow-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Template Settings</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <Form {...form}>\n                      <FormField\n                        control={form.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Move-In Inspection\" data-testid=\"input-template-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"description\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Description</FormLabel>\n                            <FormControl>\n                              <Textarea\n                                {...field}\n                                value={field.value || \"\"}\n                                placeholder=\"Template description...\"\n                                data-testid=\"input-template-description\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"scope\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Scope</FormLabel>\n                            <Select value={field.value} onValueChange={field.onChange}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-template-scope\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"property\">Property</SelectItem>\n                                <SelectItem value=\"block\">Block</SelectItem>\n                                <SelectItem value=\"both\">Both</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"categoryId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Category</FormLabel>\n                            <Select \n                              value={field.value?.toString() || \"none\"} \n                              onValueChange={(v) => field.onChange(v === \"none\" ? undefined : parseInt(v))}\n                            >\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-template-category\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"none\">No Category</SelectItem>\n                                {categories.map((cat) => (\n                                  <SelectItem key={cat.id} value={cat.id.toString()}>\n                                    {cat.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"isActive\"\n                        render={({ field }) => (\n                          <FormItem className=\"flex items-center justify-between gap-2 space-y-0\">\n                            <FormLabel>Active Template</FormLabel>\n                            <FormControl>\n                              <Switch\n                                checked={field.value ?? true}\n                                onCheckedChange={field.onChange}\n                                data-testid=\"switch-template-active\"\n                              />\n                            </FormControl>\n                          </FormItem>\n                        )}\n                      />\n                    </Form>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Structure Editor */}\n              <div className=\"lg:col-span-2 space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"text-lg font-semibold\">Template Structure</h3>\n                  <Button onClick={addSection} size=\"sm\" data-testid=\"button-add-section\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Section\n                  </Button>\n                </div>\n\n                {structure.sections.length === 0 ? (\n                  <Card className=\"shadow-sm\">\n                    <CardContent className=\"text-center py-12\">\n                      <p className=\"text-muted-foreground mb-4\">No sections yet</p>\n                      <Button onClick={addSection} data-testid=\"button-add-first-section\">\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Add First Section\n                      </Button>\n                    </CardContent>\n                  </Card>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {structure.sections.map((section, sectionIndex) => (\n                      <Card key={section.id} className=\"shadow-sm\">\n                        <Collapsible\n                          open={expandedSections.has(section.id)}\n                          onOpenChange={() => toggleSection(section.id)}\n                        >\n                          <CardHeader className=\"pb-3\">\n                            <div className=\"flex items-center gap-3\">\n                              <CollapsibleTrigger asChild>\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                                  {expandedSections.has(section.id) ? (\n                                    <ChevronDown className=\"w-4 h-4\" />\n                                  ) : (\n                                    <ChevronRight className=\"w-4 h-4\" />\n                                  )}\n                                </Button>\n                              </CollapsibleTrigger>\n                              <GripVertical className=\"w-4 h-4 text-muted-foreground\" />\n                              <Input\n                                value={section.title}\n                                onChange={(e) => updateSection(section.id, { title: e.target.value })}\n                                className=\"font-semibold flex-1\"\n                                placeholder=\"Section Title\"\n                                data-testid={`input-section-title-${sectionIndex}`}\n                              />\n                              <Switch\n                                checked={section.repeatable || false}\n                                onCheckedChange={(checked) => updateSection(section.id, { repeatable: checked })}\n                                data-testid={`switch-section-repeatable-${sectionIndex}`}\n                              />\n                              <span className=\"text-xs text-muted-foreground\">Repeatable</span>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={() => deleteSection(section.id)}\n                                data-testid={`button-delete-section-${sectionIndex}`}\n                              >\n                                <Trash2 className=\"w-4 h-4 text-destructive\" />\n                              </Button>\n                            </div>\n                          </CardHeader>\n                          <CollapsibleContent>\n                            <CardContent className=\"space-y-3\">\n                              <Textarea\n                                value={section.description || \"\"}\n                                onChange={(e) => updateSection(section.id, { description: e.target.value })}\n                                placeholder=\"Section description (optional)\"\n                                rows={2}\n                                data-testid={`input-section-description-${sectionIndex}`}\n                              />\n\n                              {/* Fields */}\n                              <div className=\"space-y-2\">\n                                {section.fields.map((field, fieldIndex) => (\n                                  <div key={field.key} className=\"space-y-2\">\n                                    <div className=\"space-y-2\">\n                                      <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n                                        <GripVertical className=\"w-4 h-4 text-muted-foreground\" />\n                                        <Input\n                                          value={field.label}\n                                          onChange={(e) => updateField(section.id, field.key, { label: e.target.value })}\n                                          placeholder=\"Field Label\"\n                                          className=\"flex-1\"\n                                          data-testid={`input-field-label-${sectionIndex}-${fieldIndex}`}\n                                        />\n                                        <Select\n                                          value={field.type}\n                                          onValueChange={(type) => updateField(section.id, field.key, { type })}\n                                        >\n                                          <SelectTrigger className=\"w-40\" data-testid={`select-field-type-${sectionIndex}-${fieldIndex}`}>\n                                            <SelectValue />\n                                          </SelectTrigger>\n                                          <SelectContent>\n                                            {FIELD_TYPES.map((ft) => (\n                                              <SelectItem key={ft.value} value={ft.value}>\n                                                {ft.label}\n                                              </SelectItem>\n                                            ))}\n                                          </SelectContent>\n                                        </Select>\n                                        <Switch\n                                          checked={field.required || false}\n                                          onCheckedChange={(checked) =>\n                                            updateField(section.id, field.key, { required: checked })\n                                          }\n                                          data-testid={`switch-field-required-${sectionIndex}-${fieldIndex}`}\n                                        />\n                                        <span className=\"text-xs text-muted-foreground w-16\">Required</span>\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"icon\"\n                                          onClick={() => deleteField(section.id, field.key)}\n                                          data-testid={`button-delete-field-${sectionIndex}-${fieldIndex}`}\n                                        >\n                                          <Trash2 className=\"w-4 h-4 text-destructive\" />\n                                        </Button>\n                                      </div>\n                                      \n                                      {/* Additional Options Row */}\n                                      <div className=\"flex items-center gap-4 ml-8 px-3\">\n                                        <div className=\"flex items-center gap-2\">\n                                          <Switch\n                                            checked={field.includeCondition || false}\n                                            onCheckedChange={(checked) =>\n                                              updateField(section.id, field.key, { includeCondition: checked })\n                                            }\n                                            data-testid={`switch-field-condition-${sectionIndex}-${fieldIndex}`}\n                                          />\n                                          <span className=\"text-xs text-muted-foreground\">Include Condition</span>\n                                        </div>\n                                        <div className=\"flex items-center gap-2\">\n                                          <Switch\n                                            checked={field.includeCleanliness || false}\n                                            onCheckedChange={(checked) =>\n                                              updateField(section.id, field.key, { includeCleanliness: checked })\n                                            }\n                                            data-testid={`switch-field-cleanliness-${sectionIndex}-${fieldIndex}`}\n                                          />\n                                          <span className=\"text-xs text-muted-foreground\">Include Cleanliness</span>\n                                        </div>\n                                      </div>\n                                    </div>\n                                    \n                                    {/* Options editor for select/multiselect fields */}\n                                    {(field.type === \"select\" || field.type === \"multiselect\") && (\n                                      <div className=\"ml-8 p-3 bg-background border rounded-lg space-y-2\">\n                                        <div className=\"flex items-center justify-between\">\n                                          <label className=\"text-sm font-medium\">Dropdown Options</label>\n                                          <Button\n                                            variant=\"outline\"\n                                            size=\"sm\"\n                                            onClick={() => {\n                                              const options = field.options || [];\n                                              updateField(section.id, field.key, { options: [...options, \"\"] });\n                                            }}\n                                            data-testid={`button-add-option-${sectionIndex}-${fieldIndex}`}\n                                          >\n                                            <Plus className=\"w-3 h-3 mr-1\" />\n                                            Add Option\n                                          </Button>\n                                        </div>\n                                        \n                                        {(!field.options || field.options.length === 0) ? (\n                                          <p className=\"text-xs text-muted-foreground\">No options yet. Click \"Add Option\" to create dropdown choices.</p>\n                                        ) : (\n                                          <div className=\"space-y-2\">\n                                            {field.options.map((option, optionIndex) => (\n                                              <div key={optionIndex} className=\"flex items-center gap-2\">\n                                                <Input\n                                                  value={option}\n                                                  onChange={(e) => {\n                                                    const newOptions = [...(field.options || [])];\n                                                    newOptions[optionIndex] = e.target.value;\n                                                    updateField(section.id, field.key, { options: newOptions });\n                                                  }}\n                                                  placeholder={`Option ${optionIndex + 1}`}\n                                                  className=\"flex-1\"\n                                                  data-testid={`input-option-${sectionIndex}-${fieldIndex}-${optionIndex}`}\n                                                />\n                                                <Button\n                                                  variant=\"ghost\"\n                                                  size=\"icon\"\n                                                  onClick={() => {\n                                                    const newOptions = (field.options || []).filter((_, i) => i !== optionIndex);\n                                                    updateField(section.id, field.key, { options: newOptions });\n                                                  }}\n                                                  data-testid={`button-delete-option-${sectionIndex}-${fieldIndex}-${optionIndex}`}\n                                                >\n                                                  <X className=\"w-4 h-4 text-destructive\" />\n                                                </Button>\n                                              </div>\n                                            ))}\n                                          </div>\n                                        )}\n                                      </div>\n                                    )}\n                                  </div>\n                                ))}\n                              </div>\n\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => addField(section.id)}\n                                className=\"w-full\"\n                                data-testid={`button-add-field-${sectionIndex}`}\n                              >\n                                <Plus className=\"w-4 h-4 mr-2\" />\n                                Add Field\n                              </Button>\n                            </CardContent>\n                          </CollapsibleContent>\n                        </Collapsible>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":29568},"server/devRoutes.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"./storage\";\nimport { hashPassword } from \"./auth\";\nimport bcrypt from \"bcryptjs\";\n\nconst router = Router();\n\n// Dev-only endpoint to create test users\n// Only works in development environment\nrouter.post(\"/create-test-user\", async (req, res) => {\n  // Strict environment guard\n  if (process.env.NODE_ENV === \"production\") {\n    return res.status(403).json({ message: \"Not available in production\" });\n  }\n\n  try {\n    const testEmail = \"test@inspect360.com\";\n    const testUsername = \"testowner\";\n    const testPassword = \"password123\";\n    const hashedPassword = await hashPassword(testPassword);\n\n    // Check if test user already exists\n    const existingUser = await storage.getUserByEmail(testEmail);\n    \n    if (existingUser) {\n      return res.json({\n        message: \"Test user already exists\",\n        email: testEmail,\n        username: testUsername,\n        password: testPassword,\n        role: existingUser.role,\n      });\n    }\n\n    // Create new test user with organization\n    // First create a temporary owner user to satisfy ownerId requirement\n    const tempOwner = await storage.createUser({\n      username: `temp_${Date.now()}`,\n      email: `temp_${Date.now()}@example.com`,\n      password: hashedPassword,\n      role: \"owner\",\n      firstName: \"Temp\",\n      lastName: \"Owner\",\n    });\n\n    const organization = await storage.createOrganization({\n      name: \"Test Organization\",\n      ownerId: tempOwner.id,\n      creditsRemaining: 100,\n    });\n\n    const user = await storage.createUser({\n      username: testUsername,\n      email: testEmail,\n      password: hashedPassword,\n      role: \"owner\",\n      firstName: \"Test\",\n      lastName: \"Owner\",\n      organizationId: organization.id,\n    });\n\n    return res.json({\n      message: \"Test user created successfully\",\n      email: testEmail,\n      username: testUsername,\n      password: testPassword,\n      role: user.role,\n      organizationId: organization.id,\n    });\n  } catch (error: any) {\n    console.error(\"Error creating test user:\", error);\n    return res.status(500).json({ \n      message: \"Failed to create test user\",\n      error: error.message \n    });\n  }\n});\n\n// Create test tenant user (development only)\nrouter.post(\"/create-test-tenant\", async (req, res) => {\n  if (process.env.NODE_ENV === \"production\") {\n    return res.status(403).json({ message: \"Not available in production\" });\n  }\n\n  try {\n    const tenantEmail = req.body.email || `tenant${Date.now()}@test.com`;\n    const tenantPassword = req.body.password || \"password123\";\n    const hashedPassword = await hashPassword(tenantPassword);\n\n    // Check if user already exists\n    const existing = await storage.getUserByEmail(tenantEmail);\n    if (existing) {\n      return res.json({\n        message: \"Tenant user already exists\",\n        email: tenantEmail,\n        password: tenantPassword,\n        userId: existing.id,\n      });\n    }\n\n    // Get or create test organization\n    let org = await storage.getOrganization(\"test-org-id\");\n    if (!org) {\n      const tempOwner = await storage.createUser({\n        username: `owner_${Date.now()}`,\n        email: `owner_${Date.now()}@example.com`,\n        password: hashedPassword,\n        role: \"owner\",\n        firstName: \"Test\",\n        lastName: \"Owner\",\n      });\n\n      org = await storage.createOrganization({\n        name: \"Test BTR Organization\",\n        ownerId: tempOwner.id,\n        creditsRemaining: 100,\n      });\n    }\n\n    // Create tenant user\n    const tenant = await storage.createUser({\n      username: tenantEmail.split('@')[0],\n      email: tenantEmail,\n      password: hashedPassword,\n      role: \"tenant\",\n      firstName: \"Test\",\n      lastName: \"Tenant\",\n      organizationId: org.id,\n    });\n\n    // Create test property if none exists\n    let property;\n    const existingProperties = await storage.getPropertiesByOrganization(org.id);\n    if (existingProperties.length > 0) {\n      property = existingProperties[0];\n    } else {\n      property = await storage.createProperty({\n        name: \"Test Property Unit 101\",\n        address: \"123 Test Street, Test City\",\n        sqft: 850,\n        organizationId: org.id,\n      });\n    }\n\n    // Create tenant assignment\n    const tenancy = await storage.createTenantAssignment({\n      organizationId: org.id,\n      propertyId: property.id,\n      tenantId: tenant.id,\n      leaseStartDate: new Date(),\n      leaseEndDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year from now\n      monthlyRent: \"1500.00\",\n      depositAmount: \"1500.00\",\n      isActive: true,\n    });\n\n    return res.json({\n      message: \"Test tenant created successfully\",\n      email: tenantEmail,\n      password: tenantPassword,\n      userId: tenant.id,\n      propertyId: property.id,\n      tenancyId: tenancy.id,\n    });\n  } catch (error: any) {\n    console.error(\"Error creating test tenant:\", error);\n    return res.status(500).json({ \n      message: \"Failed to create test tenant\",\n      error: error.message \n    });\n  }\n});\n\n// Seed admin user (development only)\nrouter.post(\"/seed-admin\", async (req, res) => {\n  if (process.env.NODE_ENV === \"production\") {\n    return res.status(403).json({ message: \"Not available in production\" });\n  }\n\n  try {\n    const hashedPassword = await bcrypt.hash(\"admin123\", 10);\n\n    // Check if admin already exists\n    const existing = await storage.getAdminByEmail(\"admin@inspect360.com\");\n    if (existing) {\n      return res.json({\n        message: \"Admin user already exists\",\n        email: \"admin@inspect360.com\",\n        password: \"admin123\",\n      });\n    }\n\n    const admin = await storage.createAdmin({\n      email: \"admin@inspect360.com\",\n      password: hashedPassword,\n      firstName: \"Super\",\n      lastName: \"Admin\",\n    });\n\n    const { password, ...sanitizedAdmin } = admin;\n    res.json({ \n      message: \"Admin user created successfully\", \n      admin: sanitizedAdmin,\n      email: \"admin@inspect360.com\",\n      password: \"admin123\",\n    });\n  } catch (error: any) {\n    if (error.message?.includes(\"duplicate\") || error.code === \"23505\") {\n      return res.status(400).json({ message: \"Admin user already exists\" });\n    }\n    console.error(\"Error seeding admin:\", error);\n    res.status(500).json({ message: \"Failed to seed admin user\" });\n  }\n});\n\nexport { router as devRouter };\n","size_bytes":6357},"client/src/pages/InspectionReview.tsx":{"content":"import { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { CheckCircle2, AlertCircle, ChevronLeft, FileText } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport type { Inspection } from \"@shared/schema\";\n\ninterface TemplateSection {\n  id: string;\n  title: string;\n  description?: string;\n  fields: TemplateField[];\n}\n\ninterface TemplateField {\n  id: string;\n  label: string;\n  type: string;\n  required?: boolean;\n}\n\nexport default function InspectionReview() {\n  const { id } = useParams<{ id: string }>();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n\n  // Fetch inspection with template snapshot\n  const { data: inspection, isLoading: inspectionLoading } = useQuery<Inspection>({\n    queryKey: [\"/api/inspections\", id],\n  });\n\n  // Fetch all entries for this inspection\n  const { data: entries = [], isLoading: entriesLoading } = useQuery<any[]>({\n    queryKey: [`/api/inspections/${id}/entries`],\n    enabled: !!id,\n  });\n\n  // Parse template structure from snapshot\n  const templateStructure = inspection?.templateSnapshotJson as { sections: TemplateSection[] } | null;\n  const sections = templateStructure?.sections || [];\n\n  // Calculate completion stats\n  const totalFields = sections.reduce((acc, section) => acc + section.fields.length, 0);\n  const completedFields = entries.length;\n  const progress = totalFields > 0 ? (completedFields / totalFields) * 100 : 0;\n\n  // Complete inspection mutation\n  const completeInspection = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(`/api/inspections/${id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          status: \"completed\",\n          completedDate: new Date().toISOString(),\n          submittedAt: new Date().toISOString(),\n        }),\n      });\n      if (!response.ok) throw new Error(await response.text());\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Inspection completed\",\n        description: \"All entries have been saved successfully.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      navigate(\"/inspections\");\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error completing inspection\",\n        description: error.message,\n      });\n    },\n  });\n\n  // Get entry value for a specific field\n  const getEntryValue = (sectionId: string, fieldKey: string) => {\n    return entries.find(e => e.sectionRef === sectionId && e.fieldKey === fieldKey);\n  };\n\n  // Render field value based on type\n  const renderFieldValue = (entry: any, field: TemplateField) => {\n    if (!entry || entry.valueJson === null || entry.valueJson === undefined) {\n      return <span className=\"text-muted-foreground italic\">Not filled</span>;\n    }\n\n    const value = entry.valueJson;\n\n    switch (field.type) {\n      case \"boolean\":\n        return <Badge variant={value ? \"default\" : \"secondary\"}>{value ? \"Yes\" : \"No\"}</Badge>;\n      \n      case \"rating\":\n        return (\n          <div className=\"flex items-center gap-1\">\n            {Array.from({ length: 5 }, (_, i) => (\n              <span key={i} className={i < value ? \"text-primary\" : \"text-muted-foreground\"}>\n                \n              </span>\n            ))}\n            <span className=\"ml-2 text-sm\">({value}/5)</span>\n          </div>\n        );\n      \n      case \"multiselect\":\n        return (\n          <div className=\"flex flex-wrap gap-1\">\n            {(value || []).map((v: string) => (\n              <Badge key={v} variant=\"secondary\">{v}</Badge>\n            ))}\n          </div>\n        );\n      \n      case \"select\":\n        return <Badge variant=\"outline\">{value}</Badge>;\n      \n      case \"photo\":\n      case \"photo_array\":\n      case \"video\":\n      case \"signature\":\n        return <Badge variant=\"secondary\">Media uploaded</Badge>;\n      \n      default:\n        return <span>{String(value)}</span>;\n    }\n  };\n\n  if (inspectionLoading || entriesLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 space-y-6\">\n        <Skeleton className=\"h-12 w-full\" />\n        <Skeleton className=\"h-[500px] w-full\" />\n      </div>\n    );\n  }\n\n  if (!inspection) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"p-8 text-center\">\n            <AlertCircle className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n            <h2 className=\"text-2xl font-semibold mb-2\">Inspection not found</h2>\n            <Button onClick={() => navigate(\"/inspections\")} data-testid=\"button-back-to-inspections\">\n              Back to Inspections\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <div className=\"flex items-center gap-3 mb-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => navigate(\"/inspections\")}\n              data-testid=\"button-back\"\n            >\n              <ChevronLeft className=\"w-5 h-5\" />\n            </Button>\n            <h1 className=\"text-3xl font-semibold\" data-testid=\"text-page-title\">\n              Inspection Review\n            </h1>\n          </div>\n          <p className=\"text-muted-foreground ml-14\">\n            {inspection.propertyId ? \"Property\" : \"Block\"} Inspection\n          </p>\n        </div>\n        <div className=\"flex items-center gap-4\">\n          <Badge\n            variant={progress === 100 ? \"default\" : \"secondary\"}\n            data-testid=\"badge-completion\"\n          >\n            {Math.round(progress)}% Complete\n          </Badge>\n          <Button\n            variant=\"outline\"\n            onClick={() => navigate(`/inspections/${id}/report`)}\n            data-testid=\"button-view-report\"\n          >\n            <FileText className=\"w-4 h-4 mr-2\" />\n            View Report\n          </Button>\n          {inspection.status !== \"completed\" && (\n            <>\n              <Button\n                variant=\"outline\"\n                onClick={() => navigate(`/inspections/${id}/capture`)}\n                data-testid=\"button-continue-capture\"\n              >\n                Continue Editing\n              </Button>\n              <Button\n                onClick={() => completeInspection.mutate()}\n                disabled={completeInspection.isPending || progress < 100}\n                data-testid=\"button-mark-complete\"\n              >\n                <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n                Mark as Complete\n              </Button>\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Progress Summary */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-sm font-medium\">Completion Progress</span>\n              <span className=\"text-2xl font-bold\">{completedFields} / {totalFields}</span>\n            </div>\n            <Progress value={progress} data-testid=\"progress-completion\" />\n            <div className=\"flex justify-between text-sm text-muted-foreground\">\n              <span>{completedFields} fields completed</span>\n              <span>{totalFields - completedFields} remaining</span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Sections and Entries */}\n      <div className=\"space-y-6\">\n        {sections.map((section) => {\n          const sectionEntries = entries.filter(e => e.sectionRef === section.id);\n          const sectionProgress = section.fields.length > 0\n            ? (sectionEntries.length / section.fields.length) * 100\n            : 0;\n\n          return (\n            <Card key={section.id} data-testid={`section-${section.id}`}>\n              <CardHeader>\n                <div className=\"flex justify-between items-start\">\n                  <div>\n                    <CardTitle className=\"text-xl\" data-testid={`text-section-title-${section.id}`}>\n                      {section.title}\n                    </CardTitle>\n                    {section.description && (\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        {section.description}\n                      </p>\n                    )}\n                  </div>\n                  <Badge variant={sectionProgress === 100 ? \"default\" : \"secondary\"}>\n                    {Math.round(sectionProgress)}%\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {section.fields.map((field) => {\n                    const entry = getEntryValue(section.id, field.id);\n                    const hasValue = entry && (entry.valueJson !== null && entry.valueJson !== undefined);\n\n                    return (\n                      <div\n                        key={field.id}\n                        className=\"flex items-start justify-between gap-4 py-3 border-b last:border-0\"\n                        data-testid={`field-${field.id}`}\n                      >\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-medium\">{field.label}</span>\n                            {field.required && <span className=\"text-destructive text-xs\">*</span>}\n                            {hasValue && <CheckCircle2 className=\"w-4 h-4 text-primary\" />}\n                          </div>\n                          <div className=\"mt-2\">\n                            {renderFieldValue(entry, field)}\n                          </div>\n                          {entry?.note && (\n                            <div className=\"mt-2 text-sm text-muted-foreground\">\n                              <span className=\"font-medium\">Note:</span> {entry.note}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n\n      {/* Empty state if no template */}\n      {sections.length === 0 && (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <AlertCircle className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n            <h2 className=\"text-xl font-semibold mb-2\">No template structure</h2>\n            <p className=\"text-muted-foreground\">\n              This inspection doesn't have a template structure to review.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":11285},"client/src/pages/InspectionCapture.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ChevronLeft, ChevronRight, Save, CheckCircle2, AlertCircle, Wifi, WifiOff, Cloud } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Inspection } from \"@shared/schema\";\nimport { FieldWidget } from \"@/components/FieldWidget\";\nimport { offlineQueue, useOnlineStatus } from \"@/lib/offlineQueue\";\nimport { InspectionQuickActions } from \"@/components/InspectionQuickActions\";\nimport { QuickAddAssetSheet } from \"@/components/QuickAddAssetSheet\";\nimport { QuickUpdateAssetSheet } from \"@/components/QuickUpdateAssetSheet\";\nimport { QuickAddMaintenanceSheet } from \"@/components/QuickAddMaintenanceSheet\";\n\ninterface TemplateSection {\n  id: string;\n  title: string;\n  description?: string;\n  repeatable?: boolean;\n  fields: TemplateField[];\n}\n\ninterface TemplateField {\n  id: string;\n  key?: string; // For compatibility with legacy templates\n  label: string;\n  type: string;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[];\n  validation?: Record<string, any>;\n  dependsOn?: Record<string, any>;\n  includeCondition?: boolean;\n  includeCleanliness?: boolean;\n}\n\ninterface InspectionEntry {\n  id?: string;\n  sectionRef: string;\n  fieldKey: string;\n  fieldType: string;\n  valueJson?: any;\n  note?: string;\n  photos?: string[];\n  maintenanceFlag?: boolean;\n  markedForReview?: boolean;\n}\n\nexport default function InspectionCapture() {\n  const { id } = useParams<{ id: string }>();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [currentSectionIndex, setCurrentSectionIndex] = useState(0);\n  const [entries, setEntries] = useState<Record<string, InspectionEntry>>({});\n  const isOnline = useOnlineStatus();\n  const [pendingCount, setPendingCount] = useState(0);\n  const [isSyncing, setIsSyncing] = useState(false);\n  const [showAssetSheet, setShowAssetSheet] = useState(false);\n  const [showUpdateAssetSheet, setShowUpdateAssetSheet] = useState(false);\n  const [showMaintenanceSheet, setShowMaintenanceSheet] = useState(false);\n\n  // Fetch inspection with template snapshot\n  const { data: inspection, isLoading } = useQuery<Inspection>({\n    queryKey: [\"/api/inspections\", id],\n  });\n\n  // Fetch property details if inspection has a propertyId\n  const { data: property } = useQuery<any>({\n    queryKey: [`/api/properties/${inspection?.propertyId}`],\n    enabled: !!inspection?.propertyId,\n  });\n\n  // Fetch existing entries for this inspection\n  const { data: existingEntries = [] } = useQuery<any[]>({\n    queryKey: [`/api/inspections/${id}/entries`],\n    enabled: !!id,\n  });\n\n  // Load existing entries into state on mount and auto-populate property address\n  useEffect(() => {\n    if (existingEntries.length > 0) {\n      const entriesMap: Record<string, InspectionEntry> = {};\n      existingEntries.forEach((entry: any) => {\n        const key = `${entry.sectionRef}-${entry.fieldKey}`;\n        entriesMap[key] = entry;\n      });\n      setEntries(entriesMap);\n    }\n  }, [existingEntries]);\n\n  // Update pending count periodically\n  useEffect(() => {\n    const updateCount = () => {\n      setPendingCount(offlineQueue.getPendingCount());\n    };\n    updateCount();\n    const interval = setInterval(updateCount, 2000);\n    return () => clearInterval(interval);\n  }, []);\n\n  // Auto-sync when coming online\n  useEffect(() => {\n    if (isOnline && pendingCount > 0 && !isSyncing) {\n      handleSync();\n    }\n  }, [isOnline]);\n\n  const handleSync = async () => {\n    if (isSyncing || pendingCount === 0) return;\n    \n    setIsSyncing(true);\n    try {\n      const result = await offlineQueue.syncAll(apiRequest);\n      if (result.success > 0) {\n        toast({\n          title: \"Sync Complete\",\n          description: `${result.success} ${result.success === 1 ? 'entry' : 'entries'} synced successfully`,\n        });\n        queryClient.invalidateQueries({ queryKey: [`/api/inspections/${id}/entries`] });\n      }\n      if (result.failed > 0) {\n        toast({\n          variant: \"destructive\",\n          title: \"Sync Issues\",\n          description: `${result.failed} ${result.failed === 1 ? 'entry' : 'entries'} failed to sync`,\n        });\n      }\n      setPendingCount(offlineQueue.getPendingCount());\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Sync Failed\",\n        description: \"Unable to sync offline entries\",\n      });\n    } finally {\n      setIsSyncing(false);\n    }\n  };\n\n  // Parse template structure from snapshot and migrate old templates\n  const rawTemplateStructure = inspection?.templateSnapshotJson as { sections: TemplateSection[] } | null;\n  \n  // Migrate old templates: ensure all fields have both id and key\n  const templateStructure = rawTemplateStructure ? {\n    sections: rawTemplateStructure.sections.map(section => ({\n      ...section,\n      fields: section.fields.map((field: any) => ({\n        ...field,\n        id: field.id || field.key, // Use existing id or fall back to key\n        key: field.key || field.id, // Ensure key exists too\n      })),\n    })),\n  } : null;\n  \n  const sections = templateStructure?.sections || [];\n  const currentSection = sections[currentSectionIndex];\n\n  // Auto-start inspection on first visit\n  useEffect(() => {\n    if (inspection && inspection.status === \"scheduled\" && !inspection.startedAt) {\n      // Update status to in_progress\n      fetch(`/api/inspections/${id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          status: \"in_progress\",\n          startedAt: new Date().toISOString(),\n        }),\n      }).then(() => {\n        queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      });\n    }\n  }, [inspection, id]);\n\n  // Calculate progress - count entries with values OR photos\n  const totalFields = sections.reduce((acc, section) => acc + section.fields.length, 0);\n  const completedFields = Object.values(entries).filter(entry => {\n    // Count as complete if has valueJson OR photos\n    const hasValue = entry.valueJson !== null && entry.valueJson !== undefined;\n    const hasPhotos = entry.photos && entry.photos.length > 0;\n    return hasValue || hasPhotos;\n  }).length;\n  const progress = totalFields > 0 ? (completedFields / totalFields) * 100 : 0;\n\n  // Update entry mutation\n  const updateEntry = useMutation({\n    mutationFn: async (entry: InspectionEntry) => {\n      const response = await fetch(`/api/inspection-entries`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          inspectionId: id,\n          ...entry,\n        }),\n      });\n      if (!response.ok) throw new Error(await response.text());\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/inspections/${id}/entries`] });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error saving field\",\n        description: error.message,\n      });\n    },\n  });\n\n  // Auto-populate property address when property is loaded and template is available\n  useEffect(() => {\n    if (!property?.address || !templateStructure || !sections.length || !id) return;\n    \n    // Check if entry already exists in existingEntries (from server)\n    const hasExistingEntry = existingEntries.some((entry: any) => {\n      const labelLower = entry.fieldKey?.toLowerCase() || \"\";\n      return labelLower.includes(\"property_address\") || labelLower.includes(\"property_address\");\n    });\n    \n    if (hasExistingEntry) return; // Don't overwrite existing entries\n    \n    // Find the property address field in the General Information section\n    const generalInfoSection = sections.find(section => \n      section.title.toLowerCase().includes(\"general\") || \n      section.id?.toLowerCase().includes(\"general\")\n    );\n    \n    if (!generalInfoSection) return;\n    \n    // Find property address field by label or common field IDs\n    const addressField = generalInfoSection.fields.find(field => {\n      const labelLower = field.label?.toLowerCase() || \"\";\n      const fieldIdLower = field.id?.toLowerCase() || \"\";\n      const fieldKeyLower = field.key?.toLowerCase() || \"\";\n      \n      return (\n        labelLower.includes(\"property address\") ||\n        (labelLower.includes(\"address\") && labelLower.includes(\"property\")) ||\n        fieldIdLower.includes(\"property_address\") ||\n        fieldKeyLower.includes(\"property_address\")\n      );\n    });\n    \n    if (!addressField) return;\n    \n    const entryKey = `${generalInfoSection.id}-${addressField.id}`;\n    const existingEntry = entries[entryKey];\n    \n    // Only auto-populate if the field is empty\n    if (!existingEntry || !existingEntry.valueJson) {\n      // Create entry directly (similar to handleFieldChange but without currentSection dependency)\n      const entry: InspectionEntry = {\n        sectionRef: generalInfoSection.id,\n        fieldKey: addressField.id,\n        fieldType: addressField.type as any,\n        valueJson: property.address,\n      };\n\n      // Update local state optimistically\n      setEntries(prev => ({\n        ...prev,\n        [entryKey]: entry,\n      }));\n\n      // Save to backend if online\n      if (isOnline) {\n        updateEntry.mutate(entry);\n      } else {\n        // If offline, queue the entry\n        offlineQueue.enqueue({\n          inspectionId: id,\n          sectionRef: generalInfoSection.id,\n          fieldKey: addressField.id,\n          fieldType: addressField.type,\n          valueJson: property.address,\n        });\n        setPendingCount(offlineQueue.getPendingCount());\n      }\n    }\n  }, [property, templateStructure, sections, entries, existingEntries, id, isOnline, updateEntry]);\n\n  // Handle field value change\n  const handleFieldChange = (fieldKey: string, value: any, note?: string | undefined, photos?: string[] | undefined) => {\n    const field = currentSection.fields.find(f => f.id === fieldKey);\n    if (!field) return;\n\n    const entryKey = `${currentSection.id}-${fieldKey}`;\n    \n    // Only save if there's a value or note/photos\n    // But for progress calculation, only count as complete if value exists\n    if (value === null || value === undefined) {\n      // If only notes/photos without value, still save but don't count as complete\n      if (!note && (!photos || photos.length === 0)) {\n        return; // Nothing to save\n      }\n    }\n\n    // If offline, queue the entry\n    if (!isOnline) {\n      offlineQueue.enqueue({\n        inspectionId: id!,\n        sectionRef: currentSection.id,\n        fieldKey,\n        fieldType: field.type,\n        valueJson: value,\n        note,\n        photos,\n      });\n      \n      // Update local state optimistically\n      setEntries(prev => ({\n        ...prev,\n        [entryKey]: {\n          sectionRef: currentSection.id,\n          fieldKey,\n          fieldType: field.type,\n          valueJson: value,\n          note,\n          photos,\n        }\n      }));\n      \n      setPendingCount(offlineQueue.getPendingCount());\n      \n      toast({\n        title: \"Saved Offline\",\n        description: \"Entry will sync when connection is restored\",\n      });\n      return;\n    }\n\n    const existingEntry = entries[entryKey];\n    const entry: InspectionEntry = {\n      sectionRef: currentSection.id,\n      fieldKey,\n      fieldType: field.type,\n      valueJson: value,\n      note,\n      photos,\n      markedForReview: existingEntry?.markedForReview || false,\n    };\n\n    // Update local state optimistically\n    setEntries(prev => ({\n      ...prev,\n      [entryKey]: entry,\n    }));\n\n    // Save to backend\n    updateEntry.mutate(entry);\n  };\n\n  // Handle mark for review change\n  const handleMarkedForReviewChange = async (fieldKey: string, marked: boolean) => {\n    const entryKey = `${currentSection.id}-${fieldKey}`;\n    const entry = entries[entryKey];\n    \n    // Update local state optimistically\n    setEntries(prev => ({\n      ...prev,\n      [entryKey]: {\n        ...prev[entryKey],\n        markedForReview: marked,\n      }\n    }));\n\n    if (!entry?.id) {\n      // Entry doesn't exist yet - will be saved with markedForReview when created\n      return;\n    }\n\n    // Update on server\n    try {\n      const response = await fetch(`/api/inspection-entries/${entry.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ markedForReview: marked }),\n      });\n      if (!response.ok) throw new Error(await response.text());\n      queryClient.invalidateQueries({ queryKey: [`/api/inspections/${id}/entries`] });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to update mark for review\",\n      });\n      // Revert optimistic update\n      setEntries(prev => ({\n        ...prev,\n        [entryKey]: {\n          ...prev[entryKey],\n          markedForReview: !marked,\n        }\n      }));\n    }\n  };\n\n  // Navigate sections\n  const goToNextSection = () => {\n    if (currentSectionIndex < sections.length - 1) {\n      setCurrentSectionIndex(currentSectionIndex + 1);\n    }\n  };\n\n  const goToPreviousSection = () => {\n    if (currentSectionIndex > 0) {\n      setCurrentSectionIndex(currentSectionIndex - 1);\n    }\n  };\n\n  // Complete inspection\n  const completeInspection = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(`/api/inspections/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          status: \"completed\",\n          completedDate: new Date().toISOString(),\n        }),\n      });\n      if (!response.ok) throw new Error(await response.text());\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Inspection completed\",\n        description: \"All entries have been saved successfully.\",\n      });\n      navigate(\"/inspections\");\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error completing inspection\",\n        description: error.message,\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 space-y-6\">\n        <Skeleton className=\"h-12 w-full\" />\n        <Skeleton className=\"h-[500px] w-full\" />\n      </div>\n    );\n  }\n\n  if (!inspection) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"p-8 text-center\">\n            <AlertCircle className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n            <h2 className=\"text-2xl font-semibold mb-2\">Inspection not found</h2>\n            <p className=\"text-muted-foreground mb-6\">\n              The inspection you're looking for doesn't exist or has been removed.\n            </p>\n            <Button onClick={() => navigate(\"/inspections\")} data-testid=\"button-back-to-inspections\">\n              Back to Inspections\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!templateStructure || sections.length === 0) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"p-8 text-center\">\n            <AlertCircle className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n            <h2 className=\"text-2xl font-semibold mb-2\">No template available</h2>\n            <p className=\"text-muted-foreground mb-6\">\n              This inspection doesn't have a template structure to fill out.\n            </p>\n            <Button onClick={() => navigate(\"/inspections\")} data-testid=\"button-back-to-inspections\">\n              Back to Inspections\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold mb-2\" data-testid=\"text-inspection-title\">\n            Inspection Capture\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {inspection.propertyId ? \"Property\" : \"Block\"} Inspection\n          </p>\n        </div>\n        <div className=\"flex items-center gap-4\">\n          {/* Online/Offline status */}\n          <Badge \n            variant={isOnline ? \"default\" : \"secondary\"}\n            data-testid=\"badge-online-status\"\n            className=\"gap-2\"\n          >\n            {isOnline ? <Wifi className=\"w-3 h-3\" /> : <WifiOff className=\"w-3 h-3\" />}\n            {isOnline ? \"Online\" : \"Offline\"}\n          </Badge>\n          \n          {/* Pending sync count */}\n          {pendingCount > 0 && (\n            <Badge variant=\"outline\" data-testid=\"badge-pending-sync\">\n              <Cloud className=\"w-3 h-3 mr-1\" />\n              {pendingCount} pending\n            </Badge>\n          )}\n          \n          {/* Manual sync button */}\n          {isOnline && pendingCount > 0 && (\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={handleSync}\n              disabled={isSyncing}\n              data-testid=\"button-sync\"\n            >\n              {isSyncing ? \"Syncing...\" : \"Sync Now\"}\n            </Button>\n          )}\n          \n          <Badge variant=\"secondary\" data-testid=\"badge-progress\">\n            {completedFields} / {totalFields} fields\n          </Badge>\n          <Button\n            onClick={() => completeInspection.mutate()}\n            disabled={completeInspection.isPending}\n            data-testid=\"button-complete-inspection\"\n          >\n            <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n            Complete Inspection\n          </Button>\n        </div>\n      </div>\n\n      {/* Progress bar */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"space-y-2\">\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Progress</span>\n              <span className=\"font-medium\">{Math.round(progress)}%</span>\n            </div>\n            <Progress value={progress} data-testid=\"progress-inspection\" />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Section navigation */}\n      <div className=\"flex items-center gap-2 overflow-x-auto pb-2\">\n        {sections.map((section, index) => (\n          <Button\n            key={section.id}\n            variant={index === currentSectionIndex ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setCurrentSectionIndex(index)}\n            data-testid={`button-section-${index}`}\n          >\n            {section.title}\n          </Button>\n        ))}\n      </div>\n\n      {/* Current section */}\n      {currentSection && (\n        <Card>\n          <CardHeader>\n            <CardTitle data-testid=\"text-section-title\">{currentSection.title}</CardTitle>\n            {currentSection.description && (\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-section-description\">\n                {currentSection.description}\n              </p>\n            )}\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {currentSection.fields.map((field) => {\n              const entryKey = `${currentSection.id}-${field.id}`;\n              const entry = entries[entryKey];\n\n              return (\n                <FieldWidget\n                  key={field.id}\n                  field={field}\n                  value={entry?.valueJson}\n                  note={entry?.note}\n                  photos={entry?.photos}\n                  inspectionId={id}\n                  entryId={entry?.id}\n                  isCheckOut={inspection?.type === \"check_out\"}\n                  markedForReview={entry?.markedForReview || false}\n                  onChange={(value: any, note?: string, photos?: string[]) => handleFieldChange(field.id, value, note, photos)}\n                  onMarkedForReviewChange={(marked: boolean) => handleMarkedForReviewChange(field.id, marked)}\n                />\n              );\n            })}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Navigation buttons */}\n      <div className=\"flex justify-between\">\n        <Button\n          variant=\"outline\"\n          onClick={goToPreviousSection}\n          disabled={currentSectionIndex === 0}\n          data-testid=\"button-previous-section\"\n        >\n          <ChevronLeft className=\"w-4 h-4 mr-2\" />\n          Previous\n        </Button>\n        <Button\n          onClick={goToNextSection}\n          disabled={currentSectionIndex === sections.length - 1}\n          data-testid=\"button-next-section\"\n        >\n          Next\n          <ChevronRight className=\"w-4 h-4 ml-2\" />\n        </Button>\n      </div>\n\n      {/* Quick Actions FAB */}\n      <InspectionQuickActions\n        onAddAsset={() => setShowAssetSheet(true)}\n        onUpdateAsset={() => setShowUpdateAssetSheet(true)}\n        onLogMaintenance={() => setShowMaintenanceSheet(true)}\n      />\n\n      {/* Quick Add Asset Sheet */}\n      <QuickAddAssetSheet\n        open={showAssetSheet}\n        onOpenChange={setShowAssetSheet}\n        propertyId={inspection?.propertyId || undefined}\n        blockId={inspection?.blockId || undefined}\n        inspectionId={id}\n      />\n\n      {/* Quick Update Asset Sheet */}\n      <QuickUpdateAssetSheet\n        open={showUpdateAssetSheet}\n        onOpenChange={setShowUpdateAssetSheet}\n        propertyId={inspection?.propertyId || undefined}\n        blockId={inspection?.blockId || undefined}\n        inspectionId={id}\n      />\n\n      {/* Quick Add Maintenance Sheet */}\n      <QuickAddMaintenanceSheet\n        open={showMaintenanceSheet}\n        onOpenChange={setShowMaintenanceSheet}\n        propertyId={inspection?.propertyId || undefined}\n        blockId={inspection?.blockId || undefined}\n        inspectionId={id}\n      />\n    </div>\n  );\n}\n","size_bytes":22356},"client/src/components/FieldWidget.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Star, Upload, Calendar, Clock, MapPin, X, Image as ImageIcon, Sparkles, Trash2, Save, Eye } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport Uppy from \"@uppy/core\";\nimport { Dashboard } from \"@uppy/react\";\nimport AwsS3 from \"@uppy/aws-s3\";\nimport Webcam from \"@uppy/webcam\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { extractFileUrlFromUploadResponse } from \"@/lib/utils\";\nimport SignatureCanvas from \"react-signature-canvas\";\n\ninterface TemplateField {\n  id: string;\n  label: string;\n  type: string;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[];\n  validation?: Record<string, any>;\n  dependsOn?: Record<string, any>;\n  includeCondition?: boolean;\n  includeCleanliness?: boolean;\n}\n\ninterface FieldWidgetProps {\n  field: TemplateField;\n  value?: any;\n  note?: string;\n  photos?: string[];\n  inspectionId?: string;\n  entryId?: string;\n  isCheckOut?: boolean; // Only show mark-for-review in Check Out inspections\n  markedForReview?: boolean;\n  onChange: (value: any, note?: string, photos?: string[]) => void;\n  onMarkedForReviewChange?: (marked: boolean) => void;\n}\n\nexport function FieldWidget({ \n  field, \n  value, \n  note, \n  photos, \n  inspectionId, \n  entryId, \n  isCheckOut,\n  markedForReview,\n  onChange,\n  onMarkedForReviewChange \n}: FieldWidgetProps) {\n  // Parse value - if field includes condition/cleanliness, value might be an object\n  const parseValue = (val: any) => {\n    if (val && typeof val === 'object' && (field.includeCondition || field.includeCleanliness)) {\n      return {\n        value: val.value,\n        condition: val.condition,\n        cleanliness: val.cleanliness,\n      };\n    }\n    return { value: val, condition: undefined, cleanliness: undefined };\n  };\n\n  const parsed = parseValue(value);\n  const [localValue, setLocalValue] = useState(parsed.value);\n  const [localCondition, setLocalCondition] = useState(parsed.condition);\n  const [localCleanliness, setLocalCleanliness] = useState(parsed.cleanliness);\n  const [localNote, setLocalNote] = useState(note || \"\");\n  const [localPhotos, setLocalPhotos] = useState<string[]>(photos || []);\n  const [localMarkedForReview, setLocalMarkedForReview] = useState(markedForReview || false);\n  const [showPhotoUpload, setShowPhotoUpload] = useState(false);\n  const signaturePadRef = useRef<SignatureCanvas>(null);\n  const [aiAnalyses, setAiAnalyses] = useState<Record<string, any>>({});\n  const [analyzingPhoto, setAnalyzingPhoto] = useState<string | null>(null);\n  const [analyzingField, setAnalyzingField] = useState(false);\n  const { toast } = useToast();\n  const { user } = useAuth();\n\n  // Fetch Check-In reference for photo fields during Check-Out inspections\n  const { data: checkInReference } = useQuery({\n    queryKey: inspectionId ? [\"/api/inspections\", inspectionId, \"check-in-reference\"] : [\"no-check-in\"],\n    queryFn: async () => {\n      if (!inspectionId || !isCheckOut || (field.type !== \"photo\" && field.type !== \"photo_array\")) {\n        return null;\n      }\n      const response = await apiRequest(\"GET\", `/api/inspections/${inspectionId}/check-in-reference`);\n      return response.json();\n    },\n    enabled: !!inspectionId && isCheckOut && (field.type === \"photo\" || field.type === \"photo_array\"),\n  });\n\n  // Find matching check-in entry for this field\n  const checkInEntry = checkInReference?.checkInEntries?.find(\n    (entry: any) => entry.fieldRef === field.id\n  );\n  const checkInPhotos = checkInEntry?.photos || [];\n\n  // Rehydrate local state when props change (e.g., when existing entries load)\n  useEffect(() => {\n    const parsed = parseValue(value);\n    setLocalValue(parsed.value);\n    setLocalCondition(parsed.condition);\n    setLocalCleanliness(parsed.cleanliness);\n  }, [value]);\n\n  useEffect(() => {\n    setLocalNote(note || \"\");\n  }, [note]);\n\n  useEffect(() => {\n    setLocalPhotos(photos || []);\n  }, [photos]);\n\n  useEffect(() => {\n    setLocalMarkedForReview(markedForReview || false);\n  }, [markedForReview]);\n\n  // Auto-clear markedForReview when all photos are deleted\n  useEffect(() => {\n    if (isCheckOut && localPhotos.length === 0 && localMarkedForReview) {\n      setLocalMarkedForReview(false);\n      onMarkedForReviewChange?.(false);\n    }\n  }, [localPhotos, localMarkedForReview, isCheckOut, onMarkedForReviewChange]);\n\n  const composeValue = (val: any, condition?: string, cleanliness?: string) => {\n    if (field.includeCondition || field.includeCleanliness) {\n      return {\n        value: val,\n        ...(field.includeCondition && { condition }),\n        ...(field.includeCleanliness && { cleanliness }),\n      };\n    }\n    return val;\n  };\n\n  const handleValueChange = (newValue: any) => {\n    setLocalValue(newValue);\n    const composedValue = composeValue(newValue, localCondition, localCleanliness);\n    onChange(composedValue, localNote || undefined, localPhotos.length > 0 ? localPhotos : undefined);\n  };\n\n  const handleConditionChange = (condition: string) => {\n    setLocalCondition(condition);\n    const composedValue = composeValue(localValue, condition, localCleanliness);\n    onChange(composedValue, localNote || undefined, localPhotos.length > 0 ? localPhotos : undefined);\n  };\n\n  const handleCleanlinessChange = (cleanliness: string) => {\n    setLocalCleanliness(cleanliness);\n    const composedValue = composeValue(localValue, localCondition, cleanliness);\n    onChange(composedValue, localNote || undefined, localPhotos.length > 0 ? localPhotos : undefined);\n  };\n\n  const handleNoteChange = (newNote: string) => {\n    setLocalNote(newNote);\n    const composedValue = composeValue(localValue, localCondition, localCleanliness);\n    onChange(composedValue, newNote || undefined, localPhotos.length > 0 ? localPhotos : undefined);\n  };\n\n  const handlePhotoAdd = (photoUrl: string) => {\n    const newPhotos = field.type === \"photo\" ? [photoUrl] : [...localPhotos, photoUrl];\n    setLocalPhotos(newPhotos);\n    const composedValue = composeValue(localValue, localCondition, localCleanliness);\n    onChange(composedValue, localNote || undefined, newPhotos);\n    toast({\n      title: \"Success\",\n      description: \"Photo uploaded successfully\",\n    });\n  };\n\n  const handlePhotoRemove = (photoUrl: string) => {\n    const newPhotos = localPhotos.filter((p) => p !== photoUrl);\n    setLocalPhotos(newPhotos);\n    const composedValue = composeValue(localValue, localCondition, localCleanliness);\n    onChange(composedValue, localNote || undefined, newPhotos.length > 0 ? newPhotos : undefined);\n  };\n\n  const handleInspectField = async () => {\n    if (!inspectionId || localPhotos.length === 0) {\n      toast({\n        title: \"Cannot Analyze\",\n        description: \"Please upload at least one photo to use InspectAI\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setAnalyzingField(true);\n\n    try {\n      const response = await apiRequest(\"POST\", \"/api/ai/inspect-field\", {\n        inspectionId,\n        fieldKey: field.id,\n        fieldLabel: field.label,\n        fieldDescription: field.placeholder,\n        photos: localPhotos,\n      });\n\n      const { analysis, tokenExceeded } = await response.json();\n\n      // Check if token limit was exceeded\n      if (tokenExceeded) {\n        toast({\n          title: \"Token Limit Exceeded\",\n          description: \"Token limit exceeded. Please try again later.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Auto-populate the notes field with the AI analysis\n      const newNote = analysis;\n      setLocalNote(newNote);\n      const composedValue = composeValue(localValue, localCondition, localCleanliness);\n      onChange(composedValue, newNote, localPhotos);\n\n      // Invalidate organization query to update credit balance on dashboard and billing pages\n      if (user?.organizationId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n      }\n\n      toast({\n        title: \"InspectAI Complete\",\n        description: \"AI analysis has been added to the notes field\",\n      });\n    } catch (error: any) {\n      console.error(\"Error analyzing field:\", error);\n      toast({\n        title: \"Analysis Failed\",\n        description: error.message || \"Failed to analyze inspection point\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setAnalyzingField(false);\n    }\n  };\n\n  const createPhotoUppy = () => {\n    const maxFiles = field.type === \"photo\" ? 1 : 10;\n    const uppy = new Uppy({\n      restrictions: {\n        maxNumberOfFiles: maxFiles,\n        allowedFileTypes: [\"image/*\"],\n        maxFileSize: 10485760, // 10MB\n      },\n      autoProceed: false,\n    })\n      .use(Webcam, {\n        modes: ['picture'],\n        facingMode: 'environment',\n      } as any)\n      .use(AwsS3, {\n        shouldUseMultipart: false,\n        async getUploadParameters(file: any) {\n          try {\n            const response = await fetch(\"/api/objects/upload\", {\n              method: \"POST\",\n              credentials: \"include\",\n            });\n\n            if (!response.ok) {\n              throw new Error(`Failed to get upload URL: ${response.statusText}`);\n            }\n\n            const data = await response.json();\n            \n            if (!data.uploadURL) {\n              throw new Error(\"Invalid upload URL response\");\n            }\n\n            // Ensure URL is absolute\n            let uploadURL = data.uploadURL;\n            if (uploadURL.startsWith('/')) {\n              // Convert relative URL to absolute\n              uploadURL = `${window.location.origin}${uploadURL}`;\n            }\n\n            // Validate URL\n            try {\n              const urlObj = new URL(uploadURL);\n              \n              // Extract objectId from upload URL and store in metadata for fallback\n              const objectId = urlObj.searchParams.get('objectId');\n              if (objectId) {\n                uppy.setFileMeta(file.id, { \n                  originalUploadURL: uploadURL,\n                  objectId: objectId,\n                });\n              } else {\n                uppy.setFileMeta(file.id, { \n                  originalUploadURL: uploadURL,\n                });\n              }\n            } catch (e) {\n              throw new Error(`Invalid upload URL format: ${uploadURL}`);\n            }\n\n            return {\n              method: \"PUT\" as const,\n              url: uploadURL,\n              headers: {\n                \"Content-Type\": file.type || \"application/octet-stream\",\n              },\n            };\n          } catch (error: any) {\n            console.error(\"[FieldWidget] Upload URL error:\", error);\n            throw new Error(`Failed to get upload URL: ${error.message}`);\n          }\n        },\n      });\n\n    uppy.on(\"upload-success\", async (file: any, response: any) => {\n      // Extract the file URL from the PUT response using the utility function\n      let uploadUrl = extractFileUrlFromUploadResponse(file, response);\n      \n      // If extraction failed, try to use objectId from metadata as fallback\n      if (!uploadUrl && file?.meta?.objectId) {\n        uploadUrl = `/objects/${file.meta.objectId}`;\n        console.log('[FieldWidget] Using objectId fallback:', uploadUrl);\n      }\n      \n      if (uploadUrl) {\n        // uploadUrl is already normalized to a relative path starting with /objects/\n        // Convert to absolute URL for ACL call\n        const absolutePhotoUrl = `${window.location.origin}${uploadUrl}`;\n        \n        // Set ACL to public so OpenAI can access the photo\n        try {\n          const aclResponse = await fetch(\"/api/objects/set-acl\", {\n            method: \"PUT\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify({ photoUrl: absolutePhotoUrl }),\n          });\n          \n          if (!aclResponse.ok) {\n            const errorData = await aclResponse.json().catch(() => ({ error: \"Unknown error\" }));\n            throw new Error(errorData.error || `ACL setting failed with status ${aclResponse.status}`);\n          }\n          \n          const { objectPath } = await aclResponse.json();\n          \n          if (!objectPath) {\n            throw new Error(\"No object path returned from ACL setting\");\n          }\n          \n          // Use the object path (which is now publicly accessible)\n          handlePhotoAdd(objectPath);\n        } catch (err: any) {\n          console.error(\"Error setting photo ACL:\", err);\n          toast({\n            title: \"Upload Error\",\n            description: err.message || \"Failed to make photo accessible for AI analysis. Please try again.\",\n            variant: \"destructive\",\n          });\n          // Do NOT add the photo to the list if ACL setting failed\n          // This prevents non-public photos from breaking the AI analysis pipeline\n        }\n      } else {\n        // Enhanced debugging - log the full structure to help diagnose\n        console.error('[FieldWidget] No upload URL found in response. Debug info:', {\n          fileKeys: file ? Object.keys(file) : null,\n          fileResponse: file?.response,\n          fileResponseBody: file?.response?.body,\n          fileMeta: file?.meta,\n          responseKeys: response ? Object.keys(response) : null,\n          responseBody: response?.body,\n          fullFile: file,\n          fullResponse: response\n        });\n        toast({\n          title: \"Upload Error\",\n          description: \"Upload succeeded but could not get photo URL. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    });\n\n    uppy.on(\"complete\", () => {\n      setShowPhotoUpload(false);\n    });\n\n    return uppy;\n  };\n\n  const createVideoUppy = () => {\n    const uppy = new Uppy({\n      restrictions: {\n        maxNumberOfFiles: 1,\n        allowedFileTypes: [\"video/*\"],\n        maxFileSize: 104857600, // 100MB\n      },\n      autoProceed: false,\n    }).use(AwsS3, {\n      shouldUseMultipart: false,\n      async getUploadParameters(file: any) {\n        try {\n          const response = await fetch(\"/api/objects/upload\", {\n            method: \"POST\",\n            credentials: \"include\",\n          });\n\n          if (!response.ok) {\n            throw new Error(`Failed to get upload URL: ${response.statusText}`);\n          }\n\n          const data = await response.json();\n          \n          if (!data.uploadURL) {\n            throw new Error(\"Invalid upload URL response\");\n          }\n\n          // Ensure URL is absolute\n          let uploadURL = data.uploadURL;\n          if (uploadURL.startsWith('/')) {\n            // Convert relative URL to absolute\n            uploadURL = `${window.location.origin}${uploadURL}`;\n          }\n\n          // Validate URL\n          try {\n            new URL(uploadURL);\n          } catch (e) {\n            throw new Error(`Invalid upload URL format: ${uploadURL}`);\n          }\n\n          return {\n            method: \"PUT\" as const,\n            url: uploadURL,\n            headers: {\n              \"Content-Type\": file.type || \"application/octet-stream\",\n            },\n          };\n        } catch (error: any) {\n          console.error(\"[FieldWidget] Video upload URL error:\", error);\n          throw new Error(`Failed to get upload URL: ${error.message}`);\n        }\n      },\n    });\n\n    uppy.on(\"upload-success\", (file: any, response: any) => {\n      // Extract the file URL from the PUT response\n      let uploadUrl: string | null = null;\n      \n      // Check file.response.body (most reliable location)\n      if (file?.response?.body) {\n        try {\n          const body = typeof file.response.body === 'string' \n            ? JSON.parse(file.response.body) \n            : file.response.body;\n          uploadUrl = body?.url || body?.uploadURL;\n        } catch (e) {\n          // Not JSON\n        }\n      }\n      \n      // Fallback: check response.body\n      if (!uploadUrl && response?.body) {\n        try {\n          const body = typeof response.body === 'string' \n            ? JSON.parse(response.body) \n            : response.body;\n          uploadUrl = body?.url || body?.uploadURL;\n        } catch (e) {\n          // Not JSON\n        }\n      }\n      \n      // Fallback: check top-level properties\n      if (!uploadUrl) {\n        uploadUrl = response?.uploadURL || response?.url || file?.response?.uploadURL || file?.response?.url;\n      }\n      \n      if (uploadUrl) {\n        const videoUrl = uploadUrl.split(\"?\")[0];\n        handleValueChange(videoUrl);\n        toast({\n          title: \"Success\",\n          description: \"Video uploaded successfully\",\n        });\n      } else {\n        console.error('[FieldWidget] No video URL found in response:', { file, response });\n        toast({\n          title: \"Upload Error\",\n          description: \"Upload succeeded but could not get video URL. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    });\n\n    uppy.on(\"complete\", () => {\n      setShowPhotoUpload(false);\n    });\n\n    return uppy;\n  };\n\n  const handleAnalyzePhoto = async (photoUrl: string) => {\n    if (!inspectionId || !photoUrl) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Unable to analyze photo - missing inspection data\",\n      });\n      return;\n    }\n\n    setAnalyzingPhoto(photoUrl);\n\n    try {\n      const response = await apiRequest(\"POST\", \"/api/ai-analyses\", {\n        inspectionId,\n        inspectionEntryId: entryId,\n        imageUrl: photoUrl,\n        context: `Analyze this photo for ${field.label}. Provide a detailed assessment of the condition, noting any issues, damage, or concerns.`,\n      });\n      \n      const result = await response.json();\n\n      setAiAnalyses((prev) => ({\n        ...prev,\n        [photoUrl]: result,\n      }));\n\n      // Invalidate organization query to update credit balance on dashboard and billing pages\n      if (user?.organizationId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n      }\n\n      toast({\n        title: \"Analysis Complete\",\n        description: \"AI analysis generated successfully (1 credit used)\",\n      });\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Analysis Failed\",\n        description: error.message || \"Failed to analyze photo\",\n      });\n    } finally {\n      setAnalyzingPhoto(null);\n    }\n  };\n\n  const renderField = () => {\n    switch (field.type) {\n      case \"short_text\":\n        return (\n          <Input\n            value={localValue || \"\"}\n            onChange={(e) => handleValueChange(e.target.value)}\n            placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n            data-testid={`input-${field.id}`}\n          />\n        );\n\n      case \"long_text\":\n        return (\n          <Textarea\n            value={localValue || \"\"}\n            onChange={(e) => handleValueChange(e.target.value)}\n            placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n            rows={4}\n            data-testid={`textarea-${field.id}`}\n          />\n        );\n\n      case \"number\":\n        return (\n          <Input\n            type=\"number\"\n            value={localValue || \"\"}\n            onChange={(e) => handleValueChange(parseFloat(e.target.value) || 0)}\n            placeholder={field.placeholder || \"Enter number\"}\n            data-testid={`input-number-${field.id}`}\n          />\n        );\n\n      case \"rating\":\n        return (\n          <div className=\"flex items-center gap-2\">\n            {[1, 2, 3, 4, 5].map((rating) => (\n              <button\n                key={rating}\n                type=\"button\"\n                onClick={() => handleValueChange(rating)}\n                className=\"focus:outline-none\"\n                data-testid={`button-rating-${rating}-${field.id}`}\n              >\n                <Star\n                  className={`w-8 h-8 ${\n                    (localValue || 0) >= rating\n                      ? \"fill-primary text-primary\"\n                      : \"text-muted-foreground\"\n                  }`}\n                />\n              </button>\n            ))}\n            {localValue > 0 && (\n              <span className=\"ml-2 text-sm text-muted-foreground\">\n                {localValue} / 5\n              </span>\n            )}\n          </div>\n        );\n\n      case \"select\":\n        return (\n          <Select value={localValue || \"\"} onValueChange={handleValueChange}>\n            <SelectTrigger data-testid={`select-${field.id}`}>\n              <SelectValue placeholder={field.placeholder || \"Select an option\"} />\n            </SelectTrigger>\n            <SelectContent>\n              {field.options?.map((option) => (\n                <SelectItem key={option} value={option} data-testid={`select-option-${option}`}>\n                  {option}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        );\n\n      case \"multiselect\":\n        const selectedValues = localValue || [];\n        return (\n          <div className=\"space-y-2\">\n            <div className=\"flex flex-wrap gap-2 mb-2\">\n              {selectedValues.map((val: string) => (\n                <Badge\n                  key={val}\n                  variant=\"secondary\"\n                  className=\"cursor-pointer\"\n                  onClick={() => {\n                    const newValues = selectedValues.filter((v: string) => v !== val);\n                    handleValueChange(newValues);\n                  }}\n                  data-testid={`badge-selected-${val}`}\n                >\n                  {val} \n                </Badge>\n              ))}\n            </div>\n            <Select\n              value=\"\"\n              onValueChange={(val) => {\n                if (!selectedValues.includes(val)) {\n                  handleValueChange([...selectedValues, val]);\n                }\n              }}\n            >\n              <SelectTrigger data-testid={`select-multiselect-${field.id}`}>\n                <SelectValue placeholder=\"Add option...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {field.options\n                  ?.filter((opt) => !selectedValues.includes(opt))\n                  .map((option) => (\n                    <SelectItem key={option} value={option}>\n                      {option}\n                    </SelectItem>\n                  ))}\n              </SelectContent>\n            </Select>\n          </div>\n        );\n\n      case \"boolean\":\n        return (\n          <div className=\"flex items-center space-x-2\">\n            <Checkbox\n              checked={localValue || false}\n              onCheckedChange={handleValueChange}\n              data-testid={`checkbox-${field.id}`}\n            />\n            <label className=\"text-sm cursor-pointer\">\n              {field.placeholder || \"Yes\"}\n            </label>\n          </div>\n        );\n\n      case \"date\":\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n            <Input\n              type=\"date\"\n              value={localValue || \"\"}\n              onChange={(e) => handleValueChange(e.target.value)}\n              data-testid={`input-date-${field.id}`}\n            />\n          </div>\n        );\n\n      case \"time\":\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"w-4 h-4 text-muted-foreground\" />\n            <Input\n              type=\"time\"\n              value={localValue || \"\"}\n              onChange={(e) => handleValueChange(e.target.value)}\n              data-testid={`input-time-${field.id}`}\n            />\n          </div>\n        );\n\n      case \"datetime\":\n        return (\n          <Input\n            type=\"datetime-local\"\n            value={localValue || \"\"}\n            onChange={(e) => handleValueChange(e.target.value)}\n            data-testid={`input-datetime-${field.id}`}\n          />\n        );\n\n      case \"photo\":\n      case \"photo_array\":\n        return (\n          <div className=\"space-y-3\">\n            {/* Check-In Reference Photos */}\n            {isCheckOut && checkInPhotos.length > 0 && (\n              <Alert className=\"border-primary/50 bg-primary/5\">\n                <Eye className=\"h-4 w-4 text-primary\" />\n                <AlertDescription>\n                  <div className=\"space-y-2\">\n                    <p className=\"font-medium text-sm\">\n                      Check-In Reference Photos\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Match these angles when taking your Check-Out photos for accurate comparison\n                    </p>\n                    <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 mt-2\">\n                      {checkInPhotos.map((photoUrl: string, index: number) => (\n                        <div key={index} className=\"relative group\">\n                          <img\n                            src={photoUrl}\n                            alt={`Check-In Reference ${index + 1}`}\n                            className=\"w-full h-32 object-cover rounded-md border-2 border-primary/30\"\n                            data-testid={`img-check-in-reference-${index}`}\n                          />\n                          <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors rounded-md flex items-center justify-center\">\n                            <Badge variant=\"secondary\" className=\"opacity-0 group-hover:opacity-100 transition-opacity\">\n                              Reference {index + 1}\n                            </Badge>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {localPhotos.length > 0 && (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {localPhotos.map((photoUrl, index) => (\n                  <Card key={index} className=\"overflow-hidden\">\n                    <CardContent className=\"p-0\">\n                      <div className=\"relative group\">\n                        <img\n                          src={photoUrl}\n                          alt={`${field.label} ${index + 1}`}\n                          className=\"w-full h-48 object-cover\"\n                        />\n                        <Button\n                          size=\"icon\"\n                          variant=\"destructive\"\n                          className=\"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity\"\n                          onClick={() => handlePhotoRemove(photoUrl)}\n                          data-testid={`button-remove-photo-${index}`}\n                        >\n                          <X className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                      <div className=\"p-3 space-y-2\">\n                        {inspectionId && (\n                          <Button\n                            type=\"button\"\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => handleAnalyzePhoto(photoUrl)}\n                            disabled={analyzingPhoto === photoUrl || !!aiAnalyses[photoUrl]}\n                            data-testid={`button-analyze-photo-${index}`}\n                            className=\"w-full\"\n                          >\n                            <Sparkles className=\"w-4 h-4 mr-2\" />\n                            {analyzingPhoto === photoUrl\n                              ? \"Analyzing...\"\n                              : aiAnalyses[photoUrl]\n                              ? \"Analyzed\"\n                              : \"Analyze with AI\"}\n                          </Button>\n                        )}\n                        {aiAnalyses[photoUrl] && (\n                          <div className=\"p-3 bg-muted rounded-lg text-sm\">\n                            <p className=\"font-medium mb-1 flex items-center gap-2\">\n                              <Sparkles className=\"w-4 h-4\" />\n                              AI Analysis\n                            </p>\n                            <p className=\"text-muted-foreground whitespace-pre-wrap\">\n                              {aiAnalyses[photoUrl].resultJson?.analysis || \n                               aiAnalyses[photoUrl].resultJson?.content ||\n                               \"Analysis completed\"}\n                            </p>\n                          </div>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setShowPhotoUpload(true)}\n              disabled={field.type === \"photo\" && localPhotos.length >= 1}\n              data-testid={`button-upload-photo-${field.id}`}\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              {localPhotos.length > 0 ? \"Add More Photos\" : \"Upload Photo\"}\n            </Button>\n            {showPhotoUpload && (\n              <Dashboard\n                uppy={createPhotoUppy()}\n                proudlyDisplayPoweredByUppy={false}\n                height={300}\n                plugins={['Webcam']}\n              />\n            )}\n          </div>\n        );\n\n      case \"video\":\n        return (\n          <div className=\"space-y-3\">\n            {localValue && (\n              <video\n                src={localValue}\n                controls\n                className=\"w-full max-h-64 rounded-lg\"\n                data-testid={`video-preview-${field.id}`}\n              />\n            )}\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setShowPhotoUpload(true)}\n              data-testid={`button-upload-video-${field.id}`}\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              {localValue ? \"Replace Video\" : \"Upload Video\"}\n            </Button>\n            {showPhotoUpload && (\n              <Dashboard\n                uppy={createVideoUppy()}\n                proudlyDisplayPoweredByUppy={false}\n                height={300}\n              />\n            )}\n          </div>\n        );\n\n      case \"gps\":\n        return (\n          <div className=\"flex items-center gap-2\">\n            <MapPin className=\"w-4 h-4 text-muted-foreground\" />\n            <Input\n              value={localValue || \"\"}\n              onChange={(e) => handleValueChange(e.target.value)}\n              placeholder=\"Latitude, Longitude\"\n              data-testid={`input-gps-${field.id}`}\n            />\n          </div>\n        );\n\n      case \"signature\":\n        const handleClearSignature = () => {\n          if (signaturePadRef.current) {\n            signaturePadRef.current.clear();\n            handleValueChange(\"\");\n          }\n        };\n\n        const handleSaveSignature = () => {\n          if (signaturePadRef.current && !signaturePadRef.current.isEmpty()) {\n            const signatureData = signaturePadRef.current.toDataURL();\n            handleValueChange(signatureData);\n            toast({\n              title: \"Signature saved\",\n              description: \"Your signature has been captured successfully.\",\n            });\n          }\n        };\n\n        return (\n          <div className=\"space-y-3\">\n            {localValue ? (\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"space-y-3\">\n                    <img \n                      src={localValue} \n                      alt=\"Signature\" \n                      className=\"w-full h-40 object-contain border rounded bg-background\"\n                      data-testid={`img-signature-${field.id}`}\n                    />\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={handleClearSignature}\n                      data-testid={`button-clear-signature-${field.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4 mr-2\" />\n                      Clear Signature\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ) : (\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"space-y-3\">\n                    <div className=\"border-2 border-dashed rounded bg-background\">\n                      <SignatureCanvas\n                        ref={signaturePadRef}\n                        canvasProps={{\n                          className: \"w-full h-40 cursor-crosshair\",\n                          \"data-testid\": `canvas-signature-${field.id}`\n                        }}\n                        backgroundColor=\"transparent\"\n                      />\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleClearSignature}\n                        data-testid={`button-clear-signature-${field.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" />\n                        Clear\n                      </Button>\n                      <Button\n                        variant=\"default\"\n                        size=\"sm\"\n                        onClick={handleSaveSignature}\n                        data-testid={`button-save-signature-${field.id}`}\n                      >\n                        <Save className=\"w-4 h-4 mr-2\" />\n                        Save Signature\n                      </Button>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Draw your signature above and click \"Save Signature\" to capture it.\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        );\n\n      default:\n        return (\n          <Input\n            value={localValue || \"\"}\n            onChange={(e) => handleValueChange(e.target.value)}\n            placeholder={field.placeholder || \"Enter value\"}\n            data-testid={`input-default-${field.id}`}\n          />\n        );\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\" data-testid={`field-widget-${field.id}`}>\n      <Label className=\"text-base font-medium flex items-center gap-2\">\n        {field.label}\n        {field.required && <span className=\"text-destructive\">*</span>}\n      </Label>\n\n      {renderField()}\n\n      {/* Condition Rating */}\n      {field.includeCondition && (\n        <div className=\"pt-2\">\n          <Label className=\"text-sm font-medium\">Condition</Label>\n          <Select value={localCondition || \"\"} onValueChange={handleConditionChange}>\n            <SelectTrigger data-testid={`select-condition-${field.id}`} className=\"mt-1\">\n              <SelectValue placeholder=\"Select condition\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"Excellent\">Excellent</SelectItem>\n              <SelectItem value=\"Good\">Good</SelectItem>\n              <SelectItem value=\"Poor\">Poor</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n\n      {/* Cleanliness Rating */}\n      {field.includeCleanliness && (\n        <div className=\"pt-2\">\n          <Label className=\"text-sm font-medium\">Cleanliness</Label>\n          <Select value={localCleanliness || \"\"} onValueChange={handleCleanlinessChange}>\n            <SelectTrigger data-testid={`select-cleanliness-${field.id}`} className=\"mt-1\">\n              <SelectValue placeholder=\"Select cleanliness\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"Clean\">Clean</SelectItem>\n              <SelectItem value=\"Needs a Clean\">Needs a Clean</SelectItem>\n              <SelectItem value=\"Poor\">Poor</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n\n      {/* InspectAI Button - only show when photos exist */}\n      {inspectionId && localPhotos.length > 0 && (\n        <div className=\"pt-2\">\n          <Button\n            type=\"button\"\n            variant=\"default\"\n            onClick={handleInspectField}\n            disabled={analyzingField}\n            data-testid={`button-inspect-ai-${field.id}`}\n            className=\"w-full\"\n          >\n            <Sparkles className=\"w-4 h-4 mr-2\" />\n            {analyzingField ? \"Analyzing...\" : \"InspectAI\"}\n          </Button>\n          <p className=\"text-xs text-muted-foreground mt-1\">\n            {analyzingField \n              ? \"Analyzing images with AI...\"\n              : \"Use AI to analyze all photos and generate a detailed inspection report\"}\n          </p>\n        </div>\n      )}\n\n      {/* Optional notes */}\n      <div className=\"pt-2\">\n        <Label htmlFor={`note-${field.id}`} className=\"text-sm text-muted-foreground\">\n          Notes (optional)\n        </Label>\n        <Textarea\n          id={`note-${field.id}`}\n          value={localNote}\n          onChange={(e) => handleNoteChange(e.target.value)}\n          placeholder=\"Add any observations or notes...\"\n          rows={2}\n          className=\"mt-1\"\n          data-testid={`textarea-note-${field.id}`}\n        />\n      </div>\n\n      {/* Mark for Review - Only for Check Out inspections WITH photos */}\n      {isCheckOut && localPhotos.length > 0 && (\n        <div className=\"pt-3 flex items-center space-x-2\">\n          <Checkbox\n            id={`mark-review-${field.id}`}\n            checked={localMarkedForReview}\n            onCheckedChange={(checked) => {\n              const isChecked = checked === true;\n              setLocalMarkedForReview(isChecked);\n              onMarkedForReviewChange?.(isChecked);\n            }}\n            data-testid={`checkbox-mark-review-${field.id}`}\n          />\n          <Label \n            htmlFor={`mark-review-${field.id}`} \n            className=\"text-sm font-medium cursor-pointer\"\n          >\n            Mark for Comparison Report\n          </Label>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":38939},"client/src/pages/ComparisonReports.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { FileText, ArrowRight, User, Building2, Calendar, DollarSign, Plus } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { Link } from \"wouter\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface ComparisonReport {\n  id: string;\n  propertyId: string;\n  tenantId: string;\n  status: \"draft\" | \"under_review\" | \"awaiting_signatures\" | \"signed\" | \"filed\";\n  totalEstimatedCost: string;\n  operatorSignature: string | null;\n  tenantSignature: string | null;\n  createdAt: string;\n  updatedAt: string;\n}\n\nconst statusConfig = {\n  draft: { label: \"Draft\", color: \"bg-gray-500\" },\n  under_review: { label: \"Under Review\", color: \"bg-blue-500\" },\n  awaiting_signatures: { label: \"Awaiting Signatures\", color: \"bg-amber-500\" },\n  signed: { label: \"Signed\", color: \"bg-green-500\" },\n  filed: { label: \"Filed\", color: \"bg-slate-600\" },\n};\n\nexport default function ComparisonReports() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [selectedPropertyId, setSelectedPropertyId] = useState(\"\");\n  const [selectedCheckInId, setSelectedCheckInId] = useState(\"\");\n  const [selectedCheckOutId, setSelectedCheckOutId] = useState(\"\");\n\n  const handleDialogOpenChange = (open: boolean) => {\n    setIsDialogOpen(open);\n    if (open) {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections/my\"] });\n    }\n  };\n\n  const { data: reports = [], isLoading } = useQuery<ComparisonReport[]>({\n    queryKey: [\"/api/comparison-reports\"],\n  });\n\n  const { data: properties = [] } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  // Fetch all inspections\n  const { data: allInspections = [] } = useQuery<any[]>({\n    queryKey: [\"/api/inspections/my\"],\n  });\n\n  // Filter inspections by selected property and type\n  const checkInInspections = allInspections.filter(\n    (i) => i.propertyId === selectedPropertyId && i.type === \"check_in\" && i.status === \"completed\"\n  );\n  \n  const checkOutInspections = allInspections.filter(\n    (i) => i.propertyId === selectedPropertyId && i.type === \"check_out\" && i.status === \"completed\"\n  );\n\n  const generateReportMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/comparison-reports\", {\n        propertyId: selectedPropertyId,\n        checkInInspectionId: selectedCheckInId,\n        checkOutInspectionId: selectedCheckOutId,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/comparison-reports\"] });\n      // Invalidate organization query to update credit balance on dashboard and billing pages\n      if (user?.organizationId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n      }\n      setIsDialogOpen(false);\n      setSelectedPropertyId(\"\");\n      setSelectedCheckInId(\"\");\n      setSelectedCheckOutId(\"\");\n      toast({\n        title: \"Success\",\n        description: \"Comparison report generated successfully. AI analysis is processing...\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to generate comparison report\",\n      });\n    },\n  });\n\n  const getPropertyName = (propertyId: string) => {\n    const property = properties.find(p => p.id === propertyId);\n    return property?.name || \"Unknown Property\";\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-6\" data-testid=\"page-comparison-reports\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-4xl font-bold flex items-center gap-3\" data-testid=\"heading-comparison-reports\">\n            <FileText className=\"w-10 h-10 text-primary\" />\n            Comparison Reports\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            AI-powered check-in vs check-out analysis with cost estimation and signatures\n          </p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={handleDialogOpenChange}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-generate-report\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Generate Report\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Generate Comparison Report</DialogTitle>\n              <DialogDescription>\n                Compare check-in and check-out inspections to analyze damages and estimate costs. Costs 2 credits.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Property</label>\n                <Select value={selectedPropertyId} onValueChange={setSelectedPropertyId}>\n                  <SelectTrigger data-testid=\"select-property\">\n                    <SelectValue placeholder=\"Select property\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {properties.map((property) => (\n                      <SelectItem key={property.id} value={property.id}>\n                        {property.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {selectedPropertyId && (\n                <>\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Check-In Inspection</label>\n                    <Select value={selectedCheckInId} onValueChange={setSelectedCheckInId}>\n                      <SelectTrigger data-testid=\"select-check-in\">\n                        <SelectValue placeholder=\"Select check-in inspection\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {checkInInspections.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">\n                            No completed check-in inspections\n                          </div>\n                        ) : (\n                          checkInInspections.map((inspection) => (\n                            <SelectItem key={inspection.id} value={inspection.id}>\n                              {format(new Date(inspection.scheduledDate), \"MMM d, yyyy\")}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Check-Out Inspection</label>\n                    <Select value={selectedCheckOutId} onValueChange={setSelectedCheckOutId}>\n                      <SelectTrigger data-testid=\"select-check-out\">\n                        <SelectValue placeholder=\"Select check-out inspection\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {checkOutInspections.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">\n                            No completed check-out inspections\n                          </div>\n                        ) : (\n                          checkOutInspections.map((inspection) => (\n                            <SelectItem key={inspection.id} value={inspection.id}>\n                              {format(new Date(inspection.scheduledDate), \"MMM d, yyyy\")}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </>\n              )}\n\n              <Button\n                className=\"w-full\"\n                onClick={() => generateReportMutation.mutate()}\n                disabled={!selectedPropertyId || !selectedCheckInId || !selectedCheckOutId || generateReportMutation.isPending}\n                data-testid=\"button-confirm-generate\"\n              >\n                {generateReportMutation.isPending ? \"Generating...\" : \"Generate Report (2 credits)\"}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-6\">\n                <div className=\"space-y-3\">\n                  <Skeleton className=\"h-6 w-1/3\" />\n                  <Skeleton className=\"h-4 w-2/3\" />\n                  <Skeleton className=\"h-4 w-1/2\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : reports.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <FileText className=\"w-16 h-16 text-muted-foreground/50 mb-4\" />\n            <h3 className=\"text-xl font-semibold mb-2\">No Comparison Reports</h3>\n            <p className=\"text-muted-foreground text-center max-w-md mb-4\">\n              Generate comparison reports to analyze check-in vs check-out inspections with AI-powered cost estimation.\n            </p>\n            <Button onClick={() => setIsDialogOpen(true)} data-testid=\"button-generate-first\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Generate Your First Report\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {reports.map((report) => {\n            const statusInfo = statusConfig[report.status];\n            const totalCost = parseFloat(report.totalEstimatedCost);\n            \n            return (\n              <Card \n                key={report.id} \n                className=\"hover-elevate transition-all duration-150\"\n                data-testid={`card-report-${report.id}`}\n              >\n                <CardContent className=\"p-6\">\n                  <div className=\"flex items-start justify-between gap-4\">\n                    <div className=\"flex-1 space-y-3\">\n                      {/* Status and Date */}\n                      <div className=\"flex items-center gap-3 flex-wrap\">\n                        <Badge className={`${statusInfo.color} text-white`}>\n                          {statusInfo.label}\n                        </Badge>\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Calendar className=\"w-4 h-4\" />\n                          {format(new Date(report.createdAt), \"MMM d, yyyy\")}\n                        </div>\n                      </div>\n\n                      {/* Property */}\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"font-medium\">{getPropertyName(report.propertyId)}</span>\n                      </div>\n\n                      {/* Cost */}\n                      <div className=\"flex items-center gap-2\">\n                        <DollarSign className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"text-lg font-semibold\">\n                          ${totalCost.toFixed(2)}\n                        </span>\n                        <span className=\"text-sm text-muted-foreground\">estimated tenant liability</span>\n                      </div>\n\n                      {/* Signatures */}\n                      <div className=\"flex items-center gap-6 text-sm\">\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"text-muted-foreground\">Operator:</span>\n                          {report.operatorSignature ? (\n                            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n                              Signed\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Pending</Badge>\n                          )}\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"text-muted-foreground\">Tenant:</span>\n                          {report.tenantSignature ? (\n                            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n                              Signed\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Pending</Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* View Button */}\n                    <Link href={`/comparisons/${report.id}`}>\n                      <a>\n                        <Button variant=\"outline\" size=\"sm\" data-testid={`button-view-${report.id}`}>\n                          View Details\n                          <ArrowRight className=\"w-4 h-4 ml-2\" />\n                        </Button>\n                      </a>\n                    </Link>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":14179},"client/src/lib/offlineQueue.ts":{"content":"import { useState, useEffect } from \"react\";\nimport { nanoid } from \"nanoid\";\nimport type { QuickAddAsset, QuickAddMaintenance, QuickUpdateAsset } from \"@shared/schema\";\n\n// Discriminated union for different queue entry types\nexport type QueuedEntry =\n  | {\n      type: \"inspection_entry\";\n      id: string; // Local queue ID\n      offlineId: string; // For server-side dedup\n      inspectionId: string;\n      sectionRef: string;\n      fieldKey: string;\n      fieldType: string;\n      valueJson: any;\n      note?: string;\n      photos?: string[];\n      timestamp: number;\n      synced: boolean;\n      attempts: number;\n    }\n  | {\n      type: \"asset\";\n      id: string; // Local queue ID\n      offlineId: string; // For server-side dedup\n      payload: QuickAddAsset;\n      timestamp: number;\n      synced: boolean;\n      attempts: number;\n    }\n  | {\n      type: \"asset_update\";\n      id: string; // Local queue ID\n      assetId: string; // ID of asset being updated\n      payload: QuickUpdateAsset;\n      timestamp: number;\n      synced: boolean;\n      attempts: number;\n    }\n  | {\n      type: \"maintenance\";\n      id: string; // Local queue ID\n      offlineId: string; // For server-side dedup\n      payload: QuickAddMaintenance;\n      timestamp: number;\n      synced: boolean;\n      attempts: number;\n    };\n\nconst QUEUE_KEY = \"inspect360_offline_queue\";\nconst MAX_RETRY_ATTEMPTS = 3;\n\nexport class OfflineQueue {\n  private queue: QueuedEntry[] = [];\n  private isSyncing = false;\n\n  constructor() {\n    this.loadQueue();\n  }\n\n  private loadQueue() {\n    try {\n      const stored = localStorage.getItem(QUEUE_KEY);\n      if (stored) {\n        this.queue = JSON.parse(stored);\n      }\n    } catch (error) {\n      console.error(\"Failed to load offline queue:\", error);\n      this.queue = [];\n    }\n  }\n\n  private saveQueue() {\n    try {\n      localStorage.setItem(QUEUE_KEY, JSON.stringify(this.queue));\n    } catch (error) {\n      console.error(\"Failed to save offline queue:\", error);\n    }\n  }\n\n  // Enqueue inspection entry\n  enqueueInspectionEntry(\n    entry: Omit<Extract<QueuedEntry, { type: \"inspection_entry\" }>, \"id\" | \"offlineId\" | \"timestamp\" | \"synced\" | \"attempts\" | \"type\">\n  ) {\n    const queuedEntry: QueuedEntry = {\n      type: \"inspection_entry\",\n      id: nanoid(),\n      offlineId: nanoid(16),\n      ...entry,\n      timestamp: Date.now(),\n      synced: false,\n      attempts: 0,\n    };\n\n    this.queue.push(queuedEntry);\n    this.saveQueue();\n    return queuedEntry;\n  }\n\n  // Enqueue asset\n  enqueueAsset(payload: QuickAddAsset) {\n    const queuedEntry: QueuedEntry = {\n      type: \"asset\",\n      id: nanoid(),\n      offlineId: nanoid(16),\n      payload,\n      timestamp: Date.now(),\n      synced: false,\n      attempts: 0,\n    };\n\n    this.queue.push(queuedEntry);\n    this.saveQueue();\n    return queuedEntry;\n  }\n\n  // Enqueue asset update\n  enqueueAssetUpdate(assetId: string, payload: QuickUpdateAsset) {\n    const queuedEntry: QueuedEntry = {\n      type: \"asset_update\",\n      id: nanoid(),\n      assetId,\n      payload: {\n        ...payload,\n        offlineId: nanoid(16), // Add offlineId for deduplication\n      },\n      timestamp: Date.now(),\n      synced: false,\n      attempts: 0,\n    };\n\n    this.queue.push(queuedEntry);\n    this.saveQueue();\n    return queuedEntry;\n  }\n\n  // Enqueue maintenance request\n  enqueueMaintenance(payload: QuickAddMaintenance) {\n    const queuedEntry: QueuedEntry = {\n      type: \"maintenance\",\n      id: nanoid(),\n      offlineId: nanoid(16),\n      payload,\n      timestamp: Date.now(),\n      synced: false,\n      attempts: 0,\n    };\n\n    this.queue.push(queuedEntry);\n    this.saveQueue();\n    return queuedEntry;\n  }\n\n  // Legacy method for backward compatibility\n  enqueue(entry: Omit<Extract<QueuedEntry, { type: \"inspection_entry\" }>, \"id\" | \"offlineId\" | \"timestamp\" | \"synced\" | \"attempts\" | \"type\">) {\n    return this.enqueueInspectionEntry(entry);\n  }\n\n  getQueue(): QueuedEntry[] {\n    return [...this.queue];\n  }\n\n  getPendingCount(): number {\n    return this.queue.filter((e) => !e.synced).length;\n  }\n\n  getPendingCountByType(type: \"inspection_entry\" | \"asset\" | \"asset_update\" | \"maintenance\"): number {\n    return this.queue.filter((e) => e.type === type && !e.synced).length;\n  }\n\n  markAsSynced(id: string) {\n    const index = this.queue.findIndex((e) => e.id === id);\n    if (index !== -1) {\n      this.queue[index].synced = true;\n      this.saveQueue();\n    }\n  }\n\n  markAsFailed(id: string) {\n    const index = this.queue.findIndex((e) => e.id === id);\n    if (index !== -1) {\n      this.queue[index].attempts += 1;\n      if (this.queue[index].attempts >= MAX_RETRY_ATTEMPTS) {\n        // Keep failed entries for manual review\n        this.saveQueue();\n      }\n    }\n  }\n\n  clearSynced() {\n    this.queue = this.queue.filter((e) => !e.synced);\n    this.saveQueue();\n  }\n\n  async syncAll(apiRequest: (method: string, url: string, body?: any) => Promise<any>): Promise<{\n    success: number;\n    failed: number;\n    details: { inspectionEntries: number; assets: number; assetUpdates: number; maintenance: number };\n  }> {\n    if (this.isSyncing) {\n      return { success: 0, failed: 0, details: { inspectionEntries: 0, assets: 0, assetUpdates: 0, maintenance: 0 } };\n    }\n\n    this.isSyncing = true;\n    const pending = this.queue.filter((e) => !e.synced && e.attempts < MAX_RETRY_ATTEMPTS);\n\n    let successCount = 0;\n    let failedCount = 0;\n    const details = { inspectionEntries: 0, assets: 0, assetUpdates: 0, maintenance: 0 };\n\n    for (const entry of pending) {\n      try {\n        if (entry.type === \"inspection_entry\") {\n          await apiRequest(\"POST\", \"/api/inspection-entries\", {\n            inspectionId: entry.inspectionId,\n            sectionRef: entry.sectionRef,\n            fieldKey: entry.fieldKey,\n            fieldType: entry.fieldType,\n            valueJson: entry.valueJson,\n            note: entry.note,\n            photos: entry.photos,\n            offlineId: entry.offlineId,\n          });\n          details.inspectionEntries++;\n        } else if (entry.type === \"asset\") {\n          await apiRequest(\"POST\", \"/api/asset-inventory/quick\", {\n            ...entry.payload,\n            offlineId: entry.offlineId,\n          });\n          details.assets++;\n        } else if (entry.type === \"asset_update\") {\n          await apiRequest(\"PATCH\", `/api/asset-inventory/${entry.assetId}/quick`, entry.payload);\n          details.assetUpdates++;\n        } else if (entry.type === \"maintenance\") {\n          await apiRequest(\"POST\", \"/api/maintenance/quick\", {\n            ...entry.payload,\n            offlineId: entry.offlineId,\n          });\n          details.maintenance++;\n        }\n\n        this.markAsSynced(entry.id);\n        successCount++;\n      } catch (error) {\n        console.error(`Failed to sync ${entry.type} entry ${entry.id}:`, error);\n        this.markAsFailed(entry.id);\n        failedCount++;\n      }\n    }\n\n    this.isSyncing = false;\n    return { success: successCount, failed: failedCount, details };\n  }\n\n  getIsSyncing(): boolean {\n    return this.isSyncing;\n  }\n}\n\n// Singleton instance\nexport const offlineQueue = new OfflineQueue();\n\n// Online/offline detection\nexport function useOnlineStatus() {\n  const [isOnline, setIsOnline] = useState(navigator.onLine);\n\n  useEffect(() => {\n    const handleOnline = () => setIsOnline(true);\n    const handleOffline = () => setIsOnline(false);\n\n    window.addEventListener(\"online\", handleOnline);\n    window.addEventListener(\"offline\", handleOffline);\n\n    return () => {\n      window.removeEventListener(\"online\", handleOnline);\n      window.removeEventListener(\"offline\", handleOffline);\n    };\n  }, []);\n\n  return isOnline;\n}\n","size_bytes":7706},"client/src/pages/AdminTeam.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { Shield, Plus, Trash2, Edit, ArrowLeft } from \"lucide-react\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\n\nexport default function AdminTeam() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [createDialog, setCreateDialog] = useState(false);\n  const [editDialog, setEditDialog] = useState(false);\n  const [deleteDialog, setDeleteDialog] = useState(false);\n  const [selectedAdmin, setSelectedAdmin] = useState<any>(null);\n  const [formData, setFormData] = useState({\n    email: \"\",\n    password: \"\",\n    firstName: \"\",\n    lastName: \"\",\n  });\n\n  // Fetch admin team\n  const { data: admins = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/admin/team\"],\n    retry: false,\n  });\n\n  // Fetch current admin user\n  const { data: currentAdmin, isLoading: isLoadingAdmin } = useQuery({\n    queryKey: [\"/api/admin/me\"],\n    retry: false,\n  });\n\n  // Create admin mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await fetch(\"/api/admin/team\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create admin\");\n      }\n      return response.json();\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/admin/team\"] });\n      setCreateDialog(false);\n      setFormData({ email: \"\", password: \"\", firstName: \"\", lastName: \"\" });\n      toast({\n        title: \"Admin Created\",\n        description: \"New admin user has been created successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Creation Failed\",\n        description: error.message,\n      });\n    },\n  });\n\n  // Update admin mutation\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      const response = await fetch(`/api/admin/team/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to update admin\");\n      return response.json();\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/admin/team\"] });\n      setEditDialog(false);\n      toast({\n        title: \"Admin Updated\",\n        description: \"Admin user has been updated successfully\",\n      });\n    },\n  });\n\n  // Delete admin mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/admin/team/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to delete admin\");\n      }\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/admin/team\"] });\n      setDeleteDialog(false);\n      setSelectedAdmin(null);\n      toast({\n        title: \"Admin Deleted\",\n        description: \"Admin user has been removed successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Deletion Failed\",\n        description: error.message,\n      });\n    },\n  });\n\n  const handleCreateClick = () => {\n    setFormData({ email: \"\", password: \"\", firstName: \"\", lastName: \"\" });\n    setCreateDialog(true);\n  };\n\n  const handleEditClick = (admin: any) => {\n    setSelectedAdmin(admin);\n    setFormData({\n      email: admin.email,\n      password: \"\",\n      firstName: admin.firstName,\n      lastName: admin.lastName,\n    });\n    setEditDialog(true);\n  };\n\n  const handleDeleteClick = (admin: any) => {\n    setSelectedAdmin(admin);\n    setDeleteDialog(true);\n  };\n\n  const handleCreateSubmit = () => {\n    createMutation.mutate(formData);\n  };\n\n  const handleEditSubmit = () => {\n    if (selectedAdmin) {\n      const updateData: any = {\n        email: formData.email,\n        firstName: formData.firstName,\n        lastName: formData.lastName,\n      };\n      if (formData.password) {\n        updateData.password = formData.password;\n      }\n      updateMutation.mutate({ id: selectedAdmin.id, data: updateData });\n    }\n  };\n\n  const handleDeleteConfirm = () => {\n    if (selectedAdmin) {\n      deleteMutation.mutate(selectedAdmin.id);\n    }\n  };\n\n  // Show loading state while checking authentication\n  if (isLoadingAdmin) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Redirect to login if not authenticated\n  if (!currentAdmin) {\n    navigate(\"/admin/login\");\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"border-b bg-card\">\n        <div className=\"container mx-auto px-4 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => navigate(\"/admin/dashboard\")}\n              data-testid=\"button-back-to-dashboard\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Dashboard\n            </Button>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <Shield className=\"w-8 h-8 text-primary\" />\n            <div>\n              <h1 className=\"text-2xl font-bold\" data-testid=\"heading-admin-team\">Admin Team</h1>\n              <p className=\"text-sm text-muted-foreground\">Manage admin users</p>\n            </div>\n          </div>\n          <div />\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <div className=\"container mx-auto px-4 py-8 space-y-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-4\">\n            <div>\n              <CardTitle>Admin Users</CardTitle>\n              <CardDescription>\n                Manage admin accounts with access to this dashboard\n              </CardDescription>\n            </div>\n            <Button onClick={handleCreateClick} data-testid=\"button-create-admin\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Admin\n            </Button>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Name</TableHead>\n                  <TableHead>Email</TableHead>\n                  <TableHead>Created</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {isLoading ? (\n                  <TableRow>\n                    <TableCell colSpan={4} className=\"text-center py-8 text-muted-foreground\">\n                      Loading admin users...\n                    </TableCell>\n                  </TableRow>\n                ) : admins.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={4} className=\"text-center py-8 text-muted-foreground\">\n                      No admin users found\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  admins.map((admin) => (\n                    <TableRow key={admin.id} data-testid={`row-admin-${admin.id}`}>\n                      <TableCell className=\"font-medium\">\n                        {admin.firstName} {admin.lastName}\n                        {currentAdmin.id === admin.id && (\n                          <span className=\"ml-2 text-xs text-muted-foreground\">(You)</span>\n                        )}\n                      </TableCell>\n                      <TableCell>{admin.email}</TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground\">\n                        {new Date(admin.createdAt).toLocaleDateString()}\n                      </TableCell>\n                      <TableCell className=\"text-right space-x-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleEditClick(admin)}\n                          data-testid={`button-edit-admin-${admin.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={() => handleDeleteClick(admin)}\n                          disabled={currentAdmin.id === admin.id}\n                          data-testid={`button-delete-admin-${admin.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Create Dialog */}\n      <Dialog open={createDialog} onOpenChange={setCreateDialog}>\n        <DialogContent data-testid=\"dialog-create-admin\">\n          <DialogHeader>\n            <DialogTitle>Create Admin User</DialogTitle>\n            <DialogDescription>\n              Add a new admin user with access to this dashboard\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>First Name</Label>\n              <Input\n                value={formData.firstName}\n                onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                placeholder=\"John\"\n                data-testid=\"input-first-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Last Name</Label>\n              <Input\n                value={formData.lastName}\n                onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                placeholder=\"Doe\"\n                data-testid=\"input-last-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Email</Label>\n              <Input\n                type=\"email\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                placeholder=\"admin@inspect360.com\"\n                data-testid=\"input-email\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Password</Label>\n              <Input\n                type=\"password\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                placeholder=\"Enter password\"\n                data-testid=\"input-password\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setCreateDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleCreateSubmit}\n              disabled={createMutation.isPending}\n              data-testid=\"button-submit-create\"\n            >\n              {createMutation.isPending ? \"Creating...\" : \"Create Admin\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={editDialog} onOpenChange={setEditDialog}>\n        <DialogContent data-testid=\"dialog-edit-admin\">\n          <DialogHeader>\n            <DialogTitle>Edit Admin User</DialogTitle>\n            <DialogDescription>\n              Update admin user information\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>First Name</Label>\n              <Input\n                value={formData.firstName}\n                onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                data-testid=\"input-edit-first-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Last Name</Label>\n              <Input\n                value={formData.lastName}\n                onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                data-testid=\"input-edit-last-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Email</Label>\n              <Input\n                type=\"email\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                data-testid=\"input-edit-email\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>New Password (leave blank to keep current)</Label>\n              <Input\n                type=\"password\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                placeholder=\"Enter new password\"\n                data-testid=\"input-edit-password\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setEditDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleEditSubmit}\n              disabled={updateMutation.isPending}\n              data-testid=\"button-submit-edit\"\n            >\n              {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={deleteDialog} onOpenChange={setDeleteDialog}>\n        <DialogContent data-testid=\"dialog-delete-admin\">\n          <DialogHeader>\n            <DialogTitle>Delete Admin User</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete{\" \"}\n              <span className=\"font-semibold\">\n                {selectedAdmin?.firstName} {selectedAdmin?.lastName}\n              </span>\n              ? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDeleteConfirm}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete Admin\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":15945},"client/src/pages/AdminDashboard.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { Shield, Search, Building2, LogOut, Users, CreditCard, AlertCircle, CheckCircle, XCircle, BookOpen, Settings } from \"lucide-react\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\n\nexport default function AdminDashboard() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedInstance, setSelectedInstance] = useState<any>(null);\n  const [editDialog, setEditDialog] = useState(false);\n  const [editFormData, setEditFormData] = useState({\n    subscriptionLevel: \"\",\n    creditsRemaining: 0,\n    isActive: true,\n  });\n\n  // Fetch admin user\n  const { data: adminUser, isLoading: isLoadingAdmin } = useQuery({\n    queryKey: [\"/api/admin/me\"],\n    retry: false,\n  });\n\n  // Fetch instances\n  const { data: instances = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/admin/instances\"],\n    retry: false,\n  });\n\n  // Logout mutation\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      await fetch(\"/api/admin/logout\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n    },\n    onSuccess: () => {\n      navigate(\"/admin/login\");\n    },\n  });\n\n  // Update instance mutation\n  const updateInstanceMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      const response = await fetch(`/api/admin/instances/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to update instance\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/instances\"] });\n      setEditDialog(false);\n      toast({\n        title: \"Instance Updated\",\n        description: \"Instance settings have been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Update Failed\",\n        description: \"Failed to update instance settings\",\n      });\n    },\n  });\n\n  // Toggle status mutation\n  const toggleStatusMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/admin/instances/${id}/toggle-status`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to toggle status\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/instances\"] });\n      toast({\n        title: \"Status Updated\",\n        description: \"Instance status has been toggled successfully\",\n      });\n    },\n  });\n\n  // Filter instances based on search\n  const filteredInstances = instances.filter(\n    (instance) =>\n      instance.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      instance.owner?.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      instance.owner?.firstName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      instance.owner?.lastName?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const handleEditClick = (instance: any) => {\n    setSelectedInstance(instance);\n    setEditFormData({\n      subscriptionLevel: instance.subscriptionLevel || \"free\",\n      creditsRemaining: instance.creditsRemaining || 0,\n      isActive: instance.isActive !== false,\n    });\n    setEditDialog(true);\n  };\n\n  const handleEditSubmit = () => {\n    if (selectedInstance) {\n      updateInstanceMutation.mutate({\n        id: selectedInstance.id,\n        data: editFormData,\n      });\n    }\n  };\n\n  // Show loading state while checking authentication\n  if (isLoadingAdmin) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Redirect to login if not authenticated\n  if (!adminUser) {\n    navigate(\"/admin/login\");\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"border-b bg-card\">\n        <div className=\"container mx-auto px-4 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Shield className=\"w-8 h-8 text-primary\" />\n            <div>\n              <h1 className=\"text-2xl font-bold\" data-testid=\"heading-admin-dashboard\">Admin Dashboard</h1>\n              <p className=\"text-sm text-muted-foreground\">Inspect360 Platform Administration</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => navigate(\"/admin/knowledge-base\")}\n              data-testid=\"button-knowledge-base\"\n            >\n              <BookOpen className=\"h-4 w-4 mr-2\" />\n              Knowledge Base\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={() => navigate(\"/admin/eco-admin\")}\n              data-testid=\"button-eco-admin\"\n            >\n              <Settings className=\"h-4 w-4 mr-2\" />\n              Eco Admin\n            </Button>\n            <span className=\"text-sm text-muted-foreground\">\n              {adminUser.firstName} {adminUser.lastName}\n            </span>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => navigate(\"/admin/team\")}\n              data-testid=\"button-admin-team\"\n            >\n              <Users className=\"w-4 h-4 mr-2\" />\n              Admin Team\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => logoutMutation.mutate()}\n              data-testid=\"button-admin-logout\"\n            >\n              <LogOut className=\"w-4 h-4 mr-2\" />\n              Logout\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <div className=\"container mx-auto px-4 py-8 space-y-6\">\n        {/* Search Bar */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Building2 className=\"w-5 h-5\" />\n              Registered Instances\n            </CardTitle>\n            <CardDescription>\n              Monitor and manage all registered organizations\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-3 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by organization name, owner name, or email...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-instances\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Instances Table */}\n        <Card>\n          <CardContent className=\"p-0\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Organization</TableHead>\n                  <TableHead>Owner</TableHead>\n                  <TableHead>Subscription</TableHead>\n                  <TableHead>Credits</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Created</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {isLoading ? (\n                  <TableRow>\n                    <TableCell colSpan={7} className=\"text-center py-8 text-muted-foreground\">\n                      Loading instances...\n                    </TableCell>\n                  </TableRow>\n                ) : filteredInstances.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={7} className=\"text-center py-8 text-muted-foreground\">\n                      No instances found\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  filteredInstances.map((instance) => (\n                    <TableRow key={instance.id} data-testid={`row-instance-${instance.id}`}>\n                      <TableCell>\n                        <div>\n                          <div className=\"font-medium\">{instance.name}</div>\n                          <div className=\"text-xs text-muted-foreground\">{instance.id}</div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div>\n                          <div className=\"font-medium\">\n                            {instance.owner?.firstName} {instance.owner?.lastName}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">{instance.owner?.email}</div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\" className=\"capitalize\">\n                          {instance.subscriptionLevel || \"free\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <CreditCard className=\"w-4 h-4 text-muted-foreground\" />\n                          {instance.creditsRemaining || 0}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {instance.isActive !== false ? (\n                          <Badge variant=\"default\" className=\"flex items-center gap-1 w-fit\">\n                            <CheckCircle className=\"w-3 h-3\" />\n                            Active\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"destructive\" className=\"flex items-center gap-1 w-fit\">\n                            <XCircle className=\"w-3 h-3\" />\n                            Disabled\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground\">\n                        {new Date(instance.createdAt).toLocaleDateString()}\n                      </TableCell>\n                      <TableCell className=\"text-right space-x-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleEditClick(instance)}\n                          data-testid={`button-edit-${instance.id}`}\n                        >\n                          Edit\n                        </Button>\n                        <Button\n                          variant={instance.isActive !== false ? \"destructive\" : \"default\"}\n                          size=\"sm\"\n                          onClick={() => toggleStatusMutation.mutate(instance.id)}\n                          disabled={toggleStatusMutation.isPending}\n                          data-testid={`button-toggle-${instance.id}`}\n                        >\n                          {instance.isActive !== false ? \"Disable\" : \"Enable\"}\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Edit Dialog */}\n      <Dialog open={editDialog} onOpenChange={setEditDialog}>\n        <DialogContent data-testid=\"dialog-edit-instance\">\n          <DialogHeader>\n            <DialogTitle>Edit Instance Settings</DialogTitle>\n            <DialogDescription>\n              Update subscription level, credits, and status for {selectedInstance?.name}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Subscription Level</Label>\n              <Select\n                value={editFormData.subscriptionLevel}\n                onValueChange={(value) =>\n                  setEditFormData({ ...editFormData, subscriptionLevel: value })\n                }\n              >\n                <SelectTrigger data-testid=\"select-subscription-level\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"free\">Free</SelectItem>\n                  <SelectItem value=\"starter\">Starter</SelectItem>\n                  <SelectItem value=\"professional\">Professional</SelectItem>\n                  <SelectItem value=\"enterprise\">Enterprise</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Credits Remaining</Label>\n              <Input\n                type=\"number\"\n                value={editFormData.creditsRemaining}\n                onChange={(e) =>\n                  setEditFormData({\n                    ...editFormData,\n                    creditsRemaining: parseInt(e.target.value) || 0,\n                  })\n                }\n                data-testid=\"input-credits\"\n              />\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <input\n                type=\"checkbox\"\n                id=\"isActive\"\n                checked={editFormData.isActive}\n                onChange={(e) =>\n                  setEditFormData({ ...editFormData, isActive: e.target.checked })\n                }\n                className=\"w-4 h-4\"\n                data-testid=\"checkbox-is-active\"\n              />\n              <Label htmlFor=\"isActive\">Instance Active</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setEditDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleEditSubmit}\n              disabled={updateInstanceMutation.isPending}\n              data-testid=\"button-save-instance\"\n            >\n              {updateInstanceMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":15321},"client/src/pages/AdminLogin.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport logoUrl from \"@assets/Inspect360 Logo_1761302629835.png\";\n\nexport default function AdminLogin() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/admin/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, password }),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Login failed\");\n      }\n\n      const admin = await response.json();\n      \n      toast({\n        title: \"Login Successful\",\n        description: `Welcome back, ${admin.firstName}!`,\n      });\n\n      navigate(\"/admin/dashboard\");\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Login Failed\",\n        description: error.message || \"Invalid credentials\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-sky-100 dark:from-gray-900 dark:to-gray-800 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <img src={logoUrl} alt=\"Inspect360\" className=\"h-16\" />\n          </div>\n          <CardTitle className=\"text-3xl font-bold\" data-testid=\"heading-admin-login\">Admin Portal</CardTitle>\n          <CardDescription>\n            Sign in to access the Inspect360 Admin Dashboard\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email Address</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"admin@inspect360.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-admin-email\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-admin-password\"\n              />\n            </div>\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={isLoading}\n              data-testid=\"button-admin-login\"\n            >\n              {isLoading ? \"Signing in...\" : \"Sign In\"}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":3591},"client/src/pages/InspectionReport.tsx":{"content":"import { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  ArrowLeft, \n  Printer, \n  Download, \n  Edit2, \n  Save, \n  X, \n  AlertTriangle, \n  FileText,\n  Calendar,\n  User,\n  MapPin,\n  Building,\n  Wrench,\n  GitCompare,\n  ExternalLink\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useState } from \"react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\n\ninterface TemplateField {\n  id: string;\n  key?: string;\n  label: string;\n  type: string;\n  description?: string;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[];\n  validation?: Record<string, any>;\n  dependsOn?: Record<string, any>;\n  includeCondition?: boolean;\n  includeCleanliness?: boolean;\n}\n\ninterface TemplateSection {\n  id: string;\n  title: string;\n  description?: string;\n  repeatable?: boolean;\n  fields: TemplateField[];\n}\n\ninterface Inspection {\n  id: string;\n  organizationId: string;\n  templateId?: string;\n  templateSnapshotJson?: { sections: TemplateSection[] };\n  propertyId?: string;\n  blockId?: string;\n  inspectorId: string;\n  type: string;\n  status: string;\n  scheduledDate?: string;\n  startedAt?: string;\n  completedDate?: string;\n  submittedAt?: string;\n  notes?: string;\n  property?: {\n    id: string;\n    name: string;\n    address: string;\n    propertyType?: string;\n  };\n  block?: {\n    id: string;\n    name: string;\n    address: string;\n  };\n  inspector?: {\n    id: string;\n    email: string;\n    firstName?: string;\n    lastName?: string;\n  };\n}\n\nexport default function InspectionReport() {\n  const { id } = useParams<{ id: string }>();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [editMode, setEditMode] = useState(false);\n  const [editedNotes, setEditedNotes] = useState<Record<string, string>>({});\n  const [maintenanceDialogOpen, setMaintenanceDialogOpen] = useState(false);\n  const [selectedEntryForMaintenance, setSelectedEntryForMaintenance] = useState<{\n    entryId: string;\n    fieldLabel: string;\n    sectionTitle: string;\n  } | null>(null);\n  const [maintenanceForm, setMaintenanceForm] = useState({\n    title: \"\",\n    description: \"\",\n    priority: \"medium\" as \"low\" | \"medium\" | \"high\" | \"urgent\",\n  });\n\n  // Fetch inspection data\n  const { data: inspection, isLoading: inspectionLoading } = useQuery<Inspection>({\n    queryKey: [\"/api/inspections\", id],\n  });\n\n  // Fetch all inspection entries\n  const { data: entries = [], isLoading: entriesLoading } = useQuery<any[]>({\n    queryKey: [`/api/inspections/${id}/entries`],\n    enabled: !!id,\n  });\n\n  // Fetch user role for edit permissions\n  const { data: currentUser } = useQuery<any>({\n    queryKey: [\"/api/auth/user\"],\n  });\n\n  // Fetch maintenance requests linked to this inspection\n  const { data: maintenanceRequests = [] } = useQuery<any[]>({\n    queryKey: [`/api/maintenance?inspectionId=${id}`],\n    enabled: !!id,\n  });\n\n  // Create maintenance request mutation\n  const createMaintenanceMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await fetch(`/api/maintenance`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create maintenance request\");\n      }\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/maintenance?inspectionId=${id}`] });\n      toast({\n        title: \"Success\",\n        description: \"Maintenance request created successfully\",\n      });\n      setMaintenanceDialogOpen(false);\n      setMaintenanceForm({ title: \"\", description: \"\", priority: \"medium\" });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create maintenance request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update inspection status mutation\n  const updateStatusMutation = useMutation({\n    mutationFn: async (newStatus: string) => {\n      return await apiRequest(\"PATCH\", `/api/inspections/${id}/status`, {\n        status: newStatus,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections\", id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inspections/my\"] });\n      toast({\n        title: \"Success\",\n        description: \"Inspection status updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update inspection status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Auto-create comparison report mutation\n  const autoCreateComparisonMutation = useMutation({\n    mutationFn: async (context: { inspectionId: string; fieldKey: string }) => {\n      if (!inspection?.propertyId) {\n        throw new Error(\"This inspection must be assigned to a property before creating a comparison report\");\n      }\n      \n      const response = await fetch(`/api/comparison-reports/auto`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ \n          propertyId: inspection.propertyId,\n          checkOutInspectionId: context.inspectionId,\n          fieldKey: context.fieldKey\n        }),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create comparison report\");\n      }\n      return await response.json();\n    },\n    onSuccess: (data: any) => {\n      const { report, created } = data;\n      if (created) {\n        toast({\n          title: \"Success\",\n          description: \"Comparison report created successfully using the latest check-in and check-out inspections\",\n        });\n      } else {\n        toast({\n          title: \"Success\",\n          description: \"Navigating to existing comparison report\",\n        });\n      }\n      // Navigate to the comparison report detail page\n      navigate(`/comparisons/${report.id}`);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create comparison report\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const templateStructure = inspection?.templateSnapshotJson as { sections: TemplateSection[] } | null;\n  const sections = templateStructure?.sections || [];\n\n  // Initialize edited notes from entries\n  useState(() => {\n    const initialNotes: Record<string, string> = {};\n    entries.forEach((entry: any) => {\n      const key = `${entry.sectionRef}-${entry.fieldKey}`;\n      if (entry.note) {\n        initialNotes[key] = entry.note;\n      }\n    });\n    setEditedNotes(initialNotes);\n  });\n\n  // Save edited notes mutation\n  const saveNotesMutation = useMutation({\n    mutationFn: async (updates: { entryId: string; note: string }[]) => {\n      const promises = updates.map(({ entryId, note }) =>\n        apiRequest(\"PATCH\", `/api/inspection-entries/${entryId}`, { note })\n      );\n      return Promise.all(promises);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/inspections/${id}/entries`] });\n      setEditMode(false);\n      toast({\n        title: \"Report updated\",\n        description: \"Changes saved successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to save changes\",\n      });\n    },\n  });\n\n  const handleSaveEdits = () => {\n    const updates: { entryId: string; note: string }[] = [];\n    entries.forEach((entry: any) => {\n      const key = `${entry.sectionRef}-${entry.fieldKey}`;\n      if (editedNotes[key] !== entry.note) {\n        updates.push({ entryId: entry.id, note: editedNotes[key] || \"\" });\n      }\n    });\n    if (updates.length > 0) {\n      saveNotesMutation.mutate(updates);\n    } else {\n      setEditMode(false);\n    }\n  };\n\n  const handleCancelEdit = () => {\n    setEditMode(false);\n    const initialNotes: Record<string, string> = {};\n    entries.forEach((entry: any) => {\n      const key = `${entry.sectionRef}-${entry.fieldKey}`;\n      if (entry.note) {\n        initialNotes[key] = entry.note;\n      }\n    });\n    setEditedNotes(initialNotes);\n  };\n\n  const handleOpenMaintenanceDialog = (entryId: string, fieldLabel: string, sectionTitle: string) => {\n    setSelectedEntryForMaintenance({ entryId, fieldLabel, sectionTitle });\n    setMaintenanceForm({\n      title: `${sectionTitle} - ${fieldLabel}`,\n      description: \"\",\n      priority: \"medium\",\n    });\n    setMaintenanceDialogOpen(true);\n  };\n\n  const handleSubmitMaintenance = () => {\n    if (!inspection || !selectedEntryForMaintenance) return;\n\n    createMaintenanceMutation.mutate({\n      title: maintenanceForm.title,\n      description: maintenanceForm.description,\n      priority: maintenanceForm.priority,\n      status: \"open\",\n      propertyId: inspection.propertyId,\n      organizationId: inspection.organizationId,\n      reportedBy: currentUser?.id,\n      source: \"inspection\",\n      inspectionId: inspection.id,\n      inspectionEntryId: selectedEntryForMaintenance.entryId,\n    });\n  };\n\n  const handlePrint = async () => {\n    if (!inspection) return;\n    \n    try {\n      toast({\n        title: \"Generating PDF\",\n        description: \"Please wait while we create your inspection report...\",\n      });\n\n      const response = await fetch(`/api/inspections/${inspection.id}/pdf`, {\n        method: \"GET\",\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to generate PDF\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `${inspection.property?.name?.replace(/[^a-zA-Z0-9]/g, \"_\") || \"inspection\"}_report.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"PDF Generated\",\n        description: \"Your inspection report has been downloaded.\",\n      });\n    } catch (error) {\n      console.error(\"Error generating PDF:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getEntryValue = (sectionId: string, fieldKey: string) => {\n    return entries.find(e => e.sectionRef === sectionId && e.fieldKey === fieldKey);\n  };\n\n  const renderFieldValue = (value: any, field: TemplateField) => {\n    if (value === null || value === undefined) {\n      return <span className=\"text-muted-foreground italic\">Not recorded</span>;\n    }\n\n    // Handle composite values (with condition/cleanliness)\n    let actualValue = value;\n    let condition = null;\n    let cleanliness = null;\n\n    if (typeof value === 'object' && !Array.isArray(value) && value.value !== undefined) {\n      actualValue = value.value;\n      condition = value.condition;\n      cleanliness = value.cleanliness;\n    }\n\n    let displayValue: React.ReactNode = null;\n\n    switch (field.type) {\n      case \"text\":\n      case \"textarea\":\n      case \"email\":\n      case \"phone\":\n        displayValue = actualValue || <span className=\"text-muted-foreground italic\">Not filled</span>;\n        break;\n      case \"number\":\n        displayValue = actualValue !== null && actualValue !== undefined ? actualValue.toString() : <span className=\"text-muted-foreground italic\">Not filled</span>;\n        break;\n      case \"boolean\":\n        displayValue = actualValue ? \"Yes\" : \"No\";\n        break;\n      case \"select\":\n      case \"radio\":\n        displayValue = actualValue || <span className=\"text-muted-foreground italic\">Not selected</span>;\n        break;\n      case \"checkbox\":\n        displayValue = Array.isArray(actualValue) ? actualValue.join(\", \") : <span className=\"text-muted-foreground italic\">None selected</span>;\n        break;\n      case \"date\":\n        displayValue = actualValue ? format(new Date(actualValue), \"MMM dd, yyyy\") : <span className=\"text-muted-foreground italic\">Not set</span>;\n        break;\n      case \"signature\":\n        displayValue = actualValue ? (\n          <img \n            src={actualValue} \n            alt=\"Signature\" \n            className=\"max-w-md h-32 object-contain border rounded bg-background p-2\"\n          />\n        ) : (\n          <span className=\"text-muted-foreground italic\">Not signed</span>\n        );\n        break;\n      default:\n        // Handle objects that don't match composite structure\n        if (typeof actualValue === 'object' && actualValue !== null) {\n          // If it's still an object, try to stringify it nicely or show a message\n          if (Array.isArray(actualValue)) {\n            displayValue = actualValue.length > 0 \n              ? actualValue.join(\", \") \n              : <span className=\"text-muted-foreground italic\">Empty list</span>;\n          } else {\n            // Try to extract meaningful data from the object with error handling\n            try {\n              // Check if object has a meaningful toString or specific properties to display\n              const jsonStr = JSON.stringify(actualValue, null, 2);\n              if (jsonStr && jsonStr !== '{}' && jsonStr !== 'null') {\n                displayValue = (\n                  <pre className=\"text-sm bg-muted p-2 rounded whitespace-pre-wrap break-words\">\n                    {jsonStr}\n                  </pre>\n                );\n              } else {\n                displayValue = <span className=\"text-muted-foreground italic\">No data</span>;\n              }\n            } catch (error) {\n              // Handle circular references or other JSON.stringify errors\n              console.warn('Failed to stringify field value:', error);\n              displayValue = <span className=\"text-muted-foreground italic\">Complex data structure</span>;\n            }\n          }\n        } else if (typeof actualValue === 'string' && actualValue.length > 0) {\n          displayValue = actualValue;\n        } else if (typeof actualValue === 'number') {\n          displayValue = actualValue.toString();\n        } else {\n          displayValue = <span className=\"text-muted-foreground italic\">Not filled</span>;\n        }\n    }\n\n    return (\n      <div className=\"space-y-2\">\n        <div className=\"text-base\">{displayValue}</div>\n        {(condition || cleanliness) && (\n          <div className=\"flex gap-2 flex-wrap\">\n            {condition && (\n              <Badge variant={condition === 'Excellent' ? 'default' : condition === 'Good' ? 'secondary' : 'destructive'}>\n                Condition: {condition}\n              </Badge>\n            )}\n            {cleanliness && (\n              <Badge variant={cleanliness === 'Clean' ? 'default' : cleanliness === 'Needs a Clean' ? 'secondary' : 'destructive'}>\n                Cleanliness: {cleanliness}\n              </Badge>\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  const canEdit = currentUser?.role === 'owner' || currentUser?.role === 'compliance';\n\n  if (inspectionLoading || entriesLoading) {\n    return (\n      <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\n        <Skeleton className=\"h-8 w-64\" />\n        <Skeleton className=\"h-40 w-full\" />\n        <Skeleton className=\"h-60 w-full\" />\n      </div>\n    );\n  }\n\n  if (!inspection) {\n    return (\n      <div className=\"p-6 max-w-6xl mx-auto\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <p className=\"text-center text-muted-foreground\">Inspection not found</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const inspectorName = inspection.inspector\n    ? `${inspection.inspector.firstName || ''} ${inspection.inspector.lastName || ''}`.trim() || inspection.inspector.email\n    : \"Unknown Inspector\";\n\n  const propertyName = inspection.property?.name || inspection.block?.name || \"Unknown Property\";\n  const propertyAddress = inspection.property?.address || inspection.block?.address || \"No address\";\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Print styles */}\n      <style>{`\n        @media print {\n          .no-print {\n            display: none !important;\n          }\n          .print-break-inside-avoid {\n            break-inside: avoid;\n            page-break-inside: avoid;\n          }\n          .print-only {\n            display: block !important;\n          }\n          .print-cover-page {\n            display: flex !important;\n            page-break-after: always;\n            min-height: 100%;\n            padding: 3rem 2rem;\n            margin: 0;\n            box-sizing: border-box;\n          }\n          body {\n            background: white !important;\n            print-color-adjust: exact;\n            -webkit-print-color-adjust: exact;\n          }\n          .bg-card {\n            background: white !important;\n            border: 1px solid #e5e7eb !important;\n          }\n          img {\n            max-width: 100%;\n            page-break-inside: avoid;\n          }\n          h1, h2, h3, h4, h5, h6 {\n            page-break-after: avoid;\n            page-break-inside: avoid;\n          }\n          .space-y-8 > * + * {\n            margin-top: 2rem !important;\n          }\n          @page {\n            margin: 0.75in;\n            size: letter;\n          }\n          @page :first {\n            margin: 0;\n          }\n          /* Ensure colors print correctly */\n          * {\n            print-color-adjust: exact;\n            -webkit-print-color-adjust: exact;\n          }\n        }\n        @media screen {\n          .print-only {\n            position: absolute !important;\n            left: -9999px !important;\n            top: -9999px !important;\n            width: 0 !important;\n            height: 0 !important;\n            overflow: hidden !important;\n            visibility: hidden !important;\n          }\n        }\n      `}</style>\n\n      {/* PDF Cover Page - Only visible when printing */}\n      <div className=\"print-only print-cover-page hidden flex-col items-center justify-center text-center p-12\" aria-hidden=\"true\">\n        <div className=\"space-y-12 max-w-2xl mx-auto\">\n          {/* Logo */}\n          <div className=\"flex justify-center mb-16\">\n            <img \n              src={new URL(\"@assets/Inspect360 Logo_1761302629835.png\", import.meta.url).href}\n              alt=\"Inspect360 Logo\" \n              className=\"h-24 w-auto\"\n            />\n          </div>\n\n          {/* Report Title */}\n          <div className=\"space-y-4 mb-12\">\n            <h1 className=\"text-5xl font-bold text-gray-900\" style={{ color: '#000' }}>\n              Inspection Report\n            </h1>\n            <div className=\"h-1 w-32 mx-auto\" style={{ backgroundColor: '#00D5CC' }}></div>\n          </div>\n\n          {/* Inspection Type */}\n          {inspection.type && (\n            <div className=\"text-2xl font-semibold text-gray-700 mb-12\" style={{ color: '#333' }}>\n              {inspection.type.replace(/_/g, ' ').toUpperCase()}\n            </div>\n          )}\n\n          {/* Property Information */}\n          <div className=\"space-y-6 pt-8 border-t-2\" style={{ borderColor: '#E5E7EB' }}>\n            <div className=\"space-y-2\">\n              <div className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Property</div>\n              <div className=\"text-2xl font-bold text-gray-900\" style={{ color: '#000' }}>\n                {propertyName || \"Property Not Specified\"}\n              </div>\n              {propertyAddress && propertyAddress !== \"No address\" && (\n                <div className=\"text-lg text-gray-600\" style={{ color: '#666' }}>\n                  {propertyAddress}\n                </div>\n              )}\n            </div>\n\n            {/* Inspector Information */}\n            <div className=\"space-y-2 pt-6\">\n              <div className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Inspector</div>\n              <div className=\"text-xl font-semibold text-gray-900\" style={{ color: '#000' }}>\n                {inspectorName || \"Inspector Not Assigned\"}\n              </div>\n              {inspection.inspector?.email && (\n                <div className=\"text-base text-gray-600\" style={{ color: '#666' }}>\n                  {inspection.inspector.email}\n                </div>\n              )}\n            </div>\n\n            {/* Inspection Date */}\n            <div className=\"space-y-2 pt-6\">\n              <div className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Inspection Date</div>\n              <div className=\"text-xl font-semibold text-gray-900\" style={{ color: '#000' }}>\n                {inspection.completedDate \n                  ? format(new Date(inspection.completedDate), \"MMMM dd, yyyy\")\n                  : inspection.scheduledDate \n                    ? format(new Date(inspection.scheduledDate), \"MMMM dd, yyyy\")\n                    : \"Not Scheduled\"}\n              </div>\n            </div>\n\n            {/* Status Badge */}\n            {inspection.status && (\n              <div className=\"pt-6\">\n                <div className=\"inline-block px-6 py-2 text-sm font-semibold uppercase tracking-wide border-2 rounded-lg\"\n                     style={{ \n                       borderColor: inspection.status === 'completed' ? '#00D5CC' : '#9CA3AF',\n                       color: inspection.status === 'completed' ? '#00D5CC' : '#9CA3AF'\n                     }}>\n                  {inspection.status.replace(/_/g, ' ')}\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Report ID */}\n          {inspection.id && (\n            <div className=\"pt-8 text-sm text-gray-500\">\n              Report ID: {inspection.id}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Header Actions - Hidden in print */}\n      <div className=\"no-print sticky top-0 z-10 bg-background border-b\">\n        <div className=\"max-w-6xl mx-auto p-4 flex items-center justify-between gap-4\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => navigate(\"/inspections\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Inspections\n          </Button>\n\n          <div className=\"flex gap-2\">\n            {canEdit && !editMode && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setEditMode(true)}\n                data-testid=\"button-edit-report\"\n              >\n                <Edit2 className=\"w-4 h-4 mr-2\" />\n                Edit Report\n              </Button>\n            )}\n            {editMode && (\n              <>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleCancelEdit}\n                  data-testid=\"button-cancel-edit\"\n                >\n                  <X className=\"w-4 h-4 mr-2\" />\n                  Cancel\n                </Button>\n                <Button\n                  size=\"sm\"\n                  onClick={handleSaveEdits}\n                  disabled={saveNotesMutation.isPending}\n                  data-testid=\"button-save-edit\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  {saveNotesMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </>\n            )}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handlePrint}\n              data-testid=\"button-print-report\"\n            >\n              <Printer className=\"w-4 h-4 mr-2\" />\n              Print\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Report Content */}\n      <div className=\"max-w-6xl mx-auto p-6 space-y-8\">\n        {/* Report Header */}\n        <Card className=\"print-break-inside-avoid\">\n          <CardHeader className=\"space-y-4\">\n            <div className=\"flex items-start justify-between gap-4\">\n              <div className=\"space-y-2\">\n                <CardTitle className=\"text-3xl\">Inspection Report</CardTitle>\n                <CardDescription className=\"text-lg\">\n                  {propertyName}\n                </CardDescription>\n              </div>\n              {canEdit ? (\n                <div className=\"flex flex-col gap-1 min-w-[180px]\">\n                  <Label className=\"text-xs text-muted-foreground\">Status</Label>\n                  <Select\n                    value={inspection.status}\n                    onValueChange={(value) => updateStatusMutation.mutate(value)}\n                    disabled={updateStatusMutation.isPending}\n                  >\n                    <SelectTrigger data-testid=\"select-inspection-status\" className=\"h-8\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                      <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                      <SelectItem value=\"completed\">Completed</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              ) : (\n                inspection.status && (\n                  <Badge variant={inspection.status === 'completed' ? 'default' : 'secondary'} className=\"text-sm\">\n                    {inspection.status.replace(/_/g, ' ').toUpperCase()}\n                  </Badge>\n                )\n              )}\n            </div>\n\n            {/* Inspection Metadata Grid */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t\">\n              <div className=\"flex items-start gap-3\">\n                <MapPin className=\"w-5 h-5 text-muted-foreground mt-0.5\" />\n                <div>\n                  <div className=\"text-sm font-medium\">Property Address</div>\n                  <div className=\"text-sm text-muted-foreground\">{propertyAddress}</div>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3\">\n                <FileText className=\"w-5 h-5 text-muted-foreground mt-0.5\" />\n                <div>\n                  <div className=\"text-sm font-medium\">Inspection Type</div>\n                  <div className=\"text-sm text-muted-foreground capitalize\">\n                    {inspection.type ? inspection.type.replace(/_/g, ' ') : 'Not specified'}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3\">\n                <User className=\"w-5 h-5 text-muted-foreground mt-0.5\" />\n                <div>\n                  <div className=\"text-sm font-medium\">Inspector</div>\n                  <div className=\"text-sm text-muted-foreground\">{inspectorName}</div>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3\">\n                <Calendar className=\"w-5 h-5 text-muted-foreground mt-0.5\" />\n                <div>\n                  <div className=\"text-sm font-medium\">Inspection Date</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {inspection.completedDate \n                      ? format(new Date(inspection.completedDate), \"MMMM dd, yyyy\")\n                      : inspection.scheduledDate \n                        ? format(new Date(inspection.scheduledDate), \"MMMM dd, yyyy\")\n                        : \"Not scheduled\"}\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {inspection.notes && (\n              <div className=\"pt-4 border-t\">\n                <div className=\"text-sm font-medium mb-2\">General Notes</div>\n                <div className=\"text-sm text-muted-foreground whitespace-pre-wrap\">{inspection.notes}</div>\n              </div>\n            )}\n          </CardHeader>\n        </Card>\n\n        {/* Inspection Points */}\n        {sections.length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6 text-center text-muted-foreground\">\n              No inspection template structure available\n            </CardContent>\n          </Card>\n        ) : (\n          sections.map((section) => {\n            const sectionEntries = entries.filter(e => e.sectionRef === section.id);\n            \n            return (\n              <Card key={section.id} className=\"print-break-inside-avoid\" data-testid={`section-${section.id}`}>\n                <CardHeader>\n                  <CardTitle className=\"text-2xl\">{section.title}</CardTitle>\n                  {section.description && (\n                    <CardDescription>{section.description}</CardDescription>\n                  )}\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {section.fields.map((field) => {\n                    const entry = getEntryValue(section.id, field.id || field.key || field.label);\n                    const entryKey = `${section.id}-${field.id || field.key || field.label}`;\n                    \n                    if (!entry && !editMode) return null; // Hide unfilled fields in view mode\n\n                    return (\n                      <div \n                        key={field.id || field.key || field.label}\n                        className=\"border-b pb-6 last:border-b-0 last:pb-0\"\n                        data-testid={`field-${field.id || field.key}`}\n                      >\n                        <div className=\"space-y-3\">\n                          {/* Field Label and Description */}\n                          <div>\n                            <h4 className=\"text-base font-semibold\">\n                              {field.label}\n                              {field.required && <span className=\"text-destructive ml-1\">*</span>}\n                            </h4>\n                            {field.description && (\n                              <p className=\"text-sm text-muted-foreground mt-1\">{field.description}</p>\n                            )}\n                          </div>\n\n                          {/* Field Value */}\n                          <div className=\"pl-4 border-l-2 border-primary/20\">\n                            {renderFieldValue(entry?.valueJson, field)}\n                          </div>\n\n                          {/* Photos */}\n                          {entry?.photos && entry.photos.length > 0 && (\n                            <div className=\"space-y-2\">\n                              <div className=\"text-sm font-medium\">Photos</div>\n                              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                                {entry.photos.map((photo: string, idx: number) => (\n                                  <img\n                                    key={idx}\n                                    src={photo}\n                                    alt={`${field.label} - Photo ${idx + 1}`}\n                                    className=\"w-full h-40 object-cover rounded-lg border\"\n                                    data-testid={`photo-${field.id || field.key}-${idx}`}\n                                  />\n                                ))}\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Notes */}\n                          <div className=\"space-y-2\">\n                            <div className=\"text-sm font-medium\">Notes</div>\n                            {editMode ? (\n                              <Textarea\n                                value={editedNotes[entryKey] || \"\"}\n                                onChange={(e) => setEditedNotes({ ...editedNotes, [entryKey]: e.target.value })}\n                                placeholder=\"Add inspection notes...\"\n                                className=\"min-h-[80px]\"\n                                data-testid={`textarea-note-${field.id || field.key}`}\n                              />\n                            ) : entry?.note ? (\n                              <div className=\"text-sm text-muted-foreground whitespace-pre-wrap bg-muted/50 p-3 rounded-lg\">\n                                {entry.note}\n                              </div>\n                            ) : (\n                              <p className=\"text-sm text-muted-foreground italic\">No notes</p>\n                            )}\n                          </div>\n\n                          {/* Action Buttons - Hidden in print and edit mode */}\n                          {!editMode && entry && (\n                            <div className=\"flex gap-2 flex-wrap no-print\">\n                              {/* Raise Maintenance Request - only if property exists */}\n                              {inspection.propertyId && (\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => handleOpenMaintenanceDialog(entry.id, field.label, section.title)}\n                                  data-testid={`button-maintenance-${field.id || field.key}`}\n                                >\n                                  <Wrench className=\"w-4 h-4 mr-2\" />\n                                  Raise Maintenance Request\n                                </Button>\n                              )}\n                              {/* Add to Comparison - only on check-out inspections with photos and property */}\n                              {inspection.type === 'check_out' && entry.photos && entry.photos.length > 0 && inspection.propertyId && (\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => autoCreateComparisonMutation.mutate({ \n                                    inspectionId: id!, \n                                    fieldKey: field.id || field.key \n                                  })}\n                                  disabled={autoCreateComparisonMutation.isPending}\n                                  data-testid={`button-comparison-${field.id || field.key}`}\n                                >\n                                  <GitCompare className=\"w-4 h-4 mr-2\" />\n                                  {autoCreateComparisonMutation.isPending ? \"Creating...\" : \"Add to Comparison\"}\n                                </Button>\n                              )}\n                            </div>\n                          )}\n\n                          {/* Maintenance Flag Indicator */}\n                          {entry?.maintenanceFlag && (\n                            <div className=\"flex items-center gap-2 text-sm text-amber-600 dark:text-amber-500\">\n                              <AlertTriangle className=\"w-4 h-4\" />\n                              <span>Flagged for maintenance</span>\n                            </div>\n                          )}\n\n                          {/* Linked Maintenance Requests */}\n                          {entry && (() => {\n                            const linkedRequests = maintenanceRequests.filter(\n                              (req: any) => req.inspectionEntryId === entry.id\n                            );\n                            if (linkedRequests.length === 0) return null;\n\n                            return (\n                              <div className=\"space-y-2 mt-4 border-t pt-4\">\n                                <div className=\"text-sm font-medium text-muted-foreground\">\n                                  Related Maintenance Requests ({linkedRequests.length})\n                                </div>\n                                {linkedRequests.map((request: any) => (\n                                  <Card key={request.id} className=\"bg-muted/30\">\n                                    <CardContent className=\"p-3\">\n                                      <div className=\"flex items-start justify-between gap-2\">\n                                        <div className=\"flex-1\">\n                                          <div className=\"font-medium text-sm\">{request.title}</div>\n                                          {request.description && (\n                                            <div className=\"text-xs text-muted-foreground mt-1\">\n                                              {request.description}\n                                            </div>\n                                          )}\n                                          <div className=\"flex items-center gap-2 mt-2\">\n                                            <Badge variant={\n                                              request.status === 'open' ? 'default' :\n                                              request.status === 'in_progress' ? 'secondary' :\n                                              request.status === 'resolved' ? 'outline' : 'default'\n                                            }>\n                                              {request.status}\n                                            </Badge>\n                                            <Badge variant=\"outline\" className=\"text-xs\">\n                                              {request.priority}\n                                            </Badge>\n                                          </div>\n                                        </div>\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => navigate(`/maintenance`)}\n                                          data-testid={`link-maintenance-${request.id}`}\n                                        >\n                                          <ExternalLink className=\"w-4 h-4\" />\n                                        </Button>\n                                      </div>\n                                    </CardContent>\n                                  </Card>\n                                ))}\n                              </div>\n                            );\n                          })()}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </CardContent>\n              </Card>\n            );\n          })\n        )}\n      </div>\n\n      {/* Maintenance Request Dialog */}\n      <Dialog open={maintenanceDialogOpen} onOpenChange={setMaintenanceDialogOpen}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle>Raise Maintenance Request</DialogTitle>\n            <DialogDescription>\n              Create a maintenance request for this inspection item\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"maintenance-title\">Title</Label>\n              <Input\n                id=\"maintenance-title\"\n                value={maintenanceForm.title}\n                onChange={(e) => setMaintenanceForm({ ...maintenanceForm, title: e.target.value })}\n                placeholder=\"Brief description of the issue\"\n                data-testid=\"input-maintenance-title\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"maintenance-description\">Description</Label>\n              <Textarea\n                id=\"maintenance-description\"\n                value={maintenanceForm.description}\n                onChange={(e) => setMaintenanceForm({ ...maintenanceForm, description: e.target.value })}\n                placeholder=\"Detailed description of the maintenance issue...\"\n                className=\"min-h-[100px]\"\n                data-testid=\"textarea-maintenance-description\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"maintenance-priority\">Priority</Label>\n              <Select\n                value={maintenanceForm.priority}\n                onValueChange={(value: any) => setMaintenanceForm({ ...maintenanceForm, priority: value })}\n              >\n                <SelectTrigger id=\"maintenance-priority\" data-testid=\"select-maintenance-priority\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Low</SelectItem>\n                  <SelectItem value=\"medium\">Medium</SelectItem>\n                  <SelectItem value=\"high\">High</SelectItem>\n                  <SelectItem value=\"urgent\">Urgent</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setMaintenanceDialogOpen(false)}\n              data-testid=\"button-cancel-maintenance\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmitMaintenance}\n              disabled={!maintenanceForm.title || createMaintenanceMutation.isPending}\n              data-testid=\"button-submit-maintenance\"\n            >\n              {createMaintenanceMutation.isPending ? \"Creating...\" : \"Create Request\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":42225},"server/resend.ts":{"content":"import { Resend } from 'resend';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  // Check for environment variables first (for non-Replit deployments)\n  if (process.env.RESEND_API_KEY && process.env.RESEND_FROM_EMAIL) {\n    return {\n      apiKey: process.env.RESEND_API_KEY,\n      fromEmail: process.env.RESEND_FROM_EMAIL\n    };\n  }\n\n  // Fallback to Replit connector (if available)\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken || !hostname) {\n    throw new Error('Resend credentials not configured. Set RESEND_API_KEY and RESEND_FROM_EMAIL environment variables.');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || (!connectionSettings.settings.api_key)) {\n    throw new Error('Resend not connected');\n  }\n  return {apiKey: connectionSettings.settings.api_key, fromEmail: connectionSettings.settings.from_email};\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\n// Always call this function again to get a fresh client.\nexport async function getUncachableResendClient() {\n  const credentials = await getCredentials();\n  return {\n    client: new Resend(credentials.apiKey),\n    fromEmail: credentials.fromEmail\n  };\n}\n\nexport async function sendPasswordResetEmail(\n  recipientEmail: string,\n  recipientName: string,\n  resetToken: string\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const subject = 'Password Reset Request - Inspect360';\n    \n    const html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${subject}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;\">\n  <div style=\"background-color: #ffffff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n    <!-- Header with Inspect360 branding -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <div style=\"width: 64px; height: 64px; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;\">\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\n          <path d=\"M12 17v-6\"></path>\n          <path d=\"M12 11h.01\"></path>\n          <circle cx=\"12\" cy=\"12\" r=\"10\"></circle>\n        </svg>\n      </div>\n      <h1 style=\"margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;\">Password Reset Request</h1>\n    </div>\n\n    <!-- Main content -->\n    <div style=\"margin-bottom: 24px;\">\n      <p style=\"margin: 0 0 16px 0; font-size: 16px;\">Hi ${recipientName},</p>\n      <p style=\"margin: 0 0 24px 0; font-size: 16px;\">\n        We received a request to reset your password for your Inspect360 account. Use the code below to reset your password.\n      </p>\n\n      <!-- Reset Code Card -->\n      <div style=\"background-color: #f8f9fa; border: 2px dashed #00D5CC; padding: 24px; border-radius: 8px; margin-bottom: 24px; text-align: center;\">\n        <p style=\"margin: 0 0 12px 0; font-size: 14px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">Your Reset Code</p>\n        <div style=\"font-size: 32px; font-weight: 700; color: #00D5CC; letter-spacing: 4px; font-family: 'Courier New', monospace;\">\n          ${resetToken}\n        </div>\n        <p style=\"margin: 16px 0 0 0; font-size: 13px; color: #888;\">\n          This code will expire in 1 hour\n        </p>\n      </div>\n\n      <p style=\"margin: 0 0 16px 0; font-size: 15px; color: #555;\">\n        To reset your password:\n      </p>\n      <ol style=\"margin: 0 0 24px 0; padding-left: 24px; font-size: 15px; color: #555;\">\n        <li style=\"margin-bottom: 8px;\">Return to the password reset page</li>\n        <li style=\"margin-bottom: 8px;\">Enter this 6-digit code</li>\n        <li style=\"margin-bottom: 8px;\">Create a new password</li>\n      </ol>\n\n      <div style=\"background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 16px; border-radius: 4px; margin-top: 24px;\">\n        <p style=\"margin: 0; font-size: 14px; color: #856404;\">\n          <strong>Didn't request this?</strong><br>\n          If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.\n        </p>\n      </div>\n    </div>\n\n    <!-- Footer -->\n    <div style=\"border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 32px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #888; text-align: center;\">\n        This email was sent from <strong style=\"color: #00D5CC;\">Inspect360</strong>  Your AI-Powered Building Inspection Platform\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 12px; color: #aaa; text-align: center;\">\n         ${new Date().getFullYear()} Inspect360. All rights reserved.\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n    `;\n\n    const response = await client.emails.send({\n      from: fromEmail,\n      to: recipientEmail,\n      subject,\n      html,\n    });\n\n    console.log('Password reset email sent:', response);\n    return response;\n  } catch (error) {\n    console.error('Failed to send password reset email:', error);\n    throw error;\n  }\n}\n\nexport async function sendInspectionCompleteEmail(\n  recipientEmail: string,\n  recipientName: string,\n  inspectionDetails: {\n    type: string;\n    propertyName?: string;\n    blockName?: string;\n    inspectorName: string;\n    completedDate: Date;\n    inspectionId: string;\n  }\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const subject = `Inspection Complete: ${inspectionDetails.type}`;\n    const location = inspectionDetails.propertyName || inspectionDetails.blockName || 'Unknown Location';\n    \n    const html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${subject}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;\">\n  <div style=\"background-color: #ffffff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n    <!-- Header with Inspect360 branding -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <div style=\"width: 64px; height: 64px; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;\">\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\n          <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n          <path d=\"m21 21-4.35-4.35\"></path>\n          <path d=\"M9 11h4\"></path>\n          <path d=\"M11 9v4\"></path>\n        </svg>\n      </div>\n      <h1 style=\"margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;\">Inspection Complete</h1>\n    </div>\n\n    <!-- Main content -->\n    <div style=\"margin-bottom: 24px;\">\n      <p style=\"margin: 0 0 16px 0; font-size: 16px;\">Hi ${recipientName},</p>\n      <p style=\"margin: 0 0 24px 0; font-size: 16px;\">\n        An inspection has been completed and is ready for your review.\n      </p>\n\n      <!-- Inspection details card -->\n      <div style=\"background-color: #f8f9fa; border-left: 4px solid #00D5CC; padding: 20px; border-radius: 4px; margin-bottom: 24px;\">\n        <h2 style=\"margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1a1a1a;\">Inspection Details</h2>\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Type:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${inspectionDetails.type}</span>\n        </div>\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Location:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${location}</span>\n        </div>\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Inspector:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${inspectionDetails.inspectorName}</span>\n        </div>\n        \n        <div>\n          <span style=\"font-weight: 600; color: #555;\">Completed:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${inspectionDetails.completedDate.toLocaleString('en-US', { \n            dateStyle: 'medium', \n            timeStyle: 'short' \n          })}</span>\n        </div>\n      </div>\n\n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${process.env.BASE_URL ? `${process.env.BASE_URL}/inspections/${inspectionDetails.inspectionId}` : '#'}\" \n           style=\"display: inline-block; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); color: white; text-decoration: none; padding: 14px 32px; border-radius: 6px; font-weight: 600; font-size: 16px;\">\n          View Inspection Report\n        </a>\n      </div>\n\n      <p style=\"margin: 24px 0 0 0; font-size: 14px; color: #666;\">\n        You can review the full inspection report, including photos and notes, by clicking the button above.\n      </p>\n    </div>\n\n    <!-- Footer -->\n    <div style=\"border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 32px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #888; text-align: center;\">\n        This email was sent from <strong style=\"color: #00D5CC;\">Inspect360</strong>  Your AI-Powered Building Inspection Platform\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 12px; color: #aaa; text-align: center;\">\n         ${new Date().getFullYear()} Inspect360. All rights reserved.\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n    `;\n\n    const response = await client.emails.send({\n      from: fromEmail,\n      to: recipientEmail,\n      subject,\n      html,\n    });\n\n    console.log('Inspection complete email sent:', response);\n    return response;\n  } catch (error) {\n    console.error('Failed to send inspection complete email:', error);\n    throw error;\n  }\n}\n\nexport async function sendTeamWorkOrderNotification(\n  teamEmail: string,\n  teamName: string,\n  workOrderDetails: {\n    id: string;\n    maintenanceTitle: string;\n    maintenanceDescription?: string;\n    priority: string;\n    propertyName?: string;\n    slaDue?: Date | null;\n    costEstimate?: number | null;\n  }\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const subject = `New Work Order Assigned: ${workOrderDetails.maintenanceTitle}`;\n    \n    const priorityColors: Record<string, string> = {\n      low: '#6b7280',\n      medium: '#3b82f6',\n      high: '#f97316',\n      urgent: '#ef4444',\n    };\n    \n    const priorityColor = priorityColors[workOrderDetails.priority] || '#3b82f6';\n    \n    const html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${subject}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;\">\n  <div style=\"background-color: #ffffff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n    <!-- Header with Inspect360 branding -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <div style=\"width: 64px; height: 64px; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;\">\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\n          <path d=\"M9 11l3 3L22 4\"></path>\n          <path d=\"M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11\"></path>\n        </svg>\n      </div>\n      <h1 style=\"margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;\">New Work Order Assigned</h1>\n    </div>\n\n    <!-- Main content -->\n    <div style=\"margin-bottom: 24px;\">\n      <p style=\"margin: 0 0 16px 0; font-size: 16px;\">Hi ${teamName} Team,</p>\n      <p style=\"margin: 0 0 24px 0; font-size: 16px;\">\n        A new work order has been assigned to your team and requires attention.\n      </p>\n\n      <!-- Work Order details card -->\n      <div style=\"background-color: #f8f9fa; border-left: 4px solid #00D5CC; padding: 20px; border-radius: 4px; margin-bottom: 24px;\">\n        <h2 style=\"margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1a1a1a;\">Work Order Details</h2>\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Title:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.maintenanceTitle}</span>\n        </div>\n        \n        ${workOrderDetails.maintenanceDescription ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Description:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.maintenanceDescription}</span>\n        </div>\n        ` : ''}\n        \n        ${workOrderDetails.propertyName ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Property:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.propertyName}</span>\n        </div>\n        ` : ''}\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Priority:</span>\n          <span style=\"display: inline-block; background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 8px; text-transform: uppercase;\">\n            ${workOrderDetails.priority}\n          </span>\n        </div>\n        \n        ${workOrderDetails.slaDue ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">SLA Due:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${new Date(workOrderDetails.slaDue).toLocaleString('en-US', { \n            dateStyle: 'medium', \n            timeStyle: 'short' \n          })}</span>\n        </div>\n        ` : ''}\n        \n        ${workOrderDetails.costEstimate ? `\n        <div>\n          <span style=\"font-weight: 600; color: #555;\">Estimated Cost:</span>\n          <span style=\"color: #333; margin-left: 8px;\">$${(workOrderDetails.costEstimate / 100).toFixed(2)}</span>\n        </div>\n        ` : ''}\n      </div>\n\n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${process.env.BASE_URL ? `${process.env.BASE_URL}/maintenance?tab=work-orders` : '#'}\" \n           style=\"display: inline-block; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); color: white; text-decoration: none; padding: 14px 32px; border-radius: 6px; font-weight: 600; font-size: 16px;\">\n          View Work Orders\n        </a>\n      </div>\n\n      <p style=\"margin: 24px 0 0 0; font-size: 14px; color: #666;\">\n        Please review the work order details and assign team members as needed.\n      </p>\n    </div>\n\n    <!-- Footer -->\n    <div style=\"border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 32px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #888; text-align: center;\">\n        This email was sent from <strong style=\"color: #00D5CC;\">Inspect360</strong>  Your AI-Powered Building Inspection Platform\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 12px; color: #aaa; text-align: center;\">\n         ${new Date().getFullYear()} Inspect360. All rights reserved.\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n    `;\n\n    const response = await client.emails.send({\n      from: fromEmail,\n      to: teamEmail,\n      subject,\n      html,\n    });\n\n    console.log('Team work order notification sent:', response);\n    return response;\n  } catch (error) {\n    console.error('Failed to send team work order notification:', error);\n    throw error;\n  }\n}\n\nexport async function sendContractorWorkOrderNotification(\n  contractorEmail: string,\n  contractorName: string,\n  workOrderDetails: {\n    id: string;\n    maintenanceTitle: string;\n    maintenanceDescription?: string;\n    priority: string;\n    propertyName?: string;\n    slaDue?: Date | null;\n    costEstimate?: number | null;\n  }\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const subject = `New Work Order Assigned: ${workOrderDetails.maintenanceTitle}`;\n    \n    const priorityColors: Record<string, string> = {\n      low: '#6b7280',\n      medium: '#3b82f6',\n      high: '#f97316',\n      urgent: '#ef4444',\n    };\n    \n    const priorityColor = priorityColors[workOrderDetails.priority] || '#3b82f6';\n    \n    const html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${subject}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;\">\n  <div style=\"background-color: #ffffff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n    <!-- Header with Inspect360 branding -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <div style=\"width: 64px; height: 64px; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;\">\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\n          <path d=\"M9 11l3 3L22 4\"></path>\n          <path d=\"M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11\"></path>\n        </svg>\n      </div>\n      <h1 style=\"margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;\">New Work Order Assigned</h1>\n    </div>\n\n    <!-- Main content -->\n    <div style=\"margin-bottom: 24px;\">\n      <p style=\"margin: 0 0 16px 0; font-size: 16px;\">Hi ${contractorName},</p>\n      <p style=\"margin: 0 0 24px 0; font-size: 16px;\">\n        A new work order has been assigned to you and requires your attention.\n      </p>\n\n      <!-- Work Order details card -->\n      <div style=\"background-color: #f8f9fa; border-left: 4px solid #00D5CC; padding: 20px; border-radius: 4px; margin-bottom: 24px;\">\n        <h2 style=\"margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1a1a1a;\">Work Order Details</h2>\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Title:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.maintenanceTitle}</span>\n        </div>\n        \n        ${workOrderDetails.maintenanceDescription ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Description:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.maintenanceDescription}</span>\n        </div>\n        ` : ''}\n        \n        ${workOrderDetails.propertyName ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Property:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${workOrderDetails.propertyName}</span>\n        </div>\n        ` : ''}\n        \n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">Priority:</span>\n          <span style=\"display: inline-block; background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 8px; text-transform: uppercase;\">\n            ${workOrderDetails.priority}\n          </span>\n        </div>\n        \n        ${workOrderDetails.slaDue ? `\n        <div style=\"margin-bottom: 12px;\">\n          <span style=\"font-weight: 600; color: #555;\">SLA Due:</span>\n          <span style=\"color: #333; margin-left: 8px;\">${new Date(workOrderDetails.slaDue).toLocaleString('en-US', { \n            dateStyle: 'medium', \n            timeStyle: 'short' \n          })}</span>\n        </div>\n        ` : ''}\n        \n        ${workOrderDetails.costEstimate ? `\n        <div>\n          <span style=\"font-weight: 600; color: #555;\">Estimated Cost:</span>\n          <span style=\"color: #333; margin-left: 8px;\">$${(workOrderDetails.costEstimate / 100).toFixed(2)}</span>\n        </div>\n        ` : ''}\n      </div>\n\n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${process.env.BASE_URL ? `${process.env.BASE_URL}/maintenance?tab=work-orders` : '#'}\" \n           style=\"display: inline-block; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); color: white; text-decoration: none; padding: 14px 32px; border-radius: 6px; font-weight: 600; font-size: 16px;\">\n          View Work Order\n        </a>\n      </div>\n\n      <p style=\"margin: 24px 0 0 0; font-size: 14px; color: #666;\">\n        Please log in to the platform to view full details and update the work order status.\n      </p>\n    </div>\n\n    <!-- Footer -->\n    <div style=\"border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 32px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #888; text-align: center;\">\n        This email was sent from <strong style=\"color: #00D5CC;\">Inspect360</strong>  Your AI-Powered Building Inspection Platform\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 12px; color: #aaa; text-align: center;\">\n         ${new Date().getFullYear()} Inspect360. All rights reserved.\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n    `;\n\n    const response = await client.emails.send({\n      from: fromEmail,\n      to: contractorEmail,\n      subject,\n      html,\n    });\n\n    console.log('Contractor work order notification sent:', response);\n    return response;\n  } catch (error) {\n    console.error('Failed to send contractor work order notification:', error);\n    throw error;\n  }\n}\n\nexport async function broadcastMessageToTenants(\n  recipients: { email: string; firstName?: string; lastName?: string }[],\n  templateData: {\n    subject: string;\n    body: string;\n  },\n  variables: {\n    blockName?: string;\n    organizationName?: string;\n    [key: string]: any;\n  }\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const results: any[] = [];\n    const errors: any[] = [];\n\n    // Send email to each recipient\n    for (const recipient of recipients) {\n      try {\n        // Replace variables in subject and body\n        const recipientName = recipient.firstName \n          ? `${recipient.firstName}${recipient.lastName ? ' ' + recipient.lastName : ''}` \n          : 'Tenant';\n        \n        // Create replacements object with recipient-specific and general variables\n        const replacements: Record<string, string> = {\n          tenant_name: recipientName,\n          tenant_first_name: recipient.firstName || 'Tenant',\n          tenant_last_name: recipient.lastName || '',\n          block_name: variables.blockName || '',\n          organization_name: variables.organizationName || '',\n          ...Object.keys(variables).reduce((acc, key) => {\n            if (key !== 'blockName' && key !== 'organizationName') {\n              acc[key] = String(variables[key]);\n            }\n            return acc;\n          }, {} as Record<string, string>),\n        };\n\n        // Replace variables in subject and body\n        let personalizedSubject = templateData.subject;\n        let personalizedBody = templateData.body;\n\n        Object.keys(replacements).forEach(key => {\n          const regex = new RegExp(`\\\\{${key}\\\\}`, 'g');\n          personalizedSubject = personalizedSubject.replace(regex, replacements[key]);\n          personalizedBody = personalizedBody.replace(regex, replacements[key]);\n        });\n\n        const html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${personalizedSubject}</title>\n</head>\n<body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;\">\n  <div style=\"background-color: #ffffff; border-radius: 8px; padding: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n    <!-- Header with Inspect360 branding -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <div style=\"width: 64px; height: 64px; background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;\">\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\n          <circle cx=\"11\" cy=\"11\" r=\"8\"></circle>\n          <path d=\"m21 21-4.35-4.35\"></path>\n        </svg>\n      </div>\n      <h1 style=\"margin: 0; font-size: 24px; font-weight: 700; color: #1a1a1a;\">${personalizedSubject}</h1>\n    </div>\n\n    <!-- Main content -->\n    <div style=\"margin-bottom: 24px;\">\n      <div style=\"font-size: 16px; white-space: pre-wrap;\">\n        ${personalizedBody}\n      </div>\n    </div>\n\n    <!-- Footer -->\n    <div style=\"border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 32px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #888; text-align: center;\">\n        This email was sent from <strong style=\"color: #00D5CC;\">Inspect360</strong>  Your AI-Powered Building Inspection Platform\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 12px; color: #aaa; text-align: center;\">\n         ${new Date().getFullYear()} Inspect360. All rights reserved.\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n        `;\n\n        const response = await client.emails.send({\n          from: fromEmail,\n          to: recipient.email,\n          subject: personalizedSubject,\n          html,\n        });\n\n        results.push({\n          email: recipient.email,\n          success: true,\n          messageId: response.data?.id || 'sent',\n        });\n\n        console.log(`Email sent to ${recipient.email}:`, response);\n      } catch (emailError) {\n        console.error(`Failed to send email to ${recipient.email}:`, emailError);\n        errors.push({\n          email: recipient.email,\n          success: false,\n          error: emailError instanceof Error ? emailError.message : 'Unknown error',\n        });\n      }\n    }\n\n    return {\n      totalSent: results.length,\n      totalFailed: errors.length,\n      results,\n      errors,\n    };\n  } catch (error) {\n    console.error('Failed to broadcast messages:', error);\n    throw error;\n  }\n}\n","size_bytes":27571},"client/src/components/ComplianceCalendar.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { AlertCircle, CheckCircle2, Clock, Circle } from \"lucide-react\";\n\ninterface MonthData {\n  month: string;\n  status: 'completed' | 'overdue' | 'due' | 'scheduled' | 'not_scheduled';\n  count: number;\n  completed?: number;\n  overdue?: number;\n}\n\ninterface TemplateCompliance {\n  templateId: string;\n  templateName: string;\n  monthData: MonthData[];\n  complianceRate: number;\n  totalScheduled: number;\n  totalCompleted: number;\n}\n\ninterface ComplianceReport {\n  year: number;\n  months: string[];\n  templates: TemplateCompliance[];\n  overallCompliance: number;\n  totalScheduled: number;\n  totalCompleted: number;\n}\n\ninterface ComplianceCalendarProps {\n  report: ComplianceReport | null;\n  isLoading: boolean;\n  entityType: 'property' | 'block';\n}\n\nfunction StatusCell({ data }: { data: MonthData }) {\n  const getStatusIcon = () => {\n    switch (data.status) {\n      case 'completed':\n        return <CheckCircle2 className=\"h-4 w-4 text-green-600\" data-testid={`icon-completed-${data.month}`} />;\n      case 'overdue':\n        return <AlertCircle className=\"h-4 w-4 text-destructive\" data-testid={`icon-overdue-${data.month}`} />;\n      case 'due':\n        return <Clock className=\"h-4 w-4 text-yellow-600\" data-testid={`icon-due-${data.month}`} />;\n      case 'scheduled':\n        return <Circle className=\"h-4 w-4 text-blue-600\" data-testid={`icon-scheduled-${data.month}`} />;\n      case 'not_scheduled':\n      default:\n        return <Circle className=\"h-4 w-4 text-muted-foreground/30\" data-testid={`icon-not-scheduled-${data.month}`} />;\n    }\n  };\n\n  const getStatusColor = () => {\n    switch (data.status) {\n      case 'completed':\n        return 'bg-green-100 dark:bg-green-950 border-green-300 dark:border-green-800';\n      case 'overdue':\n        return 'bg-destructive/10 border-destructive/30';\n      case 'due':\n        return 'bg-yellow-100 dark:bg-yellow-950 border-yellow-300 dark:border-yellow-800';\n      case 'scheduled':\n        return 'bg-blue-100 dark:bg-blue-950 border-blue-300 dark:border-blue-800';\n      case 'not_scheduled':\n      default:\n        return 'bg-muted/30 border-border/30';\n    }\n  };\n\n  const getStatusLabel = () => {\n    switch (data.status) {\n      case 'completed':\n        return `${data.month}: Completed - ${data.completed || 0} of ${data.count} inspections completed`;\n      case 'overdue':\n        return `${data.month}: Overdue - ${data.overdue || 0} of ${data.count} inspections overdue`;\n      case 'due':\n        return `${data.month}: Due Soon - ${data.count} inspections due within 30 days`;\n      case 'scheduled':\n        return `${data.month}: Scheduled - ${data.count} inspections scheduled`;\n      case 'not_scheduled':\n      default:\n        return `${data.month}: Not Scheduled - No inspections scheduled`;\n    }\n  };\n\n  const statusLabel = getStatusLabel();\n\n  return (\n    <div \n      className={`flex items-center justify-center p-2 rounded-md border ${getStatusColor()} hover-elevate transition-all`}\n      title={statusLabel}\n      aria-label={statusLabel}\n      role=\"status\"\n      data-testid={`cell-${data.status}-${data.month}`}\n    >\n      {getStatusIcon()}\n    </div>\n  );\n}\n\nexport default function ComplianceCalendar({ report, isLoading, entityType }: ComplianceCalendarProps) {\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Annual Inspection Compliance</CardTitle>\n          <CardDescription>Loading compliance report...</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"h-64 flex items-center justify-center\">\n            <div className=\"text-muted-foreground\">Loading...</div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!report || report.templates.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Annual Inspection Compliance</CardTitle>\n          <CardDescription>\n            Track inspection compliance across all months for {entityType === 'property' ? 'this property' : 'this block'}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"py-12 text-center\">\n            <AlertCircle className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No Inspection Templates</h3>\n            <p className=\"text-muted-foreground\">\n              Create inspection templates and schedule inspections to track compliance.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // Abbreviate month names for better mobile display\n  const monthAbbreviations = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between gap-4\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              Annual Inspection Compliance\n              <Badge variant=\"outline\" className=\"ml-2\" data-testid=\"badge-overall-compliance\">\n                {report.overallCompliance}% Overall\n              </Badge>\n            </CardTitle>\n            <CardDescription className=\"mt-1\">\n              {report.year}  {report.totalCompleted} of {report.totalScheduled} inspections completed\n            </CardDescription>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {/* Legend */}\n        <div className=\"mb-6 flex flex-wrap gap-4 text-sm\">\n          <div className=\"flex items-center gap-2\">\n            <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n            <span className=\"text-muted-foreground\">Completed</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <AlertCircle className=\"h-4 w-4 text-destructive\" />\n            <span className=\"text-muted-foreground\">Overdue</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"h-4 w-4 text-yellow-600\" />\n            <span className=\"text-muted-foreground\">Due Soon</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Circle className=\"h-4 w-4 text-blue-600\" />\n            <span className=\"text-muted-foreground\">Scheduled</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Circle className=\"h-4 w-4 text-muted-foreground/30\" />\n            <span className=\"text-muted-foreground\">Not Scheduled</span>\n          </div>\n        </div>\n\n        {/* Compliance Grid */}\n        <div className=\"overflow-x-auto\">\n          <div className=\"min-w-[800px]\">\n            {/* Header Row */}\n            <div className=\"grid gap-2 mb-2\" style={{ gridTemplateColumns: '200px repeat(12, 1fr) 80px' }}>\n              <div className=\"font-semibold text-sm p-2\">Template</div>\n              {monthAbbreviations.map((month, idx) => (\n                <div key={month} className=\"font-semibold text-sm text-center p-2\" data-testid={`header-${report.months[idx]}`}>\n                  {month}\n                </div>\n              ))}\n              <div className=\"font-semibold text-sm text-center p-2\">Rate</div>\n            </div>\n\n            {/* Template Rows */}\n            {report.templates.map((template) => (\n              <div \n                key={template.templateId} \n                className=\"grid gap-2 mb-2 items-center\"\n                style={{ gridTemplateColumns: '200px repeat(12, 1fr) 80px' }}\n                data-testid={`row-template-${template.templateId}`}\n              >\n                {/* Template Name */}\n                <div className=\"text-sm font-medium p-2 truncate\" title={template.templateName}>\n                  {template.templateName}\n                </div>\n\n                {/* Month Cells */}\n                {template.monthData.map((monthData) => (\n                  <StatusCell key={monthData.month} data={monthData} />\n                ))}\n\n                {/* Compliance Rate */}\n                <div className=\"text-center p-2\">\n                  <Badge \n                    variant={template.complianceRate >= 80 ? \"default\" : template.complianceRate >= 60 ? \"secondary\" : \"destructive\"}\n                    data-testid={`badge-rate-${template.templateId}`}\n                  >\n                    {template.complianceRate}%\n                  </Badge>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n\n        {/* Summary Stats */}\n        <div className=\"mt-6 pt-6 border-t grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <div className=\"text-sm text-muted-foreground\">Total Inspections</div>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-scheduled\">{report.totalScheduled}</div>\n          </div>\n          <div>\n            <div className=\"text-sm text-muted-foreground\">Completed</div>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-total-completed\">{report.totalCompleted}</div>\n          </div>\n          <div>\n            <div className=\"text-sm text-muted-foreground\">Pending</div>\n            <div className=\"text-2xl font-bold text-yellow-600\" data-testid=\"stat-total-pending\">\n              {report.totalScheduled - report.totalCompleted}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":9473},"client/src/pages/BlockTenants.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { TagFilter } from \"@/components/TagFilter\";\nimport type { Tag } from \"@shared/schema\";\nimport { ArrowLeft, Users, Home, DollarSign, Percent, Mail, Phone, Building2, Calendar, MessageSquare, Search, Tag as TagIcon } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { BroadcastDialog } from \"@/components/BroadcastDialog\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\ninterface TenantAssignment {\n  user: {\n    id: string;\n    firstName?: string;\n    lastName?: string;\n    email: string;\n    phone?: string;\n    profileImageUrl?: string;\n  };\n  property: {\n    id: string;\n    name: string;\n    address: string;\n  };\n  assignment: {\n    id: string;\n    leaseStartDate?: Date | string;\n    leaseEndDate?: Date | string;\n    monthlyRent?: string;\n    depositAmount?: string;\n    isActive: boolean;\n  };\n  tags?: Tag[];\n}\n\ninterface BlockTenantsData {\n  stats: {\n    totalUnits: number;\n    occupiedUnits: number;\n    occupancyRate: number;\n    totalMonthlyRent: number;\n  };\n  tenants: TenantAssignment[];\n}\n\ninterface Block {\n  id: string;\n  name: string;\n  address: string;\n}\n\nexport default function BlockTenants() {\n  const [, params] = useRoute(\"/blocks/:id/tenants\");\n  const blockId = params?.id;\n  const locale = useLocale();\n  const [broadcastDialogOpen, setBroadcastDialogOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterTags, setFilterTags] = useState<Tag[]>([]);\n\n  const { data: block, isLoading: blockLoading } = useQuery<Block>({\n    queryKey: [\"/api/blocks\", blockId],\n    queryFn: async () => {\n      const res = await fetch(`/api/blocks/${blockId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch block\");\n      return res.json();\n    },\n    enabled: !!blockId,\n  });\n\n  const { data: tenantsData, isLoading: tenantsLoading } = useQuery<BlockTenantsData>({\n    queryKey: [\"/api/blocks\", blockId, \"tenants\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/blocks/${blockId}/tenants`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch tenants\");\n      return res.json();\n    },\n    enabled: !!blockId,\n  });\n\n  // Fetch tags for all tenant assignments\n  const tenantAssignmentIds = useMemo(() => \n    (tenantsData?.tenants || []).map((t: TenantAssignment) => t.assignment.id).sort().join(','), \n    [tenantsData]\n  );\n  const { data: tenantTagsMap = {} } = useQuery<Record<string, Tag[]>>({\n    queryKey: [\"/api/tenant-assignments/tags\", blockId, tenantAssignmentIds],\n    enabled: !!tenantsData?.tenants && tenantsData.tenants.length > 0,\n    queryFn: async () => {\n      const tenants = tenantsData?.tenants || [];\n      const tagPromises = tenants.map(async (tenant: TenantAssignment) => {\n        try {\n          const res = await fetch(`/api/tenant-assignments/${tenant.assignment.id}/tags`, { credentials: \"include\" });\n          if (res.ok) {\n            const tags = await res.json();\n            return { assignmentId: tenant.assignment.id, tags };\n          }\n        } catch (error) {\n          console.error(`Error fetching tags for assignment ${tenant.assignment.id}:`, error);\n        }\n        return { assignmentId: tenant.assignment.id, tags: [] };\n      });\n      \n      const results = await Promise.all(tagPromises);\n      return results.reduce((acc, { assignmentId, tags }) => {\n        acc[assignmentId] = tags;\n        return acc;\n      }, {} as Record<string, Tag[]>);\n    },\n  });\n\n  // Merge tags into tenants\n  const tenantsWithTags = useMemo(() => {\n    const tenants = tenantsData?.tenants || [];\n    return tenants.map(tenant => ({\n      ...tenant,\n      tags: tenantTagsMap[tenant.assignment.id] || [],\n    }));\n  }, [tenantsData, tenantTagsMap]);\n\n  // Filter tenants by search query and tags\n  const filteredTenants = useMemo(() => {\n    let filtered = tenantsWithTags;\n\n    // Filter by search query (name, email, property name)\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(tenant => {\n        const fullName = [tenant.user.firstName, tenant.user.lastName].filter(Boolean).join(' ').toLowerCase();\n        return (\n          fullName.includes(query) ||\n          tenant.user.email.toLowerCase().includes(query) ||\n          tenant.property.name.toLowerCase().includes(query)\n        );\n      });\n    }\n\n    // Filter by tags (show tenants that have ALL selected tags)\n    if (filterTags.length > 0) {\n      filtered = filtered.filter(tenant => {\n        if (!tenant.tags || tenant.tags.length === 0) return false;\n        return filterTags.every(filterTag =>\n          tenant.tags!.some((tenantTag: Tag) => tenantTag.id === filterTag.id)\n        );\n      });\n    }\n\n    return filtered;\n  }, [tenantsWithTags, searchQuery, filterTags]);\n\n  if (blockLoading || tenantsLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!block) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Block not found</p>\n          <Link href=\"/blocks\">\n            <Button variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Blocks\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const stats = tenantsData?.stats || { totalUnits: 0, occupiedUnits: 0, occupancyRate: 0, totalMonthlyRent: 0 };\n  const tenants = tenantsData?.tenants || [];\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div>\n        <Link href={`/blocks/${block.id}`}>\n          <Button variant=\"ghost\" className=\"mb-4\" data-testid=\"button-back-to-block\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to {block.name}\n          </Button>\n        </Link>\n        \n        <div className=\"flex items-start justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n              <Users className=\"h-8 w-8 text-primary\" />\n              {block.name} - Tenants\n            </h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Tenant occupancy and property assignments for {block.name}\n            </p>\n          </div>\n          \n          <Button\n            onClick={() => setBroadcastDialogOpen(true)}\n            disabled={stats.occupiedUnits === 0}\n            data-testid=\"button-broadcast-message\"\n          >\n            <MessageSquare className=\"h-4 w-4 mr-2\" />\n            Broadcast Message\n          </Button>\n        </div>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card data-testid=\"card-total-units\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Units</CardTitle>\n            <Home className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats.totalUnits}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              Properties in this block\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-occupied-units\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Occupied Units</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats.occupiedUnits}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              Active tenant assignments\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-occupancy-rate\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Occupancy Rate</CardTitle>\n            <Percent className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats.occupancyRate.toFixed(1)}%</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {stats.occupiedUnits} of {stats.totalUnits} units\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-rent\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Monthly Rent</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {locale.formatCurrency(stats.totalMonthlyRent * 100, false)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Combined monthly revenue\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Tenants List */}\n      <div>\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-2xl font-semibold\">Tenants</h2>\n        </div>\n\n        {/* Search and Tag Filter */}\n        {tenants.length > 0 && (\n          <div className=\"space-y-4 mb-6\">\n            <div className=\"relative max-w-md\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n              <Input\n                placeholder=\"Search by name, email, or property...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-tenants\"\n              />\n            </div>\n            <TagFilter\n              selectedTags={filterTags}\n              onTagsChange={setFilterTags}\n              placeholder=\"Filter by tags...\"\n            />\n          </div>\n        )}\n        \n        {tenants.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <Users className=\"h-12 w-12 text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">No tenants assigned</h3>\n              <p className=\"text-muted-foreground text-center\">\n                Tenants assigned to properties in this block will appear here\n              </p>\n            </CardContent>\n          </Card>\n        ) : filteredTenants.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <Search className=\"h-12 w-12 text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">No tenants found</h3>\n              <p className=\"text-muted-foreground text-center\">\n                Try adjusting your search or filter criteria\n              </p>\n              <Button \n                variant=\"outline\" \n                className=\"mt-4\"\n                onClick={() => {\n                  setSearchQuery(\"\");\n                  setFilterTags([]);\n                }}\n              >\n                Clear Filters\n              </Button>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-4\">\n            {filteredTenants.map((tenant, index) => {\n              const fullName = [tenant.user.firstName, tenant.user.lastName].filter(Boolean).join(' ') || 'Unnamed Tenant';\n              const initials = fullName\n                .split(' ')\n                .map(n => n[0])\n                .join('')\n                .toUpperCase()\n                .slice(0, 2);\n\n              return (\n                <Card key={index} data-testid={`card-tenant-${index}`} className=\"hover-elevate\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex flex-col md:flex-row gap-6\">\n                      {/* Tenant Info */}\n                      <div className=\"flex items-start gap-4 flex-1\">\n                        <Avatar className=\"h-12 w-12\">\n                          <AvatarImage src={tenant.user.profileImageUrl} alt={fullName} />\n                          <AvatarFallback>{initials}</AvatarFallback>\n                        </Avatar>\n                        <div className=\"flex-1 min-w-0\">\n                          <h3 className=\"text-lg font-semibold\">{fullName}</h3>\n                          <div className=\"space-y-1 mt-2\">\n                            {tenant.user.email && (\n                              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                                <Mail className=\"h-4 w-4 shrink-0\" />\n                                <span className=\"truncate\">{tenant.user.email}</span>\n                              </div>\n                            )}\n                            {tenant.user.phone && (\n                              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                                <Phone className=\"h-4 w-4 shrink-0\" />\n                                <span>{tenant.user.phone}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                        <Badge variant={tenant.assignment.isActive ? \"default\" : \"secondary\"}>\n                          {tenant.assignment.isActive ? \"Active\" : \"Inactive\"}\n                        </Badge>\n                      </div>\n\n                      {/* Property Info */}\n                      <div className=\"border-t md:border-t-0 md:border-l pt-4 md:pt-0 md:pl-6 flex-1\">\n                        <Link href={`/properties/${tenant.property.id}`}>\n                          <div className=\"flex items-start gap-3 hover-elevate p-2 -m-2 rounded-md cursor-pointer\">\n                            <Building2 className=\"h-5 w-5 text-primary shrink-0 mt-0.5\" />\n                            <div className=\"flex-1 min-w-0\">\n                              <h4 className=\"font-semibold text-primary\">{tenant.property.name}</h4>\n                              <p className=\"text-sm text-muted-foreground truncate\">{tenant.property.address}</p>\n                            </div>\n                          </div>\n                        </Link>\n\n                        <div className=\"mt-3 space-y-2\">\n                          {tenant.assignment.leaseStartDate && (\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                              <Calendar className=\"h-4 w-4 shrink-0\" />\n                              <span>\n                                Lease: {format(new Date(tenant.assignment.leaseStartDate), 'MMM d, yyyy')}\n                                {tenant.assignment.leaseEndDate && (\n                                  <> - {format(new Date(tenant.assignment.leaseEndDate), 'MMM d, yyyy')}</>\n                                )}\n                              </span>\n                            </div>\n                          )}\n                          {tenant.assignment.monthlyRent && (\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                              <DollarSign className=\"h-4 w-4 shrink-0\" />\n                              <span>Rent: {locale.formatCurrency(parseFloat(tenant.assignment.monthlyRent) * 100, false)}/month</span>\n                            </div>\n                          )}\n                        </div>\n\n                        {/* Tags */}\n                        {tenant.tags && tenant.tags.length > 0 && (\n                          <div className=\"mt-3 pt-3 border-t\">\n                            <div className=\"flex flex-wrap gap-1.5\">\n                              {tenant.tags.map((tag: Tag) => (\n                                <span\n                                  key={tag.id}\n                                  className=\"inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-md\"\n                                  style={{ backgroundColor: tag.color || '#e2e8f0' }}\n                                  data-testid={`tag-${tenant.assignment.id}-${tag.id}`}\n                                >\n                                  <TagIcon className=\"h-3 w-3\" />\n                                  {tag.name}\n                                </span>\n                              ))}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      <BroadcastDialog\n        blockId={blockId!}\n        blockName={block.name}\n        blockAddress={block.address}\n        tenantCount={stats.occupiedUnits}\n        open={broadcastDialogOpen}\n        onOpenChange={setBroadcastDialogOpen}\n      />\n    </div>\n  );\n}\n","size_bytes":17581},"client/src/components/BroadcastDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Mail, Send, FileText, Plus, AlertCircle } from \"lucide-react\";\n\ninterface MessageTemplate {\n  id: string;\n  name: string;\n  subject: string;\n  body: string;\n  variables: string[];\n}\n\ninterface BroadcastDialogProps {\n  blockId: string;\n  blockName: string;\n  blockAddress: string;\n  tenantCount: number;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport function BroadcastDialog({\n  blockId,\n  blockName,\n  blockAddress,\n  tenantCount,\n  open,\n  onOpenChange,\n}: BroadcastDialogProps) {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState<\"template\" | \"custom\">(\"template\");\n  const [selectedTemplateId, setSelectedTemplateId] = useState<string>(\"\");\n  const [customSubject, setCustomSubject] = useState(\"\");\n  const [customBody, setCustomBody] = useState(\"\");\n  const [previewSubject, setPreviewSubject] = useState(\"\");\n  const [previewBody, setPreviewBody] = useState(\"\");\n\n  const { data: templates = [], isLoading: templatesLoading } = useQuery<MessageTemplate[]>({\n    queryKey: [\"/api/message-templates\"],\n    enabled: open,\n  });\n\n  const broadcastMutation = useMutation({\n    mutationFn: async (data: { templateId?: string; subject?: string; body?: string }) => {\n      return apiRequest(`/api/blocks/${blockId}/broadcast`, \"POST\", data);\n    },\n    onSuccess: (result: any) => {\n      const successCount = result.results?.filter((r: any) => r.success).length || 0;\n      const failureCount = result.results?.filter((r: any) => !r.success).length || 0;\n\n      toast({\n        title: \"Broadcast sent\",\n        description: `Successfully sent to ${successCount} tenant${successCount !== 1 ? 's' : ''}${failureCount > 0 ? `. Failed to send to ${failureCount}.` : ''}`,\n      });\n      onOpenChange(false);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to send broadcast\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setActiveTab(\"template\");\n    setSelectedTemplateId(\"\");\n    setCustomSubject(\"\");\n    setCustomBody(\"\");\n    setPreviewSubject(\"\");\n    setPreviewBody(\"\");\n  };\n\n  const handleTemplateChange = (templateId: string) => {\n    setSelectedTemplateId(templateId);\n    const template = templates.find(t => t.id === templateId);\n    if (template) {\n      updatePreview(template.subject, template.body);\n    }\n  };\n\n  const updatePreview = (subject: string, body: string) => {\n    const variables: Record<string, string> = {\n      '{block_name}': blockName,\n      '{block_address}': blockAddress,\n      '{tenant_name}': '[Tenant Name]',\n      '{tenant_email}': '[tenant@example.com]',\n      '{property_name}': '[Property Name]',\n      '{sender_name}': '[Your Name]',\n    };\n\n    let previewSubj = subject;\n    let previewBod = body;\n\n    Object.entries(variables).forEach(([key, value]) => {\n      previewSubj = previewSubj.replaceAll(key, value);\n      previewBod = previewBod.replaceAll(key, value);\n    });\n\n    setPreviewSubject(previewSubj);\n    setPreviewBody(previewBod);\n  };\n\n  const handleCustomSubjectChange = (value: string) => {\n    setCustomSubject(value);\n    updatePreview(value, customBody);\n  };\n\n  const handleCustomBodyChange = (value: string) => {\n    setCustomBody(value);\n    updatePreview(customSubject, value);\n  };\n\n  const handleSend = () => {\n    if (activeTab === \"template\") {\n      if (!selectedTemplateId) {\n        toast({\n          title: \"Template required\",\n          description: \"Please select a template to send\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      broadcastMutation.mutate({ templateId: selectedTemplateId });\n    } else {\n      if (!customSubject.trim() || !customBody.trim()) {\n        toast({\n          title: \"Message required\",\n          description: \"Please provide both subject and message body\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      broadcastMutation.mutate({ subject: customSubject, body: customBody });\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Mail className=\"h-5 w-5 text-primary\" />\n            Broadcast Message to Tenants\n          </DialogTitle>\n          <DialogDescription>\n            Send a message to all {tenantCount} active tenant{tenantCount !== 1 ? 's' : ''} in {blockName}\n          </DialogDescription>\n        </DialogHeader>\n\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \"template\" | \"custom\")}>\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"template\" data-testid=\"tab-template\">\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Use Template\n            </TabsTrigger>\n            <TabsTrigger value=\"custom\" data-testid=\"tab-custom\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Custom Message\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"template\" className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"template-select\">Select Message Template</Label>\n              {templatesLoading ? (\n                <div className=\"text-sm text-muted-foreground\">Loading templates...</div>\n              ) : templates.length === 0 ? (\n                <Card className=\"border-dashed\">\n                  <CardContent className=\"flex flex-col items-center justify-center py-8 text-center\">\n                    <FileText className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">\n                      No templates available. Switch to custom message or create templates from the settings.\n                    </p>\n                  </CardContent>\n                </Card>\n              ) : (\n                <Select value={selectedTemplateId} onValueChange={handleTemplateChange}>\n                  <SelectTrigger id=\"template-select\" data-testid=\"select-template\">\n                    <SelectValue placeholder=\"Choose a template...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {templates.map((template) => (\n                      <SelectItem key={template.id} value={template.id}>\n                        {template.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              )}\n            </div>\n\n            {selectedTemplateId && (\n              <Card className=\"bg-muted/50\">\n                <CardContent className=\"pt-6 space-y-3\">\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">Subject</Label>\n                    <p className=\"text-sm font-medium\" data-testid=\"text-template-subject\">\n                      {templates.find(t => t.id === selectedTemplateId)?.subject}\n                    </p>\n                  </div>\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">Message</Label>\n                    <p className=\"text-sm whitespace-pre-wrap\" data-testid=\"text-template-body\">\n                      {templates.find(t => t.id === selectedTemplateId)?.body}\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"custom\" className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"custom-subject\">Subject</Label>\n              <Input\n                id=\"custom-subject\"\n                placeholder=\"Enter message subject...\"\n                value={customSubject}\n                onChange={(e) => handleCustomSubjectChange(e.target.value)}\n                data-testid=\"input-custom-subject\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"custom-body\">Message</Label>\n              <Textarea\n                id=\"custom-body\"\n                placeholder=\"Enter your message here...\"\n                value={customBody}\n                onChange={(e) => handleCustomBodyChange(e.target.value)}\n                rows={8}\n                data-testid=\"textarea-custom-body\"\n              />\n            </div>\n\n            <Card className=\"bg-muted/50 border-dashed\">\n              <CardContent className=\"pt-6\">\n                <div className=\"flex items-start gap-2\">\n                  <AlertCircle className=\"h-4 w-4 text-muted-foreground mt-0.5 shrink-0\" />\n                  <div className=\"space-y-1 text-xs text-muted-foreground\">\n                    <p className=\"font-medium\">Available Variables:</p>\n                    <p>{'{tenant_name}'}, {'{tenant_email}'}, {'{block_name}'}, {'{block_address}'}, {'{property_name}'}, {'{sender_name}'}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {(previewSubject || previewBody) && (\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm font-semibold\">Preview</Label>\n            <Card className=\"border-primary/20\">\n              <CardContent className=\"pt-6 space-y-3\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Subject</Label>\n                  <p className=\"text-sm font-medium\" data-testid=\"text-preview-subject\">{previewSubject}</p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Message</Label>\n                  <p className=\"text-sm whitespace-pre-wrap\" data-testid=\"text-preview-body\">{previewBody}</p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)} data-testid=\"button-cancel\">\n            Cancel\n          </Button>\n          <Button\n            onClick={handleSend}\n            disabled={broadcastMutation.isPending || tenantCount === 0}\n            data-testid=\"button-send-broadcast\"\n          >\n            {broadcastMutation.isPending ? (\n              <>Sending...</>\n            ) : (\n              <>\n                <Send className=\"h-4 w-4 mr-2\" />\n                Send to {tenantCount} Tenant{tenantCount !== 1 ? 's' : ''}\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":11392},"client/src/components/EditTenantDialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { updateTenantAssignmentSchema } from \"@shared/schema\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Loader2, Send, Upload, X, FileText, Download } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport { PhoneInput } from \"@/components/PhoneInput\";\n\nconst formSchema = z.object({\n  leaseStartDate: z.string().optional(),\n  leaseEndDate: z.string().optional(),\n  monthlyRent: z.string().optional(),\n  depositAmount: z.string().optional(),\n  isActive: z.boolean(),\n  hasPortalAccess: z.boolean(),\n  nextOfKinName: z.string().optional(),\n  nextOfKinPhone: z.string().optional(),\n  nextOfKinEmail: z.string().optional(),\n  nextOfKinRelationship: z.string().optional(),\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\ninterface TenantAssignment {\n  id: string;\n  firstName?: string;\n  lastName?: string;\n  email: string;\n  assignment: {\n    id: string;\n    leaseStartDate?: Date | string;\n    leaseEndDate?: Date | string;\n    monthlyRent?: string;\n    depositAmount?: string;\n    isActive: boolean;\n    hasPortalAccess?: boolean;\n    nextOfKinName?: string;\n    nextOfKinPhone?: string;\n    nextOfKinEmail?: string;\n    nextOfKinRelationship?: string;\n  };\n}\n\ninterface Tag {\n  id: string;\n  name: string;\n  color?: string;\n}\n\ninterface Attachment {\n  id: string;\n  fileName: string;\n  fileUrl: string;\n  fileType?: string;\n  fileSize?: number;\n  description?: string;\n  createdAt: string;\n}\n\ninterface EditTenantDialogProps {\n  propertyId: string;\n  tenant: TenantAssignment;\n  children: React.ReactNode;\n  onSuccess?: () => void;\n}\n\nexport default function EditTenantDialog({\n  propertyId,\n  tenant,\n  children,\n  onSuccess,\n}: EditTenantDialogProps) {\n  const [open, setOpen] = useState(false);\n  const [selectedTags, setSelectedTags] = useState<string[]>([]);\n  const [uploading, setUploading] = useState(false);\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const locale = useLocale();\n\n  // Fetch organization tags\n  const { data: tags = [] } = useQuery<Tag[]>({\n    queryKey: [\"/api/tags\"],\n    enabled: open,\n  });\n\n  // Fetch tenant assignment tags\n  const { data: assignmentTags = [] } = useQuery<Tag[]>({\n    queryKey: [\"/api/tenant-assignments\", tenant.assignment.id, \"tags\"],\n    enabled: open,\n  });\n\n  // Fetch attachments\n  const { data: attachments = [] } = useQuery<Attachment[]>({\n    queryKey: [\"/api/tenant-assignments\", tenant.assignment.id, \"attachments\"],\n    enabled: open,\n  });\n\n  // Update selected tags when assignment tags load\n  useEffect(() => {\n    if (assignmentTags.length > 0) {\n      setSelectedTags(assignmentTags.map((t) => t.id));\n    }\n  }, [assignmentTags]);\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      leaseStartDate: \"\",\n      leaseEndDate: \"\",\n      monthlyRent: \"\",\n      depositAmount: \"\",\n      isActive: true,\n      hasPortalAccess: true,\n      nextOfKinName: \"\",\n      nextOfKinPhone: \"\",\n      nextOfKinEmail: \"\",\n      nextOfKinRelationship: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (open && tenant) {\n      const leaseStartDate = tenant.assignment.leaseStartDate\n        ? new Date(tenant.assignment.leaseStartDate).toISOString().split(\"T\")[0]\n        : \"\";\n      const leaseEndDate = tenant.assignment.leaseEndDate\n        ? new Date(tenant.assignment.leaseEndDate).toISOString().split(\"T\")[0]\n        : \"\";\n\n      form.reset({\n        leaseStartDate,\n        leaseEndDate,\n        monthlyRent: tenant.assignment.monthlyRent || \"\",\n        depositAmount: tenant.assignment.depositAmount || \"\",\n        isActive: tenant.assignment.isActive,\n        hasPortalAccess: tenant.assignment.hasPortalAccess ?? true,\n        nextOfKinName: tenant.assignment.nextOfKinName || \"\",\n        nextOfKinPhone: tenant.assignment.nextOfKinPhone || \"\",\n        nextOfKinEmail: tenant.assignment.nextOfKinEmail || \"\",\n        nextOfKinRelationship: tenant.assignment.nextOfKinRelationship || \"\",\n      });\n    }\n  }, [open, tenant, form]);\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      // Build payload - send dates as ISO strings, let server handle transformation\n      const payload: any = {\n        isActive: data.isActive,\n        hasPortalAccess: data.hasPortalAccess,\n      };\n\n      // Convert dates to ISO strings (will be converted to Date objects on server)\n      if (data.leaseStartDate && data.leaseStartDate.trim() !== '') {\n        const startDate = new Date(data.leaseStartDate);\n        if (!isNaN(startDate.getTime())) {\n          payload.leaseStartDate = startDate.toISOString();\n        }\n      }\n\n      if (data.leaseEndDate && data.leaseEndDate.trim() !== '') {\n        const endDate = new Date(data.leaseEndDate);\n        if (!isNaN(endDate.getTime())) {\n          payload.leaseEndDate = endDate.toISOString();\n        }\n      }\n\n      // Send numeric fields as strings (Drizzle numeric fields expect strings)\n      if (data.monthlyRent && data.monthlyRent.trim() !== '') {\n        const rent = parseFloat(data.monthlyRent);\n        if (!isNaN(rent) && rent >= 0) {\n          payload.monthlyRent = rent.toString();\n        }\n      }\n\n      if (data.depositAmount && data.depositAmount.trim() !== '') {\n        const deposit = parseFloat(data.depositAmount);\n        if (!isNaN(deposit) && deposit >= 0) {\n          payload.depositAmount = deposit.toString();\n        }\n      }\n\n      // Add optional next of kin fields\n      if (data.nextOfKinName && data.nextOfKinName.trim() !== '') {\n        payload.nextOfKinName = data.nextOfKinName.trim();\n      }\n      if (data.nextOfKinPhone && data.nextOfKinPhone.trim() !== '') {\n        payload.nextOfKinPhone = data.nextOfKinPhone.trim();\n      }\n      if (data.nextOfKinEmail && data.nextOfKinEmail.trim() !== '') {\n        payload.nextOfKinEmail = data.nextOfKinEmail.trim();\n      }\n      if (data.nextOfKinRelationship && data.nextOfKinRelationship.trim() !== '') {\n        payload.nextOfKinRelationship = data.nextOfKinRelationship.trim();\n      }\n\n      console.log('[EditTenantDialog] Updating assignment with payload:', payload);\n      return apiRequest(\"PUT\", `/api/tenant-assignments/${tenant.assignment.id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\", propertyId, \"tenants\"] });\n      toast({\n        title: \"Assignment updated\",\n        description: \"The tenant assignment has been successfully updated\",\n      });\n      setOpen(false);\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      console.error(\"[EditTenantDialog] Update error:\", error);\n      let errorMessage = \"An error occurred while updating the tenant assignment\";\n      \n      // Extract error message from the error object\n      if (error?.message) {\n        errorMessage = error.message;\n      } else if (typeof error === 'string') {\n        errorMessage = error;\n      }\n\n      toast({\n        title: \"Failed to update assignment\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const sendPasswordMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", `/api/tenant-assignments/${tenant.assignment.id}/send-password`, {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Password sent\",\n        description: `Portal credentials have been sent to ${tenant.email}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to send password\",\n        description: \"An error occurred while sending the password\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateTagsMutation = useMutation({\n    mutationFn: async (tagIds: string[]) => {\n      return apiRequest(\"PUT\", `/api/tenant-assignments/${tenant.assignment.id}/tags`, { tagIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant-assignments\", tenant.assignment.id, \"tags\"] });\n      toast({\n        title: \"Tags updated\",\n        description: \"Tenant tags have been successfully updated\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to update tags\",\n        description: \"An error occurred while updating tags\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteAttachmentMutation = useMutation({\n    mutationFn: async (attachmentId: string) => {\n      return apiRequest(`/api/tenancy-attachments/${attachmentId}`, \"DELETE\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant-assignments\", tenant.assignment.id, \"attachments\"] });\n      toast({\n        title: \"Attachment deleted\",\n        description: \"The attachment has been removed\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to delete attachment\",\n        description: \"An error occurred while deleting the attachment\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FormData) => {\n    updateMutation.mutate(data);\n  };\n\n  const handleToggleTag = (tagId: string) => {\n    const newTags = selectedTags.includes(tagId)\n      ? selectedTags.filter((id) => id !== tagId)\n      : [...selectedTags, tagId];\n    setSelectedTags(newTags);\n    updateTagsMutation.mutate(newTags);\n  };\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setUploading(true);\n    const formData = new FormData();\n    formData.append(\"file\", file);\n    formData.append(\"tenantAssignmentId\", tenant.assignment.id);\n\n    try {\n      const response = await fetch(\"/api/tenancy-attachments\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\", // Include cookies for authentication\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ error: \"Unknown error\" }));\n        throw new Error(errorData.error || errorData.message || \"Upload failed\");\n      }\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant-assignments\", tenant.assignment.id, \"attachments\"] });\n      toast({\n        title: \"File uploaded\",\n        description: `${file.name} has been uploaded successfully`,\n      });\n    } catch (error: any) {\n      console.error(\"[EditTenantDialog] File upload error:\", error);\n      toast({\n        title: \"Upload failed\",\n        description: error.message || \"An error occurred while uploading the file\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n      e.target.value = \"\"; // Reset input\n    }\n  };\n\n  const formatFileSize = (bytes?: number) => {\n    if (!bytes) return \"Unknown size\";\n    const mb = bytes / (1024 * 1024);\n    if (mb >= 1) return `${mb.toFixed(2)} MB`;\n    const kb = bytes / 1024;\n    return `${kb.toFixed(2)} KB`;\n  };\n\n  const fullName = [tenant.firstName, tenant.lastName].filter(Boolean).join(\" \") || tenant.email;\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>{children}</DialogTrigger>\n      <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Edit Tenant Assignment</DialogTitle>\n          <DialogDescription>Update lease details for {fullName}</DialogDescription>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            {/* Lease Details Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-semibold\">Lease Details</h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"leaseStartDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Lease Start Date</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"date\"\n                          {...field}\n                          data-testid=\"input-lease-start\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"leaseEndDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Lease End Date</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"date\"\n                          {...field}\n                          data-testid=\"input-lease-end\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"monthlyRent\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Monthly Rent</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          placeholder=\"0.00\"\n                          {...field}\n                          data-testid=\"input-monthly-rent\"\n                        />\n                      </FormControl>\n                      <FormDescription>In {locale.currency}</FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"depositAmount\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Deposit Amount</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          placeholder=\"0.00\"\n                          {...field}\n                          data-testid=\"input-deposit\"\n                        />\n                      </FormControl>\n                      <FormDescription>In {locale.currency}</FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Next of Kin Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-semibold\">Next of Kin Information</h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"nextOfKinName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Full Name</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"John Doe\"\n                          {...field}\n                          data-testid=\"input-next-of-kin-name\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"nextOfKinRelationship\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Relationship</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        value={field.value}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-next-of-kin-relationship\">\n                            <SelectValue placeholder=\"Select relationship\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Parent\">Parent</SelectItem>\n                          <SelectItem value=\"Sibling\">Sibling</SelectItem>\n                          <SelectItem value=\"Spouse\">Spouse</SelectItem>\n                          <SelectItem value=\"Partner\">Partner</SelectItem>\n                          <SelectItem value=\"Child\">Child</SelectItem>\n                          <SelectItem value=\"Friend\">Friend</SelectItem>\n                          <SelectItem value=\"Other\">Other</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"nextOfKinPhone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone Number</FormLabel>\n                      <FormControl>\n                        <PhoneInput\n                          field={field}\n                          placeholder=\"Enter phone number\"\n                          data-testid=\"input-next-of-kin-phone\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"nextOfKinEmail\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email Address</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"email\"\n                          placeholder=\"email@example.com\"\n                          {...field}\n                          data-testid=\"input-next-of-kin-email\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Portal Access & Status Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-semibold\">Access & Status</h3>\n              <div className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"hasPortalAccess\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel className=\"text-base\">Tenant Portal Access</FormLabel>\n                        <FormDescription>\n                          Allow tenant to access the portal\n                        </FormDescription>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-portal-access\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                {form.watch(\"hasPortalAccess\") && (\n                  <div className=\"rounded-lg border p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"space-y-0.5\">\n                        <p className=\"text-sm font-medium\">Send Portal Credentials</p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Email login credentials to {tenant.email}\n                        </p>\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => sendPasswordMutation.mutate()}\n                        disabled={sendPasswordMutation.isPending}\n                        data-testid=\"button-send-password\"\n                      >\n                        {sendPasswordMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          <>\n                            <Send className=\"mr-2 h-4 w-4\" />\n                            Send Password\n                          </>\n                        )}\n                      </Button>\n                    </div>\n                  </div>\n                )}\n\n                <FormField\n                  control={form.control}\n                  name=\"isActive\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel className=\"text-base\">Active Status</FormLabel>\n                        <FormDescription>\n                          Mark this tenant assignment as active or inactive\n                        </FormDescription>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-is-active\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Tags Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-semibold\">Tags</h3>\n              <div className=\"flex flex-wrap gap-2\">\n                {tags.length > 0 ? (\n                  tags.map((tag) => (\n                    <Badge\n                      key={tag.id}\n                      variant={selectedTags.includes(tag.id) ? \"default\" : \"outline\"}\n                      className=\"cursor-pointer hover-elevate\"\n                      onClick={() => handleToggleTag(tag.id)}\n                      style={\n                        selectedTags.includes(tag.id) && tag.color\n                          ? { backgroundColor: tag.color, borderColor: tag.color }\n                          : {}\n                      }\n                      data-testid={`badge-tag-${tag.id}`}\n                    >\n                      {tag.name}\n                    </Badge>\n                  ))\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">No tags available</p>\n                )}\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Attachments Section */}\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-sm font-semibold\">Tenancy Attachments</h3>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => document.getElementById(\"file-upload\")?.click()}\n                  disabled={uploading}\n                  data-testid=\"button-upload-attachment\"\n                >\n                  {uploading ? (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                  )}\n                  Upload File\n                </Button>\n                <input\n                  id=\"file-upload\"\n                  type=\"file\"\n                  className=\"hidden\"\n                  onChange={handleFileUpload}\n                  accept=\".pdf,.doc,.docx,.jpg,.jpeg,.png\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                {attachments.length > 0 ? (\n                  attachments.map((attachment) => (\n                    <div\n                      key={attachment.id}\n                      className=\"flex items-center justify-between rounded-lg border p-3\"\n                    >\n                      <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                        <FileText className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\n                        <div className=\"min-w-0 flex-1\">\n                          <p className=\"text-sm font-medium truncate\">{attachment.fileName}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatFileSize(attachment.fileSize)}  {new Date(attachment.createdAt).toLocaleDateString()}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          asChild\n                          data-testid={`button-download-${attachment.id}`}\n                        >\n                          <a href={attachment.fileUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n                            <Download className=\"h-4 w-4\" />\n                          </a>\n                        </Button>\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => deleteAttachmentMutation.mutate(attachment.id)}\n                          disabled={deleteAttachmentMutation.isPending}\n                          data-testid={`button-delete-${attachment.id}`}\n                        >\n                          <X className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))\n                ) : (\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\n                    No attachments uploaded yet\n                  </p>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setOpen(false)}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {updateMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Updating...\n                  </>\n                ) : (\n                  \"Update Assignment\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":28111},"client/src/components/AddTenantDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Loader2, UserPlus, Users } from \"lucide-react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\ninterface User {\n  id: string;\n  firstName?: string;\n  lastName?: string;\n  email: string;\n  role: string;\n}\n\nconst selectTenantFormSchema = z.object({\n  tenantId: z.string().min(1, \"Please select a tenant\"),\n  leaseStartDate: z.string().optional(),\n  leaseEndDate: z.string().optional(),\n  monthlyRent: z.string().optional(),\n  depositAmount: z.string().optional(),\n  isActive: z.boolean().default(true),\n});\n\nconst createTenantFormSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  firstName: z.string().min(1, \"First name is required\").max(255),\n  lastName: z.string().min(1, \"Last name is required\").max(255),\n  username: z.string().min(3, \"Username must be at least 3 characters\").max(100),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  leaseStartDate: z.string().optional(),\n  leaseEndDate: z.string().optional(),\n  monthlyRent: z.string().optional(),\n  depositAmount: z.string().optional(),\n  isActive: z.boolean().default(true),\n});\n\ntype SelectTenantFormData = z.infer<typeof selectTenantFormSchema>;\ntype CreateTenantFormData = z.infer<typeof createTenantFormSchema>;\n\ninterface AddTenantDialogProps {\n  propertyId: string;\n  children: React.ReactNode;\n  onSuccess?: () => void;\n}\n\nexport default function AddTenantDialog({ propertyId, children, onSuccess }: AddTenantDialogProps) {\n  const [open, setOpen] = useState(false);\n  const [mode, setMode] = useState<\"select\" | \"create\">(\"select\");\n  const { toast } = useToast();\n  const locale = useLocale();\n\n  const { data: tenantUsers = [], isLoading: loadingTenants } = useQuery<User[]>({\n    queryKey: [\"/api/users/role/tenant\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/users/role/tenant\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch tenant users\");\n      return res.json();\n    },\n    enabled: open,\n  });\n\n  const selectForm = useForm<SelectTenantFormData>({\n    resolver: zodResolver(selectTenantFormSchema),\n    defaultValues: {\n      tenantId: \"\",\n      leaseStartDate: \"\",\n      leaseEndDate: \"\",\n      monthlyRent: \"\",\n      depositAmount: \"\",\n      isActive: true,\n    },\n  });\n\n  const createForm = useForm<CreateTenantFormData>({\n    resolver: zodResolver(createTenantFormSchema),\n    defaultValues: {\n      email: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      username: \"\",\n      password: \"\",\n      leaseStartDate: \"\",\n      leaseEndDate: \"\",\n      monthlyRent: \"\",\n      depositAmount: \"\",\n      isActive: true,\n    },\n  });\n\n  const createUserMutation = useMutation<User, Error, CreateTenantFormData>({\n    mutationFn: async (data: CreateTenantFormData) => {\n      // Create the user first via team member API\n      // Format data according to createTeamMemberSchema requirements\n      const userPayload = {\n        email: data.email.trim(),\n        firstName: data.firstName.trim() || undefined,\n        lastName: data.lastName.trim() || undefined,\n        username: data.username.trim(),\n        password: data.password.trim(),\n        role: \"tenant\" as const,\n        // Optional fields - only include if they have values\n        phone: undefined,\n        skills: undefined,\n        education: undefined,\n        profileImageUrl: undefined,\n        certificateUrls: undefined,\n        address: undefined,\n      };\n      \n      console.log('[AddTenantDialog] Creating tenant user with payload:', { ...userPayload, password: '***' });\n      const res = await apiRequest(\"POST\", \"/api/team\", userPayload);\n      \n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ message: \"Failed to create tenant user\" }));\n        \n        // Handle specific error cases\n        if (res.status === 401) {\n          throw new Error(\"Your session has expired. Please refresh the page and log in again.\");\n        } else if (res.status === 403) {\n          throw new Error(\"Only organization owners can create tenant users. Please contact your administrator.\");\n        } else if (res.status === 400) {\n          // Extract validation errors\n          const errorMessage = errorData.message || errorData.errors?.[0]?.message || \"Invalid request data\";\n          throw new Error(errorMessage);\n        } else if (errorData.message === \"Email or username already exists\") {\n          throw new Error(\"A user with this email or username already exists in your organization.\");\n        } else {\n          throw new Error(errorData.message || \"Failed to create tenant user\");\n        }\n      }\n      \n      return await res.json() as User;\n    },\n  });\n\n  const assignTenantMutation = useMutation({\n    mutationFn: async (data: { tenantId: string; leaseData: any }) => {\n      // Build payload - convert dates to ISO strings and numbers for schema validation\n      const payload: any = {\n        propertyId,\n        tenantId: data.tenantId,\n        isActive: data.leaseData.isActive ?? true,\n        hasPortalAccess: true, // Required field with default value\n      };\n      \n      // Convert dates - handle DD/MM/YYYY format and other formats\n      // Send as ISO strings (will be converted to Date objects on server)\n      if (data.leaseData.leaseStartDate && data.leaseData.leaseStartDate.trim() !== '') {\n        let startDate: Date;\n        const dateStr = data.leaseData.leaseStartDate.trim();\n        \n        // Handle DD/MM/YYYY format (common in UK)\n        if (dateStr.includes('/')) {\n          const parts = dateStr.split('/');\n          if (parts.length === 3) {\n            // DD/MM/YYYY format\n            startDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));\n          } else {\n            startDate = new Date(dateStr);\n          }\n        } else {\n          startDate = typeof data.leaseData.leaseStartDate === 'string' \n            ? new Date(data.leaseData.leaseStartDate)\n            : data.leaseData.leaseStartDate;\n        }\n        \n        if (!isNaN(startDate.getTime())) {\n          // Send as ISO string (server will convert to Date object)\n          payload.leaseStartDate = startDate.toISOString();\n        }\n      }\n      \n      if (data.leaseData.leaseEndDate && data.leaseData.leaseEndDate.trim() !== '') {\n        let endDate: Date;\n        const dateStr = data.leaseData.leaseEndDate.trim();\n        \n        // Handle DD/MM/YYYY format (common in UK)\n        if (dateStr.includes('/')) {\n          const parts = dateStr.split('/');\n          if (parts.length === 3) {\n            // DD/MM/YYYY format\n            endDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));\n          } else {\n            endDate = new Date(dateStr);\n          }\n        } else {\n          endDate = typeof data.leaseData.leaseEndDate === 'string'\n            ? new Date(data.leaseData.leaseEndDate)\n            : data.leaseData.leaseEndDate;\n        }\n        \n        if (!isNaN(endDate.getTime())) {\n          // Send as ISO string (server will convert to Date object)\n          payload.leaseEndDate = endDate.toISOString();\n        }\n      }\n      \n      // Convert monthlyRent to string (Drizzle numeric fields expect strings)\n      if (data.leaseData.monthlyRent !== undefined && data.leaseData.monthlyRent !== null && data.leaseData.monthlyRent !== '') {\n        const rentStr = String(data.leaseData.monthlyRent).trim();\n        if (rentStr !== '' && rentStr !== '0.00') {\n          const rent = parseFloat(rentStr);\n          if (!isNaN(rent) && rent >= 0) {\n            // Drizzle numeric fields expect strings\n            payload.monthlyRent = rent.toString();\n          }\n        }\n      }\n      \n      // Convert depositAmount to string (Drizzle numeric fields expect strings)\n      if (data.leaseData.depositAmount !== undefined && data.leaseData.depositAmount !== null && data.leaseData.depositAmount !== '') {\n        const depositStr = String(data.leaseData.depositAmount).trim();\n        if (depositStr !== '' && depositStr !== '0.00') {\n          const deposit = parseFloat(depositStr);\n          if (!isNaN(deposit) && deposit >= 0) {\n            // Drizzle numeric fields expect strings\n            payload.depositAmount = deposit.toString();\n          }\n        }\n      }\n      \n      console.log('[AddTenantDialog] Assigning tenant with payload:', payload);\n      const res = await apiRequest(\"POST\", \"/api/tenant-assignments\", payload);\n      \n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: \"Unknown error\" }));\n        // Extract the most helpful error message\n        const errorMessage = errorData.message \n          || errorData.details?.[0]?.message \n          || errorData.details?.[0]?.path?.join('.') + ': ' + errorData.details?.[0]?.message\n          || errorData.error \n          || \"Failed to assign tenant\";\n        console.error('[AddTenantDialog] Assignment error details:', errorData);\n        throw new Error(errorMessage);\n      }\n      \n      return res;\n    },\n    onSuccess: async () => {\n      // Force active refetch to update the UI immediately\n      await queryClient.invalidateQueries({ \n        queryKey: [\"/api/properties\", propertyId, \"tenants\"],\n        refetchType: \"active\"\n      });\n      await queryClient.invalidateQueries({ \n        queryKey: [\"/api/users/role/tenant\"],\n        refetchType: \"active\"\n      });\n      toast({\n        title: \"Tenant assigned\",\n        description: \"The tenant has been successfully assigned to this property\",\n      });\n      selectForm.reset();\n      createForm.reset();\n      setOpen(false);\n      setMode(\"select\");\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      // Extract error message from the thrown error\n      const errorMessage = error?.message || \"An error occurred while assigning the tenant\";\n      \n      console.error(\"[AddTenantDialog] Tenant assignment error:\", error);\n      toast({\n        title: \"Failed to assign tenant\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSelectSubmit = async (data: SelectTenantFormData) => {\n    assignTenantMutation.mutate({\n      tenantId: data.tenantId,\n      leaseData: data,\n    });\n  };\n\n  const onCreateSubmit = async (data: CreateTenantFormData) => {\n    try {\n      // First create the user\n      const newUser = await createUserMutation.mutateAsync(data);\n      \n      if (!newUser || !newUser.id) {\n        throw new Error(\"User creation failed - no user ID returned\");\n      }\n      \n      console.log(\"User created successfully:\", newUser.id);\n      \n      // Extract only lease-related fields for the assignment\n      const leaseData = {\n        leaseStartDate: data.leaseStartDate,\n        leaseEndDate: data.leaseEndDate,\n        monthlyRent: data.monthlyRent,\n        depositAmount: data.depositAmount,\n        isActive: data.isActive,\n      };\n      \n      console.log(\"Assigning tenant to property:\", { tenantId: newUser.id, leaseData });\n      \n      // Then assign them to the property\n      assignTenantMutation.mutate({\n        tenantId: newUser.id,\n        leaseData,\n      });\n    } catch (error: any) {\n      console.error(\"Failed to create tenant user:\", error);\n      toast({\n        title: \"Failed to create tenant\",\n        description: error.message || \"An error occurred while creating the tenant user\",\n        variant: \"destructive\",\n      });\n      // Return early to prevent assignment attempt\n      return;\n    }\n  };\n\n  const getTenantDisplayName = (user: User) => {\n    const fullName = [user.firstName, user.lastName].filter(Boolean).join(\" \");\n    return fullName || user.email;\n  };\n\n  const isSubmitting = createUserMutation.isPending || assignTenantMutation.isPending;\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>{children}</DialogTrigger>\n      <DialogContent className=\"sm:max-w-[550px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Add Tenant Assignment</DialogTitle>\n          <DialogDescription>\n            {mode === \"select\" \n              ? \"Assign an existing tenant to this property with lease details\"\n              : \"Create a new tenant user and assign them to this property\"\n            }\n          </DialogDescription>\n        </DialogHeader>\n\n        <Tabs value={mode} onValueChange={(v) => setMode(v as \"select\" | \"create\")} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"select\" data-testid=\"tab-select-tenant\">\n              <Users className=\"h-4 w-4 mr-2\" />\n              Select Existing\n            </TabsTrigger>\n            <TabsTrigger value=\"create\" data-testid=\"tab-create-tenant\">\n              <UserPlus className=\"h-4 w-4 mr-2\" />\n              Create New\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"select\" className=\"space-y-4 mt-4\">\n            <Form {...selectForm}>\n              <form onSubmit={selectForm.handleSubmit(onSelectSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={selectForm.control}\n                  name=\"tenantId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Tenant *</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        value={field.value}\n                        disabled={loadingTenants}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-tenant\">\n                            <SelectValue placeholder=\"Select a tenant\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {loadingTenants ? (\n                            <div className=\"flex items-center justify-center p-4\">\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            </div>\n                          ) : tenantUsers.length === 0 ? (\n                            <div className=\"p-4 text-sm text-muted-foreground text-center\">\n                              No tenant users found. Create a new tenant using the \"Create New\" tab.\n                            </div>\n                          ) : (\n                            tenantUsers.map((user) => (\n                              <SelectItem key={user.id} value={user.id}>\n                                {getTenantDisplayName(user)}\n                              </SelectItem>\n                            ))\n                          )}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={selectForm.control}\n                    name=\"leaseStartDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Lease Start Date</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"date\"\n                            {...field}\n                            data-testid=\"input-lease-start\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={selectForm.control}\n                    name=\"leaseEndDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Lease End Date</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"date\"\n                            {...field}\n                            data-testid=\"input-lease-end\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={selectForm.control}\n                    name=\"monthlyRent\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Monthly Rent</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            placeholder=\"0.00\"\n                            {...field}\n                            data-testid=\"input-monthly-rent\"\n                          />\n                        </FormControl>\n                        <FormDescription>In {locale.currency}</FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={selectForm.control}\n                    name=\"depositAmount\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Deposit Amount</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            placeholder=\"0.00\"\n                            {...field}\n                            data-testid=\"input-deposit\"\n                          />\n                        </FormControl>\n                        <FormDescription>In {locale.currency}</FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={selectForm.control}\n                  name=\"isActive\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel className=\"text-base\">Active Status</FormLabel>\n                        <FormDescription>\n                          Mark this tenant assignment as active or inactive\n                        </FormDescription>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-is-active\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={isSubmitting}\n                    data-testid=\"button-submit\"\n                  >\n                    {isSubmitting ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Assigning...\n                      </>\n                    ) : (\n                      \"Assign Tenant\"\n                    )}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </TabsContent>\n\n          <TabsContent value=\"create\" className=\"space-y-4 mt-4\">\n            <Form {...createForm}>\n              <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                <div className=\"space-y-4 p-4 border rounded-lg bg-muted/50\">\n                  <h4 className=\"text-sm font-medium\">Tenant User Details</h4>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>First Name *</FormLabel>\n                          <FormControl>\n                            <Input\n                              placeholder=\"John\"\n                              {...field}\n                              data-testid=\"input-first-name\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={createForm.control}\n                      name=\"lastName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Last Name *</FormLabel>\n                          <FormControl>\n                            <Input\n                              placeholder=\"Doe\"\n                              {...field}\n                              data-testid=\"input-last-name\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email *</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"email\"\n                            placeholder=\"john.doe@example.com\"\n                            {...field}\n                            data-testid=\"input-email\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"username\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Username *</FormLabel>\n                          <FormControl>\n                            <Input\n                              placeholder=\"johndoe\"\n                              {...field}\n                              data-testid=\"input-username\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={createForm.control}\n                      name=\"password\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Password *</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"password\"\n                              placeholder=\"\"\n                              {...field}\n                              data-testid=\"input-password\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <h4 className=\"text-sm font-medium\">Lease Details</h4>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"leaseStartDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Lease Start Date</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"date\"\n                              {...field}\n                              data-testid=\"input-create-lease-start\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={createForm.control}\n                      name=\"leaseEndDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Lease End Date</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"date\"\n                              {...field}\n                              data-testid=\"input-create-lease-end\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"monthlyRent\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Monthly Rent</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              step=\"0.01\"\n                              placeholder=\"0.00\"\n                              {...field}\n                              data-testid=\"input-create-monthly-rent\"\n                            />\n                          </FormControl>\n                          <FormDescription>In {locale.currency}</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={createForm.control}\n                      name=\"depositAmount\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Deposit Amount</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              step=\"0.01\"\n                              placeholder=\"0.00\"\n                              {...field}\n                              data-testid=\"input-create-deposit\"\n                            />\n                          </FormControl>\n                          <FormDescription>In {locale.currency}</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"isActive\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                        <div className=\"space-y-0.5\">\n                          <FormLabel className=\"text-base\">Active Status</FormLabel>\n                          <FormDescription>\n                            Mark this tenant assignment as active or inactive\n                          </FormDescription>\n                        </div>\n                        <FormControl>\n                          <Switch\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"switch-create-is-active\"\n                          />\n                        </FormControl>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setOpen(false)}\n                    data-testid=\"button-create-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={isSubmitting}\n                    data-testid=\"button-create-submit\"\n                  >\n                    {isSubmitting ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Creating...\n                      </>\n                    ) : (\n                      \"Create & Assign Tenant\"\n                    )}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </TabsContent>\n        </Tabs>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":30283},"client/src/pages/PropertyTenants.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  ArrowLeft,\n  Users,\n  Plus,\n  Mail,\n  Phone,\n  Calendar,\n  DollarSign,\n  Edit,\n  Trash2,\n  User,\n  History,\n  FileText\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport AddTenantDialog from \"@/components/AddTenantDialog\";\nimport EditTenantDialog from \"@/components/EditTenantDialog\";\n\ninterface TenantAssignment {\n  id: string;\n  firstName?: string;\n  lastName?: string;\n  email: string;\n  phone?: string;\n  profileImageUrl?: string;\n  role: string;\n  assignment: {\n    id: string;\n    leaseStartDate?: Date | string;\n    leaseEndDate?: Date | string;\n    monthlyRent?: string;\n    depositAmount?: string;\n    isActive: boolean;\n  };\n}\n\ninterface Property {\n  id: string;\n  name: string;\n  address: string;\n  type: string;\n}\n\nexport default function PropertyTenants() {\n  const [, params] = useRoute(\"/properties/:id/tenants\");\n  const propertyId = params?.id;\n  const { toast } = useToast();\n  const locale = useLocale();\n\n  const [activeTab, setActiveTab] = useState<\"active\" | \"historical\">(\"active\");\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedTenant, setSelectedTenant] = useState<TenantAssignment | null>(null);\n\n  const { data: property, isLoading: propertyLoading } = useQuery<Property>({\n    queryKey: [\"/api/properties\", propertyId],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch property\");\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const { data: tenants = [], isLoading: tenantsLoading } = useQuery<TenantAssignment[]>({\n    queryKey: [\"/api/properties\", propertyId, \"tenants\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/properties/${propertyId}/tenants`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch tenants\");\n      return res.json();\n    },\n    enabled: !!propertyId,\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (assignmentId: string) => {\n      const res = await apiRequest(\"DELETE\", `/api/tenant-assignments/${assignmentId}`);\n      return res;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\", propertyId, \"tenants\"] });\n      toast({\n        title: \"Tenant assignment deleted\",\n        description: \"The tenant has been removed from this property\",\n      });\n      setDeleteDialogOpen(false);\n      setSelectedTenant(null);\n    },\n    onError: (error: Error) => {\n      console.error('[PropertyTenants] Delete error:', error);\n      toast({\n        title: \"Failed to delete assignment\",\n        description: error.message || \"An error occurred while removing the tenant\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const activeTenants = tenants.filter((t) => t.assignment.isActive);\n  const historicalTenants = tenants.filter((t) => !t.assignment.isActive);\n\n  const handleDelete = (tenant: TenantAssignment) => {\n    setSelectedTenant(tenant);\n    setDeleteDialogOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (selectedTenant?.assignment.id) {\n      deleteMutation.mutate(selectedTenant.assignment.id);\n    }\n  };\n\n  if (propertyLoading || tenantsLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!property) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Property not found</p>\n          <Link href=\"/properties\">\n            <Button variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Properties\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const TenantCard = ({ tenant, showStatus = false }: { tenant: TenantAssignment; showStatus?: boolean }) => {\n    const fullName = [tenant.firstName, tenant.lastName].filter(Boolean).join(\" \") || \"Unnamed Tenant\";\n    const initials = fullName\n      .split(\" \")\n      .map((n) => n[0])\n      .join(\"\")\n      .toUpperCase()\n      .slice(0, 2);\n\n    const isActive = tenant.assignment.isActive;\n    const leaseStartDate = tenant.assignment.leaseStartDate\n      ? new Date(tenant.assignment.leaseStartDate)\n      : null;\n    const leaseEndDate = tenant.assignment.leaseEndDate ? new Date(tenant.assignment.leaseEndDate) : null;\n    const monthlyRent = tenant.assignment.monthlyRent\n      ? parseFloat(tenant.assignment.monthlyRent)\n      : null;\n    const depositAmount = tenant.assignment.depositAmount\n      ? parseFloat(tenant.assignment.depositAmount)\n      : null;\n\n    return (\n      <Card className=\"hover-elevate\" data-testid={`card-tenant-${tenant.id}`}>\n        <CardHeader>\n          <div className=\"flex items-start justify-between\">\n            <div className=\"flex items-start gap-3 flex-1\">\n              <Avatar className=\"h-12 w-12\">\n                <AvatarImage src={tenant.profileImageUrl} alt={fullName} />\n                <AvatarFallback>{initials}</AvatarFallback>\n              </Avatar>\n              <div className=\"flex-1 min-w-0\">\n                <CardTitle className=\"text-base\">{fullName}</CardTitle>\n                <div className=\"space-y-1 mt-2\">\n                  {tenant.email && (\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Mail className=\"h-4 w-4 shrink-0\" />\n                      <span className=\"truncate\">{tenant.email}</span>\n                    </div>\n                  )}\n                  {tenant.phone && (\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Phone className=\"h-4 w-4 shrink-0\" />\n                      <span>{tenant.phone}</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            {showStatus && (\n              <Badge variant={isActive ? \"default\" : \"secondary\"}>\n                {isActive ? \"Active\" : \"Inactive\"}\n              </Badge>\n            )}\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {(leaseStartDate || leaseEndDate) && (\n            <div className=\"flex items-start gap-2 text-sm\">\n              <Calendar className=\"h-4 w-4 text-muted-foreground shrink-0 mt-0.5\" />\n              <div>\n                <div className=\"text-muted-foreground text-xs\">Lease Period</div>\n                <div>\n                  {leaseStartDate && format(leaseStartDate, \"MMM d, yyyy\")}\n                  {leaseStartDate && leaseEndDate && \" - \"}\n                  {leaseEndDate && format(leaseEndDate, \"MMM d, yyyy\")}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {(monthlyRent !== null || depositAmount !== null) && (\n            <div className=\"flex items-start gap-2 text-sm\">\n              <DollarSign className=\"h-4 w-4 text-muted-foreground shrink-0 mt-0.5\" />\n              <div className=\"space-y-1\">\n                {monthlyRent !== null && (\n                  <div>\n                    <span className=\"text-muted-foreground text-xs\">Monthly Rent: </span>\n                    <span className=\"font-medium\">\n                      {locale.formatCurrency(monthlyRent * 100, false)}\n                    </span>\n                  </div>\n                )}\n                {depositAmount !== null && (\n                  <div>\n                    <span className=\"text-muted-foreground text-xs\">Deposit: </span>\n                    <span className=\"font-medium\">\n                      {locale.formatCurrency(depositAmount * 100, false)}\n                    </span>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex gap-2 pt-2 border-t\">\n            <EditTenantDialog propertyId={propertyId!} tenant={tenant}>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"flex-1\"\n                data-testid={`button-edit-${tenant.id}`}\n              >\n                <Edit className=\"h-4 w-4 mr-2\" />\n                Edit\n              </Button>\n            </EditTenantDialog>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => handleDelete(tenant)}\n              data-testid={`button-delete-${tenant.id}`}\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div>\n        <Link href=\"/properties\">\n          <Button variant=\"ghost\" className=\"mb-4\" data-testid=\"button-back-to-properties\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to Properties\n          </Button>\n        </Link>\n\n        <div className=\"flex items-start justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n              <Users className=\"h-8 w-8 text-primary\" />\n              Tenant Management\n            </h1>\n            <p className=\"text-muted-foreground mt-2\">\n              {property.name} - {property.address}\n            </p>\n          </div>\n\n          <AddTenantDialog propertyId={propertyId!}>\n            <Button data-testid=\"button-add-tenant\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Tenant\n            </Button>\n          </AddTenantDialog>\n        </div>\n      </div>\n\n      {/* Stats Summary */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-active-tenants\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Tenants</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeTenants.length}</div>\n            <p className=\"text-xs text-muted-foreground\">Currently assigned</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-historical-tenants\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Historical Records</CardTitle>\n            <History className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{historicalTenants.length}</div>\n            <p className=\"text-xs text-muted-foreground\">Past assignments</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-monthly-revenue\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Monthly Revenue</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {locale.formatCurrency(\n                activeTenants\n                  .reduce((sum, t) => sum + (t.assignment.monthlyRent ? parseFloat(t.assignment.monthlyRent) : 0), 0) * 100,\n                false\n              )}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">From active leases</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Tenants List with Tabs */}\n      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \"active\" | \"historical\")}>\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"active\" data-testid=\"tab-active\">\n            <User className=\"h-4 w-4 mr-2\" />\n            Active Tenants ({activeTenants.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"historical\" data-testid=\"tab-historical\">\n            <History className=\"h-4 w-4 mr-2\" />\n            Historical ({historicalTenants.length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"active\" className=\"space-y-4 mt-6\">\n          {activeTenants.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <Users className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No active tenants</h3>\n                <p className=\"text-muted-foreground text-center mb-4\">\n                  Add a tenant to start tracking their lease and rental information\n                </p>\n                <AddTenantDialog propertyId={propertyId!}>\n                  <Button data-testid=\"button-add-first-tenant\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Add First Tenant\n                  </Button>\n                </AddTenantDialog>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {activeTenants.map((tenant) => (\n                <TenantCard key={tenant.id} tenant={tenant} />\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"historical\" className=\"space-y-4 mt-6\">\n          {historicalTenants.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No historical records</h3>\n                <p className=\"text-muted-foreground text-center\">\n                  Past tenant assignments will appear here\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {historicalTenants.map((tenant) => (\n                <TenantCard key={tenant.id} tenant={tenant} showStatus />\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Remove Tenant Assignment?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will remove{\" \"}\n              {selectedTenant && [selectedTenant.firstName, selectedTenant.lastName].filter(Boolean).join(\" \")}{\" \"}\n              from this property. This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Remove Tenant\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":16101},"server/defaultTemplates.ts":{"content":"// Default inspection templates for new organizations\n// These templates are automatically created when a new organization is set up\n// Comprehensive BTR (Build-to-Rent) templates covering all operational inspection needs\n\nexport const DEFAULT_TEMPLATES = [\n  {\n    name: \"Check In\",\n    description: \"To document the condition of a property at the start of a tenancy, recording evidence (photos, notes, etc.) of the property's state as handed over to the tenant.\\n\\nThis report establishes a baseline for future Check-Out and Maintenance inspections.\",\n    scope: \"property\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general_info\",\n          title: \"General Information\",\n          fields: [\n            {\n              id: \"field_checkin_property_address\",\n              key: \"field_checkin_property_address\",\n              label: \"Property Address\",\n              type: \"long_text\",\n              required: true,\n            },\n            {\n              id: \"field_checkin_tenant_name\",\n              key: \"field_checkin_tenant_name\",\n              label: \"Tenant Name\",\n              type: \"long_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkin_inspection_date\",\n              key: \"field_checkin_inspection_date\",\n              label: \"Date of Inspection\",\n              type: \"date\",\n              required: true,\n            },\n            {\n              id: \"field_checkin_inspector_name\",\n              key: \"field_checkin_inspector_name\",\n              label: \"Inspector Name\",\n              type: \"long_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkin_num_bedrooms\",\n              key: \"field_checkin_num_bedrooms\",\n              label: \"Number of Bedrooms\",\n              type: \"number\",\n              required: true,\n            },\n            {\n              id: \"field_checkin_property_type\",\n              key: \"field_checkin_property_type\",\n              label: \"Property Type\",\n              type: \"select\",\n              required: true,\n              options: [\"House\", \"Apartment\", \"Townhouse\", \"Unit\", \"Studio\", \"Other\"],\n            },\n          ],\n        },\n        {\n          id: \"section_entry_hallway\",\n          title: \"Entry / Hallway\",\n          fields: [\n            {\n              id: \"field_checkin_entry_condition\",\n              key: \"field_checkin_entry_condition\",\n              label: \"Condition of the Entry / Hallway\",\n              type: \"photo\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_living_room\",\n          title: \"Living Room\",\n          fields: [\n            {\n              id: \"field_checkin_living_room_condition\",\n              key: \"field_checkin_living_room_condition\",\n              label: \"Living Room Condition\",\n              type: \"photo\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_kitchen\",\n          title: \"Kitchen\",\n          fields: [\n            {\n              id: \"field_checkin_kitchen_condition\",\n              key: \"field_checkin_kitchen_condition\",\n              label: \"Kitchen Condition\",\n              type: \"photo\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_bedrooms\",\n          title: \"Bedrooms\",\n          repeatable: true,\n          fields: [\n            {\n              id: \"field_checkin_bedroom_condition\",\n              key: \"field_checkin_bedroom_condition\",\n              label: \"Bedroom Condition\",\n              type: \"photo\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_bathrooms\",\n          title: \"Bathrooms\",\n          repeatable: true,\n          fields: [\n            {\n              id: \"field_checkin_bathroom_condition\",\n              key: \"field_checkin_bathroom_condition\",\n              label: \"Bathroom Condition\",\n              type: \"photo\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_signoff\",\n          title: \"Sign-Off\",\n          fields: [\n            {\n              id: \"field_checkin_inspector_signature\",\n              key: \"field_checkin_inspector_signature\",\n              label: \"Inspector Signature\",\n              type: \"signature\",\n              required: false,\n            },\n            {\n              id: \"field_checkin_tenant_signature\",\n              key: \"field_checkin_tenant_signature\",\n              label: \"Tenant Signature\",\n              type: \"signature\",\n              required: false,\n            },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Check Out\",\n    description: \"A Check-Out Inspection is carried out at the end of a tenancy to assess the property's condition compared to the initial Check-In report. This inspection helps determine if the tenant is liable for any damage or excessive wear beyond normal use.\",\n    scope: \"property\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general_info\",\n          title: \"General Information\",\n          fields: [\n            {\n              id: \"field_checkout_property_address\",\n              key: \"field_checkout_property_address\",\n              label: \"Property Address\",\n              type: \"short_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_tenant_name\",\n              key: \"field_checkout_tenant_name\",\n              label: \"Tenant Name\",\n              type: \"short_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_inspection_date\",\n              key: \"field_checkout_inspection_date\",\n              label: \"Date of Inspection\",\n              type: \"date\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_inspector_name\",\n              key: \"field_checkout_inspector_name\",\n              label: \"Inspector's Name\",\n              type: \"short_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_num_bedrooms\",\n              key: \"field_checkout_num_bedrooms\",\n              label: \"Number of Bedrooms\",\n              type: \"number\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_entry_hallway\",\n          title: \"Entry Hallway\",\n          fields: [\n            {\n              id: \"field_checkout_entry_door_condition\",\n              key: \"field_checkout_entry_door_condition\",\n              label: \"Door Condition\",\n              type: \"photo_array\",\n              required: false,\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n            {\n              id: \"field_checkout_entry_floor_condition\",\n              key: \"field_checkout_entry_floor_condition\",\n              label: \"Floor Condition\",\n              type: \"photo_array\",\n              required: false,\n              options: [\"Carpet\", \"Wooden Flooring\", \"Laminate\", \"Tile\"],\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n            {\n              id: \"field_checkout_entry_comments\",\n              key: \"field_checkout_entry_comments\",\n              label: \"Comments\",\n              type: \"long_text\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_living_room\",\n          title: \"Living Room\",\n          fields: [\n            {\n              id: \"field_checkout_living_floor_condition\",\n              key: \"field_checkout_living_floor_condition\",\n              label: \"Floor Condition\",\n              type: \"photo_array\",\n              required: false,\n              options: [\"Carpet\", \"Tile\", \"Wooden Floor\", \"Laminate\"],\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n            {\n              id: \"field_checkout_living_walls_paint\",\n              key: \"field_checkout_living_walls_paint\",\n              label: \"Walls and Paint\",\n              type: \"photo_array\",\n              required: false,\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n            {\n              id: \"field_checkout_living_comments\",\n              key: \"field_checkout_living_comments\",\n              label: \"Comments\",\n              type: \"long_text\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_kitchen\",\n          title: \"Kitchen\",\n          fields: [\n            {\n              id: \"field_checkout_kitchen_condition\",\n              key: \"field_checkout_kitchen_condition\",\n              label: \"Kitchen Condition\",\n              type: \"photo_array\",\n              required: false,\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n          ],\n        },\n        {\n          id: \"section_bedroom\",\n          title: \"Bedroom\",\n          repeatable: true,\n          fields: [\n            {\n              id: \"field_checkout_bedroom_room_name\",\n              key: \"field_checkout_bedroom_room_name\",\n              label: \"Room Name / Number\",\n              type: \"short_text\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_bedroom_floor_condition\",\n              key: \"field_checkout_bedroom_floor_condition\",\n              label: \"Floor Condition\",\n              type: \"photo_array\",\n              required: false,\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n            {\n              id: \"field_checkout_bedroom_comments\",\n              key: \"field_checkout_bedroom_comments\",\n              label: \"Comments\",\n              type: \"long_text\",\n              required: false,\n            },\n          ],\n        },\n        {\n          id: \"section_bathroom\",\n          title: \"Bathroom\",\n          repeatable: true,\n          fields: [\n            {\n              id: \"field_checkout_bathroom_condition\",\n              key: \"field_checkout_bathroom_condition\",\n              label: \"Bathroom Condition\",\n              type: \"photo_array\",\n              required: false,\n              includeCondition: true,\n              includeCleanliness: true,\n            },\n          ],\n        },\n        {\n          id: \"section_signoff\",\n          title: \"Sign Off\",\n          fields: [\n            {\n              id: \"field_checkout_tenant_signature\",\n              key: \"field_checkout_tenant_signature\",\n              label: \"Tenant Signature\",\n              type: \"signature\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_inspector_signature\",\n              key: \"field_checkout_inspector_signature\",\n              label: \"Inspector Signature\",\n              type: \"signature\",\n              required: false,\n            },\n            {\n              id: \"field_checkout_next_inspection\",\n              key: \"field_checkout_next_inspection\",\n              label: \"Next Scheduled Inspection\",\n              type: \"date\",\n              required: false,\n            },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Periodic Inspection\",\n    description: \"A routine inspection conducted quarterly or annually to assess the overall condition of the property, ensure tenant compliance with lease terms, and identify any maintenance issues requiring attention.\\n\\nThis inspection helps maintain property standards and prevents minor issues from becoming major problems.\",\n    scope: \"property\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_periodic_property\", key: \"field_periodic_property\", label: \"Property Address\", type: \"short_text\", required: true },\n            { id: \"field_periodic_date\", key: \"field_periodic_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_periodic_inspector\", key: \"field_periodic_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n            { id: \"field_periodic_tenant_present\", key: \"field_periodic_tenant_present\", label: \"Tenant Present\", type: \"select\", options: [\"Yes\", \"No\"], required: false },\n          ],\n        },\n        {\n          id: \"section_exterior\",\n          title: \"Exterior Condition\",\n          fields: [\n            { id: \"field_periodic_ext_walls\", key: \"field_periodic_ext_walls\", label: \"External Walls\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_periodic_roof\", key: \"field_periodic_roof\", label: \"Roof Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_periodic_gutters\", key: \"field_periodic_gutters\", label: \"Gutters and Downpipes\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_periodic_windows\", key: \"field_periodic_windows\", label: \"Windows and Frames\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_periodic_doors\", key: \"field_periodic_doors\", label: \"External Doors\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_interior\",\n          title: \"Interior Condition\",\n          fields: [\n            { id: \"field_periodic_walls\", key: \"field_periodic_walls\", label: \"Walls and Ceilings\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_periodic_flooring\", key: \"field_periodic_flooring\", label: \"Flooring\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_periodic_fixtures\", key: \"field_periodic_fixtures\", label: \"Fixtures and Fittings\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_periodic_heating\", key: \"field_periodic_heating\", label: \"Heating System\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_safety\",\n          title: \"Safety Checks\",\n          fields: [\n            { id: \"field_periodic_smoke\", key: \"field_periodic_smoke\", label: \"Smoke Alarms Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: true },\n            { id: \"field_periodic_co\", key: \"field_periodic_co\", label: \"CO Detectors Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: true },\n            { id: \"field_periodic_locks\", key: \"field_periodic_locks\", label: \"Door Locks Functional\", type: \"select\", options: [\"Yes\", \"No\"], required: false },\n          ],\n        },\n        {\n          id: \"section_tenancy\",\n          title: \"Tenancy Compliance\",\n          fields: [\n            { id: \"field_periodic_overcrowding\", key: \"field_periodic_overcrowding\", label: \"Signs of Overcrowding\", type: \"select\", options: [\"No\", \"Yes - Concerns Noted\"], required: false },\n            { id: \"field_periodic_pets\", key: \"field_periodic_pets\", label: \"Unauthorized Pets\", type: \"select\", options: [\"None\", \"Noted\"], required: false },\n            { id: \"field_periodic_alterations\", key: \"field_periodic_alterations\", label: \"Unauthorized Alterations\", type: \"select\", options: [\"None\", \"Noted\"], required: false },\n            { id: \"field_periodic_compliance_notes\", key: \"field_periodic_compliance_notes\", label: \"Compliance Notes\", type: \"long_text\", required: false },\n          ],\n        },\n        {\n          id: \"section_summary\",\n          title: \"Summary and Actions\",\n          fields: [\n            { id: \"field_periodic_overall\", key: \"field_periodic_overall\", label: \"Overall Property Condition\", type: \"select\", options: [\"Excellent\", \"Good\", \"Fair\", \"Poor\"], required: true },\n            { id: \"field_periodic_actions\", key: \"field_periodic_actions\", label: \"Actions Required\", type: \"long_text\", required: false },\n            { id: \"field_periodic_next\", key: \"field_periodic_next\", label: \"Next Inspection Date\", type: \"date\", required: false },\n            { id: \"field_periodic_signature\", key: \"field_periodic_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Fire Safety Inspection\",\n    description: \"A dedicated fire safety inspection to ensure all fire prevention equipment and procedures are compliant with regulations. Essential for BTR operations to maintain tenant safety and legal compliance.\\n\\nCovers fire alarms, extinguishers, emergency exits, signage, and evacuation routes.\",\n    scope: \"block\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_fire_block\", key: \"field_fire_block\", label: \"Block/Building Name\", type: \"short_text\", required: true },\n            { id: \"field_fire_date\", key: \"field_fire_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_fire_inspector\", key: \"field_fire_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n            { id: \"field_fire_last_inspection\", key: \"field_fire_last_inspection\", label: \"Last Inspection Date\", type: \"date\", required: false },\n          ],\n        },\n        {\n          id: \"section_alarms\",\n          title: \"Fire Alarms and Detection\",\n          fields: [\n            { id: \"field_fire_alarm_system\", key: \"field_fire_alarm_system\", label: \"Fire Alarm System Type\", type: \"short_text\", required: false },\n            { id: \"field_fire_alarm_test\", key: \"field_fire_alarm_test\", label: \"Alarm System Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: true },\n            { id: \"field_fire_alarm_photo\", key: \"field_fire_alarm_photo\", label: \"Fire Alarm Panel Photo\", type: \"photo_array\", required: false },\n            { id: \"field_fire_smoke_detectors\", key: \"field_fire_smoke_detectors\", label: \"Smoke Detectors\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_fire_heat_detectors\", key: \"field_fire_heat_detectors\", label: \"Heat Detectors\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_fire_alarm_notes\", key: \"field_fire_alarm_notes\", label: \"Alarm System Notes\", type: \"long_text\", required: false },\n          ],\n        },\n        {\n          id: \"section_extinguishers\",\n          title: \"Fire Extinguishers\",\n          repeatable: true,\n          fields: [\n            { id: \"field_fire_ext_location\", key: \"field_fire_ext_location\", label: \"Location\", type: \"short_text\", required: false },\n            { id: \"field_fire_ext_type\", key: \"field_fire_ext_type\", label: \"Extinguisher Type\", type: \"select\", options: [\"Water\", \"Foam\", \"CO2\", \"Powder\", \"Wet Chemical\"], required: false },\n            { id: \"field_fire_ext_expiry\", key: \"field_fire_ext_expiry\", label: \"Service Due Date\", type: \"date\", required: false },\n            { id: \"field_fire_ext_photo\", key: \"field_fire_ext_photo\", label: \"Photo\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_fire_ext_status\", key: \"field_fire_ext_status\", label: \"Status\", type: \"select\", options: [\"Serviceable\", \"Requires Service\", \"Faulty\"], required: true },\n          ],\n        },\n        {\n          id: \"section_exits\",\n          title: \"Emergency Exits and Routes\",\n          fields: [\n            { id: \"field_fire_exit_clear\", key: \"field_fire_exit_clear\", label: \"All Exits Clear and Accessible\", type: \"select\", options: [\"Yes\", \"No - Issues Noted\"], required: true },\n            { id: \"field_fire_exit_photos\", key: \"field_fire_exit_photos\", label: \"Exit Route Photos\", type: \"photo_array\", required: false },\n            { id: \"field_fire_exit_signage\", key: \"field_fire_exit_signage\", label: \"Exit Signage Visible\", type: \"select\", options: [\"Yes\", \"No - Issues Noted\"], required: true },\n            { id: \"field_fire_emergency_lights\", key: \"field_fire_emergency_lights\", label: \"Emergency Lighting Functional\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: true },\n            { id: \"field_fire_exit_notes\", key: \"field_fire_exit_notes\", label: \"Exit/Route Notes\", type: \"long_text\", required: false },\n          ],\n        },\n        {\n          id: \"section_doors\",\n          title: \"Fire Doors\",\n          fields: [\n            { id: \"field_fire_doors_close\", key: \"field_fire_doors_close\", label: \"Fire Doors Self-Closing\", type: \"select\", options: [\"Yes - All Functional\", \"Some Issues\", \"No - Attention Required\"], required: true },\n            { id: \"field_fire_doors_seals\", key: \"field_fire_doors_seals\", label: \"Door Seals Intact\", type: \"select\", options: [\"Yes\", \"No - Replacement Needed\"], required: false },\n            { id: \"field_fire_doors_photos\", key: \"field_fire_doors_photos\", label: \"Fire Door Photos\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_fire_doors_notes\", key: \"field_fire_doors_notes\", label: \"Fire Door Notes\", type: \"long_text\", required: false },\n          ],\n        },\n        {\n          id: \"section_compliance\",\n          title: \"Compliance and Documentation\",\n          fields: [\n            { id: \"field_fire_risk_assessment\", key: \"field_fire_risk_assessment\", label: \"Fire Risk Assessment Up to Date\", type: \"select\", options: [\"Yes\", \"No\", \"N/A\"], required: false },\n            { id: \"field_fire_procedures\", key: \"field_fire_procedures\", label: \"Emergency Procedures Displayed\", type: \"select\", options: [\"Yes\", \"No\"], required: false },\n            { id: \"field_fire_overall\", key: \"field_fire_overall\", label: \"Overall Fire Safety Rating\", type: \"select\", options: [\"Compliant\", \"Minor Issues\", \"Major Issues\", \"Non-Compliant\"], required: true },\n            { id: \"field_fire_actions\", key: \"field_fire_actions\", label: \"Actions Required\", type: \"long_text\", required: false },\n            { id: \"field_fire_signature\", key: \"field_fire_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Health & Safety Inspection\",\n    description: \"Comprehensive health and safety inspection covering building safety, potential hazards, accessibility, and compliance with health regulations.\\n\\nEssential for maintaining BTR property standards and ensuring tenant wellbeing.\",\n    scope: \"block\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_hs_block\", key: \"field_hs_block\", label: \"Block/Building Name\", type: \"short_text\", required: true },\n            { id: \"field_hs_date\", key: \"field_hs_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_hs_inspector\", key: \"field_hs_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n          ],\n        },\n        {\n          id: \"section_structure\",\n          title: \"Structural Safety\",\n          fields: [\n            { id: \"field_hs_walls\", key: \"field_hs_walls\", label: \"Walls and Structure\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_cracks\", key: \"field_hs_cracks\", label: \"Cracks or Structural Damage\", type: \"select\", options: [\"None\", \"Minor\", \"Major - Urgent\"], required: true },\n            { id: \"field_hs_damp\", key: \"field_hs_damp\", label: \"Signs of Damp or Mold\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_ceiling\", key: \"field_hs_ceiling\", label: \"Ceiling Condition\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_electrical\",\n          title: \"Electrical Safety\",\n          fields: [\n            { id: \"field_hs_electrical_cert\", key: \"field_hs_electrical_cert\", label: \"Electrical Certificates Valid\", type: \"select\", options: [\"Yes\", \"No\", \"Unknown\"], required: false },\n            { id: \"field_hs_consumer_unit\", key: \"field_hs_consumer_unit\", label: \"Consumer Unit/Fuse Box\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_sockets\", key: \"field_hs_sockets\", label: \"Visible Socket Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_electrical_hazards\", key: \"field_hs_electrical_hazards\", label: \"Electrical Hazards Identified\", type: \"select\", options: [\"None\", \"Minor Issues\", \"Major Hazards\"], required: true },\n          ],\n        },\n        {\n          id: \"section_gas\",\n          title: \"Gas Safety\",\n          fields: [\n            { id: \"field_hs_gas_cert\", key: \"field_hs_gas_cert\", label: \"Gas Safety Certificate Valid\", type: \"select\", options: [\"Yes\", \"No\", \"N/A - No Gas\"], required: false },\n            { id: \"field_hs_boiler\", key: \"field_hs_boiler\", label: \"Boiler Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_gas_appliances\", key: \"field_hs_gas_appliances\", label: \"Gas Appliances\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_ventilation\", key: \"field_hs_ventilation\", label: \"Ventilation Adequate\", type: \"select\", options: [\"Yes\", \"No - Improvement Needed\"], required: false },\n          ],\n        },\n        {\n          id: \"section_water\",\n          title: \"Water Safety and Legionella\",\n          fields: [\n            { id: \"field_hs_water_temp\", key: \"field_hs_water_temp\", label: \"Hot Water Temperature Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: false },\n            { id: \"field_hs_water_storage\", key: \"field_hs_water_storage\", label: \"Water Storage Tanks\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_legionella\", key: \"field_hs_legionella\", label: \"Legionella Risk Assessment Up to Date\", type: \"select\", options: [\"Yes\", \"No\", \"N/A\"], required: false },\n            { id: \"field_hs_taps\", key: \"field_hs_taps\", label: \"Taps and Showers\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_access\",\n          title: \"Access and Mobility\",\n          fields: [\n            { id: \"field_hs_access_routes\", key: \"field_hs_access_routes\", label: \"Accessible Routes Clear\", type: \"select\", options: [\"Yes\", \"No - Obstructions\"], required: false },\n            { id: \"field_hs_handrails\", key: \"field_hs_handrails\", label: \"Handrails Secure\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_stairs\", key: \"field_hs_stairs\", label: \"Stairs and Steps\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_hs_lighting\", key: \"field_hs_lighting\", label: \"Lighting Adequate\", type: \"select\", options: [\"Yes\", \"No - Improvement Needed\"], required: false },\n          ],\n        },\n        {\n          id: \"section_summary\",\n          title: \"Summary and Actions\",\n          fields: [\n            { id: \"field_hs_overall\", key: \"field_hs_overall\", label: \"Overall H&S Rating\", type: \"select\", options: [\"Compliant\", \"Minor Issues\", \"Major Issues\", \"Non-Compliant\"], required: true },\n            { id: \"field_hs_priority\", key: \"field_hs_priority\", label: \"Urgent Actions Required\", type: \"long_text\", required: false },\n            { id: \"field_hs_recommendations\", key: \"field_hs_recommendations\", label: \"Recommendations\", type: \"long_text\", required: false },\n            { id: \"field_hs_next_inspection\", key: \"field_hs_next_inspection\", label: \"Next Inspection Due\", type: \"date\", required: false },\n            { id: \"field_hs_signature\", key: \"field_hs_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Common Area Inspection\",\n    description: \"Inspection of shared communal spaces including lobbies, hallways, stairs, lifts, gardens, and amenity areas.\\n\\nMaintains BTR property standards and ensures shared facilities are well-maintained for all residents.\",\n    scope: \"block\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_common_block\", key: \"field_common_block\", label: \"Block/Building Name\", type: \"short_text\", required: true },\n            { id: \"field_common_date\", key: \"field_common_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_common_inspector\", key: \"field_common_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n          ],\n        },\n        {\n          id: \"section_entrance\",\n          title: \"Main Entrance and Reception\",\n          fields: [\n            { id: \"field_common_entrance_doors\", key: \"field_common_entrance_doors\", label: \"Entrance Doors\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_entrance_floor\", key: \"field_common_entrance_floor\", label: \"Floor/Matting\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_reception\", key: \"field_common_reception\", label: \"Reception Area\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_signage\", key: \"field_common_signage\", label: \"Building Signage\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_corridors\",\n          title: \"Corridors and Hallways\",\n          fields: [\n            { id: \"field_common_corridor_walls\", key: \"field_common_corridor_walls\", label: \"Walls and Decoration\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_corridor_floor\", key: \"field_common_corridor_floor\", label: \"Floor Covering\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_corridor_lights\", key: \"field_common_corridor_lights\", label: \"Lighting Functional\", type: \"select\", options: [\"All Working\", \"Some Out\", \"Multiple Out\"], required: false },\n            { id: \"field_common_corridor_clutter\", key: \"field_common_corridor_clutter\", label: \"Corridors Clear of Obstructions\", type: \"select\", options: [\"Yes\", \"No - Items Noted\"], required: false },\n          ],\n        },\n        {\n          id: \"section_stairs\",\n          title: \"Staircases\",\n          fields: [\n            { id: \"field_common_stairs_condition\", key: \"field_common_stairs_condition\", label: \"Staircase Condition\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_stairs_handrails\", key: \"field_common_stairs_handrails\", label: \"Handrails Secure\", type: \"select\", options: [\"Yes\", \"No - Repair Needed\"], required: false },\n            { id: \"field_common_stairs_lighting\", key: \"field_common_stairs_lighting\", label: \"Stairwell Lighting\", type: \"select\", options: [\"Adequate\", \"Poor - Improvement Needed\"], required: false },\n            { id: \"field_common_stairs_safety\", key: \"field_common_stairs_safety\", label: \"Safety Hazards\", type: \"select\", options: [\"None\", \"Hazards Identified\"], required: false },\n          ],\n        },\n        {\n          id: \"section_lifts\",\n          title: \"Lifts/Elevators\",\n          fields: [\n            { id: \"field_common_lift_operational\", key: \"field_common_lift_operational\", label: \"Lift Operational\", type: \"select\", options: [\"Yes\", \"No - Out of Service\"], required: false },\n            { id: \"field_common_lift_interior\", key: \"field_common_lift_interior\", label: \"Lift Interior\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_lift_buttons\", key: \"field_common_lift_buttons\", label: \"Buttons and Controls\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_common_lift_cert\", key: \"field_common_lift_cert\", label: \"Service Certificate Displayed\", type: \"select\", options: [\"Yes\", \"No\", \"Out of Date\"], required: false },\n          ],\n        },\n        {\n          id: \"section_facilities\",\n          title: \"Communal Facilities\",\n          fields: [\n            { id: \"field_common_lounge\", key: \"field_common_lounge\", label: \"Communal Lounge\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_gym\", key: \"field_common_gym\", label: \"Gym/Fitness Area\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_laundry\", key: \"field_common_laundry\", label: \"Laundry Room\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_bike\", key: \"field_common_bike\", label: \"Bike Storage\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_external\",\n          title: \"External Areas\",\n          fields: [\n            { id: \"field_common_grounds\", key: \"field_common_grounds\", label: \"Grounds and Landscaping\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_bins\", key: \"field_common_bins\", label: \"Bin Storage Area\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_parking\", key: \"field_common_parking\", label: \"Car Park\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_common_external_lights\", key: \"field_common_external_lights\", label: \"External Lighting\", type: \"select\", options: [\"All Working\", \"Some Out\", \"Not Tested\"], required: false },\n          ],\n        },\n        {\n          id: \"section_summary\",\n          title: \"Summary and Actions\",\n          fields: [\n            { id: \"field_common_overall\", key: \"field_common_overall\", label: \"Overall Condition\", type: \"select\", options: [\"Excellent\", \"Good\", \"Fair\", \"Poor\"], required: true },\n            { id: \"field_common_cleaning\", key: \"field_common_cleaning\", label: \"Cleaning Standard\", type: \"select\", options: [\"Excellent\", \"Good\", \"Fair\", \"Poor\"], required: false },\n            { id: \"field_common_actions\", key: \"field_common_actions\", label: \"Actions Required\", type: \"long_text\", required: false },\n            { id: \"field_common_signature\", key: \"field_common_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Void Property Inspection\",\n    description: \"Comprehensive inspection of vacant properties between tenancies. Documents the full condition to prepare for new tenants and identifies all required works.\\n\\nEssential for BTR turnover management and ensuring properties meet letting standards.\",\n    scope: \"property\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_void_property\", key: \"field_void_property\", label: \"Property Address\", type: \"short_text\", required: true },\n            { id: \"field_void_date\", key: \"field_void_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_void_inspector\", key: \"field_void_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n            { id: \"field_void_vacant_since\", key: \"field_void_vacant_since\", label: \"Vacant Since\", type: \"date\", required: false },\n          ],\n        },\n        {\n          id: \"section_keys\",\n          title: \"Keys and Access\",\n          fields: [\n            { id: \"field_void_keys\", key: \"field_void_keys\", label: \"All Keys Received\", type: \"select\", options: [\"Yes - Complete Set\", \"No - Missing Keys\"], required: true },\n            { id: \"field_void_locks\", key: \"field_void_locks\", label: \"Lock Change Required\", type: \"select\", options: [\"No\", \"Yes - Recommended\"], required: false },\n            { id: \"field_void_meter_readings\", key: \"field_void_meter_readings\", label: \"Meter Readings Taken\", type: \"select\", options: [\"Yes\", \"No\"], required: false },\n          ],\n        },\n        {\n          id: \"section_decoration\",\n          title: \"Decoration and Repairs\",\n          fields: [\n            { id: \"field_void_walls\", key: \"field_void_walls\", label: \"Walls - Paint Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_void_ceilings\", key: \"field_void_ceilings\", label: \"Ceilings\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_void_woodwork\", key: \"field_void_woodwork\", label: \"Woodwork/Skirting\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_void_flooring\", key: \"field_void_flooring\", label: \"Flooring\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_void_decoration_grade\", key: \"field_void_decoration_grade\", label: \"Decoration Standard\", type: \"select\", options: [\"Excellent - Let Ready\", \"Good - Minor Touch-ups\", \"Fair - Repaint Required\", \"Poor - Full Redec Needed\"], required: true },\n          ],\n        },\n        {\n          id: \"section_kitchen\",\n          title: \"Kitchen\",\n          fields: [\n            { id: \"field_void_kitchen_units\", key: \"field_void_kitchen_units\", label: \"Kitchen Units\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_kitchen_worktop\", key: \"field_void_kitchen_worktop\", label: \"Worktops\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_kitchen_sink\", key: \"field_void_kitchen_sink\", label: \"Sink and Taps\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_kitchen_appliances\", key: \"field_void_kitchen_appliances\", label: \"White Goods/Appliances\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_void_kitchen_deep_clean\", key: \"field_void_kitchen_deep_clean\", label: \"Deep Clean Required\", type: \"select\", options: [\"No\", \"Yes\"], required: false },\n          ],\n        },\n        {\n          id: \"section_bathroom\",\n          title: \"Bathroom\",\n          repeatable: true,\n          fields: [\n            { id: \"field_void_bath_suite\", key: \"field_void_bath_suite\", label: \"Bathroom Suite\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_bath_tiling\", key: \"field_void_bath_tiling\", label: \"Tiling and Grouting\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_bath_shower\", key: \"field_void_bath_shower\", label: \"Shower/Bath\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_void_bath_sealant\", key: \"field_void_bath_sealant\", label: \"Sealant Condition\", type: \"select\", options: [\"Good\", \"Replacement Needed\"], required: false },\n          ],\n        },\n        {\n          id: \"section_services\",\n          title: \"Services and Safety\",\n          fields: [\n            { id: \"field_void_heating\", key: \"field_void_heating\", label: \"Heating System Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Not Tested\"], required: false },\n            { id: \"field_void_electric\", key: \"field_void_electric\", label: \"Electrical Test Due\", type: \"date\", required: false },\n            { id: \"field_void_gas\", key: \"field_void_gas\", label: \"Gas Safety Due\", type: \"date\", required: false },\n            { id: \"field_void_smoke_alarms\", key: \"field_void_smoke_alarms\", label: \"Smoke Alarms Tested\", type: \"select\", options: [\"Pass\", \"Fail\", \"Replacement Needed\"], required: false },\n          ],\n        },\n        {\n          id: \"section_schedule\",\n          title: \"Works Schedule\",\n          fields: [\n            { id: \"field_void_works_required\", key: \"field_void_works_required\", label: \"Works Required\", type: \"long_text\", required: false },\n            { id: \"field_void_priority\", key: \"field_void_priority\", label: \"Priority Level\", type: \"select\", options: [\"Urgent - Immediate\", \"High - Within 1 Week\", \"Medium - Within 2 Weeks\", \"Low - Before Relet\"], required: true },\n            { id: \"field_void_estimated_days\", key: \"field_void_estimated_days\", label: \"Estimated Days to Complete\", type: \"number\", required: false },\n            { id: \"field_void_lettable\", key: \"field_void_lettable\", label: \"Lettable Standard\", type: \"select\", options: [\"Yes - Let Ready\", \"No - Works Required\"], required: true },\n            { id: \"field_void_signature\", key: \"field_void_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n  {\n    name: \"Block Inspection\",\n    description: \"Comprehensive block/building-level inspection covering external structure, building systems, grounds, and overall property condition.\\n\\nMaintains BTR asset value and ensures building-wide compliance and maintenance standards.\",\n    scope: \"block\" as const,\n    categoryId: null,\n    structureJson: {\n      sections: [\n        {\n          id: \"section_general\",\n          title: \"General Information\",\n          fields: [\n            { id: \"field_block_name\", key: \"field_block_name\", label: \"Block/Building Name\", type: \"short_text\", required: true },\n            { id: \"field_block_date\", key: \"field_block_date\", label: \"Inspection Date\", type: \"date\", required: true },\n            { id: \"field_block_inspector\", key: \"field_block_inspector\", label: \"Inspector Name\", type: \"short_text\", required: true },\n            { id: \"field_block_weather\", key: \"field_block_weather\", label: \"Weather Conditions\", type: \"short_text\", required: false },\n          ],\n        },\n        {\n          id: \"section_structure\",\n          title: \"External Structure\",\n          fields: [\n            { id: \"field_block_roof\", key: \"field_block_roof\", label: \"Roof Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_chimneys\", key: \"field_block_chimneys\", label: \"Chimneys/Vents\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_walls\", key: \"field_block_walls\", label: \"External Walls\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_cladding\", key: \"field_block_cladding\", label: \"Cladding (if applicable)\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_gutters\", key: \"field_block_gutters\", label: \"Gutters and Drainage\", type: \"photo_array\", required: false, includeCondition: true },\n          ],\n        },\n        {\n          id: \"section_windows\",\n          title: \"Windows and Doors\",\n          fields: [\n            { id: \"field_block_windows\", key: \"field_block_windows\", label: \"Window Condition\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_frames\", key: \"field_block_frames\", label: \"Window Frames\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_communal_doors\", key: \"field_block_communal_doors\", label: \"Communal Entry Doors\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_access_control\", key: \"field_block_access_control\", label: \"Access Control System\", type: \"select\", options: [\"Working\", \"Faulty\", \"Not Applicable\"], required: false },\n          ],\n        },\n        {\n          id: \"section_grounds\",\n          title: \"Grounds and External Areas\",\n          fields: [\n            { id: \"field_block_grounds\", key: \"field_block_grounds\", label: \"Grounds Condition\", type: \"photo_array\", required: false, includeCondition: true, includeCleanliness: true },\n            { id: \"field_block_paths\", key: \"field_block_paths\", label: \"Pathways and Paving\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_fencing\", key: \"field_block_fencing\", label: \"Fencing and Boundaries\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_gates\", key: \"field_block_gates\", label: \"Gates and Barriers\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_lighting\", key: \"field_block_lighting\", label: \"External Lighting\", type: \"select\", options: [\"All Working\", \"Some Out\", \"Multiple Out\"], required: false },\n          ],\n        },\n        {\n          id: \"section_facilities\",\n          title: \"Building Facilities\",\n          fields: [\n            { id: \"field_block_boiler\", key: \"field_block_boiler\", label: \"Central Boiler/Plant Room\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_water\", key: \"field_block_water\", label: \"Water Tanks/Systems\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_electric\", key: \"field_block_electric\", label: \"Main Electrical Supply\", type: \"photo_array\", required: false, includeCondition: true },\n            { id: \"field_block_cctv\", key: \"field_block_cctv\", label: \"CCTV System\", type: \"select\", options: [\"Working\", \"Faulty\", \"Not Applicable\"], required: false },\n          ],\n        },\n        {\n          id: \"section_compliance\",\n          title: \"Compliance and Certification\",\n          fields: [\n            { id: \"field_block_fire_cert\", key: \"field_block_fire_cert\", label: \"Fire Risk Assessment Up to Date\", type: \"select\", options: [\"Yes\", \"No\", \"Due Soon\"], required: false },\n            { id: \"field_block_lift_cert\", key: \"field_block_lift_cert\", label: \"Lift Certificates Valid\", type: \"select\", options: [\"Yes\", \"No\", \"N/A\"], required: false },\n            { id: \"field_block_legionella\", key: \"field_block_legionella\", label: \"Legionella Assessment Current\", type: \"select\", options: [\"Yes\", \"No\", \"N/A\"], required: false },\n            { id: \"field_block_asbestos\", key: \"field_block_asbestos\", label: \"Asbestos Register Up to Date\", type: \"select\", options: [\"Yes\", \"No\", \"N/A\"], required: false },\n          ],\n        },\n        {\n          id: \"section_summary\",\n          title: \"Summary and Recommendations\",\n          fields: [\n            { id: \"field_block_overall\", key: \"field_block_overall\", label: \"Overall Building Condition\", type: \"select\", options: [\"Excellent\", \"Good\", \"Fair\", \"Poor\"], required: true },\n            { id: \"field_block_urgent\", key: \"field_block_urgent\", label: \"Urgent Issues\", type: \"long_text\", required: false },\n            { id: \"field_block_planned\", key: \"field_block_planned\", label: \"Planned Maintenance Recommendations\", type: \"long_text\", required: false },\n            { id: \"field_block_next\", key: \"field_block_next\", label: \"Next Inspection Date\", type: \"date\", required: false },\n            { id: \"field_block_signature\", key: \"field_block_signature\", label: \"Inspector Signature\", type: \"signature\", required: false },\n          ],\n        },\n      ],\n    },\n  },\n];\n","size_bytes":47996},"client/src/components/QuickUpdateAssetSheet.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { offlineQueue, useOnlineStatus } from \"@/lib/offlineQueue\";\nimport type { QuickUpdateAsset, AssetInventory } from \"@shared/schema\";\nimport { quickUpdateAssetSchema } from \"@shared/schema\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Search, Package } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ninterface QuickUpdateAssetSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  propertyId?: string;\n  blockId?: string;\n  inspectionId?: string;\n  inspectionEntryId?: string;\n}\n\nexport function QuickUpdateAssetSheet({\n  open,\n  onOpenChange,\n  propertyId,\n  blockId,\n  inspectionId,\n  inspectionEntryId,\n}: QuickUpdateAssetSheetProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const isOnline = useOnlineStatus();\n  const [selectedAssetId, setSelectedAssetId] = useState<string>(\"\");\n  const [selectedAsset, setSelectedAsset] = useState<AssetInventory | null>(null);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  // Build query params for filtering assets\n  const queryParams = new URLSearchParams();\n  if (propertyId) queryParams.append(\"propertyId\", propertyId);\n  if (blockId) queryParams.append(\"blockId\", blockId);\n\n  // Fetch assets for the current property/block\n  const { data: assets = [], isLoading: isLoadingAssets } = useQuery<AssetInventory[]>({\n    queryKey: [\"/api/asset-inventory\", propertyId, blockId],\n    enabled: open && (!!propertyId || !!blockId),\n  });\n\n  // Update selectedAsset when selectedAssetId changes\n  useEffect(() => {\n    if (selectedAssetId && assets.length > 0) {\n      const asset = assets.find((a) => a.id === selectedAssetId);\n      setSelectedAsset(asset || null);\n      \n      // Pre-fill form with current values\n      if (asset) {\n        form.reset({\n          condition: asset.condition,\n          cleanliness: asset.cleanliness || undefined,\n          location: asset.location || \"\",\n          notes: asset.description || \"\",\n          inspectionId: inspectionId || undefined,\n          inspectionEntryId: inspectionEntryId || undefined,\n        });\n      }\n    }\n  }, [selectedAssetId, assets, inspectionId, inspectionEntryId]);\n\n  const form = useForm<QuickUpdateAsset>({\n    resolver: zodResolver(quickUpdateAssetSchema),\n    defaultValues: {\n      condition: undefined,\n      cleanliness: undefined,\n      location: \"\",\n      notes: \"\",\n      inspectionId: inspectionId || undefined,\n      inspectionEntryId: inspectionEntryId || undefined,\n    },\n  });\n\n  const updateAssetMutation = useMutation({\n    mutationFn: async (data: QuickUpdateAsset & { assetId: string }) => {\n      const { assetId, ...payload } = data;\n      return await apiRequest(\"PATCH\", `/api/asset-inventory/${assetId}/quick`, payload);\n    },\n    onSuccess: () => {\n      // Invalidate global asset inventory query\n      queryClient.invalidateQueries({ queryKey: [\"/api/asset-inventory\"] });\n      // Invalidate property-specific inventory query if propertyId exists\n      if (propertyId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/properties\", propertyId, \"inventory\"] });\n      }\n      // Invalidate block-specific inventory query if blockId exists\n      if (blockId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/blocks\", blockId, \"inventory\"] });\n      }\n      toast({\n        title: \"Asset Updated\",\n        description: \"Asset has been updated successfully\",\n      });\n      handleClose();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Update Asset\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = async (data: QuickUpdateAsset) => {\n    if (!selectedAssetId) {\n      toast({\n        title: \"No Asset Selected\",\n        description: \"Please select an asset to update\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    try {\n      if (isOnline) {\n        // Online: submit directly\n        await updateAssetMutation.mutateAsync({ ...data, assetId: selectedAssetId });\n      } else {\n        // Offline: queue for later sync\n        offlineQueue.enqueueAssetUpdate(selectedAssetId, data);\n        toast({\n          title: \"Update Queued\",\n          description: \"Asset update will be synced when you're back online\",\n        });\n        handleClose();\n      }\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleClose = () => {\n    setSelectedAssetId(\"\");\n    setSelectedAsset(null);\n    form.reset();\n    onOpenChange(false);\n  };\n\n  const getConditionBadgeVariant = (condition: string) => {\n    switch (condition) {\n      case \"excellent\":\n        return \"default\";\n      case \"good\":\n        return \"secondary\";\n      case \"fair\":\n        return \"secondary\";\n      case \"poor\":\n        return \"destructive\";\n      case \"needs_replacement\":\n        return \"destructive\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  return (\n    <Sheet open={open} onOpenChange={handleClose}>\n      <SheetContent side=\"bottom\" className=\"h-[85vh] overflow-y-auto\">\n        <SheetHeader>\n          <SheetTitle>Quick Update Asset</SheetTitle>\n          <SheetDescription>\n            Update existing inventory during inspection\n          </SheetDescription>\n        </SheetHeader>\n\n        <div className=\"space-y-6 mt-6\">\n          {/* Asset Selection */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\" htmlFor=\"asset-select\">\n              Select Asset *\n            </label>\n            <Select\n              value={selectedAssetId}\n              onValueChange={setSelectedAssetId}\n              disabled={isLoadingAssets}\n            >\n              <SelectTrigger id=\"asset-select\" data-testid=\"select-asset\">\n                <SelectValue placeholder={isLoadingAssets ? \"Loading assets...\" : \"Search and select asset...\"} />\n              </SelectTrigger>\n              <SelectContent>\n                {assets.length === 0 ? (\n                  <div className=\"p-4 text-center text-sm text-muted-foreground\">\n                    <Package className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                    No assets found for this location\n                  </div>\n                ) : (\n                  assets.map((asset) => (\n                    <SelectItem key={asset.id} value={asset.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium\">{asset.name}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {asset.category && ` ${asset.category}`}\n                        </span>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {asset.condition}\n                        </Badge>\n                      </div>\n                    </SelectItem>\n                  ))\n                )}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Current Asset State */}\n          {selectedAsset && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Current State</CardTitle>\n                <CardDescription>Review before updating</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Asset Name</p>\n                    <p className=\"font-medium\">{selectedAsset.name}</p>\n                  </div>\n                  {selectedAsset.category && (\n                    <div>\n                      <p className=\"text-xs text-muted-foreground mb-1\">Category</p>\n                      <p className=\"font-medium\">{selectedAsset.category}</p>\n                    </div>\n                  )}\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Condition</p>\n                    <Badge variant={getConditionBadgeVariant(selectedAsset.condition)}>\n                      {selectedAsset.condition}\n                    </Badge>\n                  </div>\n                  {selectedAsset.cleanliness && (\n                    <div>\n                      <p className=\"text-xs text-muted-foreground mb-1\">Cleanliness</p>\n                      <Badge variant=\"outline\">{selectedAsset.cleanliness}</Badge>\n                    </div>\n                  )}\n                </div>\n                {selectedAsset.location && (\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Location</p>\n                    <p className=\"text-sm\">{selectedAsset.location}</p>\n                  </div>\n                )}\n                {selectedAsset.description && (\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Description</p>\n                    <p className=\"text-sm\">{selectedAsset.description}</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Update Form */}\n          {selectedAsset && (\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"condition\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Update Condition</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        value={field.value || selectedAsset.condition}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-condition\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"excellent\">Excellent</SelectItem>\n                          <SelectItem value=\"good\">Good</SelectItem>\n                          <SelectItem value=\"fair\">Fair</SelectItem>\n                          <SelectItem value=\"poor\">Poor</SelectItem>\n                          <SelectItem value=\"needs_replacement\">\n                            Needs Replacement\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"cleanliness\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Update Cleanliness (Optional)</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        value={field.value || selectedAsset.cleanliness || \"\"}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-cleanliness\">\n                            <SelectValue placeholder=\"Select cleanliness\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"clean\">Clean</SelectItem>\n                          <SelectItem value=\"needs_a_clean\">Needs a Clean</SelectItem>\n                          <SelectItem value=\"poor\">Poor</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"location\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Update Location (Optional)</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          placeholder=\"e.g., Kitchen, Bedroom 1, Common Area\"\n                          data-testid=\"input-location\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Update Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          {...field}\n                          placeholder=\"Additional notes about changes...\"\n                          rows={3}\n                          data-testid=\"textarea-notes\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex gap-2 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    className=\"flex-1\"\n                    onClick={handleClose}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    className=\"flex-1\"\n                    disabled={isSubmitting}\n                    data-testid=\"button-update-asset\"\n                  >\n                    {isSubmitting ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Updating...\n                      </>\n                    ) : (\n                      <>Update Asset{!isOnline && \" (Offline)\"}</>\n                    )}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          )}\n\n          {/* No Selection State */}\n          {!selectedAsset && !isLoadingAssets && assets.length > 0 && (\n            <Card className=\"border-dashed\">\n              <CardContent className=\"flex flex-col items-center justify-center py-8\">\n                <Search className=\"h-12 w-12 text-muted-foreground mb-3\" />\n                <p className=\"text-sm text-muted-foreground text-center\">\n                  Select an asset above to update its details\n                </p>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </SheetContent>\n    </Sheet>\n  );\n}\n","size_bytes":15564},"client/src/components/QuickAddAssetSheet.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { offlineQueue, useOnlineStatus } from \"@/lib/offlineQueue\";\nimport type { QuickAddAsset } from \"@shared/schema\";\nimport { quickAddAssetSchema } from \"@shared/schema\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2, WifiOff } from \"lucide-react\";\n\ninterface QuickAddAssetSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  propertyId?: string;\n  blockId?: string;\n  inspectionId?: string;\n  inspectionEntryId?: string;\n}\n\nconst ASSET_CATEGORIES = [\n  \"HVAC\",\n  \"Appliances\",\n  \"Furniture\",\n  \"Plumbing\",\n  \"Electrical\",\n  \"Flooring\",\n  \"Windows & Doors\",\n  \"Kitchen\",\n  \"Bathroom\",\n  \"Security\",\n  \"Lighting\",\n  \"Other\",\n];\n\nexport function QuickAddAssetSheet({\n  open,\n  onOpenChange,\n  propertyId,\n  blockId,\n  inspectionId,\n  inspectionEntryId,\n}: QuickAddAssetSheetProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const isOnline = useOnlineStatus();\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const form = useForm<QuickAddAsset>({\n    resolver: zodResolver(quickAddAssetSchema),\n    defaultValues: {\n      name: \"\",\n      category: \"\",\n      condition: \"good\",\n      cleanliness: undefined,\n      location: \"\",\n      description: \"\",\n      propertyId: propertyId || undefined,\n      blockId: blockId || undefined,\n      photos: [],\n      inspectionId: inspectionId || undefined,\n      inspectionEntryId: inspectionEntryId || undefined,\n    },\n  });\n\n  const createAssetMutation = useMutation({\n    mutationFn: async (data: QuickAddAsset) => {\n      return await apiRequest(\"POST\", \"/api/asset-inventory/quick\", data);\n    },\n    onSuccess: () => {\n      // Invalidate global asset inventory query\n      queryClient.invalidateQueries({ queryKey: [\"/api/asset-inventory\"] });\n      // Invalidate property-specific inventory query if propertyId exists\n      if (propertyId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/properties\", propertyId, \"inventory\"] });\n      }\n      // Invalidate block-specific inventory query if blockId exists\n      if (blockId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/blocks\", blockId, \"inventory\"] });\n      }\n      toast({\n        title: \"Asset Added\",\n        description: \"Asset has been added to the inventory successfully\",\n      });\n      form.reset();\n      onOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Add Asset\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = async (data: QuickAddAsset) => {\n    setIsSubmitting(true);\n\n    try {\n      if (isOnline) {\n        // Online: submit directly\n        await createAssetMutation.mutateAsync(data);\n      } else {\n        // Offline: queue for later sync\n        offlineQueue.enqueueAsset(data);\n        toast({\n          title: \"Asset Queued\",\n          description: \"Asset will be added when you're back online\",\n        });\n        form.reset();\n        onOpenChange(false);\n      }\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Sheet open={open} onOpenChange={onOpenChange}>\n      <SheetContent side=\"bottom\" className=\"h-[85vh] overflow-y-auto\">\n        <SheetHeader>\n          <SheetTitle>Quick Add Asset</SheetTitle>\n          <SheetDescription>\n            Add an asset to the inventory during inspection\n          </SheetDescription>\n        </SheetHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4 mt-6\">\n            <FormField\n              control={form.control}\n              name=\"name\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Asset Name *</FormLabel>\n                  <FormControl>\n                    <Input\n                      {...field}\n                      placeholder=\"e.g., Refrigerator, HVAC Unit, Washing Machine\"\n                      data-testid=\"input-asset-name\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"category\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Category</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-category\">\n                        <SelectValue placeholder=\"Select category\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {ASSET_CATEGORIES.map((category) => (\n                        <SelectItem key={category} value={category}>\n                          {category}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"condition\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Condition *</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-condition\">\n                        <SelectValue />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"excellent\">Excellent</SelectItem>\n                      <SelectItem value=\"good\">Good</SelectItem>\n                      <SelectItem value=\"fair\">Fair</SelectItem>\n                      <SelectItem value=\"poor\">Poor</SelectItem>\n                      <SelectItem value=\"needs_replacement\">\n                        Needs Replacement\n                      </SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"location\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Location</FormLabel>\n                  <FormControl>\n                    <Input\n                      {...field}\n                      placeholder=\"e.g., Kitchen, Bedroom 1, Common Area\"\n                      data-testid=\"input-location\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"description\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Description</FormLabel>\n                  <FormControl>\n                    <Textarea\n                      {...field}\n                      placeholder=\"Additional notes about the asset...\"\n                      rows={3}\n                      data-testid=\"textarea-description\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"flex-1\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"flex-1\"\n                disabled={isSubmitting}\n                data-testid=\"button-add-asset\"\n              >\n                {isSubmitting ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Adding...\n                  </>\n                ) : (\n                  <>Add Asset{!isOnline && \" (Offline)\"}</>\n                )}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </SheetContent>\n    </Sheet>\n  );\n}\n","size_bytes":9035},"client/src/components/InspectionQuickActions.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Plus, Package, Wrench, X, RefreshCw } from \"lucide-react\";\n\ninterface InspectionQuickActionsProps {\n  onAddAsset: () => void;\n  onUpdateAsset: () => void;\n  onLogMaintenance: () => void;\n}\n\nexport function InspectionQuickActions({\n  onAddAsset,\n  onUpdateAsset,\n  onLogMaintenance,\n}: InspectionQuickActionsProps) {\n  const [open, setOpen] = useState(false);\n\n  const handleAction = (action: () => void) => {\n    action();\n    setOpen(false);\n  };\n\n  return (\n    <div className=\"fixed bottom-20 right-6 z-50\">\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            size=\"icon\"\n            className=\"h-14 w-14 rounded-full shadow-lg hover-elevate active-elevate-2\"\n            data-testid=\"button-quick-actions\"\n          >\n            {open ? <X className=\"h-6 w-6\" /> : <Plus className=\"h-6 w-6\" />}\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent\n          side=\"top\"\n          align=\"end\"\n          className=\"w-56 p-2\"\n          data-testid=\"menu-quick-actions\"\n        >\n          <div className=\"flex flex-col gap-1\">\n            <Button\n              variant=\"ghost\"\n              className=\"w-full justify-start gap-3 h-12\"\n              onClick={() => handleAction(onAddAsset)}\n              data-testid=\"button-quick-add-asset\"\n            >\n              <Package className=\"h-5 w-5 text-primary\" />\n              <div className=\"flex flex-col items-start\">\n                <span className=\"font-medium\">Add Asset</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Add to inventory\n                </span>\n              </div>\n            </Button>\n            <Button\n              variant=\"ghost\"\n              className=\"w-full justify-start gap-3 h-12\"\n              onClick={() => handleAction(onUpdateAsset)}\n              data-testid=\"button-quick-update-asset\"\n            >\n              <RefreshCw className=\"h-5 w-5 text-primary\" />\n              <div className=\"flex flex-col items-start\">\n                <span className=\"font-medium\">Update Asset</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Modify existing inventory\n                </span>\n              </div>\n            </Button>\n            <Button\n              variant=\"ghost\"\n              className=\"w-full justify-start gap-3 h-12\"\n              onClick={() => handleAction(onLogMaintenance)}\n              data-testid=\"button-quick-log-maintenance\"\n            >\n              <Wrench className=\"h-5 w-5 text-primary\" />\n              <div className=\"flex flex-col items-start\">\n                <span className=\"font-medium\">Log Maintenance</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Report an issue\n                </span>\n              </div>\n            </Button>\n          </div>\n        </PopoverContent>\n      </Popover>\n    </div>\n  );\n}\n","size_bytes":3128},"client/src/components/QuickAddMaintenanceSheet.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { offlineQueue, useOnlineStatus } from \"@/lib/offlineQueue\";\nimport type { QuickAddMaintenance } from \"@shared/schema\";\nimport { quickAddMaintenanceSchema } from \"@shared/schema\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface QuickAddMaintenanceSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  propertyId?: string;\n  blockId?: string;\n  inspectionId?: string;\n  inspectionEntryId?: string;\n}\n\nexport function QuickAddMaintenanceSheet({\n  open,\n  onOpenChange,\n  propertyId,\n  blockId,\n  inspectionId,\n  inspectionEntryId,\n}: QuickAddMaintenanceSheetProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const isOnline = useOnlineStatus();\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  // If we have a blockId but no propertyId, fetch properties for the block\n  const { data: properties = [] } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n    enabled: !!blockId && !propertyId,\n  });\n\n  // Filter properties to only those in the current block\n  const blockProperties = blockId && !propertyId \n    ? properties.filter(p => p.blockId === blockId)\n    : [];\n\n  const form = useForm<QuickAddMaintenance>({\n    resolver: zodResolver(quickAddMaintenanceSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      propertyId: propertyId || (blockProperties.length === 1 ? blockProperties[0].id : \"\"),\n      priority: \"medium\",\n      photoUrls: [],\n      inspectionId: inspectionId || undefined,\n      inspectionEntryId: inspectionEntryId || undefined,\n      source: \"inspection\",\n    },\n  });\n\n  // Update propertyId when blockProperties change\n  if (blockProperties.length === 1 && !form.getValues(\"propertyId\")) {\n    form.setValue(\"propertyId\", blockProperties[0].id);\n  }\n\n  const createMaintenanceMutation = useMutation({\n    mutationFn: async (data: QuickAddMaintenance) => {\n      return await apiRequest(\"POST\", \"/api/maintenance/quick\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/maintenance\"], refetchType: \"active\" });\n      toast({\n        title: \"Maintenance Request Created\",\n        description: \"The maintenance request has been logged successfully\",\n      });\n      form.reset();\n      onOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Log Maintenance\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = async (data: QuickAddMaintenance) => {\n    setIsSubmitting(true);\n\n    try {\n      if (isOnline) {\n        // Online: submit directly\n        await createMaintenanceMutation.mutateAsync(data);\n      } else {\n        // Offline: queue for later sync\n        offlineQueue.enqueueMaintenance(data);\n        toast({\n          title: \"Maintenance Queued\",\n          description: \"Request will be logged when you're back online\",\n        });\n        form.reset();\n        onOpenChange(false);\n      }\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Sheet open={open} onOpenChange={onOpenChange}>\n      <SheetContent side=\"bottom\" className=\"h-[75vh] overflow-y-auto\">\n        <SheetHeader>\n          <SheetTitle>Quick Log Maintenance</SheetTitle>\n          <SheetDescription>\n            Log a maintenance issue found during inspection\n          </SheetDescription>\n        </SheetHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4 mt-6\">\n            <FormField\n              control={form.control}\n              name=\"title\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issue Title *</FormLabel>\n                  <FormControl>\n                    <Input\n                      {...field}\n                      placeholder=\"e.g., Leaking faucet, Damaged wall, Broken window\"\n                      data-testid=\"input-title\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            {/* Property selector for block-level inspections */}\n            {blockId && !propertyId && blockProperties.length > 0 && (\n              <FormField\n                control={form.control}\n                name=\"propertyId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Property *</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-property\">\n                          <SelectValue placeholder=\"Select property\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {blockProperties.map((property) => (\n                          <SelectItem key={property.id} value={property.id}>\n                            {property.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            )}\n\n            <FormField\n              control={form.control}\n              name=\"description\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Description</FormLabel>\n                  <FormControl>\n                    <Textarea\n                      {...field}\n                      placeholder=\"Describe the issue in detail...\"\n                      rows={4}\n                      data-testid=\"textarea-description\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"priority\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Priority</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-priority\">\n                        <SelectValue />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"low\">Low</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"high\">High</SelectItem>\n                      <SelectItem value=\"urgent\">Urgent</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"flex-1\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"flex-1\"\n                disabled={isSubmitting}\n                data-testid=\"button-log-maintenance\"\n              >\n                {isSubmitting ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Logging...\n                  </>\n                ) : (\n                  <>Log Request{!isOnline && \" (Offline)\"}</>\n                )}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </SheetContent>\n    </Sheet>\n  );\n}\n","size_bytes":8552},"client/src/pages/ComparisonReportDetail.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  FileText, \n  ArrowLeft, \n  MessageSquare, \n  Pen, \n  DollarSign, \n  TrendingDown, \n  Calculator,\n  Image as ImageIcon,\n  AlertCircle,\n  Check,\n  User\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\ninterface ComparisonReport {\n  id: string;\n  propertyId: string;\n  tenantId: string;\n  status: string;\n  totalEstimatedCost: string;\n  aiAnalysisJson: any;\n  operatorSignature: string | null;\n  operatorSignedAt: string | null;\n  tenantSignature: string | null;\n  tenantSignedAt: string | null;\n  createdAt: string;\n  items: ComparisonReportItem[];\n}\n\ninterface ComparisonReportItem {\n  id: string;\n  sectionRef: string;\n  fieldKey: string;\n  itemRef: string | null;\n  aiComparisonJson: any;\n  estimatedCost: string;\n  depreciation: string;\n  finalCost: string;\n  checkInEntryId: string | null;\n  checkOutEntryId: string;\n  checkInPhotos?: string[];\n  checkOutPhotos?: string[];\n}\n\ninterface Comment {\n  id: string;\n  userId: string;\n  content: string;\n  isInternal: boolean;\n  createdAt: string;\n}\n\nconst statusConfig = {\n  draft: { label: \"Draft\", color: \"bg-gray-500\" },\n  under_review: { label: \"Under Review\", color: \"bg-blue-500\" },\n  awaiting_signatures: { label: \"Awaiting Signatures\", color: \"bg-amber-500\" },\n  signed: { label: \"Signed\", color: \"bg-green-500\" },\n  filed: { label: \"Filed\", color: \"bg-slate-600\" },\n};\n\nexport default function ComparisonReportDetail() {\n  const { id } = useParams();\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const locale = useLocale();\n  const [commentText, setCommentText] = useState(\"\");\n  const [signatureName, setSignatureName] = useState(\"\");\n\n  const { data: report, isLoading } = useQuery<ComparisonReport>({\n    queryKey: [\"/api/comparison-reports\", id],\n    enabled: !!id,\n    select: (data) => {\n      // Parse AI analysis to extract photos if available\n      const items = data.items.map(item => {\n        const aiAnalysis = item.aiComparisonJson || {};\n        const checkInPhotos = aiAnalysis.checkInPhotos || [];\n        const checkOutPhotos = aiAnalysis.checkOutPhotos || [];\n        return {\n          ...item,\n          checkInPhotos,\n          checkOutPhotos,\n        };\n      });\n      return {\n        ...data,\n        items,\n      };\n    },\n  });\n\n  const { data: comments = [] } = useQuery<Comment[]>({\n    queryKey: [\"/api/comparison-reports\", id, \"comments\"],\n    enabled: !!id,\n  });\n\n  const addCommentMutation = useMutation({\n    mutationFn: async (content: string) => {\n      const response = await apiRequest(\"POST\", `/api/comparison-reports/${id}/comments`, { content });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/comparison-reports\", id, \"comments\"] });\n      setCommentText(\"\");\n      toast({\n        title: \"Comment Added\",\n        description: \"Your comment has been posted successfully.\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to add comment.\",\n      });\n    },\n  });\n\n  const signMutation = useMutation({\n    mutationFn: async (signature: string) => {\n      const response = await apiRequest(\"POST\", `/api/comparison-reports/${id}/sign`, { signature });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/comparison-reports\", id] });\n      setSignatureName(\"\");\n      toast({\n        title: \"Report Signed\",\n        description: \"Your electronic signature has been recorded.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to sign report.\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 space-y-6\">\n        <Skeleton className=\"h-12 w-2/3\" />\n        <Skeleton className=\"h-64 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  if (!report) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <AlertCircle className=\"w-16 h-16 text-muted-foreground/50 mb-4\" />\n            <h3 className=\"text-xl font-semibold mb-2\">Report Not Found</h3>\n            <p className=\"text-muted-foreground mb-4\">The comparison report you're looking for doesn't exist.</p>\n            <Link href=\"/comparisons\">\n              <a>\n                <Button variant=\"outline\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Back to Reports\n                </Button>\n              </a>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const statusInfo = statusConfig[report.status as keyof typeof statusConfig];\n  const totalCost = parseFloat(report.totalEstimatedCost);\n  const isOperator = user?.role === \"owner\" || user?.role === \"clerk\";\n  const isTenant = user?.role === \"tenant\";\n  const canSign = (isOperator && !report.operatorSignature) || (isTenant && !report.tenantSignature);\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-6\" data-testid=\"page-comparison-detail\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"space-y-1\">\n          <Link href=\"/comparisons\">\n            <a>\n              <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Reports\n              </Button>\n            </a>\n          </Link>\n          <h1 className=\"text-4xl font-bold flex items-center gap-3\">\n            <FileText className=\"w-10 h-10 text-primary\" />\n            Comparison Report\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Generated on {format(new Date(report.createdAt), \"MMMM d, yyyy 'at' h:mm a\")}\n          </p>\n        </div>\n        <Badge className={`${statusInfo.color} text-white text-lg px-4 py-2`}>\n          {statusInfo.label}\n        </Badge>\n      </div>\n\n      {/* Summary Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Cost Summary</CardTitle>\n          <CardDescription>Total estimated tenant liability after depreciation</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-4xl font-bold text-primary\">\n            {locale.formatCurrency(totalCost * 100, false)}\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-2\">\n            Based on {report.items.length} items marked for review\n          </p>\n        </CardContent>\n      </Card>\n\n      {/* Items Breakdown */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Item-by-Item Analysis</CardTitle>\n          <CardDescription>Detailed comparison of each marked item</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {report.items.map((item, index) => {\n            const aiAnalysis = item.aiComparisonJson || {};\n            const estimatedCost = parseFloat(item.estimatedCost);\n            const depreciation = parseFloat(item.depreciation);\n            const finalCost = parseFloat(item.finalCost);\n\n            return (\n              <div key={item.id} className=\"space-y-4 pb-6 border-b last:border-b-0\">\n                {/* Item Header */}\n                <div className=\"flex items-start justify-between\">\n                  <div>\n                    <h3 className=\"text-lg font-semibold\">\n                      {index + 1}. {item.sectionRef} - {item.fieldKey}\n                    </h3>\n                    {item.itemRef && (\n                      <p className=\"text-sm text-muted-foreground\">{item.itemRef}</p>\n                    )}\n                  </div>\n                  {aiAnalysis.severity && (\n                    <Badge \n                      variant={\n                        aiAnalysis.severity === \"high\" ? \"destructive\" : \n                        aiAnalysis.severity === \"medium\" ? \"default\" : \n                        \"secondary\"\n                      }\n                    >\n                      {aiAnalysis.severity} severity\n                    </Badge>\n                  )}\n                </div>\n\n                {/* Images Side-by-Side */}\n                {((item.checkInPhotos && item.checkInPhotos.length > 0) || (item.checkOutPhotos && item.checkOutPhotos.length > 0)) && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-medium text-muted-foreground\">Check-In Photos</h4>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {item.checkInPhotos && item.checkInPhotos.length > 0 ? (\n                          item.checkInPhotos.slice(0, 2).map((photo, idx) => (\n                            <img\n                              key={idx}\n                              src={photo}\n                              alt={`Check-in ${idx + 1}`}\n                              className=\"w-full h-32 object-cover rounded-lg border\"\n                            />\n                          ))\n                        ) : (\n                          <div className=\"col-span-2 flex items-center justify-center h-32 bg-muted rounded-lg border border-dashed\">\n                            <p className=\"text-sm text-muted-foreground\">No check-in photos</p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-medium text-muted-foreground\">Check-Out Photos</h4>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {item.checkOutPhotos && item.checkOutPhotos.length > 0 ? (\n                          item.checkOutPhotos.slice(0, 2).map((photo, idx) => (\n                            <img\n                              key={idx}\n                              src={photo}\n                              alt={`Check-out ${idx + 1}`}\n                              className=\"w-full h-32 object-cover rounded-lg border\"\n                            />\n                          ))\n                        ) : (\n                          <div className=\"col-span-2 flex items-center justify-center h-32 bg-muted rounded-lg border border-dashed\">\n                            <p className=\"text-sm text-muted-foreground\">No check-out photos</p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* AI Analysis */}\n                {aiAnalysis.differences && (\n                  <div className=\"bg-muted p-4 rounded-lg space-y-2\">\n                    <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                      <ImageIcon className=\"w-4 h-4\" />\n                      Visual Differences\n                    </h4>\n                    <p className=\"text-sm\">{aiAnalysis.differences}</p>\n                  </div>\n                )}\n\n                {aiAnalysis.damage && (\n                  <div className=\"bg-destructive/10 p-4 rounded-lg space-y-2\">\n                    <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                      <AlertCircle className=\"w-4 h-4 text-destructive\" />\n                      Damage Assessment\n                    </h4>\n                    <p className=\"text-sm\">{aiAnalysis.damage}</p>\n                  </div>\n                )}\n\n                {aiAnalysis.repair_description && (\n                  <div className=\"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg space-y-2\">\n                    <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                      <Calculator className=\"w-4 h-4\" />\n                      Recommended Repairs\n                    </h4>\n                    <p className=\"text-sm\">{aiAnalysis.repair_description}</p>\n                  </div>\n                )}\n\n                {/* Cost Breakdown */}\n                <div className=\"grid grid-cols-3 gap-4 pt-2\">\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <DollarSign className=\"w-4 h-4\" />\n                      Estimated Cost\n                    </div>\n                    <div className=\"text-lg font-semibold\">{locale.formatCurrency(estimatedCost * 100, false)}</div>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <TrendingDown className=\"w-4 h-4\" />\n                      Depreciation\n                    </div>\n                    <div className=\"text-lg font-semibold text-green-600\">\n                      -{locale.formatCurrency(depreciation * 100, false)}\n                    </div>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Calculator className=\"w-4 h-4\" />\n                      Tenant Liability\n                    </div>\n                    <div className=\"text-lg font-semibold text-primary\">\n                      {locale.formatCurrency(finalCost * 100, false)}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </CardContent>\n      </Card>\n\n      {/* Comments Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageSquare className=\"w-5 h-5\" />\n            Discussion Thread\n          </CardTitle>\n          <CardDescription>\n            Internal notes and tenant communication\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Comments List */}\n          <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n            {comments.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">\n                No comments yet. Start the discussion below.\n              </p>\n            ) : (\n              comments.map((comment) => (\n                <div \n                  key={comment.id}\n                  className={`p-4 rounded-lg ${\n                    comment.isInternal \n                      ? \"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800\" \n                      : \"bg-muted\"\n                  }`}\n                >\n                  <div className=\"flex items-start justify-between mb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <User className=\"w-4 h-4\" />\n                      <span className=\"text-sm font-medium\">\n                        {comment.isInternal ? \"Internal Note\" : \"Comment\"}\n                      </span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {format(new Date(comment.createdAt), \"MMM d, h:mm a\")}\n                    </span>\n                  </div>\n                  <p className=\"text-sm whitespace-pre-wrap\">{comment.content}</p>\n                </div>\n              ))\n            )}\n          </div>\n\n          <Separator />\n\n          {/* Add Comment Form */}\n          <div className=\"space-y-3\">\n            <Textarea\n              placeholder=\"Add a comment or internal note...\"\n              value={commentText}\n              onChange={(e) => setCommentText(e.target.value)}\n              rows={3}\n              data-testid=\"input-comment\"\n            />\n            <Button\n              onClick={() => addCommentMutation.mutate(commentText)}\n              disabled={!commentText.trim() || addCommentMutation.isPending}\n              data-testid=\"button-add-comment\"\n            >\n              <MessageSquare className=\"w-4 h-4 mr-2\" />\n              {addCommentMutation.isPending ? \"Adding...\" : \"Add Comment\"}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Signature Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Pen className=\"w-5 h-5\" />\n            Electronic Signatures\n          </CardTitle>\n          <CardDescription>\n            Both parties must sign to finalize the report\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* Operator Signature */}\n          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n            <div className=\"space-y-1\">\n              <div className=\"font-medium flex items-center gap-2\">\n                <User className=\"w-4 h-4\" />\n                Operator Signature\n              </div>\n              {report.operatorSignature ? (\n                <div className=\"space-y-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600\" />\n                    <span className=\"text-sm\">Signed: {report.operatorSignature}</span>\n                  </div>\n                  {report.operatorSignedAt && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      {format(new Date(report.operatorSignedAt), \"MMM d, yyyy 'at' h:mm a\")}\n                    </p>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground\">Pending signature</p>\n              )}\n            </div>\n            {isOperator && !report.operatorSignature && (\n              <Badge variant=\"outline\" className=\"text-amber-600 border-amber-600\">\n                Action Required\n              </Badge>\n            )}\n          </div>\n\n          {/* Tenant Signature */}\n          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n            <div className=\"space-y-1\">\n              <div className=\"font-medium flex items-center gap-2\">\n                <User className=\"w-4 h-4\" />\n                Tenant Signature\n              </div>\n              {report.tenantSignature ? (\n                <div className=\"space-y-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600\" />\n                    <span className=\"text-sm\">Signed: {report.tenantSignature}</span>\n                  </div>\n                  {report.tenantSignedAt && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      {format(new Date(report.tenantSignedAt), \"MMM d, yyyy 'at' h:mm a\")}\n                    </p>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground\">Pending signature</p>\n              )}\n            </div>\n            {isTenant && !report.tenantSignature && (\n              <Badge variant=\"outline\" className=\"text-amber-600 border-amber-600\">\n                Action Required\n              </Badge>\n            )}\n          </div>\n\n          {/* Sign Form */}\n          {canSign && (\n            <div className=\"space-y-3 p-4 bg-muted rounded-lg\">\n              <label className=\"text-sm font-medium\">Type your full name to sign</label>\n              <Input\n                placeholder=\"Your full name\"\n                value={signatureName}\n                onChange={(e) => setSignatureName(e.target.value)}\n                data-testid=\"input-signature\"\n              />\n              <Button\n                onClick={() => signMutation.mutate(signatureName)}\n                disabled={!signatureName.trim() || signMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-sign\"\n              >\n                <Pen className=\"w-4 h-4 mr-2\" />\n                {signMutation.isPending ? \"Signing...\" : \"Sign Report\"}\n              </Button>\n              <p className=\"text-xs text-muted-foreground\">\n                By signing, you acknowledge that you have reviewed and agree to the contents of this report.\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":21060},"server/services/fixflo-client.ts":{"content":"import type { FixfloConfig } from \"@shared/schema\";\n\nexport interface FixfloIssuePayload {\n  propertyId: string;\n  title: string;\n  description: string;\n  priority: \"low\" | \"medium\" | \"high\" | \"urgent\";\n  category?: string;\n  reporterId?: string;\n  reporterName?: string;\n  reporterEmail?: string;\n  reporterPhone?: string;\n  externalRef?: string;\n}\n\nexport interface FixfloAttachment {\n  url: string;\n  filename: string;\n  contentType?: string;\n}\n\nexport interface FixfloIssueResponse {\n  id: string;\n  jobId?: string;\n  status: string;\n  assignedAgentId?: string;\n  assignedAgentName?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface FixfloUpdatePayload {\n  assignedAgentId?: string;\n  priority?: string;\n  status?: string;\n  dueDate?: string;\n  notes?: string;\n}\n\nexport class FixfloClientError extends Error {\n  constructor(\n    message: string,\n    public statusCode?: number,\n    public response?: any\n  ) {\n    super(message);\n    this.name = \"FixfloClientError\";\n  }\n}\n\nexport class FixfloClient {\n  private baseUrl: string;\n  private bearerToken: string;\n  private maxRetries = 3;\n  private retryDelayMs = 1000;\n\n  constructor(config: FixfloConfig) {\n    this.baseUrl = config.baseUrl;\n    this.bearerToken = config.bearerToken || \"\";\n    \n    if (!this.bearerToken) {\n      throw new FixfloClientError(\"Fixflo bearer token is required\");\n    }\n  }\n\n  private async request<T>(\n    method: string,\n    endpoint: string,\n    body?: any,\n    attempt = 1\n  ): Promise<T> {\n    const url = `${this.baseUrl}${endpoint}`;\n    \n    try {\n      const response = await fetch(url, {\n        method,\n        headers: {\n          \"Authorization\": `Bearer ${this.bearerToken}`,\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      });\n\n      // Handle rate limiting with Retry-After\n      if (response.status === 429) {\n        const retryAfter = response.headers.get(\"Retry-After\");\n        const delayMs = retryAfter ? parseInt(retryAfter) * 1000 : this.retryDelayMs * attempt;\n        \n        if (attempt < this.maxRetries) {\n          console.log(`[Fixflo] Rate limited. Retrying after ${delayMs}ms (attempt ${attempt}/${this.maxRetries})`);\n          await this.delay(delayMs);\n          return this.request<T>(method, endpoint, body, attempt + 1);\n        }\n        \n        throw new FixfloClientError(\n          \"Rate limit exceeded\",\n          429,\n          await response.text()\n        );\n      }\n\n      // Retry on 5xx errors\n      if (response.status >= 500) {\n        if (attempt < this.maxRetries) {\n          const delayMs = this.retryDelayMs * attempt;\n          console.log(`[Fixflo] Server error ${response.status}. Retrying after ${delayMs}ms (attempt ${attempt}/${this.maxRetries})`);\n          await this.delay(delayMs);\n          return this.request<T>(method, endpoint, body, attempt + 1);\n        }\n        \n        throw new FixfloClientError(\n          `Server error: ${response.status}`,\n          response.status,\n          await response.text()\n        );\n      }\n\n      // Handle client errors (4xx)\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new FixfloClientError(\n          `HTTP ${response.status}: ${errorText}`,\n          response.status,\n          errorText\n        );\n      }\n\n      // Parse response\n      const contentType = response.headers.get(\"Content-Type\");\n      if (contentType?.includes(\"application/json\")) {\n        return await response.json() as T;\n      }\n      \n      return await response.text() as T;\n      \n    } catch (error) {\n      if (error instanceof FixfloClientError) {\n        throw error;\n      }\n      \n      // Network errors - retry if we haven't exhausted attempts\n      if (attempt < this.maxRetries) {\n        const delayMs = this.retryDelayMs * attempt;\n        console.log(`[Fixflo] Network error. Retrying after ${delayMs}ms (attempt ${attempt}/${this.maxRetries})`);\n        await this.delay(delayMs);\n        return this.request<T>(method, endpoint, body, attempt + 1);\n      }\n      \n      throw new FixfloClientError(\n        `Network error: ${(error as Error).message}`,\n        undefined,\n        error\n      );\n    }\n  }\n\n  private delay(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n  async createIssue(payload: FixfloIssuePayload): Promise<FixfloIssueResponse> {\n    console.log(`[Fixflo] Creating issue: ${payload.title}`);\n    \n    // Map our priority values to Fixflo's expected format\n    const priorityMapping: Record<string, string> = {\n      \"low\": \"Low\",\n      \"medium\": \"Medium\", \n      \"high\": \"High\",\n      \"urgent\": \"Emergency\"\n    };\n\n    const fixfloPayload = {\n      PropertyId: payload.propertyId,\n      Title: payload.title,\n      Description: payload.description,\n      Priority: priorityMapping[payload.priority] || \"Medium\",\n      Category: payload.category || \"Maintenance\",\n      ExternalRef: payload.externalRef,\n      Reporter: payload.reporterId ? {\n        Id: payload.reporterId,\n        Name: payload.reporterName,\n        Email: payload.reporterEmail,\n        Phone: payload.reporterPhone,\n      } : undefined,\n    };\n\n    return await this.request<FixfloIssueResponse>(\"POST\", \"/Issues\", fixfloPayload);\n  }\n\n  async updateIssue(issueId: string, payload: FixfloUpdatePayload): Promise<FixfloIssueResponse> {\n    console.log(`[Fixflo] Updating issue: ${issueId}`);\n    \n    return await this.request<FixfloIssueResponse>(\n      \"PATCH\",\n      `/Issues/${issueId}`,\n      payload\n    );\n  }\n\n  async assignContractor(issueId: string, contractorId: string): Promise<FixfloIssueResponse> {\n    console.log(`[Fixflo] Assigning contractor ${contractorId} to issue ${issueId}`);\n    \n    return await this.request<FixfloIssueResponse>(\n      \"PATCH\",\n      `/Issues/${issueId}/AssignedAgent`,\n      { AgentId: contractorId }\n    );\n  }\n\n  async getIssue(issueId: string): Promise<FixfloIssueResponse> {\n    console.log(`[Fixflo] Fetching issue: ${issueId}`);\n    \n    return await this.request<FixfloIssueResponse>(\"GET\", `/Issues/${issueId}`);\n  }\n\n  async getJobCompleted(sinceDate?: Date): Promise<FixfloIssueResponse[]> {\n    const dateParam = sinceDate \n      ? `?since=${sinceDate.toISOString()}`\n      : \"\";\n    \n    console.log(`[Fixflo] Fetching completed jobs${dateParam}`);\n    \n    return await this.request<FixfloIssueResponse[]>(\n      \"GET\",\n      `/Issues/JobCompleted${dateParam}`\n    );\n  }\n\n  async uploadAttachment(\n    issueId: string,\n    attachment: FixfloAttachment\n  ): Promise<void> {\n    console.log(`[Fixflo] Uploading attachment to issue ${issueId}: ${attachment.filename}`);\n    \n    // Fixflo may support URL-based attachments or require binary upload\n    // This implementation assumes URL-based attachment\n    await this.request(\"POST\", `/Issues/${issueId}/Attachments`, {\n      Url: attachment.url,\n      Filename: attachment.filename,\n      ContentType: attachment.contentType || \"image/jpeg\",\n    });\n  }\n\n  async downloadAttachment(attachmentUrl: string): Promise<Blob> {\n    console.log(`[Fixflo] Downloading attachment: ${attachmentUrl}`);\n    \n    const response = await fetch(attachmentUrl, {\n      headers: {\n        \"Authorization\": `Bearer ${this.bearerToken}`,\n      },\n    });\n\n    if (!response.ok) {\n      throw new FixfloClientError(\n        `Failed to download attachment: ${response.status}`,\n        response.status\n      );\n    }\n\n    return await response.blob();\n  }\n\n  async healthCheck(): Promise<boolean> {\n    try {\n      // Simple API call to verify connectivity and authentication\n      await this.request(\"GET\", \"/Issues?limit=1\");\n      return true;\n    } catch (error) {\n      console.error(`[Fixflo] Health check failed:`, error);\n      return false;\n    }\n  }\n}\n\nexport async function createFixfloClient(config: FixfloConfig): Promise<FixfloClient> {\n  if (!config.isEnabled) {\n    throw new FixfloClientError(\"Fixflo integration is not enabled for this organization\");\n  }\n  \n  return new FixfloClient(config);\n}\n","size_bytes":8106},"server/services/fixflo-webhook-processor.ts":{"content":"import type { DatabaseStorage } from \"../storage\";\n\nexport async function processFixfloWebhook(\n  webhookLogId: string,\n  organizationId: string,\n  payload: any,\n  storage: DatabaseStorage\n): Promise<void> {\n  const eventType = payload.eventType || payload.event || \"Unknown\";\n  \n  console.log(`[Fixflo Webhook] Processing event: ${eventType}`);\n\n  try {\n    // Extract issue/job IDs from payload\n    const fixfloIssueId = payload.issueId || payload.Issue?.Id || payload.Id;\n    const fixfloJobId = payload.jobId || payload.Job?.Id;\n\n    // Process based on event type\n    switch (eventType) {\n      case \"IssueCreated\":\n        await handleIssueCreated(fixfloIssueId, payload, organizationId, storage);\n        break;\n\n      case \"IssueUpdated\":\n        await handleIssueUpdated(fixfloIssueId, payload, organizationId, storage);\n        break;\n\n      case \"ContractorAssigned\":\n      case \"AssignedAgentUpdated\":\n        await handleContractorAssigned(fixfloIssueId, payload, organizationId, storage);\n        break;\n\n      case \"JobCompleted\":\n        await handleJobCompleted(fixfloIssueId, fixfloJobId, payload, organizationId, storage);\n        break;\n\n      case \"InvoiceAdded\":\n        await handleInvoiceAdded(fixfloIssueId, payload, organizationId, storage);\n        break;\n\n      case \"AttachmentAdded\":\n        await handleAttachmentAdded(fixfloIssueId, payload, organizationId, storage);\n        break;\n\n      default:\n        console.log(`[Fixflo Webhook] Unhandled event type: ${eventType}`);\n    }\n\n    // Mark webhook as processed\n    await storage.updateFixfloWebhookLog(webhookLogId, {\n      processingStatus: \"processed\",\n      processedAt: new Date(),\n    });\n\n    console.log(`[Fixflo Webhook] Successfully processed event: ${eventType}`);\n  } catch (error) {\n    console.error(`[Fixflo Webhook] Error processing webhook:`, error);\n\n    // Get current retry count\n    const webhookLogs = await storage.getFixfloWebhookLogs(organizationId, 1);\n    const currentLog = webhookLogs.find(log => log.id === webhookLogId);\n    const retryCount = (currentLog?.retryCount || 0) + 1;\n\n    // Update webhook log with error\n    await storage.updateFixfloWebhookLog(webhookLogId, {\n      processingStatus: retryCount < 3 ? \"retrying\" : \"error\",\n      errorMessage: (error as Error).message,\n      retryCount,\n    });\n\n    // Retry if under max retries\n    if (retryCount < 3) {\n      console.log(`[Fixflo Webhook] Retry ${retryCount}/3 for webhook ${webhookLogId}`);\n      // In production, this would be handled by a queue\n      setTimeout(() => {\n        processFixfloWebhook(webhookLogId, organizationId, payload, storage);\n      }, 5000 * retryCount); // Exponential backoff\n    }\n  }\n}\n\nasync function handleIssueCreated(\n  fixfloIssueId: string,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Issue created: ${fixfloIssueId}`);\n  \n  // Check if we already have a maintenance request with this Fixflo Issue ID\n  // If not, this issue was created in Fixflo directly (not from Inspect360)\n  // We could optionally create a new maintenance request here\n}\n\nasync function handleIssueUpdated(\n  fixfloIssueId: string,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Issue updated: ${fixfloIssueId}`);\n\n  // Find maintenance request by Fixflo Issue ID\n  const maintenanceRequests = await storage.getMaintenanceByOrganization(organizationId);\n  const matchingRequest = maintenanceRequests.find(\n    (req: any) => req.fixfloIssueId === fixfloIssueId\n  );\n\n  if (!matchingRequest) {\n    console.log(`[Fixflo Webhook] No matching maintenance request found for issue ${fixfloIssueId}`);\n    return;\n  }\n\n  // Update maintenance request with latest Fixflo data\n  const updates: any = {\n    fixfloStatus: payload.status || payload.Issue?.Status,\n    fixfloSyncedAt: new Date(),\n  };\n\n  // Map Fixflo status to our status\n  const fixfloStatus = (payload.status || payload.Issue?.Status || \"\").toLowerCase();\n  if (fixfloStatus.includes(\"complete\") || fixfloStatus.includes(\"closed\")) {\n    updates.status = \"completed\";\n  } else if (fixfloStatus.includes(\"progress\")) {\n    updates.status = \"in_progress\";\n  }\n\n  await storage.updateMaintenanceRequest(matchingRequest.id, updates);\n  console.log(`[Fixflo Webhook] Updated maintenance request ${matchingRequest.id}`);\n}\n\nasync function handleContractorAssigned(\n  fixfloIssueId: string,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Contractor assigned to issue: ${fixfloIssueId}`);\n\n  // Find maintenance request\n  const maintenanceRequests = await storage.getMaintenanceByOrganization(organizationId);\n  const matchingRequest = maintenanceRequests.find(\n    (req: any) => req.fixfloIssueId === fixfloIssueId\n  );\n\n  if (!matchingRequest) {\n    return;\n  }\n\n  // Update with contractor info\n  const contractorName = \n    payload.assignedAgent?.name || \n    payload.AssignedAgent?.Name ||\n    payload.contractor?.name;\n\n  const updates: any = {\n    fixfloContractorName: contractorName,\n    fixfloSyncedAt: new Date(),\n  };\n\n  await storage.updateMaintenanceRequest(matchingRequest.id, updates);\n  console.log(`[Fixflo Webhook] Updated contractor for maintenance request ${matchingRequest.id}`);\n}\n\nasync function handleJobCompleted(\n  fixfloIssueId: string,\n  fixfloJobId: string | undefined,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Job completed: ${fixfloIssueId}`);\n\n  // Find maintenance request\n  const maintenanceRequests = await storage.getMaintenanceByOrganization(organizationId);\n  const matchingRequest = maintenanceRequests.find(\n    (req: any) => req.fixfloIssueId === fixfloIssueId || req.fixfloJobId === fixfloJobId\n  );\n\n  if (!matchingRequest) {\n    return;\n  }\n\n  // Mark as completed\n  const updates: any = {\n    status: \"completed\",\n    fixfloStatus: \"Completed\",\n    fixfloJobId: fixfloJobId,\n    fixfloSyncedAt: new Date(),\n  };\n\n  await storage.updateMaintenanceRequest(matchingRequest.id, updates);\n  console.log(`[Fixflo Webhook] Marked maintenance request ${matchingRequest.id} as completed`);\n}\n\nasync function handleInvoiceAdded(\n  fixfloIssueId: string,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Invoice added to issue: ${fixfloIssueId}`);\n  \n  // Find maintenance request\n  const maintenanceRequests = await storage.getMaintenanceByOrganization(organizationId);\n  const matchingRequest = maintenanceRequests.find(\n    (req: any) => req.fixfloIssueId === fixfloIssueId\n  );\n\n  if (!matchingRequest) {\n    return;\n  }\n\n  // Store invoice data in aiAnalysisJson for now\n  // In future, might want a dedicated invoices table\n  const currentAnalysis = (matchingRequest.aiAnalysisJson as any) || {};\n  const invoiceData = {\n    amount: payload.invoice?.amount || payload.Invoice?.Amount,\n    invoiceNumber: payload.invoice?.number || payload.Invoice?.Number,\n    date: payload.invoice?.date || payload.Invoice?.Date,\n    description: payload.invoice?.description || payload.Invoice?.Description,\n  };\n\n  const updates: any = {\n    aiAnalysisJson: {\n      ...currentAnalysis,\n      fixfloInvoice: invoiceData,\n    },\n    fixfloSyncedAt: new Date(),\n  };\n\n  await storage.updateMaintenanceRequest(matchingRequest.id, updates);\n  console.log(`[Fixflo Webhook] Added invoice data to maintenance request ${matchingRequest.id}`);\n}\n\nasync function handleAttachmentAdded(\n  fixfloIssueId: string,\n  payload: any,\n  organizationId: string,\n  storage: DatabaseStorage\n): Promise<void> {\n  console.log(`[Fixflo Webhook] Attachment added to issue: ${fixfloIssueId}`);\n\n  // Find maintenance request\n  const maintenanceRequests = await storage.getMaintenanceByOrganization(organizationId);\n  const matchingRequest = maintenanceRequests.find(\n    (req: any) => req.fixfloIssueId === fixfloIssueId\n  );\n\n  if (!matchingRequest) {\n    return;\n  }\n\n  // Get attachment URL from payload\n  const attachmentUrl = payload.attachment?.url || payload.Attachment?.Url;\n  \n  if (!attachmentUrl) {\n    console.log(`[Fixflo Webhook] No attachment URL in payload`);\n    return;\n  }\n\n  // Add to photoUrls array\n  const currentPhotoUrls = matchingRequest.photoUrls || [];\n  const updatedPhotoUrls = [...currentPhotoUrls, attachmentUrl];\n\n  const updates: any = {\n    photoUrls: updatedPhotoUrls,\n    fixfloSyncedAt: new Date(),\n  };\n\n  await storage.updateMaintenanceRequest(matchingRequest.id, updates);\n  console.log(`[Fixflo Webhook] Added attachment to maintenance request ${matchingRequest.id}`);\n}\n","size_bytes":8725},"client/src/components/FixfloIntegrationSettings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { CheckCircle, XCircle, AlertCircle, RefreshCw, Settings, Link as LinkIcon } from \"lucide-react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport type { Property } from \"@shared/schema\";\n\ninterface FixfloConfig {\n  id: string;\n  organizationId: string;\n  baseUrl: string;\n  bearerToken?: string;\n  webhookVerifyToken?: string;\n  isEnabled: boolean;\n  lastHealthCheckAt?: string;\n  healthCheckStatus?: string;\n  healthCheckErrorMessage?: string;\n}\n\ninterface FixfloSyncState {\n  id: string;\n  organizationId: string;\n  entityType: string;\n  lastSyncAt?: string;\n  lastSuccessfulSyncAt?: string;\n  syncStatus: string;\n  errorMessage?: string;\n  recordsSynced: number;\n  recordsFailed: number;\n}\n\nexport default function FixfloIntegrationSettings() {\n  const { toast } = useToast();\n  const [baseUrl, setBaseUrl] = useState(\"\");\n  const [bearerToken, setBearerToken] = useState(\"\");\n  const [webhookVerifyToken, setWebhookVerifyToken] = useState(\"\");\n  const [isEnabled, setIsEnabled] = useState(false);\n  const [selectedProperty, setSelectedProperty] = useState<Property | null>(null);\n  const [fixfloPropertyId, setFixfloPropertyId] = useState(\"\");\n  const [isPropertyDialogOpen, setIsPropertyDialogOpen] = useState(false);\n\n  // Fetch Fixflo configuration\n  const { data: config, isLoading: configLoading } = useQuery<FixfloConfig>({\n    queryKey: [\"/api/fixflo/config\"],\n  });\n\n  // Fetch sync state\n  const { data: syncStates = [], isLoading: syncLoading } = useQuery<FixfloSyncState[]>({\n    queryKey: [\"/api/fixflo/sync-state\"],\n  });\n\n  // Fetch properties for mapping\n  const { data: properties = [] } = useQuery<Property[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  // Initialize form when config loads\n  useEffect(() => {\n    if (config) {\n      setBaseUrl(config.baseUrl || \"\");\n      setIsEnabled(config.isEnabled);\n    }\n  }, [config]);\n\n  // Save configuration mutation\n  const saveConfigMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/fixflo/config\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fixflo/config\"] });\n      toast({\n        title: \"Configuration Saved\",\n        description: \"Fixflo integration settings have been updated\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to save configuration\",\n      });\n    },\n  });\n\n  // Test connection mutation\n  const testConnectionMutation = useMutation({\n    mutationFn: async () => {\n      const testData: any = {\n        baseUrl: baseUrl || config?.baseUrl,\n      };\n      // Only include bearerToken if user has entered a new value\n      if (bearerToken.trim()) {\n        testData.bearerToken = bearerToken.trim();\n      }\n      return await apiRequest(\"POST\", \"/api/fixflo/health-check\", testData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fixflo/config\"] });\n      toast({\n        title: \"Connection Successful\",\n        description: \"Successfully connected to Fixflo API\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Connection Failed\",\n        description: error.message || \"Failed to connect to Fixflo API\",\n      });\n    },\n  });\n\n  // Update property mapping mutation\n  const updatePropertyMutation = useMutation({\n    mutationFn: async ({ propertyId, fixfloPropertyId }: { propertyId: string; fixfloPropertyId: string }) => {\n      return await apiRequest(\"PATCH\", `/api/properties/${propertyId}`, { fixfloPropertyId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/properties\"] });\n      toast({\n        title: \"Property Mapping Updated\",\n        description: \"Property has been linked to Fixflo\",\n      });\n      setIsPropertyDialogOpen(false);\n      setSelectedProperty(null);\n      setFixfloPropertyId(\"\");\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update property mapping\",\n      });\n    },\n  });\n\n  const handleSaveConfig = () => {\n    const configData: any = {\n      baseUrl: baseUrl.trim(),\n      isEnabled,\n    };\n\n    if (bearerToken.trim()) {\n      configData.bearerToken = bearerToken.trim();\n    }\n    if (webhookVerifyToken.trim()) {\n      configData.webhookVerifyToken = webhookVerifyToken.trim();\n    }\n\n    saveConfigMutation.mutate(configData);\n  };\n\n  const handleTestConnection = () => {\n    if (!baseUrl && !config?.baseUrl) {\n      toast({\n        variant: \"destructive\",\n        title: \"Base URL Required\",\n        description: \"Please enter a Fixflo API base URL\",\n      });\n      return;\n    }\n    testConnectionMutation.mutate();\n  };\n\n  const handleOpenPropertyDialog = (property: Property) => {\n    setSelectedProperty(property);\n    setFixfloPropertyId(property.fixfloPropertyId || \"\");\n    setIsPropertyDialogOpen(true);\n  };\n\n  const handleSavePropertyMapping = () => {\n    if (!selectedProperty) return;\n    updatePropertyMutation.mutate({\n      propertyId: selectedProperty.id,\n      fixfloPropertyId: fixfloPropertyId.trim(),\n    });\n  };\n\n  const getStatusBadge = (status?: string) => {\n    switch (status) {\n      case \"success\":\n        return <Badge variant=\"default\" className=\"bg-green-500\"><CheckCircle className=\"w-3 h-3 mr-1\" />Healthy</Badge>;\n      case \"error\":\n        return <Badge variant=\"destructive\"><XCircle className=\"w-3 h-3 mr-1\" />Error</Badge>;\n      default:\n        return <Badge variant=\"secondary\"><AlertCircle className=\"w-3 h-3 mr-1\" />Unknown</Badge>;\n    }\n  };\n\n  const getSyncStatusBadge = (status: string) => {\n    switch (status) {\n      case \"syncing\":\n        return <Badge variant=\"secondary\"><RefreshCw className=\"w-3 h-3 mr-1 animate-spin\" />Syncing</Badge>;\n      case \"error\":\n        return <Badge variant=\"destructive\"><XCircle className=\"w-3 h-3 mr-1\" />Error</Badge>;\n      case \"idle\":\n      default:\n        return <Badge variant=\"outline\">Idle</Badge>;\n    }\n  };\n\n  if (configLoading || syncLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <RefreshCw className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Tabs defaultValue=\"configuration\" className=\"w-full\">\n        <TabsList>\n          <TabsTrigger value=\"configuration\" data-testid=\"tab-fixflo-configuration\">\n            <Settings className=\"w-4 h-4 mr-2\" />\n            Configuration\n          </TabsTrigger>\n          <TabsTrigger value=\"property-mapping\" data-testid=\"tab-fixflo-property-mapping\">\n            <LinkIcon className=\"w-4 h-4 mr-2\" />\n            Property Mapping\n          </TabsTrigger>\n          <TabsTrigger value=\"sync-status\" data-testid=\"tab-fixflo-sync-status\">\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Sync Status\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"configuration\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Fixflo API Configuration</CardTitle>\n              <CardDescription>\n                Configure your Fixflo integration settings to sync maintenance requests with Fixflo.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"baseUrl\">Fixflo API Base URL</Label>\n                <Input\n                  id=\"baseUrl\"\n                  placeholder=\"https://api.fixflo.com\"\n                  value={baseUrl}\n                  onChange={(e) => setBaseUrl(e.target.value)}\n                  data-testid=\"input-fixflo-base-url\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  The base URL for your Fixflo API instance\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"bearerToken\">Bearer Token</Label>\n                <Input\n                  id=\"bearerToken\"\n                  type=\"password\"\n                  placeholder=\"Enter bearer token (optional to update)\"\n                  value={bearerToken}\n                  onChange={(e) => setBearerToken(e.target.value)}\n                  data-testid=\"input-fixflo-bearer-token\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  Your Fixflo API bearer token for authentication\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"webhookToken\">Webhook Verify Token</Label>\n                <Input\n                  id=\"webhookToken\"\n                  type=\"password\"\n                  placeholder=\"Enter webhook token (optional to update)\"\n                  value={webhookVerifyToken}\n                  onChange={(e) => setWebhookVerifyToken(e.target.value)}\n                  data-testid=\"input-fixflo-webhook-token\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  Token for verifying incoming webhooks from Fixflo\n                </p>\n              </div>\n\n              <div className=\"flex items-center space-x-2\">\n                <input\n                  type=\"checkbox\"\n                  id=\"isEnabled\"\n                  checked={isEnabled}\n                  onChange={(e) => setIsEnabled(e.target.checked)}\n                  className=\"w-4 h-4\"\n                  data-testid=\"checkbox-fixflo-enabled\"\n                />\n                <Label htmlFor=\"isEnabled\" className=\"cursor-pointer\">\n                  Enable Fixflo Integration\n                </Label>\n              </div>\n\n              {config?.lastHealthCheckAt && (\n                <div className=\"flex items-center justify-between p-4 border rounded-md bg-muted/50\">\n                  <div>\n                    <p className=\"text-sm font-medium\">Last Health Check</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {new Date(config.lastHealthCheckAt).toLocaleString()}\n                    </p>\n                  </div>\n                  {getStatusBadge(config.healthCheckStatus)}\n                </div>\n              )}\n\n              {config?.healthCheckErrorMessage && (\n                <div className=\"p-4 border border-destructive/50 rounded-md bg-destructive/10\">\n                  <p className=\"text-sm font-medium text-destructive\">Error Message</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">{config.healthCheckErrorMessage}</p>\n                </div>\n              )}\n\n              <div className=\"flex gap-2 pt-4\">\n                <Button\n                  onClick={handleSaveConfig}\n                  disabled={saveConfigMutation.isPending}\n                  data-testid=\"button-save-fixflo-config\"\n                >\n                  {saveConfigMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={handleTestConnection}\n                  disabled={testConnectionMutation.isPending}\n                  data-testid=\"button-test-fixflo-connection\"\n                >\n                  {testConnectionMutation.isPending ? (\n                    <>\n                      <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                      Testing...\n                    </>\n                  ) : (\n                    \"Test Connection\"\n                  )}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"property-mapping\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Property Mapping</CardTitle>\n              <CardDescription>\n                Link your Inspect360 properties to Fixflo property IDs for automatic sync\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Property</TableHead>\n                    <TableHead>Address</TableHead>\n                    <TableHead>Fixflo Property ID</TableHead>\n                    <TableHead>Action</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {properties.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={4} className=\"text-center text-muted-foreground\">\n                        No properties found\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    properties.map((property) => (\n                      <TableRow key={property.id}>\n                        <TableCell className=\"font-medium\" data-testid={`text-property-${property.id}`}>\n                          {property.name}\n                        </TableCell>\n                        <TableCell className=\"text-sm text-muted-foreground\">\n                          {property.address || \"N/A\"}\n                        </TableCell>\n                        <TableCell>\n                          {property.fixfloPropertyId ? (\n                            <Badge variant=\"outline\" data-testid={`badge-fixflo-id-${property.id}`}>\n                              {property.fixfloPropertyId}\n                            </Badge>\n                          ) : (\n                            <span className=\"text-sm text-muted-foreground\">Not mapped</span>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleOpenPropertyDialog(property)}\n                            data-testid={`button-map-property-${property.id}`}\n                          >\n                            <LinkIcon className=\"w-4 h-4 mr-2\" />\n                            {property.fixfloPropertyId ? \"Update\" : \"Map\"}\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))\n                  )}\n                </TableBody>\n              </Table>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"sync-status\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Sync Status</CardTitle>\n              <CardDescription>\n                Monitor the status of data synchronization with Fixflo\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Entity Type</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Last Sync</TableHead>\n                    <TableHead>Records Synced</TableHead>\n                    <TableHead>Records Failed</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {syncStates.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={5} className=\"text-center text-muted-foreground\">\n                        No sync activity yet\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    syncStates.map((state) => (\n                      <TableRow key={state.id}>\n                        <TableCell className=\"font-medium capitalize\">\n                          {state.entityType}\n                        </TableCell>\n                        <TableCell>{getSyncStatusBadge(state.syncStatus)}</TableCell>\n                        <TableCell className=\"text-sm text-muted-foreground\">\n                          {state.lastSyncAt\n                            ? new Date(state.lastSyncAt).toLocaleString()\n                            : \"Never\"}\n                        </TableCell>\n                        <TableCell>{state.recordsSynced}</TableCell>\n                        <TableCell>\n                          {state.recordsFailed > 0 ? (\n                            <span className=\"text-destructive font-medium\">\n                              {state.recordsFailed}\n                            </span>\n                          ) : (\n                            state.recordsFailed\n                          )}\n                        </TableCell>\n                      </TableRow>\n                    ))\n                  )}\n                </TableBody>\n              </Table>\n              \n              {syncStates.some((state) => state.errorMessage) && (\n                <div className=\"mt-4 space-y-2\">\n                  <h4 className=\"font-medium text-sm\">Recent Errors</h4>\n                  {syncStates\n                    .filter((state) => state.errorMessage)\n                    .map((state) => (\n                      <div\n                        key={state.id}\n                        className=\"p-3 border border-destructive/50 rounded-md bg-destructive/10\"\n                      >\n                        <p className=\"text-sm font-medium text-destructive capitalize\">\n                          {state.entityType}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {state.errorMessage}\n                        </p>\n                      </div>\n                    ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={isPropertyDialogOpen} onOpenChange={setIsPropertyDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Map Property to Fixflo</DialogTitle>\n            <DialogDescription>\n              Enter the Fixflo property ID for {selectedProperty?.name}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"fixfloPropertyId\">Fixflo Property ID</Label>\n              <Input\n                id=\"fixfloPropertyId\"\n                placeholder=\"Enter Fixflo property ID\"\n                value={fixfloPropertyId}\n                onChange={(e) => setFixfloPropertyId(e.target.value)}\n                data-testid=\"input-fixflo-property-id\"\n              />\n              <p className=\"text-sm text-muted-foreground\">\n                This ID is used to link maintenance requests to the correct property in Fixflo\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setIsPropertyDialogOpen(false)}\n              data-testid=\"button-cancel-property-mapping\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSavePropertyMapping}\n              disabled={updatePropertyMutation.isPending || !fixfloPropertyId.trim()}\n              data-testid=\"button-save-property-mapping\"\n            >\n              {updatePropertyMutation.isPending ? \"Saving...\" : \"Save Mapping\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":20268},"client/src/components/FixfloSyncButton.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { RefreshCw, ExternalLink, CheckCircle, AlertCircle } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface FixfloSyncButtonProps {\n  requestId: string;\n  propertyId: string;\n  fixfloIssueId?: string | null;\n  fixfloStatus?: string | null;\n  fixfloContractorName?: string | null;\n  title: string;\n}\n\nexport function FixfloSyncButton({\n  requestId,\n  propertyId,\n  fixfloIssueId,\n  fixfloStatus,\n  fixfloContractorName,\n  title,\n}: FixfloSyncButtonProps) {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n\n  // Sync to Fixflo mutation\n  const syncMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/fixflo/issues\", {\n        maintenanceRequestId: requestId,\n        propertyId,\n      });\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/maintenance\"] });\n      toast({\n        title: \"Synced to Fixflo\",\n        description: `Maintenance request \"${title}\" has been synced to Fixflo`,\n      });\n      setIsDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Sync Failed\",\n        description: error.message || \"Failed to sync to Fixflo. Please check your integration settings.\",\n      });\n    },\n  });\n\n  const handleSync = () => {\n    syncMutation.mutate();\n  };\n\n  // If already synced, show status badge\n  if (fixfloIssueId) {\n    return (\n      <div className=\"flex flex-col gap-1\" data-testid={`fixflo-status-${requestId}`}>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Badge \n              variant=\"outline\" \n              className=\"gap-1 cursor-help\"\n              data-testid={`badge-fixflo-status-${requestId}`}\n            >\n              <CheckCircle className=\"w-3 h-3 text-green-500\" />\n              Synced to Fixflo\n            </Badge>\n          </TooltipTrigger>\n          <TooltipContent>\n            <div className=\"text-xs space-y-1\">\n              <p><strong>Issue ID:</strong> {fixfloIssueId}</p>\n              {fixfloStatus && <p><strong>Status:</strong> {fixfloStatus}</p>}\n              {fixfloContractorName && <p><strong>Contractor:</strong> {fixfloContractorName}</p>}\n            </div>\n          </TooltipContent>\n        </Tooltip>\n        {fixfloContractorName && (\n          <Badge variant=\"secondary\" className=\"text-xs\" data-testid={`badge-contractor-${requestId}`}>\n            {fixfloContractorName}\n          </Badge>\n        )}\n      </div>\n    );\n  }\n\n  // Show sync button for unsync'd requests\n  return (\n    <>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setIsDialogOpen(true)}\n            className=\"gap-2\"\n            data-testid={`button-sync-fixflo-${requestId}`}\n          >\n            <ExternalLink className=\"w-4 h-4\" />\n            Sync to Fixflo\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>Send this maintenance request to Fixflo</p>\n        </TooltipContent>\n      </Tooltip>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Sync to Fixflo</DialogTitle>\n            <DialogDescription>\n              This will create a new issue in Fixflo for this maintenance request.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium\">Maintenance Request</p>\n              <p className=\"text-sm text-muted-foreground\">{title}</p>\n            </div>\n            <div className=\"p-4 bg-muted rounded-md\">\n              <p className=\"text-xs text-muted-foreground mb-2\">\n                The following information will be synced to Fixflo:\n              </p>\n              <ul className=\"text-xs text-muted-foreground space-y-1 list-disc list-inside\">\n                <li>Request title and description</li>\n                <li>Priority level</li>\n                <li>Property information</li>\n                <li>Any uploaded photos</li>\n              </ul>\n            </div>\n            <div className=\"flex items-start gap-2 p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-md\">\n              <AlertCircle className=\"w-4 h-4 text-blue-600 dark:text-blue-400 mt-0.5\" />\n              <p className=\"text-xs text-blue-900 dark:text-blue-100\">\n                Once synced, status updates from Fixflo will automatically be reflected here.\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setIsDialogOpen(false)}\n              disabled={syncMutation.isPending}\n              data-testid=\"button-cancel-sync\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSync}\n              disabled={syncMutation.isPending}\n              data-testid=\"button-confirm-sync\"\n            >\n              {syncMutation.isPending ? (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Syncing...\n                </>\n              ) : (\n                <>\n                  <ExternalLink className=\"w-4 h-4 mr-2\" />\n                  Sync to Fixflo\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","size_bytes":6061},"client/src/components/PWAInstallPrompt.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { X, Download, Share } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\ninterface BeforeInstallPromptEvent extends Event {\n  prompt: () => Promise<void>;\n  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;\n}\n\nexport function PWAInstallPrompt() {\n  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);\n  const [showIOSInstructions, setShowIOSInstructions] = useState(false);\n  const [showAndroidPrompt, setShowAndroidPrompt] = useState(false);\n  const [isDismissed, setIsDismissed] = useState(false);\n\n  // Detect if running in standalone mode (already installed)\n  const isStandalone = () => {\n    return window.matchMedia('(display-mode: standalone)').matches ||\n           (window.navigator as any).standalone === true;\n  };\n\n  // Detect iOS Safari\n  const isIOSSafari = () => {\n    const ua = window.navigator.userAgent;\n    const iOS = /iPhone|iPad|iPod/.test(ua);\n    const webkit = /WebKit/.test(ua);\n    const notChrome = !/CriOS/.test(ua);\n    const notFirefox = !/FxiOS/.test(ua);\n    \n    return iOS && webkit && notChrome && notFirefox;\n  };\n\n  // Check if user has previously dismissed the prompt\n  const hasBeenDismissed = () => {\n    const dismissed = localStorage.getItem('pwa-install-dismissed');\n    if (!dismissed) return false;\n    \n    // Check if dismissed more than 7 days ago\n    const dismissedTime = parseInt(dismissed, 10);\n    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);\n    return dismissedTime > sevenDaysAgo;\n  };\n\n  useEffect(() => {\n    // Don't show if already installed or dismissed\n    if (isStandalone() || hasBeenDismissed()) {\n      return;\n    }\n\n    // Android: Listen for beforeinstallprompt event\n    const handleBeforeInstallPrompt = (e: Event) => {\n      e.preventDefault();\n      setDeferredPrompt(e as BeforeInstallPromptEvent);\n      setShowAndroidPrompt(true);\n    };\n\n    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n\n    // iOS: Show instructions after 5 seconds of page load\n    if (isIOSSafari()) {\n      const timer = setTimeout(() => {\n        setShowIOSInstructions(true);\n      }, 5000);\n      \n      return () => {\n        clearTimeout(timer);\n        window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n      };\n    }\n\n    // Track successful installation\n    const handleAppInstalled = () => {\n      setShowAndroidPrompt(false);\n      setDeferredPrompt(null);\n      localStorage.removeItem('pwa-install-dismissed');\n    };\n\n    window.addEventListener('appinstalled', handleAppInstalled);\n\n    return () => {\n      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n      window.removeEventListener('appinstalled', handleAppInstalled);\n    };\n  }, []);\n\n  const handleInstallClick = async () => {\n    if (!deferredPrompt) return;\n\n    try {\n      await deferredPrompt.prompt();\n      const choiceResult = await deferredPrompt.userChoice;\n\n      if (choiceResult.outcome === 'accepted') {\n        console.log('User accepted the install prompt');\n      } else {\n        console.log('User dismissed the install prompt');\n      }\n\n      setDeferredPrompt(null);\n      setShowAndroidPrompt(false);\n    } catch (error) {\n      console.error('Error showing install prompt:', error);\n    }\n  };\n\n  const handleDismiss = () => {\n    setIsDismissed(true);\n    setShowAndroidPrompt(false);\n    setShowIOSInstructions(false);\n    localStorage.setItem('pwa-install-dismissed', Date.now().toString());\n  };\n\n  // Don't render if dismissed\n  if (isDismissed || isStandalone()) {\n    return null;\n  }\n\n  // Android Install Prompt\n  if (showAndroidPrompt && deferredPrompt) {\n    return (\n      <div className=\"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-md\">\n        <Card className=\"shadow-lg border-2 border-primary/20\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-start justify-between gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <Download className=\"w-5 h-5 text-primary\" />\n                <CardTitle className=\"text-base\">Install Inspect360</CardTitle>\n              </div>\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"h-6 w-6 -mt-1\"\n                onClick={handleDismiss}\n                data-testid=\"button-dismiss-install\"\n              >\n                <X className=\"w-4 h-4\" />\n              </Button>\n            </div>\n            <CardDescription className=\"text-sm\">\n              Install our app for quick access, offline support, and a better experience\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"pb-4\">\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={handleInstallClick}\n                className=\"flex-1\"\n                data-testid=\"button-install-pwa\"\n              >\n                Install App\n              </Button>\n              <Button\n                onClick={handleDismiss}\n                variant=\"outline\"\n                data-testid=\"button-not-now\"\n              >\n                Not Now\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // iOS Instructions\n  if (showIOSInstructions && isIOSSafari()) {\n    return (\n      <div className=\"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-md\">\n        <Alert className=\"shadow-lg border-2 border-primary/20 bg-card\">\n          <div className=\"flex items-start justify-between gap-2\">\n            <Share className=\"w-5 h-5 text-primary mt-0.5\" />\n            <div className=\"flex-1\">\n              <h4 className=\"font-semibold mb-1 text-sm\">Install Inspect360</h4>\n              <AlertDescription className=\"text-sm space-y-2\">\n                <p>Add this app to your home screen for quick access:</p>\n                <ol className=\"list-decimal list-inside space-y-1 text-xs text-muted-foreground\">\n                  <li>Tap the <strong>Share</strong> button <Share className=\"w-3 h-3 inline\" /> below</li>\n                  <li>Scroll down and tap <strong>\"Add to Home Screen\"</strong></li>\n                  <li>Tap <strong>\"Add\"</strong> to confirm</li>\n                </ol>\n                <Button\n                  onClick={handleDismiss}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"w-full mt-2\"\n                  data-testid=\"button-dismiss-ios-instructions\"\n                >\n                  Got it\n                </Button>\n              </AlertDescription>\n            </div>\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"h-6 w-6 -mt-1\"\n              onClick={handleDismiss}\n              data-testid=\"button-close-ios-instructions\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </Alert>\n      </div>\n    );\n  }\n\n  return null;\n}\n","size_bytes":7241},"server/subscriptionService.ts":{"content":"import { storage } from \"./storage\";\nimport type { Organization, CreditBatch, InsertCreditBatch, InsertCreditLedger } from \"@shared/schema\";\n\nexport class SubscriptionService {\n  /**\n   * Consume credits using FIFO logic from available batches\n   * @param organizationId - Organization consuming credits\n   * @param quantity - Number of credits to consume\n   * @param linkedEntityType - Type of entity consuming credits (e.g., \"inspection\")\n   * @param linkedEntityId - ID of the entity consuming credits\n   * @param notes - Optional notes about the consumption\n   * @returns true if successful, throws error if insufficient credits\n   */\n  async consumeCredits(\n    organizationId: string,\n    quantity: number,\n    linkedEntityType: string,\n    linkedEntityId: string,\n    notes?: string\n  ): Promise<void> {\n    if (quantity <= 0) {\n      throw new Error(\"Quantity must be positive\");\n    }\n\n    // Get available batches ordered by FIFO (earliest expiry first)\n    const batches = await storage.getAvailableCreditBatches(organizationId);\n    \n    // First, calculate total available credits and plan deductions WITHOUT modifying database\n    let totalAvailable = 0;\n    const plannedDeductions: Array<{ \n      batch: CreditBatch; \n      toConsume: number; \n      newRemaining: number;\n      unitCost?: number;\n    }> = [];\n    \n    let remainingToConsume = quantity;\n    \n    for (const batch of batches) {\n      totalAvailable += batch.remainingQuantity;\n      \n      if (remainingToConsume > 0) {\n        const toConsume = Math.min(batch.remainingQuantity, remainingToConsume);\n        plannedDeductions.push({\n          batch,\n          toConsume,\n          newRemaining: batch.remainingQuantity - toConsume,\n          unitCost: batch.unitCostMinorUnits ?? undefined,\n        });\n        remainingToConsume -= toConsume;\n      }\n    }\n\n    // Check if we have insufficient credits BEFORE making any changes\n    if (remainingToConsume > 0) {\n      throw new Error(`Insufficient credits. Needed ${quantity}, available ${totalAvailable}.`);\n    }\n\n    // Only NOW apply the planned deductions to the database\n    const consumedBatches: Array<{ batchId: string; consumed: number; unitCost?: number }> = [];\n    \n    for (const deduction of plannedDeductions) {\n      await storage.updateCreditBatch(deduction.batch.id, {\n        remainingQuantity: deduction.newRemaining,\n      });\n\n      consumedBatches.push({\n        batchId: deduction.batch.id,\n        consumed: deduction.toConsume,\n        unitCost: deduction.unitCost,\n      });\n    }\n\n    // Record consumption in credit ledger\n    for (const consumed of consumedBatches) {\n      await storage.createCreditLedgerEntry({\n        organizationId,\n        source: \"consumption\" as any,\n        quantity: -consumed.consumed,\n        batchId: consumed.batchId,\n        unitCostMinorUnits: consumed.unitCost,\n        notes: notes || `Consumed ${consumed.consumed} credits for ${linkedEntityType}`,\n        linkedEntityType,\n        linkedEntityId,\n      });\n    }\n\n    // Also update the legacy creditsRemaining field for backward compatibility\n    const org = await storage.getOrganization(organizationId);\n    if (org) {\n      await storage.updateOrganizationCredits(\n        organizationId,\n        Math.max(0, (org.creditsRemaining ?? 0) - quantity)\n      );\n    }\n  }\n\n  /**\n   * Grant credits to an organization (from plan inclusion, top-up, or admin grant)\n   * @param organizationId - Organization receiving credits\n   * @param quantity - Number of credits to grant\n   * @param source - Source of credits (\"plan_inclusion\", \"topup\", \"admin_grant\")\n   * @param expiresAt - Optional expiration date\n   * @param metadata - Optional metadata (subscriptionId, topupOrderId, adminNotes)\n   * @param unitCostMinorUnits - Optional unit cost for valuation\n   * @returns Created credit batch\n   */\n  async grantCredits(\n    organizationId: string,\n    quantity: number,\n    source: \"plan_inclusion\" | \"topup\" | \"admin_grant\",\n    expiresAt?: Date,\n    metadata?: { subscriptionId?: string; topupOrderId?: string; adminNotes?: string; createdBy?: string },\n    unitCostMinorUnits?: number\n  ): Promise<CreditBatch> {\n    if (quantity <= 0) {\n      throw new Error(\"Quantity must be positive\");\n    }\n\n    // Create credit batch\n    const batch = await storage.createCreditBatch({\n      organizationId,\n      grantedQuantity: quantity,\n      remainingQuantity: quantity,\n      grantSource: source as any,\n      grantedAt: new Date(),\n      expiresAt: expiresAt ?? null,\n      unitCostMinorUnits: unitCostMinorUnits ?? null,\n      rolled: false,\n      metadataJson: metadata ?? null,\n    });\n\n    // Record in credit ledger\n    await storage.createCreditLedgerEntry({\n      organizationId,\n      createdBy: metadata?.createdBy ?? null,\n      source: source as any,\n      quantity,\n      batchId: batch.id,\n      unitCostMinorUnits: unitCostMinorUnits ?? null,\n      notes: `Granted ${quantity} credits from ${source}`,\n      linkedEntityType: source === \"topup\" ? \"topup_order\" : \"subscription\",\n      linkedEntityId: metadata?.topupOrderId ?? metadata?.subscriptionId ?? null,\n    });\n\n    // Also update the legacy creditsRemaining field for backward compatibility\n    const org = await storage.getOrganization(organizationId);\n    if (org) {\n      await storage.updateOrganizationCredits(\n        organizationId,\n        (org.creditsRemaining ?? 0) + quantity\n      );\n    }\n\n    return batch;\n  }\n\n  /**\n   * Handle rollover logic at billing cycle start\n   * @param organizationId - Organization to process\n   * @param currentPeriodEnd - End of the current billing period\n   */\n  async processRollover(organizationId: string, currentPeriodEnd: Date): Promise<void> {\n    const now = new Date();\n    \n    // Get all batches for the organization\n    const allBatches = await storage.getCreditBatchesByOrganization(organizationId);\n\n    // Expire old rolled batches (from previous cycle)\n    const oldRolledBatches = allBatches.filter(\n      b => b.rolled && b.expiresAt && b.expiresAt < now && b.remainingQuantity > 0\n    );\n\n    for (const batch of oldRolledBatches) {\n      await storage.expireCreditBatch(batch.id);\n      \n      // Record expiry in ledger\n      await storage.createCreditLedgerEntry({\n        organizationId,\n        source: \"expiry\" as any,\n        quantity: -batch.remainingQuantity,\n        batchId: batch.id,\n        notes: `Expired ${batch.remainingQuantity} rolled credits from previous cycle`,\n      });\n    }\n\n    // Find last cycle's main batch (non-rolled, with remaining credits)\n    const lastCycleBatch = allBatches.find(\n      b => !b.rolled && b.remainingQuantity > 0 && b.expiresAt && b.expiresAt <= now\n    );\n\n    if (lastCycleBatch && lastCycleBatch.remainingQuantity > 0) {\n      // Roll over remaining credits to new batch\n      const rolledBatch = await storage.createCreditBatch({\n        organizationId,\n        grantedQuantity: lastCycleBatch.remainingQuantity,\n        remainingQuantity: lastCycleBatch.remainingQuantity,\n        grantSource: \"plan_inclusion\" as any,\n        grantedAt: new Date(),\n        expiresAt: currentPeriodEnd,\n        rolled: true,\n        metadataJson: {\n          originalBatchId: lastCycleBatch.id,\n        } as any,\n      });\n\n      // Record rollover in ledger\n      await storage.createCreditLedgerEntry({\n        organizationId,\n        source: \"plan_inclusion\" as any,\n        quantity: lastCycleBatch.remainingQuantity,\n        batchId: rolledBatch.id,\n        notes: `Rolled over ${lastCycleBatch.remainingQuantity} credits from previous cycle`,\n      });\n\n      // Mark original batch as consumed (set to 0)\n      await storage.updateCreditBatch(lastCycleBatch.id, {\n        remainingQuantity: 0,\n      });\n    }\n  }\n\n  /**\n   * Get effective pricing for a plan and country\n   * @param planId - Plan ID\n   * @param countryCode - ISO 3166-1 alpha-2 country code\n   * @returns Pricing information\n   */\n  async getEffectivePricing(\n    planId: string,\n    countryCode: string\n  ): Promise<{\n    monthlyPrice: number;\n    currency: string;\n    includedCredits: number;\n    topupPricePerCredit?: number;\n  }> {\n    // Get base plan\n    const plan = await storage.getPlan(planId);\n    if (!plan) {\n      throw new Error(\"Plan not found\");\n    }\n\n    // Check for country override\n    const override = await storage.getCountryPricingOverride(countryCode, planId);\n\n    if (override) {\n      return {\n        monthlyPrice: override.monthlyPriceMinorUnits,\n        currency: override.currency,\n        includedCredits: override.includedCreditsOverride ?? plan.includedCredits,\n        topupPricePerCredit: override.topupPricePerCreditMinorUnits ?? undefined,\n      };\n    }\n\n    // Return base plan pricing (GBP)\n    return {\n      monthlyPrice: plan.monthlyPriceGbp,\n      currency: \"GBP\",\n      includedCredits: plan.includedCredits,\n      topupPricePerCredit: 75, // Default 75 pence per credit\n    };\n  }\n\n  /**\n   * Calculate inspection credit cost based on complexity\n   * @param inspectionType - Type of inspection\n   * @param complexity - Complexity level (1, 2, or 3)\n   * @returns Number of credits required\n   */\n  calculateInspectionCreditCost(\n    inspectionType: string,\n    complexity: number = 1\n  ): number {\n    // Base cost is the complexity level\n    let cost = complexity;\n\n    // Cap at 3 credits maximum (as per specification)\n    return Math.min(cost, 3);\n  }\n}\n\nexport const subscriptionService = new SubscriptionService();\n","size_bytes":9474},"client/src/pages/Billing.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CreditCard, Package, TrendingUp, ExternalLink, Zap, AlertCircle, CheckCircle2 } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useLocation } from \"wouter\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport { format } from \"date-fns\";\nimport { getCurrencyForCountry, formatCurrency as formatCurrencyUtil } from \"@shared/countryUtils\";\n\ninterface Plan {\n  id: string;\n  code: string;\n  name: string;\n  monthlyPriceGbp: number;\n  annualPriceGbp?: number | null;\n  includedCredits: number;\n  includedCreditsPerMonth?: number; // For backwards compatibility\n  active: boolean;\n  isActive?: boolean;\n}\n\ninterface Subscription {\n  id: string;\n  organizationId: string;\n  planSnapshotJson: {\n    planName: string;\n    monthlyPrice: number;\n    includedCredits: number;\n    currency: string;\n  };\n  currentPeriodStart: string;\n  currentPeriodEnd: string;\n  status: string;\n  cancelAtPeriodEnd: boolean;\n}\n\ninterface CreditBalance {\n  available: number;\n  consumed: number;\n  expired: number;\n}\n\ninterface LedgerEntry {\n  id: string;\n  organizationType: string;\n  changeType: string;\n  quantity: number;\n  description: string;\n  notes?: string | null;\n  createdAt: string;\n  source: string;\n  createdByUser?: {\n    firstName: string | null;\n    lastName: string | null;\n    email: string | null;\n  } | null;\n}\n\nexport default function Billing() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const locale = useLocale();\n  const [selectedTopup, setSelectedTopup] = useState<number | null>(null);\n  const [topupDialogOpen, setTopupDialogOpen] = useState(false);\n  const [location, setLocation] = useLocation();\n  const [billingPeriod, setBillingPeriod] = useState<\"monthly\" | \"annual\">(\"monthly\");\n  \n  // Get currency from user's organization country (via locale context)\n  const currency = locale.currency;\n\n  // Fetch organization to get country code for proper currency detection and credits\n  const { data: organization } = useQuery<{ id: string; name: string; countryCode?: string; creditsRemaining: number | null }>({\n    queryKey: user?.organizationId ? [`/api/organizations/${user.organizationId}`] : [],\n    enabled: !!user?.organizationId,\n  });\n\n  // Update currency based on organization country if available\n  const effectiveCurrency = organization?.countryCode \n    ? getCurrencyForCountry(organization.countryCode)\n    : currency;\n\n  // Helper function to format price based on currency\n  const formatPrice = (penceAmount: number | null | undefined, curr: \"GBP\" | \"USD\" | \"AED\" = effectiveCurrency) => {\n    if (!penceAmount) return \"N/A\";\n    return formatCurrencyUtil(penceAmount, curr, true);\n  };\n\n  // Check for action=topup URL parameter and auto-open dialog\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get('action') === 'topup') {\n      setTopupDialogOpen(true);\n      // Remove the action parameter from URL\n      params.delete('action');\n      const newSearch = params.toString();\n      window.history.replaceState({}, '', `${window.location.pathname}${newSearch ? '?' + newSearch : ''}`);\n    }\n  }, []);\n\n  // Handle success/canceled query parameters with polling for webhook completion\n  useEffect(() => {\n    // Only run if user is loaded\n    if (!user) return;\n    \n    const params = new URLSearchParams(window.location.search);\n    const sessionId = params.get('session_id');\n    \n    // Helper function to poll for updated data\n    const pollForUpdates = (queryKeys: string[], maxAttempts = 5) => {\n      let attempts = 0;\n      \n      // Initial invalidation\n      queryKeys.forEach(key => {\n        queryClient.invalidateQueries({ queryKey: [key] });\n      });\n      \n      // Set up polling interval\n      const pollInterval = setInterval(() => {\n        attempts++;\n        \n        // Invalidate queries to trigger refetch\n        queryKeys.forEach(key => {\n          queryClient.invalidateQueries({ queryKey: [key] });\n        });\n        \n        // Stop after max attempts\n        if (attempts >= maxAttempts) {\n          clearInterval(pollInterval);\n        }\n      }, 2000); // Poll every 2 seconds\n      \n      return () => clearInterval(pollInterval);\n    };\n\n    \n    if (params.get('topup_success') === 'true') {\n      // Process the session immediately if we have a session_id\n      const processAndCleanup = async () => {\n        if (sessionId) {\n          try {\n            const response = await apiRequest(\"POST\", \"/api/billing/process-session\", { sessionId });\n            const result = await response.json();\n            console.log('[Billing] Session processed:', result);\n            \n            if (result.processed) {\n              // Invalidate queries to trigger refetch\n              queryClient.invalidateQueries({ queryKey: ['/api/billing/subscription'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/credits/balance'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/credits/ledger'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/billing/aggregate-credits'] });\n              queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n              \n              // Explicitly refetch the critical credit balance and organization queries to ensure immediate UI update\n              await Promise.all([\n                queryClient.refetchQueries({ queryKey: ['/api/credits/balance'] }),\n                queryClient.refetchQueries({ queryKey: [`/api/organizations/${user.organizationId}`] }),\n              ]);\n              \n              toast({\n                title: \"Payment Successful!\",\n                description: \"Your credits have been added to your account!\",\n              });\n            } else {\n              toast({\n                title: \"Processing Payment\",\n                description: \"Your payment is being processed...\",\n              });\n            }\n          } catch (error) {\n            console.error('[Billing] Error processing session:', error);\n            toast({\n              title: \"Payment Received\",\n              description: \"Your payment is being processed. Credits will appear shortly.\",\n              variant: \"default\",\n            });\n          }\n        }\n      };\n      \n      processAndCleanup();\n      \n      // Also poll for updates (in case webhook fires) and capture cleanup function\n      const cleanupPolling = pollForUpdates(['/api/credits/balance', '/api/credits/ledger', '/api/billing/aggregate-credits', `/api/organizations/${user.organizationId}`]);\n      \n      // Clean up URL after polling completes (12 seconds = 2s initial + 10s polling)\n      const urlCleanupTimer = setTimeout(() => {\n        setLocation('/billing', { replace: true });\n      }, 12000);\n      \n      // Return cleanup function for useEffect\n      return () => {\n        cleanupPolling();\n        clearTimeout(urlCleanupTimer);\n      };\n    } else if (params.get('topup_canceled') === 'true') {\n      toast({\n        title: \"Payment Canceled\",\n        description: \"Your payment was not completed.\",\n        variant: \"destructive\",\n      });\n      \n      // Clean up URL\n      setLocation('/billing', { replace: true });\n    } else if (params.get('success') === 'true') {\n      // Process the session immediately if we have a session_id\n      const processAndCleanup = async () => {\n        if (sessionId) {\n          try {\n            const response = await apiRequest(\"POST\", \"/api/billing/process-session\", { sessionId });\n            const result = await response.json();\n            console.log('[Billing] Session processed:', result);\n            \n            if (result.processed) {\n              // Small delay to ensure database write completes\n              await new Promise(resolve => setTimeout(resolve, 500));\n              \n              // Invalidate queries to trigger refetch\n              queryClient.invalidateQueries({ queryKey: ['/api/billing/subscription'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/credits/balance'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/credits/ledger'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/billing/aggregate-credits'] });\n              queryClient.invalidateQueries({ queryKey: [`/api/organizations/${user.organizationId}`] });\n              \n              // Explicitly refetch critical queries to ensure immediate UI update\n              console.log('[Billing] Refetching subscription and credit balance...');\n              await Promise.all([\n                queryClient.refetchQueries({ queryKey: ['/api/billing/subscription'] }),\n                queryClient.refetchQueries({ queryKey: ['/api/credits/balance'] }),\n                queryClient.refetchQueries({ queryKey: ['/api/credits/ledger'] }),\n                queryClient.refetchQueries({ queryKey: [`/api/organizations/${user.organizationId}`] }),\n              ]);\n              \n              console.log('[Billing] Queries refetched, subscription should now be visible');\n              \n              toast({\n                title: \"Subscription Active!\",\n                description: result.alreadyProcessed \n                  ? \"Your subscription is already active!\" \n                  : \"Your subscription has been activated!\",\n              });\n            } else {\n              toast({\n                title: \"Processing Subscription\",\n                description: \"Your subscription is being activated...\",\n              });\n            }\n          } catch (error) {\n            console.error('[Billing] Error processing session:', error);\n            toast({\n              title: \"Payment Received\",\n              description: \"Your subscription is being processed. Please refresh in a moment.\",\n              variant: \"default\",\n            });\n          }\n        }\n      };\n      \n      processAndCleanup();\n      \n      // Also poll for updates (in case webhook fires) and capture cleanup function\n      const cleanupPolling = pollForUpdates(['/api/billing/subscription', '/api/credits/balance', '/api/credits/ledger', '/api/billing/aggregate-credits', `/api/organizations/${user.organizationId}`]);\n      \n      // Clean up URL after polling completes (12 seconds = 2s initial + 10s polling)\n      const urlCleanupTimer = setTimeout(() => {\n        setLocation('/billing', { replace: true });\n      }, 12000);\n      \n      // Return cleanup function for useEffect\n      return () => {\n        cleanupPolling();\n        clearTimeout(urlCleanupTimer);\n      };\n    } else if (params.get('canceled') === 'true') {\n      toast({\n        title: \"Subscription Canceled\",\n        description: \"You can subscribe anytime from this page.\",\n        variant: \"destructive\",\n      });\n      \n      // Clean up URL\n      setLocation('/billing', { replace: true });\n    }\n  }, [user, toast, setLocation]);\n\n  // Fetch subscription plans\n  const { data: plansData = [], isLoading: plansLoading, error: plansError } = useQuery<Plan[]>({\n    queryKey: [\"/api/billing/plans\"],\n    enabled: !!user,\n  });\n\n  // Debug: Log plans data\n  useEffect(() => {\n    if (plansData && plansData.length > 0) {\n      console.log('[Billing] Plans fetched:', plansData);\n    } else if (plansData && plansData.length === 0) {\n      console.warn('[Billing] No plans returned from API');\n    }\n    if (plansError) {\n      console.error('[Billing] Error fetching plans:', plansError);\n    }\n  }, [plansData, plansError]);\n\n  // Map plans to match frontend interface (transform isActive to active, includedCredits to includedCreditsPerMonth)\n  const plans = (plansData || []).map((plan: any) => ({\n    ...plan,\n    active: plan.isActive !== undefined ? plan.isActive : (plan.active ?? true),\n    isActive: plan.isActive !== undefined ? plan.isActive : (plan.active ?? true),\n    includedCreditsPerMonth: plan.includedCredits || plan.includedCreditsPerMonth || 0,\n  })).filter((plan: any) => (plan.isActive ?? plan.active ?? true)); // Only show active plans\n\n  // Fetch current subscription\n  const { data: subscription, isLoading: subscriptionLoading, error: subscriptionError } = useQuery<Subscription | null>({\n    queryKey: [\"/api/billing/subscription\"],\n    enabled: !!user,\n  });\n\n  // Debug: Log subscription data changes\n  useEffect(() => {\n    if (subscription) {\n      console.log('[Billing] Subscription data loaded:', subscription);\n    } else if (subscription === null) {\n      console.log('[Billing] No subscription found (null)');\n    }\n    if (subscriptionError) {\n      console.error('[Billing] Subscription query error:', subscriptionError);\n    }\n    if (subscriptionLoading) {\n      console.log('[Billing] Subscription query loading...');\n    }\n  }, [subscription, subscriptionLoading, subscriptionError]);\n\n  // Fetch credit balance\n  const { data: balance } = useQuery<CreditBalance>({\n    queryKey: [\"/api/credits/balance\"],\n    enabled: !!user,\n  });\n\n  // Fetch aggregate credits (detects duplicate accounts)\n  const { data: aggregateCredits } = useQuery<{\n    primaryOrganizationCredits: number;\n    duplicateOrganizations: Array<{ organizationId: string; organizationName: string; userRole: string; credits: number }>;\n    allOrganizations: Array<{ organizationId: string; organizationName: string; userRole: string; credits: number }>;\n    totalCredits: number;\n    totalConsumed: number;\n    totalExpired: number;\n    hasDuplicates: boolean;\n  }>({\n    queryKey: [\"/api/billing/aggregate-credits\"],\n    enabled: !!user,\n  });\n\n  // Fetch credit ledger\n  const { data: ledger = [] } = useQuery<LedgerEntry[]>({\n    queryKey: [\"/api/credits/ledger\"],\n    enabled: !!user,\n  });\n\n  // Create checkout session\n  const checkoutMutation = useMutation({\n    mutationFn: async (planCode: string) => {\n      console.log(`[Billing] SUBSCRIPTION CHECKOUT initiated for plan: ${planCode}, billing period: ${billingPeriod}`);\n      console.log(`[Billing] Calling POST /api/billing/checkout`);\n      const response = await apiRequest(\"POST\", \"/api/billing/checkout\", { \n        planCode,\n        billingPeriod // Send billing period (monthly or annual)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ message: \"Unknown error\" }));\n        throw new Error(errorData.error || errorData.message || \"Failed to create checkout session\");\n      }\n      \n      const data = await response.json() as { url: string };\n      console.log(`[Billing] SUBSCRIPTION checkout URL received:`, data.url);\n      \n      if (!data.url) {\n        throw new Error(\"No checkout URL returned from server\");\n      }\n      \n      return data;\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        console.log(`[Billing] Redirecting to SUBSCRIPTION checkout...`);\n        window.location.href = data.url;\n      } else {\n        toast({\n          title: \"Error\",\n          description: \"No checkout URL received\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error: any) => {\n      console.error(`[Billing] SUBSCRIPTION checkout error:`, error);\n      const errorMessage = error.message || error.error || \"Failed to start checkout\";\n      toast({\n        title: \"Failed to create checkout session\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create portal session\n  const portalMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/billing/portal\");\n      return response.json() as Promise<{ url: string }>;\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to open portal\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Top-up checkout mutation\n  const topupMutation = useMutation({\n    mutationFn: async (packSize: number) => {\n      console.log(`[Billing] TOP-UP CHECKOUT initiated for pack size: ${packSize}`);\n      console.log(`[Billing] Calling POST /api/credits/topup/checkout`);\n      const response = await apiRequest(\"POST\", \"/api/credits/topup/checkout\", { packSize });\n      const data = await response.json() as { url: string };\n      console.log(`[Billing] TOP-UP checkout URL received:`, data.url);\n      return data;\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        console.log(`[Billing] Redirecting to TOP-UP checkout...`);\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: any) => {\n      console.error(`[Billing] TOP-UP checkout error:`, error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to start top-up checkout\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const formatCurrency = (amount: number, currency: string = \"GBP\") => {\n    const symbol = currency === \"GBP\" ? \"\" : currency === \"USD\" ? \"$\" : currency === \"AED\" ? \".\" : currency;\n    return `${symbol}${(amount / 100).toFixed(2)}`;\n  };\n\n  const getStatusBadgeVariant = (status: string) => {\n    switch (status) {\n      case \"active\":\n        return \"default\";\n      case \"trialing\":\n        return \"secondary\";\n      case \"past_due\":\n      case \"incomplete\":\n        return \"destructive\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  return (\n    <div className=\"p-8 max-w-7xl mx-auto space-y-8\">\n      <div>\n        <h1 className=\"text-3xl font-bold mb-2\" data-testid=\"text-page-title\">Billing & Credits</h1>\n        <p className=\"text-muted-foreground\">\n          Manage your subscription, credits, and billing details\n        </p>\n      </div>\n\n      {/* Duplicate Account Warning */}\n      {aggregateCredits?.hasDuplicates && (\n        <Card className=\"border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-950\" data-testid=\"card-duplicate-account-warning\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2 text-yellow-800 dark:text-yellow-200\">\n              <AlertCircle className=\"h-5 w-5\" />\n              Multiple Accounts Detected\n            </CardTitle>\n            <CardDescription className=\"text-yellow-700 dark:text-yellow-300\">\n              You have {aggregateCredits.allOrganizations.length} accounts with the same email address\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"text-sm text-yellow-800 dark:text-yellow-200\">\n              <p className=\"mb-3\">Your total credits across all accounts: <span className=\"font-bold text-lg\">{aggregateCredits.totalCredits}</span></p>\n              <div className=\"space-y-2\">\n                {aggregateCredits.allOrganizations.map((org) => (\n                  <div key={org.organizationId} className=\"flex items-center justify-between p-2 bg-white dark:bg-gray-900 rounded\" data-testid={`org-balance-${org.organizationId}`}>\n                    <div>\n                      <span className=\"font-medium\">{org.organizationName}</span>\n                      {org.organizationId === user?.organizationId && (\n                        <Badge variant=\"outline\" className=\"ml-2\">Current</Badge>\n                      )}\n                    </div>\n                    <span className=\"font-semibold\">{org.credits} credits</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n            <p className=\"text-xs text-yellow-700 dark:text-yellow-300\">\n              This happened because email addresses were previously case-sensitive. Please contact support to merge your accounts if needed.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Current Subscription & Credits Overview */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* Subscription Card */}\n        <Card data-testid=\"card-current-subscription\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5\" />\n              Current Subscription\n            </CardTitle>\n            <CardDescription>Your active billing plan</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {subscription ? (\n              <>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"text-plan-name\">\n                      {subscription.planSnapshotJson.planName}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatCurrency(subscription.planSnapshotJson.monthlyPrice, subscription.planSnapshotJson.currency)}/month\n                    </p>\n                  </div>\n                  <Badge variant={getStatusBadgeVariant(subscription.status)} data-testid=\"badge-subscription-status\">\n                    {subscription.status}\n                  </Badge>\n                </div>\n\n                <Separator />\n\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Included Credits</span>\n                    <span className=\"font-medium\">{subscription.planSnapshotJson.includedCredits}/month</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Current Period</span>\n                    <span className=\"font-medium\">\n                      {format(new Date(subscription.currentPeriodStart), \"MMM d\")} - {format(new Date(subscription.currentPeriodEnd), \"MMM d, yyyy\")}\n                    </span>\n                  </div>\n                  {subscription.cancelAtPeriodEnd && (\n                    <div className=\"flex items-center gap-2 p-2 bg-destructive/10 rounded-md\">\n                      <AlertCircle className=\"h-4 w-4 text-destructive\" />\n                      <span className=\"text-sm text-destructive\">Cancels on {format(new Date(subscription.currentPeriodEnd), \"MMM d, yyyy\")}</span>\n                    </div>\n                  )}\n                </div>\n\n                <Button\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  onClick={() => portalMutation.mutate()}\n                  disabled={portalMutation.isPending}\n                  data-testid=\"button-manage-subscription\"\n                >\n                  Manage Subscription <ExternalLink className=\"ml-2 h-4 w-4\" />\n                </Button>\n              </>\n            ) : (\n              <div className=\"space-y-4\">\n                <p className=\"text-sm text-muted-foreground\">No active subscription</p>\n                <Button className=\"w-full\" onClick={() => window.location.href = \"#plans\"} data-testid=\"button-choose-plan\">\n                  Choose a Plan\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Credit Balance Card */}\n        <Card data-testid=\"card-credit-balance\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Zap className=\"h-5 w-5\" />\n              Credit Balance\n            </CardTitle>\n            <CardDescription>\n              {aggregateCredits?.hasDuplicates \n                ? \"Total credits across all your accounts\" \n                : \"Available inspection credits\"}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-4xl font-bold text-primary\" data-testid=\"text-available-credits\">\n                {aggregateCredits?.hasDuplicates \n                  ? aggregateCredits.totalCredits \n                  : (organization?.creditsRemaining ?? 0)}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                {aggregateCredits?.hasDuplicates ? \"Total credits available\" : \"Credits available\"}\n              </p>\n            </div>\n\n            <Separator />\n\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <p className=\"text-muted-foreground\">Consumed</p>\n                <p className=\"text-lg font-semibold\" data-testid=\"text-consumed-credits\">\n                  {aggregateCredits?.hasDuplicates \n                    ? aggregateCredits.totalConsumed \n                    : (balance?.consumed || 0)}\n                </p>\n              </div>\n              <div>\n                <p className=\"text-muted-foreground\">Expired</p>\n                <p className=\"text-lg font-semibold\" data-testid=\"text-expired-credits\">\n                  {aggregateCredits?.hasDuplicates \n                    ? aggregateCredits.totalExpired \n                    : (balance?.expired || 0)}\n                </p>\n              </div>\n            </div>\n\n            <Dialog open={topupDialogOpen} onOpenChange={setTopupDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"default\" className=\"w-full\" data-testid=\"button-top-up-credits\">\n                  <Package className=\"mr-2 h-4 w-4\" />\n                  Top-Up Credits\n                </Button>\n              </DialogTrigger>\n              <DialogContent data-testid=\"dialog-topup\">\n                <DialogHeader>\n                  <DialogTitle>Add-On AI Inspection Bundles</DialogTitle>\n                  <DialogDescription>\n                    Purchase additional credits when your subscription allowance is depleted\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"grid gap-4 py-4\">\n                  {[\n                    { size: 100, price: 40000, perCredit: 400, popular: false },\n                    { size: 250, price: 75000, perCredit: 300, popular: false },\n                    { size: 500, price: 100000, perCredit: 200, popular: true },\n                    { size: 1000, price: 150000, perCredit: 150, popular: false },\n                  ].map((pack) => (\n                    <Card\n                      key={pack.size}\n                      className={`cursor-pointer hover-elevate active-elevate-2 ${\n                        selectedTopup === pack.size ? \"border-primary\" : \"\"\n                      }`}\n                      onClick={() => setSelectedTopup(pack.size)}\n                      data-testid={`card-topup-${pack.size}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <div>\n                            <p className=\"font-semibold text-lg\">{pack.size} AI Credits</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {formatCurrency(pack.price)}  {formatCurrency(pack.perCredit)} per credit\n                            </p>\n                          </div>\n                          {pack.popular && (\n                            <Badge variant=\"default\">Best Value</Badge>\n                          )}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n                <Button\n                  onClick={() => selectedTopup && topupMutation.mutate(selectedTopup)}\n                  disabled={!selectedTopup || topupMutation.isPending}\n                  data-testid=\"button-confirm-topup\"\n                >\n                  Purchase {selectedTopup} Credits\n                </Button>\n              </DialogContent>\n            </Dialog>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Subscription Management & Cancellation */}\n      {subscription && (\n        <Card data-testid=\"card-subscription-management\">\n          <CardHeader>\n            <CardTitle>Subscription Management</CardTitle>\n            <CardDescription>Manage your plan, billing, and cancellation</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div>\n                <h3 className=\"font-semibold mb-2\">Current Plan</h3>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  You're currently on the <strong>{subscription.planSnapshotJson.planName}</strong> plan\n                </p>\n                <p className=\"text-sm text-muted-foreground\">\n                  {formatCurrency(subscription.planSnapshotJson.monthlyPrice, subscription.planSnapshotJson.currency)}/month  {subscription.planSnapshotJson.includedCredits} credits per month\n                </p>\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-2\">Billing Cycle</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Your next billing date is <strong>{format(new Date(subscription.currentPeriodEnd), \"MMMM d, yyyy\")}</strong>\n                </p>\n                {subscription.cancelAtPeriodEnd && (\n                  <p className=\"text-sm text-destructive mt-2\">\n                    Your subscription will cancel on this date.\n                  </p>\n                )}\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className=\"flex flex-col sm:flex-row gap-3\">\n              <Button\n                variant=\"outline\"\n                className=\"flex-1\"\n                onClick={() => portalMutation.mutate()}\n                disabled={portalMutation.isPending}\n                data-testid=\"button-change-plan\"\n              >\n                <CreditCard className=\"mr-2 h-4 w-4\" />\n                Change Plan or Payment Method\n              </Button>\n              <Button\n                variant={subscription.cancelAtPeriodEnd ? \"default\" : \"destructive\"}\n                className=\"flex-1\"\n                onClick={() => portalMutation.mutate()}\n                disabled={portalMutation.isPending}\n                data-testid=\"button-cancel-subscription\"\n              >\n                <AlertCircle className=\"mr-2 h-4 w-4\" />\n                {subscription.cancelAtPeriodEnd ? \"Reactivate Subscription\" : \"Cancel Subscription\"}\n              </Button>\n            </div>\n\n            {!subscription.cancelAtPeriodEnd && (\n              <div className=\"bg-muted p-3 rounded-md\">\n                <p className=\"text-xs text-muted-foreground\">\n                  <strong>Note:</strong> Canceling your subscription will keep it active until the end of your current billing period. \n                  You'll continue to have access to all features and your remaining credits until {format(new Date(subscription.currentPeriodEnd), \"MMMM d, yyyy\")}.\n                </p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Available Plans */}\n      <div id=\"plans\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold\">Available Plans</h2>\n          \n          <div className=\"flex items-center gap-6\">\n            {/* Billing Period Toggle */}\n            <div className=\"flex items-center gap-3\">\n              <Label htmlFor=\"billing-period\" className={billingPeriod === \"monthly\" ? \"font-semibold\" : \"text-muted-foreground\"}>\n                Monthly\n              </Label>\n              <Switch\n                id=\"billing-period\"\n                checked={billingPeriod === \"annual\"}\n                onCheckedChange={(checked) => setBillingPeriod(checked ? \"annual\" : \"monthly\")}\n                data-testid=\"switch-billing-period\"\n              />\n              <Label htmlFor=\"billing-period\" className={billingPeriod === \"annual\" ? \"font-semibold\" : \"text-muted-foreground\"}>\n                Annual <Badge variant=\"secondary\" className=\"ml-1\">Save up to 10%</Badge>\n              </Label>\n            </div>\n          </div>\n        </div>\n        \n        {plansLoading ? (\n          <div className=\"text-center py-8\">\n            <p className=\"text-muted-foreground\">Loading plans...</p>\n          </div>\n        ) : plans && plans.length > 0 ? (\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-4\">\n            {plans\n            .sort((a, b) => {\n              const order = ['starter', 'professional', 'enterprise', 'enterprise_plus'];\n              return order.indexOf(a.code) - order.indexOf(b.code);\n            })\n            .map((plan) => {\n            const planDescriptions: Record<string, { idealFor: string; features: string[] }> = {\n              starter: {\n                idealFor: \"Ideal for Small Property Managers or Local Agents\",\n                features: [\n                  \"50 Inspection Credits per month\",\n                  \"AI-powered inspections\",\n                  \"Basic support\"\n                ]\n              },\n              professional: {\n                idealFor: \"Ideal for Medium Sized Agency / Facilities Manager\",\n                features: [\n                  \"200 Inspection Credits per month\",\n                  \"AI-powered inspections\",\n                  \"Priority support\"\n                ]\n              },\n              enterprise: {\n                idealFor: \"Ideal for BTR, Housing Association, or Student Accommodation Provider\",\n                features: [\n                  \"500 Inspection Credits per month\",\n                  \"AI-powered inspections\",\n                  \"Dedicated account manager\"\n                ]\n              },\n              enterprise_plus: {\n                idealFor: \"Ideal for National or Multi-Site Operator\",\n                features: [\n                  \"2000+ Inspection Credits per month\",\n                  \"AI-powered inspections\",\n                  \"White-label options\",\n                  \"Custom integrations\"\n                ]\n              }\n            };\n\n            const description = planDescriptions[plan.code] || {\n              idealFor: \"Custom plan for your organization\",\n              features: [`${plan.includedCreditsPerMonth} credits/month`, \"AI-powered inspections\"]\n            };\n\n            return (\n              <Card key={plan.id} data-testid={`card-plan-${plan.code}`} className={subscription?.planSnapshotJson.planName === plan.name ? \"border-primary\" : \"\"}>\n                <CardHeader>\n                  <CardTitle>{plan.name}</CardTitle>\n                  {plan.code === \"enterprise_plus\" ? (\n                    <CardDescription>\n                      <span className=\"text-2xl font-bold\">Custom Pricing</span>\n                    </CardDescription>\n                  ) : (\n                    <CardDescription>\n                      {billingPeriod === \"annual\" && plan.annualPriceGbp ? (\n                        <>\n                          <span className=\"text-3xl font-bold\">{formatPrice(plan.annualPriceGbp, effectiveCurrency)}</span>\n                          <span className=\"text-base text-muted-foreground\">/year</span>\n                          <div className=\"text-sm text-muted-foreground mt-1\">\n                            ({formatPrice(Math.floor(plan.annualPriceGbp / 12), effectiveCurrency)}/month billed annually)\n                          </div>\n                        </>\n                      ) : billingPeriod === \"annual\" && !plan.annualPriceGbp ? (\n                        <div className=\"space-y-1\">\n                          <span className=\"text-3xl font-bold\">{formatPrice(plan.monthlyPriceGbp, effectiveCurrency)}</span>\n                          <span className=\"text-base text-muted-foreground\">/month</span>\n                          <div className=\"text-xs text-muted-foreground mt-1\">\n                            Annual billing not available for this plan\n                          </div>\n                        </div>\n                      ) : (\n                        <>\n                          <span className=\"text-3xl font-bold\">{formatPrice(plan.monthlyPriceGbp, effectiveCurrency)}</span>\n                          <span className=\"text-base text-muted-foreground\">/month</span>\n                        </>\n                      )}\n                    </CardDescription>\n                  )}\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <p className=\"text-sm text-muted-foreground italic\">{description.idealFor}</p>\n                  <Separator />\n                  <div className=\"space-y-2\">\n                    {description.features.map((feature, idx) => (\n                      <div key={idx} className=\"flex items-center gap-2\">\n                        <CheckCircle2 className=\"h-4 w-4 text-primary flex-shrink-0\" />\n                        <span className=\"text-sm\">{feature}</span>\n                      </div>\n                    ))}\n                  </div>\n\n                  <Button\n                    className=\"w-full\"\n                    variant={subscription?.planSnapshotJson.planName === plan.name ? \"outline\" : \"default\"}\n                    onClick={() => {\n                      if (plan.code === \"enterprise_plus\") {\n                        console.log(`[Billing] Contact Sales clicked for Enterprise+`);\n                        window.location.href = \"mailto:sales@inspect360.com?subject=Enterprise+ Inquiry\";\n                      } else {\n                        console.log(`[Billing] SELECT PLAN CLICKED for plan: ${plan.code} (${plan.name})`);\n                        console.log(`[Billing] Billing period: ${billingPeriod}`);\n                        console.log(`[Billing] This should trigger SUBSCRIPTION checkout, NOT top-up`);\n                        checkoutMutation.mutate(plan.code);\n                      }\n                    }}\n                    disabled={checkoutMutation.isPending || topupMutation.isPending || subscription?.planSnapshotJson.planName === plan.name}\n                    data-testid={`button-select-plan-${plan.code}`}\n                  >\n                    {subscription?.planSnapshotJson.planName === plan.name \n                      ? \"Current Plan\" \n                      : plan.code === \"enterprise_plus\" \n                        ? \"Contact Sales\" \n                        : \"Select Plan\"}\n                  </Button>\n                </CardContent>\n              </Card>\n            );\n          })}\n          </div>\n        ) : (\n          <div className=\"text-center py-8\">\n            <p className=\"text-muted-foreground\">\n              {plansError ? `Error loading plans: ${(plansError as any)?.message || 'Unknown error'}` : 'No plans available. Please contact support.'}\n            </p>\n          </div>\n        )}\n      </div>\n\n      {/* FAQ Section */}\n      <Card data-testid=\"card-credits-faq\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <AlertCircle className=\"h-5 w-5\" />\n            How Inspection Credits Work\n          </CardTitle>\n          <CardDescription>Frequently asked questions about credits</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Accordion type=\"single\" collapsible className=\"w-full\">\n            <AccordionItem value=\"what-are-credits\" data-testid=\"faq-what-are-credits\">\n              <AccordionTrigger className=\"text-left\">What are Inspection Credits?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground\">\n                  Inspection Credits are used to perform AI-powered property inspections in Inspect360. Each time you complete an inspection, \n                  1 AI credit is automatically deducted from your account.\n                </p>\n              </AccordionContent>\n            </AccordionItem>\n\n            <AccordionItem value=\"credit-cost\" data-testid=\"faq-credit-cost\">\n              <AccordionTrigger className=\"text-left\">How many credits does each inspection cost?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground\">\n                  <strong>Every inspection costs 1 AI credit</strong>, regardless of the inspection type (Check-In, Check-Out, Routine, or Maintenance).\n                </p>\n              </AccordionContent>\n            </AccordionItem>\n\n            <AccordionItem value=\"unused-credits\" data-testid=\"faq-unused-credits\">\n              <AccordionTrigger className=\"text-left\">What happens to unused credits?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground\">\n                  Unused credits automatically roll over to the next month, giving you an additional month to use them. \n                  After that, any remaining credits from that batch will expire. This ensures you always have flexibility \n                  while keeping your account current.\n                </p>\n              </AccordionContent>\n            </AccordionItem>\n\n            <AccordionItem value=\"purchase-credits\" data-testid=\"faq-purchase-credits\">\n              <AccordionTrigger className=\"text-left\">Can I purchase additional credits?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground mb-3\">\n                  Yes! When your subscription allowance is depleted, you can purchase add-on AI inspection bundles:\n                </p>\n                <div className=\"text-sm text-muted-foreground space-y-1\">\n                  <p> <strong>100 credits:</strong> 400 (4.00 per credit)</p>\n                  <p> <strong>250 credits:</strong> 750 (3.00 per credit)</p>\n                  <p> <strong>500 credits:</strong> 1,000 (2.00 per credit) - Best Value</p>\n                  <p> <strong>1000 credits:</strong> 1,500 (1.50 per credit)</p>\n                  <p className=\"pt-3 text-xs italic\">\n                    Top-up credits never expire and are consumed using FIFO (first-in, first-out) logic after your monthly credits.\n                  </p>\n                </div>\n              </AccordionContent>\n            </AccordionItem>\n\n            <AccordionItem value=\"run-out\" data-testid=\"faq-run-out\">\n              <AccordionTrigger className=\"text-left\">What happens if I run out of credits?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground\">\n                  If you run out of credits, you won't be able to complete new inspections until you purchase a top-up pack \n                  or wait for your next monthly credit allocation. You can monitor your credit balance on this page at any time.\n                </p>\n              </AccordionContent>\n            </AccordionItem>\n\n            <AccordionItem value=\"upgrade-plan\" data-testid=\"faq-upgrade-plan\">\n              <AccordionTrigger className=\"text-left\">Can I upgrade or downgrade my plan?</AccordionTrigger>\n              <AccordionContent>\n                <p className=\"text-sm text-muted-foreground\">\n                  Yes! You can upgrade or downgrade your plan at any time through the Stripe customer portal. Changes will be \n                  prorated, and your credit allocation will adjust with your next billing cycle.\n                </p>\n              </AccordionContent>\n            </AccordionItem>\n          </Accordion>\n        </CardContent>\n      </Card>\n\n      {/* Credit History */}\n      <Card data-testid=\"card-credit-ledger\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <TrendingUp className=\"h-5 w-5\" />\n            Credit History\n          </CardTitle>\n          <CardDescription>Recent credit transactions</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {ledger.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">No credit transactions yet</p>\n            ) : (\n              ledger.slice(0, 10).map((entry) => {\n                const purchaserName = entry.createdByUser \n                  ? `${entry.createdByUser.firstName || ''} ${entry.createdByUser.lastName || ''}`.trim() || entry.createdByUser.email\n                  : null;\n                \n                return (\n                  <div key={entry.id} className=\"flex items-center justify-between py-2 border-b last:border-0\" data-testid={`ledger-entry-${entry.id}`}>\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-medium\">{entry.notes || entry.description || `${entry.source} credits`}</p>\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                        <span>{format(new Date(entry.createdAt), \"MMM d, yyyy 'at' h:mm a\")}</span>\n                        {purchaserName && (\n                          <>\n                            <span></span>\n                            <span className=\"font-medium\">{purchaserName}</span>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant={entry.quantity < 0 ? \"destructive\" : \"default\"}>\n                        {entry.quantity < 0 ? \"\" : \"+\"}{entry.quantity}\n                      </Badge>\n                    </div>\n                  </div>\n                );\n              })\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":46356},"client/src/pages/Profile.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { User as UserIcon, Loader2 } from \"lucide-react\";\nimport { updateSelfProfileSchema, type User } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { PhoneInput } from \"@/components/PhoneInput\";\n\ntype ProfileFormValues = z.infer<typeof updateSelfProfileSchema>;\n\nexport default function Profile() {\n  const { toast } = useToast();\n\n  // Fetch current user profile\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/profile\"],\n  });\n\n  // Update profile mutation\n  const updateMutation = useMutation({\n    mutationFn: async (data: ProfileFormValues) => {\n      return await apiRequest(\"PATCH\", \"/api/auth/profile\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/profile\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Success\",\n        description: \"Profile updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update profile\",\n      });\n    },\n  });\n\n  const form = useForm<ProfileFormValues>({\n    resolver: zodResolver(updateSelfProfileSchema),\n    defaultValues: {\n      firstName: user?.firstName || \"\",\n      lastName: user?.lastName || \"\",\n      phone: user?.phone || \"\",\n      profileImageUrl: user?.profileImageUrl || \"\",\n    },\n    values: {\n      firstName: user?.firstName || \"\",\n      lastName: user?.lastName || \"\",\n      phone: user?.phone || \"\",\n      profileImageUrl: user?.profileImageUrl || \"\",\n    },\n  });\n\n  const onSubmit = (data: ProfileFormValues) => {\n    updateMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold flex items-center gap-2\" data-testid=\"text-page-title\">\n          <UserIcon className=\"w-8 h-8\" />\n          Profile\n        </h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Manage your personal information and settings\n        </p>\n      </div>\n\n      <Card data-testid=\"card-profile-form\">\n        <CardHeader>\n          <CardTitle>Personal Information</CardTitle>\n          <CardDescription>\n            Update your profile details below\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"firstName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>First Name</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your first name\"\n                          data-testid=\"input-firstName\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"lastName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Last Name</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your last name\"\n                          data-testid=\"input-lastName\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"phone\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Phone Number</FormLabel>\n                    <FormControl>\n                      <PhoneInput\n                        field={field}\n                        placeholder=\"Enter your phone number\"\n                        data-testid=\"input-phone\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"profileImageUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Profile Image URL</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"Enter profile image URL\"\n                        data-testid=\"input-profileImageUrl\"\n                        {...field}\n                        value={field.value || \"\"}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"pt-4\">\n                <Button\n                  type=\"submit\"\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-save-profile\"\n                >\n                  {updateMutation.isPending && (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  )}\n                  Save Changes\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\" data-testid=\"card-account-info\">\n        <CardHeader>\n          <CardTitle>Account Information</CardTitle>\n          <CardDescription>\n            These details cannot be changed from this page\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <div>\n            <Label className=\"text-sm font-medium text-muted-foreground\">Email</Label>\n            <p className=\"text-base\" data-testid=\"text-email\">{user?.email}</p>\n          </div>\n          <div>\n            <Label className=\"text-sm font-medium text-muted-foreground\">Username</Label>\n            <p className=\"text-base\" data-testid=\"text-username\">{user?.username}</p>\n          </div>\n          <div>\n            <Label className=\"text-sm font-medium text-muted-foreground\">Role</Label>\n            <p className=\"text-base capitalize\" data-testid=\"text-role\">{user?.role}</p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":7392},"client/src/components/UserProfileMenu.tsx":{"content":"import { Link } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { User, CreditCard, LogOut } from \"lucide-react\";\n\nexport function UserProfileMenu() {\n  const { user, logoutMutation } = useAuth();\n\n  if (!user) return null;\n\n  const getInitials = () => {\n    if (user.firstName && user.lastName) {\n      return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();\n    }\n    if (user.firstName) {\n      return user.firstName.substring(0, 2).toUpperCase();\n    }\n    if (user.username) {\n      return user.username.substring(0, 2).toUpperCase();\n    }\n    return \"U\";\n  };\n\n  const getDisplayName = () => {\n    if (user.firstName && user.lastName) {\n      return `${user.firstName} ${user.lastName}`;\n    }\n    if (user.firstName) {\n      return user.firstName;\n    }\n    return user.username;\n  };\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          className=\"relative h-9 w-9 rounded-full\"\n          data-testid=\"button-profile-menu\"\n        >\n          <Avatar className=\"h-9 w-9\">\n            <AvatarImage src={user.profileImageUrl || undefined} alt={getDisplayName()} />\n            <AvatarFallback>{getInitials()}</AvatarFallback>\n          </Avatar>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel className=\"font-normal\">\n          <div className=\"flex flex-col space-y-1\">\n            <p className=\"text-sm font-medium leading-none\" data-testid=\"text-user-name\">\n              {getDisplayName()}\n            </p>\n            <p className=\"text-xs leading-none text-muted-foreground\" data-testid=\"text-user-email\">\n              {user.email}\n            </p>\n          </div>\n        </DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem asChild>\n          <Link href=\"/profile\" className=\"cursor-pointer\" data-testid=\"link-profile\">\n            <User className=\"mr-2 h-4 w-4\" />\n            <span>Profile</span>\n          </Link>\n        </DropdownMenuItem>\n        <DropdownMenuItem asChild>\n          <Link href=\"/billing\" className=\"cursor-pointer\" data-testid=\"link-billing\">\n            <CreditCard className=\"mr-2 h-4 w-4\" />\n            <span>Billing</span>\n          </Link>\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem\n          onClick={() => logoutMutation.mutate()}\n          disabled={logoutMutation.isPending}\n          className=\"cursor-pointer\"\n          data-testid=\"button-logout-menu\"\n        >\n          <LogOut className=\"mr-2 h-4 w-4\" />\n          <span>Logout</span>\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","size_bytes":3027},"server/pdfService.ts":{"content":"import puppeteer from \"puppeteer\";\nimport chromium from \"@sparticuz/chromium\";\n\n// Detect if running in a serverless environment (AWS Lambda, etc.)\nconst isServerless = process.env.AWS_LAMBDA_FUNCTION_NAME || process.env.VERCEL || process.env.NETLIFY;\nimport { format } from \"date-fns\";\n\n// HTML escape utility to prevent XSS\nfunction escapeHtml(unsafe: string): string {\n  if (typeof unsafe !== 'string') return String(unsafe || '');\n  \n  return unsafe\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n}\n\n// Sanitize URL for use in HTML attributes (whitelist-based approach)\nfunction sanitizeUrl(url: string, baseUrl?: string): string {\n  if (typeof url !== 'string' || !url.trim()) return '';\n  \n  const trimmed = url.trim();\n  const lower = trimmed.toLowerCase();\n  \n  // Handle relative URLs (convert to absolute using baseUrl)\n  if (trimmed.startsWith('/') && baseUrl) {\n    const absoluteUrl = `${baseUrl}${trimmed}`;\n    return escapeHtml(absoluteUrl);\n  }\n  \n  // Allow only safe protocols via whitelist\n  const safeProtocols = ['https://', 'http://'];\n  const isSafeProtocol = safeProtocols.some(protocol => lower.startsWith(protocol));\n  \n  if (!isSafeProtocol) {\n    // For data URLs, only allow safe image types (NO SVG - can contain XSS)\n    const safeDataImages = [\n      'data:image/png',\n      'data:image/jpeg',\n      'data:image/jpg',\n      'data:image/gif',\n      'data:image/webp',\n    ];\n    \n    const isSafeDataUrl = safeDataImages.some(prefix => lower.startsWith(prefix));\n    \n    if (!isSafeDataUrl) {\n      // Reject all other protocols/schemes (javascript:, data:image/svg+xml, vbscript:, etc.)\n      console.warn(`Blocked potentially unsafe URL: ${url.substring(0, 50)}...`);\n      return '';\n    }\n  }\n  \n  // Return escaped URL (escape special chars for HTML attribute safety)\n  return escapeHtml(trimmed);\n}\n\n// Format text while preserving line breaks but escaping dangerous HTML\nfunction formatText(text: string): string {\n  if (!text) return '';\n  \n  // First escape HTML to prevent XSS\n  const escaped = escapeHtml(text);\n  \n  // Convert line breaks to <br> tags for proper display\n  const withBreaks = escaped.replace(/\\n/g, '<br>');\n  \n  return withBreaks;\n}\n\ninterface TemplateField {\n  id: string;\n  key?: string;\n  label: string;\n  type: string;\n  description?: string;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[];\n  validation?: Record<string, any>;\n  dependsOn?: Record<string, any>;\n  includeCondition?: boolean;\n  includeCleanliness?: boolean;\n}\n\ninterface TemplateSection {\n  id: string;\n  title: string;\n  description?: string;\n  repeatable?: boolean;\n  fields: TemplateField[];\n}\n\ninterface Inspection {\n  id: string;\n  organizationId: string;\n  templateId?: string;\n  templateSnapshotJson?: { sections: TemplateSection[] };\n  propertyId?: string;\n  blockId?: string;\n  inspectorId: string;\n  type: string;\n  status: string;\n  scheduledDate?: string;\n  startedAt?: string;\n  completedDate?: string;\n  submittedAt?: string;\n  notes?: string;\n  property?: {\n    id: string;\n    name: string;\n    address: string;\n    propertyType?: string;\n  };\n  block?: {\n    id: string;\n    name: string;\n    address: string;\n  };\n  inspector?: {\n    id: string;\n    email: string;\n    firstName?: string;\n    lastName?: string;\n  };\n}\n\ninterface InspectionEntry {\n  id: string;\n  inspectionId: string;\n  sectionRef: string;\n  fieldKey: string;\n  value?: any;\n  note?: string;\n  photos?: string[];\n  condition?: string;\n  cleanliness?: string;\n  markedForReview?: boolean;\n}\n\nexport async function generateInspectionPDF(\n  inspection: Inspection,\n  entries: InspectionEntry[],\n  baseUrl: string\n): Promise<Buffer> {\n  const html = generateInspectionHTML(inspection, entries, baseUrl);\n\n  let browser;\n  try {\n    // Use @sparticuz/chromium for serverless environments, regular Puppeteer for local development\n    if (isServerless) {\n      // Serverless environment - use @sparticuz/chromium\n      browser = await puppeteer.launch({\n        args: chromium.args,\n        executablePath: await chromium.executablePath(),\n        headless: true,\n      });\n    } else {\n      // Local development - use Puppeteer's bundled Chromium\n      browser = await puppeteer.launch({\n        headless: true,\n        args: [\n          '--no-sandbox',\n          '--disable-setuid-sandbox',\n          '--disable-dev-shm-usage',\n          '--disable-accelerated-2d-canvas',\n          '--no-first-run',\n          '--no-zygote',\n          '--disable-gpu'\n        ],\n      });\n    }\n\n    const page = await browser.newPage();\n    await page.setContent(html, {\n      waitUntil: \"networkidle0\",\n    });\n\n    const pdf = await page.pdf({\n      format: \"A4\",\n      printBackground: true,\n      margin: {\n        top: \"20mm\",\n        right: \"15mm\",\n        bottom: \"20mm\",\n        left: \"15mm\",\n      },\n    });\n\n    return Buffer.from(pdf);\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n  }\n}\n\nfunction renderFieldValue(value: any, field: TemplateField): string {\n  if (value === null || value === undefined || value === \"\") {\n    return '<span style=\"color: #999;\">Not provided</span>';\n  }\n\n  try {\n    if (typeof value === \"object\" && value !== null) {\n      if (Array.isArray(value)) {\n        // Escape each array item\n        const escaped = value.map(v => escapeHtml(String(v)));\n        return escaped.length > 0 ? escaped.join(\", \") : '<span style=\"color: #999;\">Empty</span>';\n      }\n      // Escape JSON output\n      return `<pre style=\"background: #f5f5f5; padding: 8px; border-radius: 4px; font-size: 12px; overflow-x: auto;\">${escapeHtml(JSON.stringify(value, null, 2))}</pre>`;\n    }\n\n    if (field.type === \"checkbox\" || field.type === \"toggle\") {\n      return value ? \" Yes\" : \" No\";\n    }\n\n    if (field.type === \"date\" && typeof value === \"string\") {\n      try {\n        const formatted = format(new Date(value), \"PPP\");\n        return escapeHtml(formatted);\n      } catch {\n        return escapeHtml(String(value));\n      }\n    }\n\n    // Escape all string values\n    return escapeHtml(String(value));\n  } catch (error) {\n    console.error(\"Error rendering field value:\", error);\n    return escapeHtml(String(value || \"\"));\n  }\n}\n\nfunction generateInspectionHTML(\n  inspection: Inspection,\n  entries: InspectionEntry[],\n  baseUrl: string\n): string {\n  const templateStructure = inspection.templateSnapshotJson as { sections: TemplateSection[] } | null;\n  const sections = templateStructure?.sections || [];\n\n  const propertyName = inspection.property?.name || \"Unknown Property\";\n  const propertyAddress = inspection.property?.address || \"No address\";\n  const inspectorName = inspection.inspector\n    ? `${inspection.inspector.firstName || \"\"} ${inspection.inspector.lastName || \"\"}`.trim() ||\n      inspection.inspector.email\n    : \"Unknown Inspector\";\n  const inspectionDate = inspection.completedDate || inspection.scheduledDate || inspection.startedAt;\n  const formattedDate = inspectionDate ? format(new Date(inspectionDate), \"PPP\") : \"Not specified\";\n\n  // Build entries map\n  const entriesMap = new Map<string, InspectionEntry>();\n  entries.forEach((entry) => {\n    const key = `${entry.sectionRef}-${entry.fieldKey}`;\n    entriesMap.set(key, entry);\n  });\n\n  // Generate sections HTML\n  let sectionsHTML = \"\";\n  sections.forEach((section) => {\n    let fieldsHTML = \"\";\n    section.fields.forEach((field) => {\n      const key = `${section.id}-${field.key || field.id}`;\n      const entry = entriesMap.get(key);\n\n      const value = entry?.value;\n      const note = entry?.note;\n      const photos = entry?.photos || [];\n      const condition = entry?.condition;\n      const cleanliness = entry?.cleanliness;\n\n      // Helper function to check if a value is truly empty\n      const isEmpty = (val: any): boolean => {\n        if (val === null || val === undefined) return true;\n        if (typeof val === 'string') return val.trim() === '';\n        if (Array.isArray(val)) return val.length === 0;\n        if (typeof val === 'object') return Object.keys(val).length === 0;\n        if (typeof val === 'boolean') return false; // booleans are always valid\n        return false;\n      };\n\n      // Skip fields with no data, photos, notes, or ratings\n      const hasValue = !isEmpty(value);\n      const hasPhotos = photos.length > 0;\n      const hasNote = !isEmpty(note);\n      const hasCondition = !isEmpty(condition);\n      const hasCleanliness = !isEmpty(cleanliness);\n      \n      if (!hasValue && !hasPhotos && !hasNote && !hasCondition && !hasCleanliness) {\n        return; // Skip this field\n      }\n\n      fieldsHTML += `\n        <div style=\"margin-bottom: 24px; page-break-inside: avoid;\">\n          <div style=\"font-weight: 600; color: #1a1a1a; margin-bottom: 8px;\">\n            ${escapeHtml(field.label)}\n            ${field.required ? '<span style=\"color: #ef4444;\">*</span>' : ''}\n          </div>\n          ${field.description ? `<div style=\"color: #666; font-size: 14px; margin-bottom: 8px;\">${escapeHtml(field.description)}</div>` : \"\"}\n          \n          ${value !== undefined && value !== null && value !== \"\" ? `\n            <div style=\"color: #333; margin-bottom: 8px;\">\n              ${renderFieldValue(value, field)}\n            </div>\n          ` : \"\"}\n\n          ${condition ? `\n            <div style=\"margin-top: 8px;\">\n              <span style=\"font-size: 13px; color: #666;\">Condition:</span>\n              <span style=\"display: inline-block; background: #f0fdf4; color: #16a34a; padding: 2px 8px; border-radius: 4px; font-size: 13px; margin-left: 8px;\">\n                ${escapeHtml(condition)}\n              </span>\n            </div>\n          ` : \"\"}\n\n          ${cleanliness ? `\n            <div style=\"margin-top: 8px;\">\n              <span style=\"font-size: 13px; color: #666;\">Cleanliness:</span>\n              <span style=\"display: inline-block; background: #eff6ff; color: #2563eb; padding: 2px 8px; border-radius: 4px; font-size: 13px; margin-left: 8px;\">\n                ${escapeHtml(cleanliness)}\n              </span>\n            </div>\n          ` : \"\"}\n\n          ${photos.length > 0 ? `\n            <div style=\"margin-top: 12px;\">\n              <div style=\"font-size: 13px; color: #666; margin-bottom: 8px;\">Photos (${photos.length}):</div>\n              <div style=\"display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;\">\n                ${photos.map((photo) => `\n                  <div style=\"border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;\">\n                    <img src=\"${sanitizeUrl(photo, baseUrl)}\" alt=\"Inspection photo\" style=\"width: 100%; height: 150px; object-fit: cover;\" />\n                  </div>\n                `).join(\"\")}\n              </div>\n            </div>\n          ` : \"\"}\n\n          ${note ? `\n            <div style=\"margin-top: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 4px;\">\n              <div style=\"font-weight: 500; color: #92400e; margin-bottom: 4px; font-size: 13px;\">Note:</div>\n              <div style=\"color: #78350f; font-size: 14px; white-space: pre-wrap;\">${formatText(note)}</div>\n            </div>\n          ` : \"\"}\n        </div>\n      `;\n    });\n\n    // Only include section if it has fields with data\n    if (fieldsHTML.trim()) {\n      sectionsHTML += `\n        <div style=\"margin-bottom: 32px; page-break-inside: avoid;\">\n          <h2 style=\"font-size: 20px; font-weight: 700; color: #00D5CC; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #00D5CC;\">\n            ${escapeHtml(section.title)}\n          </h2>\n          ${section.description ? `<p style=\"color: #666; margin-bottom: 16px;\">${escapeHtml(section.description)}</p>` : \"\"}\n          ${fieldsHTML}\n        </div>\n      `;\n    }\n  });\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n    \n    body {\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      background: white;\n    }\n\n    .container {\n      max-width: 100%;\n      padding: 0;\n    }\n\n    .cover-page {\n      height: 100vh;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      align-items: center;\n      text-align: center;\n      background: linear-gradient(135deg, #00D5CC 0%, #3B7A8C 100%);\n      color: white;\n      page-break-after: always;\n    }\n\n    .cover-logo {\n      font-size: 72px;\n      font-weight: 800;\n      margin-bottom: 24px;\n      letter-spacing: -2px;\n    }\n\n    .cover-title {\n      font-size: 48px;\n      font-weight: 700;\n      margin-bottom: 16px;\n    }\n\n    .cover-property {\n      font-size: 32px;\n      font-weight: 400;\n      margin-bottom: 48px;\n      opacity: 0.95;\n    }\n\n    .cover-details {\n      font-size: 18px;\n      opacity: 0.9;\n      margin-top: 24px;\n    }\n\n    .header {\n      background: white;\n      padding: 32px 0;\n      border-bottom: 3px solid #00D5CC;\n      margin-bottom: 32px;\n    }\n\n    .header-title {\n      font-size: 32px;\n      font-weight: 800;\n      color: #00D5CC;\n      margin-bottom: 8px;\n    }\n\n    .header-subtitle {\n      font-size: 24px;\n      color: #3B7A8C;\n      font-weight: 600;\n    }\n\n    .info-grid {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 24px;\n      margin-bottom: 32px;\n      page-break-inside: avoid;\n    }\n\n    .info-item {\n      background: #f9fafb;\n      padding: 16px;\n      border-radius: 8px;\n      border-left: 4px solid #00D5CC;\n    }\n\n    .info-label {\n      font-size: 13px;\n      color: #666;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n      margin-bottom: 4px;\n      font-weight: 600;\n    }\n\n    .info-value {\n      font-size: 16px;\n      color: #1a1a1a;\n      font-weight: 500;\n    }\n\n    .status-badge {\n      display: inline-block;\n      padding: 6px 16px;\n      border-radius: 20px;\n      font-size: 14px;\n      font-weight: 600;\n      background: #dcfce7;\n      color: #166534;\n    }\n\n    @media print {\n      .page-break {\n        page-break-before: always;\n      }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <!-- Cover Page -->\n    <div class=\"cover-page\">\n      <div class=\"cover-logo\">INSPECT360</div>\n      <div class=\"cover-title\">Inspection Report</div>\n      <div class=\"cover-property\">${escapeHtml(propertyName)}</div>\n      <div class=\"cover-details\">\n        <div>${escapeHtml(formattedDate)}</div>\n        <div style=\"margin-top: 8px;\">${escapeHtml(inspection.type.charAt(0).toUpperCase() + inspection.type.slice(1).replace(/_/g, \" \"))}</div>\n      </div>\n    </div>\n\n    <!-- Main Content -->\n    <div style=\"padding: 0;\">\n      <div class=\"header\">\n        <div class=\"header-title\">Inspection Report</div>\n        <div class=\"header-subtitle\">${escapeHtml(propertyName)}</div>\n      </div>\n\n      <!-- Property Information -->\n      <div class=\"info-grid\">\n        <div class=\"info-item\">\n          <div class=\"info-label\">Property Address</div>\n          <div class=\"info-value\">${escapeHtml(propertyAddress)}</div>\n        </div>\n        <div class=\"info-item\">\n          <div class=\"info-label\">Inspection Type</div>\n          <div class=\"info-value\">${escapeHtml(inspection.type.charAt(0).toUpperCase() + inspection.type.slice(1).replace(/_/g, \" \"))}</div>\n        </div>\n        <div class=\"info-item\">\n          <div class=\"info-label\">Inspector</div>\n          <div class=\"info-value\">${escapeHtml(inspectorName)}</div>\n        </div>\n        <div class=\"info-item\">\n          <div class=\"info-label\">Inspection Date</div>\n          <div class=\"info-value\">${escapeHtml(formattedDate)}</div>\n        </div>\n        <div class=\"info-item\">\n          <div class=\"info-label\">Status</div>\n          <div class=\"info-value\">\n            <span class=\"status-badge\">${escapeHtml(inspection.status.toUpperCase())}</span>\n          </div>\n        </div>\n        ${inspection.notes ? `\n          <div class=\"info-item\" style=\"grid-column: 1 / -1;\">\n            <div class=\"info-label\">General Notes</div>\n            <div class=\"info-value\">${escapeHtml(inspection.notes)}</div>\n          </div>\n        ` : \"\"}\n      </div>\n\n      <!-- Inspection Sections -->\n      ${sectionsHTML}\n    </div>\n  </div>\n</body>\n</html>\n  `;\n}\n","size_bytes":16439},"client/src/components/SettingsTeamsPanel.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Edit2, Trash2, Users, Mail, X } from \"lucide-react\";\nimport { z } from \"zod\";\nimport type { InspectionCategory } from \"@shared/schema\";\n\n// Team schema\nconst teamFormSchema = z.object({\n  name: z.string().min(1, \"Team name is required\"),\n  description: z.string().optional(),\n  email: z.string().email(\"Valid email is required\"),\n  isActive: z.boolean().default(true),\n  userIds: z.array(z.string()).default([]),\n  contactIds: z.array(z.string()).default([]),\n  categories: z.array(z.string()).default([]),\n});\n\ntype TeamFormValues = z.infer<typeof teamFormSchema>;\n\ninterface Team {\n  id: string;\n  name: string;\n  description: string | null;\n  email: string;\n  isActive: boolean;\n  memberCount: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface TeamMember {\n  id: string;\n  teamId: string;\n  userId: string | null;\n  contactId: string | null;\n  role: string;\n  user?: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    email: string;\n    role: string;\n  } | null;\n  contact?: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    email: string;\n    type: string;\n  } | null;\n}\n\ninterface TeamCategory {\n  id: string;\n  teamId: string;\n  category: string;\n}\n\ninterface User {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  role: string;\n}\n\ninterface Contact {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  type: string;\n}\n\nexport default function SettingsTeamsPanel() {\n  const { toast } = useToast();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingTeam, setEditingTeam] = useState<Team | null>(null);\n  const [deletingTeam, setDeletingTeam] = useState<Team | null>(null);\n\n  // Fetch teams\n  const { data: teams = [], isLoading: teamsLoading } = useQuery<Team[]>({\n    queryKey: ['/api/teams'],\n  });\n\n  // Fetch users (organization members)\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n  });\n\n  // Fetch contacts (contractors)\n  const { data: contacts = [] } = useQuery<Contact[]>({\n    queryKey: ['/api/contacts'],\n  });\n\n  // Fetch inspection categories\n  const { data: inspectionCategories = [] } = useQuery<InspectionCategory[]>({\n    queryKey: ['/api/inspection-categories'],\n  });\n\n  // Create team mutation - uses single atomic endpoint\n  const createMutation = useMutation({\n    mutationFn: async (data: TeamFormValues) => {\n      // Single server-side transactional create\n      return await apiRequest(\"POST\", \"/api/teams/full\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teams'] });\n      toast({\n        title: \"Success\",\n        description: \"Team created successfully\",\n      });\n      setIsCreateDialogOpen(false);\n      createForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create team\",\n      });\n    },\n  });\n\n  // Update team mutation - uses single atomic endpoint\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: TeamFormValues }) => {\n      // Single server-side transactional update\n      return await apiRequest(\"PATCH\", `/api/teams/${id}/full`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teams'] });\n      toast({\n        title: \"Success\",\n        description: \"Team updated successfully\",\n      });\n      setEditingTeam(null);\n      editForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update team\",\n      });\n    },\n  });\n\n  // Delete team mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/teams/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teams'] });\n      toast({\n        title: \"Success\",\n        description: \"Team deleted successfully\",\n      });\n      setDeletingTeam(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to delete team\",\n      });\n    },\n  });\n\n  const createForm = useForm<TeamFormValues>({\n    resolver: zodResolver(teamFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      email: \"\",\n      isActive: true,\n      userIds: [],\n      contactIds: [],\n      categories: [],\n    },\n  });\n\n  const editForm = useForm<TeamFormValues>({\n    resolver: zodResolver(teamFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      email: \"\",\n      isActive: true,\n      userIds: [],\n      contactIds: [],\n      categories: [],\n    },\n  });\n\n  // Load team data when editing\n  const loadTeamForEdit = async (team: Team) => {\n    const members: any = await apiRequest(\"GET\", `/api/teams/${team.id}/members`);\n    const categories: any = await apiRequest(\"GET\", `/api/teams/${team.id}/categories`);\n    \n    editForm.reset({\n      name: team.name,\n      description: team.description || \"\",\n      email: team.email,\n      isActive: team.isActive,\n      userIds: members.filter((m: any) => m.userId).map((m: any) => m.userId!),\n      contactIds: members.filter((m: any) => m.contactId).map((m: any) => m.contactId!),\n      categories: categories.map((c: any) => c.category),\n    });\n    \n    setEditingTeam(team);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Teams</h2>\n          <p className=\"text-muted-foreground\">\n            Manage work order teams and email distribution lists\n          </p>\n        </div>\n        <Button \n          onClick={() => setIsCreateDialogOpen(true)} \n          data-testid=\"button-create-team\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create Team\n        </Button>\n      </div>\n\n      {teamsLoading ? (\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map(i => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader>\n                <div className=\"h-6 bg-muted rounded w-1/4\" />\n                <div className=\"h-4 bg-muted rounded w-1/2\" />\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : teams.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-8 text-center\">\n            <Users className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <p className=\"text-lg font-medium\">No teams yet</p>\n            <p className=\"text-muted-foreground mb-4\">\n              Create your first team to manage work order assignments\n            </p>\n            <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-first-team\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Team\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          {teams.map((team) => (\n            <Card key={team.id} data-testid={`card-team-${team.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <CardTitle className=\"text-lg\" data-testid={`text-team-name-${team.id}`}>\n                        {team.name}\n                      </CardTitle>\n                      {!team.isActive && (\n                        <Badge variant=\"secondary\" data-testid={`badge-team-inactive-${team.id}`}>\n                          Inactive\n                        </Badge>\n                      )}\n                    </div>\n                    {team.description && (\n                      <CardDescription data-testid={`text-team-description-${team.id}`}>\n                        {team.description}\n                      </CardDescription>\n                    )}\n                    <div className=\"flex items-center gap-4 mt-3 text-sm\">\n                      <div className=\"flex items-center gap-1 text-muted-foreground\">\n                        <Mail className=\"h-4 w-4\" />\n                        <span data-testid={`text-team-email-${team.id}`}>{team.email}</span>\n                      </div>\n                      <div className=\"flex items-center gap-1 text-muted-foreground\">\n                        <Users className=\"h-4 w-4\" />\n                        <span data-testid={`text-team-member-count-${team.id}`}>\n                          {team.memberCount} {team.memberCount === 1 ? 'member' : 'members'}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => loadTeamForEdit(team)}\n                      data-testid={`button-edit-team-${team.id}`}\n                    >\n                      <Edit2 className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => setDeletingTeam(team)}\n                      data-testid={`button-delete-team-${team.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {/* Create Team Dialog */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-create-team\">\n          <DialogHeader>\n            <DialogTitle>Create Team</DialogTitle>\n            <DialogDescription>\n              Create a team for work order management with email distribution list\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...createForm}>\n            <form onSubmit={createForm.handleSubmit((data) => createMutation.mutate(data))} className=\"space-y-4\">\n              <FormField\n                control={createForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Name</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"e.g., Maintenance Team\" data-testid=\"input-team-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={createForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description (Optional)</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Team description\" data-testid=\"input-team-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={createForm.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Distribution Email</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"email\" placeholder=\"team@example.com\" data-testid=\"input-team-email\" />\n                    </FormControl>\n                    <FormDescription>\n                      Work order notifications will be sent to this email\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={createForm.control}\n                name=\"userIds\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Members (Staff)</FormLabel>\n                    <div className=\"space-y-2\">\n                      {users.map((user) => (\n                        <div key={user.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(user.id)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), user.id]\n                                : (field.value || []).filter((id) => id !== user.id);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-user-${user.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {user.firstName} {user.lastName} ({user.email})\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={createForm.control}\n                name=\"contactIds\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Members (Contractors)</FormLabel>\n                    <div className=\"space-y-2\">\n                      {contacts.filter(c => c.type === 'contractor').map((contact) => (\n                        <div key={contact.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(contact.id)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), contact.id]\n                                : (field.value || []).filter((id) => id !== contact.id);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-contact-${contact.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {contact.firstName} {contact.lastName} ({contact.email})\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={createForm.control}\n                name=\"categories\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Maintenance Categories</FormLabel>\n                    <FormDescription>\n                      Assign categories to auto-route work orders to this team\n                    </FormDescription>\n                    <div className=\"space-y-2\">\n                      {inspectionCategories.map((category) => (\n                        <div key={category.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(category.name)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), category.name]\n                                : (field.value || []).filter((name) => name !== category.name);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-category-${category.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {category.name}\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={createForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                    <FormControl>\n                      <Checkbox\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"checkbox-team-active\"\n                      />\n                    </FormControl>\n                    <div className=\"space-y-1 leading-none\">\n                      <FormLabel>Active</FormLabel>\n                      <FormDescription>\n                        Only active teams can be assigned work orders\n                      </FormDescription>\n                    </div>\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsCreateDialogOpen(false)}\n                  data-testid=\"button-cancel-create-team\"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createMutation.isPending}\n                  data-testid=\"button-submit-create-team\"\n                >\n                  {createMutation.isPending ? \"Creating...\" : \"Create Team\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Team Dialog */}\n      <Dialog open={!!editingTeam} onOpenChange={(open) => !open && setEditingTeam(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-edit-team\">\n          <DialogHeader>\n            <DialogTitle>Edit Team</DialogTitle>\n            <DialogDescription>\n              Update team details and assignments\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form \n              onSubmit={editForm.handleSubmit((data) => editingTeam && updateMutation.mutate({ id: editingTeam.id, data }))} \n              className=\"space-y-4\"\n            >\n              <FormField\n                control={editForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Name</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"e.g., Maintenance Team\" data-testid=\"input-edit-team-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description (Optional)</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Team description\" data-testid=\"input-edit-team-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Distribution Email</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"email\" placeholder=\"team@example.com\" data-testid=\"input-edit-team-email\" />\n                    </FormControl>\n                    <FormDescription>\n                      Work order notifications will be sent to this email\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={editForm.control}\n                name=\"userIds\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Members (Staff)</FormLabel>\n                    <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                      {users.map((user) => (\n                        <div key={user.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(user.id)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), user.id]\n                                : (field.value || []).filter((id) => id !== user.id);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-edit-user-${user.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {user.firstName} {user.lastName} ({user.email})\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={editForm.control}\n                name=\"contactIds\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Members (Contractors)</FormLabel>\n                    <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                      {contacts.filter(c => c.type === 'contractor').map((contact) => (\n                        <div key={contact.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(contact.id)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), contact.id]\n                                : (field.value || []).filter((id) => id !== contact.id);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-edit-contact-${contact.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {contact.firstName} {contact.lastName} ({contact.email})\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={editForm.control}\n                name=\"categories\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Maintenance Categories</FormLabel>\n                    <FormDescription>\n                      Assign categories to auto-route work orders to this team\n                    </FormDescription>\n                    <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                      {inspectionCategories.map((category) => (\n                        <div key={category.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            checked={field.value?.includes(category.name)}\n                            onCheckedChange={(checked) => {\n                              const updatedValue = checked\n                                ? [...(field.value || []), category.name]\n                                : (field.value || []).filter((name) => name !== category.name);\n                              field.onChange(updatedValue);\n                            }}\n                            data-testid={`checkbox-edit-category-${category.id}`}\n                          />\n                          <Label className=\"font-normal cursor-pointer\">\n                            {category.name}\n                          </Label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={editForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                    <FormControl>\n                      <Checkbox\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"checkbox-edit-team-active\"\n                      />\n                    </FormControl>\n                    <div className=\"space-y-1 leading-none\">\n                      <FormLabel>Active</FormLabel>\n                      <FormDescription>\n                        Only active teams can be assigned work orders\n                      </FormDescription>\n                    </div>\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setEditingTeam(null)}\n                  data-testid=\"button-cancel-edit-team\"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-submit-edit-team\"\n                >\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={!!deletingTeam} onOpenChange={(open) => !open && setDeletingTeam(null)}>\n        <DialogContent data-testid=\"dialog-delete-team\">\n          <DialogHeader>\n            <DialogTitle>Delete Team</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingTeam?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setDeletingTeam(null)}\n              data-testid=\"button-cancel-delete-team\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingTeam && deleteMutation.mutate(deletingTeam.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-team\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete Team\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":28398},"client/src/pages/Analytics.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { BarChart3, TrendingUp, Users, AlertCircle, Clock } from \"lucide-react\";\n\ninterface WorkOrderAnalytics {\n  total: number;\n  statusDistribution: { [key: string]: number };\n  priorityDistribution: { [key: string]: number };\n  teamDistribution: { [key: string]: { name: string; count: number } };\n  categoryDistribution: { [key: string]: number };\n  averageResolutionTimeMinutes: number;\n}\n\nexport default function Analytics() {\n  const { data: analytics, isLoading } = useQuery<WorkOrderAnalytics>({\n    queryKey: [\"/api/analytics/work-orders\"],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"space-y-4\">\n          <div className=\"h-8 bg-muted rounded animate-pulse\" />\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n            {[1, 2, 3, 4].map((i) => (\n              <Card key={i}>\n                <CardHeader className=\"space-y-2\">\n                  <div className=\"h-4 bg-muted rounded animate-pulse\" />\n                  <div className=\"h-8 bg-muted rounded animate-pulse\" />\n                </CardHeader>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">No analytics data available</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\" data-testid=\"heading-analytics\">\n            Work Order Analytics\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Overview of maintenance and work order metrics\n          </p>\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-5\">\n        <Card data-testid=\"card-total-work-orders\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Work Orders</CardTitle>\n            <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-count\">\n              {analytics.total}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-open-work-orders\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Open</CardTitle>\n            <AlertCircle className=\"h-4 w-4 text-yellow-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-open-count\">\n              {analytics.statusDistribution?.open || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-in-progress-work-orders\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">In Progress</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-in-progress-count\">\n              {analytics.statusDistribution?.in_progress || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-completed-work-orders\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Completed</CardTitle>\n            <Users className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-completed-count\">\n              {analytics.statusDistribution?.completed || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-avg-resolution-time\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Avg Resolution</CardTitle>\n            <Clock className=\"h-4 w-4 text-purple-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-avg-resolution-time\">\n              {analytics.averageResolutionTimeMinutes > 0\n                ? (() => {\n                    const hours = Math.floor(analytics.averageResolutionTimeMinutes / 60);\n                    const minutes = Math.round(analytics.averageResolutionTimeMinutes % 60);\n                    return hours > 0 && minutes > 0\n                      ? `${hours}h ${minutes}m`\n                      : hours > 0\n                      ? `${hours}h`\n                      : `${minutes}m`;\n                  })()\n                : \"N/A\"}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Distribution Charts */}\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        {/* Priority Distribution */}\n        <Card data-testid=\"card-priority-distribution\">\n          <CardHeader>\n            <CardTitle>Priority Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {Object.entries(analytics.priorityDistribution || {}).map(([priority, count]) => (\n                <div key={priority} className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div\n                      className={`w-3 h-3 rounded-full ${\n                        priority === \"urgent\"\n                          ? \"bg-red-500\"\n                          : priority === \"high\"\n                          ? \"bg-orange-500\"\n                          : priority === \"medium\"\n                          ? \"bg-yellow-500\"\n                          : \"bg-green-500\"\n                      }`}\n                    />\n                    <span className=\"capitalize\" data-testid={`text-priority-${priority}`}>\n                      {priority}\n                    </span>\n                  </div>\n                  <span className=\"font-medium\" data-testid={`text-priority-${priority}-count`}>\n                    {count as number}\n                  </span>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Category Distribution */}\n        <Card data-testid=\"card-category-distribution\">\n          <CardHeader>\n            <CardTitle>Category Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {Object.entries(analytics.categoryDistribution || {}).map(([category, count]) => (\n                <div key={category} className=\"flex items-center justify-between\">\n                  <span className=\"capitalize\" data-testid={`text-category-${category}`}>\n                    {category}\n                  </span>\n                  <span className=\"font-medium\" data-testid={`text-category-${category}-count`}>\n                    {count as number}\n                  </span>\n                </div>\n              ))}\n              {Object.keys(analytics.categoryDistribution || {}).length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">No categories assigned yet</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Team Distribution */}\n        <Card data-testid=\"card-team-distribution\" className=\"md:col-span-2\">\n          <CardHeader>\n            <CardTitle>Team Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {Object.entries(analytics.teamDistribution || {}).map(([teamId, data]: [string, any]) => (\n                <div key={teamId} className=\"flex items-center justify-between\">\n                  <span data-testid={`text-team-${teamId}`}>{data.name}</span>\n                  <span className=\"font-medium\" data-testid={`text-team-${teamId}-count`}>\n                    {data.count}\n                  </span>\n                </div>\n              ))}\n              {Object.keys(analytics.teamDistribution || {}).length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">No teams assigned yet</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8775},"server/documentProcessor.ts":{"content":"import mammoth from 'mammoth';\n\nexport interface ProcessedDocument {\n  extractedText: string;\n  pageCount?: number;\n  error?: string;\n}\n\nexport async function extractTextFromFile(\n  fileUrl: string,\n  fileType: string\n): Promise<ProcessedDocument> {\n  try {\n    const response = await fetch(fileUrl);\n    if (!response.ok) {\n      throw new Error(`Failed to fetch file: ${response.statusText}`);\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    const fileBuffer = Buffer.from(arrayBuffer);\n\n    if (fileType === 'pdf' || fileType === 'application/pdf') {\n      return await extractTextFromPDF(fileBuffer);\n    } else if (\n      fileType === 'docx' ||\n      fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n    ) {\n      return await extractTextFromWord(fileBuffer);\n    } else if (fileType === 'txt' || fileType === 'text/plain') {\n      return {\n        extractedText: fileBuffer.toString('utf-8'),\n      };\n    } else {\n      return {\n        extractedText: '',\n        error: `Unsupported file type: ${fileType}`,\n      };\n    }\n  } catch (error: any) {\n    console.error('[Document Processor] Error extracting text:', error);\n    return {\n      extractedText: '',\n      error: error.message || 'Failed to extract text from document',\n    };\n  }\n}\n\nasync function extractTextFromPDF(buffer: Buffer): Promise<ProcessedDocument> {\n  try {\n    const pdfParse = (await import('pdf-parse')).default;\n    const data = await pdfParse(buffer);\n    return {\n      extractedText: data.text,\n      pageCount: data.numpages,\n    };\n  } catch (error: any) {\n    console.error('[PDF Parser] Error:', error);\n    return {\n      extractedText: '',\n      error: error.message || 'Failed to parse PDF',\n    };\n  }\n}\n\nasync function extractTextFromWord(buffer: Buffer): Promise<ProcessedDocument> {\n  try {\n    const result = await mammoth.extractRawText({ buffer });\n    return {\n      extractedText: result.value,\n    };\n  } catch (error: any) {\n    console.error('[Word Parser] Error:', error);\n    return {\n      extractedText: '',\n      error: error.message || 'Failed to parse Word document',\n    };\n  }\n}\n\nexport function chunkText(text: string, chunkSize: number = 2000): string[] {\n  const sentences = text.split(/[.!?]\\s+/);\n  const chunks: string[] = [];\n  let currentChunk = '';\n\n  for (const sentence of sentences) {\n    if ((currentChunk + sentence).length <= chunkSize) {\n      currentChunk += (currentChunk ? '. ' : '') + sentence;\n    } else {\n      if (currentChunk) chunks.push(currentChunk);\n      currentChunk = sentence;\n    }\n  }\n\n  if (currentChunk) chunks.push(currentChunk);\n  return chunks;\n}\n\nexport function findRelevantChunks(\n  text: string,\n  query: string,\n  maxChunks: number = 3\n): string[] {\n  const chunks = chunkText(text);\n  const queryTerms = query.toLowerCase().split(/\\s+/);\n\n  const scoredChunks = chunks.map((chunk) => {\n    const chunkLower = chunk.toLowerCase();\n    let score = 0;\n\n    for (const term of queryTerms) {\n      const matches = (chunkLower.match(new RegExp(term, 'g')) || []).length;\n      score += matches;\n    }\n\n    return { chunk, score };\n  });\n\n  return scoredChunks\n    .filter((item) => item.score > 0)\n    .sort((a, b) => b.score - a.score)\n    .slice(0, maxChunks)\n    .map((item) => item.chunk);\n}\n","size_bytes":3307},"client/src/pages/KnowledgeBase.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { BookOpen, Upload, FileText, Trash2, ArrowLeft, File, CheckCircle, XCircle } from \"lucide-react\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport Uppy from '@uppy/core';\nimport { Dashboard as UppyDashboard } from '@uppy/react';\nimport AwsS3 from '@uppy/aws-s3';\n\nexport default function KnowledgeBase() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [uploadDialog, setUploadDialog] = useState(false);\n  const [deleteDialog, setDeleteDialog] = useState(false);\n  const [selectedDoc, setSelectedDoc] = useState<any>(null);\n  const [uploadData, setUploadData] = useState({\n    title: \"\",\n    category: \"\",\n    description: \"\",\n    fileUrl: \"\",\n    fileName: \"\",\n    fileType: \"\",\n    fileSizeBytes: 0,\n  });\n  const [uppy] = useState(() =>\n    new Uppy({\n      restrictions: {\n        maxFileSize: 10 * 1024 * 1024,\n        allowedFileTypes: ['.pdf', '.docx', '.txt'],\n      },\n    }).use(AwsS3, {\n      endpoint: '/api/object-storage/upload',\n      shouldUseMultipart: false,\n    })\n  );\n\n  useEffect(() => {\n    const handleUploadSuccess = async (file: any, response: any) => {\n      const { extractFileUrlFromUploadResponse } = await import(\"@/lib/utils\");\n      const fileUrl = extractFileUrlFromUploadResponse(file, response);\n      \n      if (fileUrl && file) {\n        // Convert relative path to absolute URL if needed\n        const absoluteUrl = fileUrl.startsWith('/') \n          ? `${window.location.origin}${fileUrl}`\n          : fileUrl;\n        \n        setUploadData(prev => ({\n          ...prev,\n          fileUrl: absoluteUrl,\n          fileName: file.name,\n          fileType: file.type || '',\n          fileSizeBytes: file.size,\n        }));\n      }\n    };\n\n    uppy.on('upload-success', handleUploadSuccess);\n\n    return () => {\n      uppy.off('upload-success', handleUploadSuccess);\n    };\n  }, [uppy]);\n\n  const { data: adminUser } = useQuery({\n    queryKey: [\"/api/admin/me\"],\n    retry: false,\n  });\n\n  const { data: documents = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/knowledge-base/documents\"],\n    enabled: !!adminUser,\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await fetch(\"/api/knowledge-base/documents\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to upload document\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/knowledge-base/documents\"] });\n      setUploadDialog(false);\n      setUploadData({\n        title: \"\",\n        category: \"\",\n        description: \"\",\n        fileUrl: \"\",\n        fileName: \"\",\n        fileType: \"\",\n        fileSizeBytes: 0,\n      });\n      uppy.reset();\n      toast({\n        title: \"Document Uploaded\",\n        description: \"Knowledge base document has been processed and uploaded successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Upload Failed\",\n        description: error.message || \"Failed to upload document\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/knowledge-base/documents/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete document\");\n      // DELETE endpoints may return 204 No Content with empty body\n      if (response.status === 204 || response.headers.get(\"content-length\") === \"0\") {\n        return null;\n      }\n      const text = await response.text();\n      return text ? JSON.parse(text) : null;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/knowledge-base/documents\"] });\n      setDeleteDialog(false);\n      setSelectedDoc(null);\n      toast({\n        title: \"Document Deleted\",\n        description: \"Knowledge base document has been deleted successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Delete Failed\",\n        description: \"Failed to delete document\",\n      });\n    },\n  });\n\n  const handleUpload = () => {\n    if (!uploadData.title || !uploadData.fileUrl) {\n      toast({\n        variant: \"destructive\",\n        title: \"Missing Information\",\n        description: \"Please provide a title and upload a file\",\n      });\n      return;\n    }\n\n    uploadMutation.mutate(uploadData);\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return bytes + ' B';\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\n  };\n\n  if (!adminUser) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <Card className=\"w-96\">\n          <CardHeader>\n            <CardTitle>Access Denied</CardTitle>\n            <CardDescription>You must be logged in as an admin to access this page</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button onClick={() => navigate(\"/admin/login\")} className=\"w-full\">\n              Go to Admin Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-3\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => navigate(\"/admin\")} data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n              <BookOpen className=\"h-8 w-8\" />\n              AI Chatbot Knowledge Base\n            </h1>\n            <p className=\"text-muted-foreground\">Manage documents for the AI assistant</p>\n          </div>\n        </div>\n        <Button onClick={() => setUploadDialog(true)} data-testid=\"button-upload\">\n          <Upload className=\"h-4 w-4 mr-2\" />\n          Upload Document\n        </Button>\n      </div>\n\n      <Alert>\n        <FileText className=\"h-4 w-4\" />\n        <AlertDescription>\n          Upload user guides, best practices, and documentation (PDF, DOCX, TXT). The AI chatbot will use these documents to answer user questions.\n        </AlertDescription>\n      </Alert>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Knowledge Base Documents ({documents.length})</CardTitle>\n          <CardDescription>Documents available to the AI assistant</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading documents...</div>\n          ) : documents.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No documents uploaded yet. Upload your first document to get started.\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Title</TableHead>\n                  <TableHead>Category</TableHead>\n                  <TableHead>File</TableHead>\n                  <TableHead>Size</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Uploaded</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {documents.map((doc) => (\n                  <tr key={doc.id} data-testid={`row-document-${doc.id}`}>\n                    <TableCell className=\"font-medium\">{doc.title}</TableCell>\n                    <TableCell>\n                      {doc.category ? (\n                        <Badge variant=\"outline\">{doc.category}</Badge>\n                      ) : (\n                        <span className=\"text-muted-foreground text-sm\">No category</span>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"flex items-center gap-2\">\n                      <File className=\"h-4 w-4\" />\n                      <span className=\"text-sm\">{doc.fileName}</span>\n                    </TableCell>\n                    <TableCell className=\"text-sm text-muted-foreground\">\n                      {formatFileSize(doc.fileSizeBytes)}\n                    </TableCell>\n                    <TableCell>\n                      {doc.isActive ? (\n                        <Badge variant=\"default\" className=\"bg-green-500\">\n                          <CheckCircle className=\"h-3 w-3 mr-1\" />\n                          Active\n                        </Badge>\n                      ) : (\n                        <Badge variant=\"secondary\">\n                          <XCircle className=\"h-3 w-3 mr-1\" />\n                          Inactive\n                        </Badge>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-sm text-muted-foreground\">\n                      {new Date(doc.createdAt).toLocaleDateString()}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setSelectedDoc(doc);\n                          setDeleteDialog(true);\n                        }}\n                        data-testid={`button-delete-${doc.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </TableCell>\n                  </tr>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={uploadDialog} onOpenChange={setUploadDialog}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Upload Knowledge Base Document</DialogTitle>\n            <DialogDescription>\n              Upload a PDF, DOCX, or TXT file. The text will be automatically extracted for the AI assistant.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"title\">Document Title *</Label>\n              <Input\n                id=\"title\"\n                value={uploadData.title}\n                onChange={(e) => setUploadData(prev => ({ ...prev, title: e.target.value }))}\n                placeholder=\"e.g., Inspect360 User Guide\"\n                data-testid=\"input-title\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"category\">Category (optional)</Label>\n              <Input\n                id=\"category\"\n                value={uploadData.category}\n                onChange={(e) => setUploadData(prev => ({ ...prev, category: e.target.value }))}\n                placeholder=\"e.g., User Guide, Best Practices, Compliance\"\n                data-testid=\"input-category\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"description\">Description (optional)</Label>\n              <Textarea\n                id=\"description\"\n                value={uploadData.description}\n                onChange={(e) => setUploadData(prev => ({ ...prev, description: e.target.value }))}\n                placeholder=\"Brief description of the document content\"\n                rows={3}\n                data-testid=\"input-description\"\n              />\n            </div>\n            <div>\n              <Label>Upload File *</Label>\n              <div className=\"mt-2\">\n                <UppyDashboard uppy={uppy} height={250} />\n              </div>\n              {uploadData.fileName && (\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Selected: {uploadData.fileName} ({formatFileSize(uploadData.fileSizeBytes)})\n                </p>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setUploadDialog(false)} disabled={uploadMutation.isPending}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpload}\n              disabled={uploadMutation.isPending || !uploadData.title || !uploadData.fileUrl}\n              data-testid=\"button-submit-upload\"\n            >\n              {uploadMutation.isPending ? \"Processing...\" : \"Upload & Process\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteDialog} onOpenChange={setDeleteDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Document</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{selectedDoc?.title}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => selectedDoc && deleteMutation.mutate(selectedDoc.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":14574},"client/src/components/AIChatbot.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { MessageCircle, Send, Bot, User, Loader2, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport type { ChatMessage } from \"@shared/schema\";\n\nexport function AIChatbot() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [message, setMessage] = useState(\"\");\n  const [conversationId, setConversationId] = useState<string | null>(null);\n  const [showConversations, setShowConversations] = useState(false);\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const { toast } = useToast();\n\n  const { data: conversations = [], isLoading: isLoadingConversations, error: conversationsError } = useQuery<any[]>({\n    queryKey: [\"/api/chat/conversations\"],\n    queryFn: async () => {\n      const response = await apiRequest(\"GET\", \"/api/chat/conversations\");\n      return response.json();\n    },\n    enabled: isOpen,\n  });\n\n  const { data: messages = [], isLoading: isLoadingMessages, error: messagesError } = useQuery<ChatMessage[]>({\n    queryKey: conversationId ? [\"/api/chat/conversations\", conversationId, \"messages\"] : [\"no-conversation\"],\n    queryFn: async () => {\n      if (!conversationId) return [];\n      const response = await apiRequest(\"GET\", `/api/chat/conversations/${conversationId}/messages`);\n      return response.json();\n    },\n    enabled: !!conversationId && isOpen,\n    retry: false,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async ({ message }: { message: string }) => {\n      let convId = conversationId;\n\n      if (!convId) {\n        const convResponse = await apiRequest(\"POST\", \"/api/chat/conversations\", {\n          title: message.substring(0, 50),\n        });\n        const convData: any = await convResponse.json();\n        convId = convData.id;\n        setConversationId(convId);\n      }\n\n      const messageResponse = await apiRequest(\"POST\", `/api/chat/conversations/${convId}/messages`, {\n        content: message,\n      });\n      await messageResponse.json();\n\n      return convId;\n    },\n    onSuccess: (convId) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\", convId, \"messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setMessage(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Message Failed\",\n        description: error.message || \"Failed to send message\",\n      });\n    },\n  });\n\n  useEffect(() => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n    }\n  }, [messages]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!message.trim() || sendMessageMutation.isPending) return;\n\n    sendMessageMutation.mutate({ message: message.trim() });\n  };\n\n  const handleNewConversation = () => {\n    setConversationId(null);\n    setShowConversations(false);\n  };\n\n  const handleSelectConversation = (id: string) => {\n    setConversationId(id);\n    setShowConversations(false);\n  };\n\n  return (\n    <>\n      <Button\n        size=\"icon\"\n        className=\"fixed bottom-6 right-6 h-14 w-14 rounded-full shadow-lg z-50\"\n        onClick={() => setIsOpen(true)}\n        data-testid=\"button-chatbot-open\"\n      >\n        <MessageCircle className=\"h-6 w-6\" />\n      </Button>\n\n      <Dialog open={isOpen} onOpenChange={setIsOpen}>\n        <DialogContent className=\"max-w-2xl h-[600px] p-0 flex flex-col\">\n          <DialogHeader className=\"px-6 py-4 border-b\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Bot className=\"h-5 w-5 text-primary\" />\n                <div>\n                  <DialogTitle>AI Assistant</DialogTitle>\n                  <p className=\"text-sm text-muted-foreground\">Ask me anything about Inspect360</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {conversations.length > 0 && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setShowConversations(!showConversations)}\n                    data-testid=\"button-show-conversations\"\n                  >\n                    History ({conversations.length})\n                  </Button>\n                )}\n                {conversationId && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleNewConversation}\n                    data-testid=\"button-new-chat\"\n                  >\n                    New Chat\n                  </Button>\n                )}\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setIsOpen(false)}\n                  data-testid=\"button-chatbot-close\"\n                >\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </div>\n          </DialogHeader>\n\n          <ScrollArea className=\"flex-1 p-6\" ref={scrollRef}>\n            {showConversations ? (\n              <div className=\"space-y-2\">\n                <h3 className=\"text-sm font-semibold mb-4\">Conversation History</h3>\n                {isLoadingConversations ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n                  </div>\n                ) : conversationsError ? (\n                  <Alert variant=\"destructive\">\n                    <AlertDescription>Failed to load conversation history</AlertDescription>\n                  </Alert>\n                ) : conversations.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    No conversation history yet\n                  </div>\n                ) : (\n                  conversations.map((conv) => (\n                    <Card\n                      key={conv.id}\n                      className=\"p-3 hover-elevate cursor-pointer\"\n                      onClick={() => handleSelectConversation(conv.id)}\n                      data-testid={`conversation-${conv.id}`}\n                    >\n                      <div className=\"font-medium text-sm\">{conv.title || \"Untitled\"}</div>\n                      <div className=\"text-xs text-muted-foreground\">\n                        {new Date(conv.createdAt).toLocaleDateString()}\n                      </div>\n                    </Card>\n                  ))\n                )}\n              </div>\n            ) : !conversationId && messages.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center h-full text-center space-y-4\">\n                <Bot className=\"h-16 w-16 text-muted-foreground/50\" />\n                <div>\n                  <h3 className=\"text-lg font-semibold\">Welcome to Inspect360 AI Assistant</h3>\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    Ask me about inspections, compliance, properties, or any features\n                  </p>\n                </div>\n              </div>\n            ) : messagesError ? (\n              <Alert variant=\"destructive\" className=\"m-4\">\n                <AlertDescription>Failed to load messages. Please try again.</AlertDescription>\n              </Alert>\n            ) : isLoadingMessages ? (\n              <div className=\"flex items-center justify-center h-full\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {messages.map((msg) => (\n                  <div\n                    key={msg.id}\n                    className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}\n                    data-testid={`message-${msg.role}-${msg.id}`}\n                  >\n                    {msg.role === 'assistant' && (\n                      <div className=\"flex-shrink-0\">\n                        <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                          <Bot className=\"h-5 w-5 text-primary\" />\n                        </div>\n                      </div>\n                    )}\n                    <div\n                      className={`max-w-[80%] rounded-lg px-4 py-2 ${\n                        msg.role === 'user'\n                          ? 'bg-primary text-primary-foreground'\n                          : 'bg-muted'\n                      }`}\n                    >\n                      <p className=\"text-sm whitespace-pre-wrap\">{msg.content}</p>\n                      <p className=\"text-xs mt-1 opacity-70\">\n                        {msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString() : ''}\n                      </p>\n                    </div>\n                    {msg.role === 'user' && (\n                      <div className=\"flex-shrink-0\">\n                        <div className=\"w-8 h-8 rounded-full bg-primary flex items-center justify-center\">\n                          <User className=\"h-5 w-5 text-primary-foreground\" />\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n                {sendMessageMutation.isPending && (\n                  <div className=\"flex gap-3 justify-start\">\n                    <div className=\"flex-shrink-0\">\n                      <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <Bot className=\"h-5 w-5 text-primary\" />\n                      </div>\n                    </div>\n                    <div className=\"bg-muted rounded-lg px-4 py-2\">\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n          </ScrollArea>\n\n          <div className=\"border-t p-4\">\n            <form onSubmit={handleSubmit} className=\"flex gap-2\">\n              <Input\n                value={message}\n                onChange={(e) => setMessage(e.target.value)}\n                placeholder=\"Ask a question...\"\n                disabled={sendMessageMutation.isPending}\n                data-testid=\"input-message\"\n              />\n              <Button\n                type=\"submit\"\n                disabled={!message.trim() || sendMessageMutation.isPending}\n                data-testid=\"button-send\"\n              >\n                <Send className=\"h-4 w-4\" />\n              </Button>\n            </form>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","size_bytes":11184},"client/src/pages/TenantLogin.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Home } from \"lucide-react\";\nimport logoUrl from \"@assets/Inspect360 Logo_1761302629835.png\";\n\nconst tenantLoginSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\ntype TenantLoginData = z.infer<typeof tenantLoginSchema>;\n\nexport default function TenantLogin() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n\n  const form = useForm<TenantLoginData>({\n    resolver: zodResolver(tenantLoginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (data: TenantLoginData) => {\n    setIsLoading(true);\n    try {\n      const res = await apiRequest(\"POST\", \"/api/tenant/login\", data);\n      \n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || \"Login failed\");\n      }\n\n      // Await response to ensure session is set\n      const result = await res.json();\n\n      // Verify user data exists\n      if (!result?.user) {\n        throw new Error(\"Invalid response from server\");\n      }\n\n      // Set the user data in the cache directly (like staff login)\n      queryClient.setQueryData([\"/api/auth/user\"], result.user);\n\n      // Refetch to ensure session is fully established before navigation\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"], exact: true, type: \"active\" });\n\n      toast({\n        title: \"Welcome back!\",\n        description: \"You've successfully logged in.\",\n      });\n\n      // Navigate only after auth state is fully updated\n      navigate(\"/tenant/home\");\n    } catch (error: any) {\n      toast({\n        title: \"Login Failed\",\n        description: error.message || \"Invalid email or password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-[hsl(174,100%,42%)] to-[hsl(193,40%,38%)] p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-4 text-center\">\n          <div className=\"flex justify-center\">\n            <img src={logoUrl} alt=\"Inspect360\" className=\"h-16 w-auto\" />\n          </div>\n          <div>\n            <CardTitle className=\"text-2xl font-bold\">Tenant Portal</CardTitle>\n            <CardDescription>Access your property information and maintenance</CardDescription>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        type=\"email\"\n                        placeholder=\"your.email@example.com\"\n                        data-testid=\"input-tenant-email\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"password\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Password</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        type=\"password\"\n                        placeholder=\"\"\n                        data-testid=\"input-tenant-password\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={isLoading}\n                data-testid=\"button-tenant-login\"\n              >\n                {isLoading ? \"Signing in...\" : \"Sign In\"}\n              </Button>\n            </form>\n          </Form>\n\n          <div className=\"mt-6 text-center\">\n            <Button\n              variant=\"ghost\"\n              onClick={() => navigate(\"/\")}\n              data-testid=\"button-back-home\"\n              className=\"text-sm\"\n            >\n              <Home className=\"w-4 h-4 mr-2\" />\n              Back to Home\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":5218},"client/src/pages/TenantRequests.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ArrowLeft, MessageSquare } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { format } from \"date-fns\";\n\nconst statusColors: Record<string, string> = {\n  open: \"bg-yellow-100 text-yellow-800\",\n  in_progress: \"bg-blue-100 text-blue-800\",\n  completed: \"bg-green-100 text-green-800\",\n  closed: \"bg-gray-100 text-gray-800\",\n};\n\nconst priorityColors: Record<string, string> = {\n  low: \"bg-gray-100 text-gray-800\",\n  medium: \"bg-blue-100 text-blue-800\",\n  high: \"bg-orange-100 text-orange-800\",\n  urgent: \"bg-red-100 text-red-800\",\n};\n\nexport default function TenantRequests() {\n  const [, navigate] = useLocation();\n\n  const { data: requests = [], isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/tenant/maintenance-requests\"],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-12 w-64\" />\n        <Skeleton className=\"h-32\" />\n        <Skeleton className=\"h-32\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button\n          variant=\"ghost\"\n          onClick={() => navigate(\"/tenant/home\")}\n          data-testid=\"button-back-home\"\n        >\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n          Back\n        </Button>\n        <div>\n          <h1 className=\"text-2xl font-bold\">My Maintenance Requests</h1>\n          <p className=\"text-muted-foreground text-sm\">\n            Track your submitted maintenance requests\n          </p>\n        </div>\n      </div>\n\n      {requests.length === 0 ? (\n        <Card>\n          <CardHeader>\n            <CardTitle>No Requests Yet</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-muted-foreground mb-4\">\n              You haven't submitted any maintenance requests yet.\n            </p>\n            <Button onClick={() => navigate(\"/tenant/maintenance\")} data-testid=\"button-new-request\">\n              <MessageSquare className=\"h-4 w-4 mr-2\" />\n              Get Help with an Issue\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          {requests.map((request) => (\n            <Card key={request.id} data-testid={`request-${request.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <CardTitle className=\"text-lg\">{request.title}</CardTitle>\n                    {request.description && (\n                      <p className=\"text-sm text-muted-foreground mt-2\">\n                        {request.description}\n                      </p>\n                    )}\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Badge className={statusColors[request.status] || \"\"}>\n                      {request.status}\n                    </Badge>\n                    <Badge className={priorityColors[request.priority] || \"\"}>\n                      {request.priority}\n                    </Badge>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {request.photoUrls && request.photoUrls.length > 0 && (\n                  <div className=\"flex gap-2 overflow-x-auto\">\n                    {request.photoUrls.map((url: string, index: number) => (\n                      <img\n                        key={index}\n                        src={url}\n                        alt={`Photo ${index + 1}`}\n                        className=\"h-24 w-24 object-cover rounded-lg\"\n                      />\n                    ))}\n                  </div>\n                )}\n                {request.aiSuggestedFixes && (\n                  <div className=\"p-3 bg-muted rounded-lg\">\n                    <div className=\"text-sm font-semibold mb-1\">AI Suggested Fixes:</div>\n                    <div className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                      {request.aiSuggestedFixes}\n                    </div>\n                  </div>\n                )}\n                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                  <span>\n                    Submitted: {format(new Date(request.createdAt), \"MMM dd, yyyy HH:mm\")}\n                  </span>\n                  {request.assignedTo && (\n                    <span>\n                      Assigned to maintenance team\n                    </span>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":4932},"client/src/pages/TenantHome.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Building2, Home, FileText, MessageSquare, Calendar, DollarSign, MapPin } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\n\nexport default function TenantHome() {\n  const [, navigate] = useLocation();\n  const locale = useLocale();\n\n  const { data: tenancyData, isLoading } = useQuery<any>({\n    queryKey: [\"/api/tenant/tenancy\"],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-12 w-64\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n          <Skeleton className=\"h-48\" />\n          <Skeleton className=\"h-48\" />\n          <Skeleton className=\"h-48\" />\n          <Skeleton className=\"h-48\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!tenancyData) {\n    return (\n      <div className=\"p-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>No Tenancy Found</CardTitle>\n            <CardDescription>\n              You don't have an active tenancy assigned. Please contact your property manager.\n            </CardDescription>\n          </CardHeader>\n        </Card>\n      </div>\n    );\n  }\n\n  const { tenancy, property, block } = tenancyData;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-welcome\">\n            Welcome Home\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Manage your property and maintenance requests\n          </p>\n        </div>\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <Card className=\"hover-elevate cursor-pointer\" onClick={() => navigate(\"/tenant/maintenance\")}>\n          <CardHeader className=\"flex flex-row items-center gap-4 space-y-0\">\n            <div className=\"p-3 bg-primary/10 rounded-lg\">\n              <MessageSquare className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-lg\">AI Maintenance Help</CardTitle>\n              <CardDescription>Get instant assistance with issues</CardDescription>\n            </div>\n          </CardHeader>\n        </Card>\n\n        <Card className=\"hover-elevate cursor-pointer\" onClick={() => navigate(\"/tenant/requests\")}>\n          <CardHeader className=\"flex flex-row items-center gap-4 space-y-0\">\n            <div className=\"p-3 bg-primary/10 rounded-lg\">\n              <FileText className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-lg\">My Requests</CardTitle>\n              <CardDescription>View your maintenance requests</CardDescription>\n            </div>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {/* Property Information */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        {/* Property Card */}\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <Home className=\"h-5 w-5 text-primary\" />\n              </div>\n              <CardTitle>Your Property</CardTitle>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <div className=\"text-sm text-muted-foreground\">Property Name</div>\n              <div className=\"font-semibold text-lg\" data-testid=\"text-property-name\">\n                {property?.name}\n              </div>\n            </div>\n            <div>\n              <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <MapPin className=\"h-4 w-4\" />\n                Address\n              </div>\n              <div className=\"font-medium\" data-testid=\"text-property-address\">\n                {property?.address}\n              </div>\n            </div>\n            {property?.sqft && (\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Square Footage</div>\n                <div className=\"font-medium\">{property.sqft.toLocaleString()} sq ft</div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Block Card (if property belongs to a block) */}\n        {block && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <Building2 className=\"h-5 w-5 text-primary\" />\n                </div>\n                <CardTitle>Building Complex</CardTitle>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Block Name</div>\n                <div className=\"font-semibold text-lg\" data-testid=\"text-block-name\">\n                  {block.name}\n                </div>\n              </div>\n              <div>\n                <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                  <MapPin className=\"h-4 w-4\" />\n                  Address\n                </div>\n                <div className=\"font-medium\" data-testid=\"text-block-address\">\n                  {block.address}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Tenancy Details */}\n        <Card className={block ? \"md:col-span-2\" : \"\"}>\n          <CardHeader>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <Calendar className=\"h-5 w-5 text-primary\" />\n              </div>\n              <CardTitle>Tenancy Details</CardTitle>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Lease Start</div>\n                <div className=\"font-semibold\" data-testid=\"text-lease-start\">\n                  {tenancy.leaseStartDate \n                    ? locale.formatDate(tenancy.leaseStartDate)\n                    : \"Not specified\"}\n                </div>\n              </div>\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Lease End</div>\n                <div className=\"font-semibold\" data-testid=\"text-lease-end\">\n                  {tenancy.leaseEndDate \n                    ? locale.formatDate(tenancy.leaseEndDate)\n                    : \"Not specified\"}\n                </div>\n              </div>\n              {tenancy.monthlyRent && (\n                <div>\n                  <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    Monthly Rent\n                  </div>\n                  <div className=\"font-semibold\" data-testid=\"text-monthly-rent\">\n                    {locale.currencySymbol}{parseFloat(tenancy.monthlyRent).toLocaleString()}\n                  </div>\n                </div>\n              )}\n              {tenancy.depositAmount && (\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Deposit</div>\n                  <div className=\"font-semibold\">\n                    {locale.currencySymbol}{parseFloat(tenancy.depositAmount).toLocaleString()}\n                  </div>\n                </div>\n              )}\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Status</div>\n                <Badge variant={tenancy.isActive ? \"default\" : \"secondary\"} data-testid=\"badge-tenancy-status\">\n                  {tenancy.isActive ? \"Active\" : \"Inactive\"}\n                </Badge>\n              </div>\n            </div>\n            {tenancy.notes && (\n              <div className=\"mt-6 p-4 bg-muted rounded-lg\">\n                <div className=\"text-sm text-muted-foreground mb-2\">Notes</div>\n                <div className=\"text-sm\">{tenancy.notes}</div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8467},"client/src/pages/TenantMaintenance.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Send, ImagePlus, Loader2, CheckCircle2, AlertCircle, MessageSquare, ArrowLeft } from \"lucide-react\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { useLocation } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface ChatMessage {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n  imageUrl?: string;\n  aiSuggestedFixes?: string;\n  createdAt: string;\n}\n\ninterface Chat {\n  id: string;\n  title: string;\n  status: string;\n  maintenanceRequestId?: string;\n  createdAt: string;\n  messages?: ChatMessage[];\n}\n\nexport default function TenantMaintenance() {\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const [selectedChatId, setSelectedChatId] = useState<string | null>(null);\n  const [messageInput, setMessageInput] = useState(\"\");\n  const [uploadedImage, setUploadedImage] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const { data: chats = [], isLoading: isLoadingChats } = useQuery<Chat[]>({\n    queryKey: [\"/api/tenant/maintenance-chats\"],\n  });\n\n  const { data: currentChat, isLoading: isLoadingChat } = useQuery<Chat>({\n    queryKey: [\"/api/tenant/maintenance-chats\", selectedChatId],\n    enabled: !!selectedChatId,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (data: { chatId?: string; message: string; imageUrl?: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/tenant/maintenance-chat/message\", data);\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant/maintenance-chats\"] });\n      if (selectedChatId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/tenant/maintenance-chats\", selectedChatId] });\n      }\n      setMessageInput(\"\");\n      setUploadedImage(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send message\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createMaintenanceMutation = useMutation({\n    mutationFn: async (chatId: string) => {\n      const res = await apiRequest(\"POST\", \"/api/tenant/maintenance-chat/create-request\", { chatId });\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Maintenance Request Created\",\n        description: \"Your maintenance request has been submitted to the property manager\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant/maintenance-chats\"] });\n      if (selectedChatId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/tenant/maintenance-chats\", selectedChatId] });\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create maintenance request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [currentChat?.messages]);\n\n  const handleSendMessage = async () => {\n    if (!messageInput.trim() && !uploadedImage) return;\n\n    const chatId = selectedChatId || undefined;\n    const newMessage = await sendMessageMutation.mutateAsync({\n      chatId,\n      message: messageInput,\n      imageUrl: uploadedImage || undefined,\n    });\n\n    if (!selectedChatId && newMessage.chatId) {\n      setSelectedChatId(newMessage.chatId);\n    }\n  };\n\n  const handleCreateRequest = () => {\n    if (!selectedChatId) return;\n    createMaintenanceMutation.mutate(selectedChatId);\n  };\n\n  if (isLoadingChats) {\n    return (\n      <div className=\"p-6\">\n        <Skeleton className=\"h-12 w-64 mb-6\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n          <Skeleton className=\"h-96\" />\n          <Skeleton className=\"h-96 md:col-span-2\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-[calc(100vh-4rem)] flex flex-col\">\n      {/* Header */}\n      <div className=\"p-6 border-b\">\n        <div className=\"flex items-center gap-4\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigate(\"/tenant/home\")}\n            data-testid=\"button-back-home\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <MessageSquare className=\"h-6 w-6 text-primary\" />\n              AI Maintenance Help\n            </h1>\n            <p className=\"text-muted-foreground text-sm\">\n              Get instant help with property issues\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 overflow-hidden\">\n        {/* Chat History Sidebar */}\n        <div className=\"border-r p-4 overflow-y-auto\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"font-semibold\">Conversations</h3>\n            <Button\n              size=\"sm\"\n              onClick={() => setSelectedChatId(null)}\n              data-testid=\"button-new-chat\"\n            >\n              New Chat\n            </Button>\n          </div>\n          <div className=\"space-y-2\">\n            {chats.map((chat) => (\n              <Card\n                key={chat.id}\n                className={`cursor-pointer hover-elevate ${\n                  selectedChatId === chat.id ? \"border-primary bg-primary/5\" : \"\"\n                }`}\n                onClick={() => setSelectedChatId(chat.id)}\n                data-testid={`chat-${chat.id}`}\n              >\n                <CardHeader className=\"p-4 space-y-2\">\n                  <CardTitle className=\"text-sm line-clamp-2\">{chat.title}</CardTitle>\n                  <div className=\"flex items-center justify-between\">\n                    <Badge variant={chat.status === \"active\" ? \"default\" : \"secondary\"} className=\"text-xs\">\n                      {chat.status}\n                    </Badge>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {format(new Date(chat.createdAt), \"MMM dd\")}\n                    </span>\n                  </div>\n                  {chat.maintenanceRequestId && (\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                      Request Created\n                    </Badge>\n                  )}\n                </CardHeader>\n              </Card>\n            ))}\n            {chats.length === 0 && (\n              <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                No conversations yet. Start a new chat to get help!\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* Chat Interface */}\n        <div className=\"md:col-span-2 flex flex-col\">\n          {/* Messages */}\n          <div className=\"flex-1 overflow-y-auto p-6 space-y-4\">\n            {!selectedChatId && !isLoadingChat && (\n              <div className=\"flex items-center justify-center h-full\">\n                <Card className=\"max-w-lg\">\n                  <CardHeader>\n                    <CardTitle>Welcome to AI Maintenance Help</CardTitle>\n                    <CardDescription>\n                      Describe your issue and upload a photo. Our AI will analyze it and suggest\n                      solutions. If the issue isn't resolved, you can create a maintenance request.\n                    </CardDescription>\n                  </CardHeader>\n                </Card>\n              </div>\n            )}\n\n            {isLoadingChat && <Skeleton className=\"h-32 w-full\" />}\n\n            {currentChat?.messages?.map((message) => (\n              <div\n                key={message.id}\n                className={`flex ${message.role === \"user\" ? \"justify-end\" : \"justify-start\"}`}\n              >\n                <div\n                  className={`max-w-[80%] rounded-lg p-4 ${\n                    message.role === \"user\"\n                      ? \"bg-primary text-primary-foreground\"\n                      : \"bg-muted\"\n                  }`}\n                >\n                  {message.imageUrl && (\n                    <img\n                      src={message.imageUrl}\n                      alt=\"Uploaded\"\n                      className=\"rounded-lg mb-2 max-w-full h-auto\"\n                    />\n                  )}\n                  <p className=\"whitespace-pre-wrap\">{message.content}</p>\n                  {message.aiSuggestedFixes && (\n                    <div className=\"mt-3 p-3 bg-background/20 rounded-lg\">\n                      <div className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                        <AlertCircle className=\"h-4 w-4\" />\n                        Suggested Fixes:\n                      </div>\n                      <p className=\"text-sm whitespace-pre-wrap\">{message.aiSuggestedFixes}</p>\n                    </div>\n                  )}\n                  <div className=\"text-xs opacity-70 mt-2\">\n                    {format(new Date(message.createdAt), \"HH:mm\")}\n                  </div>\n                </div>\n              </div>\n            ))}\n            <div ref={messagesEndRef} />\n          </div>\n\n          {/* Input Area */}\n          <div className=\"border-t p-4 space-y-4\">\n            {currentChat && !currentChat.maintenanceRequestId && (\n              <div className=\"flex justify-center\">\n                <Button\n                  onClick={handleCreateRequest}\n                  disabled={createMaintenanceMutation.isPending}\n                  variant=\"outline\"\n                  data-testid=\"button-create-request\"\n                >\n                  {createMaintenanceMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Issue Not Resolved - Create Maintenance Request\n                </Button>\n              </div>\n            )}\n\n            {uploadedImage && (\n              <div className=\"relative inline-block\">\n                <img src={uploadedImage} alt=\"Preview\" className=\"h-20 rounded-lg\" />\n                <Button\n                  size=\"sm\"\n                  variant=\"destructive\"\n                  className=\"absolute -top-2 -right-2\"\n                  onClick={() => setUploadedImage(null)}\n                >\n                  \n                </Button>\n              </div>\n            )}\n\n            <div className=\"flex gap-2\">\n              <ObjectUploader\n                onGetUploadParameters={async () => {\n                  const res = await apiRequest(\"POST\", \"/api/object-storage/upload-url\");\n                  const data = await res.json();\n                  return { method: \"PUT\" as const, url: data.uploadUrl };\n                }}\n                onComplete={(result) => {\n                  if (result.successful && result.successful[0]) {\n                    let uploadedUrl = result.successful[0].uploadURL;\n                    \n                    // Normalize URL: if absolute, extract pathname; if relative, use as is\n                    if (uploadedUrl && (uploadedUrl.startsWith('http://') || uploadedUrl.startsWith('https://'))) {\n                      try {\n                        const urlObj = new URL(uploadedUrl);\n                        uploadedUrl = urlObj.pathname;\n                      } catch (e) {\n                        console.error('[TenantMaintenance] Invalid upload URL:', uploadedUrl);\n                        toast({\n                          title: \"Upload Error\",\n                          description: \"Invalid file URL format. Please try again.\",\n                          variant: \"destructive\",\n                        });\n                        return;\n                      }\n                    }\n                    \n                    // Ensure it's a valid file path (should start with /objects/)\n                    if (!uploadedUrl || !uploadedUrl.startsWith('/objects/')) {\n                      console.error('[TenantMaintenance] Invalid file URL format:', uploadedUrl);\n                      toast({\n                        title: \"Upload Error\",\n                        description: \"Invalid file URL format. Please try again.\",\n                        variant: \"destructive\",\n                      });\n                      return;\n                    }\n                    \n                    // Convert to absolute URL for display\n                    const absoluteUrl = `${window.location.origin}${uploadedUrl}`;\n                    setUploadedImage(absoluteUrl);\n                    toast({\n                      title: \"Image Uploaded\",\n                      description: \"Your image has been uploaded successfully\",\n                    });\n                  }\n                }}\n              >\n                <Button variant=\"outline\" size=\"icon\" data-testid=\"button-upload-image\">\n                  <ImagePlus className=\"h-4 w-4\" />\n                </Button>\n              </ObjectUploader>\n              <Textarea\n                placeholder=\"Describe the issue...\"\n                value={messageInput}\n                onChange={(e) => setMessageInput(e.target.value)}\n                onKeyDown={(e) => {\n                  if (e.key === \"Enter\" && !e.shiftKey) {\n                    e.preventDefault();\n                    handleSendMessage();\n                  }\n                }}\n                className=\"flex-1 resize-none\"\n                rows={2}\n                data-testid=\"input-message\"\n              />\n              <Button\n                onClick={handleSendMessage}\n                disabled={sendMessageMutation.isPending || (!messageInput.trim() && !uploadedImage)}\n                data-testid=\"button-send-message\"\n              >\n                {sendMessageMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  <Send className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":14688},"QUICK_START.md":{"content":"# Quick Start - Database Setup\n\n##  Fastest Solution: Neon (2 minutes, FREE)\n\n1. **Go to https://neon.tech** and sign up (free account)\n\n2. **Create a new project:**\n   - Click \"Create Project\"\n   - Name it \"inspect360\" \n   - Choose a region\n   - Click \"Create Project\"\n\n3. **Copy your connection string:**\n   - After creating, you'll see a connection string like:\n     ```\n     postgresql://username:password@ep-xxxx-xxxx.us-east-2.aws.neon.tech/neondb?sslmode=require\n     ```\n   - Click the \"Copy\" button\n\n4. **Update your `.env` file:**\n   - Open `.env` in the project root\n   - Find the line: `DATABASE_URL=postgresql://user:password@host:port/database?sslmode=require`\n   - Replace it with your Neon connection string:\n     ```\n     DATABASE_URL=postgresql://username:password@ep-xxxx-xxxx.us-east-2.aws.neon.tech/neondb?sslmode=require\n     ```\n   - Save the file\n\n5. **Run migrations:**\n   ```powershell\n   npm run db:push\n   ```\n\n6. **Start the server:**\n   ```powershell\n   npm run dev\n   ```\n\n **Done!** Your database is ready.\n\n---\n\n## Alternative: Local PostgreSQL\n\nIf you prefer local setup:\n\n1. **Install PostgreSQL:**\n   - Download: https://www.postgresql.org/download/windows/\n   - Or use Chocolatey: `choco install postgresql`\n\n2. **Create database:**\n   ```powershell\n   # After installation, open psql and run:\n   CREATE DATABASE inspect360;\n   ```\n\n3. **Update `.env`:**\n   ```\n   DATABASE_URL=postgresql://postgres:yourpassword@localhost:5432/inspect360\n   ```\n\n4. **Run migrations and start:**\n   ```powershell\n   npm run db:push\n   npm run dev\n   ```\n\n","size_bytes":1582},"SETUP.md":{"content":"# Inspect360 Setup Guide\n\n## Quick Start\n\n### 1. Install Dependencies\n```bash\nnpm install\n```\n\n### 2. Set Up Environment Variables\n\nCreate a `.env` file in the root directory (copy from `.env.example`):\n\n```bash\n# Windows PowerShell\nCopy-Item .env.example .env\n```\n\n### 3. Configure Database\n\nYou have two options:\n\n#### Option A: Use Neon (Recommended for Development)\n1. Go to [https://neon.tech](https://neon.tech)\n2. Sign up for a free account\n3. Create a new project\n4. Copy the connection string (it looks like: `postgresql://user:password@host/database?sslmode=require`)\n5. Paste it into your `.env` file as `DATABASE_URL`\n\n#### Option B: Use Local PostgreSQL\n1. Install PostgreSQL locally\n2. Create a database: `createdb inspect360`\n3. Set `DATABASE_URL=postgresql://localhost:5432/inspect360`\n\n### 4. Generate Session Secret\n\nRun this command to generate a secure session secret:\n```bash\nnode -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\"\n```\n\nCopy the output and set it as `SESSION_SECRET` in your `.env` file.\n\n### 5. Set Up Other Environment Variables\n\nEdit your `.env` file and configure:\n\n- **DATABASE_URL**: Your PostgreSQL connection string (required)\n- **SESSION_SECRET**: Random secret for session management (required)\n- **RESEND_API_KEY**: Your Resend API key (optional, for email functionality)\n- **RESEND_FROM_EMAIL**: Email address to send emails from (optional, required if using email features)\n- **STRIPE_SECRET_KEY**: Your Stripe secret key (optional, for payments)\n- **STRIPE_WEBHOOK_SECRET**: Your Stripe webhook secret (optional)\n- **AI_INTEGRATIONS_OPENAI_BASE_URL**: OpenAI API base URL (optional, for AI features)\n- **AI_INTEGRATIONS_OPENAI_API_KEY**: OpenAI API key (optional, for AI features)\n- **LOCAL_STORAGE_DIR**: Directory for local file storage (optional, defaults to `./storage`)\n- **PUBLIC_OBJECT_SEARCH_PATHS**: Comma-separated paths for public object search (optional, defaults to `public`)\n- **PRIVATE_OBJECT_DIR**: Directory name for private objects (optional, defaults to `private`)\n- **PORT**: Server port (optional, defaults to 5000)\n\n### 6. Run Database Migrations\n\nPush the schema to your database:\n```bash\nnpm run db:push\n```\n\n### 7. Start Development Server\n\n```bash\nnpm run dev\n```\n\nThe application will be available at `http://localhost:5000` (or your configured PORT).\n\n## Troubleshooting\n\n### Error: \"DATABASE_URL must be set\"\n- Make sure you've created a `.env` file in the root directory\n- Verify that `DATABASE_URL` is set in the `.env` file\n- Check that the connection string is valid\n\n### Error: \"Connection refused\" or Database connection errors\n- Verify your `DATABASE_URL` is correct\n- Check that your database server is running\n- For Neon: Ensure your IP is allowed (Neon allows all IPs by default)\n- For local PostgreSQL: Check that the service is running\n\n### Error: \"Session secret required\"\n- Generate a session secret using the command above\n- Add it to your `.env` file as `SESSION_SECRET`\n\n### Error: \"RESEND_API_KEY environment variable is required\"\n- Sign up for a Resend account at [https://resend.com](https://resend.com)\n- Get your API key from the dashboard\n- Add `RESEND_API_KEY` and `RESEND_FROM_EMAIL` to your `.env` file\n\n### Error: File storage issues\n- Files are stored locally in the `storage` directory by default\n- You can customize the storage location by setting `LOCAL_STORAGE_DIR` in your `.env` file\n- Make sure the application has write permissions to the storage directory\n- The storage directory structure:\n  - `storage/public/` - Public files\n  - `storage/private/` - Private files (with ACL metadata)\n\n## Environment Variables Reference\n\n| Variable | Required | Description |\n|----------|----------|-------------|\n| `DATABASE_URL` |  Yes | PostgreSQL connection string |\n| `SESSION_SECRET` |  Yes | Secret key for session encryption |\n| `RESEND_API_KEY` |  No | Resend API key (for email functionality) |\n| `RESEND_FROM_EMAIL` |  No | Email address to send emails from (required if using email features) |\n| `STRIPE_SECRET_KEY` |  No | Stripe API secret key (for payments) |\n| `STRIPE_WEBHOOK_SECRET` |  No | Stripe webhook secret |\n| `AI_INTEGRATIONS_OPENAI_BASE_URL` |  No | OpenAI API base URL |\n| `AI_INTEGRATIONS_OPENAI_API_KEY` |  No | OpenAI API key |\n| `LOCAL_STORAGE_DIR` |  No | Directory for local file storage (default: `./storage`) |\n| `PUBLIC_OBJECT_SEARCH_PATHS` |  No | Comma-separated paths for public object search (default: `public`) |\n| `PRIVATE_OBJECT_DIR` |  No | Directory name for private objects (default: `private`) |\n| `PORT` |  No | Server port (default: 5000) |\n\n## Next Steps\n\nAfter setup:\n1. Register your first user account\n2. Create an organization\n3. Start creating properties and inspections!\n\nFor more information, see the main project documentation.\n\n","size_bytes":4845},"DATABASE_SETUP.md":{"content":"# Database Setup Guide\n\n##  Current Issue\nYour `DATABASE_URL` is set to a placeholder value. You need to set up a real PostgreSQL database.\n\n## Quick Setup Options\n\n### Option 1: Neon (Recommended - Free & Easy) \n\n**Neon is a serverless PostgreSQL that's perfect for development. It's free and takes 2 minutes to set up.**\n\n1. **Sign up at [https://neon.tech](https://neon.tech)**\n   - Click \"Sign Up\" (you can use GitHub, Google, or email)\n   - It's completely free for development\n\n2. **Create a new project**\n   - Click \"Create Project\"\n   - Choose a name (e.g., \"inspect360\")\n   - Select a region close to you\n   - Click \"Create Project\"\n\n3. **Get your connection string**\n   - After creating the project, you'll see a connection string like:\n     ```\n     postgresql://username:password@ep-xxxx-xxxx.us-east-2.aws.neon.tech/neondb?sslmode=require\n     ```\n   - Click \"Copy\" to copy the connection string\n\n4. **Update your `.env` file**\n   - Open `.env` in your project root\n   - Replace the placeholder `DATABASE_URL` with your Neon connection string:\n     ```\n     DATABASE_URL=postgresql://username:password@ep-xxxx-xxxx.us-east-2.aws.neon.tech/neondb?sslmode=require\n     ```\n\n5. **Run migrations**\n   ```bash\n   npm run db:push\n   ```\n\n6. **Start the server**\n   ```bash\n   npm run dev\n   ```\n\n **Done!** Your database is now set up.\n\n---\n\n### Option 2: Local PostgreSQL\n\nIf you prefer to run PostgreSQL locally:\n\n1. **Install PostgreSQL**\n   - Windows: Download from [https://www.postgresql.org/download/windows/](https://www.postgresql.org/download/windows/)\n   - Or use Chocolatey: `choco install postgresql`\n   - Or use Docker: `docker run --name postgres -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres`\n\n2. **Create a database**\n   ```bash\n   # Using psql command line\n   psql -U postgres\n   CREATE DATABASE inspect360;\n   \\q\n   ```\n\n3. **Update your `.env` file**\n   ```\n   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/inspect360\n   ```\n   *(Replace `postgres:postgres` with your actual PostgreSQL username and password)*\n\n4. **Run migrations**\n   ```bash\n   npm run db:push\n   ```\n\n5. **Start the server**\n   ```bash\n   npm run dev\n   ```\n\n---\n\n### Option 3: Docker PostgreSQL (Quick Local Setup)\n\nIf you have Docker installed:\n\n1. **Run PostgreSQL container**\n   ```bash\n   docker run --name inspect360-db -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=inspect360 -p 5432:5432 -d postgres:15\n   ```\n\n2. **Update your `.env` file**\n   ```\n   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/inspect360\n   ```\n\n3. **Run migrations**\n   ```bash\n   npm run db:push\n   ```\n\n4. **Start the server**\n   ```bash\n   npm run dev\n   ```\n\n---\n\n## Verification\n\nAfter setting up your database, verify it works:\n\n1. Check that your `.env` file has a real `DATABASE_URL` (not the placeholder)\n2. Run `npm run db:push` - this should complete without errors\n3. Run `npm run dev` - the server should start without database connection errors\n\n## Troubleshooting\n\n### Error: \"Invalid URL\"\n- Make sure your `DATABASE_URL` doesn't have the placeholder values\n- Check for extra spaces or quotes in the `.env` file\n- Ensure the connection string starts with `postgresql://`\n\n### Error: \"Connection refused\" or \"Connection timeout\"\n- **Neon**: Check that your IP is allowed (Neon allows all IPs by default)\n- **Local**: Make sure PostgreSQL is running (`pg_isready` or check services)\n- **Docker**: Make sure the container is running (`docker ps`)\n\n### Error: \"Database does not exist\"\n- For local PostgreSQL, make sure you created the database first\n- For Neon, the database is created automatically with your project\n\n### Error: \"Password authentication failed\"\n- Double-check your username and password in the connection string\n- For Neon, make sure you copied the full connection string including the password\n\n## Need Help?\n\n- **Neon Documentation**: [https://neon.tech/docs](https://neon.tech/docs)\n- **PostgreSQL Documentation**: [https://www.postgresql.org/docs/](https://www.postgresql.org/docs/)\n\n","size_bytes":4041},"fix-database-password.md":{"content":"# Fix PostgreSQL Password Authentication Error\n\n## Error: \"password authentication failed for user 'postgres'\"\n\nThis error means the password in your `DATABASE_URL` doesn't match your PostgreSQL `postgres` user password.\n\n## Solutions\n\n### Option 1: Update DATABASE_URL with Correct Password\n\n1. **Find out your PostgreSQL password:**\n   - Remember what password you set during PostgreSQL installation\n   - Or check if you're using the default (often empty or \"postgres\")\n\n2. **Update your `.env` file:**\n   ```env\n   DATABASE_URL=postgresql://postgres:YOUR_ACTUAL_PASSWORD@localhost:5432/inspect360\n   ```\n   Replace `YOUR_ACTUAL_PASSWORD` with your actual PostgreSQL password.\n\n3. **If password has special characters, URL-encode them:**\n   - `@`  `%40`\n   - `:`  `%3A`\n   - `/`  `%2F`\n\n### Option 2: Reset PostgreSQL Password\n\nIf you forgot your password, reset it:\n\n**Step 1: Edit PostgreSQL configuration to allow local connections without password**\n\n1. Find your PostgreSQL data directory (usually `C:\\Program Files\\PostgreSQL\\<version>\\data`)\n2. Edit `pg_hba.conf` file\n3. Find the line:\n   ```\n   host    all             all             127.0.0.1/32            scram-sha-256\n   ```\n4. Temporarily change it to:\n   ```\n   host    all             all             127.0.0.1/32            trust\n   ```\n5. Restart PostgreSQL service\n\n**Step 2: Connect and reset password**\n\n```powershell\n# Connect without password (now possible due to 'trust' setting)\npsql -U postgres\n\n# Reset password\nALTER USER postgres PASSWORD 'newpassword';\n\n# Exit\n\\q\n```\n\n**Step 3: Restore security**\n\n1. Edit `pg_hba.conf` again\n2. Change back to:\n   ```\n   host    all             all             127.0.0.1/32            scram-sha-256\n   ```\n3. Restart PostgreSQL service\n\n**Step 4: Update DATABASE_URL**\n\n```env\nDATABASE_URL=postgresql://postgres:newpassword@localhost:5432/inspect360\n```\n\n### Option 3: Use pgAdmin to Reset Password\n\n1. Open **pgAdmin**\n2. Connect to your PostgreSQL server\n3. Right-click on `postgres` user  Properties\n4. Go to \"Definition\" tab\n5. Enter new password  Save\n6. Update your `.env` file with the new password\n\n### Option 4: Create a New User (Recommended for Development)\n\nInstead of using the `postgres` superuser, create a dedicated user:\n\n```powershell\n# Connect as postgres user\npsql -U postgres\n\n# Create new user and database\nCREATE USER inspect360_user WITH PASSWORD 'inspect360_pass';\nCREATE DATABASE inspect360 OWNER inspect360_user;\nGRANT ALL PRIVILEGES ON DATABASE inspect360 TO inspect360_user;\n\n# Exit\n\\q\n```\n\nThen update your `.env`:\n```env\nDATABASE_URL=postgresql://inspect360_user:inspect360_pass@localhost:5432/inspect360\n```\n\n### Quick Test\n\nTest your connection string:\n\n```powershell\n# Replace with your actual connection string\npsql \"postgresql://postgres:yourpassword@localhost:5432/inspect360\"\n```\n\nIf it connects without errors, the password is correct!\n\n","size_bytes":2909},"DATABASE_CONNECTION_TROUBLESHOOTING.md":{"content":"# Database Connection Troubleshooting\n\n## Error: \"SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string\"\n\nThis error means PostgreSQL is not receiving a valid password string. Common causes:\n\n### 1. Password Contains Special Characters\n\nIf your PostgreSQL password contains special characters like `@`, `:`, `/`, `#`, `%`, you need to **URL-encode** them in the connection string.\n\n**Special Characters and Their URL Encoding:**\n- `@`  `%40`\n- `:`  `%3A`\n- `/`  `%2F`\n- `#`  `%23`\n- `%`  `%25`\n- `&`  `%26`\n- `?`  `%3F`\n- `=`  `%3D`\n- ` ` (space)  `%20`\n\n**Example:**\nIf your password is `my@pass:word`, use:\n```\nDATABASE_URL=postgresql://postgres:my%40pass%3Aword@localhost:5432/inspect360\n```\n\n### 2. Check Your .env File Format\n\nMake sure your `.env` file has the correct format (no quotes needed):\n\n```env\nDATABASE_URL=postgresql://username:password@host:port/database\n```\n\n**Common Mistakes:**\n-  `DATABASE_URL=\"postgresql://...\"` (quotes can cause issues)\n-  `DATABASE_URL= postgresql://...` (leading space)\n-  `DATABASE_URL=postgresql://... ` (trailing space)\n-  `DATABASE_URL=postgresql://username:password@localhost:5432/inspect360`\n\n### 3. Verify Connection String Format\n\nYour connection string should follow this format:\n```\npostgresql://[username]:[password]@[host]:[port]/[database]\n```\n\n**Local PostgreSQL Example:**\n```\npostgresql://postgres:mypassword@localhost:5432/inspect360\n```\n\n### 4. Test Your Connection String\n\nYou can test your connection string using `psql`:\n\n```powershell\n# Test the connection\npsql \"postgresql://postgres:password@localhost:5432/inspect360\"\n```\n\n### 5. Check PostgreSQL is Running\n\nMake sure PostgreSQL is running:\n\n**Windows:**\n```powershell\nGet-Service -Name \"*postgres*\"\n```\n\n**Or check if the port is listening:**\n```powershell\nnetstat -an | findstr 5432\n```\n\n### 6. Password Reset (If Needed)\n\nIf you forgot your PostgreSQL password:\n\n```powershell\n# Connect to PostgreSQL as superuser\npsql -U postgres\n\n# Change password\nALTER USER postgres PASSWORD 'newpassword';\n\n# Exit\n\\q\n```\n\n### 7. URL Encode Your Password Online\n\nIf your password has special characters, use an online URL encoder:\n- Go to https://www.urlencoder.org/\n- Enter your password\n- Copy the encoded version\n- Replace the password in your DATABASE_URL\n\n### Quick Fix Steps\n\n1. **Check your `.env` file:**\n   - Open `.env` in your project root\n   - Find the `DATABASE_URL` line\n   - Ensure no quotes, no extra spaces\n   - Verify the format: `postgresql://user:pass@host:port/db`\n\n2. **URL-encode special characters:**\n   - If password has `@`, `:`, `/`, etc., encode them\n\n3. **Restart your server:**\n   ```powershell\n   npm run dev\n   ```\n\n4. **Test connection:**\n   - The server should connect on startup\n   - If errors persist, check the exact error message\n\n### Example Connection Strings\n\n**Simple password (no special chars):**\n```\nDATABASE_URL=postgresql://postgres:postgres123@localhost:5432/inspect360\n```\n\n**Password with special characters (encoded):**\n```\nDATABASE_URL=postgresql://postgres:p%40ssw%3Aord@localhost:5432/inspect360\n```\n\n**With SSL:**\n```\nDATABASE_URL=postgresql://postgres:password@localhost:5432/inspect360?sslmode=require\n```\n\n","size_bytes":3226},"LOCAL_POSTGRES_SETUP.md":{"content":"# Local PostgreSQL Setup Guide\n\nYour code is now configured to use a standard local PostgreSQL database (not Neon).\n\n## Quick Setup Steps\n\n### 1. Install PostgreSQL (if not already installed)\n\n**Windows:**\n- Download from: https://www.postgresql.org/download/windows/\n- Or use Chocolatey: `choco install postgresql`\n- During installation, remember the password you set for the `postgres` user\n\n### 2. Create the Database\n\nOpen a terminal and run:\n\n```powershell\n# Connect to PostgreSQL (replace 'postgres' with your password if different)\npsql -U postgres\n\n# Create the database\nCREATE DATABASE inspect360;\n\n# Exit psql\n\\q\n```\n\n**Alternative using pgAdmin:**\n1. Open pgAdmin\n2. Connect to your PostgreSQL server\n3. Right-click \"Databases\"  \"Create\"  \"Database\"\n4. Name it `inspect360`\n5. Click \"Save\"\n\n### 3. Update Your `.env` File\n\nOpen `.env` in your project root and update the `DATABASE_URL`:\n\n```\nDATABASE_URL=postgresql://postgres:yourpassword@localhost:5432/inspect360\n```\n\n**Replace:**\n- `postgres` (first occurrence) - your PostgreSQL username (usually `postgres`)\n- `yourpassword` - your PostgreSQL password\n- `inspect360` - database name (use what you created in step 2)\n\n**Example:**\n```\nDATABASE_URL=postgresql://postgres:mypassword@localhost:5432/inspect360\n```\n\n### 4. Run Database Migrations\n\n```powershell\nnpm run db:push\n```\n\nThis will create all the necessary tables in your database.\n\n### 5. Start the Server\n\n```powershell\nnpm run dev\n```\n\n **Done!** Your local PostgreSQL database is ready.\n\n## Troubleshooting\n\n### Error: \"psql: command not found\"\n- Make sure PostgreSQL is installed\n- Add PostgreSQL's `bin` directory to your PATH\n- Default location: `C:\\Program Files\\PostgreSQL\\<version>\\bin`\n\n### Error: \"password authentication failed\"\n- Double-check your password in the DATABASE_URL\n- Try resetting the postgres user password in pgAdmin\n\n### Error: \"database does not exist\"\n- Make sure you created the database (step 2)\n- Check the database name in your DATABASE_URL matches what you created\n\n### Error: \"connection refused\" or \"connection timeout\"\n- Make sure PostgreSQL service is running\n- Check if it's running on port 5432 (default)\n- Try: `netstat -an | findstr 5432` to verify the port is open\n\n## Using Docker (Alternative)\n\nIf you have Docker installed:\n\n```powershell\n# Run PostgreSQL container\ndocker run --name inspect360-db -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=inspect360 -p 5432:5432 -d postgres:15\n\n# Update .env\nDATABASE_URL=postgresql://postgres:postgres@localhost:5432/inspect360\n\n# Run migrations\nnpm run db:push\n\n# Start server\nnpm run dev\n```\n\n","size_bytes":2614},"server/stripeClient.ts":{"content":"import Stripe from 'stripe';\n\nlet connectionSettings: any;\nlet cachedCredentials: { publishableKey: string; secretKey: string } | null = null;\nlet credentialsCacheExpiry: number = 0;\nconst CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\nasync function getCredentials() {\n  // Return cached credentials if still valid\n  if (cachedCredentials && Date.now() < credentialsCacheExpiry) {\n    return cachedCredentials;\n  }\n\n  // Check for environment variables first (for non-Replit deployments)\n  const secretKey = process.env.STRIPE_SECRET_KEY?.trim();\n  const publishableKey = process.env.STRIPE_PUBLISHABLE_KEY?.trim();\n  \n  if (secretKey && publishableKey) {\n    console.log('[Stripe] Using environment variables for Stripe credentials');\n    cachedCredentials = {\n      publishableKey: publishableKey,\n      secretKey: secretKey,\n    };\n    credentialsCacheExpiry = Date.now() + CACHE_TTL_MS;\n    return cachedCredentials;\n  } else {\n    console.warn('[Stripe] Missing Stripe credentials:', {\n      hasSecretKey: !!secretKey,\n      hasPublishableKey: !!publishableKey\n    });\n  }\n\n  // Fallback to Replit connector (if available)\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY\n    ? 'repl ' + process.env.REPL_IDENTITY\n    : process.env.WEB_REPL_RENEWAL\n      ? 'depl ' + process.env.WEB_REPL_RENEWAL\n      : null;\n\n  if (!xReplitToken || !hostname) {\n    throw new Error('Stripe credentials not configured. Set STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY environment variables.');\n  }\n\n  // Use stripe connector for all environments\n  // The environment field in the connection will distinguish between development and production\n  const connectorName = 'stripe';\n\n  // Determine which environment to use based on deployment status\n  const isProduction = process.env.REPLIT_DEPLOYMENT === '1';\n  const targetEnvironment = isProduction ? 'production' : 'development';\n\n  const url = new URL(`https://${hostname}/api/v2/connection`);\n  url.searchParams.set('include_secrets', 'true');\n  url.searchParams.set('connector_names', connectorName);\n  url.searchParams.set('environment', targetEnvironment);\n\n  const response = await fetch(url.toString(), {\n    headers: {\n      'Accept': 'application/json',\n      'X_REPLIT_TOKEN': xReplitToken\n    }\n  });\n\n  const data = await response.json();\n  \n  connectionSettings = data.items?.[0];\n\n  if (!connectionSettings || (!connectionSettings.settings.publishable || !connectionSettings.settings.secret)) {\n    throw new Error(`Stripe ${targetEnvironment} connection not found`);\n  }\n\n  // Cache the credentials\n  cachedCredentials = {\n    publishableKey: connectionSettings.settings.publishable,\n    secretKey: connectionSettings.settings.secret,\n  };\n  credentialsCacheExpiry = Date.now() + CACHE_TTL_MS;\n\n  return cachedCredentials;\n}\n\n// WARNING: Never cache this client.\n// Always call this function again to get a fresh client.\n// Use getUncachableStripeClient() for server-side operations with secret key\nexport async function getUncachableStripeClient() {\n  const { secretKey } = await getCredentials();\n\n  return new Stripe(secretKey, {\n    // Note that this is the latest API version, don't change it to a old version of the\n    // API.\n    apiVersion: '2025-10-29.clover',\n  });\n}\n\n// Use getStripePublishableKey() for client-side operations\nexport async function getStripePublishableKey() {\n  const { publishableKey } = await getCredentials();\n\n  return publishableKey;\n}\n\n// Use getStripeSecretKey() for server-side operations requiring the secret key\nexport async function getStripeSecretKey() {\n  const { secretKey } = await getCredentials();\n  return secretKey;\n}\n","size_bytes":3678},"server/seedEcoAdmin.ts":{"content":"import \"dotenv/config\";\nimport { db } from \"./db\";\nimport { plans, creditBundles } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nasync function seedEcoAdmin() {\n  console.log(\" Seeding Eco Admin data...\");\n\n  try {\n    // Seed Subscription Plans\n    console.log(\" Seeding subscription plans...\");\n    \n    const planData = [\n      {\n        code: \"starter\" as const,\n        name: \"Starter Plan\",\n        monthlyPriceGbp: 4900, // 49.00\n        annualPriceGbp: 52920, // 529.20 (10% discount: 49 * 12 * 0.9)\n        includedCredits: 50,\n        softCap: 5000,\n        isCustom: false,\n        isActive: true,\n      },\n      {\n        code: \"professional\" as const,\n        name: \"Professional Plan\",\n        monthlyPriceGbp: 14900, // 149.00\n        annualPriceGbp: 160920, // 1,609.20 (10% discount: 149 * 12 * 0.9)\n        includedCredits: 200,\n        softCap: 5000,\n        isCustom: false,\n        isActive: true,\n      },\n      {\n        code: \"enterprise\" as const,\n        name: \"Enterprise Plan\",\n        monthlyPriceGbp: 34900, // 349.00\n        annualPriceGbp: 376920, // 3,769.20 (10% discount: 349 * 12 * 0.9)\n        includedCredits: 500,\n        softCap: 5000,\n        isCustom: false,\n        isActive: true,\n      },\n      {\n        code: \"enterprise_plus\" as const,\n        name: \"Enterprise+ Plan\",\n        monthlyPriceGbp: 99900, // 999.00 (custom pricing)\n        annualPriceGbp: null, // No annual pricing for custom plans\n        includedCredits: 2000,\n        softCap: 10000,\n        isCustom: true,\n        isActive: true,\n      },\n    ];\n\n    for (const plan of planData) {\n      // Check if plan exists\n      const existing = await db.select().from(plans).where(eq(plans.code, plan.code));\n      \n      if (existing.length === 0) {\n        await db.insert(plans).values(plan);\n        console.log(` Created plan: ${plan.name}`);\n      } else {\n        // Always update existing plan to ensure it matches seed data\n        const [existingPlan] = existing;\n        const updates: any = {};\n        \n        // Always update annual price if seed data has it (for non-custom plans)\n        if (plan.annualPriceGbp !== null && existingPlan.annualPriceGbp !== plan.annualPriceGbp) {\n          updates.annualPriceGbp = plan.annualPriceGbp;\n        } else if (plan.annualPriceGbp === null && existingPlan.annualPriceGbp !== null) {\n          // If seed data says null (for custom plans), ensure it's null\n          updates.annualPriceGbp = null;\n        }\n        \n        // Also ensure other fields are up to date\n        if (existingPlan.monthlyPriceGbp !== plan.monthlyPriceGbp) {\n          updates.monthlyPriceGbp = plan.monthlyPriceGbp;\n        }\n        if (existingPlan.includedCredits !== plan.includedCredits) {\n          updates.includedCredits = plan.includedCredits;\n        }\n        if (existingPlan.isActive !== plan.isActive) {\n          updates.isActive = plan.isActive;\n        }\n        \n        if (Object.keys(updates).length > 0) {\n          await db.update(plans)\n            .set(updates)\n            .where(eq(plans.id, existingPlan.id));\n          console.log(` Updated plan: ${plan.name} - Updated: ${Object.keys(updates).join(', ')}`);\n        } else {\n          console.log(`  Plan already exists and matches seed data: ${plan.name}`);\n        }\n      }\n    }\n\n    // Seed Credit Bundles (optional - skip if table doesn't exist)\n    try {\n      console.log(\"\\n Seeding credit bundles...\");\n      \n      const bundleData = [\n        {\n          name: \"100 Credits Pack\",\n          credits: 100,\n          priceGbp: 40000, // 400 = 4.00 per credit\n          priceUsd: 52000, // $520 = $5.20 per credit\n          priceAed: 190000, // AED 1,900 = AED 19.00 per credit\n          sortOrder: 0,\n          isPopular: false,\n          discountLabel: null,\n          isActive: true,\n        },\n        {\n          name: \"250 Credits Pack\",\n          credits: 250,\n          priceGbp: 75000, // 750 = 3.00 per credit\n          priceUsd: 97500, // $975 = $3.90 per credit\n          priceAed: 360000, // AED 3,600 = AED 14.40 per credit\n          sortOrder: 1,\n          isPopular: true,\n          discountLabel: \"Best Value\",\n          isActive: true,\n        },\n        {\n          name: \"500 Credits Pack\",\n          credits: 500,\n          priceGbp: 100000, // 1,000 = 2.00 per credit\n          priceUsd: 130000, // $1,300 = $2.60 per credit\n          priceAed: 480000, // AED 4,800 = AED 9.60 per credit\n          sortOrder: 2,\n          isPopular: false,\n          discountLabel: \"Save 50%\",\n          isActive: true,\n        },\n        {\n          name: \"1000 Credits Pack\",\n          credits: 1000,\n          priceGbp: 150000, // 1,500 = 1.50 per credit\n          priceUsd: 195000, // $1,950 = $1.95 per credit\n          priceAed: 720000, // AED 7,200 = AED 7.20 per credit\n          sortOrder: 3,\n          isPopular: false,\n          discountLabel: \"Enterprise Value\",\n          isActive: true,\n        },\n      ];\n\n      for (const bundle of bundleData) {\n        // Check if bundle exists by name and credits\n        const existing = await db\n          .select()\n          .from(creditBundles)\n          .where(eq(creditBundles.name, bundle.name));\n        \n        if (existing.length === 0) {\n          await db.insert(creditBundles).values(bundle);\n          console.log(` Created bundle: ${bundle.name}`);\n        } else {\n          console.log(`  Bundle already exists: ${bundle.name}`);\n        }\n      }\n    } catch (bundleError: any) {\n      // Credit bundles table might not exist yet - that's okay\n      if (bundleError.code === '42P01') {\n        console.log(`  Credit bundles table doesn't exist yet - skipping bundle seeding`);\n      } else {\n        throw bundleError; // Re-throw if it's a different error\n      }\n    }\n\n    console.log(\"\\n Eco Admin seeding completed successfully!\");\n  } catch (error) {\n    console.error(\" Error seeding Eco Admin data:\", error);\n    throw error;\n  }\n}\n\n// Run the seed function\nseedEcoAdmin()\n  .then(() => {\n    console.log(\" Done!\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\" Fatal error:\", error);\n    process.exit(1);\n  });\n","size_bytes":6255},"client/src/pages/EcoAdmin.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Plus, Edit, Trash2, Save, X, Package, CreditCard, Globe, Loader2 } from \"lucide-react\";\nimport type { Plan, CreditBundle, CountryPricingOverride } from \"@shared/schema\";\n\nexport default function EcoAdmin() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"plans\");\n  const [, navigate] = useLocation();\n\n  // Fetch admin user for authentication\n  const { data: adminUser, isLoading: isLoadingAdmin } = useQuery({\n    queryKey: [\"/api/admin/me\"],\n    retry: false,\n  });\n\n  // Show loading state while checking authentication\n  if (isLoadingAdmin) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Loader2 className=\"animate-spin h-12 w-12 text-primary mx-auto mb-4\" />\n          <p className=\"text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Redirect to login if not authenticated\n  if (!adminUser) {\n    navigate(\"/admin/login\");\n    return null;\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold mb-2\" data-testid=\"text-title\">Eco Admin Dashboard</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">\n          Manage subscription plans, credit bundles, and multi-currency pricing\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"plans\" data-testid=\"tab-plans\">\n            <Package className=\"h-4 w-4 mr-2\" />\n            Subscription Plans\n          </TabsTrigger>\n          <TabsTrigger value=\"bundles\" data-testid=\"tab-bundles\">\n            <CreditCard className=\"h-4 w-4 mr-2\" />\n            Credit Bundles\n          </TabsTrigger>\n          <TabsTrigger value=\"pricing\" data-testid=\"tab-pricing\">\n            <Globe className=\"h-4 w-4 mr-2\" />\n            Multi-Currency Pricing\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"plans\" className=\"mt-6\">\n          <PlansManagement />\n        </TabsContent>\n\n        <TabsContent value=\"bundles\" className=\"mt-6\">\n          <BundlesManagement />\n        </TabsContent>\n\n        <TabsContent value=\"pricing\" className=\"mt-6\">\n          <CountryPricingManagement />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction PlansManagement() {\n  const { toast } = useToast();\n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [formData, setFormData] = useState<Partial<Plan>>({});\n\n  const { data: plans, isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/admin/plans\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: Partial<Plan>) => {\n      return await apiRequest(\"/api/admin/plans\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/plans\"] });\n      toast({ title: \"Plan created successfully\" });\n      setFormData({});\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Failed to create plan\", \n        description: error.message || \"Invalid data provided\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Plan> }) => {\n      return await apiRequest(`/api/admin/plans/${id}`, \"PATCH\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/plans\"] });\n      toast({ title: \"Plan updated successfully\" });\n      setEditingId(null);\n      setFormData({});\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Failed to update plan\", \n        description: error.message || \"Invalid data provided\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const handleSave = () => {\n    if (!formData.code || !formData.name || !formData.monthlyPriceGbp || !formData.includedCredits) {\n      toast({ title: \"Please fill all required fields\", variant: \"destructive\" });\n      return;\n    }\n\n    // Build clean payload - strip read-only fields\n    const payload = {\n      code: formData.code,\n      name: formData.name,\n      monthlyPriceGbp: formData.monthlyPriceGbp,\n      annualPriceGbp: formData.annualPriceGbp || null,\n      includedCredits: formData.includedCredits,\n      softCap: formData.softCap || 5000,\n      isCustom: formData.isCustom || false,\n      isActive: formData.isActive !== undefined ? formData.isActive : true,\n    };\n\n    if (editingId) {\n      updateMutation.mutate({ id: editingId, data: payload });\n    } else {\n      createMutation.mutate(payload);\n    }\n  };\n\n  const startEdit = (plan: Plan) => {\n    setEditingId(plan.id);\n    setFormData(plan);\n  };\n\n  if (isLoading) {\n    return <div>Loading plans...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            {editingId ? \"Edit Plan\" : \"Create New Plan\"}\n          </CardTitle>\n          <CardDescription>\n            Configure subscription plan details and pricing (GBP base currency)\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"code\">Plan Code</Label>\n              <Input\n                id=\"code\"\n                value={formData.code || \"\"}\n                onChange={(e) => setFormData({ ...formData, code: e.target.value as any })}\n                placeholder=\"starter, professional, etc.\"\n                data-testid=\"input-plan-code\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Plan Name</Label>\n              <Input\n                id=\"name\"\n                value={formData.name || \"\"}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"Starter Plan\"\n                data-testid=\"input-plan-name\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4 mb-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price\">Monthly Price (GBP Pence)</Label>\n              <Input\n                id=\"price\"\n                type=\"number\"\n                value={formData.monthlyPriceGbp || \"\"}\n                onChange={(e) => setFormData({ ...formData, monthlyPriceGbp: parseInt(e.target.value) })}\n                placeholder=\"4900 = 49.00\"\n                data-testid=\"input-monthly-price\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"annual-price\">Annual Price (GBP Pence - Optional)</Label>\n              <Input\n                id=\"annual-price\"\n                type=\"number\"\n                value={formData.annualPriceGbp || \"\"}\n                onChange={(e) => setFormData({ ...formData, annualPriceGbp: parseInt(e.target.value) || null })}\n                placeholder=\"52920 = 529.20 (save 10%)\"\n                data-testid=\"input-annual-price\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"credits\">Included Credits</Label>\n              <Input\n                id=\"credits\"\n                type=\"number\"\n                value={formData.includedCredits || \"\"}\n                onChange={(e) => setFormData({ ...formData, includedCredits: parseInt(e.target.value) })}\n                placeholder=\"50\"\n                data-testid=\"input-included-credits\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"softCap\">Soft Cap (Fair Usage)</Label>\n              <Input\n                id=\"softCap\"\n                type=\"number\"\n                value={formData.softCap || 5000}\n                onChange={(e) => setFormData({ ...formData, softCap: parseInt(e.target.value) })}\n                placeholder=\"5000\"\n                data-testid=\"input-soft-cap\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex items-center space-x-4\">\n            <label className=\"flex items-center space-x-2\">\n              <input\n                type=\"checkbox\"\n                checked={formData.isActive ?? true}\n                onChange={(e) => setFormData({ ...formData, isActive: e.target.checked })}\n                data-testid=\"checkbox-active\"\n              />\n              <span>Active</span>\n            </label>\n            <label className=\"flex items-center space-x-2\">\n              <input\n                type=\"checkbox\"\n                checked={formData.isCustom ?? false}\n                onChange={(e) => setFormData({ ...formData, isCustom: e.target.checked })}\n                data-testid=\"checkbox-custom\"\n              />\n              <span>Custom Plan</span>\n            </label>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button onClick={handleSave} data-testid=\"button-save-plan\">\n              <Save className=\"h-4 w-4 mr-2\" />\n              {editingId ? \"Update Plan\" : \"Create Plan\"}\n            </Button>\n            {editingId && (\n              <Button variant=\"outline\" onClick={() => {\n                setEditingId(null);\n                setFormData({});\n              }} data-testid=\"button-cancel-edit\">\n                <X className=\"h-4 w-4 mr-2\" />\n                Cancel\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Existing Plans</CardTitle>\n          <CardDescription>All subscription plans in the system</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {plans && plans.length > 0 ? (\n              plans.map((plan) => (\n                <div key={plan.id} className=\"flex items-center justify-between p-4 border rounded-lg\" data-testid={`card-plan-${plan.id}`}>\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-semibold\" data-testid={`text-plan-name-${plan.id}`}>{plan.name}</h3>\n                      <Badge variant=\"outline\" data-testid={`badge-plan-code-${plan.id}`}>{plan.code}</Badge>\n                      {plan.isActive && <Badge data-testid={`badge-active-${plan.id}`}>Active</Badge>}\n                      {plan.isCustom && <Badge variant=\"secondary\" data-testid={`badge-custom-${plan.id}`}>Custom</Badge>}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid={`text-plan-details-${plan.id}`}>\n                      {(plan.monthlyPriceGbp / 100).toFixed(2)}/month  {plan.includedCredits} credits  Soft Cap: {plan.softCap}\n                    </p>\n                  </div>\n                  <Button size=\"sm\" variant=\"outline\" onClick={() => startEdit(plan)} data-testid={`button-edit-plan-${plan.id}`}>\n                    <Edit className=\"h-4 w-4 mr-2\" />\n                    Edit\n                  </Button>\n                </div>\n              ))\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\" data-testid=\"text-no-plans\">No plans created yet</p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction BundlesManagement() {\n  const { toast } = useToast();\n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [formData, setFormData] = useState<Partial<CreditBundle>>({});\n\n  const { data: bundles, isLoading } = useQuery<CreditBundle[]>({\n    queryKey: [\"/api/admin/bundles\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: Partial<CreditBundle>) => {\n      return await apiRequest(\"/api/admin/bundles\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/bundles\"] });\n      toast({ title: \"Bundle created successfully\" });\n      setFormData({});\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Failed to create bundle\", \n        description: error.message || \"Invalid data provided\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<CreditBundle> }) => {\n      return await apiRequest(`/api/admin/bundles/${id}`, \"PATCH\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/bundles\"] });\n      toast({ title: \"Bundle updated successfully\" });\n      setEditingId(null);\n      setFormData({});\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Failed to update bundle\", \n        description: error.message || \"Invalid data provided\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/admin/bundles/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/bundles\"] });\n      toast({ title: \"Bundle deleted successfully\" });\n    },\n  });\n\n  const handleSave = () => {\n    if (!formData.name || !formData.credits || !formData.priceGbp || !formData.priceUsd || !formData.priceAed) {\n      toast({ title: \"Please fill all required fields\", variant: \"destructive\" });\n      return;\n    }\n\n    // Build clean payload - strip read-only fields\n    const payload = {\n      name: formData.name,\n      credits: formData.credits,\n      priceGbp: formData.priceGbp,\n      priceUsd: formData.priceUsd,\n      priceAed: formData.priceAed,\n      sortOrder: formData.sortOrder || 0,\n      isPopular: formData.isPopular || false,\n      discountLabel: formData.discountLabel || null,\n      isActive: formData.isActive !== undefined ? formData.isActive : true,\n    };\n\n    if (editingId) {\n      updateMutation.mutate({ id: editingId, data: payload });\n    } else {\n      createMutation.mutate(payload);\n    }\n  };\n\n  const startEdit = (bundle: CreditBundle) => {\n    setEditingId(bundle.id);\n    setFormData(bundle);\n  };\n\n  if (isLoading) {\n    return <div>Loading bundles...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            {editingId ? \"Edit Credit Bundle\" : \"Create New Credit Bundle\"}\n          </CardTitle>\n          <CardDescription>\n            Configure add-on credit packages with multi-currency pricing\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"bundle-name\">Bundle Name</Label>\n              <Input\n                id=\"bundle-name\"\n                value={formData.name || \"\"}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"100 Credits Pack\"\n                data-testid=\"input-bundle-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"bundle-credits\">Credits</Label>\n              <Input\n                id=\"bundle-credits\"\n                type=\"number\"\n                value={formData.credits || \"\"}\n                onChange={(e) => setFormData({ ...formData, credits: parseInt(e.target.value) })}\n                placeholder=\"100\"\n                data-testid=\"input-bundle-credits\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price-gbp\">Price (GBP Pence)</Label>\n              <Input\n                id=\"price-gbp\"\n                type=\"number\"\n                value={formData.priceGbp || \"\"}\n                onChange={(e) => setFormData({ ...formData, priceGbp: parseInt(e.target.value) })}\n                placeholder=\"40000 = 400\"\n                data-testid=\"input-price-gbp\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {formData.priceGbp && formData.credits \n                  ? `${(formData.priceGbp / 100 / formData.credits).toFixed(2)} per credit`\n                  : \"\"}\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price-usd\">Price (USD Cents)</Label>\n              <Input\n                id=\"price-usd\"\n                type=\"number\"\n                value={formData.priceUsd || \"\"}\n                onChange={(e) => setFormData({ ...formData, priceUsd: parseInt(e.target.value) })}\n                placeholder=\"50000 = $500\"\n                data-testid=\"input-price-usd\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {formData.priceUsd && formData.credits \n                  ? `$${(formData.priceUsd / 100 / formData.credits).toFixed(2)} per credit`\n                  : \"\"}\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price-aed\">Price (AED Fils)</Label>\n              <Input\n                id=\"price-aed\"\n                type=\"number\"\n                value={formData.priceAed || \"\"}\n                onChange={(e) => setFormData({ ...formData, priceAed: parseInt(e.target.value) })}\n                placeholder=\"180000 = AED 1800\"\n                data-testid=\"input-price-aed\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {formData.priceAed && formData.credits \n                  ? `AED ${(formData.priceAed / 100 / formData.credits).toFixed(2)} per credit`\n                  : \"\"}\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"sort-order\">Sort Order</Label>\n              <Input\n                id=\"sort-order\"\n                type=\"number\"\n                value={formData.sortOrder || 0}\n                onChange={(e) => setFormData({ ...formData, sortOrder: parseInt(e.target.value) })}\n                placeholder=\"0\"\n                data-testid=\"input-sort-order\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"discount-label\">Discount Label (optional)</Label>\n              <Input\n                id=\"discount-label\"\n                value={formData.discountLabel || \"\"}\n                onChange={(e) => setFormData({ ...formData, discountLabel: e.target.value || null })}\n                placeholder=\"Best Value\"\n                data-testid=\"input-discount-label\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex items-center space-x-4\">\n            <label className=\"flex items-center space-x-2\">\n              <input\n                type=\"checkbox\"\n                checked={formData.isActive ?? true}\n                onChange={(e) => setFormData({ ...formData, isActive: e.target.checked })}\n                data-testid=\"checkbox-bundle-active\"\n              />\n              <span>Active</span>\n            </label>\n            <label className=\"flex items-center space-x-2\">\n              <input\n                type=\"checkbox\"\n                checked={formData.isPopular ?? false}\n                onChange={(e) => setFormData({ ...formData, isPopular: e.target.checked })}\n                data-testid=\"checkbox-popular\"\n              />\n              <span>Mark as Popular</span>\n            </label>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button onClick={handleSave} data-testid=\"button-save-bundle\">\n              <Save className=\"h-4 w-4 mr-2\" />\n              {editingId ? \"Update Bundle\" : \"Create Bundle\"}\n            </Button>\n            {editingId && (\n              <Button variant=\"outline\" onClick={() => {\n                setEditingId(null);\n                setFormData({});\n              }} data-testid=\"button-cancel-bundle-edit\">\n                <X className=\"h-4 w-4 mr-2\" />\n                Cancel\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Existing Credit Bundles</CardTitle>\n          <CardDescription>All add-on credit packages in the system</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {bundles && bundles.length > 0 ? (\n              bundles.map((bundle) => (\n                <div key={bundle.id} className=\"flex items-center justify-between p-4 border rounded-lg\" data-testid={`card-bundle-${bundle.id}`}>\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-semibold\" data-testid={`text-bundle-name-${bundle.id}`}>{bundle.name}</h3>\n                      <Badge data-testid={`badge-bundle-credits-${bundle.id}`}>{bundle.credits} Credits</Badge>\n                      {bundle.isPopular && <Badge variant=\"secondary\" data-testid={`badge-popular-${bundle.id}`}>Popular</Badge>}\n                      {bundle.isActive && <Badge data-testid={`badge-bundle-active-${bundle.id}`}>Active</Badge>}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid={`text-bundle-pricing-${bundle.id}`}>\n                      {(bundle.priceGbp / 100).toFixed(2)}  ${(bundle.priceUsd / 100).toFixed(2)}  AED {(bundle.priceAed / 100).toFixed(2)}\n                    </p>\n                    {bundle.discountLabel && (\n                      <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-discount-${bundle.id}`}>{bundle.discountLabel}</Badge>\n                    )}\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button size=\"sm\" variant=\"outline\" onClick={() => startEdit(bundle)} data-testid={`button-edit-bundle-${bundle.id}`}>\n                      <Edit className=\"h-4 w-4 mr-2\" />\n                      Edit\n                    </Button>\n                    <Button size=\"sm\" variant=\"destructive\" onClick={() => {\n                      if (confirm(\"Are you sure you want to delete this bundle?\")) {\n                        deleteMutation.mutate(bundle.id);\n                      }\n                    }} data-testid={`button-delete-bundle-${bundle.id}`}>\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ))\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\" data-testid=\"text-no-bundles\">No bundles created yet</p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction CountryPricingManagement() {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState<Partial<CountryPricingOverride>>({});\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/admin/plans\"],\n  });\n\n  const { data: overrides, isLoading } = useQuery<CountryPricingOverride[]>({\n    queryKey: [\"/api/admin/country-pricing\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: Partial<CountryPricingOverride>) => {\n      return await apiRequest(\"/api/admin/country-pricing\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/country-pricing\"] });\n      toast({ title: \"Country pricing created successfully\" });\n      setFormData({});\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/admin/country-pricing/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/country-pricing\"] });\n      toast({ title: \"Country pricing deleted successfully\" });\n    },\n  });\n\n  const handleSave = () => {\n    if (!formData.countryCode || !formData.planId || !formData.currency || !formData.monthlyPriceMinorUnits) {\n      toast({ title: \"Please fill all required fields\", variant: \"destructive\" });\n      return;\n    }\n\n    createMutation.mutate(formData);\n  };\n\n  if (isLoading) {\n    return <div>Loading country pricing...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Create Country Pricing Override</CardTitle>\n          <CardDescription>\n            Configure region-specific pricing for subscription plans\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"country-code\">Country Code (ISO 3166-1 alpha-2)</Label>\n              <Input\n                id=\"country-code\"\n                value={formData.countryCode || \"\"}\n                onChange={(e) => setFormData({ ...formData, countryCode: e.target.value.toUpperCase() })}\n                placeholder=\"US, AE, etc.\"\n                maxLength={2}\n                data-testid=\"input-country-code\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"plan-select\">Plan</Label>\n              <select\n                id=\"plan-select\"\n                className=\"w-full h-9 rounded-md border border-input bg-transparent px-3 py-1 text-sm\"\n                value={formData.planId || \"\"}\n                onChange={(e) => setFormData({ ...formData, planId: e.target.value })}\n                data-testid=\"select-plan\"\n              >\n                <option value=\"\">Select a plan</option>\n                {plans?.map((plan) => (\n                  <option key={plan.id} value={plan.id}>{plan.name}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currency\">Currency</Label>\n              <select\n                id=\"currency\"\n                className=\"w-full h-9 rounded-md border border-input bg-transparent px-3 py-1 text-sm\"\n                value={formData.currency || \"\"}\n                onChange={(e) => setFormData({ ...formData, currency: e.target.value as any })}\n                data-testid=\"select-currency\"\n              >\n                <option value=\"\">Select currency</option>\n                <option value=\"GBP\">GBP</option>\n                <option value=\"USD\">USD</option>\n                <option value=\"AED\">AED</option>\n              </select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"monthly-price\">Monthly Price (Minor Units)</Label>\n              <Input\n                id=\"monthly-price\"\n                type=\"number\"\n                value={formData.monthlyPriceMinorUnits || \"\"}\n                onChange={(e) => setFormData({ ...formData, monthlyPriceMinorUnits: parseInt(e.target.value) })}\n                placeholder=\"4900 for 49 or $49\"\n                data-testid=\"input-monthly-price-minor\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"topup-price\">Top-up Price per Credit (Minor Units)</Label>\n              <Input\n                id=\"topup-price\"\n                type=\"number\"\n                value={formData.topupPricePerCreditMinorUnits || \"\"}\n                onChange={(e) => setFormData({ ...formData, topupPricePerCreditMinorUnits: parseInt(e.target.value) || null })}\n                placeholder=\"75 for 0.75\"\n                data-testid=\"input-topup-price\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"credits-override\">Included Credits Override (optional)</Label>\n            <Input\n              id=\"credits-override\"\n              type=\"number\"\n              value={formData.includedCreditsOverride || \"\"}\n              onChange={(e) => setFormData({ ...formData, includedCreditsOverride: parseInt(e.target.value) || null })}\n              placeholder=\"Leave empty to use plan default\"\n              data-testid=\"input-credits-override\"\n            />\n          </div>\n\n          <Button onClick={handleSave} data-testid=\"button-save-pricing\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Create Country Pricing\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Existing Country Pricing Overrides</CardTitle>\n          <CardDescription>All region-specific pricing configurations</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {overrides && overrides.length > 0 ? (\n              overrides.map((override) => {\n                const plan = plans?.find(p => p.id === override.planId);\n                return (\n                  <div key={override.id} className=\"flex items-center justify-between p-4 border rounded-lg\" data-testid={`card-override-${override.id}`}>\n                    <div className=\"space-y-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <Badge variant=\"outline\" data-testid={`badge-country-${override.id}`}>{override.countryCode}</Badge>\n                        <h3 className=\"font-semibold\" data-testid={`text-plan-name-override-${override.id}`}>{plan?.name || \"Unknown Plan\"}</h3>\n                        <Badge data-testid={`badge-currency-${override.id}`}>{override.currency}</Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\" data-testid={`text-override-details-${override.id}`}>\n                        Monthly: {override.currency} {(override.monthlyPriceMinorUnits / 100).toFixed(2)}\n                        {override.topupPricePerCreditMinorUnits && (\n                          `  Top-up: ${override.currency} ${(override.topupPricePerCreditMinorUnits / 100).toFixed(2)}/credit`\n                        )}\n                        {override.includedCreditsOverride && `  Credits: ${override.includedCreditsOverride}`}\n                      </p>\n                    </div>\n                    <Button size=\"sm\" variant=\"destructive\" onClick={() => {\n                      if (confirm(\"Are you sure you want to delete this override?\")) {\n                        deleteMutation.mutate(override.id);\n                      }\n                    }} data-testid={`button-delete-override-${override.id}`}>\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                );\n              })\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\" data-testid=\"text-no-overrides\">No country pricing overrides created yet</p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":31637},"shared/countryUtils.ts":{"content":"// Country to Currency mapping (ISO 3166-1 alpha-2 country codes)\nexport const COUNTRY_TO_CURRENCY: Record<string, \"GBP\" | \"USD\" | \"AED\"> = {\n  // GBP Countries\n  GB: \"GBP\", // United Kingdom\n  GG: \"GBP\", // Guernsey\n  IM: \"GBP\", // Isle of Man\n  JE: \"GBP\", // Jersey\n  \n  // USD Countries\n  US: \"USD\", // United States\n  AS: \"USD\", // American Samoa\n  BQ: \"USD\", // Bonaire, Sint Eustatius and Saba\n  EC: \"USD\", // Ecuador\n  FM: \"USD\", // Micronesia\n  GU: \"USD\", // Guam\n  MH: \"USD\", // Marshall Islands\n  MP: \"USD\", // Northern Mariana Islands\n  PA: \"USD\", // Panama\n  PR: \"USD\", // Puerto Rico\n  PW: \"USD\", // Palau\n  SV: \"USD\", // El Salvador\n  TC: \"USD\", // Turks and Caicos Islands\n  TL: \"USD\", // Timor-Leste\n  UM: \"USD\", // United States Minor Outlying Islands\n  VG: \"USD\", // Virgin Islands (British)\n  VI: \"USD\", // Virgin Islands (U.S.)\n  ZW: \"USD\", // Zimbabwe\n  \n  // AED Countries\n  AE: \"AED\", // United Arab Emirates\n};\n\n// Default to GBP for countries not in the map\nexport function getCurrencyForCountry(countryCode: string): \"GBP\" | \"USD\" | \"AED\" {\n  return COUNTRY_TO_CURRENCY[countryCode.toUpperCase()] || \"GBP\";\n}\n\n// Currency symbols\nexport const CURRENCY_SYMBOLS: Record<\"GBP\" | \"USD\" | \"AED\", string> = {\n  GBP: \"\",\n  USD: \"$\",\n  AED: \".\",\n};\n\n// Date format patterns by country\nexport const COUNTRY_DATE_FORMATS: Record<string, string> = {\n  // UK and Commonwealth (DD/MM/YYYY)\n  GB: \"dd/MM/yyyy\",\n  AU: \"dd/MM/yyyy\",\n  NZ: \"dd/MM/yyyy\",\n  IE: \"dd/MM/yyyy\",\n  IN: \"dd/MM/yyyy\",\n  ZA: \"dd/MM/yyyy\",\n  SG: \"dd/MM/yyyy\",\n  MY: \"dd/MM/yyyy\",\n  HK: \"dd/MM/yyyy\",\n  \n  // US and territories (MM/DD/YYYY)\n  US: \"MM/dd/yyyy\",\n  PR: \"MM/dd/yyyy\",\n  VI: \"MM/dd/yyyy\",\n  GU: \"MM/dd/yyyy\",\n  \n  // Middle East (DD/MM/YYYY)\n  AE: \"dd/MM/yyyy\",\n  SA: \"dd/MM/yyyy\",\n  QA: \"dd/MM/yyyy\",\n  KW: \"dd/MM/yyyy\",\n  BH: \"dd/MM/yyyy\",\n  OM: \"dd/MM/yyyy\",\n  \n  // Canada (YYYY-MM-DD)\n  CA: \"yyyy-MM-dd\",\n  \n  // Default for other countries (DD/MM/YYYY - ISO-like)\n};\n\n// Date-time format patterns by country\nexport const COUNTRY_DATETIME_FORMATS: Record<string, string> = {\n  // UK and Commonwealth (DD/MM/YYYY HH:mm)\n  GB: \"dd/MM/yyyy 'at' h:mm a\",\n  AU: \"dd/MM/yyyy 'at' h:mm a\",\n  NZ: \"dd/MM/yyyy 'at' h:mm a\",\n  IE: \"dd/MM/yyyy 'at' h:mm a\",\n  IN: \"dd/MM/yyyy 'at' h:mm a\",\n  \n  // US and territories (MM/DD/YYYY HH:mm)\n  US: \"MM/dd/yyyy 'at' h:mm a\",\n  PR: \"MM/dd/yyyy 'at' h:mm a\",\n  \n  // Middle East (DD/MM/YYYY HH:mm)\n  AE: \"dd/MM/yyyy 'at' h:mm a\",\n  SA: \"dd/MM/yyyy 'at' h:mm a\",\n  \n  // Canada (YYYY-MM-DD HH:mm)\n  CA: \"yyyy-MM-dd 'at' HH:mm\",\n};\n\nexport function getDateFormatForCountry(countryCode: string): string {\n  return COUNTRY_DATE_FORMATS[countryCode.toUpperCase()] || \"dd/MM/yyyy\";\n}\n\nexport function getDateTimeFormatForCountry(countryCode: string): string {\n  return COUNTRY_DATETIME_FORMATS[countryCode.toUpperCase()] || \"dd/MM/yyyy 'at' h:mm a\";\n}\n\n// Short date format (for compact displays)\nexport function getShortDateFormatForCountry(countryCode: string): string {\n  const format = getDateFormatForCountry(countryCode);\n  return format.replace(/yyyy/g, \"yy\"); // Use 2-digit year\n}\n\n// List of common countries for dropdown\nexport const COMMON_COUNTRIES = [\n  { code: \"GB\", name: \"United Kingdom\" },\n  { code: \"US\", name: \"United States\" },\n  { code: \"AE\", name: \"United Arab Emirates\" },\n  { code: \"AU\", name: \"Australia\" },\n  { code: \"CA\", name: \"Canada\" },\n  { code: \"IE\", name: \"Ireland\" },\n  { code: \"NZ\", name: \"New Zealand\" },\n  { code: \"SG\", name: \"Singapore\" },\n  { code: \"IN\", name: \"India\" },\n  { code: \"ZA\", name: \"South Africa\" },\n  { code: \"SA\", name: \"Saudi Arabia\" },\n  { code: \"QA\", name: \"Qatar\" },\n  { code: \"KW\", name: \"Kuwait\" },\n  { code: \"BH\", name: \"Bahrain\" },\n  { code: \"OM\", name: \"Oman\" },\n];\n\n// Format currency amount based on currency type\nexport function formatCurrency(\n  amount: number, \n  currency: \"GBP\" | \"USD\" | \"AED\", \n  minorUnits: boolean = true\n): string {\n  const value = minorUnits ? amount / 100 : amount;\n  const symbol = CURRENCY_SYMBOLS[currency];\n  \n  // Format with appropriate decimal places\n  const formatted = value.toLocaleString('en-US', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n  \n  // AED symbol goes after the amount\n  if (currency === \"AED\") {\n    return `${formatted} ${symbol}`;\n  }\n  \n  // GBP and USD symbols go before\n  return `${symbol}${formatted}`;\n}\n","size_bytes":4382},"client/src/lib/geolocation.ts":{"content":"// IP Geolocation service to detect user's country\nexport interface GeolocationResult {\n  countryCode: string;\n  countryName: string;\n  city?: string;\n  timezone?: string;\n}\n\n// Free IP geolocation service using ipapi.co\nexport async function detectUserCountry(): Promise<GeolocationResult | null> {\n  try {\n    // Add timeout to prevent hanging\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout\n    \n    const response = await fetch(\"https://ipapi.co/json/\", {\n      signal: controller.signal\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!response.ok) {\n      console.warn(\"Failed to detect country from IP\");\n      return null;\n    }\n    \n    const data = await response.json();\n    \n    // Validate response has required fields\n    if (!data.country_code) {\n      console.warn(\"IP geolocation response missing country code\");\n      return null;\n    }\n    \n    return {\n      countryCode: data.country_code || \"GB\", // Default to GB\n      countryName: data.country_name || \"United Kingdom\",\n      city: data.city,\n      timezone: data.timezone,\n    };\n  } catch (error) {\n    // Timeout or network error\n    if (error instanceof Error && error.name === 'AbortError') {\n      console.warn(\"Country detection timed out\");\n    } else {\n      console.error(\"Error detecting country:\", error);\n    }\n    return null;\n  }\n}\n\n// Cached result to avoid multiple API calls\nlet cachedCountry: GeolocationResult | null | undefined = undefined;\n\nexport async function getCachedUserCountry(): Promise<GeolocationResult> {\n  if (cachedCountry === undefined) {\n    cachedCountry = await detectUserCountry();\n  }\n  \n  return cachedCountry || {\n    countryCode: \"GB\",\n    countryName: \"United Kingdom\",\n  };\n}\n","size_bytes":1787},"client/src/contexts/LocaleContext.tsx":{"content":"import { createContext, useContext, ReactNode } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { getCurrencyForCountry, getDateFormatForCountry, getDateTimeFormatForCountry, CURRENCY_SYMBOLS, formatCurrency as formatCurrencyUtil } from \"@shared/countryUtils\";\nimport { format as dateFnsFormat } from \"date-fns\";\n\ninterface LocaleContextType {\n  countryCode: string;\n  currency: \"GBP\" | \"USD\" | \"AED\";\n  currencySymbol: string;\n  dateFormat: string;\n  dateTimeFormat: string;\n  formatCurrency: (amount: number, minorUnits?: boolean) => string;\n  formatDate: (date: Date | string | number, formatStr?: string) => string;\n  formatDateTime: (date: Date | string | number) => string;\n}\n\nconst LocaleContext = createContext<LocaleContextType | undefined>(undefined);\n\nexport function LocaleProvider({ children }: { children: ReactNode }) {\n  const { user } = useAuth();\n  \n  // Get country code from user's organization, default to GB\n  // The user object has organizationCountryCode added by the API\n  const countryCode = (user as any)?.organizationCountryCode || \"GB\";\n  const currency = getCurrencyForCountry(countryCode);\n  const currencySymbol = CURRENCY_SYMBOLS[currency];\n  const dateFormat = getDateFormatForCountry(countryCode);\n  const dateTimeFormat = getDateTimeFormatForCountry(countryCode);\n  \n  const formatCurrency = (amount: number, minorUnits: boolean = true): string => {\n    return formatCurrencyUtil(amount, currency, minorUnits);\n  };\n  \n  const formatDate = (date: Date | string | number, formatStr?: string): string => {\n    const dateObj = typeof date === \"string\" || typeof date === \"number\" ? new Date(date) : date;\n    return dateFnsFormat(dateObj, formatStr || dateFormat);\n  };\n  \n  const formatDateTime = (date: Date | string | number): string => {\n    const dateObj = typeof date === \"string\" || typeof date === \"number\" ? new Date(date) : date;\n    return dateFnsFormat(dateObj, dateTimeFormat);\n  };\n  \n  return (\n    <LocaleContext.Provider\n      value={{\n        countryCode,\n        currency,\n        currencySymbol,\n        dateFormat,\n        dateTimeFormat,\n        formatCurrency,\n        formatDate,\n        formatDateTime,\n      }}\n    >\n      {children}\n    </LocaleContext.Provider>\n  );\n}\n\nexport function useLocale() {\n  const context = useContext(LocaleContext);\n  if (context === undefined) {\n    throw new Error(\"useLocale must be used within a LocaleProvider\");\n  }\n  return context;\n}\n","size_bytes":2448},"client/src/pages/BlocksReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  Building2, \n  ArrowLeft, \n  Filter,\n  Loader2,\n  Home,\n  Users\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function BlocksReport() {\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: blocks = [], isLoading: blocksLoading } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  const { data: properties = [] } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: tenantAssignments = [] } = useQuery<any[]>({\n    queryKey: [\"/api/tenant-assignments\"],\n  });\n\n  // Calculate statistics for each block\n  const blocksWithStats = useMemo(() => {\n    return blocks.map(block => {\n      const blockProperties = properties.filter(p => p.blockId === block.id);\n      const totalUnits = blockProperties.length;\n      \n      // Count occupied units\n      const occupiedUnits = blockProperties.filter(property => {\n        return tenantAssignments.some(\n          assignment => \n            assignment.propertyId === property.id && \n            assignment.status === \"active\"\n        );\n      }).length;\n\n      const occupancyRate = totalUnits > 0 \n        ? Math.round((occupiedUnits / totalUnits) * 100) \n        : 0;\n\n      return {\n        ...block,\n        totalUnits,\n        occupiedUnits,\n        vacantUnits: totalUnits - occupiedUnits,\n        occupancyRate,\n      };\n    });\n  }, [blocks, properties, tenantAssignments]);\n\n  // Filter blocks\n  const filteredBlocks = useMemo(() => {\n    return blocksWithStats.filter(block => {\n      const searchLower = searchTerm.toLowerCase();\n      return (\n        block.name?.toLowerCase().includes(searchLower) ||\n        block.address?.toLowerCase().includes(searchLower) ||\n        block.postcode?.toLowerCase().includes(searchLower)\n      );\n    });\n  }, [blocksWithStats, searchTerm]);\n\n  const totalProperties = properties.length;\n  const avgOccupancyRate = blocksWithStats.length > 0\n    ? Math.round(\n        blocksWithStats.reduce((sum, block) => sum + block.occupancyRate, 0) / \n        blocksWithStats.length\n      )\n    : 0;\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const response = await apiRequest(\"POST\", \"/api/reports/blocks/pdf\", {});\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `blocks-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 md:p-8 lg:p-12 space-y-8\">\n      {/* Header */}\n      <div className=\"flex items-start justify-between\">\n        <div className=\"space-y-2\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" className=\"mb-2\" data-testid=\"button-back-reports\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Reports\n            </Button>\n          </Link>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-12 h-12 rounded-xl bg-accent/10 flex items-center justify-center\">\n              <Building2 className=\"h-6 w-6 text-accent\" />\n            </div>\n            <div>\n              <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Blocks Report</h1>\n              <p className=\"text-lg text-muted-foreground mt-1\">\n                Block-level statistics and occupancy metrics\n              </p>\n            </div>\n          </div>\n        </div>\n        <Button\n          onClick={handleExportPDF}\n          disabled={isExporting || filteredBlocks.length === 0}\n          size=\"lg\"\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n              Exporting...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-5 w-5\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Filters */}\n      <Card className=\"glass-card\">\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5 text-primary\" />\n            <CardTitle>Search & Filter</CardTitle>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-2\">\n            <Label>Search Blocks</Label>\n            <Input\n              placeholder=\"Search by name, address, or postcode...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              data-testid=\"input-search-blocks\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Blocks</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{filteredBlocks.length}</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Properties</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{totalProperties}</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Avg Occupancy Rate</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{avgOccupancyRate}%</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Tenants</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {tenantAssignments.filter(a => a.status === \"active\").length}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Blocks Table */}\n      <Card className=\"glass-card\">\n        <CardHeader>\n          <CardTitle>Block Details</CardTitle>\n          <CardDescription>\n            Showing {filteredBlocks.length} block{filteredBlocks.length !== 1 ? 's' : ''}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {blocksLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredBlocks.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Building2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground\">\n                {searchTerm ? \"No blocks found matching your search\" : \"No blocks found\"}\n              </p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Block Name</TableHead>\n                    <TableHead>Address</TableHead>\n                    <TableHead className=\"text-center\">Total Units</TableHead>\n                    <TableHead className=\"text-center\">Occupied</TableHead>\n                    <TableHead className=\"text-center\">Vacant</TableHead>\n                    <TableHead className=\"text-center\">Occupancy Rate</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredBlocks.map((block: any) => {\n                    const occupancyColor = \n                      block.occupancyRate >= 90 ? \"default\" :\n                      block.occupancyRate >= 70 ? \"secondary\" :\n                      \"destructive\";\n\n                    return (\n                      <TableRow key={block.id}>\n                        <TableCell className=\"font-medium\">\n                          <div className=\"flex items-center gap-2\">\n                            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                            {block.name}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"text-sm\">\n                            <div>{block.address}</div>\n                            {block.postcode && (\n                              <div className=\"text-muted-foreground\">{block.postcode}</div>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant=\"secondary\">\n                            <Home className=\"h-3 w-3 mr-1\" />\n                            {block.totalUnits}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant=\"default\">\n                            <Users className=\"h-3 w-3 mr-1\" />\n                            {block.occupiedUnits}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          {block.vacantUnits}\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant={occupancyColor}>\n                            {block.occupancyRate}%\n                          </Badge>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":10947},"client/src/pages/InspectionsReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  ClipboardCheck, \n  ArrowLeft, \n  Calendar,\n  Filter,\n  Loader2\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function InspectionsReport() {\n  const { toast } = useToast();\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [filterProperty, setFilterProperty] = useState<string>(\"all\");\n  const [filterBlock, setFilterBlock] = useState<string>(\"all\");\n  const [dateFrom, setDateFrom] = useState(\"\");\n  const [dateTo, setDateTo] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: inspections = [], isLoading: inspectionsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/inspections\"],\n  });\n\n  const { data: properties = [] } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  // Filter inspections\n  const filteredInspections = useMemo(() => {\n    let filtered = inspections;\n\n    if (filterStatus !== \"all\") {\n      filtered = filtered.filter(i => i.status === filterStatus);\n    }\n\n    if (filterType !== \"all\") {\n      filtered = filtered.filter(i => i.type === filterType);\n    }\n\n    if (filterProperty !== \"all\") {\n      filtered = filtered.filter(i => i.propertyId === filterProperty);\n    }\n\n    if (filterBlock !== \"all\") {\n      const blockProperties = properties.filter(p => p.blockId === filterBlock);\n      const blockPropertyIds = blockProperties.map(p => p.id);\n      filtered = filtered.filter(i => blockPropertyIds.includes(i.propertyId));\n    }\n\n    if (dateFrom) {\n      filtered = filtered.filter(i => {\n        const inspectionDate = new Date(i.scheduledDate || i.createdAt);\n        return inspectionDate >= new Date(dateFrom);\n      });\n    }\n\n    if (dateTo) {\n      filtered = filtered.filter(i => {\n        const inspectionDate = new Date(i.scheduledDate || i.createdAt);\n        return inspectionDate <= new Date(dateTo);\n      });\n    }\n\n    return filtered.sort((a, b) => {\n      const dateA = new Date(a.scheduledDate || a.createdAt);\n      const dateB = new Date(b.scheduledDate || b.createdAt);\n      return dateB.getTime() - dateA.getTime();\n    });\n  }, [inspections, filterStatus, filterType, filterProperty, filterBlock, dateFrom, dateTo, properties]);\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const filters = {\n        status: filterStatus,\n        type: filterType,\n        propertyId: filterProperty,\n        blockId: filterBlock,\n        dateFrom,\n        dateTo,\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/reports/inspections/pdf\", filters);\n      \n      // Create blob from response and download\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `inspections-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    const statusMap: Record<string, { variant: any; label: string }> = {\n      scheduled: { variant: \"secondary\", label: \"Scheduled\" },\n      in_progress: { variant: \"default\", label: \"In Progress\" },\n      completed: { variant: \"default\", label: \"Completed\" },\n      cancelled: { variant: \"destructive\", label: \"Cancelled\" },\n    };\n\n    const config = statusMap[status] || { variant: \"secondary\", label: status };\n    return <Badge variant={config.variant}>{config.label}</Badge>;\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 md:p-8 lg:p-12 space-y-8\">\n      {/* Header */}\n      <div className=\"flex items-start justify-between\">\n        <div className=\"space-y-2\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" className=\"mb-2\" data-testid=\"button-back-reports\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Reports\n            </Button>\n          </Link>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center\">\n              <ClipboardCheck className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div>\n              <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Inspections Report</h1>\n              <p className=\"text-lg text-muted-foreground mt-1\">\n                Comprehensive inspection history and analytics\n              </p>\n            </div>\n          </div>\n        </div>\n        <Button\n          onClick={handleExportPDF}\n          disabled={isExporting || filteredInspections.length === 0}\n          size=\"lg\"\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n              Exporting...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-5 w-5\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Filters */}\n      <Card className=\"glass-card\">\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5 text-primary\" />\n            <CardTitle>Filters</CardTitle>\n          </div>\n          <CardDescription>Customize your report by applying filters</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            <div className=\"space-y-2\">\n              <Label>Status</Label>\n              <Select value={filterStatus} onValueChange={setFilterStatus}>\n                <SelectTrigger data-testid=\"select-filter-status\">\n                  <SelectValue placeholder=\"All statuses\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Statuses</SelectItem>\n                  <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                  <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                  <SelectItem value=\"completed\">Completed</SelectItem>\n                  <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Type</Label>\n              <Select value={filterType} onValueChange={setFilterType}>\n                <SelectTrigger data-testid=\"select-filter-type\">\n                  <SelectValue placeholder=\"All types\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Types</SelectItem>\n                  <SelectItem value=\"check-in\">Check-In</SelectItem>\n                  <SelectItem value=\"check-out\">Check-Out</SelectItem>\n                  <SelectItem value=\"periodic\">Periodic</SelectItem>\n                  <SelectItem value=\"maintenance\">Maintenance</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Block</Label>\n              <Select value={filterBlock} onValueChange={setFilterBlock}>\n                <SelectTrigger data-testid=\"select-filter-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Blocks</SelectItem>\n                  {blocks.map((block: any) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Property</Label>\n              <Select value={filterProperty} onValueChange={setFilterProperty}>\n                <SelectTrigger data-testid=\"select-filter-property\">\n                  <SelectValue placeholder=\"All properties\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Properties</SelectItem>\n                  {properties.map((property: any) => (\n                    <SelectItem key={property.id} value={property.id}>\n                      {property.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Date From</Label>\n              <Input\n                type=\"date\"\n                value={dateFrom}\n                onChange={(e) => setDateFrom(e.target.value)}\n                data-testid=\"input-date-from\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Date To</Label>\n              <Input\n                type=\"date\"\n                value={dateTo}\n                onChange={(e) => setDateTo(e.target.value)}\n                data-testid=\"input-date-to\"\n              />\n            </div>\n          </div>\n\n          {(filterStatus !== \"all\" || filterType !== \"all\" || filterProperty !== \"all\" || filterBlock !== \"all\" || dateFrom || dateTo) && (\n            <Button\n              variant=\"outline\"\n              className=\"mt-4\"\n              onClick={() => {\n                setFilterStatus(\"all\");\n                setFilterType(\"all\");\n                setFilterProperty(\"all\");\n                setFilterBlock(\"all\");\n                setDateFrom(\"\");\n                setDateTo(\"\");\n              }}\n              data-testid=\"button-clear-filters\"\n            >\n              Clear All Filters\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Inspections</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{filteredInspections.length}</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Completed</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {filteredInspections.filter(i => i.status === \"completed\").length}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>In Progress</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {filteredInspections.filter(i => i.status === \"in_progress\").length}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Scheduled</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {filteredInspections.filter(i => i.status === \"scheduled\").length}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Inspections Table */}\n      <Card className=\"glass-card\">\n        <CardHeader>\n          <CardTitle>Inspection Records</CardTitle>\n          <CardDescription>\n            Showing {filteredInspections.length} inspection{filteredInspections.length !== 1 ? 's' : ''}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {inspectionsLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredInspections.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <ClipboardCheck className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground\">No inspections found matching your filters</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Date</TableHead>\n                    <TableHead>Property</TableHead>\n                    <TableHead>Type</TableHead>\n                    <TableHead>Inspector</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredInspections.map((inspection: any) => {\n                    const property = properties.find(p => p.id === inspection.propertyId);\n                    const inspectionDate = new Date(inspection.scheduledDate || inspection.createdAt);\n                    \n                    return (\n                      <TableRow key={inspection.id}>\n                        <TableCell>\n                          <div className=\"flex items-center gap-2\">\n                            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                            {format(inspectionDate, 'MMM d, yyyy')}\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"font-medium\">\n                          {property?.name || \"Unknown Property\"}\n                        </TableCell>\n                        <TableCell className=\"capitalize\">\n                          {inspection.type?.replace('-', ' ') || \"N/A\"}\n                        </TableCell>\n                        <TableCell>\n                          {inspection.inspector || \"Unassigned\"}\n                        </TableCell>\n                        <TableCell>\n                          {getStatusBadge(inspection.status)}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <Link href={`/inspections/${inspection.id}`}>\n                            <Button variant=\"ghost\" size=\"sm\">\n                              View\n                            </Button>\n                          </Link>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":15709},"client/src/pages/Reports.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { \n  FileText, \n  Building2, \n  Home, \n  Users, \n  Package, \n  ClipboardCheck,\n  BarChart3,\n  FileBarChart,\n  ShieldCheck\n} from \"lucide-react\";\n\nexport default function Reports() {\n  const reportCards = [\n    {\n      title: \"Inspections Report\",\n      description: \"Comprehensive inspection history with status tracking and analytics\",\n      icon: ClipboardCheck,\n      link: \"/reports/inspections\",\n      color: \"text-primary\",\n      bgColor: \"bg-primary/10\",\n      available: true\n    },\n    {\n      title: \"Blocks Report\",\n      description: \"Block-level statistics, occupancy rates, and compliance metrics\",\n      icon: Building2,\n      link: \"/reports/blocks\",\n      color: \"text-accent\",\n      bgColor: \"bg-accent/10\",\n      available: true\n    },\n    {\n      title: \"Properties Report\",\n      description: \"Property portfolio overview with maintenance and inspection data\",\n      icon: Home,\n      link: \"/reports/properties\",\n      color: \"text-chart-1\",\n      bgColor: \"bg-chart-1/10\",\n      available: true\n    },\n    {\n      title: \"Tenants Report\",\n      description: \"Tenant occupancy, lease tracking, and rental income analysis\",\n      icon: Users,\n      link: \"/reports/tenants\",\n      color: \"text-chart-3\",\n      bgColor: \"bg-chart-3/10\",\n      available: true\n    },\n    {\n      title: \"Inventory Report\",\n      description: \"Asset tracking across all properties with condition reports\",\n      icon: Package,\n      link: \"/reports/inventory\",\n      color: \"text-chart-2\",\n      bgColor: \"bg-chart-2/10\",\n      available: true\n    },\n    {\n      title: \"Compliance Report\",\n      description: \"Document tracking and compliance management by block and property\",\n      icon: ShieldCheck,\n      link: \"/reports/compliance\",\n      color: \"text-chart-4\",\n      bgColor: \"bg-chart-4/10\",\n      available: true\n    }\n  ];\n\n  return (\n    <div className=\"container mx-auto p-6 md:p-8 lg:p-12 space-y-8\">\n      {/* Header */}\n      <div className=\"space-y-2\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center\">\n            <FileBarChart className=\"h-6 w-6 text-primary\" />\n          </div>\n          <div>\n            <h1 className=\"text-4xl md:text-5xl font-bold tracking-tight\">Reports</h1>\n            <p className=\"text-lg text-muted-foreground mt-1\">\n              Generate detailed reports and export to PDF\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Info Banner */}\n      <Card className=\"glass-card border-primary/20\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0\">\n              <BarChart3 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"space-y-1\">\n              <h3 className=\"font-semibold\">Professional BTR Reporting</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Each report includes advanced filtering options and PDF export functionality. \n                Apply filters to focus on specific date ranges, properties, or criteria, then export \n                professional reports for stakeholders, audits, or record-keeping.\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Report Cards Grid */}\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        {reportCards.map((report) => {\n          const Icon = report.icon;\n          const cardContent = (\n            <Card \n              className={`glass-card transition-all h-full ${report.available ? 'hover-elevate cursor-pointer' : 'opacity-60'}`}\n              data-testid={`card-report-${report.title.toLowerCase().replace(/\\s+/g, '-')}`}\n            >\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-4\">\n                  <div className={`w-12 h-12 rounded-xl ${report.bgColor} flex items-center justify-center flex-shrink-0`}>\n                    <Icon className={`h-6 w-6 ${report.color}`} />\n                  </div>\n                  {report.comingSoon ? (\n                    <Badge variant=\"secondary\">Coming Soon</Badge>\n                  ) : (\n                    <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                  )}\n                </div>\n                <CardTitle className=\"mt-4\">{report.title}</CardTitle>\n                <CardDescription className=\"text-base\">\n                  {report.description}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className={`flex items-center text-sm font-medium ${report.available ? 'text-primary' : 'text-muted-foreground'}`}>\n                  {report.available ? 'View Report' : 'Coming Soon'}\n                  {report.available && <span className=\"ml-2\"></span>}\n                </div>\n              </CardContent>\n            </Card>\n          );\n          \n          return report.available ? (\n            <Link key={report.title} href={report.link}>\n              {cardContent}\n            </Link>\n          ) : (\n            <div key={report.title}>\n              {cardContent}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","size_bytes":5532},"client/src/components/TagFilter.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Input } from \"@/components/ui/input\";\nimport { Filter, X, Tag as TagIcon } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport type { Tag } from \"@shared/schema\";\n\ninterface TagFilterProps {\n  selectedTags: Tag[];\n  onTagsChange: (tags: Tag[]) => void;\n  placeholder?: string;\n}\n\nexport function TagFilter({ selectedTags, onTagsChange, placeholder = \"Filter by tags...\" }: TagFilterProps) {\n  const [open, setOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: allTags = [] } = useQuery<Tag[]>({\n    queryKey: [\"/api/tags\"],\n  });\n\n  const handleAddTag = (tag: Tag) => {\n    if (!selectedTags.find(t => t.id === tag.id)) {\n      onTagsChange([...selectedTags, tag]);\n    }\n    setSearchQuery(\"\");\n  };\n\n  const handleRemoveTag = (tagId: string) => {\n    onTagsChange(selectedTags.filter(t => t.id !== tagId));\n  };\n\n  const handleClearAll = () => {\n    onTagsChange([]);\n  };\n\n  const filteredTags = allTags.filter(tag =>\n    !selectedTags.find(t => t.id === tag.id) &&\n    tag.name.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  return (\n    <div className=\"flex items-center gap-2 flex-wrap\">\n      {/* Selected tags */}\n      {selectedTags.map(tag => (\n        <Badge\n          key={tag.id}\n          variant=\"secondary\"\n          className=\"gap-1\"\n          style={{ backgroundColor: tag.color || undefined }}\n          data-testid={`filter-tag-${tag.id}`}\n        >\n          <TagIcon className=\"h-3 w-3\" />\n          {tag.name}\n          <button\n            type=\"button\"\n            onClick={() => handleRemoveTag(tag.id)}\n            className=\"ml-1 hover:bg-black/10 rounded-full\"\n            data-testid={`button-remove-filter-tag-${tag.id}`}\n          >\n            <X className=\"h-3 w-3\" />\n          </button>\n        </Badge>\n      ))}\n\n      {/* Add tag button */}\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"h-7\"\n            data-testid=\"button-add-tag-filter\"\n          >\n            <Filter className=\"h-3 w-3 mr-1\" />\n            Add Filter\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-64 p-0\" align=\"start\">\n          <div className=\"p-2 border-b\">\n            <Input\n              placeholder={placeholder}\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"h-8\"\n              data-testid=\"input-tag-filter-search\"\n            />\n          </div>\n          <ScrollArea className=\"h-48\">\n            <div className=\"p-2 space-y-1\">\n              {filteredTags.length === 0 ? (\n                <div className=\"text-sm text-muted-foreground text-center py-4\">\n                  {searchQuery ? \"No tags found\" : \"No more tags available\"}\n                </div>\n              ) : (\n                filteredTags.map(tag => (\n                  <button\n                    key={tag.id}\n                    onClick={() => handleAddTag(tag)}\n                    className=\"w-full text-left px-2 py-1.5 text-sm rounded hover-elevate flex items-center gap-2\"\n                    data-testid={`button-select-tag-${tag.id}`}\n                  >\n                    <TagIcon className=\"h-3 w-3\" style={{ color: tag.color || undefined }} />\n                    {tag.name}\n                  </button>\n                ))\n              )}\n            </div>\n          </ScrollArea>\n        </PopoverContent>\n      </Popover>\n\n      {/* Clear all button */}\n      {selectedTags.length > 0 && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={handleClearAll}\n          className=\"h-7 text-xs\"\n          data-testid=\"button-clear-all-filters\"\n        >\n          Clear All\n        </Button>\n      )}\n    </div>\n  );\n}\n","size_bytes":4153},"client/src/pages/InventoryReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  Package, \n  ArrowLeft, \n  Filter,\n  Loader2,\n  Building2,\n  Home\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function InventoryReport() {\n  const { toast } = useToast();\n  const [filterBlock, setFilterBlock] = useState<string>(\"all\");\n  const [filterProperty, setFilterProperty] = useState<string>(\"all\");\n  const [filterCategory, setFilterCategory] = useState<string>(\"all\");\n  const [filterCondition, setFilterCondition] = useState<string>(\"all\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: assetInventory = [], isLoading: inventoryLoading } = useQuery<any[]>({\n    queryKey: [\"/api/asset-inventory\"],\n  });\n\n  const { data: properties = [], isLoading: propertiesLoading } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [], isLoading: blocksLoading } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  const isLoading = inventoryLoading || propertiesLoading || blocksLoading;\n\n  // Enrich inventory data with property and block information\n  const enrichedInventory = useMemo(() => {\n    return assetInventory.map(asset => {\n      const property = properties.find(p => p.id === asset.propertyId);\n      const block = property ? blocks.find(b => b.id === property.blockId) : \n                    blocks.find(b => b.id === asset.blockId);\n\n      return {\n        ...asset,\n        property,\n        block,\n      };\n    });\n  }, [assetInventory, properties, blocks]);\n\n  // Get unique categories\n  const categories = useMemo(() => {\n    const cats = new Set<string>();\n    enrichedInventory.forEach(item => {\n      if (item.category) cats.add(item.category);\n    });\n    return Array.from(cats).sort();\n  }, [enrichedInventory]);\n\n  // Filter inventory\n  const filteredInventory = useMemo(() => {\n    let filtered = enrichedInventory;\n\n    if (filterBlock !== \"all\") {\n      filtered = filtered.filter(i => \n        i.blockId === filterBlock || i.property?.blockId === filterBlock\n      );\n    }\n\n    if (filterProperty !== \"all\") {\n      filtered = filtered.filter(i => i.propertyId === filterProperty);\n    }\n\n    if (filterCategory !== \"all\") {\n      filtered = filtered.filter(i => i.category === filterCategory);\n    }\n\n    if (filterCondition !== \"all\") {\n      filtered = filtered.filter(i => i.condition === filterCondition);\n    }\n\n    if (searchTerm) {\n      const searchLower = searchTerm.toLowerCase();\n      filtered = filtered.filter(i => \n        i.name?.toLowerCase().includes(searchLower) ||\n        i.description?.toLowerCase().includes(searchLower) ||\n        i.serialNumber?.toLowerCase().includes(searchLower) ||\n        i.location?.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return filtered.sort((a, b) => {\n      // Sort by block, then property, then category, then name\n      const blockCompare = (a.block?.name || \"\").localeCompare(b.block?.name || \"\");\n      if (blockCompare !== 0) return blockCompare;\n      \n      const propertyCompare = (a.property?.unitNumber || \"\").localeCompare(b.property?.unitNumber || \"\");\n      if (propertyCompare !== 0) return propertyCompare;\n      \n      const categoryCompare = (a.category || \"\").localeCompare(b.category || \"\");\n      if (categoryCompare !== 0) return categoryCompare;\n      \n      return (a.name || \"\").localeCompare(b.name || \"\");\n    });\n  }, [enrichedInventory, filterBlock, filterProperty, filterCategory, filterCondition, searchTerm]);\n\n  // Summary statistics\n  const totalAssets = filteredInventory.length;\n  const blockAssets = filteredInventory.filter(i => i.blockId && !i.propertyId).length;\n  const propertyAssets = filteredInventory.filter(i => i.propertyId).length;\n  const damagedAssets = filteredInventory.filter(i => \n    i.condition === \"poor\" || i.condition === \"damaged\"\n  ).length;\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const filters = {\n        blockId: filterBlock,\n        propertyId: filterProperty,\n        category: filterCategory,\n        condition: filterCondition,\n        searchTerm,\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/reports/inventory/pdf\", filters);\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `inventory-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight flex items-center gap-2\">\n              <Package className=\"h-8 w-8 text-primary\" />\n              Inventory Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Asset tracking and inventory management across blocks and properties\n            </p>\n          </div>\n        </div>\n        <Button \n          onClick={handleExportPDF} \n          disabled={isExporting || filteredInventory.length === 0}\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              Generating...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-4 w-4\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Total Assets</CardDescription>\n            <CardTitle className=\"text-3xl\" data-testid=\"stat-total-assets\">{totalAssets}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Block Assets</CardDescription>\n            <CardTitle className=\"text-3xl text-primary\" data-testid=\"stat-block-assets\">{blockAssets}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Property Assets</CardDescription>\n            <CardTitle className=\"text-3xl text-accent\" data-testid=\"stat-property-assets\">{propertyAssets}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Needs Attention</CardDescription>\n            <CardTitle className=\"text-3xl text-destructive\" data-testid=\"stat-needs-attention\">{damagedAssets}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5\" />\n            Filters\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid gap-4 md:grid-cols-5\">\n            <div className=\"space-y-2\">\n              <Label>Search</Label>\n              <Input\n                placeholder=\"Search assets...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Block</Label>\n              <Select value={filterBlock} onValueChange={setFilterBlock}>\n                <SelectTrigger data-testid=\"select-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Blocks</SelectItem>\n                  {blocks.map((block) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Property</Label>\n              <Select value={filterProperty} onValueChange={setFilterProperty}>\n                <SelectTrigger data-testid=\"select-property\">\n                  <SelectValue placeholder=\"All properties\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Properties</SelectItem>\n                  {properties.map((property) => (\n                    <SelectItem key={property.id} value={property.id}>\n                      {property.unitNumber || property.address}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Category</Label>\n              <Select value={filterCategory} onValueChange={setFilterCategory}>\n                <SelectTrigger data-testid=\"select-category\">\n                  <SelectValue placeholder=\"All categories\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Categories</SelectItem>\n                  {categories.map((category) => (\n                    <SelectItem key={category} value={category}>\n                      {category}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Condition</Label>\n              <Select value={filterCondition} onValueChange={setFilterCondition}>\n                <SelectTrigger data-testid=\"select-condition\">\n                  <SelectValue placeholder=\"All conditions\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"excellent\">Excellent</SelectItem>\n                  <SelectItem value=\"good\">Good</SelectItem>\n                  <SelectItem value=\"fair\">Fair</SelectItem>\n                  <SelectItem value=\"poor\">Poor</SelectItem>\n                  <SelectItem value=\"damaged\">Damaged</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Inventory Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Asset Inventory ({filteredInventory.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredInventory.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-inventory\">\n              No inventory items found matching your criteria\n            </div>\n          ) : (\n            <div className=\"border rounded-lg overflow-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Asset Name</TableHead>\n                    <TableHead>Category</TableHead>\n                    <TableHead>Location</TableHead>\n                    <TableHead>Block</TableHead>\n                    <TableHead>Property</TableHead>\n                    <TableHead>Condition</TableHead>\n                    <TableHead>Serial Number</TableHead>\n                    <TableHead>Added</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredInventory.map((asset) => (\n                    <TableRow key={asset.id} data-testid={`row-asset-${asset.id}`}>\n                      <TableCell className=\"font-medium\">\n                        {asset.name}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">\n                          {asset.category || \"Uncategorized\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {asset.location || \"N/A\"}\n                      </TableCell>\n                      <TableCell>\n                        {asset.block ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                            {asset.block.name}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {asset.property ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Home className=\"h-4 w-4 text-muted-foreground\" />\n                            {asset.property.unitNumber}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge \n                          variant={\n                            asset.condition === \"excellent\" || asset.condition === \"good\"\n                              ? \"default\"\n                              : asset.condition === \"fair\"\n                              ? \"secondary\"\n                              : \"destructive\"\n                          }\n                        >\n                          {asset.condition || \"Unknown\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-sm font-mono\">\n                        {asset.serialNumber || \"-\"}\n                      </TableCell>\n                      <TableCell>\n                        {asset.createdAt ? (\n                          format(new Date(asset.createdAt), 'MMM d, yyyy')\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":15890},"client/src/pages/TenantsReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  Users, \n  ArrowLeft, \n  Filter,\n  Loader2,\n  Building2,\n  Home\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format, differenceInDays } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function TenantsReport() {\n  const { toast } = useToast();\n  const [filterBlock, setFilterBlock] = useState<string>(\"all\");\n  const [filterProperty, setFilterProperty] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: tenantAssignments = [], isLoading: tenantsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/tenant-assignments\"],\n  });\n\n  const { data: properties = [], isLoading: propertiesLoading } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [], isLoading: blocksLoading } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  const isLoading = tenantsLoading || propertiesLoading || blocksLoading;\n\n  // Enrich tenant data with property and block information\n  const enrichedTenants = useMemo(() => {\n    return tenantAssignments.map(tenant => {\n      const property = properties.find(p => p.id === tenant.propertyId);\n      const block = property ? blocks.find(b => b.id === property.blockId) : null;\n\n      const leaseEndDate = tenant.leaseEndDate ? new Date(tenant.leaseEndDate) : null;\n      const daysUntilExpiry = leaseEndDate ? differenceInDays(leaseEndDate, new Date()) : null;\n      const isExpiringSoon = daysUntilExpiry !== null && daysUntilExpiry >= 0 && daysUntilExpiry <= 60;\n\n      return {\n        ...tenant,\n        property,\n        block,\n        daysUntilExpiry,\n        isExpiringSoon,\n        monthlyRent: tenant.monthlyRent ? parseFloat(tenant.monthlyRent) : 0,\n        depositAmount: tenant.depositAmount ? parseFloat(tenant.depositAmount) : 0,\n      };\n    });\n  }, [tenantAssignments, properties, blocks]);\n\n  // Filter tenants\n  const filteredTenants = useMemo(() => {\n    let filtered = enrichedTenants;\n\n    if (filterBlock !== \"all\") {\n      filtered = filtered.filter(t => t.property?.blockId === filterBlock);\n    }\n\n    if (filterProperty !== \"all\") {\n      filtered = filtered.filter(t => t.propertyId === filterProperty);\n    }\n\n    if (filterStatus !== \"all\") {\n      if (filterStatus === \"active\") {\n        filtered = filtered.filter(t => t.status === \"active\");\n      } else if (filterStatus === \"expiring\") {\n        filtered = filtered.filter(t => t.isExpiringSoon);\n      } else if (filterStatus === \"expired\") {\n        filtered = filtered.filter(t => t.daysUntilExpiry !== null && t.daysUntilExpiry < 0);\n      }\n    }\n\n    if (searchTerm) {\n      const searchLower = searchTerm.toLowerCase();\n      filtered = filtered.filter(t => \n        t.tenantFirstName?.toLowerCase().includes(searchLower) ||\n        t.tenantLastName?.toLowerCase().includes(searchLower) ||\n        t.tenantEmail?.toLowerCase().includes(searchLower) ||\n        t.property?.address?.toLowerCase().includes(searchLower) ||\n        t.property?.unitNumber?.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return filtered.sort((a, b) => {\n      // Sort by block, then property unit\n      const blockCompare = (a.block?.name || \"\").localeCompare(b.block?.name || \"\");\n      if (blockCompare !== 0) return blockCompare;\n      return (a.property?.unitNumber || \"\").localeCompare(b.property?.unitNumber || \"\");\n    });\n  }, [enrichedTenants, filterBlock, filterProperty, filterStatus, searchTerm]);\n\n  // Summary statistics\n  const totalTenants = filteredTenants.length;\n  const activeTenants = filteredTenants.filter(t => t.status === \"active\").length;\n  const expiringSoon = filteredTenants.filter(t => t.isExpiringSoon).length;\n  const totalMonthlyRent = filteredTenants\n    .filter(t => t.status === \"active\")\n    .reduce((sum, t) => sum + t.monthlyRent, 0);\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const filters = {\n        blockId: filterBlock,\n        propertyId: filterProperty,\n        status: filterStatus,\n        searchTerm,\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/reports/tenants/pdf\", filters);\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `tenants-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight flex items-center gap-2\">\n              <Users className=\"h-8 w-8 text-primary\" />\n              Tenants Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Tenant occupancy, lease tracking, and rental income analysis\n            </p>\n          </div>\n        </div>\n        <Button \n          onClick={handleExportPDF} \n          disabled={isExporting || filteredTenants.length === 0}\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              Generating...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-4 w-4\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Total Tenants</CardDescription>\n            <CardTitle className=\"text-3xl\" data-testid=\"stat-total-tenants\">{totalTenants}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Active</CardDescription>\n            <CardTitle className=\"text-3xl text-green-600\" data-testid=\"stat-active\">{activeTenants}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Expiring Soon</CardDescription>\n            <CardTitle className=\"text-3xl text-orange-600\" data-testid=\"stat-expiring\">{expiringSoon}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Total Monthly Rent</CardDescription>\n            <CardTitle className=\"text-3xl\" data-testid=\"stat-monthly-rent\">{totalMonthlyRent.toLocaleString()}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5\" />\n            Filters\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            <div className=\"space-y-2\">\n              <Label>Search</Label>\n              <Input\n                placeholder=\"Search tenant or property...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Block</Label>\n              <Select value={filterBlock} onValueChange={setFilterBlock}>\n                <SelectTrigger data-testid=\"select-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Blocks</SelectItem>\n                  {blocks.map((block) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Property</Label>\n              <Select value={filterProperty} onValueChange={setFilterProperty}>\n                <SelectTrigger data-testid=\"select-property\">\n                  <SelectValue placeholder=\"All properties\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Properties</SelectItem>\n                  {properties.map((property) => (\n                    <SelectItem key={property.id} value={property.id}>\n                      {property.unitNumber || property.address}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Status</Label>\n              <Select value={filterStatus} onValueChange={setFilterStatus}>\n                <SelectTrigger data-testid=\"select-status\">\n                  <SelectValue placeholder=\"All\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"active\">Active</SelectItem>\n                  <SelectItem value=\"expiring\">Expiring Soon (60 days)</SelectItem>\n                  <SelectItem value=\"expired\">Expired</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Tenants Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Tenant Assignments ({filteredTenants.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredTenants.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-tenants\">\n              No tenants found matching your criteria\n            </div>\n          ) : (\n            <div className=\"border rounded-lg overflow-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Tenant Name</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Block</TableHead>\n                    <TableHead>Property</TableHead>\n                    <TableHead>Lease Start</TableHead>\n                    <TableHead>Lease End</TableHead>\n                    <TableHead>Monthly Rent</TableHead>\n                    <TableHead>Status</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredTenants.map((tenant) => (\n                    <TableRow key={tenant.id} data-testid={`row-tenant-${tenant.id}`}>\n                      <TableCell className=\"font-medium\">\n                        {tenant.tenantFirstName} {tenant.tenantLastName}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {tenant.tenantEmail || \"N/A\"}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                          {tenant.block?.name || \"N/A\"}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <Home className=\"h-4 w-4 text-muted-foreground\" />\n                          {tenant.property?.unitNumber || \"N/A\"}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {tenant.leaseStartDate ? (\n                          format(new Date(tenant.leaseStartDate), 'MMM d, yyyy')\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {tenant.leaseEndDate ? (\n                          <div className=\"space-y-1\">\n                            <div>{format(new Date(tenant.leaseEndDate), 'MMM d, yyyy')}</div>\n                            {tenant.daysUntilExpiry !== null && tenant.daysUntilExpiry >= 0 && (\n                              <div className=\"text-xs text-muted-foreground\">\n                                {tenant.daysUntilExpiry} days left\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {tenant.monthlyRent > 0 ? (\n                          <span className=\"font-medium\">{tenant.monthlyRent.toLocaleString()}</span>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge \n                          variant={\n                            tenant.status === \"active\" \n                              ? \"default\" \n                              : tenant.isExpiringSoon \n                              ? \"outline\" \n                              : \"secondary\"\n                          }\n                        >\n                          {tenant.status === \"active\" && tenant.isExpiringSoon \n                            ? \"Expiring Soon\" \n                            : tenant.status === \"active\"\n                            ? \"Active\"\n                            : \"Inactive\"}\n                        </Badge>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":15635},"client/src/pages/PropertiesReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  Home, \n  ArrowLeft, \n  Filter,\n  Loader2,\n  Building2\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function PropertiesReport() {\n  const { toast } = useToast();\n  const [filterBlock, setFilterBlock] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: properties = [], isLoading: propertiesLoading } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [], isLoading: blocksLoading } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  const { data: inspections = [], isLoading: inspectionsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/inspections\"],\n  });\n\n  const { data: tenantAssignments = [], isLoading: tenantAssignmentsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/tenant-assignments\"],\n  });\n\n  const { data: maintenanceRequests = [], isLoading: maintenanceLoading } = useQuery<any[]>({\n    queryKey: [\"/api/maintenance\"],\n  });\n\n  const isLoading = propertiesLoading || blocksLoading || inspectionsLoading || tenantAssignmentsLoading || maintenanceLoading;\n\n  // Calculate statistics for each property\n  const propertiesWithStats = useMemo(() => {\n    return properties.map(property => {\n      const propertyInspections = inspections.filter(i => i.propertyId === property.id);\n      const latestInspection = propertyInspections.sort((a, b) => \n        new Date(b.scheduledDate || b.createdAt).getTime() - \n        new Date(a.scheduledDate || a.createdAt).getTime()\n      )[0];\n\n      const tenantAssignment = tenantAssignments.find(\n        t => t.propertyId === property.id && t.status === \"active\"\n      );\n\n      const propertyMaintenance = maintenanceRequests.filter(\n        m => m.propertyId === property.id\n      );\n      const openMaintenance = propertyMaintenance.filter(\n        m => m.status === \"open\" || m.status === \"in_progress\"\n      ).length;\n\n      return {\n        ...property,\n        block: blocks.find(b => b.id === property.blockId),\n        totalInspections: propertyInspections.length,\n        lastInspection: latestInspection,\n        isOccupied: !!tenantAssignment,\n        tenant: tenantAssignment,\n        openMaintenanceCount: openMaintenance,\n        totalMaintenanceCount: propertyMaintenance.length,\n      };\n    });\n  }, [properties, blocks, inspections, tenantAssignments, maintenanceRequests]);\n\n  // Filter properties\n  const filteredProperties = useMemo(() => {\n    let filtered = propertiesWithStats;\n\n    if (filterBlock !== \"all\") {\n      filtered = filtered.filter(p => p.blockId === filterBlock);\n    }\n\n    if (filterStatus !== \"all\") {\n      if (filterStatus === \"occupied\") {\n        filtered = filtered.filter(p => p.isOccupied);\n      } else if (filterStatus === \"vacant\") {\n        filtered = filtered.filter(p => !p.isOccupied);\n      }\n    }\n\n    if (searchTerm) {\n      const searchLower = searchTerm.toLowerCase();\n      filtered = filtered.filter(p => \n        p.address?.toLowerCase().includes(searchLower) ||\n        p.unitNumber?.toLowerCase().includes(searchLower) ||\n        p.block?.name?.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return filtered.sort((a, b) => {\n      // Sort by block name, then unit number\n      const blockCompare = (a.block?.name || \"\").localeCompare(b.block?.name || \"\");\n      if (blockCompare !== 0) return blockCompare;\n      return (a.unitNumber || \"\").localeCompare(b.unitNumber || \"\");\n    });\n  }, [propertiesWithStats, filterBlock, filterStatus, searchTerm]);\n\n  // Summary statistics\n  const totalProperties = filteredProperties.length;\n  const occupiedProperties = filteredProperties.filter(p => p.isOccupied).length;\n  const vacantProperties = filteredProperties.filter(p => !p.isOccupied).length;\n  const totalOpenMaintenance = filteredProperties.reduce((sum, p) => sum + p.openMaintenanceCount, 0);\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const filters = {\n        blockId: filterBlock,\n        status: filterStatus,\n        searchTerm,\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/reports/properties/pdf\", filters);\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `properties-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight flex items-center gap-2\">\n              <Home className=\"h-8 w-8 text-primary\" />\n              Properties Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Property portfolio overview with maintenance and inspection data\n            </p>\n          </div>\n        </div>\n        <Button \n          onClick={handleExportPDF} \n          disabled={isExporting || filteredProperties.length === 0}\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              Generating...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-4 w-4\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Total Properties</CardDescription>\n            <CardTitle className=\"text-3xl\" data-testid=\"stat-total-properties\">{totalProperties}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Occupied</CardDescription>\n            <CardTitle className=\"text-3xl text-green-600\" data-testid=\"stat-occupied\">{occupiedProperties}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Vacant</CardDescription>\n            <CardTitle className=\"text-3xl text-orange-600\" data-testid=\"stat-vacant\">{vacantProperties}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Open Maintenance</CardDescription>\n            <CardTitle className=\"text-3xl text-destructive\" data-testid=\"stat-open-maintenance\">{totalOpenMaintenance}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5\" />\n            Filters\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            <div className=\"space-y-2\">\n              <Label>Search</Label>\n              <Input\n                placeholder=\"Search address or unit...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Block</Label>\n              <Select value={filterBlock} onValueChange={setFilterBlock}>\n                <SelectTrigger data-testid=\"select-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Blocks</SelectItem>\n                  {blocks.map((block) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Occupancy Status</Label>\n              <Select value={filterStatus} onValueChange={setFilterStatus}>\n                <SelectTrigger data-testid=\"select-status\">\n                  <SelectValue placeholder=\"All\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"occupied\">Occupied</SelectItem>\n                  <SelectItem value=\"vacant\">Vacant</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Properties Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Properties ({filteredProperties.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredProperties.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-properties\">\n              No properties found matching your criteria\n            </div>\n          ) : (\n            <div className=\"border rounded-lg\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Block</TableHead>\n                    <TableHead>Unit</TableHead>\n                    <TableHead>Address</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Tenant</TableHead>\n                    <TableHead>Inspections</TableHead>\n                    <TableHead>Maintenance</TableHead>\n                    <TableHead>Last Inspection</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredProperties.map((property) => (\n                    <TableRow key={property.id} data-testid={`row-property-${property.id}`}>\n                      <TableCell className=\"font-medium\" data-testid={`text-block-${property.id}`}>\n                        <div className=\"flex items-center gap-2\">\n                          <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                          {property.block?.name || \"N/A\"}\n                        </div>\n                      </TableCell>\n                      <TableCell data-testid={`text-unit-${property.id}`}>{property.unitNumber || \"N/A\"}</TableCell>\n                      <TableCell className=\"max-w-xs truncate\" data-testid={`text-address-${property.id}`}>\n                        {property.address}\n                      </TableCell>\n                      <TableCell data-testid={`badge-status-${property.id}`}>\n                        <Badge variant={property.isOccupied ? \"default\" : \"secondary\"}>\n                          {property.isOccupied ? \"Occupied\" : \"Vacant\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell data-testid={`text-tenant-${property.id}`}>\n                        {property.tenant ? (\n                          <span className=\"text-sm\">\n                            {property.tenant.tenantFirstName} {property.tenant.tenantLastName}\n                          </span>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell data-testid={`badge-inspections-${property.id}`}>\n                        <Badge variant=\"outline\">\n                          {property.totalInspections}\n                        </Badge>\n                      </TableCell>\n                      <TableCell data-testid={`badge-maintenance-${property.id}`}>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant={property.openMaintenanceCount > 0 ? \"destructive\" : \"outline\"}>\n                            {property.openMaintenanceCount} open\n                          </Badge>\n                        </div>\n                      </TableCell>\n                      <TableCell data-testid={`text-last-inspection-${property.id}`}>\n                        {property.lastInspection ? (\n                          <span className=\"text-sm\">\n                            {format(new Date(property.lastInspection.scheduledDate || property.lastInspection.createdAt), 'MMM d, yyyy')}\n                          </span>\n                        ) : (\n                          <span className=\"text-muted-foreground\">Never</span>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":14510},"client/src/pages/ComplianceReport.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  FileDown, \n  ShieldCheck, \n  ArrowLeft, \n  Filter,\n  Loader2,\n  Building2,\n  Home,\n  Calendar,\n  AlertTriangle\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format, differenceInDays, isPast } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function ComplianceReport() {\n  const { toast } = useToast();\n  const [filterBlock, setFilterBlock] = useState<string>(\"all\");\n  const [filterProperty, setFilterProperty] = useState<string>(\"all\");\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isExporting, setIsExporting] = useState(false);\n\n  const { data: complianceDocuments = [], isLoading: documentsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/compliance\"],\n  });\n\n  const { data: properties = [], isLoading: propertiesLoading } = useQuery<any[]>({\n    queryKey: [\"/api/properties\"],\n  });\n\n  const { data: blocks = [], isLoading: blocksLoading } = useQuery<any[]>({\n    queryKey: [\"/api/blocks\"],\n  });\n\n  const isLoading = documentsLoading || propertiesLoading || blocksLoading;\n\n  // Get unique document types\n  const documentTypes = useMemo(() => {\n    const types = new Set<string>();\n    complianceDocuments.forEach(doc => {\n      if (doc.documentType) types.add(doc.documentType);\n    });\n    return Array.from(types).sort();\n  }, [complianceDocuments]);\n\n  // Enrich documents with property and block information\n  const enrichedDocuments = useMemo(() => {\n    return complianceDocuments.map(doc => {\n      const property = properties.find(p => p.id === doc.propertyId);\n      const block = property ? blocks.find(b => b.id === property.blockId) : \n                    blocks.find(b => b.id === doc.blockId);\n\n      let status = \"current\";\n      let daysUntilExpiry = null;\n\n      if (doc.expiryDate) {\n        const expiryDate = new Date(doc.expiryDate);\n        daysUntilExpiry = differenceInDays(expiryDate, new Date());\n        \n        if (isPast(expiryDate)) {\n          status = \"expired\";\n        } else if (daysUntilExpiry <= 30) {\n          status = \"expiring-soon\";\n        } else {\n          status = \"current\";\n        }\n      }\n\n      return {\n        ...doc,\n        property,\n        block,\n        status,\n        daysUntilExpiry,\n      };\n    });\n  }, [complianceDocuments, properties, blocks]);\n\n  // Filter documents\n  const filteredDocuments = useMemo(() => {\n    let filtered = enrichedDocuments;\n\n    if (filterBlock !== \"all\") {\n      filtered = filtered.filter(d => \n        d.blockId === filterBlock || d.property?.blockId === filterBlock\n      );\n    }\n\n    if (filterProperty !== \"all\") {\n      filtered = filtered.filter(d => d.propertyId === filterProperty);\n    }\n\n    if (filterType !== \"all\") {\n      filtered = filtered.filter(d => d.documentType === filterType);\n    }\n\n    if (filterStatus !== \"all\") {\n      filtered = filtered.filter(d => d.status === filterStatus);\n    }\n\n    if (searchTerm) {\n      const searchLower = searchTerm.toLowerCase();\n      filtered = filtered.filter(d => \n        d.documentType?.toLowerCase().includes(searchLower) ||\n        d.property?.address?.toLowerCase().includes(searchLower) ||\n        d.property?.unitNumber?.toLowerCase().includes(searchLower) ||\n        d.block?.name?.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return filtered.sort((a, b) => {\n      // Sort by status (expired first, then expiring soon, then current), then by expiry date\n      const statusOrder = { \"expired\": 0, \"expiring-soon\": 1, \"current\": 2 };\n      const statusCompare = statusOrder[a.status as keyof typeof statusOrder] - \n                           statusOrder[b.status as keyof typeof statusOrder];\n      if (statusCompare !== 0) return statusCompare;\n\n      // Then by expiry date\n      if (a.expiryDate && b.expiryDate) {\n        return new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime();\n      }\n      if (a.expiryDate) return -1;\n      if (b.expiryDate) return 1;\n      \n      // Finally by document type\n      return (a.documentType || \"\").localeCompare(b.documentType || \"\");\n    });\n  }, [enrichedDocuments, filterBlock, filterProperty, filterType, filterStatus, searchTerm]);\n\n  // Summary statistics\n  const totalDocuments = filteredDocuments.length;\n  const currentDocuments = filteredDocuments.filter(d => d.status === \"current\").length;\n  const expiringSoon = filteredDocuments.filter(d => d.status === \"expiring-soon\").length;\n  const expired = filteredDocuments.filter(d => d.status === \"expired\").length;\n\n  const handleExportPDF = async () => {\n    setIsExporting(true);\n    try {\n      const filters = {\n        blockId: filterBlock,\n        propertyId: filterProperty,\n        documentType: filterType,\n        status: filterStatus,\n        searchTerm,\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/reports/compliance/pdf\", filters);\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `compliance-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Report exported\",\n        description: \"Your PDF report has been downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to generate PDF report. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/reports\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight flex items-center gap-2\">\n              <ShieldCheck className=\"h-8 w-8 text-primary\" />\n              Compliance Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Document tracking and compliance management by block and property\n            </p>\n          </div>\n        </div>\n        <Button \n          onClick={handleExportPDF} \n          disabled={isExporting || filteredDocuments.length === 0}\n          data-testid=\"button-export-pdf\"\n        >\n          {isExporting ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              Generating...\n            </>\n          ) : (\n            <>\n              <FileDown className=\"mr-2 h-4 w-4\" />\n              Export PDF\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Summary Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Total Documents</CardDescription>\n            <CardTitle className=\"text-3xl\" data-testid=\"stat-total-documents\">{totalDocuments}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Current</CardDescription>\n            <CardTitle className=\"text-3xl text-green-600\" data-testid=\"stat-current\">{currentDocuments}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Expiring Soon</CardDescription>\n            <CardTitle className=\"text-3xl text-orange-600\" data-testid=\"stat-expiring-soon\">{expiringSoon}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardDescription>Expired</CardDescription>\n            <CardTitle className=\"text-3xl text-destructive\" data-testid=\"stat-expired\">{expired}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5\" />\n            Filters\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid gap-4 md:grid-cols-5\">\n            <div className=\"space-y-2\">\n              <Label>Search</Label>\n              <Input\n                placeholder=\"Search documents...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Block</Label>\n              <Select value={filterBlock} onValueChange={setFilterBlock}>\n                <SelectTrigger data-testid=\"select-block\">\n                  <SelectValue placeholder=\"All blocks\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Blocks</SelectItem>\n                  {blocks.map((block) => (\n                    <SelectItem key={block.id} value={block.id}>\n                      {block.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Property</Label>\n              <Select value={filterProperty} onValueChange={setFilterProperty}>\n                <SelectTrigger data-testid=\"select-property\">\n                  <SelectValue placeholder=\"All properties\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Properties</SelectItem>\n                  {properties.map((property) => (\n                    <SelectItem key={property.id} value={property.id}>\n                      {property.unitNumber || property.address}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Document Type</Label>\n              <Select value={filterType} onValueChange={setFilterType}>\n                <SelectTrigger data-testid=\"select-type\">\n                  <SelectValue placeholder=\"All types\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Types</SelectItem>\n                  {documentTypes.map((type) => (\n                    <SelectItem key={type} value={type}>\n                      {type}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Status</Label>\n              <Select value={filterStatus} onValueChange={setFilterStatus}>\n                <SelectTrigger data-testid=\"select-status\">\n                  <SelectValue placeholder=\"All statuses\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"current\">Current</SelectItem>\n                  <SelectItem value=\"expiring-soon\">Expiring Soon (30 days)</SelectItem>\n                  <SelectItem value=\"expired\">Expired</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Documents Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Compliance Documents ({filteredDocuments.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : filteredDocuments.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-documents\">\n              No compliance documents found matching your criteria\n            </div>\n          ) : (\n            <div className=\"border rounded-lg overflow-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Document Type</TableHead>\n                    <TableHead>Location</TableHead>\n                    <TableHead>Block</TableHead>\n                    <TableHead>Property</TableHead>\n                    <TableHead>Expiry Date</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Uploaded</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredDocuments.map((doc) => (\n                    <TableRow key={doc.id} data-testid={`row-document-${doc.id}`}>\n                      <TableCell className=\"font-medium\">\n                        {doc.documentType}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">\n                          {doc.blockId && !doc.propertyId ? \"Block-Level\" : \"Property-Level\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {doc.block ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                            {doc.block.name}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {doc.property ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Home className=\"h-4 w-4 text-muted-foreground\" />\n                            {doc.property.unitNumber}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {doc.expiryDate ? (\n                          <div className=\"space-y-1\">\n                            <div className=\"flex items-center gap-2\">\n                              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                              {format(new Date(doc.expiryDate), 'MMM d, yyyy')}\n                            </div>\n                            {doc.daysUntilExpiry !== null && doc.daysUntilExpiry >= 0 && (\n                              <div className=\"text-xs text-muted-foreground\">\n                                {doc.daysUntilExpiry} days left\n                              </div>\n                            )}\n                            {doc.daysUntilExpiry !== null && doc.daysUntilExpiry < 0 && (\n                              <div className=\"text-xs text-destructive flex items-center gap-1\">\n                                <AlertTriangle className=\"h-3 w-3\" />\n                                {Math.abs(doc.daysUntilExpiry)} days overdue\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">No expiry</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge \n                          variant={\n                            doc.status === \"expired\" \n                              ? \"destructive\" \n                              : doc.status === \"expiring-soon\" \n                              ? \"outline\" \n                              : \"default\"\n                          }\n                        >\n                          {doc.status === \"expired\" \n                            ? \"Expired\" \n                            : doc.status === \"expiring-soon\"\n                            ? \"Expiring Soon\"\n                            : \"Current\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {doc.createdAt ? (\n                          format(new Date(doc.createdAt), 'MMM d, yyyy')\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":17578},"client/src/components/AddressInput.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface AddressInputProps {\n  value?: string;\n  defaultValue?: string;\n  onChange?: (value: string) => void;\n  name?: string; // For form integration\n  placeholder?: string;\n  id?: string;\n  required?: boolean;\n  className?: string;\n  \"data-testid\"?: string;\n}\n\n// Load Google Maps script\nfunction loadGoogleMapsScript(apiKey: string): Promise<void> {\n  return new Promise((resolve, reject) => {\n    // Check if script is already loaded\n    if (window.google && window.google.maps && window.google.maps.places) {\n      console.log('[AddressInput] Google Maps already loaded');\n      resolve();\n      return;\n    }\n\n    // Check if script is already being loaded\n    const existingScript = document.querySelector(`script[src*=\"maps.googleapis.com\"]`);\n    if (existingScript) {\n      console.log('[AddressInput] Google Maps script already loading, waiting...');\n      existingScript.addEventListener('load', () => {\n        console.log('[AddressInput] Existing script loaded');\n        resolve();\n      });\n      existingScript.addEventListener('error', () => {\n        console.error('[AddressInput] Existing script failed to load');\n        reject(new Error('Failed to load Google Maps script'));\n      });\n      return;\n    }\n\n    // Create and load script\n    console.log('[AddressInput] Creating new Google Maps script tag');\n    const script = document.createElement('script');\n    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;\n    script.async = true;\n    script.defer = true;\n    script.onload = () => {\n      console.log('[AddressInput] Google Maps script loaded successfully');\n      resolve();\n    };\n    script.onerror = (error) => {\n      console.error('[AddressInput] Failed to load Google Maps script:', error);\n      reject(new Error('Failed to load Google Maps script'));\n    };\n    document.head.appendChild(script);\n    console.log('[AddressInput] Google Maps script tag added to head');\n  });\n}\n\n// Fetch Google Maps API key from server\nasync function getGoogleMapsApiKey(): Promise<string | null> {\n  try {\n    const response = await fetch('/api/config/google-maps-key', { credentials: 'include' });\n    if (!response.ok) {\n      console.error('[AddressInput] Failed to fetch API key, status:', response.status);\n      // If server error, return null to allow manual input\n      return null;\n    }\n    const data = await response.json();\n    console.log('[AddressInput] API key response:', { \n      configured: data.configured, \n      hasApiKey: !!data.apiKey,\n      apiKeyLength: data.apiKey?.length || 0 \n    });\n    // Return null if not configured, so component can work without autocomplete\n    return data.apiKey || null;\n  } catch (error) {\n    console.error('[AddressInput] Error fetching API key:', error);\n    return null;\n  }\n}\n\nexport function AddressInput({\n  value,\n  defaultValue,\n  onChange,\n  name,\n  placeholder = \"Enter address...\",\n  id,\n  required,\n  className,\n  \"data-testid\": dataTestId,\n}: AddressInputProps) {\n  const { countryCode } = useLocale();\n  const inputRef = useRef<HTMLInputElement>(null);\n  const autocompleteRef = useRef<google.maps.places.Autocomplete | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [internalValue, setInternalValue] = useState(value || defaultValue || \"\");\n  \n  // Use controlled value if provided, otherwise use internal state\n  const currentValue = value !== undefined ? value : internalValue;\n\n  // Fetch API key\n  const { data: apiKey, isLoading: isLoadingKey, error: apiKeyError } = useQuery({\n    queryKey: ['google-maps-api-key'],\n    queryFn: getGoogleMapsApiKey,\n    staleTime: Infinity, // API key doesn't change\n    retry: false, // Don't retry if API key is not configured\n    // Don't block input if API key fetch fails - allow manual entry\n    onError: (error) => {\n      console.warn('[AddressInput] Failed to fetch API key:', error);\n      setIsLoading(false);\n    },\n    onSuccess: (key) => {\n      console.log('[AddressInput] API key fetched:', key ? 'configured' : 'not configured');\n      // If API key is null (not configured), enable input immediately\n      if (!key) {\n        console.warn('[AddressInput] Google Maps API key not configured. Address autocomplete will not be available.');\n        setIsLoading(false);\n      }\n    },\n  });\n\n  // Initialize Google Maps Autocomplete\n  useEffect(() => {\n    // If still loading key, wait\n    if (isLoadingKey) {\n      setIsLoading(true);\n      return;\n    }\n\n    // If no API key (null or undefined), allow manual input\n    if (!apiKey) {\n      console.log('[AddressInput] No API key available, allowing manual input only');\n      setIsLoading(false);\n      return;\n    }\n\n    // Wait for input ref to be available\n    if (!inputRef.current) {\n      console.log('[AddressInput] Input ref not available yet, waiting...');\n      // Use a small timeout to wait for the input to be mounted\n      const timeout = setTimeout(() => {\n        if (inputRef.current) {\n          console.log('[AddressInput] Input ref now available');\n        }\n      }, 100);\n      return () => clearTimeout(timeout);\n    }\n\n    let mounted = true;\n\n    const initializeAutocomplete = async () => {\n      try {\n        setIsLoading(true);\n        setError(null);\n\n        console.log('[AddressInput] Loading Google Maps script with API key:', apiKey ? `${apiKey.substring(0, 10)}...` : 'none');\n\n        // Load Google Maps script\n        await loadGoogleMapsScript(apiKey);\n\n        console.log('[AddressInput] Google Maps script loaded successfully');\n\n        if (!mounted || !inputRef.current) {\n          console.warn('[AddressInput] Component unmounted or input ref not available after script load');\n          setIsLoading(false);\n          return;\n        }\n\n        // Verify Google Maps is loaded\n        if (!window.google || !window.google.maps || !window.google.maps.places) {\n          console.error('[AddressInput] Google Maps Places API not available after script load');\n          throw new Error('Google Maps Places API not loaded');\n        }\n\n        console.log('[AddressInput] Creating Autocomplete instance for country:', countryCode);\n        \n        // Create autocomplete instance\n        const autocomplete = new google.maps.places.Autocomplete(inputRef.current, {\n          componentRestrictions: { country: countryCode.toLowerCase() }, // Restrict to user's country\n          fields: ['formatted_address', 'address_components', 'geometry'],\n          types: ['address'], // Focus on addresses\n        });\n\n        autocompleteRef.current = autocomplete;\n\n        // Debug: Log autocomplete initialization\n        console.log('[AddressInput] Google Maps Autocomplete initialized successfully for country:', countryCode);\n        \n        // Test that autocomplete is working\n        console.log('[AddressInput] Autocomplete instance created:', !!autocomplete);\n\n        // Handle place selection\n        autocomplete.addListener('place_changed', () => {\n          const place = autocomplete.getPlace();\n          console.log('[AddressInput] Place selected:', place.formatted_address);\n          if (place.formatted_address) {\n            const addressValue = place.formatted_address;\n            setInternalValue(addressValue);\n            if (onChange) {\n              onChange(addressValue);\n            }\n            // Update form field if name is provided\n            if (name && inputRef.current) {\n              inputRef.current.value = addressValue;\n              // Trigger input event for form libraries\n              inputRef.current.dispatchEvent(new Event('input', { bubbles: true }));\n            }\n          }\n        });\n\n        setIsLoading(false);\n        console.log('[AddressInput] Autocomplete setup complete - ready for user input');\n      } catch (err) {\n        console.error('[AddressInput] Failed to initialize Google Maps:', err);\n        console.error('[AddressInput] Error details:', {\n          apiKey: apiKey ? 'present' : 'missing',\n          countryCode,\n          hasInput: !!inputRef.current,\n          googleMapsLoaded: !!(window.google && window.google.maps),\n        });\n        // Don't show error to user - just allow manual input\n        setError(null);\n        setIsLoading(false);\n      }\n    };\n\n    initializeAutocomplete();\n\n    return () => {\n      mounted = false;\n      if (autocompleteRef.current) {\n        try {\n          google.maps.event.clearInstanceListeners(autocompleteRef.current);\n        } catch (e) {\n          console.warn('[AddressInput] Error clearing listeners:', e);\n        }\n        autocompleteRef.current = null;\n      }\n    };\n  }, [apiKey, isLoadingKey, countryCode, onChange, name]);\n\n  // Only disable if actively loading AND we have an API key to load\n  // If no API key, allow manual input\n  const shouldDisable = isLoading && apiKey !== undefined;\n\n  return (\n    <div className=\"relative\">\n      <Input\n        ref={inputRef}\n        id={id}\n        name={name}\n        value={currentValue}\n        defaultValue={defaultValue}\n        onChange={(e) => {\n          const newValue = e.target.value;\n          setInternalValue(newValue);\n          if (onChange) {\n            onChange(newValue);\n          }\n        }}\n        placeholder={isLoading && apiKey ? \"Loading address suggestions...\" : placeholder}\n        required={required}\n        className={className}\n        data-testid={dataTestId}\n        disabled={shouldDisable}\n      />\n      {error && (\n        <p className=\"text-xs text-destructive mt-1\">{error}</p>\n      )}\n      {apiKeyError && (\n        <p className=\"text-xs text-muted-foreground mt-1\">\n          Address suggestions unavailable. You can still type the address manually.\n        </p>\n      )}\n    </div>\n  );\n}\n\n","size_bytes":10002},"DEPLOYMENT.md":{"content":"# Inspect360 - Deployment Guide\n\nThis guide will help you deploy Inspect360 to any server or hosting platform.\n\n## Table of Contents\n\n1. [Prerequisites](#prerequisites)\n2. [Required External Services](#required-external-services)\n3. [Installation Steps](#installation-steps)\n4. [Environment Configuration](#environment-configuration)\n5. [Database Setup](#database-setup)\n6. [Building for Production](#building-for-production)\n7. [Running in Production](#running-in-production)\n8. [Deployment Platforms](#deployment-platforms)\n9. [Troubleshooting](#troubleshooting)\n\n---\n\n## Prerequisites\n\n- **Node.js**: Version 20.x or higher\n- **npm**: Version 10.x or higher\n- **PostgreSQL**: Version 14 or higher (or a managed PostgreSQL service)\n- **Storage**: At least 5GB for local file storage (more if expecting many uploads)\n- **Memory**: Minimum 2GB RAM recommended\n\n---\n\n## Required External Services\n\nBefore deployment, you'll need API keys from these services:\n\n### 1. PostgreSQL Database (REQUIRED)\n**Recommended Providers:**\n- [Neon](https://neon.tech) - Serverless PostgreSQL (Free tier available)\n- [Supabase](https://supabase.com) - Open source Firebase alternative\n- [Railway](https://railway.app) - Simple PostgreSQL hosting\n- Self-hosted PostgreSQL\n\n**What you need:**\n- Database connection string (format: `postgresql://user:password@host:port/database`)\n\n### 2. Stripe (REQUIRED for payments)\n**Sign up at:** https://stripe.com\n\n**What you need:**\n- Secret Key (`sk_test_...` for testing, `sk_live_...` for production)\n- Publishable Key (`pk_test_...` for testing, `pk_live_...` for production)\n- Webhook Secret (from Stripe Dashboard  Developers  Webhooks)\n\n**Setup steps:**\n1. Create a Stripe account\n2. Get your API keys from Dashboard  Developers  API keys\n3. Set up a webhook endpoint at `https://yourdomain.com/api/stripe/webhook`\n4. Copy the webhook signing secret\n\n### 3. Resend (REQUIRED for email)\n**Sign up at:** https://resend.com\n\n**What you need:**\n- API Key\n- Verified sending domain\n\n**Setup steps:**\n1. Create a Resend account\n2. Add and verify your domain (e.g., `yourdomain.com`)\n3. Create an API key\n4. Set your from email (e.g., `noreply@yourdomain.com`)\n\n**Important:** Emails will fail until your domain is verified!\n\n### 4. OpenAI (REQUIRED for AI features)\n**Sign up at:** https://platform.openai.com\n\n**What you need:**\n- API Key\n\n**Setup steps:**\n1. Create an OpenAI account\n2. Add billing information (usage-based pricing)\n3. Generate an API key from API Keys section\n\n**Note:** The application uses GPT-4 Vision for:\n- Inspection photo analysis\n- Comparison report generation\n- Maintenance request triage\n- AI chatbot responses\n\n---\n\n## Installation Steps\n\n### 1. Download the Project\n\n```bash\n# If you received a ZIP file, extract it\nunzip inspect360.zip\ncd inspect360\n\n# Or clone from repository\ngit clone <repository-url>\ncd inspect360\n```\n\n### 2. Install Dependencies\n\n```bash\nnpm install\n```\n\n### 3. Configure Environment Variables\n\n```bash\n# Copy the example environment file\ncp .env.example .env\n\n# Edit .env with your actual values\nnano .env  # or use your preferred editor\n```\n\nSee [Environment Configuration](#environment-configuration) section for details.\n\n---\n\n## Environment Configuration\n\nEdit your `.env` file with the following required values:\n\n```bash\n# =============================================================================\n# DATABASE (REQUIRED)\n# =============================================================================\nDATABASE_URL=postgresql://user:password@host:port/database?sslmode=require\n\n# =============================================================================\n# SESSION (REQUIRED)\n# =============================================================================\n# Generate a random secret:\n# node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\"\nSESSION_SECRET=your-generated-random-secret-here\n\n# =============================================================================\n# STRIPE (REQUIRED)\n# =============================================================================\nSTRIPE_SECRET_KEY=sk_live_your_stripe_secret_key\nSTRIPE_PUBLISHABLE_KEY=pk_live_your_stripe_publishable_key\nSTRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret\n\n# =============================================================================\n# RESEND (REQUIRED)\n# =============================================================================\nRESEND_API_KEY=re_your_resend_api_key\nRESEND_FROM_EMAIL=noreply@yourdomain.com\n\n# =============================================================================\n# OPENAI (REQUIRED)\n# =============================================================================\nAI_INTEGRATIONS_OPENAI_BASE_URL=https://api.openai.com/v1\nAI_INTEGRATIONS_OPENAI_API_KEY=sk-your-openai-api-key\n\n# =============================================================================\n# SERVER (OPTIONAL)\n# =============================================================================\nPORT=5000\nNODE_ENV=production\n\n# =============================================================================\n# STORAGE (OPTIONAL - defaults shown)\n# =============================================================================\nLOCAL_STORAGE_DIR=./storage\nPRIVATE_OBJECT_DIR=private\nPUBLIC_OBJECT_SEARCH_PATHS=public\n```\n\n---\n\n## Database Setup\n\n### 1. Create PostgreSQL Database\n\nUsing Neon (recommended):\n```bash\n# 1. Sign up at https://neon.tech\n# 2. Create a new project\n# 3. Copy the connection string\n# 4. Add it to your .env file as DATABASE_URL\n```\n\nOr use any PostgreSQL provider and get the connection string.\n\n### 2. Initialize Database Schema\n\n```bash\n# This will create all tables and schema\nnpm run db:push\n```\n\nIf you get a warning about data loss, use:\n```bash\nnpm run db:push --force\n```\n\n**Note:** The database migration system uses Drizzle ORM. Never manually write SQL migrations.\n\n---\n\n## Building for Production\n\n### 1. Build the Application\n\n```bash\nnpm run build\n```\n\nThis will:\n- Build the frontend (Vite)  `dist/public`\n- Build the backend (esbuild)  `dist/index.js`\n\n### 2. Test the Production Build\n\n```bash\nnpm start\n```\n\nVisit `http://localhost:5000` to verify everything works.\n\n---\n\n## Running in Production\n\n### Option 1: Using PM2 (Recommended)\n\nPM2 is a production process manager for Node.js:\n\n```bash\n# Install PM2 globally\nnpm install -g pm2\n\n# Start the application\npm2 start npm --name \"inspect360\" -- start\n\n# Save the PM2 process list\npm2 save\n\n# Setup PM2 to start on system boot\npm2 startup\n\n# View logs\npm2 logs inspect360\n\n# Monitor\npm2 monit\n```\n\n### Option 2: Using systemd (Linux)\n\nCreate `/etc/systemd/system/inspect360.service`:\n\n```ini\n[Unit]\nDescription=Inspect360 Application\nAfter=network.target\n\n[Service]\nType=simple\nUser=your-username\nWorkingDirectory=/path/to/inspect360\nEnvironment=NODE_ENV=production\nExecStart=/usr/bin/npm start\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n```\n\nThen:\n```bash\nsudo systemctl enable inspect360\nsudo systemctl start inspect360\nsudo systemctl status inspect360\n```\n\n### Option 3: Using Docker\n\nCreate a `Dockerfile`:\n\n```dockerfile\nFROM node:20-alpine\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\n\n# Install dependencies\nRUN npm ci --only=production\n\n# Copy application files\nCOPY . .\n\n# Build the application\nRUN npm run build\n\n# Expose port\nEXPOSE 5000\n\n# Start the application\nCMD [\"npm\", \"start\"]\n```\n\nBuild and run:\n```bash\ndocker build -t inspect360 .\ndocker run -p 5000:5000 --env-file .env inspect360\n```\n\n---\n\n## Deployment Platforms\n\n### Railway\n\n1. Install Railway CLI: `npm install -g @railway/cli`\n2. Login: `railway login`\n3. Initialize: `railway init`\n4. Add environment variables: `railway variables set DATABASE_URL=...`\n5. Deploy: `railway up`\n\n### Render\n\n1. Create a new Web Service\n2. Connect your repository\n3. Set build command: `npm install && npm run build`\n4. Set start command: `npm start`\n5. Add environment variables in dashboard\n\n### DigitalOcean App Platform\n\n1. Create a new app from GitHub/GitLab\n2. Set build command: `npm run build`\n3. Set run command: `npm start`\n4. Add environment variables\n5. Deploy\n\n### AWS / Google Cloud / Azure\n\nFor cloud platforms, you'll want to:\n1. Set up a VM (EC2, Compute Engine, Azure VM)\n2. Install Node.js and npm\n3. Clone the repository\n4. Follow the [Running in Production](#running-in-production) section\n5. Set up a reverse proxy (Nginx or Apache)\n6. Configure SSL with Let's Encrypt\n\n---\n\n## Reverse Proxy Setup (Optional but Recommended)\n\n### Using Nginx\n\n```nginx\nserver {\n    listen 80;\n    server_name yourdomain.com;\n\n    location / {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n```\n\n### Enable SSL with Certbot\n\n```bash\nsudo apt install certbot python3-certbot-nginx\nsudo certbot --nginx -d yourdomain.com\n```\n\n---\n\n## File Storage\n\nThe application uses **local file system storage** by default. Files are stored in:\n- `./storage/private/` - Private files (inspections, compliance docs)\n- `./storage/public/` - Public files (if any)\n\n### Important Notes:\n\n1. **Ensure storage directory is writable:**\n   ```bash\n   mkdir -p storage/private storage/public\n   chmod -R 755 storage\n   ```\n\n2. **Backup strategy:**\n   - Set up regular backups of the `./storage` directory\n   - Consider using `rsync` or cloud backup services\n\n3. **For horizontal scaling:**\n   - Use shared network storage (NFS, EFS, etc.)\n   - Or migrate to Google Cloud Storage (GCS) - code is ready, just needs credentials\n\n---\n\n## Stripe Webhook Configuration\n\nAfter deployment, configure your Stripe webhook:\n\n1. Go to Stripe Dashboard  Developers  Webhooks\n2. Click \"Add endpoint\"\n3. Set URL to: `https://yourdomain.com/api/stripe/webhook`\n4. Select events to listen for:\n   - `checkout.session.completed`\n   - `customer.subscription.created`\n   - `customer.subscription.updated`\n   - `customer.subscription.deleted`\n5. Copy the signing secret to `STRIPE_WEBHOOK_SECRET` in your `.env`\n\n---\n\n## Initial Setup After Deployment\n\n### 1. Create Admin Account\n\nThe first user to register will need to be promoted to admin manually:\n\n```bash\n# Connect to your database and run:\nUPDATE users SET role = 'admin' WHERE email = 'your-email@example.com';\n```\n\n### 2. Set Up Subscription Plans\n\n1. Log in as admin\n2. Navigate to Eco-Admin  Plans\n3. Create your subscription plans and credit bundles\n4. Link them to Stripe prices\n\n### 3. Configure Email Templates\n\n1. Navigate to Settings  Message Templates\n2. Create templates for broadcast messages\n3. Test email sending\n\n---\n\n## Monitoring and Logs\n\n### Application Logs\n\nIf using PM2:\n```bash\npm2 logs inspect360\n```\n\nIf using systemd:\n```bash\njournalctl -u inspect360 -f\n```\n\n### Important Metrics to Monitor\n\n- **Server CPU and Memory** - Should stay below 80%\n- **Database connections** - Monitor connection pool\n- **Storage space** - `./storage` directory growth\n- **Email delivery** - Check Resend dashboard for failures\n- **AI API usage** - Monitor OpenAI usage and costs\n\n---\n\n## Troubleshooting\n\n### Database Connection Errors\n\n```\nError: DATABASE_URL not found\n```\n**Solution:** Ensure `DATABASE_URL` is set in `.env`\n\n### Email Sending Failures\n\n```\nError: Resend not connected\n```\n**Solutions:**\n1. Verify `RESEND_API_KEY` is set\n2. Ensure domain is verified in Resend dashboard\n3. Check `RESEND_FROM_EMAIL` matches verified domain\n\n### Stripe Payment Issues\n\n```\nError: Stripe credentials not configured\n```\n**Solutions:**\n1. Set `STRIPE_SECRET_KEY` and `STRIPE_PUBLISHABLE_KEY`\n2. Ensure webhook secret is correct\n3. Verify webhook endpoint is accessible\n\n### AI Features Not Working\n\n```\nError: OpenAI integration not configured\n```\n**Solutions:**\n1. Set `AI_INTEGRATIONS_OPENAI_API_KEY`\n2. Set `AI_INTEGRATIONS_OPENAI_BASE_URL=https://api.openai.com/v1`\n3. Verify OpenAI API key has credits\n\n### Build Failures\n\n```\nError: Cannot find module\n```\n**Solution:** Run `npm install` again\n\n### Port Already in Use\n\n```\nError: EADDRINUSE\n```\n**Solution:** Change `PORT` in `.env` or kill the process using port 5000\n\n---\n\n## Security Checklist\n\nBefore going live:\n\n- [ ] Set strong `SESSION_SECRET` (32+ random characters)\n- [ ] Use production Stripe keys (not test keys)\n- [ ] Enable HTTPS (SSL certificate)\n- [ ] Configure firewall rules\n- [ ] Set up database backups\n- [ ] Enable rate limiting (already built-in)\n- [ ] Review CORS settings if needed\n- [ ] Set `NODE_ENV=production`\n- [ ] Don't commit `.env` file to version control\n- [ ] Restrict database access to your server IP only\n- [ ] Set up monitoring and alerts\n\n---\n\n## Backup Strategy\n\n### Database Backups\n\n```bash\n# Backup PostgreSQL database\npg_dump $DATABASE_URL > backup-$(date +%Y%m%d).sql\n\n# Restore from backup\npsql $DATABASE_URL < backup-20231122.sql\n```\n\n### File Storage Backups\n\n```bash\n# Backup storage directory\ntar -czf storage-backup-$(date +%Y%m%d).tar.gz storage/\n\n# Restore\ntar -xzf storage-backup-20231122.tar.gz\n```\n\n### Automated Backups\n\nSet up a cron job:\n```bash\n# Edit crontab\ncrontab -e\n\n# Add daily backup at 2 AM\n0 2 * * * cd /path/to/inspect360 && ./backup.sh\n```\n\n---\n\n## Scaling Considerations\n\n### Horizontal Scaling\n\nTo run multiple instances:\n\n1. **Database:** Already supports multiple connections\n2. **Session Store:** Currently uses in-memory - migrate to Redis for multi-instance\n3. **File Storage:** Use shared storage (NFS) or migrate to Google Cloud Storage\n4. **Load Balancer:** Use Nginx, HAProxy, or cloud load balancer\n\n### Performance Optimization\n\n- Enable caching for static assets\n- Use CDN for frontend assets\n- Optimize database queries\n- Monitor and optimize AI API usage\n- Consider PostgreSQL read replicas for reporting\n\n---\n\n## Support and Documentation\n\n- **Project Documentation:** See `replit.md` for architecture details\n- **API Documentation:** See `server/routes.ts` for all endpoints\n- **Database Schema:** See `shared/schema.ts`\n- **Frontend Components:** See `client/src/components/`\n\n---\n\n## Version Information\n\n- **Node.js:** 20.x+\n- **PostgreSQL:** 14+\n- **Framework:** Express.js + React + Vite\n- **ORM:** Drizzle ORM\n- **Styling:** Tailwind CSS + Shadcn UI\n\n---\n\n## License\n\nThis project is proprietary software. See LICENSE file for details.\n\n---\n\n**Last Updated:** November 2024\n\nFor questions or issues during deployment, refer to the troubleshooting section or contact your development team.\n","size_bytes":14558},"client/src/pages/ResetPassword.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Loader2, ArrowLeft, CheckCircle2, Eye, EyeOff, Lock, FileCheck, Building2 } from \"lucide-react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function ResetPassword() {\n  const searchParams = useSearch();\n  const urlParams = new URLSearchParams(searchParams);\n  const emailFromUrl = urlParams.get(\"email\");\n  \n  const [email, setEmail] = useState(\"\");\n  const [token, setToken] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showNewPassword, setShowNewPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n\n  // Pre-fill email from URL if present\n  useEffect(() => {\n    if (emailFromUrl) {\n      setEmail(decodeURIComponent(emailFromUrl));\n    }\n  }, [emailFromUrl]);\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    \n    if (newPassword !== confirmPassword) {\n      toast({\n        title: \"Error\",\n        description: \"Passwords do not match\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword.length < 6) {\n      toast({\n        title: \"Error\",\n        description: \"Password must be at least 6 characters\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      await apiRequest(\"POST\", \"/api/reset-password\", { \n        email, \n        token,\n        newPassword \n      });\n      setIsSuccess(true);\n      toast({\n        title: \"Password reset successful\",\n        description: \"You can now sign in with your new password\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to reset password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex h-screen\">\n      {/* Left Column - Form */}\n      <div className=\"flex flex-1 items-center justify-center p-8 bg-background\">\n        <div className=\"w-full max-w-md\">\n          <Card>\n            <CardHeader className=\"space-y-1\">\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => navigate(\"/auth\")}\n                  data-testid=\"button-back\"\n                >\n                  <ArrowLeft className=\"h-4 w-4\" />\n                </Button>\n                <CardTitle className=\"text-2xl font-bold\">Reset Password</CardTitle>\n              </div>\n              <CardDescription>\n                Enter the code we sent to your email and choose a new password\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {isSuccess ? (\n                <div className=\"text-center space-y-4 py-8\">\n                  <CheckCircle2 className=\"h-16 w-16 text-primary mx-auto\" />\n                  <div>\n                    <h3 className=\"text-lg font-semibold mb-2\">Password reset successful!</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      You can now sign in with your new password\n                    </p>\n                  </div>\n                  <Button\n                    className=\"w-full\"\n                    onClick={() => navigate(\"/auth\")}\n                    data-testid=\"button-back-to-login\"\n                  >\n                    Back to login\n                  </Button>\n                </div>\n              ) : (\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"email\">Email address</Label>\n                    <Input\n                      id=\"email\"\n                      type=\"email\"\n                      value={email}\n                      onChange={(e) => setEmail(e.target.value)}\n                      placeholder=\"Enter your email\"\n                      required\n                      disabled={isLoading || !!emailFromUrl}\n                      data-testid=\"input-email\"\n                      className={emailFromUrl ? \"bg-muted\" : \"\"}\n                    />\n                    {emailFromUrl && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Email address is pre-filled from your reset request\n                      </p>\n                    )}\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"token\">Reset code</Label>\n                    <Input\n                      id=\"token\"\n                      type=\"text\"\n                      value={token}\n                      onChange={(e) => setToken(e.target.value)}\n                      placeholder=\"Enter 6-digit code\"\n                      required\n                      disabled={isLoading}\n                      maxLength={6}\n                      data-testid=\"input-token\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Check your email for the 6-digit reset code\n                    </p>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"new-password\">New password</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"new-password\"\n                        type={showNewPassword ? \"text\" : \"password\"}\n                        value={newPassword}\n                        onChange={(e) => setNewPassword(e.target.value)}\n                        placeholder=\"Enter new password\"\n                        required\n                        disabled={isLoading}\n                        data-testid=\"input-new-password\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowNewPassword(!showNewPassword)}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        data-testid=\"button-toggle-new-password\"\n                      >\n                        {showNewPassword ? (\n                          <EyeOff className=\"h-4 w-4\" />\n                        ) : (\n                          <Eye className=\"h-4 w-4\" />\n                        )}\n                      </button>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"confirm-password\">Confirm new password</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"confirm-password\"\n                        type={showConfirmPassword ? \"text\" : \"password\"}\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        placeholder=\"Confirm new password\"\n                        required\n                        disabled={isLoading}\n                        data-testid=\"input-confirm-password\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        data-testid=\"button-toggle-confirm-password\"\n                      >\n                        {showConfirmPassword ? (\n                          <EyeOff className=\"h-4 w-4\" />\n                        ) : (\n                          <Eye className=\"h-4 w-4\" />\n                        )}\n                      </button>\n                    </div>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full\"\n                    disabled={isLoading || !email || !token || !newPassword || !confirmPassword}\n                    data-testid=\"button-submit\"\n                  >\n                    {isLoading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Reset password\n                  </Button>\n                </form>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Right Column - Hero */}\n      <div className=\"hidden lg:flex lg:flex-1 items-center justify-center p-12 relative overflow-hidden\">\n        {/* Inspect360 brand gradient - Bright Cyan to Teal */}\n        <div className=\"absolute inset-0 bg-gradient-to-br from-[#00D5CC] via-[#3B7A8C] to-[#06283F]\"></div>\n        \n        {/* Overlay with subtle pattern */}\n        <div className=\"absolute inset-0 opacity-10\">\n          <div className=\"absolute inset-0\" style={{\n            backgroundImage: `radial-gradient(circle at 2px 2px, white 1px, transparent 0)`,\n            backgroundSize: '32px 32px'\n          }}></div>\n        </div>\n\n        <div className=\"relative z-10 max-w-lg text-white\">\n          <div className=\"mb-6\">\n            <Lock className=\"h-16 w-16 mb-4\" />\n          </div>\n          <h2 className=\"text-3xl font-bold mb-4\">Secure Password Reset</h2>\n          <p className=\"text-lg text-white/90 mb-6\">\n            Enter the 6-digit code we sent to your email and choose a strong new password to secure your account.\n          </p>\n          <ul className=\"space-y-3\">\n            <li className=\"flex items-start gap-3\">\n              <FileCheck className=\"h-5 w-5 mt-0.5 flex-shrink-0\" />\n              <span>Code expires in 1 hour for security</span>\n            </li>\n            <li className=\"flex items-start gap-3\">\n              <Lock className=\"h-5 w-5 mt-0.5 flex-shrink-0\" />\n              <span>Password must be at least 6 characters</span>\n            </li>\n            <li className=\"flex items-start gap-3\">\n              <Building2 className=\"h-5 w-5 mt-0.5 flex-shrink-0\" />\n              <span>Access your property inspections securely</span>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":10672},"client/src/types/google-maps.d.ts":{"content":"// Google Maps API type declarations\ndeclare global {\n  interface Window {\n    google: typeof google;\n  }\n}\n\ndeclare namespace google {\n  namespace maps {\n    namespace places {\n      interface AutocompleteOptions {\n        componentRestrictions?: { country: string | string[] };\n        fields?: string[];\n        types?: string[];\n      }\n\n      class Autocomplete {\n        constructor(inputField: HTMLInputElement, opts?: AutocompleteOptions);\n        getPlace(): PlaceResult;\n        addListener(eventName: string, handler: () => void): void;\n      }\n\n      interface PlaceResult {\n        formatted_address?: string;\n        address_components?: AddressComponent[];\n        geometry?: {\n          location?: {\n            lat(): number;\n            lng(): number;\n          };\n        };\n      }\n\n      interface AddressComponent {\n        long_name: string;\n        short_name: string;\n        types: string[];\n      }\n    }\n\n    namespace event {\n      function clearInstanceListeners(instance: any): void;\n    }\n  }\n}\n\nexport {};\n\n","size_bytes":1040},"shared/phoneCountryCodes.ts":{"content":"// Mapping of ISO 3166-1 alpha-2 country codes to phone country codes\nexport const COUNTRY_TO_PHONE_CODE: Record<string, string> = {\n  // United Kingdom and Crown Dependencies\n  GB: \"+44\",\n  GG: \"+44\",\n  IM: \"+44\",\n  JE: \"+44\",\n  \n  // United States and territories\n  US: \"+1\",\n  CA: \"+1\",\n  AS: \"+1\",\n  GU: \"+1\",\n  MP: \"+1\",\n  PR: \"+1\",\n  VI: \"+1\",\n  \n  // United Arab Emirates\n  AE: \"+971\",\n  \n  // Australia\n  AU: \"+61\",\n  \n  // Ireland\n  IE: \"+353\",\n  \n  // New Zealand\n  NZ: \"+64\",\n  \n  // Singapore\n  SG: \"+65\",\n  \n  // India\n  IN: \"+91\",\n  \n  // South Africa\n  ZA: \"+27\",\n  \n  // Saudi Arabia\n  SA: \"+966\",\n  \n  // Qatar\n  QA: \"+974\",\n  \n  // Kuwait\n  KW: \"+965\",\n  \n  // Bahrain\n  BH: \"+973\",\n  \n  // Oman\n  OM: \"+968\",\n  \n  // Additional common countries\n  FR: \"+33\",\n  DE: \"+49\",\n  IT: \"+39\",\n  ES: \"+34\",\n  NL: \"+31\",\n  BE: \"+32\",\n  CH: \"+41\",\n  AT: \"+43\",\n  SE: \"+46\",\n  NO: \"+47\",\n  DK: \"+45\",\n  FI: \"+358\",\n  PL: \"+48\",\n  PT: \"+351\",\n  GR: \"+30\",\n  TR: \"+90\",\n  RU: \"+7\",\n  CN: \"+86\",\n  JP: \"+81\",\n  KR: \"+82\",\n  BR: \"+55\",\n  MX: \"+52\",\n  AR: \"+54\",\n  CL: \"+56\",\n  CO: \"+57\",\n  PE: \"+51\",\n  EG: \"+20\",\n  NG: \"+234\",\n  KE: \"+254\",\n  ZW: \"+263\",\n  PK: \"+92\",\n  BD: \"+880\",\n  ID: \"+62\",\n  MY: \"+60\",\n  TH: \"+66\",\n  VN: \"+84\",\n  PH: \"+63\",\n};\n\n// Get phone country code from ISO country code\nexport function getPhoneCodeForCountry(countryCode: string): string {\n  return COUNTRY_TO_PHONE_CODE[countryCode.toUpperCase()] || \"+1\";\n}\n\n// Reverse lookup: get country code from phone code (for most common ones)\nexport function getCountryCodeFromPhoneCode(phoneCode: string): string | null {\n  const normalized = phoneCode.startsWith(\"+\") ? phoneCode : `+${phoneCode}`;\n  for (const [country, code] of Object.entries(COUNTRY_TO_PHONE_CODE)) {\n    if (code === normalized) {\n      return country;\n    }\n  }\n  return null;\n}\n\n// Parse phone number: splits combined phone number into country code and number\n// Handles formats like: \"+44 7700 900000\", \"+44 7700900000\", \"447700900000\", etc.\nexport function parsePhoneNumber(fullPhone: string | null | undefined): {\n  countryCode: string | null;\n  number: string;\n} {\n  if (!fullPhone) {\n    return { countryCode: null, number: \"\" };\n  }\n\n  const trimmed = fullPhone.trim();\n  if (!trimmed) {\n    return { countryCode: null, number: \"\" };\n  }\n\n  // Try to extract country code from the beginning\n  // Match common patterns: +44, +1, +971, etc.\n  const phoneCodeMatch = trimmed.match(/^(\\+\\d{1,3})[\\s\\-]*(.*)$/);\n  if (phoneCodeMatch) {\n    return {\n      countryCode: phoneCodeMatch[1],\n      number: phoneCodeMatch[2].trim(),\n    };\n  }\n\n  // If no country code prefix, return null for country code and the whole thing as number\n  // This allows the component to use the user's default country code\n  return { countryCode: null, number: trimmed };\n}\n\n// Combine country code and number into a single phone string\nexport function combinePhoneNumber(countryCode: string, number: string): string {\n  if (!number.trim()) {\n    return \"\";\n  }\n  const normalizedCode = countryCode.startsWith(\"+\") ? countryCode : `+${countryCode}`;\n  const normalizedNumber = number.trim();\n  return `${normalizedCode} ${normalizedNumber}`;\n}\n\n","size_bytes":3173},"client/src/components/PhoneInput.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useLocale } from \"@/contexts/LocaleContext\";\nimport {\n  getPhoneCodeForCountry,\n  COUNTRY_TO_PHONE_CODE,\n  parsePhoneNumber,\n  combinePhoneNumber,\n} from \"@shared/phoneCountryCodes\";\nimport { COMMON_COUNTRIES } from \"@shared/countryUtils\";\n\ninterface PhoneInputProps {\n  value?: string | null;\n  onChange?: (value: string) => void;\n  onCountryCodeChange?: (countryCode: string) => void;\n  onNumberChange?: (number: string) => void;\n  id?: string;\n  name?: string;\n  label?: string;\n  placeholder?: string;\n  className?: string;\n  disabled?: boolean;\n  \"data-testid\"?: string;\n  // For form libraries like react-hook-form\n  field?: {\n    value?: string | null;\n    onChange?: (value: string) => void;\n  };\n}\n\nexport function PhoneInput({\n  value: controlledValue,\n  onChange,\n  onCountryCodeChange,\n  onNumberChange,\n  id,\n  name,\n  label,\n  placeholder,\n  className,\n  disabled,\n  \"data-testid\": dataTestId,\n  field,\n}: PhoneInputProps) {\n  const { countryCode: userCountryCode } = useLocale();\n  const defaultPhoneCode = getPhoneCodeForCountry(userCountryCode);\n\n  // Use controlled value if provided, otherwise use field value\n  const phoneValue = controlledValue ?? field?.value ?? \"\";\n\n  // Parse the phone number into country code and number\n  const parsed = parsePhoneNumber(phoneValue);\n  // If parsed country code exists, use it; otherwise use user's country code\n  // Always default to user's country code when no phone value exists\n  const initialCountryCode = (phoneValue && parsed.countryCode) ? parsed.countryCode : defaultPhoneCode;\n  const [countryCode, setCountryCode] = useState(initialCountryCode);\n  const [number, setNumber] = useState(parsed.number || \"\");\n\n  // Update internal state when external value or user country changes\n  useEffect(() => {\n    const parsed = parsePhoneNumber(phoneValue);\n    // Update country code if parsed has one, otherwise use user's default\n    if (phoneValue && parsed.countryCode) {\n      // Only update if there's an actual phone value with a country code\n      setCountryCode(parsed.countryCode);\n    } else {\n      // If no phone value or no country code in parsed value, use user's default country code\n      setCountryCode(defaultPhoneCode);\n    }\n    setNumber(parsed.number || \"\");\n  }, [phoneValue, defaultPhoneCode]);\n\n  const handleCountryCodeChange = (newCountryCode: string) => {\n    setCountryCode(newCountryCode);\n    const combined = combinePhoneNumber(newCountryCode, number);\n    if (field?.onChange) {\n      field.onChange(combined);\n    }\n    if (onChange) {\n      onChange(combined);\n    }\n    if (onCountryCodeChange) {\n      onCountryCodeChange(newCountryCode);\n    }\n  };\n\n  const handleNumberChange = (newNumber: string) => {\n    setNumber(newNumber);\n    const combined = combinePhoneNumber(countryCode, newNumber);\n    if (field?.onChange) {\n      field.onChange(combined);\n    }\n    if (onChange) {\n      onChange(combined);\n    }\n    if (onNumberChange) {\n      onNumberChange(newNumber);\n    }\n  };\n\n  // Create list of unique phone codes with their representative countries\n  const phoneCodeOptions: Array<{ code: string; countries: string[] }> = [];\n  const codeMap = new Map<string, string[]>();\n\n  // Group countries by phone code\n  for (const country of COMMON_COUNTRIES) {\n    const phoneCode = getPhoneCodeForCountry(country.code);\n    if (!codeMap.has(phoneCode)) {\n      codeMap.set(phoneCode, []);\n    }\n    codeMap.get(phoneCode)!.push(country.name);\n  }\n\n  // Convert to array format\n  for (const [code, countries] of codeMap.entries()) {\n    phoneCodeOptions.push({ code, countries });\n  }\n\n  // Sort by phone code\n  phoneCodeOptions.sort((a, b) => {\n    const numA = parseInt(a.code.replace(\"+\", \"\")) || 9999;\n    const numB = parseInt(b.code.replace(\"+\", \"\")) || 9999;\n    return numA - numB;\n  });\n\n  // Add other common codes if not already present\n  const allCodes = new Set(phoneCodeOptions.map(opt => opt.code));\n  const commonOtherCodes = [\n    { code: \"+44\", countries: [\"United Kingdom\"] },\n    { code: \"+1\", countries: [\"United States\", \"Canada\"] },\n    { code: \"+971\", countries: [\"United Arab Emirates\"] },\n    { code: \"+61\", countries: [\"Australia\"] },\n    { code: \"+353\", countries: [\"Ireland\"] },\n    { code: \"+64\", countries: [\"New Zealand\"] },\n    { code: \"+65\", countries: [\"Singapore\"] },\n    { code: \"+91\", countries: [\"India\"] },\n    { code: \"+27\", countries: [\"South Africa\"] },\n  ];\n\n  for (const option of commonOtherCodes) {\n    if (!allCodes.has(option.code)) {\n      phoneCodeOptions.push(option);\n      allCodes.add(option.code);\n    }\n  }\n\n  const displayLabel = label || \"Phone Number\";\n  const displayPlaceholder = placeholder || \"1234567890\";\n  const displayId = id || name || \"phone\";\n\n  return (\n    <div className={className}>\n      {label && <Label htmlFor={displayId}>{displayLabel}</Label>}\n      <div className=\"grid grid-cols-3 gap-2\">\n        <div>\n          {!label && <Label htmlFor={`${displayId}-country-code`} className=\"sr-only\">Country Code</Label>}\n          <Select\n            value={countryCode}\n            onValueChange={handleCountryCodeChange}\n            disabled={disabled}\n          >\n            <SelectTrigger\n              id={`${displayId}-country-code`}\n              name={name ? `${name}CountryCode` : undefined}\n              data-testid={dataTestId ? `${dataTestId}-country-code` : undefined}\n              className=\"h-10\"\n            >\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {phoneCodeOptions.map((option) => (\n                <SelectItem key={option.code} value={option.code}>\n                  {option.code} {option.countries[0]}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <div className=\"col-span-2\">\n          {!label && <Label htmlFor={displayId} className=\"sr-only\">{displayLabel}</Label>}\n          <Input\n            id={displayId}\n            type=\"tel\"\n            value={number}\n            onChange={(e) => handleNumberChange(e.target.value)}\n            placeholder={displayPlaceholder}\n            disabled={disabled}\n            data-testid={dataTestId ? `${dataTestId}-number` : dataTestId}\n          />\n        </div>\n      </div>\n      {/* Hidden input for form submission with combined value */}\n      {name && (\n        <input\n          type=\"hidden\"\n          name={name}\n          value={combinePhoneNumber(countryCode, number)}\n        />\n      )}\n    </div>\n  );\n}\n\n","size_bytes":6760}},"version":2}